[{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412143919","html_url":"https://github.com/apache/couchdb/issues/1544#issuecomment-412143919","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1544","id":412143919,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjE0MzkxOQ==","user":{"login":"mtabb13","id":7840530,"node_id":"MDQ6VXNlcjc4NDA1MzA=","avatar_url":"https://avatars.githubusercontent.com/u/7840530?v=4","gravatar_id":"","url":"https://api.github.com/users/mtabb13","html_url":"https://github.com/mtabb13","followers_url":"https://api.github.com/users/mtabb13/followers","following_url":"https://api.github.com/users/mtabb13/following{/other_user}","gists_url":"https://api.github.com/users/mtabb13/gists{/gist_id}","starred_url":"https://api.github.com/users/mtabb13/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mtabb13/subscriptions","organizations_url":"https://api.github.com/users/mtabb13/orgs","repos_url":"https://api.github.com/users/mtabb13/repos","events_url":"https://api.github.com/users/mtabb13/events{/privacy}","received_events_url":"https://api.github.com/users/mtabb13/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-10T17:01:06Z","updated_at":"2018-08-10T17:01:06Z","author_association":"NONE","body":"I have come across a bug in v2.1.2 querying _changes.  It doesn't fail every time, maybe once or twice a day.  The application code calling this endpoint runs on a 30 second polling interval.  The same code worked in 2.0 and 2.1.1 without problems.  I get the following error:\r\n\r\n`fabric_rpc:changes/3 error:{badmatch,{'EXIT',noproc}} [{couch_file,pread_binary,2,[{file,\"src/couch_file.erl\"},{line,169}]},{couch_file,pread_term,2,[{file,\"src/couch_file.erl\"},{line,157}]},{couch_btree,get_node,2,[{file,\"src/couch_btree.erl\"},{line,434}]},{couch_btree,reduce_stream_node,11,[{file,\"src/couch_btree.erl\"},{line,619}]},{couch_btree,fold_reduce,4,[{file,\"src/couch_btree.erl\"},{line,81}]},{couch_db,count_changes_since,2,[{file,\"src/couch_db.erl\"},{line,1407}]},{fabric_rpc,changes,4,[{file,\"src/fabric_rpc.erl\"},{line,80}]},{rexi_server,init_p,3,[{file,\"src/rexi_server.erl\"},{line,139}]}]`","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412143919/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412197240","html_url":"https://github.com/apache/couchdb/pull/1551#issuecomment-412197240","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1551","id":412197240,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjE5NzI0MA==","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-10T20:29:38Z","updated_at":"2018-08-10T20:29:38Z","author_association":"CONTRIBUTOR","body":"@wohali @janl I gave it another try. Now we have the optimization enabled. And, as a bonus, found a race condition that became more apparent now that we immediately retry after a failure.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412197240/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412273984","html_url":"https://github.com/apache/couchdb/issues/1460#issuecomment-412273984","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1460","id":412273984,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjI3Mzk4NA==","user":{"login":"jvegaseg","id":12508470,"node_id":"MDQ6VXNlcjEyNTA4NDcw","avatar_url":"https://avatars.githubusercontent.com/u/12508470?v=4","gravatar_id":"","url":"https://api.github.com/users/jvegaseg","html_url":"https://github.com/jvegaseg","followers_url":"https://api.github.com/users/jvegaseg/followers","following_url":"https://api.github.com/users/jvegaseg/following{/other_user}","gists_url":"https://api.github.com/users/jvegaseg/gists{/gist_id}","starred_url":"https://api.github.com/users/jvegaseg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jvegaseg/subscriptions","organizations_url":"https://api.github.com/users/jvegaseg/orgs","repos_url":"https://api.github.com/users/jvegaseg/repos","events_url":"https://api.github.com/users/jvegaseg/events{/privacy}","received_events_url":"https://api.github.com/users/jvegaseg/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-11T13:08:34Z","updated_at":"2018-08-11T13:08:34Z","author_association":"NONE","body":"After compacting, space was reduced more than 50%.\r\nIs there a way to run only one active compacting task on each node (or running compacting sequentially for each shard)? \r\nRunning several in parallel need too much space for compacting. ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412273984/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412296886","html_url":"https://github.com/apache/couchdb/issues/1544#issuecomment-412296886","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1544","id":412296886,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjI5Njg4Ng==","user":{"login":"ermouth","id":1540047,"node_id":"MDQ6VXNlcjE1NDAwNDc=","avatar_url":"https://avatars.githubusercontent.com/u/1540047?v=4","gravatar_id":"","url":"https://api.github.com/users/ermouth","html_url":"https://github.com/ermouth","followers_url":"https://api.github.com/users/ermouth/followers","following_url":"https://api.github.com/users/ermouth/following{/other_user}","gists_url":"https://api.github.com/users/ermouth/gists{/gist_id}","starred_url":"https://api.github.com/users/ermouth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ermouth/subscriptions","organizations_url":"https://api.github.com/users/ermouth/orgs","repos_url":"https://api.github.com/users/ermouth/repos","events_url":"https://api.github.com/users/ermouth/events{/privacy}","received_events_url":"https://api.github.com/users/ermouth/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-11T19:32:13Z","updated_at":"2018-08-11T19:32:13Z","author_association":"CONTRIBUTOR","body":"@rnewson We‘ll test the patch on Tuesday. Could you please explain shortly what that code intended to do? Particularly, why so tricky way to call a fn is used?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412296886/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412304221","html_url":"https://github.com/apache/couchdb/issues/1460#issuecomment-412304221","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1460","id":412304221,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjMwNDIyMQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-11T22:03:47Z","updated_at":"2018-08-11T22:03:47Z","author_association":"MEMBER","body":"If you leave it up to the compaction daemon, it won't run more than one at a time. If you do it manually, it's up to you to ensure that only one is running at once, by looking at the output of `GET /_active_tasks` or similar.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412304221/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412308090","html_url":"https://github.com/apache/couchdb/issues/1534#issuecomment-412308090","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1534","id":412308090,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjMwODA5MA==","user":{"login":"ermouth","id":1540047,"node_id":"MDQ6VXNlcjE1NDAwNDc=","avatar_url":"https://avatars.githubusercontent.com/u/1540047?v=4","gravatar_id":"","url":"https://api.github.com/users/ermouth","html_url":"https://github.com/ermouth","followers_url":"https://api.github.com/users/ermouth/followers","following_url":"https://api.github.com/users/ermouth/following{/other_user}","gists_url":"https://api.github.com/users/ermouth/gists{/gist_id}","starred_url":"https://api.github.com/users/ermouth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ermouth/subscriptions","organizations_url":"https://api.github.com/users/ermouth/orgs","repos_url":"https://api.github.com/users/ermouth/repos","events_url":"https://api.github.com/users/ermouth/events{/privacy}","received_events_url":"https://api.github.com/users/ermouth/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-11T23:30:06Z","updated_at":"2018-08-11T23:30:06Z","author_association":"CONTRIBUTOR","body":"@wohali \r\n> recognize you are angry and want to fight for something you believe in\r\n> You want to contribute to couchapps still?\r\n\r\nThere is kind of misunderstanding. We use couchapps, but not in the way you think. We have Couchbox, which completely replaces couchapp-related QS fns, able to run legacy code, and is much faster and reacher with features (but much heavier). So we do not need `_list`, `_rewrite` or `_update` for _couchapps_. \r\n\r\nBut there exist other scenarios, probably not so visible, where built-in QS stuff seem to be extremely valuable.\r\n\r\nUpdate fns is the only way to send whatever data to Couch without prior reading. It‘s invaluable feature for ie nets of sensors. Couch here acts as an aggregator, and ability to run Couch on PI allows to make aggregators very lean, setup them in place, and avoid app layer completely (which is obviously important for lean devices).\r\n\r\nLists are also valuable for scenarios of aggregating data from net of sensors. You can perform remote data lookup on whatever basis without fetching real data, and have no serious bucket stalls, like you have with views. Mango queries seem to provide alternative mechanics for this, but they are less flexible (however much more fast).\r\n\r\nRewrites (only as functions surely) are just great. Ability to re-wire API remotely has a lot of applications aside of couchapps. Also this approach of providing API is easily testable without deployment. Functions are easy to play with, unlike sets of nginx or haproxy rules.\r\n\r\nAll those features just work. They might be faster, and some improvements are low hanging fruits, but they already work in acceptable way. They only need very minor repair time to time.\r\n\r\nSo I can’t accept your ”submit PRs or stop complaining“. There’s not so lot of things I personally want to improve. However, I think I can help with fixing (or at least nailing down) QS-related bugs. Hope it may help to preserve those features little bit longer.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412308090/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412319097","html_url":"https://github.com/apache/couchdb/issues/1534#issuecomment-412319097","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1534","id":412319097,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjMxOTA5Nw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-12T05:06:06Z","updated_at":"2018-08-12T05:06:06Z","author_association":"MEMBER","body":"@johs The improved rewrites not being included in 1.7 was an oversight in the rush to get it out, not an intentional omission. Sorry about that :(\r\n\r\n@ermouth Thanks for the clarifications and specific points. Your assistance on the repro case for #1544 is greatly appreciated; more of this support going forward and the occasional PR is all I'm asking for. And while the passion is helpful, the anger is not. Thanks for responding civilly.\r\n\r\nWe've already clarified that update functions won't go away without a suitable replacement. I suspect that the JS engine replacement (see below) will still support update and VDU functions, but I don't see evidence of it yet. The question is more along the lines of: can we do better in a declarative, Mango-like fashion? There are other proposals to provide similar/useful functionality (#1532, #1533, #1498) if the operator decides to run without a JS engine (#1513), plus I suspect there are thoughts about doing Mango-based update functionality to filter fields, as well as apply database schema enforcement (type and format checking) in a declarative fashion for a NoJS mode. Could your embedded RasPi update function be written declaratively? I assume you're adding info such as incoming IP address, central timestamp, etc. which I could see being done automatically quite easily. This is a use case we can accelerate without the use of JS readily; we just need to agree on an API and how to write it down in a JSON blob.\r\n\r\nThe big problem with the query server implementation is the age of JS 1.8.5, and the relative difficulty of upgrading the JS engine without touching anything else, plus addressing the long-standing issue of poor query server performance, especially at scale. @davisp is the one working on bringing the new JS engine into CouchDB via a NIF over in https://github.com/cloudant-labs/erlang-chakracore . So far, the big place he's stuck is implementing _lists_. From what I know of Paul's current thinking, one possibility would be a full refactor of the query server protocol/implementation and use external processes again to solve this problem, but more efficiently. This is a big task and could hold up the entire effort. Another is to just drop lists going forward, preserving the better performance provided by the NIF binding for the core JS functionality. Perhaps you can assist, if you know NIFs and C/C++ well... Alternately, what would Mango need added to it to give you sufficiently improved list functionality to fully replace JS lists?\r\n\r\nOverall, rewrites are far less often used than either of the other two features, vhosts even less, and proxies even less than that. Cloudant doesn't support JS as rewrites, and I could see Couch going the same way for a NoJS mode at the very least - with static or templated/regex rewrites over in Mango. But I think there's some concern about having rewrites at all in what is increasingly envisioned as a pure database. I can't think of another database engine that allows you to rewrite its API.... This is where we'll have to agree to disagree on the priority of a feature, but again, I'm just a single vote.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412319097/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412322522","html_url":"https://github.com/apache/couchdb/issues/1554#issuecomment-412322522","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1554","id":412322522,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjMyMjUyMg==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-12T06:47:00Z","updated_at":"2018-08-12T06:51:15Z","author_association":"MEMBER","body":"Got to thinking more about this one in the shower. Here's a sample Mango-like document structure for a combined VDU/update handler that would capture all of the above:\r\n\r\n```json\r\n{\r\n  \"queries\": [\r\n    {\r\n      \"name\": \"sensor_name\",\r\n      \"selector\": {\r\n        \"type\": \"sensor\",\r\n        \"ip_address\": \"$doc.ip_address\"\r\n      },\r\n      \"fields\": [\"name\"],\r\n      ...\r\n    }\r\n  ],\r\n  \"fields\": {\r\n    \"whitelist\": [\"type\", \"datetime\", \"ip_address\", \"station_name\", \"temperature\", \"RH%\", \"rain_gauge\", \"wind.speed\", \"wind.direction\", \"light\", \"battery.voltage\", \"battery.current\", \"line.voltage\", \"line.current\", \"solar.voltage\", \"solar.current\", \"register_total\"],\r\n    \"blacklist\": [\"battery.wattage\", \"rain_gauge.*\"],\r\n    \"formats\": {\r\n      \"type\": [\"sensor_reading\"],\r\n      \"datetime\": {\r\n        \"$or\": {\r\n          \"$format\": \"$iso8601\",\r\n          \"$format\": \"$unixepoch\",\r\n          \"$regex\": \"(\\\\d{2})-(\\\\d{2})-(\\\\d{2}) (\\\\d{2}):(\\\\d{2}):(\\\\d{2})\"\r\n        }\r\n      },\r\n      \"battery.voltage\": \"$float\",\r\n      \"battery.current\": \"$float\",\r\n      \"register_total\": { \"$regex\": \"^\\\\$\\\\d{1,9}\\\\.\\\\d{2}$\" },\r\n      \"wind.direction\": {\"$or\": [\"N\", \"NE\", \"E\", \"SE\", \"S\", \"SW\", \"W\", \"NW\"]}\r\n      ...\r\n    }\r\n  },\r\n  \"patch\": [\r\n      { \"op\": \"add\", \"path\": \"/\", \"value\": { \"name\": \"$query:sensor_name.name\" } },\r\n      { \"op\": \"move\", \"from\": \"/ip-address\", \"path\": \"/ip_address\" },\r\n      { \"op\": \"add\", \"path\": \"/\", \"value\": { \"server_datetime\": \"$server_time.iso8601\" } },\r\n      ...\r\n  ]\r\n}\r\n```\r\n\r\nComments:\r\n* This runs a Mango query up front to get any documents with `\"type\": \"sensor\"` that match the IP address of the incoming request. (Assumes that the `$req` object has that value, not sure we pass that thru to VDUs right now...)\r\n* There's then a field presence check. In a real situation, you would probably only have one of `fields.whitelist` and `fields.blacklist`.\r\n* Field values/formats are then checked, some just for general structure, one by regex, one by list of acceptable values. The output of a Mango query could be used as input to this, too. (An aside: Mango aggregations could be really useful here, for instance to reduce a query to a single list of acceptable values. See #1254.)\r\n* Documents that didn't match `\"type\": \"sensor_reading\"` or any of the other format checks would fall through to the next whatever-we-call-this-thing. If all failed, the document would be rejected.\r\n* Maybe we add a `\"$format\": \"$datetime\"` that includes all the common datetime formats?\r\n\r\nJust some food for discussion.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412322522/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412326103","html_url":"https://github.com/apache/couchdb/issues/1534#issuecomment-412326103","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1534","id":412326103,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjMyNjEwMw==","user":{"login":"giowild","id":818361,"node_id":"MDQ6VXNlcjgxODM2MQ==","avatar_url":"https://avatars.githubusercontent.com/u/818361?v=4","gravatar_id":"","url":"https://api.github.com/users/giowild","html_url":"https://github.com/giowild","followers_url":"https://api.github.com/users/giowild/followers","following_url":"https://api.github.com/users/giowild/following{/other_user}","gists_url":"https://api.github.com/users/giowild/gists{/gist_id}","starred_url":"https://api.github.com/users/giowild/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/giowild/subscriptions","organizations_url":"https://api.github.com/users/giowild/orgs","repos_url":"https://api.github.com/users/giowild/repos","events_url":"https://api.github.com/users/giowild/events{/privacy}","received_events_url":"https://api.github.com/users/giowild/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-12T08:05:49Z","updated_at":"2018-08-12T08:13:41Z","author_association":"NONE","body":"Thanks @johs and @ermouth for mention.\r\n\r\n> There is kind of misunderstanding. We use couchapps, but not in the way you think. \r\n> All those features just work. They might be faster, and some improvements are low hanging fruits, but they already work in acceptable way. They only need very minor repair time to time.\r\n\r\nI strongly agree with ermouth words. \r\nI think there is a substantial lack of comprehension on what these features can already give out of the box, as they are now, and how they can be used to achieve what today is thought impossible to achieve with couchdb, if not using a proxy.\r\n\r\nI already tried to explain (unfortunately in vain) in the past on the ML, how vhosts and rewrites can substantially be used as sorts of firewalls and routers to implement fine access control and routing(to other design docs rewrites, show,list,updates and so on) even before reading documents from database. This opens up endless possibilities for app developers. Just to make an example: the long-time asked \"document-level acl\" is already possible, withouth security flaws, simply by using correctly all rewrites, shows, list, views and updates features. This is in place, as example, to deliver smileupps website, cloud panel and billing!!! Other big plus are the possibility to perform hot-swap when upgrading a website from version 1.0 to 2.0 (by updating the first routing document in the chain), or possibility to work on a draft version of a website, different from what the user is watching (by simply using a vhost pointing to a different design doc/rewrites in the same database).\r\n\r\nThese are features app developers want and these are only few examples of what can ALREADY be achieved with existing couchdb features!\r\n\r\nAfter that, only adding few minor enhancements, can give tremendous benefits to app developers improving overall ease of use, flexibility and security. We tried to discuss them in the ML in vain, then we ended up implementing them in our personal Couchdb-fork.\r\n\r\nI'm referring to the possibility of pushing more details inside rewrites documents, such as acl details. What said above, becomes trivial in this way:\r\n```\r\n[\r\n   {\"to\":\"ABC\",\"from\":\"XYZ\",\"logged\":\"true\"},\r\n   {\"to\":\"ABC\",\"from\":\"XYZ\",\"user\":\"joe\"},\r\n   {\"to\":\"ABC\",\"from\":\"XYZ\",\"role\":\"author\"}\r\n]\r\n```\r\n- or the possibility to replace special keywords in rewrites rules, such as :actualuser,:actualrole,:actualdb and :actualvhost\r\n- or the possibility to use absolute paths instead of relative paths, which greatly improves simplicity from an app developer perspective\r\n- or the possibility to use current database instead of _users database for user authentication\r\nand much more...\r\n\r\nIt is sad to say that what is missing in CouchDB today, is not a specific feature, but the VISION and WILL of DIFFERENTIATING from other database products. \r\n\r\n@joan said:\r\n> I can't think of another database engine that allows you to rewrite its API\r\nand this IS AN ADVANTAGE for CouchDB!!! :-) These are exactly the kind of features where couchdb CAN and SHOULD differentiate, otherwise it will forever remain another NoSQL database, differentiating only for the fact that its API is native and not a plugin.\r\n\r\nI would like a database meant FOR the APP DEVELOPER and not for a db or system administrator. If no app developers will ever write apps with couchdb, no db or system administrators will be ever required to mantain its databases!\r\n\r\nIMHO app developers tends to value the following features in this order: \r\n1. expressiveness, flexibility and ease of use (impacting on development time) + app-level features (authentication, authorization, website+app inside database, in-browser development, etc.)\r\n2. security: no information must leak from the database (rewrites are great for this)\r\n3. performance \r\n4. system-level features (clustering is here :-)\r\n\r\nThis is my thinking on the argument: first features need to be built, in a secure way, then they can and SHOULD be optimized for performance. Since performance can always be achieved by improving hardware, better performance through software optimization, will always come after points 1 and 2. Point 4 is nice-to-have but not mandatory for onboarding and will always come after points 1-3.\r\n\r\nIn the end, FWIW this is my invaluable set of features:\r\n* _rewrites\r\n* vhosts\r\n*  _show\r\n* _list\r\n* OS daemons\r\n* Couch proxy stuff (Couch proxying other services - couch_httpd_proxy\r\n* Update functions\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412326103/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412328706","html_url":"https://github.com/apache/couchdb/issues/1544#issuecomment-412328706","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1544","id":412328706,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjMyODcwNg==","user":{"login":"wactbprot","id":113518,"node_id":"MDQ6VXNlcjExMzUxOA==","avatar_url":"https://avatars.githubusercontent.com/u/113518?v=4","gravatar_id":"","url":"https://api.github.com/users/wactbprot","html_url":"https://github.com/wactbprot","followers_url":"https://api.github.com/users/wactbprot/followers","following_url":"https://api.github.com/users/wactbprot/following{/other_user}","gists_url":"https://api.github.com/users/wactbprot/gists{/gist_id}","starred_url":"https://api.github.com/users/wactbprot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wactbprot/subscriptions","organizations_url":"https://api.github.com/users/wactbprot/orgs","repos_url":"https://api.github.com/users/wactbprot/repos","events_url":"https://api.github.com/users/wactbprot/events{/privacy}","received_events_url":"https://api.github.com/users/wactbprot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-12T08:56:13Z","updated_at":"2018-08-12T08:56:13Z","author_association":"NONE","body":">I expect a) you no longer get the error reported b) your log shows a new error that I would very much like to see.\r\n\r\n@rnewson  patch fixes our list issues completely.\r\n on b) don't observe any error messages  related to our list requests (log level debug)\r\n\r\n@couchdbteam Thanks a lot for your work!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412328706/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412336625","html_url":"https://github.com/apache/couchdb/issues/1544#issuecomment-412336625","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1544","id":412336625,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjMzNjYyNQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-12T11:33:28Z","updated_at":"2018-08-12T11:33:28Z","author_association":"MEMBER","body":"@wactbprot Thanks for the confirmation. We'll get this update into the very next release of CouchDB.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412336625/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412337650","html_url":"https://github.com/apache/couchdb/issues/1534#issuecomment-412337650","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1534","id":412337650,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjMzNzY1MA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-12T11:52:16Z","updated_at":"2018-08-12T11:52:16Z","author_association":"MEMBER","body":"@giowild I understand you disagree, and I appreciate your comment here, but I'm unconvinced by your argument. I especially want to thank you for being civil in your comment.\r\n\r\nThe fundamental difference of opinion here hasn't changed. The UNIX philosophy applies to CouchDB as to any other program: do one thing, and do it well. The developers and PMC of CouchDB are increasingly making the product a better **database**, not a better one-stop **app server** + database. Our key differentiation in the marketplace isn't app serving, it's **replication**, with the HTTP DB API/JSON interface as a close second, and scaling horizontally as the third most important feature. Apps and their related features were an afterthought, and while people like you have made it work for them, it was an experiment that didn't pay off writ large, and has become less compelling with each passing year. While we don't have live telemetry from every install that backs these claims, we have data from Cloudant customers over 6 years and from the mailing lists that do back it up.\r\n\r\nEven on a lowly Raspberry Pi 3, you have 4 cores now; running an app server in any other language alongside CouchDB on this humblest of platforms gives you better app server functionality and performance by leaps and bounds than we can ever hope to achieve in CouchDB's core. The same goes for a proxy server like HAproxy or Nginx when it comes to proxying, vhosts and rewrites.\r\n\r\nAs to your list of features, `_show` and `_list` are arguably useful for data export in different formats from CouchDB, and update functions/VDUs are also very important (see #1554 for a possible evolution). I can see the value in them. While I know you don't want to see them go, I'm sure you'd agree that the others are not valuable in a database-only development approach, as they can be filled by an app server, a reverse proxy, or whatever other process you wish to run alongside our database.\r\n\r\nThanks again for the discussion. Again, I am only one vote in this deprecation discussion.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412337650/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412367604","html_url":"https://github.com/apache/couchdb/issues/1534#issuecomment-412367604","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1534","id":412367604,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjM2NzYwNA==","user":{"login":"ermouth","id":1540047,"node_id":"MDQ6VXNlcjE1NDAwNDc=","avatar_url":"https://avatars.githubusercontent.com/u/1540047?v=4","gravatar_id":"","url":"https://api.github.com/users/ermouth","html_url":"https://github.com/ermouth","followers_url":"https://api.github.com/users/ermouth/followers","following_url":"https://api.github.com/users/ermouth/following{/other_user}","gists_url":"https://api.github.com/users/ermouth/gists{/gist_id}","starred_url":"https://api.github.com/users/ermouth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ermouth/subscriptions","organizations_url":"https://api.github.com/users/ermouth/orgs","repos_url":"https://api.github.com/users/ermouth/repos","events_url":"https://api.github.com/users/ermouth/events{/privacy}","received_events_url":"https://api.github.com/users/ermouth/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-12T19:55:09Z","updated_at":"2018-08-12T20:11:09Z","author_association":"CONTRIBUTOR","body":"> Could your embedded RasPi update function be written declaratively?\r\n\r\nVery unlikely, devices do not post json. For now both `_update` and `_rewrite` as a fn are able to chop up requests having binary body, and then decide. I have no doubts any DSL making this kind of work will be either useless for other scenarios, or too complex if it wants to cover everything. DSLs are not a substitute for yet unknown tasks. Any DSL is domain-specific, or it’s a cumbersome mess.\r\n\r\n> The UNIX philosophy applies to CouchDB as to any other program\r\n\r\nIndeed, however ‘do one thing’ is, looking at most of modern really user- and dev-friendly SW, bit unpopular from UX point of view. This rule was good at CLI-only times, and those times are gone. For now, standing for this rule mostly increases transaction costs: the approach of loosely stitching things together is good for scripts, but often induces heavy deployment and impedance alignment costs for continuous systems.\r\n\r\nAlso let me remind another Unix rule that still stands, the rule of diversity: **Make programs flexible, allowing them to be used in ways other than those their developers intended.**\r\n\r\n> The same goes for a proxy server like HAproxy or Nginx when it comes to proxying, vhosts and rewrites\r\n\r\nI have nothing to say about vhosts and proxying, we never used them seriously as those settings are not replicatable, but as for rewrites...\r\n\r\nWhat about deployment? If you have hundreds of nodes which are not intended to be members of a cluster, updating external proxy rules is a serious pain with immense number of uncomfortable (or just dangerous) subtleties. With delivering API wiring using regular data flow, deployment is just one click because it uses most powerful feature of Couch: replication. Utils like nginx-sync do not stand even near.\r\n\r\n> So far, the big place he's stuck is implementing lists\r\n\r\nIt would be nice to have more info, no one can help having no description of a problem. \r\n\r\nShould removing or simplifying `.info` obj ease the task? It was done for rewrites as a fn, and this trim, aside of other effects, gives good perf improvement comparing to other QS stuff. Actually, CouchDB 1.6.1 patched with JS rewrites and called through rewrite JS function is still in most cases bit faster then naked single-node 2.x.\r\n\r\n> Alternately, what would Mango need added to it to give you sufficiently improved list functionality to fully replace JS lists?\r\n\r\nFull replacement is impossible, or you will make new DSL just another programming language. However if narrow the scope to simplest cases and JSON-only, joins and reducers are obvious answer. If former is more or less clear and implementable, the latter just does not fit well into DSL concept except simplest cases.\r\n\r\nSo, summing up: I have nothing to say about non-replicatable features or features proven to be buggy and unreliable. But I think most features using benefits of syncing code with data flow better be kept.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412367604/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412373395","html_url":"https://github.com/apache/couchdb/issues/1554#issuecomment-412373395","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1554","id":412373395,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjM3MzM5NQ==","user":{"login":"ermouth","id":1540047,"node_id":"MDQ6VXNlcjE1NDAwNDc=","avatar_url":"https://avatars.githubusercontent.com/u/1540047?v=4","gravatar_id":"","url":"https://api.github.com/users/ermouth","html_url":"https://github.com/ermouth","followers_url":"https://api.github.com/users/ermouth/followers","following_url":"https://api.github.com/users/ermouth/following{/other_user}","gists_url":"https://api.github.com/users/ermouth/gists{/gist_id}","starred_url":"https://api.github.com/users/ermouth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ermouth/subscriptions","organizations_url":"https://api.github.com/users/ermouth/orgs","repos_url":"https://api.github.com/users/ermouth/repos","events_url":"https://api.github.com/users/ermouth/events{/privacy}","received_events_url":"https://api.github.com/users/ermouth/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-12T21:36:13Z","updated_at":"2018-08-17T10:32:51Z","author_association":"CONTRIBUTOR","body":"IMO the `patch` list better be named `transform` and look like \r\n```` javascript\r\ntransform:[\r\n  {\r\n    selector:{  // Mango selector for list of actions\r\n      type: { $neq: \"whatever\"}\r\n    },\r\n    actions: [  // List of actions\r\n      [\"stop\"]\r\n    ]\r\n  }, \r\n  // Next item, used if we didn‘t stop processing\r\n  {selector:{ stamp: { $format:'Int', $gt: 1234567890123}}},\r\n  actions: [\r\n    [\"set\",  \".ip\",  \":peer\"   ],\r\n    [\"swap\", \".a.0\", [\"a\", \"1\"]],\r\n    [\"del\",  \".x.y.z\"          ]\r\n  ]}\r\n  //...\r\n]\r\n````\r\nActions are pretty self-explanatory, so no need to use obj keys. Objects as `.actions` members may be used later for syntax extensions or nesting.\r\n\r\nThis also replaces `.fields.format` typecheck making it more flexible. Typechecks just move to actions list member `.selector` prop.\r\n\r\nAlso syntax `\"battery.voltage\": \"$float\"` in fields seems somewhat ambiguous. Using proposed syntax it should be `\"battery.voltage\": {\"$format\": \"Float\"}`. $ marker before formats/types seems to be excessive, omitting it in favor of uppercasing type tag reads better. \r\n\r\nIt all seems unexpectedly reasonable. I’ll try to write down some of our _updates in this way, to compare readability and to understand other json-induced benefits/penalties. \r\n\r\nAnd I couldn‘t comprehend what `.queries` field supposed to do. Can you please give a hint?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412373395/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412375828","html_url":"https://github.com/apache/couchdb/issues/1554#issuecomment-412375828","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1554","id":412375828,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjM3NTgyOA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-12T22:19:45Z","updated_at":"2018-08-12T22:19:45Z","author_association":"MEMBER","body":"@ermouth The patch stuff is coming from JSON Patch, which is an RFC and has widespread support. We're looking at it for partial update support, see #1498. If we build it for that, then we can reuse that support here rather than inventing our own crazy DSL. ;)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412375828/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412376205","html_url":"https://github.com/apache/couchdb/issues/1554#issuecomment-412376205","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1554","id":412376205,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjM3NjIwNQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-12T22:26:55Z","updated_at":"2018-08-12T22:30:24Z","author_association":"MEMBER","body":"Sorry, I hit submit too quickly. The `$` before operators is mimicing the Mango syntax, to distinguish operators from operands. You're right that in some places, where the value is expected to be a format (like the float check) we can probably drop the `$`. As for the format, it's already inside the list for the top-level `formats` key, so it wouldn't need an additional `{\"$format\":\"float\"}` in my approach, since my approach is intentionally keeping the `patch` section JSON Patch compatible.\r\n\r\nAs for `queries`, the idea is you could run a Mango query before applying the VDU/update handler, then use that information later on. See the first line in the `patch` entry for use of the lookup to convert an incoming sensor's IP address to a station name. The assumption is that the query will only return the first document, or a reduced set of values (see the reference to Mango aggregation functions being a potential prerequisite for this functionality). Optionally you could cram in there a `.0.` to reference just the first doc in the result set, I guess. The returned result could also be used in the validator section, for instance, to look up the current list of allowed `wind direction` values or something.\r\n\r\nThe pre-update-Mango-query stuff is speculative; there may well be pushback from the db core team on making update functions a little _too_ clever and slow since they're now performing a read before a write. We'll see. I think the proposal is valuable even without that specific functionality.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412376205/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412376581","html_url":"https://github.com/apache/couchdb/issues/1513#issuecomment-412376581","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1513","id":412376581,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjM3NjU4MQ==","user":{"login":"detroitenglish","id":18492423,"node_id":"MDQ6VXNlcjE4NDkyNDIz","avatar_url":"https://avatars.githubusercontent.com/u/18492423?v=4","gravatar_id":"","url":"https://api.github.com/users/detroitenglish","html_url":"https://github.com/detroitenglish","followers_url":"https://api.github.com/users/detroitenglish/followers","following_url":"https://api.github.com/users/detroitenglish/following{/other_user}","gists_url":"https://api.github.com/users/detroitenglish/gists{/gist_id}","starred_url":"https://api.github.com/users/detroitenglish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/detroitenglish/subscriptions","organizations_url":"https://api.github.com/users/detroitenglish/orgs","repos_url":"https://api.github.com/users/detroitenglish/repos","events_url":"https://api.github.com/users/detroitenglish/events{/privacy}","received_events_url":"https://api.github.com/users/detroitenglish/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-12T22:34:39Z","updated_at":"2018-08-12T22:34:39Z","author_association":"NONE","body":"> ...I’d really like a way for users to use CouchDB productively without having to write a line of JavaScript. \r\n\r\nIt would seem strange to me for a database advertising itself as \"built of the web\" to divert development resources _away_ from the fundamental programming language of the web. As I understand, the use of JavaScript in CouchDB is actively promoted as a web-centric feature.\r\n\r\nUnderstandably, the performance hit from ol' SpiderMonkey must put a damper on that 'feature' for many. But considering work on Chakra is already well underway, perhaps it's best to wait for those benchmarks before deciding if a No-JS mode is worth pursuing?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412376581/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412404470","html_url":"https://github.com/apache/couchdb/issues/1501#issuecomment-412404470","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1501","id":412404470,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjQwNDQ3MA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T04:16:14Z","updated_at":"2018-08-13T04:16:14Z","author_association":"MEMBER","body":"Duplicate of #1554, oops. I'm closing this one because that ticket has a much richer discussion of this feature now.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412404470/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412405158","html_url":"https://github.com/apache/couchdb/issues/1513#issuecomment-412405158","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1513","id":412405158,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjQwNTE1OA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T04:23:51Z","updated_at":"2018-08-13T04:23:51Z","author_association":"MEMBER","body":"@detroitenglish This is not about removing JS entirely from CouchDB. **NoJS mode would be entirely optional, not the default.** It's about ensuring enough base functionality works without JS to make it a useful option. I think there's some interesting use cases for it.\r\n\r\nIt's more about security and system performance than CouchDB performance in this case. (It's worth noting that with dirty schedulers in Erlang 19+, NIF code that is CPU or I/O intensive plays more nicely with the Erlang scheduler than a pure Erlang system does, but it's can't ever be as good as pure non-dirty-scheduled code.) Heavily memory-constrained and scheduling-critical environments  like embedded and real-time systems, or an embedded CouchDB in a larger Erlang application, are candidates for this mode.\r\n\r\nYou can try to run NoJS mode today by disabling the `couchjs` query server in 1.x or 2.x, but certain things like the `_users` database's VDU are hardcoded as JS right in our source code (see #1146) so core functionality like simply adding a user breaks. Problems like that are what this ticket is tracking. \r\n\r\nYou obviously lose any JS-based design document functionality too (views, , but at least with 2.x you have Mango to give you some of that back. Other tickets are tracking enhancing CouchDB to allow things like VDUs and update functions to be written declaratively - see #1554 for example.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412405158/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412420241","html_url":"https://github.com/apache/couchdb/issues/1460#issuecomment-412420241","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1460","id":412420241,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjQyMDI0MQ==","user":{"login":"jvegaseg","id":12508470,"node_id":"MDQ6VXNlcjEyNTA4NDcw","avatar_url":"https://avatars.githubusercontent.com/u/12508470?v=4","gravatar_id":"","url":"https://api.github.com/users/jvegaseg","html_url":"https://github.com/jvegaseg","followers_url":"https://api.github.com/users/jvegaseg/followers","following_url":"https://api.github.com/users/jvegaseg/following{/other_user}","gists_url":"https://api.github.com/users/jvegaseg/gists{/gist_id}","starred_url":"https://api.github.com/users/jvegaseg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jvegaseg/subscriptions","organizations_url":"https://api.github.com/users/jvegaseg/orgs","repos_url":"https://api.github.com/users/jvegaseg/repos","events_url":"https://api.github.com/users/jvegaseg/events{/privacy}","received_events_url":"https://api.github.com/users/jvegaseg/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T06:30:20Z","updated_at":"2018-08-13T06:30:20Z","author_association":"NONE","body":"@wohali, I am referring to compact only one shard at same time on same database. When you compact a database with 16 shards, it starts compacting several shards at a same time in each node. That way of doing it requires too much disk space.\r\nFor example, if each shard has a size of 500G and it starts compacting 3 shards at same time on same node, it needs 1,5 Tb for compacting.\r\nIf it would compact only one shard at same time, it would only need 500Gb of disk space. It saves 66% of needed space.\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412420241/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412421542","html_url":"https://github.com/apache/couchdb/issues/1460#issuecomment-412421542","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1460","id":412421542,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjQyMTU0Mg==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T06:37:59Z","updated_at":"2018-08-13T18:15:07Z","author_association":"MEMBER","body":"@jvegaseg Sorry, my misunderstanding.\r\n\r\n~~Unfortunately db file has a unique value that specifies when the database was initialized. This value (effectively a coordinated datetime stamp, you can see it in the filename of the shard) is consistent across all shards on either side of the compaction process, meaning it is changed post compaction. The value is only specified once in the `_dbs` system database, which is aggressively forced to be consistent across all nodes. There's no way to say that, for node X, for shard 00-1f, use the updated shard, but for nodes Y and Z (in a standard `n=3` database) keep using the original shard since they are not yet done compacting. Things would get messy quickly.~~\r\n\r\nI can see the value in what you're proposing, but I'm not sure it's possible.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412421542/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412445785","html_url":"https://github.com/apache/couchdb/issues/1552#issuecomment-412445785","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1552","id":412445785,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjQ0NTc4NQ==","user":{"login":"strelok1010","id":42271054,"node_id":"MDQ6VXNlcjQyMjcxMDU0","avatar_url":"https://avatars.githubusercontent.com/u/42271054?v=4","gravatar_id":"","url":"https://api.github.com/users/strelok1010","html_url":"https://github.com/strelok1010","followers_url":"https://api.github.com/users/strelok1010/followers","following_url":"https://api.github.com/users/strelok1010/following{/other_user}","gists_url":"https://api.github.com/users/strelok1010/gists{/gist_id}","starred_url":"https://api.github.com/users/strelok1010/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/strelok1010/subscriptions","organizations_url":"https://api.github.com/users/strelok1010/orgs","repos_url":"https://api.github.com/users/strelok1010/repos","events_url":"https://api.github.com/users/strelok1010/events{/privacy}","received_events_url":"https://api.github.com/users/strelok1010/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T08:31:42Z","updated_at":"2018-08-13T08:31:42Z","author_association":"NONE","body":"Could you help me install dreyfus / clouseau ?. I tried to install lucence, more than 1 week ago I am trying, but without positive results. My current level is not enough to understand how to install lucence, maybe the ones you recommend are simpler to install (dreyfus / clouseau) could you help me please?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412445785/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412446600","html_url":"https://github.com/apache/couchdb/issues/1513#issuecomment-412446600","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1513","id":412446600,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjQ0NjYwMA==","user":{"login":"detroitenglish","id":18492423,"node_id":"MDQ6VXNlcjE4NDkyNDIz","avatar_url":"https://avatars.githubusercontent.com/u/18492423?v=4","gravatar_id":"","url":"https://api.github.com/users/detroitenglish","html_url":"https://github.com/detroitenglish","followers_url":"https://api.github.com/users/detroitenglish/followers","following_url":"https://api.github.com/users/detroitenglish/following{/other_user}","gists_url":"https://api.github.com/users/detroitenglish/gists{/gist_id}","starred_url":"https://api.github.com/users/detroitenglish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/detroitenglish/subscriptions","organizations_url":"https://api.github.com/users/detroitenglish/orgs","repos_url":"https://api.github.com/users/detroitenglish/repos","events_url":"https://api.github.com/users/detroitenglish/events{/privacy}","received_events_url":"https://api.github.com/users/detroitenglish/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T08:35:02Z","updated_at":"2018-08-13T08:35:02Z","author_association":"NONE","body":"@wohali Thank you for the background on this. It makes sense with your context now, even more so with the [design priorities](https://github.com/apache/couchdb/issues/1534#issuecomment-412337650) you lay out in #1534.  This issue could otherwise be misinterpreted as a core contributor highlighting another core contributor's performance frustrations and consequent desire to put JS on the back-burner (and referencing issue number 6-6-6, which I find hilarious). \r\n\r\nSeems there are a lot of tough decisions to be made right now, but imo the future looks great e.g. #1554 is a _really_ cool concept... and one hell of a shower-thought!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412446600/reactions","total_count":6,"+1":0,"-1":0,"laugh":3,"hooray":3,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412473313","html_url":"https://github.com/apache/couchdb/issues/1460#issuecomment-412473313","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1460","id":412473313,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjQ3MzMxMw==","user":{"login":"jvegaseg","id":12508470,"node_id":"MDQ6VXNlcjEyNTA4NDcw","avatar_url":"https://avatars.githubusercontent.com/u/12508470?v=4","gravatar_id":"","url":"https://api.github.com/users/jvegaseg","html_url":"https://github.com/jvegaseg","followers_url":"https://api.github.com/users/jvegaseg/followers","following_url":"https://api.github.com/users/jvegaseg/following{/other_user}","gists_url":"https://api.github.com/users/jvegaseg/gists{/gist_id}","starred_url":"https://api.github.com/users/jvegaseg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jvegaseg/subscriptions","organizations_url":"https://api.github.com/users/jvegaseg/orgs","repos_url":"https://api.github.com/users/jvegaseg/repos","events_url":"https://api.github.com/users/jvegaseg/events{/privacy}","received_events_url":"https://api.github.com/users/jvegaseg/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T10:21:04Z","updated_at":"2018-08-13T10:21:04Z","author_association":"NONE","body":"So, big databases will never compacts if you do not have very large free space on each node (in my case 4Tb free space on each node).\r\n\r\nIs is possible con compact only one shard? For example issuing a command like this:\r\n\r\ncurl --user admin:\"password\" -H \"Content-Type: application/json\" -X POST http://localhost:5986/shards%2F00000000-1fffffff%2Fmydb.1510391138/_compact\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412473313/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412485492","html_url":"https://github.com/apache/couchdb/issues/1534#issuecomment-412485492","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1534","id":412485492,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjQ4NTQ5Mg==","user":{"login":"johs","id":48370,"node_id":"MDQ6VXNlcjQ4Mzcw","avatar_url":"https://avatars.githubusercontent.com/u/48370?v=4","gravatar_id":"","url":"https://api.github.com/users/johs","html_url":"https://github.com/johs","followers_url":"https://api.github.com/users/johs/followers","following_url":"https://api.github.com/users/johs/following{/other_user}","gists_url":"https://api.github.com/users/johs/gists{/gist_id}","starred_url":"https://api.github.com/users/johs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/johs/subscriptions","organizations_url":"https://api.github.com/users/johs/orgs","repos_url":"https://api.github.com/users/johs/repos","events_url":"https://api.github.com/users/johs/events{/privacy}","received_events_url":"https://api.github.com/users/johs/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T11:17:09Z","updated_at":"2018-08-13T18:00:39Z","author_association":"NONE","body":"We have never been closer to the core of the \"couchapp\" discussion than with @wohali discussing differntiation in DB land:\r\n> I can't think of another database engine that allows you to rewrite its API....\r\n\r\n.. and  @giowild discussing _onboarding_\r\n> If no app developers will ever write apps with couchdb, no db or system administrators will be ever required to mantain its databases!\r\n\r\n.. and @ermouth discussing _syncing_ code with data\r\n> I think most features using benefits of syncing code with data flow better be kept.\r\n\r\n.. not forgetting the _prototyping_ feature that @nolanlawson desicribed so well back in 2014:\r\n>ultimately your webapp will grow in complexity to the point where you’re forced to put a proxy server in front of CouchDB to smooth out its rougher edges, but I think you’ll still be amazed how far you can get with vanilla Couch.\r\n\r\n### CouchDB has offered __truly unique__ CI/CD productivity on a single platform.\r\n\r\nIf the work with the https://github.com/cloudant-labs/erlang-chakracore is successful and javascript developers can still host their server-side functions in CouchDB and clientside apps as attachements maintained in couch/pouch mini-IDEs like http://ddoc.me/ I think the most interesting question is:\r\n__What is the disadvantage of preserving the experimental space of design documents?__ \r\n\r\nIf this opportunity space -- especially related to onboarding -- can be preserved at low cost, then it would be very unwise to remove it.\r\n\r\nPS\r\nthanks for the gentle reminder and title edit by @rnewson \r\n\r\n[wohali: Edited my handle, I am not @-joan, I am @wohali...]","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412485492/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412558279","html_url":"https://github.com/apache/couchdb/issues/1508#issuecomment-412558279","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1508","id":412558279,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjU1ODI3OQ==","user":{"login":"mikerhodes","id":453210,"node_id":"MDQ6VXNlcjQ1MzIxMA==","avatar_url":"https://avatars.githubusercontent.com/u/453210?v=4","gravatar_id":"","url":"https://api.github.com/users/mikerhodes","html_url":"https://github.com/mikerhodes","followers_url":"https://api.github.com/users/mikerhodes/followers","following_url":"https://api.github.com/users/mikerhodes/following{/other_user}","gists_url":"https://api.github.com/users/mikerhodes/gists{/gist_id}","starred_url":"https://api.github.com/users/mikerhodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikerhodes/subscriptions","organizations_url":"https://api.github.com/users/mikerhodes/orgs","repos_url":"https://api.github.com/users/mikerhodes/repos","events_url":"https://api.github.com/users/mikerhodes/events{/privacy}","received_events_url":"https://api.github.com/users/mikerhodes/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T15:26:54Z","updated_at":"2018-08-13T15:26:54Z","author_association":"CONTRIBUTOR","body":"I think the partition work doesn't end up being helpful for a couple of reasons:\r\n\r\n1. Setting up partitions in e.g., a date based way likely makes for very hot partitions (basically all writes on one partition), which would be an anti-pattern. \r\n2. Because `partition -> shard` is a `1 -> many` relationship, you wouldn't get benefits like archiving off whole shards because a shard would likely be hosting a mix of ready-to-archive partitions and not-ready-to-archive partitions.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412558279/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412562014","html_url":"https://github.com/apache/couchdb/issues/1508#issuecomment-412562014","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1508","id":412562014,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjU2MjAxNA==","user":{"login":"mikerhodes","id":453210,"node_id":"MDQ6VXNlcjQ1MzIxMA==","avatar_url":"https://avatars.githubusercontent.com/u/453210?v=4","gravatar_id":"","url":"https://api.github.com/users/mikerhodes","html_url":"https://github.com/mikerhodes","followers_url":"https://api.github.com/users/mikerhodes/followers","following_url":"https://api.github.com/users/mikerhodes/following{/other_user}","gists_url":"https://api.github.com/users/mikerhodes/gists{/gist_id}","starred_url":"https://api.github.com/users/mikerhodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikerhodes/subscriptions","organizations_url":"https://api.github.com/users/mikerhodes/orgs","repos_url":"https://api.github.com/users/mikerhodes/repos","events_url":"https://api.github.com/users/mikerhodes/events{/privacy}","received_events_url":"https://api.github.com/users/mikerhodes/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T15:38:11Z","updated_at":"2018-08-13T15:38:11Z","author_association":"CONTRIBUTOR","body":"To be more positive, FWIW, I had some thoughts on this a while ago, and thought you could fold this kind of feature into a set of document lifecycle rules based on Mango selectors. In addition to archiving, you could also have delete as an action for TTL, so I wanted to capture the idea of combining potentially different actions and conditions into rules.\r\n\r\nWhat I thought was something that works like this. There's a set of one or more rules in a ddoc section which define actions and conditions using a selector. The action is `archive`, `delete` and so on. The conditions are things like comparing a `doc_expiry` field in a document with \"now\" :\r\n\r\n```json\r\n{\r\n  \"_id\": \"_design/lifecyle-example\",\r\n  \"_rev\": \"19-4426420428e8744fcfb67763cedd1ea8\",\r\n  \"doc-lifecycle-rules\": [\r\n    {\r\n      \"action\": \"archive\", \r\n      \"condition\": [ { \"doc_expiry\": { \"$lt\": \"$$now\"}, \"type\": \"vital_entry\"} ]\r\n    },\r\n    {\r\n      \"action\": \"delete\", \r\n      \"condition\": [ { \"doc_expiry\": { \"$lt\": \"$$now\"}, \"type\": \"spurious_entry\"} ]\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nHere:\r\n\r\n- `$$now` is a new a special variable syntax, and there would be a few predefined ones like `$$now` so this feature can specify dynamic rules.\r\n- `doc-lifecycle-rules` contains an array of (action,selector) pairs.\r\n    - Maybe there's an `options` field which would take e.g., archiving destination.\r\n- Periodically, say once per minute, the (action,selector) pairs are evaluated against the documents in the database.\r\n    - I'd expect an index would be auto-created from the condition selector to make this cheap, so the selector may need to be heavily restricted such that it can be evaluated from an index alone to identify affected documents.\r\n- At evaluation time, if more than one (action,selector) pair matches a document, only a single action of the matching actions will be run. \r\n    - It's undefined which action happens, but only one will happen before the conditions are re-evaluated. Also, we don't guarantee an ordering, as that would need to be a total ordering over all (action,selector) pairs in all ddocs in the database.\r\n- Action is a set of atoms rather than freeform text. Broadly the database supports a few key workloads rather than it being arbitrarily expandable.\r\n- The format allows more actions to gradually be added.\r\n- We obviously allow for multiple ddocs to have these rules in them.\r\n- Actions are evaluated async, and we don't guarantee that if, for example, a document should've been expired from the database that it won't appear in search/view/query requests, you can still GET  it, etc.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412562014/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412571999","html_url":"https://github.com/apache/couchdb/issues/1555#issuecomment-412571999","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1555","id":412571999,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjU3MTk5OQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T16:06:55Z","updated_at":"2018-08-13T16:06:55Z","author_association":"MEMBER","body":"Through experience, CouchDB developers recommend using [HAProxy](https://www.haproxy.org/) as a load balancer. We provide a default configuration that just works™ here: https://github.com/apache/couchdb/blob/master/rel/haproxy.cfg\r\n\r\nWe do [document our recommended Nginx configuration](http://docs.couchdb.org/en/stable/best-practices/nginx.html) as well. Getting it right is difficult, and there are specific issues with configuring Nginx properly as a reverse proxy for CouchDB when you are using replication, so be sure to review our documentation.\r\n\r\nAt present, CouchDB does not natively have the concept of \"read-only replicas,\" so there is no need to separate `GET` and `PUT` requests.\r\n\r\nFinally, remember that in a 2.x CouchDB cluster, additional nodes don't participate in requests for databases you've already created unless you move shards to those new nodes. See the new 2.2.0 documentation on [shard management](http://docs.couchdb.org/en/stable/cluster/sharding.html) for more details.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412571999/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412591754","html_url":"https://github.com/apache/couchdb/issues/1556#issuecomment-412591754","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1556","id":412591754,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjU5MTc1NA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T17:06:53Z","updated_at":"2018-08-13T17:06:53Z","author_association":"MEMBER","body":"@greenais Did you change the `_security` object on the `_users` database? That is unsupported.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412591754/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412608018","html_url":"https://github.com/apache/couchdb/issues/1516#issuecomment-412608018","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1516","id":412608018,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjYwODAxOA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T17:57:48Z","updated_at":"2018-08-13T17:57:48Z","author_association":"MEMBER","body":"This is a duplicate of #1269 as it turns out.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412608018/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412608218","html_url":"https://github.com/apache/couchdb/issues/1269#issuecomment-412608218","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1269","id":412608218,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjYwODIxOA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T17:58:24Z","updated_at":"2018-08-13T17:58:24Z","author_association":"MEMBER","body":"From the merged #1516:\r\n\r\nOnce #1515 is done, this should be easy.\r\n\r\n@janl:\r\n>* deeeper clouseau/dreyfus integration\r\n>* elasticsearch?\r\n\r\n@davisp:\r\n> At least a clear example of how to bundle and include Clouseau/Dreyfus.\r\n> Just had someone ask how to use Dreyfus/Clouseau with CouchDB and I had to google for instructions and came across this:\r\n>\r\n>https://developer.ibm.com/dwblog/2015/text-search-apache-couchdb/\r\n>\r\n>Definitely Exhibit A on needing better integration. That's a lot of difficult steps for getting full text set up.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412608218/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412608393","html_url":"https://github.com/apache/couchdb/issues/1552#issuecomment-412608393","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1552","id":412608393,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjYwODM5Mw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T17:58:56Z","updated_at":"2018-08-13T17:58:56Z","author_association":"MEMBER","body":"@strelok1010 dreyfus/clouseau include Lucene as a dependency. The best installation instructions of which I'm aware are here:\r\n\r\nhttps://github.com/cloudant-labs/dreyfus/wiki/Introduce-dreyfus-into-couchdb\r\n\r\nOlder instructions that are easier to read but are no longer 100% accurate are here: https://developer.ibm.com/dwblog/2015/text-search-apache-couchdb/#.WB9FOZNS1-U\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412608393/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412608601","html_url":"https://github.com/apache/couchdb/issues/1460#issuecomment-412608601","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1460","id":412608601,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjYwODYwMQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T17:59:33Z","updated_at":"2018-08-13T17:59:33Z","author_association":"MEMBER","body":"@jvegaseg I do not know if this is possible. I will ask someone else to comment.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412608601/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412611066","html_url":"https://github.com/apache/couchdb/issues/1534#issuecomment-412611066","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1534","id":412611066,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjYxMTA2Ng==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T18:06:59Z","updated_at":"2018-08-13T18:06:59Z","author_association":"MEMBER","body":"Speaking for myself, the disadvantage is that these features have poor functionality as compared to what you can do with an app server alongside or in front of CouchDB. They mislead people into thinking CouchDB is a fully-fledged application server environment. People waste time building things in this environment, discover all of the inherent limitations, and have to rewrite everything in an standalone app server. They then complain about the lack of functionality in something that has stagnated for many years.\r\n\r\nBringing chakracore into CouchDB is not going to allow you to npm install modules into a ddoc so you can leverage the entire JS ecosystem inside a CouchApp. The sandbox I expect to come with the new engine will continue to enforce the same limitations that exist in the current query server implementation.\r\n\r\nTo put a finer point on the standpoint of the entire development team, the [documentation](http://docs.couchdb.org/en/stable/ddocs/index.html)'s single remaining reference to CouchApps has a good summary that I wrote in coordination with them:\r\n\r\n> Note: Previously, the functionality provided by CouchDB’s design documents, in combination with document attachments, was referred to as “CouchApps.” The general principle was that entire web applications could be hosted in CouchDB, without need for an additional application server.\r\n\r\n> Use of CouchDB as a combined standalone database and application server is no longer recommended. There are significant limitations to a pure CouchDB web server application stack, including but not limited to: fully-fledged fine-grained security, robust templating and scaffolding, complete developer tooling, and most importantly, a thriving ecosystem of developers, modules and frameworks to choose from.\r\n\r\n> The developers of CouchDB believe that web developers should pick “the right tool for the right job”. Use CouchDB as your database layer, in conjunction with any number of other server-side web application frameworks, such as the entire Node.JS ecosystem, Python’s Django and Flask, PHP’s Drupal, Java’s Apache Struts, and more.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412611066/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412613881","html_url":"https://github.com/apache/couchdb/issues/1460#issuecomment-412613881","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1460","id":412613881,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjYxMzg4MQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T18:15:45Z","updated_at":"2018-08-13T18:15:45Z","author_association":"MEMBER","body":"Seems I am wrong about the filename changing, so the contents of the `_dbs` database don't need special handling.\r\n\r\nWe're looking into the compaction process now to see what's up with multiple shards compacting at once. We'll get back to you soon.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412613881/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412642779","html_url":"https://github.com/apache/couchdb/issues/1514#issuecomment-412642779","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1514","id":412642779,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjY0Mjc3OQ==","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T19:54:58Z","updated_at":"2018-08-13T19:54:58Z","author_association":"MEMBER","body":"I'd like to see the protocol support the option to run a query server as a separate network service.\r\n\r\nThere's been significant adoption of [gRPC](https://grpc.io/) in the cloud-native computing world recently. I think this could provide a lot of interesting benefits including the network service (HTTP/2 is used for transport) and the streaming piece mentioned above.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412642779/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412644439","html_url":"https://github.com/apache/couchdb/issues/1514#issuecomment-412644439","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1514","id":412644439,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjY0NDQzOQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T20:00:46Z","updated_at":"2018-08-13T20:01:31Z","author_association":"MEMBER","body":"If we're talking about reworking the protocol, it is worth considering the implications of how we enforce sandboxing. As soon as you move to a network interface or simliar, there's nothing that stops that process from having crazy side effects, like storing the document locally, making calls back to CouchDB __while a document is being processed__, etc. Our current JS implementation is very strict about not allowing those things, and it's always bugged me that people used to write their own \"query servers\" that did all of these things that violate the contract between Couch and a query server.\r\n\r\n@kocolosk wouldn't it make more sense to keep everything inside of Erlang to enforce the above, and just redo rexi so it uses gRPC?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412644439/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412647604","html_url":"https://github.com/apache/couchdb/issues/1460#issuecomment-412647604","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1460","id":412647604,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjY0NzYwNA==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T20:11:56Z","updated_at":"2018-08-13T20:11:56Z","author_association":"MEMBER","body":"@jvegaseg: yes, you can compact shards one by one. ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412647604/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412652185","html_url":"https://github.com/apache/couchdb/issues/1514#issuecomment-412652185","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1514","id":412652185,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjY1MjE4NQ==","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T20:27:26Z","updated_at":"2018-08-13T20:27:26Z","author_association":"MEMBER","body":"Hmm, I guess I thought the sandboxing was a rather separate issue from the communication protocol. I'm not sure I see how they're related here.\r\n\r\nI'm certainly open to more innovation that reduces the need for custom code execution.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412652185/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412653530","html_url":"https://github.com/apache/couchdb/issues/1460#issuecomment-412653530","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1460","id":412653530,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjY1MzUzMA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T20:31:28Z","updated_at":"2018-08-13T20:31:28Z","author_association":"MEMBER","body":"@jvegaseg also a reminder that the compaction daemon will always compact one shard at a time. It will not compact all at once like your compaction on port 5984 does.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412653530/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412666013","html_url":"https://github.com/apache/couchdb/issues/1514#issuecomment-412666013","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1514","id":412666013,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjY2NjAxMw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T21:11:57Z","updated_at":"2018-08-13T21:11:57Z","author_association":"MEMBER","body":"@kocolosk @davisp My argument is that the query server needs to go, entirely, so people don't mistake it for an external interface. If it's an internal Erlang thing (such as a gRPC rexi implementation or whatever) then it's immaterial, that's as good as a write-only language for many. ;)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412666013/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412683059","html_url":"https://github.com/apache/couchdb/pull/1478#issuecomment-412683059","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1478","id":412683059,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjY4MzA1OQ==","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T22:13:38Z","updated_at":"2018-08-13T22:13:38Z","author_association":"CONTRIBUTOR","body":"@iilyak can you merge this for me please?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412683059/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412683804","html_url":"https://github.com/apache/couchdb/pull/1486#issuecomment-412683804","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1486","id":412683804,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjY4MzgwNA==","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T22:16:47Z","updated_at":"2018-08-13T22:16:47Z","author_association":"CONTRIBUTOR","body":"@iilyak I have rebased -- can you merge this?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412683804/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412684326","html_url":"https://github.com/apache/couchdb/pull/1492#issuecomment-412684326","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1492","id":412684326,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjY4NDMyNg==","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T22:18:49Z","updated_at":"2018-08-13T22:18:49Z","author_association":"CONTRIBUTOR","body":"@garrensmith thanks for the review! Can you merge this for me?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412684326/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412694183","html_url":"https://github.com/apache/couchdb/issues/1460#issuecomment-412694183","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1460","id":412694183,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjY5NDE4Mw==","user":{"login":"jvegaseg","id":12508470,"node_id":"MDQ6VXNlcjEyNTA4NDcw","avatar_url":"https://avatars.githubusercontent.com/u/12508470?v=4","gravatar_id":"","url":"https://api.github.com/users/jvegaseg","html_url":"https://github.com/jvegaseg","followers_url":"https://api.github.com/users/jvegaseg/followers","following_url":"https://api.github.com/users/jvegaseg/following{/other_user}","gists_url":"https://api.github.com/users/jvegaseg/gists{/gist_id}","starred_url":"https://api.github.com/users/jvegaseg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jvegaseg/subscriptions","organizations_url":"https://api.github.com/users/jvegaseg/orgs","repos_url":"https://api.github.com/users/jvegaseg/repos","events_url":"https://api.github.com/users/jvegaseg/events{/privacy}","received_events_url":"https://api.github.com/users/jvegaseg/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T23:01:25Z","updated_at":"2018-08-13T23:01:25Z","author_association":"NONE","body":"Ok thanks a lot","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412694183/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412700311","html_url":"https://github.com/apache/couchdb/pull/1468#issuecomment-412700311","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1468","id":412700311,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjcwMDMxMQ==","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-13T23:29:48Z","updated_at":"2018-08-13T23:29:48Z","author_association":"CONTRIBUTOR","body":"@iilyak if you are ok with the latest changes, please LMK, and I will squash and rebase as necessary.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412700311/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412759880","html_url":"https://github.com/apache/couchdb/issues/1556#issuecomment-412759880","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1556","id":412759880,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjc1OTg4MA==","user":{"login":"greenais","id":16271522,"node_id":"MDQ6VXNlcjE2MjcxNTIy","avatar_url":"https://avatars.githubusercontent.com/u/16271522?v=4","gravatar_id":"","url":"https://api.github.com/users/greenais","html_url":"https://github.com/greenais","followers_url":"https://api.github.com/users/greenais/followers","following_url":"https://api.github.com/users/greenais/following{/other_user}","gists_url":"https://api.github.com/users/greenais/gists{/gist_id}","starred_url":"https://api.github.com/users/greenais/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/greenais/subscriptions","organizations_url":"https://api.github.com/users/greenais/orgs","repos_url":"https://api.github.com/users/greenais/repos","events_url":"https://api.github.com/users/greenais/events{/privacy}","received_events_url":"https://api.github.com/users/greenais/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T05:36:39Z","updated_at":"2018-08-14T05:36:39Z","author_association":"NONE","body":"@wohali Yes. otherwise user couldn't access his own doc from _users db, getting 403 error above. \r\nBtw, in docs I can't find anything about any resctrictions of modifying _security doc for _users, only _auth is locked, is that right?\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412759880/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412794194","html_url":"https://github.com/apache/couchdb/issues/1554#issuecomment-412794194","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1554","id":412794194,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjc5NDE5NA==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T08:24:33Z","updated_at":"2018-08-14T17:11:15Z","author_association":"MEMBER","body":"I really like where this is going, great first draft!\r\n\r\nQuick initial notes up top:\r\n- I like the unification of VDU and _update into one thing that is logically “stuff that happens before a doc hits the db.”\r\n- I’d leave out `queries` in this example, this would open up having to handle cluster network error on the doc write path. We can revisit this at a later point, the current design here allows for an easy extension later on. I think it’ll simplify the already complex discussions required for a baseline feature (which I’m going to extend shortly).\r\n\r\nOne further aspect that we should discuss the other use of VDUs. To recap, VDUs are used to enforce document schema (this is handled in this draft) and authorisation, where check doc contents against the context of `ctx`.\r\n\r\nhttp://docs.couchdb.org/en/stable/ddocs/ddocs.html#vdufun\r\n\r\nFor Example:\r\n\r\n```js\r\nfunction (newDoc, oldDoc, userCtx) {\r\n  // in an authenticated request, userCtx.user is the authenticated username\r\n  // so we can:\r\n\r\n  if (oldDoc.author != userCtx.name) {\r\n    throw({ forbidden: 'you can’t update other user’s docs.' })\r\n  }\r\n}\r\n```\r\n\r\n[`userCtx` Definition](http://docs.couchdb.org/en/stable/json-structure.html#userctx-object)\r\n\r\nIn addition, there is a fourth parameter, the `secObj`, which is the database’s [`_security` object](http://docs.couchdb.org/en/stable/json-structure.html#security-object)\r\n\r\n```js\r\nfunction (newDoc, oldDoc, userCtx, secObj) {\r\n  if (secObj.members.names.indexOf(userCtx.name) === -1) {\r\n    throw({ forbidden: 'you can’t update if you’re not a member.' }) // contrived example, you wouldn’t get to this part in the first place, because the _security check comes first, but you should get what is meant\r\n  }\r\n}\r\n```\r\n\r\nWe could argue that this could co-incide with the [security overhaul](https://github.com/apache/couchdb/issues/1504), which would take care of any authentication, and I’m happy to discuss this separately if needed, I just wanted to bring this up.\r\n\r\nMaybe the draft can be amended, so `fields` becomes `schema`, and we introduce `authorisation` as a new top level field:\r\n\r\n```js\r\n{\r\n\"fields\": {\r\n    \"whitelist\": [\"type\", \"datetime\", \"ip_address\", \"station_name\", \"temperature\", \"RH%\", \"rain_gauge\", \"wind.speed\", \"wind.direction\", \"light\", \"battery.voltage\", \"battery.current\", \"line.voltage\", \"line.current\", \"solar.voltage\", \"solar.current\", \"register_total\"],\r\n    \"blacklist\": [\"battery.wattage\", \"rain_gauge.*\"],\r\n    \"formats\": {\r\n      \"type\": [\"sensor_reading\"],\r\n      \"datetime\": {\r\n        \"$or\": {\r\n          \"$format\": \"$iso8601\",\r\n          \"$format\": \"$unixepoch\",\r\n          \"$regex\": \"(\\\\d{2})-(\\\\d{2})-(\\\\d{2}) (\\\\d{2}):(\\\\d{2}):(\\\\d{2})\"\r\n        }\r\n      },\r\n      \"battery.voltage\": \"$float\",\r\n      \"battery.current\": \"$float\",\r\n      \"register_total\": { \"$regex\": \"^\\\\$\\\\d{1,9}\\\\.\\\\d{2}$\" },\r\n      \"wind.direction\": {\"$or\": [\"N\", \"NE\", \"E\", \"SE\", \"S\", \"SW\", \"W\", \"NW\"]}\r\n      ...\r\n    }\r\n  },\r\n  \"authorisation\": [\r\n       {\r\n         \"author\": { \"$eq\" : \"$userCtx.name\" },\r\n         \"throw\": \"you can’t update other user’s docs.\" \r\n    ]}\r\n  }\r\n```\r\n\r\nwhere the line `\"throw\": \"you can’t update other user’s docs.\"` is equivalent to the `throw({ forbidden: 'you can’t update other user’s docs.' })`-line from the first example above. `$secObj` would work similarly.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412794194/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412809591","html_url":"https://github.com/apache/couchdb/issues/1544#issuecomment-412809591","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1544","id":412809591,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjgwOTU5MQ==","user":{"login":"ermouth","id":1540047,"node_id":"MDQ6VXNlcjE1NDAwNDc=","avatar_url":"https://avatars.githubusercontent.com/u/1540047?v=4","gravatar_id":"","url":"https://api.github.com/users/ermouth","html_url":"https://github.com/ermouth","followers_url":"https://api.github.com/users/ermouth/followers","following_url":"https://api.github.com/users/ermouth/following{/other_user}","gists_url":"https://api.github.com/users/ermouth/gists{/gist_id}","starred_url":"https://api.github.com/users/ermouth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ermouth/subscriptions","organizations_url":"https://api.github.com/users/ermouth/orgs","repos_url":"https://api.github.com/users/ermouth/repos","events_url":"https://api.github.com/users/ermouth/events{/privacy}","received_events_url":"https://api.github.com/users/ermouth/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T09:20:41Z","updated_at":"2018-08-14T09:20:41Z","author_association":"CONTRIBUTOR","body":"I also confirm that the issue seems to be fixed with the patch.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412809591/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412817741","html_url":"https://github.com/apache/couchdb/issues/1556#issuecomment-412817741","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1556","id":412817741,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjgxNzc0MQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T09:50:56Z","updated_at":"2018-08-14T09:50:56Z","author_association":"MEMBER","body":"You're right, this is an oversight in the documentation. I've opened an issue to track this: apache/couchdb-documentation#317\r\n\r\nIn short:\r\n1. Do not change the `_security` object on the `_users` database. We don't recommend changing it, and the consequences are on you.\r\n1. The expected behaviour for `_users` is that, once you have created a server-level admin user (taking CouchDB out of Admin Party), any user can view and edit their own `_users` database document, and cannot view or edit any other user's database document. The full list of rules is here: http://docs.couchdb.org/en/stable/intro/security.html#authentication-database\r\n1. Don't treat `_users` as a \"proper\" CouchDB database; it is handled specially and not everything you can do to a regular database can be done to `_users`.\r\n1. A future release will prevent you from changing the `_users` database's `_security` object, and also remove any reason to do so, as the DB itself will only be accessible through API logic - see #1534 \r\n1. A full rework of CouchDB's security model is coming in the 3.x-ish timeframe, see #1504.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412817741/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412818423","html_url":"https://github.com/apache/couchdb/issues/1556#issuecomment-412818423","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1556","id":412818423,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjgxODQyMw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T09:53:38Z","updated_at":"2018-08-14T09:53:38Z","author_association":"MEMBER","body":"FYI I tested your setup, with `require_valid_user=true`, without changing the `_security` object on `_users`, and even with roles created and assigned to users, `_users` access remained as described in the documentation. That is, every user was able to see and edit only their own document.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412818423/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412820127","html_url":"https://github.com/apache/couchdb/issues/1554#issuecomment-412820127","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1554","id":412820127,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjgyMDEyNw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T10:00:06Z","updated_at":"2018-08-14T10:00:06Z","author_association":"MEMBER","body":"I like this idea, and especially the ability to use multiple docs of this format to enforce rules such as \"only users with role `sensor` are able to add/modify documents of type `sensor`. It's not fully-fledged per-doc auth since this only is traversed on the write path, but it might be a way forward for the read-path too (if people are willing to accept the massive performance penalty it'll invoke).\r\n\r\nThe `queries` idea was blue sky, happy to break it into a separate issue so it doesn't get lost when we implement this one.\r\n\r\nI'm flexible on what lives where in the actual doc, would like to see some other opinions as well.\r\n\r\nI would say that for `authorisation`, since you didn't break things out into separate `selector` and `action` sections, we use `$throw` to ensure we don't overlap any tests against a real document key named `throw`. We'll need to work out escaping just in case someone DOES have a key named `$throw`, same for the other sections as well.\r\n\r\nThe alternative is to prefix all document fields with `$doc` but I think this makes things needlessly verbose, don't you?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412820127/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412823016","html_url":"https://github.com/apache/couchdb/issues/1554#issuecomment-412823016","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1554","id":412823016,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjgyMzAxNg==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T10:11:41Z","updated_at":"2018-08-14T10:11:41Z","author_association":"MEMBER","body":"yeah not a fan of `$doc` prefix, but `$throw` works fine.\r\n\r\nThat might dovetail into my next proposal (that I’ll open a new ticket for), to add string manipulation funs to Mango, those then would follow the same lead, say `$strlen(field.sub)`, but let’s keep that definitely separate from this proposal ;D","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412823016/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412856429","html_url":"https://github.com/apache/couchdb/issues/1554#issuecomment-412856429","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1554","id":412856429,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjg1NjQyOQ==","user":{"login":"mikerhodes","id":453210,"node_id":"MDQ6VXNlcjQ1MzIxMA==","avatar_url":"https://avatars.githubusercontent.com/u/453210?v=4","gravatar_id":"","url":"https://api.github.com/users/mikerhodes","html_url":"https://github.com/mikerhodes","followers_url":"https://api.github.com/users/mikerhodes/followers","following_url":"https://api.github.com/users/mikerhodes/following{/other_user}","gists_url":"https://api.github.com/users/mikerhodes/gists{/gist_id}","starred_url":"https://api.github.com/users/mikerhodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikerhodes/subscriptions","organizations_url":"https://api.github.com/users/mikerhodes/orgs","repos_url":"https://api.github.com/users/mikerhodes/repos","events_url":"https://api.github.com/users/mikerhodes/events{/privacy}","received_events_url":"https://api.github.com/users/mikerhodes/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T12:35:37Z","updated_at":"2018-08-14T12:35:37Z","author_association":"CONTRIBUTOR","body":"@janl should your JSON snippet be (i..e, with the `schema` and `authorization` top level fields):\r\n\r\n```\r\n{\r\n    \"schema\": {\r\n        \"whitelist\": [\r\n            \"type\",\r\n            \"datetime\",\r\n            \"others.....\"\r\n        ],\r\n        ...\r\n    },\r\n    \"authorization\": [\r\n        {\r\n            \"author\": { \"$eq\": \"$userCtx.name\" },\r\n            \"throw\": \"you can’t update other user’s docs.\"\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\nAlso, I used American spelling for \"authorization\".\r\n\r\nSuggestion:\r\n\r\n- I think for clarity, splitting out the selector and action in the authorization field as @wohali suggests means you can avoid the ambiguity of field name vs. processing instruction. Collapsing them together feels confusing to me.\r\n\r\nQuestions:\r\n\r\n- What would happen when replicating to older db versions that don't understand some part of the validation (e.g., didn't understand `formats` part of `schema`)? Be lenient (ignore bits not understood) or strict (fail validation when can't process the whole set of instructions)?\r\n- There's an information leak possible: write-only users can discern document shape by observing error messages for schema.\r\n    - Perhaps an optional `throw` clause which would allow the user to override default error to prevent this leakage.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412856429/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412856874","html_url":"https://github.com/apache/couchdb/issues/1556#issuecomment-412856874","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1556","id":412856874,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjg1Njg3NA==","user":{"login":"greenais","id":16271522,"node_id":"MDQ6VXNlcjE2MjcxNTIy","avatar_url":"https://avatars.githubusercontent.com/u/16271522?v=4","gravatar_id":"","url":"https://api.github.com/users/greenais","html_url":"https://github.com/greenais","followers_url":"https://api.github.com/users/greenais/followers","following_url":"https://api.github.com/users/greenais/following{/other_user}","gists_url":"https://api.github.com/users/greenais/gists{/gist_id}","starred_url":"https://api.github.com/users/greenais/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/greenais/subscriptions","organizations_url":"https://api.github.com/users/greenais/orgs","repos_url":"https://api.github.com/users/greenais/repos","events_url":"https://api.github.com/users/greenais/events{/privacy}","received_events_url":"https://api.github.com/users/greenais/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T12:37:29Z","updated_at":"2018-08-14T12:37:29Z","author_association":"NONE","body":"@wohali Thank you for comprehensive answer, I wil take care of not changing _security in _users anymore.\r\nBut question remains - why in my setup CDB was blocking user from accessing his own doc in _users?\r\nI created _users DB via API (under Node) quite long ago and I'm in doubt if after that _admin role was there originally in Member Roles. Could you please check it in your Fauxton? Perhaps I added it myself on some stage for some reason, not sure..\r\nFYI: I removed all Users/Roles from Members section in Fauxton - and now it works as intended, no 403 errors anymore. So the root of issue was that _admin in Roles. \r\nProbably it's a really good idea to block admins from modifying _security object as it leads to such side effects, you are right.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412856874/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412857346","html_url":"https://github.com/apache/couchdb/issues/1504#issuecomment-412857346","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1504","id":412857346,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjg1NzM0Ng==","user":{"login":"mikerhodes","id":453210,"node_id":"MDQ6VXNlcjQ1MzIxMA==","avatar_url":"https://avatars.githubusercontent.com/u/453210?v=4","gravatar_id":"","url":"https://api.github.com/users/mikerhodes","html_url":"https://github.com/mikerhodes","followers_url":"https://api.github.com/users/mikerhodes/followers","following_url":"https://api.github.com/users/mikerhodes/following{/other_user}","gists_url":"https://api.github.com/users/mikerhodes/gists{/gist_id}","starred_url":"https://api.github.com/users/mikerhodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikerhodes/subscriptions","organizations_url":"https://api.github.com/users/mikerhodes/orgs","repos_url":"https://api.github.com/users/mikerhodes/repos","events_url":"https://api.github.com/users/mikerhodes/events{/privacy}","received_events_url":"https://api.github.com/users/mikerhodes/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T12:39:23Z","updated_at":"2018-08-14T12:39:23Z","author_association":"CONTRIBUTOR","body":"It would be good to see a clearly defined security layer cut through the database horizontally in any refactoring / building from scratch (e.g., sitting above fabric, so anything below fabric can assume authorised). This would also help a lot with any efforts to separate out different database subsystems, if, e.g., the whole storage subsystem doesn't have to care about users, roles etc.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412857346/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412861150","html_url":"https://github.com/apache/couchdb/issues/1537#issuecomment-412861150","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1537","id":412861150,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjg2MTE1MA==","user":{"login":"mikerhodes","id":453210,"node_id":"MDQ6VXNlcjQ1MzIxMA==","avatar_url":"https://avatars.githubusercontent.com/u/453210?v=4","gravatar_id":"","url":"https://api.github.com/users/mikerhodes","html_url":"https://github.com/mikerhodes","followers_url":"https://api.github.com/users/mikerhodes/followers","following_url":"https://api.github.com/users/mikerhodes/following{/other_user}","gists_url":"https://api.github.com/users/mikerhodes/gists{/gist_id}","starred_url":"https://api.github.com/users/mikerhodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikerhodes/subscriptions","organizations_url":"https://api.github.com/users/mikerhodes/orgs","repos_url":"https://api.github.com/users/mikerhodes/repos","events_url":"https://api.github.com/users/mikerhodes/events{/privacy}","received_events_url":"https://api.github.com/users/mikerhodes/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T12:53:19Z","updated_at":"2018-08-14T12:53:26Z","author_association":"CONTRIBUTOR","body":"@wohali A thought I had in this vein is storing JSON-as-binary, as described at https://github.com/cockroachdb/cockroach/blob/master/docs/RFCS/20171005_jsonb_encoding.md for a faster processing pipeline. It sounds like this idea is different though?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412861150/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412946496","html_url":"https://github.com/apache/couchdb/issues/1554#issuecomment-412946496","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1554","id":412946496,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjk0NjQ5Ng==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T17:10:26Z","updated_at":"2018-08-14T17:10:26Z","author_association":"MEMBER","body":"@mikerhodes good catch, that's a typo!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412946496/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412977409","html_url":"https://github.com/apache/couchdb/issues/1554#issuecomment-412977409","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1554","id":412977409,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjk3NzQwOQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T18:50:11Z","updated_at":"2018-08-14T18:50:11Z","author_association":"MEMBER","body":"@mikerhodes asks:\r\n\r\n\r\n> * What would happen when replicating to older db versions that don't  understand some part of the validation (e.g., didn't understand formats part of schema)? Be lenient (ignore bits not understood) or strict (fail validation when can't process the whole set of instructions)? \r\n\r\nIdea 1: Maybe we need a version field, regardless of what we do with this, if not specified we assume it's the version of whatever the current runtime is\r\nIdea 2: Maybe we need a `\"fail\": \"closed|open\"` setting per-VDU\r\nIdea 3: Maybe we need a server setting in `local.ini` to toggle the same thing\r\n\r\nThe latter 2 come from electronic door locks that generally come with a user-configurable setting for this.\r\n\r\n> * There's an information leak possible: write-only users can discern document shape by observing error messages for schema. Perhaps an optional throw clause which would allow the user to override default error to prevent this leakage.\r\n\r\nWell, in Apache CouchDB, there are no such things as write-only users to my knowledge. Are you talking about a Cloudant-specific thing, or something that might come in with #1504 ?\r\n\r\nI was imagining that if any of the tests failed (pre-@janl's change) a generic response would be provided, along the lines of `document failed validation`, _maybe_ including the name of the whatever-we-call-this to point a finger, but not explictly including the precise reason for failure. I like the idea of a `$throw.default` to override that message if you want, but I'm not sure it does much?\r\n\r\nThe other option would be to provide a `\"debug\": true/false` boolean toggle that would include precise info about the reason for a document's failure. We've done a poor job of helping users debug their JS functions in the past. Putting the control over debugging a Mango-VDU in the hands of the developer would be a big step up in my opinion.\r\n\r\nThanks for the discussion!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412977409/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412980915","html_url":"https://github.com/apache/couchdb/issues/1556#issuecomment-412980915","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1556","id":412980915,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjk4MDkxNQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T19:01:50Z","updated_at":"2018-08-14T19:01:50Z","author_association":"MEMBER","body":"@greenais After running a brand new test 2.2.0 node, here's what I see:\r\n\r\n```bash\r\n$ curl http://root:password@localhost:15984/_users/_security\r\n{}\r\n```\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412980915/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412982808","html_url":"https://github.com/apache/couchdb/issues/1558#issuecomment-412982808","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1558","id":412982808,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjk4MjgwOA==","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T19:08:46Z","updated_at":"2018-08-14T19:08:46Z","author_association":"MEMBER","body":"It's a difficult thing to remove at this late stage, though I agree with the proposal.\r\n\r\nShould we fold this into the broader push to hide these databases behind an API that enforces only the semantics we wish?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412982808/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412983453","html_url":"https://github.com/apache/couchdb/issues/1558#issuecomment-412983453","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1558","id":412983453,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjk4MzQ1Mw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T19:11:03Z","updated_at":"2018-08-14T19:11:03Z","author_association":"MEMBER","body":"@rnewson If a naive block is a problem for 2.x, we can just say this is backwards-incompatible and fold it into #1504 if you want, sure. I just thought maybe a 2.3 that blocked `_users/_security` writes wouldn't be too hard to implement, and shouldn't affect TOO many people...","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412983453/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412983700","html_url":"https://github.com/apache/couchdb/pull/1543#issuecomment-412983700","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1543","id":412983700,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjk4MzcwMA==","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T19:12:04Z","updated_at":"2018-08-14T19:14:40Z","author_association":"CONTRIBUTOR","body":"I want to provide a status update. \r\n\r\nThere is a slight bump on the way to update JS test suite to use new endpoint. \r\nWhen `_restart` is invoked it reinitialize all of the OTP applications, but it doesn't restart beam itself (same approach as in couchdb 1x). This means that uptime is not updated. The `uptime` returned from `_system` is used to check that the restart is completed.\r\n\r\nI am working on finding the solution.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412983700/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412984158","html_url":"https://github.com/apache/couchdb/issues/1537#issuecomment-412984158","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1537","id":412984158,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjk4NDE1OA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T19:13:44Z","updated_at":"2018-08-14T19:13:44Z","author_association":"MEMBER","body":"@mikerhodes Yup, that's different, this is about accepting binary data on the HTTP API (though I know that we previously said we'd not do BSON)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412984158/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412985909","html_url":"https://github.com/apache/couchdb/issues/1558#issuecomment-412985909","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1558","id":412985909,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjk4NTkwOQ==","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T19:20:07Z","updated_at":"2018-08-14T19:20:28Z","author_association":"MEMBER","body":"It's hard to know how many have changed the security object of _users. Those that have done so and _not_ encountered a problem will be broken by this change; those that _have_ encountered a problem will have had to reverse their change already.\r\n\r\nI think we should save the breakingchangeness until we present a full replacement for this; the API that sits in front of this database and only permits what it ought to.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412985909/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412986591","html_url":"https://github.com/apache/couchdb/issues/1558#issuecomment-412986591","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1558","id":412986591,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjk4NjU5MQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T19:22:42Z","updated_at":"2018-08-14T19:22:42Z","author_association":"MEMBER","body":"+1, let's leave this unti #1504. I'll close this for now.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412986591/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412997032","html_url":"https://github.com/apache/couchdb/issues/1558#issuecomment-412997032","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1558","id":412997032,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjk5NzAzMg==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T20:00:39Z","updated_at":"2018-08-14T20:00:39Z","author_association":"MEMBER","body":"Alternatively, like we've done with default db security and making _all_dbs an opt-in config value could help folks until we have a proper fix. ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412997032/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412998970","html_url":"https://github.com/apache/couchdb/issues/1558#issuecomment-412998970","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1558","id":412998970,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjk5ODk3MA==","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T20:07:45Z","updated_at":"2018-08-14T20:07:45Z","author_association":"MEMBER","body":"yes, I can see that. [couchdb] users_db_security_editable=false|true or something, defaulting to false in the new default.ini","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/412998970/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413000180","html_url":"https://github.com/apache/couchdb/issues/1556#issuecomment-413000180","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1556","id":413000180,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzAwMDE4MA==","user":{"login":"greenais","id":16271522,"node_id":"MDQ6VXNlcjE2MjcxNTIy","avatar_url":"https://avatars.githubusercontent.com/u/16271522?v=4","gravatar_id":"","url":"https://api.github.com/users/greenais","html_url":"https://github.com/greenais","followers_url":"https://api.github.com/users/greenais/followers","following_url":"https://api.github.com/users/greenais/following{/other_user}","gists_url":"https://api.github.com/users/greenais/gists{/gist_id}","starred_url":"https://api.github.com/users/greenais/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/greenais/subscriptions","organizations_url":"https://api.github.com/users/greenais/orgs","repos_url":"https://api.github.com/users/greenais/repos","events_url":"https://api.github.com/users/greenais/events{/privacy}","received_events_url":"https://api.github.com/users/greenais/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T20:12:11Z","updated_at":"2018-08-14T20:12:11Z","author_association":"NONE","body":"@wohali Thank you. \r\nIt's my fault, clearly.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413000180/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413003830","html_url":"https://github.com/apache/couchdb/issues/1119#issuecomment-413003830","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1119","id":413003830,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzAwMzgzMA==","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T20:24:38Z","updated_at":"2018-08-14T20:24:38Z","author_association":"NONE","body":"Again, our server is idle. If there are metrics you require to confirm that, we'd be happy to supply them, but our server is not \"overloaded\", not should a database system render itself unavailable due to hypothetical load.\r\n\r\nIt's also unclear why you're attempting to divert a community bug report to commercial support. If this project has relationships with commercial support companies, please disclose them here so we know what we're dealing with.\r\n\r\nThanks.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413003830/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413011567","html_url":"https://github.com/apache/couchdb/issues/1558#issuecomment-413011567","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1558","id":413011567,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzAxMTU2Nw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T20:51:01Z","updated_at":"2018-08-14T20:51:01Z","author_association":"MEMBER","body":"If we're OK with that alternative for 2.x, I'll re-open this.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413011567/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413011861","html_url":"https://github.com/apache/couchdb/issues/1119#issuecomment-413011861","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1119","id":413011861,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzAxMTg2MQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T20:51:59Z","updated_at":"2018-08-14T20:51:59Z","author_association":"MEMBER","body":"@browndav No relationships - just that I don't have more time to assist you. \r\n\r\nSomeone else will have to assist at this point.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413011861/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413012021","html_url":"https://github.com/apache/couchdb/issues/1119#issuecomment-413012021","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1119","id":413012021,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzAxMjAyMQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T20:52:26Z","updated_at":"2018-08-14T20:52:26Z","author_association":"MEMBER","body":"@browndav did you try increasing the fabric timeout?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413012021/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413030924","html_url":"https://github.com/apache/couchdb/issues/1119#issuecomment-413030924","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1119","id":413030924,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzAzMDkyNA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T22:02:57Z","updated_at":"2018-08-14T22:02:57Z","author_association":"MEMBER","body":"@browndav To make it clear, I tend to be the first line of issue triaging for CouchDB. I don't have more time to dig into your issue, sorry. It could be a while before someone else looks at this. So, if you need an answer quickly, guaranteed, going with a paid offering from one of the available vendors would get you the support you need. Otherwise you'll have to wait until someone comes along to assist.\r\n\r\nSorry I couldn't be of more assistance here.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413030924/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413045966","html_url":"https://github.com/apache/couchdb/issues/1373#issuecomment-413045966","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1373","id":413045966,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzA0NTk2Ng==","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T23:18:13Z","updated_at":"2018-08-14T23:18:13Z","author_association":"CONTRIBUTOR","body":"What if we would change our logging statements to something like:\r\n\r\n```\r\ncouch_log:Level(FormatWhichSupportsBindings, MetaData, Bindings).\r\n```\r\n\r\nMetadata would include data about location of the call and some context such as:\r\n- nonce\r\n- user\r\n- namespace (if available)\r\n- full URL of the request (if available)\r\n- component\r\n\r\nHere is one example which illustrates the idea:\r\n```\r\ncouch_log:Level(\"Something {db_name} something else {view}\", \r\n   [{line, ?LINE}, {module, ?MODULE}, {user, #user_ctx.name}],\r\n   [{\r\n       {db_name, DbName},\r\n       {view, View}\r\n   }]).\r\n```\r\n\r\nWe can define macro to include ?LINE and ?MODULE for convenience if we want to.\r\n\r\nSince all of the arguments are key-value pairs we can use any serialization format (depending on logging infrastructure used):\r\n- JSON \r\n- message pack\r\n- BSON\r\n- Cap’n Proto\r\n- plain string as we currently use\r\n\r\nThere might be a need to define expected format for every argument. For example in which format we would send dates? We need to think about it we we design the FormatWhichSupportsBindings language or choosing the library. \r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413045966/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413047215","html_url":"https://github.com/apache/couchdb/issues/1373#issuecomment-413047215","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1373","id":413047215,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzA0NzIxNQ==","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T23:25:20Z","updated_at":"2018-08-14T23:25:20Z","author_association":"CONTRIBUTOR","body":"The metadata inclusion is inspired by Elixir logger. Which has following fields: https://hexdocs.pm/logger/Logger.html#module-metadata\r\n\r\n* application - the current application\r\n* module - the current module\r\n* function - the current function\r\n* file - the current file\r\n* line - the current line\r\n* pid - the current process identifier\r\n* crash_reason - a two-element tuple with the throw/error/exit reason as first argument and the stacktrace as second. A throw will always be {:nocatch, term}. An error is always an Exception struct. All other entries are exits. The console backend ignores this metadata by default but it can be useful to other backends, such as the ones that report errors to third-party services\r\n* initial_call - the initial call that started the process\r\n* registered_name - the process registered name as an atom\r\n\r\nWe can include `{commit, ?COUCHDB_GIT_SHA}` as well.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413047215/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413048413","html_url":"https://github.com/apache/couchdb/issues/1373#issuecomment-413048413","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1373","id":413048413,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzA0ODQxMw==","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-14T23:31:37Z","updated_at":"2018-08-14T23:31:37Z","author_association":"CONTRIBUTOR","body":"We also need to include timestamp in metadata or pass it as a separate argument. In order to have exact timestamps which correspond to the time when log function is executed rather then when we format the message in the logging backend.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413048413/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413068903","html_url":"https://github.com/apache/couchdb/issues/1373#issuecomment-413068903","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1373","id":413068903,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzA2ODkwMw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T01:44:16Z","updated_at":"2018-08-15T01:44:16Z","author_association":"MEMBER","body":"@iilyak have you looked at the Erlang 21 logger library? It seems like a decent target.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413068903/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413101466","html_url":"https://github.com/apache/couchdb/issues/1316#issuecomment-413101466","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1316","id":413101466,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzEwMTQ2Ng==","user":{"login":"johs","id":48370,"node_id":"MDQ6VXNlcjQ4Mzcw","avatar_url":"https://avatars.githubusercontent.com/u/48370?v=4","gravatar_id":"","url":"https://api.github.com/users/johs","html_url":"https://github.com/johs","followers_url":"https://api.github.com/users/johs/followers","following_url":"https://api.github.com/users/johs/following{/other_user}","gists_url":"https://api.github.com/users/johs/gists{/gist_id}","starred_url":"https://api.github.com/users/johs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/johs/subscriptions","organizations_url":"https://api.github.com/users/johs/orgs","repos_url":"https://api.github.com/users/johs/repos","events_url":"https://api.github.com/users/johs/events{/privacy}","received_events_url":"https://api.github.com/users/johs/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T05:56:48Z","updated_at":"2018-08-15T05:56:48Z","author_association":"NONE","body":"Hi @asterisks007,\r\nI am trying to prepare installation of CouchDB 1.7.2 on Ubuntu 18.04 bionic and get\r\n```Building dependency tree       \r\nReading state information... Done\r\nE: Unable to locate package libmozjs185-dev\r\n```\r\non my AMI\r\nInstalling Ubuntu on a MacBook Air both, ibmozjs185-dev and libcurl4-openssl-dev are missing.\r\n\r\nCould you share in detail how you succeeded following the advice of @wohali?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413101466/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413105885","html_url":"https://github.com/apache/couchdb/issues/1119#issuecomment-413105885","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1119","id":413105885,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzEwNTg4NQ==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T06:26:49Z","updated_at":"2018-08-15T06:26:49Z","author_association":"MEMBER","body":"2.2.0 is out now and has additional error logging for this issue. I'm happy to look at fresh logs. ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413105885/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413134772","html_url":"https://github.com/apache/couchdb/issues/1498#issuecomment-413134772","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1498","id":413134772,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzEzNDc3Mg==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T08:49:48Z","updated_at":"2018-08-15T08:49:48Z","author_association":"MEMBER","body":"Superseded by https://github.com/apache/couchdb/issues/1559","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413134772/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413183951","html_url":"https://github.com/apache/couchdb/issues/1373#issuecomment-413183951","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1373","id":413183951,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzE4Mzk1MQ==","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T12:33:40Z","updated_at":"2018-08-15T12:33:40Z","author_association":"CONTRIBUTOR","body":"API for Erlang 21 logger looks good.\r\n\r\n# Logging macros\r\n```\r\n?LOG_ERROR(FunOrFormat,Args[,Metadata])\r\n```\r\n\r\n```\r\n-define(LOG_ERROR(A,B,C),?DO_LOG(error,[A,B,C])).\r\n-define(DO_LOG(Level,Args),\r\n        case logger:allow(Level,?MODULE) of\r\n            true ->\r\n                apply(logger,macro_log,[?LOCATION,Level|Args]);\r\n            false ->\r\n                ok\r\n        end).\r\n-endif.\r\n```\r\nLOG_ERROR macro injects additional info to provided Metadata map. The injected info:\r\n```\r\n-define(LOCATION,#{mfa=>{?MODULE,?FUNCTION_NAME,?FUNCTION_ARITY},\r\n                   line=>?LINE,\r\nfile=>?FILE}).\r\n```\r\n\r\nAs you can see the logging macro uses `case` to find out if the event needs to be logged.\r\n\r\n# Additional features\r\n\r\n- Process specific metadata can be added using logger:set_process_metadata(Meta).\r\n  Which is implemented using process dictionary (good).\r\n  We can use it to set full uri used by the user to access endpoint.\r\n- There is concept of filters. Filters can be applied to logger and to logger handler\r\n- There is some [overload protection](https://github.com/erlang/otp/blob/22a6c1ab6dd63a358dbf264e52b172816af54eee/lib/kernel/src/logger_h_common.erl#L129) in few default handlers which is based on message queue size (drop on the flour)\r\n- There is a notion of formatters to be able to use existent handlers (file or stdout) \r\n  Formatters are called as `Formatter:format(Log,FormatterConfig)` (see `logger_h_common.erl`)\r\n\r\n# Implementation details\r\n\r\n1. the log statements is wrapped in a `case` to check if it needs to be logged (ets:lookup)\r\n2. then we dispatch it to `logger_backend.erl` via `logger.erl`\r\n3. `logger_backend.erl` does the following:\r\n   - `logger_config:get(Tid,primary)` (ets:lookup)\r\n   - apply filters\r\n   - call handlers. Every handler does\r\n      - `logger_config:get(Tid,Id,Level)` (ets:lookup)\r\n      - apply filters\r\n      - dispatch the call using `Module:log(Log1,Config1)`\r\n      - if the call to Module fail the handler is automatically removed from configuration\r\n      - it is up to the handler to decide how to log event (single process or parallel and in which format)\r\n\r\nDefault handlers are implemented as gen_servers. \r\n\r\n# Overload protection\r\n\r\nDefault handlers (`logger_disk_log_h` and `logger_std_h`) has overload protection. Which is [implemented here](https://github.com/erlang/otp/blob/22a6c1ab6dd63a358dbf264e52b172816af54eee/lib/kernel/src/logger_h_common.erl#L129). \r\n\r\nIf the handler process is getting overloaded, the log event\r\nwill be send synchronously (to the handler process) instead of \r\nasynchronous (slows down the logging tempo of a process doing \r\nlots of logging. If the handler is choked, drop mode is set and \r\nno event will be sent (to the handler process).\r\n\r\nThe `logger_h_common` provides helper function for gen_server based handlers to flash all log events from the message queue in case of overload. It also provides functions to detect overload case. \r\n\r\n# Conclusion\r\n\r\nThe Logger library has good API and useful features. Implementation is robust and should provide good performance. The only place which could be optimized further (based on one hour review) is configuration module. Since it is implemented using ets which is the second fastest way (the fastest way is generated module). \r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413183951/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413186596","html_url":"https://github.com/apache/couchdb/issues/1559#issuecomment-413186596","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1559","id":413186596,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzE4NjU5Ng==","user":{"login":"st-fankl-in","id":498915,"node_id":"MDQ6VXNlcjQ5ODkxNQ==","avatar_url":"https://avatars.githubusercontent.com/u/498915?v=4","gravatar_id":"","url":"https://api.github.com/users/st-fankl-in","html_url":"https://github.com/st-fankl-in","followers_url":"https://api.github.com/users/st-fankl-in/followers","following_url":"https://api.github.com/users/st-fankl-in/following{/other_user}","gists_url":"https://api.github.com/users/st-fankl-in/gists{/gist_id}","starred_url":"https://api.github.com/users/st-fankl-in/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/st-fankl-in/subscriptions","organizations_url":"https://api.github.com/users/st-fankl-in/orgs","repos_url":"https://api.github.com/users/st-fankl-in/repos","events_url":"https://api.github.com/users/st-fankl-in/events{/privacy}","received_events_url":"https://api.github.com/users/st-fankl-in/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T12:45:51Z","updated_at":"2018-08-15T12:45:51Z","author_association":"NONE","body":"Just a heads-up\r\n\r\n> JSON Pointer is designed to work inside a URI fragment (think index.html#foo), so it’d be great to get single-field oeprations handled that way.\r\n\r\nURI fragments are not send for GET Requests (at least)\r\nI ran netcat and checked with curl, chrome and firefox, neither of them included the URI fragment:\r\n\r\n```\r\n$ echo -e \"HTTP/1.1 200 OK\\n\\n Hello World\\n\" | nc -l -p 1500\r\nGET /db/doc HTTP/1.1\r\nHost: localhost:1500\r\nUser-Agent: curl/7.58.0\r\nAccept: */*\r\n```\r\n\r\n```\r\n$ curl -v 'http://localhost:1500/db/doc#field'\r\n*   Trying ::1...\r\n* TCP_NODELAY set\r\n* connect to ::1 port 1500 failed: Connection refused\r\n*   Trying 127.0.0.1...\r\n* TCP_NODELAY set\r\n* Connected to localhost (127.0.0.1) port 1500 (#0)\r\n> GET /db/doc HTTP/1.1\r\n> Host: localhost:1500\r\n> User-Agent: curl/7.58.0\r\n> Accept: */*\r\n> \r\n< HTTP/1.1 200 OK\r\n* no chunk, no close, no size. Assume close to signal end\r\n< \r\n Hello World\r\n```\r\nnetcat and curl to make sure nothing \"smart\" is interfering, firefox and chrome did send the same `GET` though more headers.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413186596/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413189720","html_url":"https://github.com/apache/couchdb/issues/1559#issuecomment-413189720","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1559","id":413189720,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzE4OTcyMA==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T12:59:18Z","updated_at":"2018-08-15T12:59:18Z","author_association":"MEMBER","body":"@st-fankl-in a drat, but thanks!\r\n\r\n* * *\r\n\r\nModified proposal: `/db/doc/_/` instead of `/db/doc#`","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413189720/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413205182","html_url":"https://github.com/apache/couchdb/pull/1543#issuecomment-413205182","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1543","id":413205182,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzIwNTE4Mg==","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T13:56:24Z","updated_at":"2018-08-15T13:56:24Z","author_association":"CONTRIBUTOR","body":"@wohali I pushed a commit to remove `_restart` from `default.ini` however I am not sure if we need to follow  a protocol and send a proposal via ML in this case. We are not deprecating the endpoint we are changing a default. I am considering to revert that commit for now.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413205182/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413215052","html_url":"https://github.com/apache/couchdb/issues/1373#issuecomment-413215052","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1373","id":413215052,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzIxNTA1Mg==","user":{"login":"eiri","id":70542,"node_id":"MDQ6VXNlcjcwNTQy","avatar_url":"https://avatars.githubusercontent.com/u/70542?v=4","gravatar_id":"","url":"https://api.github.com/users/eiri","html_url":"https://github.com/eiri","followers_url":"https://api.github.com/users/eiri/followers","following_url":"https://api.github.com/users/eiri/following{/other_user}","gists_url":"https://api.github.com/users/eiri/gists{/gist_id}","starred_url":"https://api.github.com/users/eiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eiri/subscriptions","organizations_url":"https://api.github.com/users/eiri/orgs","repos_url":"https://api.github.com/users/eiri/repos","events_url":"https://api.github.com/users/eiri/events{/privacy}","received_events_url":"https://api.github.com/users/eiri/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T14:28:31Z","updated_at":"2018-08-15T14:28:31Z","author_association":"MEMBER","body":"> @kocolosk wrote:\r\n> - We exhumed lager from the codebase a few years ago. Why? Was it simply that we thought it was a lot of unnecessary code?\r\n> - Erlang 21 adds a new logger inspired by lager:..\r\n\r\niirc we switched from lager because 1) it was too coupled with couch codebase and we wanted ability to change backends (apache/couchdb-couch-log#4) 2) we didn't **want** lager's overload protection, not with how it handle it with just quietly dropping the messages 3) and it was cumbersome to deal with all together, with its use of `parse_transform` and none-intuitive buffers and handlers\r\n\r\nI like the idea of structured logging, but I'm not keen on proposed here change to `couch_log:Level(FormatWhichSupportsBindings, MetaData, Bindings)`. I don't see benefits in introducing *two* separate bins to hold attributes and then also enforce change on both formatting template and arguments' switch from list to proplist.\r\n\r\nI don't know how Elixir logger works, but personally I like how [logrus](https://github.com/sirupsen/logrus) went about idea of structured logging. They keep all meta or \"fields\" separate from a message and encourage to simplify the message itself, so it wouldn't need to include meta info. Quoting: \"We've found this API forces you to think about logging in a way that produces much more useful logging messages.\". Sure one still can use `sprintf` if necessary.\r\nThere are also idea of configurable implicit default fields, akin of mentioned `?LINE` and `?MODULE` and automatic treatment of `level`, `time` and `msg` as just another fields.\r\n\r\nThis is how I'd go about adding structured logging to `couch_log`:\r\n- Extract formatting out of writers and make it into own entity. I.e. [this function](https://github.com/apache/couchdb/blob/master/src/couch_log/src/couch_log_writer_file.erl#L78-L98) will be in its own module and accept not a record `#log_entry`, but a map or a proplist. Depending on a formatter the output would be the same log message string as we have now, JSON object or a message + key=value pairs (this called `TextFormatter` in `logrus`).\r\n- Add function `couch_log:Level(Format, Args, Meta)` to allow to pass additional fields. To emphasize - formatter doesn't modify `msg` - the message is a message, not a template.\r\n- Formatters will be configurable in `[log]` section with a default to what we have now. Or default can be dictated by a writer module, I'm thinking about `couch_log_writer_syslog` case\r\n- ...\r\n- Profit!\r\n\r\nA bonus section:\r\n- Macros sounds like a good idea, maybe not a complete switch everywhere, but they'd be nice to have. I'm using following two in my dev a lot, I've added them to my local `couch_db.hrl`, so they available almost everywhere.\r\n```\r\n+-define(l(F, A), couch_log:info(\"~p:~b - \" ++ F, [?MODULE,?LINE] ++ A)).\r\n+-define(r2kv(Rec, Name),\r\n+    lists:zip(record_info(fields, Name), tl(tuple_to_list(Rec)))).\r\n+\r\n```\r\n- We can make [should_log](https://github.com/apache/couchdb/blob/master/src/couch_log/src/couch_log_server.erl#L82) more sfisticated to turn things on and off based on meta. Something like dropping a function to logger server state and then use it as a predicate for `lists:all/2` to run over meta.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413215052/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413230316","html_url":"https://github.com/apache/couchdb/issues/1559#issuecomment-413230316","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1559","id":413230316,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzIzMDMxNg==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T15:15:20Z","updated_at":"2018-08-15T15:15:20Z","author_association":"MEMBER","body":"Duplicate of #1280 as well, I'll close that one.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413230316/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413230434","html_url":"https://github.com/apache/couchdb/issues/1280#issuecomment-413230434","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1280","id":413230434,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzIzMDQzNA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T15:15:43Z","updated_at":"2018-08-15T15:15:43Z","author_association":"MEMBER","body":"See #1559 for the continuation of this.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413230434/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413231042","html_url":"https://github.com/apache/couchdb/pull/1543#issuecomment-413231042","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1543","id":413231042,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzIzMTA0Mg==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T15:17:46Z","updated_at":"2018-08-15T15:17:46Z","author_association":"MEMBER","body":"@iilyak You're re-introducting a new endpoint, so that's fine. You removed the node-local one, right? I'm not sure it actually worked correctly in 2.0 so I don't personally consider that a deprecation.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413231042/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413233458","html_url":"https://github.com/apache/couchdb/issues/1559#issuecomment-413233458","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1559","id":413233458,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzIzMzQ1OA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T15:25:20Z","updated_at":"2018-08-15T15:25:47Z","author_association":"MEMBER","body":"From the license FAQ on MPL:\r\n\r\n> Software under the following licenses may be included in binary form within an Apache product if the inclusion is appropriately labeled (see below):\r\n>\r\n> * Mozilla Public Licenses: MPL 1.0, MPL 1.1, and MPL 2.0\r\n>\r\n> For small amounts of source that is directly consumed by the ASF product at runtime in source form, and for which that source is unmodified and unlikely to be changed anyway (say, by virtue of being specified by a standard), inclusion of appropriately labeled source is also permitted. An example of this is the web-facesconfig_1_0.dtd, whose inclusion is mandated by the JSR 127: JavaServer Faces specification.\r\n\r\nBased on this we couldn't pull the JSON Patch functionality in via the source repo, but if it's in [hex](https://hex.pm/), for instance, we could handle it that way.\r\n\r\nAlternately we wake up one morning and @davisp has written his own implementation :wink: ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413233458/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413234523","html_url":"https://github.com/apache/couchdb/issues/1554#issuecomment-413234523","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1554","id":413234523,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzIzNDUyMw==","user":{"login":"mikerhodes","id":453210,"node_id":"MDQ6VXNlcjQ1MzIxMA==","avatar_url":"https://avatars.githubusercontent.com/u/453210?v=4","gravatar_id":"","url":"https://api.github.com/users/mikerhodes","html_url":"https://github.com/mikerhodes","followers_url":"https://api.github.com/users/mikerhodes/followers","following_url":"https://api.github.com/users/mikerhodes/following{/other_user}","gists_url":"https://api.github.com/users/mikerhodes/gists{/gist_id}","starred_url":"https://api.github.com/users/mikerhodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikerhodes/subscriptions","organizations_url":"https://api.github.com/users/mikerhodes/orgs","repos_url":"https://api.github.com/users/mikerhodes/repos","events_url":"https://api.github.com/users/mikerhodes/events{/privacy}","received_events_url":"https://api.github.com/users/mikerhodes/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T15:28:43Z","updated_at":"2018-08-15T15:28:43Z","author_association":"CONTRIBUTOR","body":"Cloudant has write-only, but I did think that it'd likely come in with any access rewrite as it's definitely a useful thing.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413234523/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413235122","html_url":"https://github.com/apache/couchdb/issues/1537#issuecomment-413235122","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1537","id":413235122,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzIzNTEyMg==","user":{"login":"mikerhodes","id":453210,"node_id":"MDQ6VXNlcjQ1MzIxMA==","avatar_url":"https://avatars.githubusercontent.com/u/453210?v=4","gravatar_id":"","url":"https://api.github.com/users/mikerhodes","html_url":"https://github.com/mikerhodes","followers_url":"https://api.github.com/users/mikerhodes/followers","following_url":"https://api.github.com/users/mikerhodes/following{/other_user}","gists_url":"https://api.github.com/users/mikerhodes/gists{/gist_id}","starred_url":"https://api.github.com/users/mikerhodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikerhodes/subscriptions","organizations_url":"https://api.github.com/users/mikerhodes/orgs","repos_url":"https://api.github.com/users/mikerhodes/repos","events_url":"https://api.github.com/users/mikerhodes/events{/privacy}","received_events_url":"https://api.github.com/users/mikerhodes/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T15:30:29Z","updated_at":"2018-08-15T15:30:56Z","author_association":"CONTRIBUTOR","body":"jsonb (Postgres-originated) is different to BSON (Mongo), unsure whether they have different trade-offs that change the balance of that discussion. jsonb seems to have a nice format to enable faster field value lookup via a table of contents which could benefit Mango where it loads up documents and matches them against a selector.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413235122/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413235332","html_url":"https://github.com/apache/couchdb/issues/1119#issuecomment-413235332","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1119","id":413235332,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzIzNTMzMg==","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T15:31:11Z","updated_at":"2018-08-16T17:34:35Z","author_association":"NONE","body":"We went back to first principles and attempted to set up CouchDB 2.2.0 manually, per the non-wizard instructions at http://docs.couchdb.org/en/latest/install/setup.html. We now have a different error. The machine's load average is zero; it is idle.\r\n\r\nThe CouchDB manual suggests that the we create the `_users` database once the system comes up. Unfortunately, CouchDB begins looking for the `_users` database immediately, before we even have time to set up the required system databases per the instructions. The database system appears unusable from that point on. We cannot get a `200 OK` on the HTTP PUT for `_users` at any point in the process, but will obviously repeat tests across all platforms we've tried today.\r\n\r\n```\r\n[info] 2018-08-15T15:19:35.688656Z couchdb@127.0.0.1 <0.11.0> -------- Application couch_log started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:35.693970Z couchdb@127.0.0.1 <0.11.0> -------- Application folsom started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:35.765819Z couchdb@127.0.0.1 <0.11.0> -------- Application couch_stats started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:35.765982Z couchdb@127.0.0.1 <0.11.0> -------- Application khash started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:35.777264Z couchdb@127.0.0.1 <0.11.0> -------- Application couch_event started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:35.777414Z couchdb@127.0.0.1 <0.11.0> -------- Application hyper started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:35.786869Z couchdb@127.0.0.1 <0.11.0> -------- Application ibrowse started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:35.795983Z couchdb@127.0.0.1 <0.11.0> -------- Application ioq started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:35.796157Z couchdb@127.0.0.1 <0.11.0> -------- Application mochiweb started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:35.809087Z couchdb@127.0.0.1 <0.211.0> -------- Apache CouchDB 2.2.0 is starting.\r\n[info] 2018-08-15T15:19:35.809156Z couchdb@127.0.0.1 <0.212.0> -------- Starting couch_sup\r\n[notice] 2018-08-15T15:19:35.822077Z couchdb@127.0.0.1 <0.99.0> -------- config: [features] pluggable-storage-engines set to true for reason nil\r\n[notice] 2018-08-15T15:19:35.871635Z couchdb@127.0.0.1 <0.99.0> -------- config: [couchdb] uuid set to e9dd318e72cd3eff60a52da3b2e3df1b for reason nil\r\n[info] 2018-08-15T15:19:35.929686Z couchdb@127.0.0.1 <0.217.0> -------- open_result error {not_found,no_db_file} for _users\r\n[info] 2018-08-15T15:19:35.985482Z couchdb@127.0.0.1 <0.211.0> -------- Apache CouchDB has started. Time to relax.\r\n[info] 2018-08-15T15:19:35.985561Z couchdb@127.0.0.1 <0.211.0> -------- Apache CouchDB has started on http://127.0.0.1:5986/\r\n[info] 2018-08-15T15:19:35.985846Z couchdb@127.0.0.1 <0.11.0> -------- Application couch started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:35.986067Z couchdb@127.0.0.1 <0.11.0> -------- Application ets_lru started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.001712Z couchdb@127.0.0.1 <0.11.0> -------- Application rexi started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.013619Z couchdb@127.0.0.1 <0.217.0> -------- open_result error {not_found,no_db_file} for _nodes\r\n[warning] 2018-08-15T15:19:36.013665Z couchdb@127.0.0.1 <0.287.0> -------- creating missing database: _nodes\r\n[info] 2018-08-15T15:19:36.041166Z couchdb@127.0.0.1 <0.217.0> -------- open_result error {not_found,no_db_file} for _dbs\r\n[warning] 2018-08-15T15:19:36.041202Z couchdb@127.0.0.1 <0.301.0> -------- creating missing database: _dbs\r\n[warning] 2018-08-15T15:19:36.041242Z couchdb@127.0.0.1 <0.300.0> -------- creating missing database: _dbs\r\n[info] 2018-08-15T15:19:36.047811Z couchdb@127.0.0.1 <0.11.0> -------- Application mem3 started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.048139Z couchdb@127.0.0.1 <0.11.0> -------- Application fabric started on node\r\n 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.068172Z couchdb@127.0.0.1 <0.11.0> -------- Application chttpd started on node\r\n 'couchdb@127.0.0.1'\r\n[notice] 2018-08-15T15:19:36.079238Z couchdb@127.0.0.1 <0.338.0> -------- chttpd_auth_cache changes listener died database_does_not_exist at mem3_shards:load_shards_from_db/6(line:395) <= mem3_shards:load_shards_from_disk/1(line:370) <= mem3_shards:load_shards_from_disk/2(line:399) <= mem3_shards:for_docid/3(line:86) <= fabric_doc_open:go/3(line:38) <= chttpd_auth_cache:ensure_auth_ddoc_exists/2(line:187) <= chttpd_auth_cache:listen_for_changes/1(line:134)\r\n[error] 2018-08-15T15:19:36.079511Z couchdb@127.0.0.1 emulator -------- Error in process <0.339.0> on node 'couchdb@127.0.0.1' with exit value:\r\n{database_does_not_exist,[{mem3_shards,load_shards_from_db,\"_users\",[{file,\"src/mem3_shards.erl\"},{line,395}]},{mem3_shards,load_shards_from_disk,1,[{file,\"src/mem3_shards.erl\"},{line,370}]},{mem3_shards,load_shards_from_disk,2,[{file,\"src/mem3_shards.erl\"},{line,399}]},{mem3_shards,for_docid,3,[{file,\"src/mem3_shards.erl\"},{line,86}]},{fabric_doc_open,go,3,[{file,\"src/fabric_doc_open.erl\"},{line,38}]},{chttpd_auth_cache,ensure_auth_ddoc_exists,2,[{file,\"src/chttpd_auth_cache.erl\"},{line,187}]},{chttpd_auth_cache,listen_for_changes,1,[{file,\"src/chttpd_auth_cache.erl\"},{line,134}]}]}\r\n\r\n[info] 2018-08-15T15:19:36.084896Z couchdb@127.0.0.1 <0.11.0> -------- Application couch_index started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.085009Z couchdb@127.0.0.1 <0.11.0> -------- Application couch_mrview started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.085056Z couchdb@127.0.0.1 <0.11.0> -------- Application couch_plugins started on node 'couchdb@127.0.0.1'\r\n[notice] 2018-08-15T15:19:36.114719Z couchdb@127.0.0.1 <0.99.0> -------- config: [features] scheduler set to true for reason nil\r\n[info] 2018-08-15T15:19:36.134469Z couchdb@127.0.0.1 <0.217.0> -------- open_result error {not_found,no_db_file} for _replicator\r\n[notice] 2018-08-15T15:19:36.138139Z couchdb@127.0.0.1 <0.355.0> -------- creating replicator ddoc <<\"_replicator\">>\r\n[info] 2018-08-15T15:19:36.153545Z couchdb@127.0.0.1 <0.11.0> -------- Application couch_replicator started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.162640Z couchdb@127.0.0.1 <0.11.0> -------- Application couch_peruser started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.175302Z couchdb@127.0.0.1 <0.11.0> -------- Application ddoc_cache started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.197073Z couchdb@127.0.0.1 <0.11.0> -------- Application global_changes started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.197097Z couchdb@127.0.0.1 <0.11.0> -------- Application jiffy started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.203955Z couchdb@127.0.0.1 <0.11.0> -------- Application mango started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.212173Z couchdb@127.0.0.1 <0.11.0> -------- Application setup started on node 'couchdb@127.0.0.1'\r\n[info] 2018-08-15T15:19:36.212221Z couchdb@127.0.0.1 <0.11.0> -------- Application snappy started on node 'couchdb@127.0.0.1'\r\n[notice] 2018-08-15T15:19:41.082305Z couchdb@127.0.0.1 <0.338.0> -------- chttpd_auth_cache changes listener died database_does_not_exist at mem3_shards:load_shards_from_db/6(line:395) <= mem3_shards:load_shards_from_disk/1(line:370) <= mem3_shards:load_shards_from_disk/2(line:399) <= mem3_shards:for_docid/3(line:86) <= fabric_doc_open:go/3(line:38) <= chttpd_auth_cache:ensure_auth_ddoc_exists/2(line:187) <= chttpd_auth_cache:listen_for_changes/1(line:134)\r\n[error] 2018-08-15T15:19:41.082706Z couchdb@127.0.0.1 emulator -------- Error in process <0.477.0> on node 'couchdb@127.0.0.1' with exit value:\r\n{database_does_not_exist,[{mem3_shards,load_shards_from_db,\"_users\",[{file,\"src/mem3_shards.erl\"},{line,395}]},{mem3_shards,load_shards_from_disk,1,[{file,\"src/mem3_shards.erl\"},{line,370}]},{mem3_shards,load_shards_from_disk,2,[{file,\"src/mem3_shards.erl\"},{line,399}]},{mem3_shards,for_docid,3,[{file,\"src/mem3_shards.erl\"},{line,86}]},{fabric_doc_open,go,3,[{file,\"src/fabric_doc_open.erl\"},{line,38}]},{chttpd_auth_cache,ensure_auth_ddoc_exists,2,[{file,\"src/chttpd_auth_cache.erl\"},{line,187}]},{chttpd_auth_cache,listen_for_changes,1,[{file,\"src/chttpd_auth_cache.erl\"},{line,134}]}]}\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413235332/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413250368","html_url":"https://github.com/apache/couchdb/issues/1559#issuecomment-413250368","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1559","id":413250368,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzI1MDM2OA==","user":{"login":"lazedo","id":770988,"node_id":"MDQ6VXNlcjc3MDk4OA==","avatar_url":"https://avatars.githubusercontent.com/u/770988?v=4","gravatar_id":"","url":"https://api.github.com/users/lazedo","html_url":"https://github.com/lazedo","followers_url":"https://api.github.com/users/lazedo/followers","following_url":"https://api.github.com/users/lazedo/following{/other_user}","gists_url":"https://api.github.com/users/lazedo/gists{/gist_id}","starred_url":"https://api.github.com/users/lazedo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lazedo/subscriptions","organizations_url":"https://api.github.com/users/lazedo/orgs","repos_url":"https://api.github.com/users/lazedo/repos","events_url":"https://api.github.com/users/lazedo/events{/privacy}","received_events_url":"https://api.github.com/users/lazedo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T16:18:34Z","updated_at":"2018-08-15T16:18:34Z","author_association":"CONTRIBUTOR","body":"@janl Hi, not sure if i understood correctly but it seems that you're proposing that `/db/doc?rev=$rev` will allow apps/users to partially update documents without knowing the current `rev`, is that correct ?\r\ni love this proposal but have some concerns if the above is correct. two users updating the same document at same time in different fields is great, but if they try to update the same fields at same they both succeed but only the last will preserve, this can cause some unwanted disputes.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413250368/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413251707","html_url":"https://github.com/apache/couchdb/issues/1559#issuecomment-413251707","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1559","id":413251707,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzI1MTcwNw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T16:23:05Z","updated_at":"2018-08-15T16:23:05Z","author_association":"MEMBER","body":"@lazedo no, I think that's parametrized, you'd still need to know the current rev of the document to make this work.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413251707/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413254118","html_url":"https://github.com/apache/couchdb/issues/1559#issuecomment-413254118","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1559","id":413254118,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzI1NDExOA==","user":{"login":"lazedo","id":770988,"node_id":"MDQ6VXNlcjc3MDk4OA==","avatar_url":"https://avatars.githubusercontent.com/u/770988?v=4","gravatar_id":"","url":"https://api.github.com/users/lazedo","html_url":"https://github.com/lazedo","followers_url":"https://api.github.com/users/lazedo/followers","following_url":"https://api.github.com/users/lazedo/following{/other_user}","gists_url":"https://api.github.com/users/lazedo/gists{/gist_id}","starred_url":"https://api.github.com/users/lazedo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lazedo/subscriptions","organizations_url":"https://api.github.com/users/lazedo/orgs","repos_url":"https://api.github.com/users/lazedo/repos","events_url":"https://api.github.com/users/lazedo/events{/privacy}","received_events_url":"https://api.github.com/users/lazedo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T16:30:39Z","updated_at":"2018-08-15T16:30:39Z","author_association":"CONTRIBUTOR","body":"@wohali thanks. an alternative for concurrent updates in different parts of document would be to send a computed hash of previous values being updated and have couchdb validate against current values before accepting. that way, two users can have the same `rev`of a document and update different parts of the document at same time with no need to send the `rev` for partial updates. thoughts ?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413254118/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413254740","html_url":"https://github.com/apache/couchdb/issues/1119#issuecomment-413254740","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1119","id":413254740,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzI1NDc0MA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T16:32:45Z","updated_at":"2018-08-15T16:32:45Z","author_association":"MEMBER","body":"The error messages in that logfile you see are normal and are not the database \"crashing.\" Proceed to join the nodes and create the _users database once you've joined the nodes together.\r\n\r\nIf you create the _users database prior to joining the nodes together, the database will not be distributed across those additional nodes and you will be placing all of the _users database onto a single node.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413254740/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413255224","html_url":"https://github.com/apache/couchdb/issues/1537#issuecomment-413255224","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1537","id":413255224,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzI1NTIyNA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T16:34:19Z","updated_at":"2018-08-15T16:34:19Z","author_association":"MEMBER","body":"@mikerhodes but this sounds like it's more about an internal storage format, not for external communication? I might be confused. If what you're talking about is over-the-wire comms with a client for transmitting non-JSON data, then this issue applies. If you're talking about just a way to accelerate transmitting JSON data, file a new ticket please. :)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413255224/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413256197","html_url":"https://github.com/apache/couchdb/issues/1559#issuecomment-413256197","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1559","id":413256197,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzI1NjE5Nw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T16:37:28Z","updated_at":"2018-08-15T16:38:51Z","author_association":"MEMBER","body":"@lazedo Sorry, that's not under consideration here. This patch proposal will still create a new _rev after it completes, so one of those users will \"lose\" and either introduce a conflict (if they try and update at the same time) or will receive a 409 and have to retry the operation at the client. Having the server retry multiple times is just asking for runaway race conditions.\r\n\r\nRemember that previous revisions of the document may no longer exist due to compaction, so it'd be entirely possible for user 1 to transmit their patch (upping the rev from 1 -> 2) and by the time user 2 tries to transmit their patch, referencing rev 1, that revision no longer exists - so the data you want to compare against isn't available.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413256197/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413276085","html_url":"https://github.com/apache/couchdb/issues/1316#issuecomment-413276085","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1316","id":413276085,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzI3NjA4NQ==","user":{"login":"asterisks007","id":27955001,"node_id":"MDQ6VXNlcjI3OTU1MDAx","avatar_url":"https://avatars.githubusercontent.com/u/27955001?v=4","gravatar_id":"","url":"https://api.github.com/users/asterisks007","html_url":"https://github.com/asterisks007","followers_url":"https://api.github.com/users/asterisks007/followers","following_url":"https://api.github.com/users/asterisks007/following{/other_user}","gists_url":"https://api.github.com/users/asterisks007/gists{/gist_id}","starred_url":"https://api.github.com/users/asterisks007/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/asterisks007/subscriptions","organizations_url":"https://api.github.com/users/asterisks007/orgs","repos_url":"https://api.github.com/users/asterisks007/repos","events_url":"https://api.github.com/users/asterisks007/events{/privacy}","received_events_url":"https://api.github.com/users/asterisks007/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-08-15T17:40:38Z","updated_at":"2018-08-15T17:40:38Z","author_association":"NONE","body":"@johs Please find attached steps which I followed.\r\nThank you.\r\n[Preparing couchdb-libmozjs1.8.5 for installation.zip](https://github.com/apache/couchdb/files/2291127/Preparing.couchdb-libmozjs1.8.5.for.installation.zip)\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/413276085/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]