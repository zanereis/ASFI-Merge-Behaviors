[{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1049135699","html_url":"https://github.com/apache/couchdb/issues/3939#issuecomment-1049135699","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3939","id":1049135699,"node_id":"IC_kwDOAAMmUc4-iIpT","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-23T19:28:17Z","updated_at":"2022-02-23T19:40:48Z","author_association":"CONTRIBUTOR","body":"That's a good test. If we run with `n=1` only mode for integration tests, there could be a separate issue revealed where we drop the connection and never close it properly when attachments are ignored. I guess with `n>1` it would happen as well, if all the nodes have the revision already because we would never pull the data bytes off the socket. We had tried before to force-close such connections to prevent them from being recycled [1]. Whether the client notices the close quickly enough is another issue...\r\n\r\nIn the case where n>1 and some nodes ready the attachment, for `replicated_changes` we perhaps would want to inspect the doc when we ignore it, and if it has any attachment parser processes, explicitly notify them in the case the update is dropped:\r\nhttps://github.com/apache/couchdb/blob/e4b8a4624fc7ae09b4649aac9a8d68226208cd8b/src/couch/src/couch_db.erl#L1240-L1241\r\n\r\n[1] https://github.com/apache/couchdb/blob/2c23d8e0fc8e44fa3f91228aa93002a9977e7221/src/couch/src/couch_httpd.erl#L988-L999 (I am afraid this never actually made it to the chttpd side!)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1049135699/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1049172876","html_url":"https://github.com/apache/couchdb/issues/3939#issuecomment-1049172876","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3939","id":1049172876,"node_id":"IC_kwDOAAMmUc4-iRuM","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-23T20:13:12Z","updated_at":"2022-02-23T20:13:12Z","author_association":"MEMBER","body":"> I guess with n>1 it would happen as well, if all the nodes have the revision already because we would never pull the data bytes off the socket.\r\n\r\nYes, I think so, although I'm now realizing that \"pulling bytes off the socket\" is not necessarily the issue in either the n=1 or n>1 case (with or without concurrent data races). The parser might well consume all the request data (and for small requests it probably does, even if no worker ever requests it), but the `HTTPD` process will still be stuck in `WaitFun()` _after_ sending the response to the client. The connection stays open, and the client sends a new request on that connection, but `HTTPD` won't act on it until that 5 minute timeout fires.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1049172876/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1049216566","html_url":"https://github.com/apache/couchdb/pull/3932#issuecomment-1049216566","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3932","id":1049216566,"node_id":"IC_kwDOAAMmUc4-icY2","user":{"login":"frapa","id":1306195,"node_id":"MDQ6VXNlcjEzMDYxOTU=","avatar_url":"https://avatars.githubusercontent.com/u/1306195?v=4","gravatar_id":"","url":"https://api.github.com/users/frapa","html_url":"https://github.com/frapa","followers_url":"https://api.github.com/users/frapa/followers","following_url":"https://api.github.com/users/frapa/following{/other_user}","gists_url":"https://api.github.com/users/frapa/gists{/gist_id}","starred_url":"https://api.github.com/users/frapa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/frapa/subscriptions","organizations_url":"https://api.github.com/users/frapa/orgs","repos_url":"https://api.github.com/users/frapa/repos","events_url":"https://api.github.com/users/frapa/events{/privacy}","received_events_url":"https://api.github.com/users/frapa/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-23T21:07:02Z","updated_at":"2022-02-23T21:07:02Z","author_association":"NONE","body":"Thanks for running the CI. I made it Linux-only because I have no access to freeBSD or macOS to test alternatives. Could you update the branch so we see if the CI passes everywhere?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1049216566/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1049988626","html_url":"https://github.com/apache/couchdb/pull/3932#issuecomment-1049988626","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3932","id":1049988626,"node_id":"IC_kwDOAAMmUc4-lY4S","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-24T15:42:01Z","updated_at":"2022-02-24T15:42:01Z","author_association":"MEMBER","body":"OK that's fine. Can you add the `spidermonkey_vsn` back into the Jenkinsfile for the macOS and FreeBSD builds and add the flag back in `generateNativeStage`? Otherwise macOS is going to fail because the 1.8.5 default is incorrect.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1049988626/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1050376914","html_url":"https://github.com/apache/couchdb/issues/3937#issuecomment-1050376914","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3937","id":1050376914,"node_id":"IC_kwDOAAMmUc4-m3rS","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-25T00:02:03Z","updated_at":"2022-02-25T00:02:03Z","author_association":"MEMBER","body":"Agreed this would be a nice enhancement, thanks for suggesting it.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1050376914/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1051214828","html_url":"https://github.com/apache/couchdb/issues/3943#issuecomment-1051214828","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3943","id":1051214828,"node_id":"IC_kwDOAAMmUc4-qEPs","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-25T20:19:00Z","updated_at":"2022-02-25T20:19:00Z","author_association":"MEMBER","body":"Years and years ago I believe this was the `_bulk_docs` API. We added the object wrapper for a reason that I vaguely recall as security-related, but I don't recall all the details offhand.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1051214828/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1051549653","html_url":"https://github.com/apache/couchdb/issues/2112#issuecomment-1051549653","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2112","id":1051549653,"node_id":"IC_kwDOAAMmUc4-rV_V","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-26T03:35:40Z","updated_at":"2022-02-26T03:35:40Z","author_association":"MEMBER","body":"Rediscovered this and fixed it in #3913 ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1051549653/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1054588822","html_url":"https://github.com/apache/couchdb/pull/3947#issuecomment-1054588822","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3947","id":1054588822,"node_id":"IC_kwDOAAMmUc4-27-W","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-28T19:27:18Z","updated_at":"2022-02-28T19:27:18Z","author_association":"CONTRIBUTOR","body":"This is a nice usability improvement. One interesting corner case to consider is when users replicate the `_replicator` database. Then, the updates would seem as if they are coming from the user and not the replicator and the new VDU update would reject those documents. Perhaps that is a cleaner way to handle it, anyway. But it would be an incompatibility.\r\n\r\nIf `validate_doc_update` has a `replicated_changes | new_edits` option passed in, we could allow an \"replicated externally\" exception for compatibility. After a cursory look I couldn't see if we pass that flag into the VDU callback.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1054588822/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1054651618","html_url":"https://github.com/apache/couchdb/pull/3947#issuecomment-1054651618","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3947","id":1054651618,"node_id":"IC_kwDOAAMmUc4-3LTi","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-28T20:52:44Z","updated_at":"2022-02-28T20:52:44Z","author_association":"MEMBER","body":"I'm tempted to expand to any property beginning with `_replication` in case we invent new ones. And should this be inside the `if (!newDoc._deleted)` section?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1054651618/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1054786682","html_url":"https://github.com/apache/couchdb/pull/3947#issuecomment-1054786682","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3947","id":1054786682,"node_id":"IC_kwDOAAMmUc4-3sR6","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-28T23:05:36Z","updated_at":"2022-02-28T23:05:36Z","author_association":"CONTRIBUTOR","body":"A prefix check could make sense. We should probably synchronize it with https://github.com/apache/couchdb/blob/3.x/src/couch/src/couch_doc.erl#L346-L373 and have a prefix check there too?\r\n\r\nPutting it under `if (!newDoc._deleted)` would work.\r\n\r\nBut, overall, still not sure if this would break replication of the `_replicator` dbs.  Yeah it is a bit odd to replicate the _replicator db, but it might still be something users do. Those updates would look like user `_bulk_doc`  updates with `new_edits:false` flag, and won't have the `_replicator` role. I don't think we've explicitly considered what should happen in that case across all the combination matrix of old -> new state updates.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1054786682/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1054794033","html_url":"https://github.com/apache/couchdb/pull/3890#issuecomment-1054794033","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3890","id":1054794033,"node_id":"IC_kwDOAAMmUc4-3uEx","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-28T23:09:30Z","updated_at":"2022-02-28T23:09:30Z","author_association":"CONTRIBUTOR","body":"It looks like @eiri may have found the reason for this in https://github.com/apache/couchdb/issues/1349#issuecomment-481279977 from a while back","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1054794033/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1055177589","html_url":"https://github.com/apache/couchdb/pull/3947#issuecomment-1055177589","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3947","id":1055177589,"node_id":"IC_kwDOAAMmUc4-5Lt1","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-01T08:59:35Z","updated_at":"2022-03-01T08:59:35Z","author_association":"MEMBER","body":"we have a general prohibition at https://github.com/apache/couchdb/blob/3.x/src/couch/src/couch_doc.erl#L377 for unknown special fields. I'm not sure it's wise to expand the couch_doc clauses to allow all `_replication_`-prefixed fields but others can comment if they feel strongly.\r\n\r\nreplications of `_replicator` db should be unaffected as the first clause allows any write by a user with the `_replicator` role.\r\n\r\nThe PR is trying to prevent users from being misled if they attempt to influence the replicator in undocumented ways.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1055177589/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1055988998","html_url":"https://github.com/apache/couchdb/pull/3947#issuecomment-1055988998","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3947","id":1055988998,"node_id":"IC_kwDOAAMmUc4-8R0G","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-01T23:59:52Z","updated_at":"2022-03-01T23:59:52Z","author_association":"CONTRIBUTOR","body":"The `_replicator` role isn't applied to replicated `_bulk_docs` writes to the replication endpoints. In that case, the write is indistinguishable from any other user `_bulk_docs` replicated POST request.\r\n\r\nIn other words, if user has backed up their replication job on `$backup_sever/_replicator/repjob` then they replicate `$backup_server/_replicator -> $server/_replicator`. The `_replicator` role is not applied when the `repjob` document is written. It is only applied when the replication app running on `$server` has started running that job, and wants to do a state update from `\"triggered\"` to `\"failed\"`, for example.\r\n\r\nSo, this would be one difference in behavior that I am not 100% sure about. Previously users were able to replicate replicator docs in any state, but after this change those documents could be skipped over.\r\n\r\nI made a script to demonstrate it https://gist.github.com/nickva/6ad4f7a284fe410d54da5affeb0e43de\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1055988998/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1056566116","html_url":"https://github.com/apache/couchdb/pull/3947#issuecomment-1056566116","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3947","id":1056566116,"node_id":"IC_kwDOAAMmUc4--etk","user":{"login":"lostnet","id":1422781,"node_id":"MDQ6VXNlcjE0MjI3ODE=","avatar_url":"https://avatars.githubusercontent.com/u/1422781?v=4","gravatar_id":"","url":"https://api.github.com/users/lostnet","html_url":"https://github.com/lostnet","followers_url":"https://api.github.com/users/lostnet/followers","following_url":"https://api.github.com/users/lostnet/following{/other_user}","gists_url":"https://api.github.com/users/lostnet/gists{/gist_id}","starred_url":"https://api.github.com/users/lostnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lostnet/subscriptions","organizations_url":"https://api.github.com/users/lostnet/orgs","repos_url":"https://api.github.com/users/lostnet/repos","events_url":"https://api.github.com/users/lostnet/events{/privacy}","received_events_url":"https://api.github.com/users/lostnet/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-02T08:33:00Z","updated_at":"2022-03-02T08:33:00Z","author_association":"CONTRIBUTOR","body":"It seems to me like there's a potential for a slippery slope into doing full JSON schema checking. I.e. in some context a confused admin may think replacing a property that is a string with an array or other type is meant to have an effect or that this secures against tampering with auditable history. This leads me to wonder if warnings in the fauxton's editor could be extended for more document-type specific checks and admins who edit directly should continue to do so at their own risk?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1056566116/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1056832880","html_url":"https://github.com/apache/couchdb/pull/3947#issuecomment-1056832880","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3947","id":1056832880,"node_id":"IC_kwDOAAMmUc4-_f1w","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-02T11:38:49Z","updated_at":"2022-03-02T11:38:49Z","author_association":"MEMBER","body":"The `_replicator` database should not have been user-accessible from the start. We should have put it behind an api endpoint with defined semantics. Too late to change it now, hence the approach in this PR. As for additional testing in fauxton, I'm skeptical. The best place to block unwanted writes is the VDU, which is enforced however the request is made.\r\n\r\nIf we think there's a risk that this change breaks existing legitimate uses (as @nickva is saying), it might be best not to merge this change.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1056832880/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1057091182","html_url":"https://github.com/apache/couchdb/pull/3947#issuecomment-1057091182","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3947","id":1057091182,"node_id":"IC_kwDOAAMmUc4_Ae5u","user":{"login":"lostnet","id":1422781,"node_id":"MDQ6VXNlcjE0MjI3ODE=","avatar_url":"https://avatars.githubusercontent.com/u/1422781?v=4","gravatar_id":"","url":"https://api.github.com/users/lostnet","html_url":"https://github.com/lostnet","followers_url":"https://api.github.com/users/lostnet/followers","following_url":"https://api.github.com/users/lostnet/following{/other_user}","gists_url":"https://api.github.com/users/lostnet/gists{/gist_id}","starred_url":"https://api.github.com/users/lostnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lostnet/subscriptions","organizations_url":"https://api.github.com/users/lostnet/orgs","repos_url":"https://api.github.com/users/lostnet/repos","events_url":"https://api.github.com/users/lostnet/events{/privacy}","received_events_url":"https://api.github.com/users/lostnet/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-02T16:00:16Z","updated_at":"2022-03-02T16:00:16Z","author_association":"CONTRIBUTOR","body":"Sure, I think I get this usage scenario. The distinction I'm thinking about is that:\r\n\r\n- The current contents of the VDU are mandatory security, i.e. the user can't be allowed to add a role they don't have to the context through any mechanism.\r\n- The intended additions are advisory, the user is achieving nothing by changing \\_replication\\_ values and it is nice to inform them (but possibly not correct to stop a programmatic update as @nickva points out.)\r\n\r\nI wouldn't have thought of _replicator document fields as a first priority in advisory validation, but I think there could be much more advisory information to add to make couchdb admin friendlier for adding users, design docs, etc. The fauxton client side and schema validation could better present growing amounts of non-critical advice/warnings/info and keep it out the VDUs to make it clear that they are just advice, aren't really part of any security model and maybe don't block save, etc.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1057091182/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1057340312","html_url":"https://github.com/apache/couchdb/pull/3932#issuecomment-1057340312","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3932","id":1057340312,"node_id":"IC_kwDOAAMmUc4_BbuY","user":{"login":"frapa","id":1306195,"node_id":"MDQ6VXNlcjEzMDYxOTU=","avatar_url":"https://avatars.githubusercontent.com/u/1306195?v=4","gravatar_id":"","url":"https://api.github.com/users/frapa","html_url":"https://github.com/frapa","followers_url":"https://api.github.com/users/frapa/followers","following_url":"https://api.github.com/users/frapa/following{/other_user}","gists_url":"https://api.github.com/users/frapa/gists{/gist_id}","starred_url":"https://api.github.com/users/frapa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/frapa/subscriptions","organizations_url":"https://api.github.com/users/frapa/orgs","repos_url":"https://api.github.com/users/frapa/repos","events_url":"https://api.github.com/users/frapa/events{/privacy}","received_events_url":"https://api.github.com/users/frapa/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-02T20:18:59Z","updated_at":"2022-03-02T20:19:07Z","author_association":"NONE","body":"I think this PR should now be finished.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1057340312/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1057477904","html_url":"https://github.com/apache/couchdb/pull/3947#issuecomment-1057477904","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3947","id":1057477904,"node_id":"IC_kwDOAAMmUc4_B9UQ","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-02T23:01:08Z","updated_at":"2022-03-02T23:01:36Z","author_association":"CONTRIBUTOR","body":"@lostnet yeah, it might be nice, in general, to have a schema we can export or publish from an endpoint so then Fauxton could use it to validate input.\r\n\r\nSpecifically for the replicator's VDU, an improvement could be to port the BDU (the Erlang VDU) approach from `main`. There we have a single module which both validates and parses the replication job.  That reduce duplication, so we don't validate it twice, and, as a bonus, it avoids having to auto-inject the VDU design doc. \r\n\r\nhttps://github.com/apache/couchdb/blob/main/src/couch_replicator/src/couch_replicator_parse.erl\r\n\r\n@rnewson One way we could allow replicated changes and disallow interactive edits is by using `_revisions` field as a heuristic. VDU functions don't get the `replicated_changes | interactive_edit` flag passed in, but in most cases, we could detect the  replicated changes by the presence of a `\"_revisions\" : {\"start\": N, \"ids: [Rev1, Rev2, ...]}` field. A bit too hackish perhaps?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1057477904/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1057514920","html_url":"https://github.com/apache/couchdb/pull/3947#issuecomment-1057514920","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3947","id":1057514920,"node_id":"IC_kwDOAAMmUc4_CGWo","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-02T23:47:53Z","updated_at":"2022-03-02T23:47:53Z","author_association":"MEMBER","body":"@lostnet There's no mechanism to send an \"advisory\" though, otherwise I'd agree. I also don't know what percentage of users edit documents through Fauxton but anything we do here would need to work for those that don't.\r\n\r\nThe underscore-prefixed fields are reserved for system use (lots of examples of this and is documented). There's enforcement against misuse for most of them because they stem from the erlang code itself. It's been tricky to extend that protection inside documents.\r\n\r\nI am not a huge fan of my proposed change, and the motivating case is a user that got caught out by this. It is the first time in my experience of couchdb (circa 11 years) where someone has thought they could edit the _replication_state field to achieve an effect (cancellation, in this case).\r\n\r\n@nickva A bit too cute, imo.\r\n\r\nWe've had a good discussion but perhaps it is best to do nothing.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1057514920/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1057615647","html_url":"https://github.com/apache/couchdb/pull/3940#issuecomment-1057615647","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3940","id":1057615647,"node_id":"IC_kwDOAAMmUc4_Ce8f","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-03T02:56:38Z","updated_at":"2022-03-03T02:56:38Z","author_association":"MEMBER","body":"@nickva @jcoglan I'm not sure I'll be able to return to this one in the short term given work commitments and some upcoming PTO. I have no issue with someone else picking this up, or mitigating the bug with a completely different tactic.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1057615647/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1058288443","html_url":"https://github.com/apache/couchdb/issues/3949#issuecomment-1058288443","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3949","id":1058288443,"node_id":"IC_kwDOAAMmUc4_FDM7","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-03T17:20:08Z","updated_at":"2022-03-03T17:20:08Z","author_association":"MEMBER","body":"Hm, thanks! I certainly thought I had published the key there, will fix.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1058288443/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1058875373","html_url":"https://github.com/apache/couchdb/issues/3949#issuecomment-1058875373","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3949","id":1058875373,"node_id":"IC_kwDOAAMmUc4_HSft","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-04T06:30:23Z","updated_at":"2022-03-04T23:29:24Z","author_association":"CONTRIBUTOR","body":"I signed the package and updated the repository\r\n\r\n```\r\nrpm --addsign couchdb-3.2.1-2.el7.x86_64.rpm\r\n\r\ngpg: writing to 'couchdb-3.2.1-2.el7.x86_64.rpm.sig'\r\ngpg: RSA/SHA256 signature from: \"FC04DFBC9657A78E Nicolae Vatamaniuc <vatamane@apache.org>\"\r\ngpg: writing to 'couchdb-3.2.1-2.el7.x86_64.rpm.sig'\r\ngpg: RSA/SHA256 signature from: \"FC04DFBC9657A78E Nicolae Vatamaniuc <vatamane@apache.org>\"\r\n```\r\n\r\n```\r\nrpmsign --addsign couchdb-3.2.1-2.el8.x86_64.rpm\r\n\r\ngpg: writing to 'el8/x86_64/couchdb-3.2.1-2.el8.x86_64.rpm.sig'\r\ngpg: RSA/SHA256 signature from: \"FC04DFBC9657A78E Nicolae Vatamaniuc <vatamane@apache.org>\"\r\ngpg: writing to 'el8/x86_64/couchdb-3.2.1-2.el8.x86_64.rpm.sig'\r\ngpg: RSA/SHA256 signature from: \"FC04DFBC9657A78E Nicolae Vatamaniuc <vatamane@apache.org>\"\r\n```\r\n\r\nVerified with:\r\n\r\n```\r\n$ docker run -it centos:7\r\n# yum-config-manager --add-repo https://couchdb.apache.org/repo/couchdb.repo\r\n# yum install couchdb\r\n```\r\n\r\n```\r\n$ docker run -it almalinux:8\r\n# yum install -y yum-utils\r\n# yum-config-manager --add-repo https://couchdb.apache.org/repo/couchdb.repo\r\n# yum install couchdb\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1058875373/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1059154528","html_url":"https://github.com/apache/couchdb/issues/3949#issuecomment-1059154528","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3949","id":1059154528,"node_id":"IC_kwDOAAMmUc4_IWpg","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-04T13:17:43Z","updated_at":"2022-03-04T13:17:43Z","author_association":"MEMBER","body":"Thanks Nick!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1059154528/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1059177568","html_url":"https://github.com/apache/couchdb/issues/3949#issuecomment-1059177568","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3949","id":1059177568,"node_id":"IC_kwDOAAMmUc4_IcRg","user":{"login":"dehaansa","id":563558,"node_id":"MDQ6VXNlcjU2MzU1OA==","avatar_url":"https://avatars.githubusercontent.com/u/563558?v=4","gravatar_id":"","url":"https://api.github.com/users/dehaansa","html_url":"https://github.com/dehaansa","followers_url":"https://api.github.com/users/dehaansa/followers","following_url":"https://api.github.com/users/dehaansa/following{/other_user}","gists_url":"https://api.github.com/users/dehaansa/gists{/gist_id}","starred_url":"https://api.github.com/users/dehaansa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dehaansa/subscriptions","organizations_url":"https://api.github.com/users/dehaansa/orgs","repos_url":"https://api.github.com/users/dehaansa/repos","events_url":"https://api.github.com/users/dehaansa/events{/privacy}","received_events_url":"https://api.github.com/users/dehaansa/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-04T13:49:02Z","updated_at":"2022-03-04T13:49:02Z","author_association":"NONE","body":"Confirmed, it works as expected in my environment. Thanks for the quick responses!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1059177568/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1059450735","html_url":"https://github.com/apache/couchdb/pull/3950#issuecomment-1059450735","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3950","id":1059450735,"node_id":"IC_kwDOAAMmUc4_Je9v","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-04T19:26:18Z","updated_at":"2022-03-04T19:26:18Z","author_association":"CONTRIBUTOR","body":"Example of a crash:\r\n\r\n```\r\ncouch_replicator_scheduler_job:handle_info({#Ref<0.199527780.840171523.212239>,{ok,\"200\",[{\"Cache-Control\",\"must-revalidate\"},...\r\n```\r\n\r\nFrom https://couchdb.slack.com/archives/C49LEE7NW/p1646318130239849","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1059450735/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1059758034","html_url":"https://github.com/apache/couchdb/issues/3951#issuecomment-1059758034","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3951","id":1059758034,"node_id":"IC_kwDOAAMmUc4_Kp_S","user":{"login":"SamYuan1990","id":7820992,"node_id":"MDQ6VXNlcjc4MjA5OTI=","avatar_url":"https://avatars.githubusercontent.com/u/7820992?v=4","gravatar_id":"","url":"https://api.github.com/users/SamYuan1990","html_url":"https://github.com/SamYuan1990","followers_url":"https://api.github.com/users/SamYuan1990/followers","following_url":"https://api.github.com/users/SamYuan1990/following{/other_user}","gists_url":"https://api.github.com/users/SamYuan1990/gists{/gist_id}","starred_url":"https://api.github.com/users/SamYuan1990/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SamYuan1990/subscriptions","organizations_url":"https://api.github.com/users/SamYuan1990/orgs","repos_url":"https://api.github.com/users/SamYuan1990/repos","events_url":"https://api.github.com/users/SamYuan1990/events{/privacy}","received_events_url":"https://api.github.com/users/SamYuan1990/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-05T12:49:26Z","updated_at":"2022-03-05T12:49:26Z","author_association":"NONE","body":"as so far, with default value as configuration.\r\naccess:\r\n```\r\n/tmp % curl 127.0.0.1:5984/_node/_local/_prometheus \r\n{\"error\":\"unauthorized\",\"reason\":\"You are not a server admin or read-only metrics user\"}\r\n```\r\n\r\nrelated with https://github.com/apache/couchdb/discussions/3935\r\n\r\nI can understand we want to disable the prometheus by default, but...\r\nas current status, the prometheus seems enabled at port 5984, and blocked prometheus as prometheus operator to access it.\r\nare we want it disabled by default?\r\nor \r\nwe'd better have a fixable configuration to control this feature enablement?\r\n\r\nwith my hands on, I am confusing.\r\n\r\nattachment my yaml file for reference.\r\n\r\n```\r\n---\r\napiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: org1peer1couchdb\r\nspec:\r\n  selector:\r\n    app: org1peer1couchdb\r\n  ports:\r\n  - name: couchport\r\n    port: 5984\r\n    protocol: TCP\r\n  - name: matrix\r\n    port: 17986\r\n    protocol: TCP  \r\n---\r\napiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: org1peer1couchdb\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: org1peer1couchdb\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: org1peer1couchdb\r\n    spec:\r\n      containers:\r\n      - name: couchdb\r\n        image: couchdb:3.2\r\n        imagePullPolicy: IfNotPresent\r\n        env:\r\n          - name: \"COUCHDB_USER\"\r\n            value: \"admin\" \r\n          - name: \"COUCHDB_PASSWORD\"\r\n            value: \"adminpw\"\r\n          - name: \"PROMETHEUS_ADDITIONAL_PORT\" # useless so far\r\n            value: \"true\"\r\n          - name: \"PROMETHEUS_BIND_ADDRESS\" # useless so far\r\n            value: \"0.0.0.0\"\r\n          - name: \"PROMETHEUS_PORT\" # useless so far\r\n            value: \"17986\"\r\n        ports:\r\n            - containerPort: 5984\r\n            - containerPort: 17986\r\n---\r\napiVersion: monitoring.coreos.com/v1\r\nkind: ServiceMonitor\r\nmetadata:\r\n  name: org1peer1couchdb\r\n  namespace: default\r\n  labels:\r\n    release: mypro\r\nspec:\r\n  namespaceSelector: \r\n    matchNames:\r\n    - default\r\n  selector:\r\n    matchLabels:\r\n      app:  org1peer1couchdb\r\n  endpoints:\r\n  - port: couchport \r\n    path: /_node/_local/_prometheus\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1059758034/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065056150","html_url":"https://github.com/apache/couchdb/issues/3956#issuecomment-1065056150","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3956","id":1065056150,"node_id":"IC_kwDOAAMmUc4_e3eW","user":{"login":"guanfeix","id":34960209,"node_id":"MDQ6VXNlcjM0OTYwMjA5","avatar_url":"https://avatars.githubusercontent.com/u/34960209?v=4","gravatar_id":"","url":"https://api.github.com/users/guanfeix","html_url":"https://github.com/guanfeix","followers_url":"https://api.github.com/users/guanfeix/followers","following_url":"https://api.github.com/users/guanfeix/following{/other_user}","gists_url":"https://api.github.com/users/guanfeix/gists{/gist_id}","starred_url":"https://api.github.com/users/guanfeix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guanfeix/subscriptions","organizations_url":"https://api.github.com/users/guanfeix/orgs","repos_url":"https://api.github.com/users/guanfeix/repos","events_url":"https://api.github.com/users/guanfeix/events{/privacy}","received_events_url":"https://api.github.com/users/guanfeix/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-11T12:10:28Z","updated_at":"2022-03-11T12:10:28Z","author_association":"NONE","body":"This is some part of log,because of log level limits maybe not so detailed\r\n[couch-5985.log](https://github.com/apache/couchdb/files/8231698/couch-5985.log)\r\n ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065056150/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065223944","html_url":"https://github.com/apache/couchdb/issues/3956#issuecomment-1065223944","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3956","id":1065223944,"node_id":"IC_kwDOAAMmUc4_fgcI","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-11T15:34:05Z","updated_at":"2022-03-11T15:34:05Z","author_association":"CONTRIBUTOR","body":"It looks like the compactor is failing to compact the database. It's hard to say immediately why, but behaves as if the documents appeared in the sequence index but then miss from the main doc id index. \r\n\r\nPerhaps try to stop any updates to the database, stop replications, and try to compact again manually. Otherwise investigate if the perhaps there is a failing disk.\r\n\r\nAs this is 1.6, try to upgrade to latest 1.7. Then, try to replicate that db to a new copy. But, seeing as we have these missing document bodies that appear in the changes feed that might fail as well.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065223944/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065228427","html_url":"https://github.com/apache/couchdb/issues/3955#issuecomment-1065228427","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3955","id":1065228427,"node_id":"IC_kwDOAAMmUc4_fhiL","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-11T15:38:49Z","updated_at":"2022-03-11T15:38:49Z","author_association":"CONTRIBUTOR","body":"Thanks for your report, @silvpol. Yeah it does look like a bug.\r\n\r\nDoes it fail with a single document or do we need to create a certain number of them?\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065228427/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065342720","html_url":"https://github.com/apache/couchdb/issues/3955#issuecomment-1065342720","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3955","id":1065342720,"node_id":"IC_kwDOAAMmUc4_f9cA","user":{"login":"silvpol","id":2226747,"node_id":"MDQ6VXNlcjIyMjY3NDc=","avatar_url":"https://avatars.githubusercontent.com/u/2226747?v=4","gravatar_id":"","url":"https://api.github.com/users/silvpol","html_url":"https://github.com/silvpol","followers_url":"https://api.github.com/users/silvpol/followers","following_url":"https://api.github.com/users/silvpol/following{/other_user}","gists_url":"https://api.github.com/users/silvpol/gists{/gist_id}","starred_url":"https://api.github.com/users/silvpol/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/silvpol/subscriptions","organizations_url":"https://api.github.com/users/silvpol/orgs","repos_url":"https://api.github.com/users/silvpol/repos","events_url":"https://api.github.com/users/silvpol/events{/privacy}","received_events_url":"https://api.github.com/users/silvpol/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-11T17:48:30Z","updated_at":"2022-03-11T17:48:30Z","author_association":"NONE","body":"@nickva I have tested and it also happens in a db with just a single doc.\r\n\r\nInserting custom reduce funtion via API is not restricted and causes **ALL** views in the given design doc to fail with the same error message, which is rather scary.\r\n\r\nI have also tried to update design doc via Fauxton and it shows warning that partitioned DB doesn't support custom reduce. This points to a known limitation but it would be good to add it somewhere in the API docs.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065342720/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065403637","html_url":"https://github.com/apache/couchdb/issues/3955#issuecomment-1065403637","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3955","id":1065403637,"node_id":"IC_kwDOAAMmUc4_gMT1","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-11T19:02:39Z","updated_at":"2022-03-11T19:02:39Z","author_association":"CONTRIBUTOR","body":"@silvpol That makes sense. \r\n\r\nIt is quite embarrassing, it seems we never intended to support partitioned db custom reduces but added a check in Fauxton only, but not the internal design doc updater validation logic.\r\n\r\nThe fix here it seems is to update the ddoc validation logic to conform to what we intended.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065403637/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065474107","html_url":"https://github.com/apache/couchdb/issues/3955#issuecomment-1065474107","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3955","id":1065474107,"node_id":"IC_kwDOAAMmUc4_gdg7","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-11T20:10:37Z","updated_at":"2022-03-11T20:10:37Z","author_association":"CONTRIBUTOR","body":"Added an integration tests which demonstrates it as well: https://github.com/apache/couchdb/pull/3957","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065474107/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065490419","html_url":"https://github.com/apache/couchdb/issues/3955#issuecomment-1065490419","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3955","id":1065490419,"node_id":"IC_kwDOAAMmUc4_ghfz","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-11T20:24:45Z","updated_at":"2022-03-11T20:24:45Z","author_association":"CONTRIBUTOR","body":"Fauxton indicates we don't intend to support it\r\n\r\nhttps://github.com/apache/couchdb-fauxton/blob/f9da884aaee6ce60779b924196f5bfa3308a02c0/app/addons/documents/index-editor/components/IndexEditor.js#L48-L54","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065490419/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065841604","html_url":"https://github.com/apache/couchdb/pull/3883#issuecomment-1065841604","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3883","id":1065841604,"node_id":"IC_kwDOAAMmUc4_h3PE","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-12T08:34:57Z","updated_at":"2022-03-12T08:34:57Z","author_association":"MEMBER","body":"@lostnet nice work here. Isn’t his missing an entry here?\r\n\r\nhttps://github.com/apache/couchdb/blob/3.x/src/couch/rebar.config.script#L66-L67","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065841604/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065841605","html_url":"https://github.com/apache/couchdb/pull/3883#issuecomment-1065841605","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3883","id":1065841605,"node_id":"IC_kwDOAAMmUc4_h3PF","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-12T08:34:57Z","updated_at":"2022-03-12T08:34:57Z","author_association":"MEMBER","body":"@lostnet nice work here. Isn’t his missing an entry here?\r\n\r\nhttps://github.com/apache/couchdb/blob/3.x/src/couch/rebar.config.script#L66-L67","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065841605/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065860067","html_url":"https://github.com/apache/couchdb/pull/3883#issuecomment-1065860067","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3883","id":1065860067,"node_id":"IC_kwDOAAMmUc4_h7vj","user":{"login":"lostnet","id":1422781,"node_id":"MDQ6VXNlcjE0MjI3ODE=","avatar_url":"https://avatars.githubusercontent.com/u/1422781?v=4","gravatar_id":"","url":"https://api.github.com/users/lostnet","html_url":"https://github.com/lostnet","followers_url":"https://api.github.com/users/lostnet/followers","following_url":"https://api.github.com/users/lostnet/following{/other_user}","gists_url":"https://api.github.com/users/lostnet/gists{/gist_id}","starred_url":"https://api.github.com/users/lostnet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lostnet/subscriptions","organizations_url":"https://api.github.com/users/lostnet/orgs","repos_url":"https://api.github.com/users/lostnet/repos","events_url":"https://api.github.com/users/lostnet/events{/privacy}","received_events_url":"https://api.github.com/users/lostnet/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-12T10:43:20Z","updated_at":"2022-03-12T10:43:20Z","author_association":"CONTRIBUTOR","body":"Hi @janl, that looks like 3.x, but this pull is based on the feat/support-sm91-3.x-from-lostnet branch since your backport from 4.x of the original changes looks good to me:\r\nhttps://github.com/apache/couchdb/blob/feat/support-sm91-3.x-from-lostnet/src/couch/rebar.config.script#L68","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065860067/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065860982","html_url":"https://github.com/apache/couchdb/pull/3883#issuecomment-1065860982","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3883","id":1065860982,"node_id":"IC_kwDOAAMmUc4_h792","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-12T10:49:58Z","updated_at":"2022-03-12T10:49:58Z","author_association":"MEMBER","body":"oh I’m now realising this is a PR to a feature branch and not `3.x`, never mind! :D","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065860982/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065921555","html_url":"https://github.com/apache/couchdb/pull/3938#issuecomment-1065921555","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3938","id":1065921555,"node_id":"IC_kwDOAAMmUc4_iKwT","user":{"login":"tsloughter","id":36227,"node_id":"MDQ6VXNlcjM2MjI3","avatar_url":"https://avatars.githubusercontent.com/u/36227?v=4","gravatar_id":"","url":"https://api.github.com/users/tsloughter","html_url":"https://github.com/tsloughter","followers_url":"https://api.github.com/users/tsloughter/followers","following_url":"https://api.github.com/users/tsloughter/following{/other_user}","gists_url":"https://api.github.com/users/tsloughter/gists{/gist_id}","starred_url":"https://api.github.com/users/tsloughter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsloughter/subscriptions","organizations_url":"https://api.github.com/users/tsloughter/orgs","repos_url":"https://api.github.com/users/tsloughter/repos","events_url":"https://api.github.com/users/tsloughter/events{/privacy}","received_events_url":"https://api.github.com/users/tsloughter/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-12T17:11:30Z","updated_at":"2022-03-12T17:11:30Z","author_association":"NONE","body":"I just looked at `rebar_raw_resource` hasn't been updated in over 6 years, I doubt it works. There may be another raw resource plugin.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065921555/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065929342","html_url":"https://github.com/apache/couchdb/pull/3938#issuecomment-1065929342","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3938","id":1065929342,"node_id":"IC_kwDOAAMmUc4_iMp-","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-12T17:49:11Z","updated_at":"2022-03-12T17:49:11Z","author_association":"CONTRIBUTOR","body":"Thanks for taking a look, @tsloughter. It's much appreciated.\r\n\r\nFor raw dependencies, would it be feasible to turn those into empty/no-op erlang apps so they can compile and build like regular dependencies?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065929342/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065984623","html_url":"https://github.com/apache/couchdb/pull/3938#issuecomment-1065984623","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3938","id":1065984623,"node_id":"IC_kwDOAAMmUc4_iaJv","user":{"login":"tsloughter","id":36227,"node_id":"MDQ6VXNlcjM2MjI3","avatar_url":"https://avatars.githubusercontent.com/u/36227?v=4","gravatar_id":"","url":"https://api.github.com/users/tsloughter","html_url":"https://github.com/tsloughter","followers_url":"https://api.github.com/users/tsloughter/followers","following_url":"https://api.github.com/users/tsloughter/following{/other_user}","gists_url":"https://api.github.com/users/tsloughter/gists{/gist_id}","starred_url":"https://api.github.com/users/tsloughter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsloughter/subscriptions","organizations_url":"https://api.github.com/users/tsloughter/orgs","repos_url":"https://api.github.com/users/tsloughter/repos","events_url":"https://api.github.com/users/tsloughter/events{/privacy}","received_events_url":"https://api.github.com/users/tsloughter/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-12T23:35:23Z","updated_at":"2022-03-12T23:35:23Z","author_association":"NONE","body":"If you are able to control the dependencies then yes, turning them into empty erlang apps should work. They wouldn't be included in the release, so would just be \"apps\" fetched and kept in `_build`.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065984623/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065985923","html_url":"https://github.com/apache/couchdb/pull/3938#issuecomment-1065985923","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3938","id":1065985923,"node_id":"IC_kwDOAAMmUc4_iaeD","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-12T23:46:19Z","updated_at":"2022-03-12T23:46:19Z","author_association":"CONTRIBUTOR","body":"> If you are able to control the dependencies then yes, turning them into empty erlang apps should work. They wouldn't be included in the release, so would just be \"apps\" fetched and kept in `_build`.\r\n\r\nThanks! We do control them and that may be the easiest way to go, then","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1065985923/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1066296289","html_url":"https://github.com/apache/couchdb/issues/3956#issuecomment-1066296289","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3956","id":1066296289,"node_id":"IC_kwDOAAMmUc4_jmPh","user":{"login":"guanfeix","id":34960209,"node_id":"MDQ6VXNlcjM0OTYwMjA5","avatar_url":"https://avatars.githubusercontent.com/u/34960209?v=4","gravatar_id":"","url":"https://api.github.com/users/guanfeix","html_url":"https://github.com/guanfeix","followers_url":"https://api.github.com/users/guanfeix/followers","following_url":"https://api.github.com/users/guanfeix/following{/other_user}","gists_url":"https://api.github.com/users/guanfeix/gists{/gist_id}","starred_url":"https://api.github.com/users/guanfeix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guanfeix/subscriptions","organizations_url":"https://api.github.com/users/guanfeix/orgs","repos_url":"https://api.github.com/users/guanfeix/repos","events_url":"https://api.github.com/users/guanfeix/events{/privacy}","received_events_url":"https://api.github.com/users/guanfeix/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-14T03:13:08Z","updated_at":"2022-03-14T03:56:12Z","author_association":"NONE","body":"I try stop the replicate, delete the dpl_job.compact,restart couchdb. catch the log \r\n[Mon, 14 Mar 2022 02:55:56 GMT] [info] [<0.1327.0>] Starting compaction for db \"dpl_job\"\r\n[Mon, 14 Mar 2022 02:55:56 GMT] [info] [<0.117.0>] 127.0.0.1 - - POST /dpl_job/_compact 202\r\n[Mon, 14 Mar 2022 02:55:56 GMT] [error] [emulator] Error in process <0.1332.0> with exit value: {function_clause,[{couch_db_updater,'-copy_docs/4-fun-3-',[not_found],[{file,\"couch_db_updater.erl\"},{line,862}]},{lists,map,2,[{file,\"lists.erl\"},{line,1224}]},{lists,map,2,[{file,\"lists.erl\"},{line,1224}]},{couch_db_updater,copy_docs... \r\n\r\n\r\n[Mon, 14 Mar 2022 02:55:56 GMT] [error] [<0.1327.0>] ** Generic server <0.1327.0> terminating \r\n** Last message in was {'EXIT',<0.1332.0>,\r\n                           {function_clause,\r\n                               [{couch_db_updater,'-copy_docs/4-fun-3-',\r\n                                    [not_found],\r\n                                    [{file,\"couch_db_updater.erl\"},\r\n                                     {line,862}]},\r\n                                {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n                                {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n                                {couch_db_updater,copy_docs,4,\r\n                                    [{file,\"couch_db_updater.erl\"},\r\n                                     {line,861}]},\r\n                                {couch_db_updater,copy_compact,3,\r\n                                    [{file,\"couch_db_updater.erl\"},\r\n                                     {line,961}]},\r\n                                {couch_db_updater,start_copy_compact,1,\r\n                                    [{file,\"couch_db_updater.erl\"},\r\n                                     {line,1004}]}]}}\r\n** When Server state == {db,<0.1326.0>,<0.1327.0>,<0.1332.0>,\r\n                            <<\"1647226556413367\">>,<0.1328.0>,<0.1324.0>,\r\n                            <0.1330.0>,\r\n                            {db_header,6,36085,0,\r\n                                {433507267,{55,456,65074},88060},\r\n                                {433509119,543,43262},\r\n                                {433522899,[],20453},\r\n                                140,417682521,nil,10},\r\n                            36085,\r\n                            {btree,<0.1324.0>,\r\n                                {433507267,{55,456,65074},88060},\r\n                                #Fun<couch_db_updater.10.58444962>,\r\n                                #Fun<couch_db_updater.11.58444962>,\r\n                                #Fun<couch_btree.5.15886126>,\r\n                                #Fun<couch_db_updater.12.58444962>,snappy},\r\n                            {btree,<0.1324.0>,\r\n                                {433509119,543,43262},\r\n                                #Fun<couch_db_updater.13.58444962>,\r\n                                #Fun<couch_db_updater.14.58444962>,\r\n                                #Fun<couch_btree.5.15886126>,\r\n                                #Fun<couch_db_updater.15.58444962>,snappy},\r\n                            {btree,<0.1324.0>,\r\n                                {433522899,[],20453},\r\n                                #Fun<couch_btree.3.15886126>,\r\n                                #Fun<couch_btree.4.15886126>,\r\n                                #Fun<couch_btree.5.15886126>,nil,snappy},\r\n                            36085,<<\"dpl_job\">>,\r\n                            \"/var/lib/couchdb-5985/dpl_job.couch\",[],[],nil,\r\n                            {user_ctx,null,[],undefined},\r\n                            nil,10,\r\n                            [before_header,after_header,on_file_open],\r\n                            [{user_ctx,\r\n                                 {user_ctx,null,\r\n                                     [<<\"_admin\">>],\r\n                                     <<\"{couch_httpd_auth, default_authentication_handler}\">>}}],\r\n                            snappy,nil,nil}\r\n** Reason for termination == \r\n** {function_clause,\r\n       [{couch_db_updater,'-copy_docs/4-fun-3-',\r\n            [not_found],\r\n            [{file,\"couch_db_updater.erl\"},{line,862}]},\r\n        {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n        {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n        {couch_db_updater,copy_docs,4,\r\n            [{file,\"couch_db_updater.erl\"},{line,861}]},\r\n        {couch_db_updater,copy_compact,3,\r\n            [{file,\"couch_db_updater.erl\"},{line,961}]},\r\n        {couch_db_updater,start_copy_compact,1,\r\n            [{file,\"couch_db_updater.erl\"},{line,1004}]}]}\r\n\r\n[Mon, 14 Mar 2022 02:55:56 GMT] [error] [<0.1327.0>] {error_report,<0.31.0>,\r\n                      {<0.1327.0>,crash_report,\r\n                       [[{initial_call,\r\n                          {couch_db_updater,init,['Argument__1']}},\r\n                         {pid,<0.1327.0>},\r\n                         {registered_name,[]},\r\n                         {error_info,\r\n                          {exit,\r\n                           {function_clause,\r\n                            [{couch_db_updater,'-copy_docs/4-fun-3-',\r\n                              [not_found],\r\n                              [{file,\"couch_db_updater.erl\"},{line,862}]},\r\n                             {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n                             {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n                             {couch_db_updater,copy_docs,4,\r\n                              [{file,\"couch_db_updater.erl\"},{line,861}]},\r\n                             {couch_db_updater,copy_compact,3,\r\n                              [{file,\"couch_db_updater.erl\"},{line,961}]},\r\n                             {couch_db_updater,start_copy_compact,1,\r\n                              [{file,\"couch_db_updater.erl\"},{line,1004}]}]},\r\n                           [{gen_server,terminate,6,\r\n                             [{file,\"gen_server.erl\"},{line,744}]},\r\n                            {proc_lib,init_p_do_apply,3,\r\n                             [{file,\"proc_lib.erl\"},{line,239}]}]}},\r\n                         {ancestors,[<0.1326.0>,<0.1323.0>]},\r\n                         {messages,[]},\r\n                         {links,[<0.1326.0>]},\r\n                         {dictionary,[]},\r\n                         {trap_exit,true},\r\n                         {status,running},\r\n                         {heap_size,4185},\r\n                         {stack_size,27},\r\n                         {reductions,1744}],\r\n                        []]}}\r\n[Mon, 14 Mar 2022 02:55:56 GMT] [error] [<0.1326.0>] ** Generic server <0.1326.0> terminating \r\n** Last message in was {'EXIT',<0.1327.0>,\r\n                           {function_clause,\r\n                               [{couch_db_updater,'-copy_docs/4-fun-3-',\r\n                                    [not_found],\r\n                                    [{file,\"couch_db_updater.erl\"},\r\n                                     {line,862}]},\r\n                                {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n                                {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n                                {couch_db_updater,copy_docs,4,\r\n                                    [{file,\"couch_db_updater.erl\"},\r\n                                     {line,861}]},\r\n                                {couch_db_updater,copy_compact,3,\r\n                                    [{file,\"couch_db_updater.erl\"},\r\n                                     {line,961}]},\r\n                                {couch_db_updater,start_copy_compact,1,\r\n                                    [{file,\"couch_db_updater.erl\"},\r\n                                     {line,1004}]}]}}\r\n** When Server state == {db,<0.1326.0>,<0.1327.0>,<0.1332.0>,\r\n                            <<\"1647226556413367\">>,<0.1328.0>,<0.1324.0>,\r\n                            <0.1330.0>,\r\n                            {db_header,6,36085,0,\r\n                                {433507267,{55,456,65074},88060},\r\n                                {433509119,543,43262},\r\n                                {433522899,[],20453},\r\n                                140,417682521,nil,10},\r\n                            36085,\r\n                            {btree,<0.1324.0>,\r\n                                {433507267,{55,456,65074},88060},\r\n                                #Fun<couch_db_updater.10.58444962>,\r\n                                #Fun<couch_db_updater.11.58444962>,\r\n                                #Fun<couch_btree.5.15886126>,\r\n                                #Fun<couch_db_updater.12.58444962>,snappy},\r\n                            {btree,<0.1324.0>,\r\n                                {433509119,543,43262},\r\n                                #Fun<couch_db_updater.13.58444962>,\r\n                                #Fun<couch_db_updater.14.58444962>,\r\n                                #Fun<couch_btree.5.15886126>,\r\n                                #Fun<couch_db_updater.15.58444962>,snappy},\r\n                            {btree,<0.1324.0>,\r\n                                {433522899,[],20453},\r\n                                #Fun<couch_btree.3.15886126>,\r\n                                #Fun<couch_btree.4.15886126>,\r\n                                #Fun<couch_btree.5.15886126>,nil,snappy},\r\n                            36085,<<\"dpl_job\">>,\r\n                            \"/var/lib/couchdb-5985/dpl_job.couch\",[],[],nil,\r\n                            {user_ctx,null,[],undefined},\r\n                            nil,10,\r\n                            [before_header,after_header,on_file_open],\r\n                            [{user_ctx,\r\n                                 {user_ctx,null,\r\n                                     [<<\"_admin\">>],\r\n                                     <<\"{couch_httpd_auth, default_authentication_handler}\">>}}],\r\n                            snappy,nil,nil}\r\n** Reason for termination == \r\n** {function_clause,\r\n       [{couch_db_updater,'-copy_docs/4-fun-3-',\r\n            [not_found],\r\n            [{file,\"couch_db_updater.erl\"},{line,862}]},\r\n        {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n        {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n        {couch_db_updater,copy_docs,4,\r\n            [{file,\"couch_db_updater.erl\"},{line,861}]},\r\n        {couch_db_updater,copy_compact,3,\r\n            [{file,\"couch_db_updater.erl\"},{line,961}]},\r\n        {couch_db_updater,start_copy_compact,1,\r\n            [{file,\"couch_db_updater.erl\"},{line,1004}]}]}\r\n\r\n[Mon, 14 Mar 2022 02:55:56 GMT] [error] [<0.1326.0>] {error_report,<0.31.0>,\r\n                      {<0.1326.0>,crash_report,\r\n                       [[{initial_call,{couch_db,init,['Argument__1']}},\r\n                         {pid,<0.1326.0>},\r\n                         {registered_name,[]},\r\n                         {error_info,\r\n                          {exit,\r\n                           {function_clause,\r\n                            [{couch_db_updater,'-copy_docs/4-fun-3-',\r\n                              [not_found],\r\n                              [{file,\"couch_db_updater.erl\"},{line,862}]},\r\n                             {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n                             {lists,map,2,[{file,\"lists.erl\"},{line,1224}]},\r\n                             {couch_db_updater,copy_docs,4,\r\n                              [{file,\"couch_db_updater.erl\"},{line,861}]},\r\n                             {couch_db_updater,copy_compact,3,\r\n                              [{file,\"couch_db_updater.erl\"},{line,961}]},\r\n                             {couch_db_updater,start_copy_compact,1,\r\n                              [{file,\"couch_db_updater.erl\"},{line,1004}]}]},\r\n                           [{gen_server,terminate,6,\r\n                             [{file,\"gen_server.erl\"},{line,744}]},\r\n                            {proc_lib,init_p_do_apply,3,\r\n                             [{file,\"proc_lib.erl\"},{line,239}]}]}},\r\n                         {ancestors,[<0.1323.0>]},\r\n                         {messages,[]},\r\n                         {links,[<0.88.0>]},\r\n                         {dictionary,[]},\r\n                         {trap_exit,true},\r\n                         {status,running},\r\n                         {heap_size,987},\r\n                         {stack_size,27},\r\n                         {reductions,308}],\r\n                        []]}}\r\n[Mon, 14 Mar 2022 02:55:56 GMT] [error] [<0.88.0>] Unexpected exit of database process <0.1326.0> [<<\"dpl_job\">>]: {function_clause,\r\n                                                                                    [{couch_db_updater,\r\n                                                                                      '-copy_docs/4-fun-3-',\r\n                                                                                      [not_found],\r\n                                                                                      [{file,\r\n                                                                                        \"couch_db_updater.erl\"},\r\n                                                                                       {line,\r\n                                                                                        862}]},\r\n                                                                                     {lists,\r\n                                                                                      map,\r\n                                                                                      2,\r\n                                                                                      [{file,\r\n                                                                                        \"lists.erl\"},\r\n                                                                                       {line,\r\n                                                                                        1224}]},\r\n                                                                                     {lists,\r\n                                                                                      map,\r\n                                                                                      2,\r\n                                                                                      [{file,\r\n                                                                                        \"lists.erl\"},\r\n                                                                                       {line,\r\n                                                                                        1224}]},\r\n                                                                                     {couch_db_updater,\r\n                                                                                      copy_docs,\r\n                                                                                      4,\r\n                                                                                      [{file,\r\n                                                                                        \"couch_db_updater.erl\"},\r\n                                                                                       {line,\r\n                                                                                        861}]},\r\n                                                                                     {couch_db_updater,\r\n                                                                                      copy_compact,\r\n                                                                                      3,\r\n                                                                                      [{file,\r\n                                                                                        \"couch_db_updater.erl\"},\r\n                                                                                       {line,\r\n                                                                                        961}]},\r\n                                                                                     {couch_db_updater,\r\n                                                                                      start_copy_compact,\r\n                                                                                      1,\r\n                                                                                      [{file,\r\n                                                                                        \"couch_db_updater.erl\"},\r\n                                                                                       {line,\r\n                                                                                        1004}]}]}\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1066296289/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1066991256","html_url":"https://github.com/apache/couchdb/issues/3959#issuecomment-1066991256","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3959","id":1066991256,"node_id":"IC_kwDOAAMmUc4_mP6Y","user":{"login":"ronag","id":3065230,"node_id":"MDQ6VXNlcjMwNjUyMzA=","avatar_url":"https://avatars.githubusercontent.com/u/3065230?v=4","gravatar_id":"","url":"https://api.github.com/users/ronag","html_url":"https://github.com/ronag","followers_url":"https://api.github.com/users/ronag/followers","following_url":"https://api.github.com/users/ronag/following{/other_user}","gists_url":"https://api.github.com/users/ronag/gists{/gist_id}","starred_url":"https://api.github.com/users/ronag/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ronag/subscriptions","organizations_url":"https://api.github.com/users/ronag/orgs","repos_url":"https://api.github.com/users/ronag/repos","events_url":"https://api.github.com/users/ronag/events{/privacy}","received_events_url":"https://api.github.com/users/ronag/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-14T15:58:14Z","updated_at":"2022-03-14T15:58:34Z","author_association":"NONE","body":"```\r\n\\\"server\\\": \\\"CouchDB/3.2.1 (Erlang OTP/20)\\\",\r\n\\\"x-couch-request-id\\\": \\\"84771c9a5d\\\",\r\n\\\"x-couch-stack-hash\\\": \\\"27933023\\\",\\n\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1066991256/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1067590688","html_url":"https://github.com/apache/couchdb/pull/3938#issuecomment-1067590688","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3938","id":1067590688,"node_id":"IC_kwDOAAMmUc4_oiQg","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-15T05:53:56Z","updated_at":"2022-03-25T17:02:49Z","author_association":"CONTRIBUTOR","body":"Some progress\r\n * Basic Erlang app structure in raw dependencies seems to have worked (thanks, Tristan!)\r\n * Created an initially broken symlink from `src/{docs|fauxton} -> _build/_build/default/lib/{docs|fauxton}` which later gets filled in by the `get-deps`. This is mainly to avoid altering docs and Fauxton tooling which expects those deps in those directories.\r\n * `configure` i.e. download rebar3, get-deps seems to work\r\n * `make` works as well, but not sure if it all the artifacts end up in the right place\r\n * eunit starts and runs for a few basic erlang app but chokes on a NIF\r\n\r\n```\r\n   module 'couch_debug'\r\n      link_tree tests\r\n        couch_debug:753: should_have_same_shape...[0.001 s] ok\r\n        couch_debug:761: should_include_extra_info...[0.001 s] ok\r\n        [done in 0.020 s]\r\n      [done in 0.020 s]\r\n    module 'couch_doc'\r\nundefined\r\n*** test module not found ***\r\n**couch_ejson_compare\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1067590688/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1068776922","html_url":"https://github.com/apache/couchdb/issues/3948#issuecomment-1068776922","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3948","id":1068776922,"node_id":"IC_kwDOAAMmUc4_tD3a","user":{"login":"tonysun83","id":6991573,"node_id":"MDQ6VXNlcjY5OTE1NzM=","avatar_url":"https://avatars.githubusercontent.com/u/6991573?v=4","gravatar_id":"","url":"https://api.github.com/users/tonysun83","html_url":"https://github.com/tonysun83","followers_url":"https://api.github.com/users/tonysun83/followers","following_url":"https://api.github.com/users/tonysun83/following{/other_user}","gists_url":"https://api.github.com/users/tonysun83/gists{/gist_id}","starred_url":"https://api.github.com/users/tonysun83/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tonysun83/subscriptions","organizations_url":"https://api.github.com/users/tonysun83/orgs","repos_url":"https://api.github.com/users/tonysun83/repos","events_url":"https://api.github.com/users/tonysun83/events{/privacy}","received_events_url":"https://api.github.com/users/tonysun83/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-16T06:18:48Z","updated_at":"2022-03-16T06:18:48Z","author_association":"CONTRIBUTOR","body":"@nickva A trivial approach which you probably considered is to mask the `dict:fetch` by catching the badargs and storing `undefined` for the > 100 case. Assuming that the < 100 case simply has \"error\" : \"undefined\" as part of it's 201 response, then this trivial change would align with it. \r\n\r\nWe know generally why `Results` is not fully populated (as you mentioned). More importantly, I don't think it's possible to write the code in such a way where we can guarantee len(AllDocs) == len(Results). Any solution would probably entail populating the missing result with place holder such as `undefined`. What do you think?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1068776922/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1069187996","html_url":"https://github.com/apache/couchdb/issues/3948#issuecomment-1069187996","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3948","id":1069187996,"node_id":"IC_kwDOAAMmUc4_uoOc","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-16T14:25:37Z","updated_at":"2022-03-16T14:50:29Z","author_association":"CONTRIBUTOR","body":"@tonysun83 yeah, we could mimic the `couch_util:get_value(Key, SortedResults)` => `undefined` for missing entries, but I wonder if we should double-check how we end up in this state.\r\n\r\nI wonder if it's because we got a bunch of `rexi_DOWN` or `rexi_EXIT` and called `skip_message` https://github.com/apache/couchdb/blob/e4b8a4624fc7ae09b4649aac9a8d68226208cd8b/src/fabric/src/fabric_doc_update.erl#L62-L74\r\n\r\nIn general for `undefined`, we should probably emit a `missing_response` or `internal_server_error`. It's interesting what our guarantees are with respect to what return code we emit then, should it be a 201/202 even if we didn't get any results for some docs...","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1069187996/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1069552348","html_url":"https://github.com/apache/couchdb/issues/3948#issuecomment-1069552348","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3948","id":1069552348,"node_id":"IC_kwDOAAMmUc4_wBLc","user":{"login":"tonysun83","id":6991573,"node_id":"MDQ6VXNlcjY5OTE1NzM=","avatar_url":"https://avatars.githubusercontent.com/u/6991573?v=4","gravatar_id":"","url":"https://api.github.com/users/tonysun83","html_url":"https://github.com/tonysun83","followers_url":"https://api.github.com/users/tonysun83/followers","following_url":"https://api.github.com/users/tonysun83/following{/other_user}","gists_url":"https://api.github.com/users/tonysun83/gists{/gist_id}","starred_url":"https://api.github.com/users/tonysun83/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tonysun83/subscriptions","organizations_url":"https://api.github.com/users/tonysun83/orgs","repos_url":"https://api.github.com/users/tonysun83/repos","events_url":"https://api.github.com/users/tonysun83/events{/privacy}","received_events_url":"https://api.github.com/users/tonysun83/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-16T19:50:00Z","updated_at":"2022-03-16T19:50:00Z","author_association":"CONTRIBUTOR","body":"@nickva I will investigate further. It's another one of those \"it's been like this for a while, but how should it really behave\" situations. And also, \"if we change it drastically, will it break existing behavior.\"","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1069552348/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1069638499","html_url":"https://github.com/apache/couchdb/issues/3581#issuecomment-1069638499","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3581","id":1069638499,"node_id":"IC_kwDOAAMmUc4_wWNj","user":{"login":"bdoyle0182","id":11879547,"node_id":"MDQ6VXNlcjExODc5NTQ3","avatar_url":"https://avatars.githubusercontent.com/u/11879547?v=4","gravatar_id":"","url":"https://api.github.com/users/bdoyle0182","html_url":"https://github.com/bdoyle0182","followers_url":"https://api.github.com/users/bdoyle0182/followers","following_url":"https://api.github.com/users/bdoyle0182/following{/other_user}","gists_url":"https://api.github.com/users/bdoyle0182/gists{/gist_id}","starred_url":"https://api.github.com/users/bdoyle0182/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bdoyle0182/subscriptions","organizations_url":"https://api.github.com/users/bdoyle0182/orgs","repos_url":"https://api.github.com/users/bdoyle0182/repos","events_url":"https://api.github.com/users/bdoyle0182/events{/privacy}","received_events_url":"https://api.github.com/users/bdoyle0182/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-16T21:13:14Z","updated_at":"2022-03-16T21:13:14Z","author_association":"NONE","body":"@MrOats does that config work now? I filed an issue awhile back where I couldn't get the couchdb server to start when trying to set that config option. It was on couchdb 3.1.1 at that time and tried multiple erlang versions\r\n\r\nhttps://github.com/apache/couchdb/issues/3324","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1069638499/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1070338086","html_url":"https://github.com/apache/couchdb/issues/3956#issuecomment-1070338086","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3956","id":1070338086,"node_id":"IC_kwDOAAMmUc4_zBAm","user":{"login":"guanfeix","id":34960209,"node_id":"MDQ6VXNlcjM0OTYwMjA5","avatar_url":"https://avatars.githubusercontent.com/u/34960209?v=4","gravatar_id":"","url":"https://api.github.com/users/guanfeix","html_url":"https://github.com/guanfeix","followers_url":"https://api.github.com/users/guanfeix/followers","following_url":"https://api.github.com/users/guanfeix/following{/other_user}","gists_url":"https://api.github.com/users/guanfeix/gists{/gist_id}","starred_url":"https://api.github.com/users/guanfeix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guanfeix/subscriptions","organizations_url":"https://api.github.com/users/guanfeix/orgs","repos_url":"https://api.github.com/users/guanfeix/repos","events_url":"https://api.github.com/users/guanfeix/events{/privacy}","received_events_url":"https://api.github.com/users/guanfeix/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-17T05:21:57Z","updated_at":"2022-03-17T05:40:05Z","author_association":"NONE","body":"> It looks like the compactor is failing to compact the database. It's hard to say immediately why, but behaves as if the documents appeared in the sequence index but then miss from the main doc id index.\r\n> \r\n> Perhaps try to stop any updates to the database, stop replications, and try to compact again manually. Otherwise investigate if the perhaps there is a failing disk.\r\n> \r\n> As this is 1.6, try to upgrade to latest 1.7. Then, try to replicate that db to a new copy. But, seeing as we have these missing document bodies that appear in the changes feed that might fail as well.\r\n\r\n\r\nYour means latest 1.7 refer to which version.where can i get it.\r\nI try the 1.7.1 copy the failed database from 1.6.1,still failed  to compact.The view compaction is ok.Where can I find the old version of couchdb. such as deb package for ubuntu 14.0.4.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1070338086/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1070362364","html_url":"https://github.com/apache/couchdb/issues/3956#issuecomment-1070362364","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3956","id":1070362364,"node_id":"IC_kwDOAAMmUc4_zG78","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-17T06:14:02Z","updated_at":"2022-03-17T06:14:02Z","author_association":"CONTRIBUTOR","body":"Thanks for trying on 1.7. One last possible thing to try could be to replicate the database to a new database. If that fails as well, and there is a good chance it might, you can try doing an _all_docs query with include_docs=true and copy those documents manually to a new database (with a script).\r\n\r\nSince Ubuntu https://help.ubuntu.com/community/EOL#Ubuntu_14.04_Trusty_Tahr end of life was 3 years ago we don't support it any longer.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1070362364/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1072040821","html_url":"https://github.com/apache/couchdb/issues/3956#issuecomment-1072040821","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3956","id":1072040821,"node_id":"IC_kwDOAAMmUc4_5gt1","user":{"login":"guanfeix","id":34960209,"node_id":"MDQ6VXNlcjM0OTYwMjA5","avatar_url":"https://avatars.githubusercontent.com/u/34960209?v=4","gravatar_id":"","url":"https://api.github.com/users/guanfeix","html_url":"https://github.com/guanfeix","followers_url":"https://api.github.com/users/guanfeix/followers","following_url":"https://api.github.com/users/guanfeix/following{/other_user}","gists_url":"https://api.github.com/users/guanfeix/gists{/gist_id}","starred_url":"https://api.github.com/users/guanfeix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guanfeix/subscriptions","organizations_url":"https://api.github.com/users/guanfeix/orgs","repos_url":"https://api.github.com/users/guanfeix/repos","events_url":"https://api.github.com/users/guanfeix/events{/privacy}","received_events_url":"https://api.github.com/users/guanfeix/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-18T05:15:45Z","updated_at":"2022-03-18T05:16:51Z","author_association":"NONE","body":"> Thanks for trying on 1.7. One last possible thing to try could be to replicate the database to a new database. If that fails as well, and there is a good chance it might, you can try doing an _all_docs query with include_docs=true and copy those documents manually to a new database (with a script).\r\n> \r\n> Since Ubuntu https://help.ubuntu.com/community/EOL#Ubuntu_14.04_Trusty_Tahr end of life was 3 years ago we don't support it any longer.\r\n\r\n\r\nReplicate the couchdb is ok, this problem can be solved by that.But we still  want to how to aviod this problem because it happened in client. I hope some peole can help me of question belowed for this problem.\r\n\r\n1. If we didn't to process this database.If this will increase continuously to take up the rest available space of its filesystem.\r\n2. Why does this problem happen,only 40 documents to take so much disk space,is there any problem of our way to use CouchDB\r\n3. In the last I want to know if 1.7.1 contains commit of this issue  https://github.com/apache/couchdb/issues/1001. May be the same question for this problem\r\n4. If 1.7.1 didn't contains such commit, I will try to install from source code, which will be my best choice of 1.7 latest.No matter it from github or official website.\r\n\r\n![图片](https://user-images.githubusercontent.com/34960209/158782808-394c8eb2-b152-44c2-8c95-446f24aff6ca.png)\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1072040821/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1072481120","html_url":"https://github.com/apache/couchdb/issues/3948#issuecomment-1072481120","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3948","id":1072481120,"node_id":"IC_kwDOAAMmUc4_7MNg","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-18T14:46:20Z","updated_at":"2022-03-18T14:46:20Z","author_association":"CONTRIBUTOR","body":"I used this script to insert a bunch of ddocs with VDUs at the same time: https://gist.github.com/nickva/bde7d3cfa8c9df0dd18700c661fec4ab\r\n\r\nThe VDU isn't as critical and it looks like I didn't even trigger the `throw{forbidden:..})` as things were failing before then.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1072481120/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1072616685","html_url":"https://github.com/apache/couchdb/pull/3961#issuecomment-1072616685","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3961","id":1072616685,"node_id":"IC_kwDOAAMmUc4_7tTt","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-18T17:12:33Z","updated_at":"2022-03-18T17:12:33Z","author_association":"CONTRIBUTOR","body":"Thank you for your contribution, @kianmeng!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1072616685/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1073250002","html_url":"https://github.com/apache/couchdb/pull/3961#issuecomment-1073250002","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3961","id":1073250002,"node_id":"IC_kwDOAAMmUc4_-H7S","user":{"login":"kianmeng","id":134518,"node_id":"MDQ6VXNlcjEzNDUxOA==","avatar_url":"https://avatars.githubusercontent.com/u/134518?v=4","gravatar_id":"","url":"https://api.github.com/users/kianmeng","html_url":"https://github.com/kianmeng","followers_url":"https://api.github.com/users/kianmeng/followers","following_url":"https://api.github.com/users/kianmeng/following{/other_user}","gists_url":"https://api.github.com/users/kianmeng/gists{/gist_id}","starred_url":"https://api.github.com/users/kianmeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kianmeng/subscriptions","organizations_url":"https://api.github.com/users/kianmeng/orgs","repos_url":"https://api.github.com/users/kianmeng/repos","events_url":"https://api.github.com/users/kianmeng/events{/privacy}","received_events_url":"https://api.github.com/users/kianmeng/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-20T13:17:01Z","updated_at":"2022-03-20T13:17:01Z","author_association":"CONTRIBUTOR","body":":partying_face: :partying_face: :partying_face: :partying_face: :partying_face:","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1073250002/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1073997078","html_url":"https://github.com/apache/couchdb/issues/1753#issuecomment-1073997078","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1753","id":1073997078,"node_id":"IC_kwDOAAMmUc5AA-UW","user":{"login":"roelarents","id":2691308,"node_id":"MDQ6VXNlcjI2OTEzMDg=","avatar_url":"https://avatars.githubusercontent.com/u/2691308?v=4","gravatar_id":"","url":"https://api.github.com/users/roelarents","html_url":"https://github.com/roelarents","followers_url":"https://api.github.com/users/roelarents/followers","following_url":"https://api.github.com/users/roelarents/following{/other_user}","gists_url":"https://api.github.com/users/roelarents/gists{/gist_id}","starred_url":"https://api.github.com/users/roelarents/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roelarents/subscriptions","organizations_url":"https://api.github.com/users/roelarents/orgs","repos_url":"https://api.github.com/users/roelarents/repos","events_url":"https://api.github.com/users/roelarents/events{/privacy}","received_events_url":"https://api.github.com/users/roelarents/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-21T14:52:11Z","updated_at":"2022-03-21T14:52:11Z","author_association":"NONE","body":"The `_default` option is under `compactions` [in the (2.3.1) docs](https://docs.couchdb.org/en/2.3.1/config/compaction.html#compactions). So i think it should be `[compactions] _default` instead of `[compaction_daemon] _default`. Which would make sense. No schedules to run means: run never.\r\n\r\nIt seems to work for me so far. (Unless there is maybe a hidden default and it will start around midnight again or something, I haven't waited that long yet.) I also tried putting `[]` instead of an empty string by the way, which started a compaction immediately after restart.\r\n\r\nMy/our use case was that I don't want an automatic compaction to start (for a while), because it seemed to slow down a running replication (230 GiB DB with 46,000,000 docs).\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1073997078/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1074214047","html_url":"https://github.com/apache/couchdb/pull/3963#issuecomment-1074214047","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3963","id":1074214047,"node_id":"IC_kwDOAAMmUc5ABzSf","user":{"login":"davisp","id":19929,"node_id":"MDQ6VXNlcjE5OTI5","avatar_url":"https://avatars.githubusercontent.com/u/19929?v=4","gravatar_id":"","url":"https://api.github.com/users/davisp","html_url":"https://github.com/davisp","followers_url":"https://api.github.com/users/davisp/followers","following_url":"https://api.github.com/users/davisp/following{/other_user}","gists_url":"https://api.github.com/users/davisp/gists{/gist_id}","starred_url":"https://api.github.com/users/davisp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisp/subscriptions","organizations_url":"https://api.github.com/users/davisp/orgs","repos_url":"https://api.github.com/users/davisp/repos","events_url":"https://api.github.com/users/davisp/events{/privacy}","received_events_url":"https://api.github.com/users/davisp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-21T17:37:58Z","updated_at":"2022-03-21T17:37:58Z","author_association":"MEMBER","body":"I'd also note that this improves performance across the board. Using maps on 20 and 21 also improves against current baseline.\r\n\r\n+1","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1074214047/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1074714240","html_url":"https://github.com/apache/couchdb/pull/3964#issuecomment-1074714240","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3964","id":1074714240,"node_id":"IC_kwDOAAMmUc5ADtaA","user":{"login":"noahshaw11","id":47468872,"node_id":"MDQ6VXNlcjQ3NDY4ODcy","avatar_url":"https://avatars.githubusercontent.com/u/47468872?v=4","gravatar_id":"","url":"https://api.github.com/users/noahshaw11","html_url":"https://github.com/noahshaw11","followers_url":"https://api.github.com/users/noahshaw11/followers","following_url":"https://api.github.com/users/noahshaw11/following{/other_user}","gists_url":"https://api.github.com/users/noahshaw11/gists{/gist_id}","starred_url":"https://api.github.com/users/noahshaw11/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noahshaw11/subscriptions","organizations_url":"https://api.github.com/users/noahshaw11/orgs","repos_url":"https://api.github.com/users/noahshaw11/repos","events_url":"https://api.github.com/users/noahshaw11/events{/privacy}","received_events_url":"https://api.github.com/users/noahshaw11/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-22T04:29:40Z","updated_at":"2022-03-22T05:07:15Z","author_association":"CONTRIBUTOR","body":"If we do not plan on implementing any behavior if an `all_dbs_active` error is encountered, then maybe just wrapping https://github.com/apache/couchdb/blob/3.x/src/couch/src/couch_server.erl#L126 in a `throw/1` would suffice for the errors found by Dialyzer because of the catch found at https://github.com/apache/couchdb/blob/3.x/src/couch/src/couch_server.erl#L102-L104. This is because all of these errors stem from calls to `couch_db:open_int/2`.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1074714240/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1074725480","html_url":"https://github.com/apache/couchdb/pull/3964#issuecomment-1074725480","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3964","id":1074725480,"node_id":"IC_kwDOAAMmUc5ADwJo","user":{"login":"noahshaw11","id":47468872,"node_id":"MDQ6VXNlcjQ3NDY4ODcy","avatar_url":"https://avatars.githubusercontent.com/u/47468872?v=4","gravatar_id":"","url":"https://api.github.com/users/noahshaw11","html_url":"https://github.com/noahshaw11","followers_url":"https://api.github.com/users/noahshaw11/followers","following_url":"https://api.github.com/users/noahshaw11/following{/other_user}","gists_url":"https://api.github.com/users/noahshaw11/gists{/gist_id}","starred_url":"https://api.github.com/users/noahshaw11/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noahshaw11/subscriptions","organizations_url":"https://api.github.com/users/noahshaw11/orgs","repos_url":"https://api.github.com/users/noahshaw11/repos","events_url":"https://api.github.com/users/noahshaw11/events{/privacy}","received_events_url":"https://api.github.com/users/noahshaw11/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-22T04:54:12Z","updated_at":"2022-04-04T18:52:22Z","author_association":"CONTRIBUTOR","body":"Listed below are the errors found by Dialyzer via adding the following spec:\r\n```\r\ndiff --git a/src/couch/src/couch_server.erl b/src/couch/src/couch_server.erl\r\nindex 3c72e3357..72bd51375 100644\r\n--- a/src/couch/src/couch_server.erl\r\n+++ b/src/couch/src/couch_server.erl\r\n@@ -90,6 +90,9 @@ get_spidermonkey_version() -> list_to_binary(?COUCHDB_SPIDERMONKEY_VERSION).\r\n sup_start_link(N) ->\r\n     gen_server:start_link({local, couch_server(N)}, couch_server, [N], []).\r\n \r\n+-spec open(any(), [any()]) ->\r\n+    {ok, any()} |\r\n+    {error, all_dbs_active}.\r\n open(DbName, Options) ->\r\n     try\r\n         validate_open_or_create(DbName, Options),\r\n```\r\nList of errors left to handle:\r\n```\r\nsrc/cpse_test_open_close_delete.erl:0: in cpse_test_open_close_delete:cpse_open_non_existent/1[32-38]:Guard test \r\n          {'error', 'all_dbs_active'} | {'ok', _} =:= \r\n          __X :: {'not_found', 'no_db_file'} can never succeed\r\n\r\nsrc/cpse_test_open_close_delete.erl:0: in cpse_test_open_close_delete:cpse_open_create/1[39-45]:Guard test \r\n          {'error', 'all_dbs_active'} | {'ok', _} =:= \r\n          __X :: {'not_found', 'no_db_file'} can never succeed\r\n\r\nsrc/cpse_test_open_close_delete.erl:0: in cpse_test_open_close_delete:cpse_open_when_exists/1[46-52]:Guard test \r\n          {'error', 'all_dbs_active'} | {'ok', _} =:= \r\n          __X :: {'not_found', 'no_db_file'} can never succeed\r\n\r\nsrc/cpse_test_open_close_delete.erl:0: in cpse_test_open_close_delete:cpse_terminate/1[53-59]:Guard test \r\n          {'error', 'all_dbs_active'} | {'ok', _} =:= \r\n          __X :: {'not_found', 'no_db_file'} can never succeed\r\n\r\nsrc/hastings_rpc.erl:0: in hastings_rpc:get_or_create_db/2[111-120]:The pattern \r\n          {'not_found', 'no_db_file'} can never match the type \r\n          {'error', 'all_dbs_active'} | {'ok', _}\r\n ```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1074725480/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1074745866","html_url":"https://github.com/apache/couchdb/issues/3966#issuecomment-1074745866","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3966","id":1074745866,"node_id":"IC_kwDOAAMmUc5AD1IK","user":{"login":"zamb3zi","id":11073466,"node_id":"MDQ6VXNlcjExMDczNDY2","avatar_url":"https://avatars.githubusercontent.com/u/11073466?v=4","gravatar_id":"","url":"https://api.github.com/users/zamb3zi","html_url":"https://github.com/zamb3zi","followers_url":"https://api.github.com/users/zamb3zi/followers","following_url":"https://api.github.com/users/zamb3zi/following{/other_user}","gists_url":"https://api.github.com/users/zamb3zi/gists{/gist_id}","starred_url":"https://api.github.com/users/zamb3zi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zamb3zi/subscriptions","organizations_url":"https://api.github.com/users/zamb3zi/orgs","repos_url":"https://api.github.com/users/zamb3zi/repos","events_url":"https://api.github.com/users/zamb3zi/events{/privacy}","received_events_url":"https://api.github.com/users/zamb3zi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-22T05:36:31Z","updated_at":"2022-03-22T05:36:31Z","author_association":"NONE","body":"I'm having the same issue on Debian Buster:\r\n```\r\n#  apt update\r\nHit:1 http://security.debian.org/debian-security buster/updates InRelease\r\nHit:2 http://cdn-fastly.deb.debian.org/debian buster InRelease\r\nErr:3 https://apache.jfrog.io/artifactory/couchdb-deb buster InRelease\r\n  403  Forbidden [IP: 13.32.80.86 443]\r\nReading package lists... Done\r\nE: Failed to fetch https://apache.jfrog.io/artifactory/couchdb-deb/dists/buster/InRelease  403  Forbidden [IP: 13.32.80.86 443]\r\nE: The repository 'https://apache.jfrog.io/artifactory/couchdb-deb buster InRelease' is no longer signed.\r\nN: Updating from such a repository can't be done securely, and is therefore disabled by default.\r\nN: See apt-secure(8) manpage for repository creation and user configuration details.\r\n```\r\n\r\nand Debian Stretch:\r\n```\r\n# apt update\r\nHit:1 http://security.debian.org/debian-security stretch/updates InRelease\r\nIgn:2 http://cdn-fastly.deb.debian.org/debian stretch InRelease\r\nHit:4 https://deb.nodesource.com/node_8.x stretch InRelease\r\nHit:3 http://cdn-fastly.deb.debian.org/debian stretch Release\r\nIgn:6 https://apache.jfrog.io/artifactory/couchdb-deb stretch InRelease\r\nErr:7 https://apache.jfrog.io/artifactory/couchdb-deb stretch Release\r\n  403  Forbidden\r\nReading package lists... Done\r\nE: The repository 'https://apache.jfrog.io/artifactory/couchdb-deb stretch Release' does not have a Release file.\r\nN: Updating from such a repository can't be done securely, and is therefore disabled by default.\r\nN: See apt-secure(8) manpage for repository creation and user configuration details.\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1074745866/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075399499","html_url":"https://github.com/apache/couchdb/pull/3967#issuecomment-1075399499","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3967","id":1075399499,"node_id":"IC_kwDOAAMmUc5AGUtL","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-22T17:04:13Z","updated_at":"2022-03-22T17:04:13Z","author_association":"MEMBER","body":"you can also check 'Code is written and works correctly' at least ;)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075399499/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075404369","html_url":"https://github.com/apache/couchdb/pull/3967#issuecomment-1075404369","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3967","id":1075404369,"node_id":"IC_kwDOAAMmUc5AGV5R","user":{"login":"noahshaw11","id":47468872,"node_id":"MDQ6VXNlcjQ3NDY4ODcy","avatar_url":"https://avatars.githubusercontent.com/u/47468872?v=4","gravatar_id":"","url":"https://api.github.com/users/noahshaw11","html_url":"https://github.com/noahshaw11","followers_url":"https://api.github.com/users/noahshaw11/followers","following_url":"https://api.github.com/users/noahshaw11/following{/other_user}","gists_url":"https://api.github.com/users/noahshaw11/gists{/gist_id}","starred_url":"https://api.github.com/users/noahshaw11/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noahshaw11/subscriptions","organizations_url":"https://api.github.com/users/noahshaw11/orgs","repos_url":"https://api.github.com/users/noahshaw11/repos","events_url":"https://api.github.com/users/noahshaw11/events{/privacy}","received_events_url":"https://api.github.com/users/noahshaw11/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-22T17:09:13Z","updated_at":"2022-03-22T17:09:13Z","author_association":"CONTRIBUTOR","body":"Thank you for the review @rnewson!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075404369/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075420986","html_url":"https://github.com/apache/couchdb/pull/3965#issuecomment-1075420986","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3965","id":1075420986,"node_id":"IC_kwDOAAMmUc5AGZ86","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-22T17:27:03Z","updated_at":"2022-03-22T17:27:03Z","author_association":"CONTRIBUTOR","body":"Closing in favor of https://github.com/apache/couchdb/pull/3967","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075420986/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075723247","html_url":"https://github.com/apache/couchdb/pull/3963#issuecomment-1075723247","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3963","id":1075723247,"node_id":"IC_kwDOAAMmUc5AHjvv","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-22T22:42:16Z","updated_at":"2022-03-22T22:42:16Z","author_association":"CONTRIBUTOR","body":"Trying the optimization with a production revision tree with 6638 live conflicts.\r\n\r\n```\r\nlength(couch_key_tree:get_all_leafs(Tree)).\r\n6638\r\n```\r\n\r\nMeasured time to run `couch_key_tree:stem(Tree, 1000)`\r\n\r\n### Before this commit\r\n\r\n\r\n| Erlang Version  |  Time (sec) | Memory (GBs) |\r\n|----------------|-------|---------|\r\n| 20 | 221 | 1.2 |\r\n| 23 | 1382 | 45 |\r\n\r\n### After this commit\r\n\r\n| Erlang Version  |  Time (sec) | Memory (GBs) |\r\n|----------------|-------|---------|\r\n| 20 | 3 | 1.2 |\r\n| 23 | 3 | 1.3 |\r\n\r\nIn summary, on Erlang 23, we got a nice **460x** speedup and **34x** memory usage reduction","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075723247/reactions","total_count":3,"+1":0,"-1":0,"laugh":1,"hooray":1,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075780051","html_url":"https://github.com/apache/couchdb/issues/3966#issuecomment-1075780051","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3966","id":1075780051,"node_id":"IC_kwDOAAMmUc5AHxnT","user":{"login":"ncraike","id":1109269,"node_id":"MDQ6VXNlcjExMDkyNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1109269?v=4","gravatar_id":"","url":"https://api.github.com/users/ncraike","html_url":"https://github.com/ncraike","followers_url":"https://api.github.com/users/ncraike/followers","following_url":"https://api.github.com/users/ncraike/following{/other_user}","gists_url":"https://api.github.com/users/ncraike/gists{/gist_id}","starred_url":"https://api.github.com/users/ncraike/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncraike/subscriptions","organizations_url":"https://api.github.com/users/ncraike/orgs","repos_url":"https://api.github.com/users/ncraike/repos","events_url":"https://api.github.com/users/ncraike/events{/privacy}","received_events_url":"https://api.github.com/users/ncraike/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T00:25:37Z","updated_at":"2022-03-23T00:25:37Z","author_association":"NONE","body":"This _seems_ to be resolved now, and it's possible again to install from the package repository on CentOS.\r\n\r\n @zamb3zi I'm not sure if the Debian package repository is still having issues?\r\n\r\nIf possible, it would be good to know the underlying issue and if it's likely to happen again.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075780051/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075830926","html_url":"https://github.com/apache/couchdb/pull/3963#issuecomment-1075830926","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3963","id":1075830926,"node_id":"IC_kwDOAAMmUc5AH-CO","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T02:04:12Z","updated_at":"2022-03-23T02:04:12Z","author_association":"MEMBER","body":"Now you're just showing off 😉 Nice work!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075830926/reactions","total_count":2,"+1":0,"-1":0,"laugh":2,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075877870","html_url":"https://github.com/apache/couchdb/issues/3966#issuecomment-1075877870","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3966","id":1075877870,"node_id":"IC_kwDOAAMmUc5AIJfu","user":{"login":"zamb3zi","id":11073466,"node_id":"MDQ6VXNlcjExMDczNDY2","avatar_url":"https://avatars.githubusercontent.com/u/11073466?v=4","gravatar_id":"","url":"https://api.github.com/users/zamb3zi","html_url":"https://github.com/zamb3zi","followers_url":"https://api.github.com/users/zamb3zi/followers","following_url":"https://api.github.com/users/zamb3zi/following{/other_user}","gists_url":"https://api.github.com/users/zamb3zi/gists{/gist_id}","starred_url":"https://api.github.com/users/zamb3zi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zamb3zi/subscriptions","organizations_url":"https://api.github.com/users/zamb3zi/orgs","repos_url":"https://api.github.com/users/zamb3zi/repos","events_url":"https://api.github.com/users/zamb3zi/events{/privacy}","received_events_url":"https://api.github.com/users/zamb3zi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T03:30:17Z","updated_at":"2022-03-23T03:30:17Z","author_association":"NONE","body":"@ncraike looks good to me now. Working in both debian stretch and buster.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075877870/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075994497","html_url":"https://github.com/apache/couchdb/issues/3966#issuecomment-1075994497","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3966","id":1075994497,"node_id":"IC_kwDOAAMmUc5AIl-B","user":{"login":"handerpeder","id":97645,"node_id":"MDQ6VXNlcjk3NjQ1","avatar_url":"https://avatars.githubusercontent.com/u/97645?v=4","gravatar_id":"","url":"https://api.github.com/users/handerpeder","html_url":"https://github.com/handerpeder","followers_url":"https://api.github.com/users/handerpeder/followers","following_url":"https://api.github.com/users/handerpeder/following{/other_user}","gists_url":"https://api.github.com/users/handerpeder/gists{/gist_id}","starred_url":"https://api.github.com/users/handerpeder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/handerpeder/subscriptions","organizations_url":"https://api.github.com/users/handerpeder/orgs","repos_url":"https://api.github.com/users/handerpeder/repos","events_url":"https://api.github.com/users/handerpeder/events{/privacy}","received_events_url":"https://api.github.com/users/handerpeder/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T07:03:38Z","updated_at":"2022-03-23T07:03:38Z","author_association":"NONE","body":"Not resolved on ubuntu 21.10\r\n\r\n```sh\r\n$ sudo apt update\r\n...\r\nIgn:6 https://apache.jfrog.io/artifactory/couchdb-deb impish InRelease\r\nGet:7 http://us.archive.ubuntu.com/ubuntu impish-security InRelease [110 kB]\r\nErr:8 https://apache.jfrog.io/artifactory/couchdb-deb impish Release\r\n  404   [IP: 34.210.158.172 443]\r\nReading package lists... Done\r\nE: The repository 'https://apache.jfrog.io/artifactory/couchdb-deb impish Release' does not have a Release file.\r\nN: Updating from such a repository can't be done securely, and is therefore disabled by default.\r\nN: See apt-secure(8) manpage for repository creation and user configuration details.\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1075994497/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076456652","html_url":"https://github.com/apache/couchdb/issues/3966#issuecomment-1076456652","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3966","id":1076456652,"node_id":"IC_kwDOAAMmUc5AKWzM","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T14:42:21Z","updated_at":"2022-03-23T14:42:21Z","author_association":"CONTRIBUTOR","body":"@handerpeder It's a different issue. We don't support `impish` Ubuntu 21.10. Try using the Ubuntu 20.04 package\r\n\r\nhttps://apache.jfrog.io/ui/native/couchdb-deb/dists/","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076456652/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076458213","html_url":"https://github.com/apache/couchdb/issues/3966#issuecomment-1076458213","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3966","id":1076458213,"node_id":"IC_kwDOAAMmUc5AKXLl","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T14:44:11Z","updated_at":"2022-03-23T14:44:11Z","author_association":"CONTRIBUTOR","body":"I verified CentOS 7 and Debian 10. After the JFrog artifactory probably was updated or had some maintenance done and was unavailable for a bit. Now it seems to be back up. Closing the issue. Thanks for reaching out, everyone!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076458213/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076460204","html_url":"https://github.com/apache/couchdb/issues/3959#issuecomment-1076460204","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3959","id":1076460204,"node_id":"IC_kwDOAAMmUc5AKXqs","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T14:46:36Z","updated_at":"2022-03-23T14:46:36Z","author_association":"CONTRIBUTOR","body":"@ronag I think the _revisions field provided might not be valid CouchDB revisions such as: `NIE8HiDHRKbFD3-_asset` (just an initial guess).\r\n\r\nWould the logs from CouchDB be available?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076460204/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076461705","html_url":"https://github.com/apache/couchdb/issues/3959#issuecomment-1076461705","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3959","id":1076461705,"node_id":"IC_kwDOAAMmUc5AKYCJ","user":{"login":"ronag","id":3065230,"node_id":"MDQ6VXNlcjMwNjUyMzA=","avatar_url":"https://avatars.githubusercontent.com/u/3065230?v=4","gravatar_id":"","url":"https://api.github.com/users/ronag","html_url":"https://github.com/ronag","followers_url":"https://api.github.com/users/ronag/followers","following_url":"https://api.github.com/users/ronag/following{/other_user}","gists_url":"https://api.github.com/users/ronag/gists{/gist_id}","starred_url":"https://api.github.com/users/ronag/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ronag/subscriptions","organizations_url":"https://api.github.com/users/ronag/orgs","repos_url":"https://api.github.com/users/ronag/repos","events_url":"https://api.github.com/users/ronag/events{/privacy}","received_events_url":"https://api.github.com/users/ronag/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T14:48:26Z","updated_at":"2022-03-23T14:48:26Z","author_association":"NONE","body":"It seems related to heavy/extreme load. Everything works fine usually but when on heavy load we get various kind of \"unknown\" internal server errors.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076461705/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076462080","html_url":"https://github.com/apache/couchdb/issues/3959#issuecomment-1076462080","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3959","id":1076462080,"node_id":"IC_kwDOAAMmUc5AKYIA","user":{"login":"ronag","id":3065230,"node_id":"MDQ6VXNlcjMwNjUyMzA=","avatar_url":"https://avatars.githubusercontent.com/u/3065230?v=4","gravatar_id":"","url":"https://api.github.com/users/ronag","html_url":"https://github.com/ronag","followers_url":"https://api.github.com/users/ronag/followers","following_url":"https://api.github.com/users/ronag/following{/other_user}","gists_url":"https://api.github.com/users/ronag/gists{/gist_id}","starred_url":"https://api.github.com/users/ronag/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ronag/subscriptions","organizations_url":"https://api.github.com/users/ronag/orgs","repos_url":"https://api.github.com/users/ronag/repos","events_url":"https://api.github.com/users/ronag/events{/privacy}","received_events_url":"https://api.github.com/users/ronag/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T14:48:57Z","updated_at":"2022-03-23T14:48:57Z","author_association":"NONE","body":"I don't have more info on this atm as the logs have rotated since then.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076462080/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076462919","html_url":"https://github.com/apache/couchdb/issues/3959#issuecomment-1076462919","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3959","id":1076462919,"node_id":"IC_kwDOAAMmUc5AKYVH","user":{"login":"ronag","id":3065230,"node_id":"MDQ6VXNlcjMwNjUyMzA=","avatar_url":"https://avatars.githubusercontent.com/u/3065230?v=4","gravatar_id":"","url":"https://api.github.com/users/ronag","html_url":"https://github.com/ronag","followers_url":"https://api.github.com/users/ronag/followers","following_url":"https://api.github.com/users/ronag/following{/other_user}","gists_url":"https://api.github.com/users/ronag/gists{/gist_id}","starred_url":"https://api.github.com/users/ronag/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ronag/subscriptions","organizations_url":"https://api.github.com/users/ronag/orgs","repos_url":"https://api.github.com/users/ronag/repos","events_url":"https://api.github.com/users/ronag/events{/privacy}","received_events_url":"https://api.github.com/users/ronag/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T14:49:56Z","updated_at":"2022-03-23T14:49:56Z","author_association":"NONE","body":">  I think the _revisions field provided might not be valid CouchDB revisions such\r\n\r\nThey work and should work. I believe it was discussed in couch 4 to deprecate the possibility of custom revisions. If I retry the exact same request now everything works fine.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076462919/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076463752","html_url":"https://github.com/apache/couchdb/issues/3958#issuecomment-1076463752","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3958","id":1076463752,"node_id":"IC_kwDOAAMmUc5AKYiI","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T14:51:41Z","updated_at":"2022-03-23T14:51:41Z","author_association":"CONTRIBUTOR","body":"@digimbyte thanks for your report. Is it easy to reproduce. Something like: make sure it's running, then kill its main process and when it restarts this happens?\r\n\r\nThe `resetting the admin password.` part stood out a bit. Did that involve a manual restart?\r\n\r\nCheck and see what is running or bound to that port when the error happens. That is to see if it's a permissions issue (like a firewall rule) or because something else is bound to it. Could it be that the old instance is still running and bound to it or another CouchDB instance (in a container environment)?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076463752/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076489068","html_url":"https://github.com/apache/couchdb/issues/3959#issuecomment-1076489068","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3959","id":1076489068,"node_id":"IC_kwDOAAMmUc5AKets","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T15:27:50Z","updated_at":"2022-03-23T15:27:50Z","author_association":"CONTRIBUTOR","body":"@ronag that makes sense. In that case keep an eye out for a stacktrace in the couchdb logs. If it happens again see if you look for the `\"x-couch-stack-hash\": \"27933023\"` value (`27933023` in that case) in the logs. That ID should help pin-point the stack trace associated with that request.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076489068/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076492696","html_url":"https://github.com/apache/couchdb/issues/3959#issuecomment-1076492696","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3959","id":1076492696,"node_id":"IC_kwDOAAMmUc5AKfmY","user":{"login":"ronag","id":3065230,"node_id":"MDQ6VXNlcjMwNjUyMzA=","avatar_url":"https://avatars.githubusercontent.com/u/3065230?v=4","gravatar_id":"","url":"https://api.github.com/users/ronag","html_url":"https://github.com/ronag","followers_url":"https://api.github.com/users/ronag/followers","following_url":"https://api.github.com/users/ronag/following{/other_user}","gists_url":"https://api.github.com/users/ronag/gists{/gist_id}","starred_url":"https://api.github.com/users/ronag/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ronag/subscriptions","organizations_url":"https://api.github.com/users/ronag/orgs","repos_url":"https://api.github.com/users/ronag/repos","events_url":"https://api.github.com/users/ronag/events{/privacy}","received_events_url":"https://api.github.com/users/ronag/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-23T15:33:23Z","updated_at":"2022-03-23T15:33:23Z","author_association":"NONE","body":"I'll re-open this issue once/if it occurs again and I can grab the stack trace.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1076492696/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1080035366","html_url":"https://github.com/apache/couchdb/pull/3890#issuecomment-1080035366","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3890","id":1080035366,"node_id":"IC_kwDOAAMmUc5AYAgm","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-27T22:47:09Z","updated_at":"2022-03-27T22:47:09Z","author_association":"CONTRIBUTOR","body":"> It would be interesting to see how it could plausibly get into that state. It looks like the entry process exited `normal` and we handled it in `handle_info` at `ddoc_cache_lru:handle_info/2(line:219)`. We [found](https://github.com/apache/couchdb/blob/3.x/src/ddoc_cache/src/ddoc_cache_lru.erl#L215) the Pid in the `Pids` table but the key, which we assumed would be present wasn't there.\r\n> \r\n> It could be a race condition somehow or multiple entries (Pids) point to the same key?\r\n\r\nI had this happen again recently on my dev environment:\r\n```\r\n[error] 2022-03-27T01:25:26.061197Z node1@127.0.0.1 <0.4240.120> -------- gen_server ddoc_cache_lru terminated with reason: no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:299) <= ddoc_cache_lru:handle_info/2(line:217) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226)\r\n  last msg: redacted\r\n     state: {st,#Ref<0.3817933327.115212289.259708>,#Ref<0.3817933327.115212289.259709>,<0.4822.120>}\r\n    extra: []\r\n[error] 2022-03-27T01:25:26.061348Z node1@127.0.0.1 <0.4240.120> -------- gen_server ddoc_cache_lru terminated with reason: no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:299) <= ddoc_cache_lru:handle_info/2(line:217) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226)\r\n  last msg: redacted\r\n     state: {st,#Ref<0.3817933327.115212289.259708>,#Ref<0.3817933327.115212289.259709>,<0.4822.120>}\r\n    extra: []\r\n[error] 2022-03-27T01:25:26.061483Z node1@127.0.0.1 <0.4240.120> -------- CRASH REPORT Process ddoc_cache_lru (<0.4240.120>) with 0 neighbors crashed with reason: no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:299) <= ddoc_cache_lru:handle_info/2(line:217) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226); initial_call: {ddoc_cache_lru,init,['Argument__1']}, ancestors: [ddoc_cache_sup,<0.4627.0>], message_queue_len: 0, links: [<0.4822.120>,<0.4631.0>], dictionary: [], trap_exit: true, status: running, heap_size: 1598, stack_size: 29, reductions: 2103851\r\n[error] 2022-03-27T01:25:26.061611Z node1@127.0.0.1 <0.4240.120> -------- CRASH REPORT Process ddoc_cache_lru (<0.4240.120>) with 0 neighbors crashed with reason: no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:299) <= ddoc_cache_lru:handle_info/2(line:217) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226); initial_call: {ddoc_cache_lru,init,['Argument__1']}, ancestors: [ddoc_cache_sup,<0.4627.0>], message_queue_len: 0, links: [<0.4822.120>,<0.4631.0>], dictionary: [], trap_exit: true, status: running, heap_size: 1598, stack_size: 29, reductions: 2103851\r\n[error] 2022-03-27T01:25:26.061743Z node1@127.0.0.1 <0.4631.0> -------- Supervisor ddoc_cache_sup had child ddoc_cache_lru started with ddoc_cache_lru:start_link() at <0.4240.120> exit with reason no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:299) <= ddoc_cache_lru:handle_info/2(line:217) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226) in context child_terminated\r\n[error] 2022-03-27T01:25:26.061829Z node1@127.0.0.1 <0.4631.0> -------- Supervisor ddoc_cache_sup had child ddoc_cache_lru started with ddoc_cache_lru:start_link() at <0.4240.120> exit with reason no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:299) <= ddoc_cache_lru:handle_info/2(line:217) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226) in context child_terminated\r\n```\r\nwhich was puzzling because I didn't think there was _anything_ using ddocs in that environment. So I patched `ddoc_cache_lru` with the following:\r\n```diff\r\n--- a/src/ddoc_cache/src/ddoc_cache_lru.erl\r\n+++ b/src/ddoc_cache/src/ddoc_cache_lru.erl\r\n@@ -124,6 +124,8 @@ handle_call({start, Key, Default}, _From, St) ->\r\n                     true = ets:update_element(?CACHE, Key, {#entry.pid, Pid}),\r\n                     ok = khash:put(Pids, Pid, Key),\r\n                     store_key(Dbs, Key, Pid),\r\n+                    couch_log:info(\"~p:start Key=~p Pid=~p, Pids=~p Dbs=~p\",\r\n+                        [?MODULE, Key, Pid, Pids, Dbs]),\r\n                     {reply, {ok, Pid}, St};\r\n                 full ->\r\n                     ?EVENT(full, Key),\r\n```\r\nand these showed in my logs at a rate of one per second.\r\n```erlang\r\n[info] 2022-03-27T22:41:11.994176Z node1@127.0.0.1 <0.4636.0> -------- ddoc_cache_lru:start Key={ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}} Pid=<0.26100.17>, Pids=#Ref<0.3262557261.2829713410.69203> Dbs=#Ref<0.3262557261.2829713410.69204>\r\n[info] 2022-03-27T22:41:12.994058Z node1@127.0.0.1 <0.4636.0> -------- ddoc_cache_lru:start Key={ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}} Pid=<0.26085.17>, Pids=#Ref<0.3262557261.2829713410.69203> Dbs=#Ref<0.3262557261.2829713410.69204>\r\n[info] 2022-03-27T22:41:13.994136Z node1@127.0.0.1 <0.4636.0> -------- ddoc_cache_lru:start Key={ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}} Pid=<0.26173.17>, Pids=#Ref<0.3262557261.2829713410.69203> Dbs=#Ref<0.3262557261.2829713410.69204>\r\n[info] 2022-03-27T22:41:14.994415Z node1@127.0.0.1 <0.4636.0> -------- ddoc_cache_lru:start Key={ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}} Pid=<0.26190.17>, Pids=#Ref<0.3262557261.2829713410.69203> Dbs=#Ref<0.3262557261.2829713410.69204>\r\n[info] 2022-03-27T22:41:15.994461Z node1@127.0.0.1 <0.4636.0> -------- ddoc_cache_lru:start Key={ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}} Pid=<0.26157.17>, Pids=#Ref<0.3262557261.2829713410.69203> Dbs=#Ref<0.3262557261.2829713410.69204>\r\n[info] 2022-03-27T22:41:16.994359Z node1@127.0.0.1 <0.4636.0> -------- ddoc_cache_lru:start Key={ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}} Pid=<0.26269.17>, Pids=#Ref<0.3262557261.2829713410.69203> Dbs=#Ref<0.3262557261.2829713410.69204>\r\n```\r\nSo it looks like your second guess that\r\n\r\n> multiple entries (Pids) point to the same key\r\n\r\nis correct, since these apparently all have the same key (of a non-existent ddoc), but are different PIDs.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1080035366/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1081227474","html_url":"https://github.com/apache/couchdb/pull/3890#issuecomment-1081227474","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3890","id":1081227474,"node_id":"IC_kwDOAAMmUc5AcjjS","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-28T22:49:09Z","updated_at":"2022-03-28T22:49:09Z","author_association":"CONTRIBUTOR","body":"@jaydoane interesting find. I stared some more at the code and still couldn't figure how we could end up with a not_found in https://github.com/apache/couchdb/blob/f801d400bd880644e74098070da82b5703ff0477/src/ddoc_cache/src/ddoc_cache_lru.erl#L299\r\n\r\nThe update to the Pids and Dbs khashes happen only in the ddoc_cache_lru `gen_server` https://github.com/apache/couchdb/blob/3.x/src/ddoc_cache/src/ddoc_cache_lru.erl#L122-L126 so I couldn't come up with a sequence of events to end up with them out of sync.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1081227474/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1081381897","html_url":"https://github.com/apache/couchdb/pull/3890#issuecomment-1081381897","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3890","id":1081381897,"node_id":"IC_kwDOAAMmUc5AdJQJ","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-29T04:13:06Z","updated_at":"2022-03-29T04:54:06Z","author_association":"CONTRIBUTOR","body":"I added logging to `ddoc_cache_entry:terminate/1` as well:\r\n```\r\n[info] 2022-03-29T02:54:26.712593Z node1@127.0.0.1 <0.4621.0> -------- ddoc_cache_lru:start Key={ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}} Pid=<0.25927.8>, Pids=#Ref<0.4244486069.2869821445.124970> Dbs=#Ref<0.4244486069.2869821445.124971>\r\n[info] 2022-03-29T02:54:26.713215Z node1@127.0.0.1 <0.25927.8> -------- ddoc_cache_entry:terminate St={st,{ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}},{open_ok,{not_found,missing}},undefined,undefined,undefined,1}\r\n[info] 2022-03-29T02:54:27.148635Z node1@127.0.0.1 <0.4621.0> -------- ddoc_cache_lru:start Key={ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}} Pid=<0.25936.8>, Pids=#Ref<0.4244486069.2869821445.124970> Dbs=#Ref<0.4244486069.2869821445.124971>\r\n[info] 2022-03-29T02:54:27.149547Z node1@127.0.0.1 <0.25936.8> -------- ddoc_cache_entry:terminate St={st,{ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}},{open_ok,{not_found,missing}},undefined,undefined,undefined,1}\r\n[info] 2022-03-29T02:54:27.712771Z node1@127.0.0.1 <0.4621.0> -------- ddoc_cache_lru:start Key={ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}} Pid=<0.26015.8>, Pids=#Ref<0.4244486069.2869821445.124970> Dbs=#Ref<0.4244486069.2869821445.124971>\r\n[info] 2022-03-29T02:54:27.713406Z node1@127.0.0.1 <0.26015.8> -------- ddoc_cache_entry:terminate St={st,{ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}},{open_ok,{not_found,missing}},undefined,undefined,undefined,1}\r\n```\r\nand noticed that there's typically ~1ms between spawn and termination of a ddoc_cache_entry.\r\n\r\nIf I artificially widen that gap by adding a delay in terminate like so:\r\n```diff\r\n--- a/src/ddoc_cache/src/ddoc_cache_entry.erl\r\n+++ b/src/ddoc_cache/src/ddoc_cache_entry.erl\r\n@@ -145,6 +145,8 @@ init({Key, Wrapped}) ->\r\n     gen_server:enter_loop(?MODULE, [], St, hibernate).\r\n \r\n terminate(_Reason, St) ->\r\n+    timer:sleep(1),\r\n+    couch_log:info(\"~p:terminate St=~p\", [?MODULE, St]),\r\n     #st{\r\n         key = Key,\r\n         opener = Pid,\r\n```\r\n\r\nI can reproduce this every time using this in a remsh:\r\n```\r\n(node1@127.0.0.1)8> ddoc_cache:open(<<\"users\">>, <<\"_design/feature_flags\">>), ddoc_cache:open(<<\"users\">>, <<\"_design/feature_flags\">>).\r\n{not_found,missing}\r\n```\r\nwhich does this in the logs:\r\n```\r\n[info] 2022-03-29T04:06:01.698265Z node1@127.0.0.1 <0.14792.12> -------- ddoc_cache_lru:start Key={ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}} Pid=<0.18310.12>, Pids=#Ref<0.4244486069.2877947905.247295> Dbs=#Ref<0.4244486069.2877947905.247296>\r\n[info] 2022-03-29T04:06:01.700248Z node1@127.0.0.1 <0.14792.12> -------- ddoc_cache_lru:start Key={ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}} Pid=<0.18373.12>, Pids=#Ref<0.4244486069.2877947905.247295> Dbs=#Ref<0.4244486069.2877947905.247296>\r\n[info] 2022-03-29T04:06:01.701389Z node1@127.0.0.1 <0.18310.12> -------- ddoc_cache_entry:terminate St={st,{ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}},{open_ok,{not_found,missing}},undefined,undefined,undefined,1}\r\n[info] 2022-03-29T04:06:01.702401Z node1@127.0.0.1 <0.18373.12> -------- ddoc_cache_entry:terminate St={st,{ddoc_cache_entry_ddocid,{<<\"users\">>,<<\"_design/feature_flags\">>}},{open_ok,{not_found,missing}},undefined,undefined,undefined,1}\r\n[error] 2022-03-29T04:06:01.702893Z node1@127.0.0.1 <0.14792.12> -------- gen_server ddoc_cache_lru terminated with reason: no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:301) <= ddoc_cache_lru:handle_info/2(line:219) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226)\r\n  last msg: redacted\r\n     state: {st,#Ref<0.4244486069.2877947905.247295>,#Ref<0.4244486069.2877947905.247296>,<0.14791.12>}\r\n    extra: []\r\n[error] 2022-03-29T04:06:01.703080Z node1@127.0.0.1 <0.14792.12> -------- gen_server ddoc_cache_lru terminated with reason: no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:301) <= ddoc_cache_lru:handle_info/2(line:219) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226)\r\n  last msg: redacted\r\n     state: {st,#Ref<0.4244486069.2877947905.247295>,#Ref<0.4244486069.2877947905.247296>,<0.14791.12>}\r\n    extra: []\r\n[error] 2022-03-29T04:06:01.703257Z node1@127.0.0.1 <0.14792.12> -------- CRASH REPORT Process ddoc_cache_lru (<0.14792.12>) with 0 neighbors crashed with reason: no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:301) <= ddoc_cache_lru:handle_info/2(line:219) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226); initial_call: {ddoc_cache_lru,init,['Argument__1']}, ancestors: [ddoc_cache_sup,<0.4616.0>], message_queue_len: 0, links: [<0.14791.12>,<0.4620.0>], dictionary: [], trap_exit: true, status: running, heap_size: 1598, stack_size: 29, reductions: 4403\r\n[error] 2022-03-29T04:06:01.703434Z node1@127.0.0.1 <0.14792.12> -------- CRASH REPORT Process ddoc_cache_lru (<0.14792.12>) with 0 neighbors crashed with reason: no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:301) <= ddoc_cache_lru:handle_info/2(line:219) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226); initial_call: {ddoc_cache_lru,init,['Argument__1']}, ancestors: [ddoc_cache_sup,<0.4616.0>], message_queue_len: 0, links: [<0.14791.12>,<0.4620.0>], dictionary: [], trap_exit: true, status: running, heap_size: 1598, stack_size: 29, reductions: 4403\r\n[error] 2022-03-29T04:06:01.703588Z node1@127.0.0.1 <0.4620.0> -------- Supervisor ddoc_cache_sup had child ddoc_cache_lru started with ddoc_cache_lru:start_link() at <0.14792.12> exit with reason no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:301) <= ddoc_cache_lru:handle_info/2(line:219) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226) in context child_terminated\r\n[error] 2022-03-29T04:06:01.703695Z node1@127.0.0.1 <0.4620.0> -------- Supervisor ddoc_cache_sup had child ddoc_cache_lru started with ddoc_cache_lru:start_link() at <0.14792.12> exit with reason no match of right hand value not_found at ddoc_cache_lru:remove_key/2(line:301) <= ddoc_cache_lru:handle_info/2(line:219) <= gen_server:try_dispatch/4(line:695) <= gen_server:handle_msg/6(line:771) <= proc_lib:init_p_do_apply/3(line:226) in context child_terminated\r\n```\r\nIn short, any two  `ddoc_cache:open` calls to the same non-existent ddoc that occur close enough in time can cause that error.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1081381897/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1081977312","html_url":"https://github.com/apache/couchdb/issues/3978#issuecomment-1081977312","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3978","id":1081977312,"node_id":"IC_kwDOAAMmUc5Afang","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-29T14:57:28Z","updated_at":"2022-03-29T14:57:28Z","author_association":"CONTRIBUTOR","body":"I think `{error,enospc}` means isufficient space where you are trying to write.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1081977312/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1081991080","html_url":"https://github.com/apache/couchdb/pull/3938#issuecomment-1081991080","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3938","id":1081991080,"node_id":"IC_kwDOAAMmUc5Afd-o","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-29T15:08:00Z","updated_at":"2022-03-29T15:08:00Z","author_association":"CONTRIBUTOR","body":"Given that we may be dropping OTP 20 support \"soon\", what happens when you try a more modern version like [3.18.0](https://github.com/erlang/rebar3/releases/tag/3.18.0) or main? Guessing that won't help with the NIF choke?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1081991080/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1082114229","html_url":"https://github.com/apache/couchdb/pull/3979#issuecomment-1082114229","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3979","id":1082114229,"node_id":"IC_kwDOAAMmUc5Af8C1","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-29T16:44:27Z","updated_at":"2022-03-29T16:44:27Z","author_association":"CONTRIBUTOR","body":"I think, ideally, if we didn't get any response for some document we'd want to return an error (500), regardless if it's greater or smaller than 100. It seems would be a data loss situation if we returned a 201 but never got any response back. \r\n\r\nIf at least some response came, for all docs we can return `accepted` then.\r\n\r\nInstead of `undefined`, perhaps if we'd do a pre-processing of responses and mark the un-returned ones with a better error (`timeout` or `internal_server_error` if it could be anything).\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1082114229/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1082236130","html_url":"https://github.com/apache/couchdb/issues/3975#issuecomment-1082236130","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3975","id":1082236130,"node_id":"IC_kwDOAAMmUc5AgZzi","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-29T18:31:34Z","updated_at":"2022-03-29T18:31:34Z","author_association":"CONTRIBUTOR","body":"Just like https://github.com/apache/couchdb/issues/3978 this one has the `{error,enospc}` error which means the disk is full.\r\n\r\nIt should be a nicer error that we should propagate back to the client. But that is why the crashes happen","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1082236130/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1082310495","html_url":"https://github.com/apache/couchdb/issues/3977#issuecomment-1082310495","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3977","id":1082310495,"node_id":"IC_kwDOAAMmUc5Agr9f","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-29T19:50:16Z","updated_at":"2022-03-29T19:50:16Z","author_association":"CONTRIBUTOR","body":"@ronag thanks for your report.\r\n\r\n`key` effectively behaves as if we are setting both `startkey=$key&endkey=$key`. So every time it is parsed it does exactly that.\r\n\r\nHowever, we do have \"keys\" which returns an error as you mentioned:\r\n\r\n\r\n```\r\nhttp $DB/db/_all_docs'?keys=[\"c\"]&endkey=\"b\"'\r\nHTTP/1.1 400 Bad Request\r\n{\r\n    \"error\": \"query_parse_error\",\r\n    \"reason\": \"`keys` is incompatible with `key`, `start_key` and `end_key`\"\r\n}\r\n```\r\n\r\nPerhaps `key` it should be translated to `keys=[Key]` internally, instead and behave similarly, but it maybe a compatibility issue in some cases as well. It could be a nice improvement for the future.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1082310495/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1082612105","html_url":"https://github.com/apache/couchdb/issues/3977#issuecomment-1082612105","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3977","id":1082612105,"node_id":"IC_kwDOAAMmUc5Ah1mJ","user":{"login":"ronag","id":3065230,"node_id":"MDQ6VXNlcjMwNjUyMzA=","avatar_url":"https://avatars.githubusercontent.com/u/3065230?v=4","gravatar_id":"","url":"https://api.github.com/users/ronag","html_url":"https://github.com/ronag","followers_url":"https://api.github.com/users/ronag/followers","following_url":"https://api.github.com/users/ronag/following{/other_user}","gists_url":"https://api.github.com/users/ronag/gists{/gist_id}","starred_url":"https://api.github.com/users/ronag/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ronag/subscriptions","organizations_url":"https://api.github.com/users/ronag/orgs","repos_url":"https://api.github.com/users/ronag/repos","events_url":"https://api.github.com/users/ronag/events{/privacy}","received_events_url":"https://api.github.com/users/ronag/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-30T04:34:35Z","updated_at":"2022-03-30T04:34:35Z","author_association":"NONE","body":"@nickva What is the predence here though? It seems setting both key and endkey has different result that just setting key. Or does the order of the parameters matter?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1082612105/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1083260350","html_url":"https://github.com/apache/couchdb/issues/3977#issuecomment-1083260350","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3977","id":1083260350,"node_id":"IC_kwDOAAMmUc5AkT2-","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-30T15:08:47Z","updated_at":"2022-03-30T15:08:47Z","author_association":"CONTRIBUTOR","body":"@ronag The precedence is in the order the parameters are specified. For example:\r\n\r\n```\r\n http $DB/db/_all_docs'?endkey=\"b\"&key=\"a\"&key=\"c\"'\r\n```\r\n\r\nWill set endkey to `b` then set both `startkey` and `endkey` to `a` then set both `startkey` and `endkey` to `c` and will emit `c`:\r\n\r\n```\r\n{\r\n    \"offset\": 2,\r\n    \"rows\": [\r\n        {\r\n            \"id\": \"c\",\r\n            \"key\": \"c\",\r\n            \"value\": {\r\n                \"rev\": \"1-935564bc7ec7e86aa82ecec3face18f6\"\r\n            }\r\n        }\r\n    ],\r\n    \"total_rows\": 3\r\n}\r\n```\r\n\r\nI can't think of any useful cases for this, but it has been like that for many years. It probably should be fixed to work like `keys=[...]` and raise a `mutually_exclusive` 400 error or some `duplicate_parameter` error and such as well.\r\n\r\nI marked the issue as an enhancement. It could be picked up by a beginner contributor as it doesn't seem particularly difficult to implement. But, it might involve some discussion on the dev ML since it's a compatibility issue.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1083260350/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1084084577","html_url":"https://github.com/apache/couchdb/pull/3969#issuecomment-1084084577","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3969","id":1084084577,"node_id":"IC_kwDOAAMmUc5AndFh","user":{"login":"jiahuili430","id":54631519,"node_id":"MDQ6VXNlcjU0NjMxNTE5","avatar_url":"https://avatars.githubusercontent.com/u/54631519?v=4","gravatar_id":"","url":"https://api.github.com/users/jiahuili430","html_url":"https://github.com/jiahuili430","followers_url":"https://api.github.com/users/jiahuili430/followers","following_url":"https://api.github.com/users/jiahuili430/following{/other_user}","gists_url":"https://api.github.com/users/jiahuili430/gists{/gist_id}","starred_url":"https://api.github.com/users/jiahuili430/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jiahuili430/subscriptions","organizations_url":"https://api.github.com/users/jiahuili430/orgs","repos_url":"https://api.github.com/users/jiahuili430/repos","events_url":"https://api.github.com/users/jiahuili430/events{/privacy}","received_events_url":"https://api.github.com/users/jiahuili430/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-31T05:14:59Z","updated_at":"2022-03-31T05:14:59Z","author_association":"CONTRIBUTOR","body":"After adding the new namespace `non_design`, I don't need to deal with `skip/limit` in fabric.\r\nThis is indeed a more efficient approach.\r\nThank you for your suggestion, @nickva ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1084084577/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1084272961","html_url":"https://github.com/apache/couchdb/issues/3977#issuecomment-1084272961","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3977","id":1084272961,"node_id":"IC_kwDOAAMmUc5AoLFB","user":{"login":"big-r81","id":9985963,"node_id":"MDQ6VXNlcjk5ODU5NjM=","avatar_url":"https://avatars.githubusercontent.com/u/9985963?v=4","gravatar_id":"","url":"https://api.github.com/users/big-r81","html_url":"https://github.com/big-r81","followers_url":"https://api.github.com/users/big-r81/followers","following_url":"https://api.github.com/users/big-r81/following{/other_user}","gists_url":"https://api.github.com/users/big-r81/gists{/gist_id}","starred_url":"https://api.github.com/users/big-r81/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/big-r81/subscriptions","organizations_url":"https://api.github.com/users/big-r81/orgs","repos_url":"https://api.github.com/users/big-r81/repos","events_url":"https://api.github.com/users/big-r81/events{/privacy}","received_events_url":"https://api.github.com/users/big-r81/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-31T08:40:49Z","updated_at":"2022-03-31T08:40:49Z","author_association":"CONTRIBUTOR","body":"Hi @ronag,\r\n\r\nI would say that your example is working like expected, but you are right it seems a little bit confusing and needs an optimization in the future. \r\nYou are accesing the `_all_docs` [view](https://docs.couchdb.org/en/stable/api/database/bulk-api.html#db-all-docs) endpoint and some [view parameters](https://docs.couchdb.org/en/stable/api/ddoc/views.html#db-design-design-doc-view-view-name) are setting default values like `inclusive_end`, which is set to true. \r\n\r\nSo you would also get `b`in your result list. Maybe you can test it with `?inclusive_end=false` and if `b`isn't in your result, then it is this default parameter...","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1084272961/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1084276356","html_url":"https://github.com/apache/couchdb/issues/3977#issuecomment-1084276356","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3977","id":1084276356,"node_id":"IC_kwDOAAMmUc5AoL6E","user":{"login":"ronag","id":3065230,"node_id":"MDQ6VXNlcjMwNjUyMzA=","avatar_url":"https://avatars.githubusercontent.com/u/3065230?v=4","gravatar_id":"","url":"https://api.github.com/users/ronag","html_url":"https://github.com/ronag","followers_url":"https://api.github.com/users/ronag/followers","following_url":"https://api.github.com/users/ronag/following{/other_user}","gists_url":"https://api.github.com/users/ronag/gists{/gist_id}","starred_url":"https://api.github.com/users/ronag/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ronag/subscriptions","organizations_url":"https://api.github.com/users/ronag/orgs","repos_url":"https://api.github.com/users/ronag/repos","events_url":"https://api.github.com/users/ronag/events{/privacy}","received_events_url":"https://api.github.com/users/ronag/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-31T08:44:07Z","updated_at":"2022-03-31T08:44:07Z","author_association":"NONE","body":"> The precedence is in the order the parameters are specifie\r\n\r\nThis answered my confusion.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1084276356/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1084814189","html_url":"https://github.com/apache/couchdb/pull/3969#issuecomment-1084814189","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3969","id":1084814189,"node_id":"IC_kwDOAAMmUc5AqPNt","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-31T16:24:46Z","updated_at":"2022-03-31T16:24:46Z","author_association":"CONTRIBUTOR","body":"@jiahuili430 wonder if we could revert to using a case in map_fold and check the non_design namespace there:\r\n\r\nhttps://github.com/apache/couchdb/blob/3.x/src/couch_mrview/src/couch_mrview.erl#L481-L484","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1084814189/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1087583343","html_url":"https://github.com/apache/couchdb/issues/2769#issuecomment-1087583343","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2769","id":1087583343,"node_id":"IC_kwDOAAMmUc5A0zRv","user":{"login":"Minecraftschurli","id":23388022,"node_id":"MDQ6VXNlcjIzMzg4MDIy","avatar_url":"https://avatars.githubusercontent.com/u/23388022?v=4","gravatar_id":"","url":"https://api.github.com/users/Minecraftschurli","html_url":"https://github.com/Minecraftschurli","followers_url":"https://api.github.com/users/Minecraftschurli/followers","following_url":"https://api.github.com/users/Minecraftschurli/following{/other_user}","gists_url":"https://api.github.com/users/Minecraftschurli/gists{/gist_id}","starred_url":"https://api.github.com/users/Minecraftschurli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Minecraftschurli/subscriptions","organizations_url":"https://api.github.com/users/Minecraftschurli/orgs","repos_url":"https://api.github.com/users/Minecraftschurli/repos","events_url":"https://api.github.com/users/Minecraftschurli/events{/privacy}","received_events_url":"https://api.github.com/users/Minecraftschurli/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-04T13:51:12Z","updated_at":"2022-04-04T13:54:54Z","author_association":"NONE","body":"I have the same issue with a normal filter function (using the docker image 3.2.1)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1087583343/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1089272253","html_url":"https://github.com/apache/couchdb/pull/3984#issuecomment-1089272253","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3984","id":1089272253,"node_id":"IC_kwDOAAMmUc5A7Pm9","user":{"login":"noahshaw11","id":47468872,"node_id":"MDQ6VXNlcjQ3NDY4ODcy","avatar_url":"https://avatars.githubusercontent.com/u/47468872?v=4","gravatar_id":"","url":"https://api.github.com/users/noahshaw11","html_url":"https://github.com/noahshaw11","followers_url":"https://api.github.com/users/noahshaw11/followers","following_url":"https://api.github.com/users/noahshaw11/following{/other_user}","gists_url":"https://api.github.com/users/noahshaw11/gists{/gist_id}","starred_url":"https://api.github.com/users/noahshaw11/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noahshaw11/subscriptions","organizations_url":"https://api.github.com/users/noahshaw11/orgs","repos_url":"https://api.github.com/users/noahshaw11/repos","events_url":"https://api.github.com/users/noahshaw11/events{/privacy}","received_events_url":"https://api.github.com/users/noahshaw11/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-05T20:04:33Z","updated_at":"2022-04-05T20:04:33Z","author_association":"CONTRIBUTOR","body":"Example:\r\n```\r\n(node1@127.0.0.1)3> couch_debug:memory_info([<0.0.0>,<0.1.0>,<0.2.0>,<0.3.0>,<0.4.0>,<0.5.0>,<0.6.0>]).\r\n[{<0.0.0>,\"init[<0.0.0>]\",\r\n  #{binary => 0,dictionary => 0,heap_size => 2586,links => 3,\r\n    memory => 29568,message_queue_len => 0,monitored_by => 0,\r\n    monitors => 0,stack_size => 3,total_heap_size => 3577}},\r\n {<0.1.0>,\"erts_code_purger[<0.1.0>]\",\r\n  #{binary => 0,dictionary => 0,heap_size => 233,links => 0,\r\n    memory => 3328,message_queue_len => 0,monitored_by => 0,\r\n    monitors => 0,stack_size => 2,total_heap_size => 312}},\r\n {<0.2.0>,\"erts_literal_area_collector:start/0[<0.2.0>]\",\r\n  #{binary => 0,dictionary => 0,heap_size => 233,links => 0,\r\n    memory => 2696,message_queue_len => 0,monitored_by => 0,\r\n    monitors => 0,stack_size => 6,total_heap_size => 233}},\r\n {<0.3.0>,\r\n  \"erts_dirty_process_signal_handler:start/0[<0.3.0>]\",\r\n  #{binary => 0,dictionary => 0,heap_size => 233,links => 0,\r\n    memory => 2696,message_queue_len => 0,monitored_by => 0,\r\n    monitors => 0,stack_size => 3,total_heap_size => 233}},\r\n {<0.4.0>,\r\n  \"erts_dirty_process_signal_handler:start/0[<0.4.0>]\",\r\n  #{binary => 0,dictionary => 0,heap_size => 233,links => 0,\r\n    memory => 2696,message_queue_len => 0,monitored_by => 0,\r\n    monitors => 0,stack_size => 3,total_heap_size => 233}},\r\n {<0.5.0>,\r\n  \"erts_dirty_process_signal_handler:start/0[<0.5.0>]\",\r\n  #{binary => 0,dictionary => 0,heap_size => 233,links => 0,\r\n    memory => 2696,message_queue_len => 0,monitored_by => 0,\r\n    monitors => 0,stack_size => 3,total_heap_size => 233}},\r\n {<0.6.0>,\"prim_file:start/0[<0.6.0>]\",\r\n  #{binary => 0,dictionary => 0,heap_size => 233,links => 0,\r\n    memory => 2880,message_queue_len => 0,monitored_by => 0,\r\n    monitors => 0,stack_size => 2,total_heap_size => 245}}]\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1089272253/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1089760466","html_url":"https://github.com/apache/couchdb/issues/3986#issuecomment-1089760466","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3986","id":1089760466,"node_id":"IC_kwDOAAMmUc5A9GzS","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-06T03:44:54Z","updated_at":"2022-04-06T03:44:54Z","author_association":"CONTRIBUTOR","body":"@sbagati it looks like the replicator cannot make requests to the _session endpoint. It's getting a timeout. Can try logging in on that node and use curl to perform the same request and see if it works. It could be a firewall or proxy in between.\r\n\r\nSometimes proxies can alter or prevent cookie headers from being set properly. In that case could try disabling the session auth and revert to using basic auth for replication:\r\n\r\n```ini\r\n[replicator]\r\nauth_plugins = couch_replicator_auth_noop\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1089760466/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1089765282","html_url":"https://github.com/apache/couchdb/pull/3938#issuecomment-1089765282","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3938","id":1089765282,"node_id":"IC_kwDOAAMmUc5A9H-i","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-06T03:50:09Z","updated_at":"2022-04-06T03:50:09Z","author_association":"CONTRIBUTOR","body":"@jaydoane good idea to try. The version we have is pretty old. But I suspect in this case it's the issue with odd paths we expect these NIFs to have relative the top of the (top) umbrella folder vs the individual dep app folder in various contexts (eunit tests vs regular builds). ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1089765282/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1089871060","html_url":"https://github.com/apache/couchdb/issues/3581#issuecomment-1089871060","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3581","id":1089871060,"node_id":"IC_kwDOAAMmUc5A9hzU","user":{"login":"snackerphi","id":25625824,"node_id":"MDQ6VXNlcjI1NjI1ODI0","avatar_url":"https://avatars.githubusercontent.com/u/25625824?v=4","gravatar_id":"","url":"https://api.github.com/users/snackerphi","html_url":"https://github.com/snackerphi","followers_url":"https://api.github.com/users/snackerphi/followers","following_url":"https://api.github.com/users/snackerphi/following{/other_user}","gists_url":"https://api.github.com/users/snackerphi/gists{/gist_id}","starred_url":"https://api.github.com/users/snackerphi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/snackerphi/subscriptions","organizations_url":"https://api.github.com/users/snackerphi/orgs","repos_url":"https://api.github.com/users/snackerphi/repos","events_url":"https://api.github.com/users/snackerphi/events{/privacy}","received_events_url":"https://api.github.com/users/snackerphi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-06T06:27:56Z","updated_at":"2022-04-06T06:30:58Z","author_association":"NONE","body":"Are we sure it isn't using TLSv1.3?\r\n\r\n    echo | openssl s_client -tls1_3 -connect localhost:6984 \r\n        ...\r\n        New, TLSv1.3, Cipher is TLS_AES_256_GCM_SHA384\r\n        ...\r\n\r\n\r\n    curl -k https://localhost:6984/_all_dbs -v -u admin:password\r\n        ...\r\n        SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384\r\n        ...\r\n        Server: CouchDB/3.2.1 (Erlang OTP/23)\r\n        ...\r\n\r\nActually... this is the unix version.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1089871060/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1089927176","html_url":"https://github.com/apache/couchdb/issues/3291#issuecomment-1089927176","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3291","id":1089927176,"node_id":"IC_kwDOAAMmUc5A9vgI","user":{"login":"weareu","id":1459006,"node_id":"MDQ6VXNlcjE0NTkwMDY=","avatar_url":"https://avatars.githubusercontent.com/u/1459006?v=4","gravatar_id":"","url":"https://api.github.com/users/weareu","html_url":"https://github.com/weareu","followers_url":"https://api.github.com/users/weareu/followers","following_url":"https://api.github.com/users/weareu/following{/other_user}","gists_url":"https://api.github.com/users/weareu/gists{/gist_id}","starred_url":"https://api.github.com/users/weareu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weareu/subscriptions","organizations_url":"https://api.github.com/users/weareu/orgs","repos_url":"https://api.github.com/users/weareu/repos","events_url":"https://api.github.com/users/weareu/events{/privacy}","received_events_url":"https://api.github.com/users/weareu/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-06T07:36:35Z","updated_at":"2022-04-06T07:36:35Z","author_association":"NONE","body":"We are also getting this issue on 3.1.1, we monitor _system in various scenarios for restarts on the cluster and having issues lately on 3.1.1 that are hard to describe or pinpoint.\r\n\r\nIs there any solution?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1089927176/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1090241963","html_url":"https://github.com/apache/couchdb/issues/3986#issuecomment-1090241963","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3986","id":1090241963,"node_id":"IC_kwDOAAMmUc5A-8Wr","user":{"login":"sbagati","id":96412399,"node_id":"U_kgDOBb8i7w","avatar_url":"https://avatars.githubusercontent.com/u/96412399?v=4","gravatar_id":"","url":"https://api.github.com/users/sbagati","html_url":"https://github.com/sbagati","followers_url":"https://api.github.com/users/sbagati/followers","following_url":"https://api.github.com/users/sbagati/following{/other_user}","gists_url":"https://api.github.com/users/sbagati/gists{/gist_id}","starred_url":"https://api.github.com/users/sbagati/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sbagati/subscriptions","organizations_url":"https://api.github.com/users/sbagati/orgs","repos_url":"https://api.github.com/users/sbagati/repos","events_url":"https://api.github.com/users/sbagati/events{/privacy}","received_events_url":"https://api.github.com/users/sbagati/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-06T13:01:28Z","updated_at":"2022-04-06T13:02:13Z","author_association":"NONE","body":"Thanks a lot @nickva for the help and support after introducing the parameter in local.ini, issue got resolved and replication process is up now\r\n[replicator]\r\nauth_plugins = couch_replicator_auth_noop","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1090241963/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1090287567","html_url":"https://github.com/apache/couchdb/issues/3986#issuecomment-1090287567","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3986","id":1090287567,"node_id":"IC_kwDOAAMmUc5A_HfP","user":{"login":"sbagati","id":96412399,"node_id":"U_kgDOBb8i7w","avatar_url":"https://avatars.githubusercontent.com/u/96412399?v=4","gravatar_id":"","url":"https://api.github.com/users/sbagati","html_url":"https://github.com/sbagati","followers_url":"https://api.github.com/users/sbagati/followers","following_url":"https://api.github.com/users/sbagati/following{/other_user}","gists_url":"https://api.github.com/users/sbagati/gists{/gist_id}","starred_url":"https://api.github.com/users/sbagati/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sbagati/subscriptions","organizations_url":"https://api.github.com/users/sbagati/orgs","repos_url":"https://api.github.com/users/sbagati/repos","events_url":"https://api.github.com/users/sbagati/events{/privacy}","received_events_url":"https://api.github.com/users/sbagati/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-06T13:41:25Z","updated_at":"2022-04-06T14:06:14Z","author_association":"NONE","body":"@nickva :  Now the error we are getting is below:\r\n[root@couchstagedb1.las ~]# /opt/ec/couchdb/couchdb_replication_restart.rb -u admin -p xxxxxxxx -t couchstagedb.aor.expertcity.com -c services -s\r\nReplication is in error state the error is:\r\n{http_request_failed,\"GET\",\r\n                     \"http://admin:*****@couchstagedb1.bmi.expertcity.com:5984/services/\",\r\n                     {error,{error,{conn_failed,{error,etimedout}}}}}\r\n[root@couchstagedb1.las ~]# /opt/ec/couchdb/couchdb_replication_check.rb -u admin -p xxxxxxx couchstagedb1.bmi.expertcity.com  couchstagedb.aor.expertcity.com services\r\nprocess_status:0\r\ndocument_mismatches:-1\r\n\r\nPlease help","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1090287567/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1090508711","html_url":"https://github.com/apache/couchdb/issues/3291#issuecomment-1090508711","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3291","id":1090508711,"node_id":"IC_kwDOAAMmUc5A_9en","user":{"login":"Liquid-NeoN","id":1575482,"node_id":"MDQ6VXNlcjE1NzU0ODI=","avatar_url":"https://avatars.githubusercontent.com/u/1575482?v=4","gravatar_id":"","url":"https://api.github.com/users/Liquid-NeoN","html_url":"https://github.com/Liquid-NeoN","followers_url":"https://api.github.com/users/Liquid-NeoN/followers","following_url":"https://api.github.com/users/Liquid-NeoN/following{/other_user}","gists_url":"https://api.github.com/users/Liquid-NeoN/gists{/gist_id}","starred_url":"https://api.github.com/users/Liquid-NeoN/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Liquid-NeoN/subscriptions","organizations_url":"https://api.github.com/users/Liquid-NeoN/orgs","repos_url":"https://api.github.com/users/Liquid-NeoN/repos","events_url":"https://api.github.com/users/Liquid-NeoN/events{/privacy}","received_events_url":"https://api.github.com/users/Liquid-NeoN/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-06T17:12:38Z","updated_at":"2022-04-06T17:12:38Z","author_association":"NONE","body":"We seeing similar behaviour when calling the [/_node/_local/_system](url) end point, but we get a different error. Environment specs and  [/_node/_local/_system](url) response below.\r\n\r\nOperating system and version: Ubuntu 18.04.6 LTS\r\n\r\n[/](url)\r\n```JSON\r\n{\r\n    \"couchdb\": \"Welcome\",\r\n    \"version\": \"3.2.1\",\r\n    \"git_sha\": \"244d428af\",\r\n    \"uuid\": \"2c788d3183f607ee7cb432038b940f78\",\r\n    \"features\": [\r\n        \"access-ready\",\r\n        \"partitioned\",\r\n        \"pluggable-storage-engines\",\r\n        \"reshard\",\r\n        \"scheduler\"\r\n    ],\r\n    \"vendor\": {\r\n        \"name\": \"The Apache Software Foundation\"\r\n    }\r\n}\r\n```\r\n\r\n[/_membership](url)\r\n```JSON\r\n{\r\n    \"all_nodes\": [\r\n        \"couchdb@db1.xxx.com\",\r\n        \"couchdb@db2.xxx.com\",\r\n        \"couchdb@db3.xxx.com\",\r\n        \"couchdb@db4.xxx.com\"\r\n    ],\r\n    \"cluster_nodes\": [\r\n        \"couchdb@db1.xxx.com\",\r\n        \"couchdb@db2.xxx.com\",\r\n        \"couchdb@db3.xxx.com\",\r\n        \"couchdb@db4.xxx.com\"\r\n    ]\r\n}\r\n```\r\n\r\n[/_node/_local/_system](url)\r\n```JSON\r\n{\r\n    \"error\": \"invalid_ejson\",\r\n    \"reason\": \"{badrpc,\\n    {'EXIT',\\n        {function_clause,\\n            [{prim_inet,getstat,\\n                 [<0.12402.0>,\\n                  [recv_oct,recv_cnt,recv_max,recv_avg,recv_dvi,send_oct,\\n                   send_cnt,send_max,send_avg,send_pend]],\\n                 []},\\n             {chttpd_node,'-get_distribution_stats/0-fun-0-',1,\\n                 [{file,\\\"src/chttpd_node.erl\\\"},{line,312}]},\\n             {lists,map,2,[{file,\\\"lists.erl\\\"},{line,1243}]},\\n             {chttpd_node,get_stats,0,\\n                 [{file,\\\"src/chttpd_node.erl\\\"},{line,264}]}]}}}\",\r\n    \"ref\": 878456848\r\n}\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1090508711/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1092664864","html_url":"https://github.com/apache/couchdb/issues/3976#issuecomment-1092664864","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3976","id":1092664864,"node_id":"IC_kwDOAAMmUc5BIL4g","user":{"login":"big-r81","id":9985963,"node_id":"MDQ6VXNlcjk5ODU5NjM=","avatar_url":"https://avatars.githubusercontent.com/u/9985963?v=4","gravatar_id":"","url":"https://api.github.com/users/big-r81","html_url":"https://github.com/big-r81","followers_url":"https://api.github.com/users/big-r81/followers","following_url":"https://api.github.com/users/big-r81/following{/other_user}","gists_url":"https://api.github.com/users/big-r81/gists{/gist_id}","starred_url":"https://api.github.com/users/big-r81/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/big-r81/subscriptions","organizations_url":"https://api.github.com/users/big-r81/orgs","repos_url":"https://api.github.com/users/big-r81/repos","events_url":"https://api.github.com/users/big-r81/events{/privacy}","received_events_url":"https://api.github.com/users/big-r81/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-08T09:39:24Z","updated_at":"2022-04-14T09:29:38Z","author_association":"CONTRIBUTOR","body":"Hi,\r\n\r\nI can reproduce this on windows.\r\n\r\n```\r\n[error] 2022-04-08T09:33:44.043000Z couchdb@localhost <0.5852.1> -------- CRASH REPORT Process  (<0.5852.1>) with 0 neighbors crashed with reason: {invalid_ejson,{bad_block,88}} at jiffy:encode/2(line:99) <= couch_httpd:before_response/4(line:1207) <= couch_httpd:handle_response/5(line:1199) <= couch_httpd:send_response_no_cors/4(line:798) <= chttpd:process_request/1(line:318) <= chttpd:handle_request_int/1(line:249) <= mochiweb_http:headers/6(line:150) <= proc_lib:init_p_do_apply/3(line:226); initial_call: {mochiweb_acceptor,init,['Argument__1','Argument__2',...]}, ancestors: [chttpd,chttpd_sup,<0.332.0>], message_queue_len: 0, links: [<0.336.0>,#Port<0.33>], dictionary: [{chttpd_stats,{st,0,0,0}},{dont_log_response,true},{dont_log_request,...},...], trap_exit: false, status: running, heap_size: 4185, stack_size: 28, reductions: 6665\r\n\r\n[error] 2022-04-08T09:33:44.043000Z couchdb@localhost <0.5852.1> -------- CRASH REPORT Process  (<0.5852.1>) with 0 neighbors crashed with reason: {invalid_ejson,{bad_block,88}} at jiffy:encode/2(line:99) <= couch_httpd:before_response/4(line:1207) <= couch_httpd:handle_response/5(line:1199) <= couch_httpd:send_response_no_cors/4(line:798) <= chttpd:process_request/1(line:318) <= chttpd:handle_request_int/1(line:249) <= mochiweb_http:headers/6(line:150) <= proc_lib:init_p_do_apply/3(line:226); initial_call: {mochiweb_acceptor,init,['Argument__1','Argument__2',...]}, ancestors: [chttpd,chttpd_sup,<0.332.0>], message_queue_len: 0, links: [<0.336.0>,#Port<0.33>], dictionary: [{chttpd_stats,{st,0,0,0}},{dont_log_response,true},{dont_log_request,...},...], trap_exit: false, status: running, heap_size: 4185, stack_size: 28, reductions: 6665\r\n```\r\n\r\nDoes your server completely die, so that you can't do any requests to it?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/1092664864/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]