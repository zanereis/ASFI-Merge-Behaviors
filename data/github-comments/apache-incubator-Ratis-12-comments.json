[{"url":"https://api.github.com/repos/apache/ratis/issues/comments/921432428","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-921432428","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":921432428,"node_id":"IC_kwDOBMxbGc426_Fs","user":{"login":"JacksonYao287","id":80438902,"node_id":"MDQ6VXNlcjgwNDM4OTAy","avatar_url":"https://avatars.githubusercontent.com/u/80438902?v=4","gravatar_id":"","url":"https://api.github.com/users/JacksonYao287","html_url":"https://github.com/JacksonYao287","followers_url":"https://api.github.com/users/JacksonYao287/followers","following_url":"https://api.github.com/users/JacksonYao287/following{/other_user}","gists_url":"https://api.github.com/users/JacksonYao287/gists{/gist_id}","starred_url":"https://api.github.com/users/JacksonYao287/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JacksonYao287/subscriptions","organizations_url":"https://api.github.com/users/JacksonYao287/orgs","repos_url":"https://api.github.com/users/JacksonYao287/repos","events_url":"https://api.github.com/users/JacksonYao287/events{/privacy}","received_events_url":"https://api.github.com/users/JacksonYao287/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-17T03:46:59Z","updated_at":"2021-09-17T03:49:10Z","author_association":"NONE","body":"@szetszwo thanks for the review!\r\n>In requestVote(..), the leader recognizes a candidate only if the candidate has a higher term. Therefore, the leader should change to follower even if it will reject the vote from the candidate.\r\n\r\nyes , so , we can say that when the leader rejects a vote, it means the candidate must have a term lower or equal than the leader. if a candidate has a higher term, the leader should vote for it and step down to follower. \r\n\r\nso my point is that , before `changeToFollower` , we should check whether vote is granted.\r\nif vote is granted , it means the candidate has a higher term , so it make sense to `changeToFollower`\r\nif vote is not granted, it means the candidate has a equal or lower term,  `changeToFollower` should not be called.\r\nso there does not exist any case that the leader reject the vote and meanwhile `changeToFollower`.\r\n\r\npleaser see the attached log below which i have uploaded in this jira.\r\n```\r\n2021-09-15 18:21:07,529 [grpc-default-executor-617] INFO org.apache.ratis.server.impl.VoteContext: a075f477-2523-4b79-991f-ecbe8ee00d0d@group-8BCFDCD73BCA-LEADER: reject ELECTION from b7bb63db-f11b-49c0-8269-2acf98d5fdd6: our last entry (t:3, i:432782) > candidate's last entry (t:3, i:302053)\r\n2021-09-15 18:21:07,529 [grpc-default-executor-617] INFO org.apache.ratis.server.RaftServer$Division: a075f477-2523-4b79-991f-ecbe8ee00d0d@group-8BCFDCD73BCA: change Leader from a075f477-2523-4b79-991f-ecbe8ee00d0d to null at term 4 for updateCurrentTerm\r\n2021-09-15 18:21:07,529 [grpc-default-executor-617] INFO org.apache.ratis.server.RaftServer$Division: a075f477-2523-4b79-991f-ecbe8ee00d0d@group-8BCFDCD73BCA: changes role from    LEADER to FOLLOWER at term 4 for candidate:b7bb63db-f11b-49c0-8269-2acf98d5fdd6\r\n```\r\nit show that the leader reject the vote because the candidate has a less up-to-date log(same term, but smaller index). after    this rejection, the leader does not check whether the candidate has a higher term(voteGranted), and just go ahead to call `changeToFollower`,in which `state.updateCurrentTerm` is called.  so , this is what the current patch fixed","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/921432428/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/921454957","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-921454957","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":921454957,"node_id":"IC_kwDOBMxbGc427Elt","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-17T04:33:33Z","updated_at":"2021-09-17T04:33:33Z","author_association":"CONTRIBUTOR","body":"> ... if vote is not granted, it means the candidate has a equal or lower term ...\r\n\r\nThis is not true.  The candidate can still have a higher term.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/921454957/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/921455596","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-921455596","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":921455596,"node_id":"IC_kwDOBMxbGc427Evs","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-17T04:35:37Z","updated_at":"2021-09-17T04:35:37Z","author_association":"CONTRIBUTOR","body":"For the leader case, recognizeCandidate(candidateTerm) != null means the candidateTerm is higher.  However, decideVote(..) can still return false.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/921455596/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/921588140","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-921588140","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":921588140,"node_id":"IC_kwDOBMxbGc427lGs","user":{"login":"JacksonYao287","id":80438902,"node_id":"MDQ6VXNlcjgwNDM4OTAy","avatar_url":"https://avatars.githubusercontent.com/u/80438902?v=4","gravatar_id":"","url":"https://api.github.com/users/JacksonYao287","html_url":"https://github.com/JacksonYao287","followers_url":"https://api.github.com/users/JacksonYao287/followers","following_url":"https://api.github.com/users/JacksonYao287/following{/other_user}","gists_url":"https://api.github.com/users/JacksonYao287/gists{/gist_id}","starred_url":"https://api.github.com/users/JacksonYao287/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JacksonYao287/subscriptions","organizations_url":"https://api.github.com/users/JacksonYao287/orgs","repos_url":"https://api.github.com/users/JacksonYao287/repos","events_url":"https://api.github.com/users/JacksonYao287/events{/privacy}","received_events_url":"https://api.github.com/users/JacksonYao287/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-17T07:55:43Z","updated_at":"2021-09-17T07:56:13Z","author_association":"NONE","body":"@szetszwo \r\n> For the leader case, recognizeCandidate(candidateTerm) != null means the candidateTerm is higher. \r\n\r\nyea , it is\r\n\r\n>However, decideVote(..) can still return false.\r\n\r\n can you give a case that a candidate has a higher term(recognizeCandidate(candidateTerm) != null), but decideVote(..) still returns false? \r\ni think if candidate has a higher term, `ServerState.compareLog(lastEntry, candidateLastEntry)` will definitely return -1, so that decideVote(..) will return true!\r\n\r\nplease correct me if I miss something!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/921588140/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/921666675","html_url":"https://github.com/apache/ratis/pull/502#issuecomment-921666675","issue_url":"https://api.github.com/repos/apache/ratis/issues/502","id":921666675,"node_id":"IC_kwDOBMxbGc4274Rz","user":{"login":"adoroszlai","id":6454655,"node_id":"MDQ6VXNlcjY0NTQ2NTU=","avatar_url":"https://avatars.githubusercontent.com/u/6454655?v=4","gravatar_id":"","url":"https://api.github.com/users/adoroszlai","html_url":"https://github.com/adoroszlai","followers_url":"https://api.github.com/users/adoroszlai/followers","following_url":"https://api.github.com/users/adoroszlai/following{/other_user}","gists_url":"https://api.github.com/users/adoroszlai/gists{/gist_id}","starred_url":"https://api.github.com/users/adoroszlai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adoroszlai/subscriptions","organizations_url":"https://api.github.com/users/adoroszlai/orgs","repos_url":"https://api.github.com/users/adoroszlai/repos","events_url":"https://api.github.com/users/adoroszlai/events{/privacy}","received_events_url":"https://api.github.com/users/adoroszlai/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-17T09:53:26Z","updated_at":"2021-09-17T09:53:26Z","author_association":"CONTRIBUTOR","body":"Thanks @szetszwo for reviewing and committing it.\r\n\r\n<img width=\"465\" alt=\"Screenshot 2021-09-17 at 11 52 03\" src=\"https://user-images.githubusercontent.com/6454655/133763813-dd80cd05-899f-4ad6-bdc8-57666ebda21f.png\">\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/921666675/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922171562","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-922171562","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":922171562,"node_id":"IC_kwDOBMxbGc429ziq","user":{"login":"kaijchen","id":5821159,"node_id":"MDQ6VXNlcjU4MjExNTk=","avatar_url":"https://avatars.githubusercontent.com/u/5821159?v=4","gravatar_id":"","url":"https://api.github.com/users/kaijchen","html_url":"https://github.com/kaijchen","followers_url":"https://api.github.com/users/kaijchen/followers","following_url":"https://api.github.com/users/kaijchen/following{/other_user}","gists_url":"https://api.github.com/users/kaijchen/gists{/gist_id}","starred_url":"https://api.github.com/users/kaijchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaijchen/subscriptions","organizations_url":"https://api.github.com/users/kaijchen/orgs","repos_url":"https://api.github.com/users/kaijchen/repos","events_url":"https://api.github.com/users/kaijchen/events{/privacy}","received_events_url":"https://api.github.com/users/kaijchen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-18T03:31:07Z","updated_at":"2021-09-18T06:33:56Z","author_association":"CONTRIBUTOR","body":"> can you give a case that a candidate has a higher term(recognizeCandidate(candidateTerm) != null), but decideVote(..) still returns false?\r\n\r\n1. candidate's term >  leader's term\r\n2. candidate's last log (term, index) < leader's last log (term, index)\r\n\r\nLeader should reject the VoteFor request, and step down.\r\n\r\nWe can see the etcd's implementation for reference. Note in Go, the switch-case doesn't fallthrough by default.\r\nhttps://github.com/etcd-io/etcd/blob/706f256a054b2158ba5dc2e59cbab45826063829/raft/raft.go#L847","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922171562/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922172442","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-922172442","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":922172442,"node_id":"IC_kwDOBMxbGc429zwa","user":{"login":"kaijchen","id":5821159,"node_id":"MDQ6VXNlcjU4MjExNTk=","avatar_url":"https://avatars.githubusercontent.com/u/5821159?v=4","gravatar_id":"","url":"https://api.github.com/users/kaijchen","html_url":"https://github.com/kaijchen","followers_url":"https://api.github.com/users/kaijchen/followers","following_url":"https://api.github.com/users/kaijchen/following{/other_user}","gists_url":"https://api.github.com/users/kaijchen/gists{/gist_id}","starred_url":"https://api.github.com/users/kaijchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaijchen/subscriptions","organizations_url":"https://api.github.com/users/kaijchen/orgs","repos_url":"https://api.github.com/users/kaijchen/repos","events_url":"https://api.github.com/users/kaijchen/events{/privacy}","received_events_url":"https://api.github.com/users/kaijchen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-18T03:38:43Z","updated_at":"2021-09-18T03:38:43Z","author_association":"CONTRIBUTOR","body":"To avoid unnecessary step down, PreVote should be used.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922172442/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922227394","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-922227394","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":922227394,"node_id":"IC_kwDOBMxbGc42-BLC","user":{"login":"kaijchen","id":5821159,"node_id":"MDQ6VXNlcjU4MjExNTk=","avatar_url":"https://avatars.githubusercontent.com/u/5821159?v=4","gravatar_id":"","url":"https://api.github.com/users/kaijchen","html_url":"https://github.com/kaijchen","followers_url":"https://api.github.com/users/kaijchen/followers","following_url":"https://api.github.com/users/kaijchen/following{/other_user}","gists_url":"https://api.github.com/users/kaijchen/gists{/gist_id}","starred_url":"https://api.github.com/users/kaijchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaijchen/subscriptions","organizations_url":"https://api.github.com/users/kaijchen/orgs","repos_url":"https://api.github.com/users/kaijchen/repos","events_url":"https://api.github.com/users/kaijchen/events{/privacy}","received_events_url":"https://api.github.com/users/kaijchen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-18T06:48:01Z","updated_at":"2021-09-18T08:05:23Z","author_association":"CONTRIBUTOR","body":"> i think if candidate has a higher term, `ServerState.compareLog(lastEntry, candidateLastEntry)` will definitely return -1, so that decideVote(..) will return true!\r\n\r\nThis is not true. The candidate has a higher term doesn't mean it has higher lastEntryTerm.\r\n\r\nFor example, in 3-node Raft group.\r\n\r\n| Node | Role | Term | Log Index -> | 1 | 2 | 3 | 4 | 5 | 6 |\r\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\r\n| A | Leader | 1 | Log Term -> | 1 | 1 | 1 | 1 | 1 | |\r\n| B | Candidate | 2 | Log Term -> | 1 | 1 | 1 | | | |\r\n| C | Follower | 1 | Log Term -> | 1 | 1 | | | | |\r\n\r\n1. It is possible for B to passed the PreVote stage and became a candidate, `B {term = 2, votedFor = B}`\r\n    * The message is `RequestForVote {term = 2, candidateId = B, lastLogIndex = 3, lastLogTerm = 1}`.\r\n2. B -> A: RequestForVote\r\n    * **A rejects the vote request and steps down**, `A {term = 2, votedFor = None}`.\r\n3. B -> C: RequestForVote\r\n    * C accepts the vote request, `C {term = 2, votedFor = B}`.\r\n4. B got quorum votes and became the new leader.\r\n5. B appends a `Log {index = 4, term = 2}` and begin to send AppendEntries requests to A and C.\r\n\r\nThe end result might look like this.\r\n\r\n| Node | Role | Term | Log Index -> | 1 | 2 | 3 | 4 | 5 | 6 |\r\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\r\n| A | Follower | 2 | Log Term -> | 1 | 1 | 1 | 2 | | |\r\n| B | Leader | 2 | Log Term -> | 1 | 1 | 1 | 2 | | |\r\n| C | Follower | 2 | Log Term -> | 1 | 1 | 1 | 2 | | |","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922227394/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922250260","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-922250260","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":922250260,"node_id":"IC_kwDOBMxbGc42-GwU","user":{"login":"JacksonYao287","id":80438902,"node_id":"MDQ6VXNlcjgwNDM4OTAy","avatar_url":"https://avatars.githubusercontent.com/u/80438902?v=4","gravatar_id":"","url":"https://api.github.com/users/JacksonYao287","html_url":"https://github.com/JacksonYao287","followers_url":"https://api.github.com/users/JacksonYao287/followers","following_url":"https://api.github.com/users/JacksonYao287/following{/other_user}","gists_url":"https://api.github.com/users/JacksonYao287/gists{/gist_id}","starred_url":"https://api.github.com/users/JacksonYao287/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JacksonYao287/subscriptions","organizations_url":"https://api.github.com/users/JacksonYao287/orgs","repos_url":"https://api.github.com/users/JacksonYao287/repos","events_url":"https://api.github.com/users/JacksonYao287/events{/privacy}","received_events_url":"https://api.github.com/users/JacksonYao287/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-18T09:46:32Z","updated_at":"2021-09-18T09:46:32Z","author_association":"NONE","body":"thanks @kaijchen for the review!\r\n\r\n> To avoid unnecessary step down, PreVote should be used.\r\n\r\nPreVote is very import and has been supported by RATIS, but for some uncertain reason , we disable it in some components of ozone(for example, scm)\r\n\r\n```\r\nRatisUtil.java\r\n /**\r\n   * Set properties related to Raft leader election.\r\n   *\r\n   * @param properties RaftProperties instance which will be updated\r\n   *\r\n   */\r\n  private static void setRaftLeadElectionProperties(\r\n      final RaftProperties properties) {\r\n    // Disable the pre vote feature (related to leader election) in Ratis\r\n    RaftServerConfigKeys.LeaderElection.setPreVote(properties, false);\r\n  }\r\n```\r\n\r\n\r\n> > i think if candidate has a higher term, `ServerState.compareLog(lastEntry, candidateLastEntry)` will definitely return -1, so that decideVote(..) will return true!\r\n> \r\n> This is not true. The candidate has a higher term doesn't mean it has higher lastEntryTerm.\r\n> \r\n\r\nthe below is extracted from raft paper(5.4.1 Election restriction)\r\n\r\nRaft uses the voting process to prevent a candidate from winning an election unless its log contains all committed entries. A candidate must contact a majority of the cluster in order to be elected, which means that every committed entry must be present in at least one of those servers. If the candidate’s log is at least as up-to-date as any other log in that majority (where “up-to-date” is defined precisely below), then it will hold all the committed entries. The RequestVote RPC implements this restriction: the RPC includes information about the candidate’s log, and the voter denies its vote if its own log is more up-to-date than that of the candidate.\r\n\r\nRaft determines which of two logs is more up-to-date by comparing the index and term of the last entries in the logs. If the logs have last entries with different terms, then the log with the later term is more up-to-date. If the logs end with the same term, then whichever log is longer is more up-to-date.\r\n\r\nso, here, the key point is what `up-to-date` stands for? according to the paper, a log with a higher term in its last entry is more up-to-date than a log with a lower term in its last entry. it means even if a log has a smaller index, it can also be more up-to-date than a log with a bigger index. that means a log with a shorter length can be much more up-to-date than a log with a longer length.   {index = 1, term = 100} is more up-to-date than {index = 100, term = 1}.\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922250260/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922251205","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-922251205","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":922251205,"node_id":"IC_kwDOBMxbGc42-G_F","user":{"login":"kaijchen","id":5821159,"node_id":"MDQ6VXNlcjU4MjExNTk=","avatar_url":"https://avatars.githubusercontent.com/u/5821159?v=4","gravatar_id":"","url":"https://api.github.com/users/kaijchen","html_url":"https://github.com/kaijchen","followers_url":"https://api.github.com/users/kaijchen/followers","following_url":"https://api.github.com/users/kaijchen/following{/other_user}","gists_url":"https://api.github.com/users/kaijchen/gists{/gist_id}","starred_url":"https://api.github.com/users/kaijchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaijchen/subscriptions","organizations_url":"https://api.github.com/users/kaijchen/orgs","repos_url":"https://api.github.com/users/kaijchen/repos","events_url":"https://api.github.com/users/kaijchen/events{/privacy}","received_events_url":"https://api.github.com/users/kaijchen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-18T09:53:56Z","updated_at":"2021-09-18T10:58:22Z","author_association":"CONTRIBUTOR","body":"> it means even if a log has a smaller index, it can also be more up-to-date than a log with a bigger index. that means a log with a shorter length can be much more up-to-date than a log with a longer length. {index = 1, term = 100} is more up-to-date than {index = 100, term = 1}.\r\n\r\nYes, you are correct.\r\n\r\nThe point is, have higher term doesn't necessarily mean have higher lastLogTerm.\r\n\r\nCandidate cannot append log entries by itself. Only leader can do that.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922251205/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922255114","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-922255114","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":922255114,"node_id":"IC_kwDOBMxbGc42-H8K","user":{"login":"kaijchen","id":5821159,"node_id":"MDQ6VXNlcjU4MjExNTk=","avatar_url":"https://avatars.githubusercontent.com/u/5821159?v=4","gravatar_id":"","url":"https://api.github.com/users/kaijchen","html_url":"https://github.com/kaijchen","followers_url":"https://api.github.com/users/kaijchen/followers","following_url":"https://api.github.com/users/kaijchen/following{/other_user}","gists_url":"https://api.github.com/users/kaijchen/gists{/gist_id}","starred_url":"https://api.github.com/users/kaijchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaijchen/subscriptions","organizations_url":"https://api.github.com/users/kaijchen/orgs","repos_url":"https://api.github.com/users/kaijchen/repos","events_url":"https://api.github.com/users/kaijchen/events{/privacy}","received_events_url":"https://api.github.com/users/kaijchen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-18T10:25:22Z","updated_at":"2021-09-18T10:27:52Z","author_association":"CONTRIBUTOR","body":"> 2\\. candidate's last log (term, index) < leader's last log (term, index)\r\n\r\nFor clarification, I wrote this in Python's tuple comparison syntax. \r\n\r\n`(a, b) < (x, y)` means `a < x || (a == x && b < y)`, which is equal to `less up-to-date than` in Raft.\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922255114/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922257245","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-922257245","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":922257245,"node_id":"IC_kwDOBMxbGc42-Idd","user":{"login":"kaijchen","id":5821159,"node_id":"MDQ6VXNlcjU4MjExNTk=","avatar_url":"https://avatars.githubusercontent.com/u/5821159?v=4","gravatar_id":"","url":"https://api.github.com/users/kaijchen","html_url":"https://github.com/kaijchen","followers_url":"https://api.github.com/users/kaijchen/followers","following_url":"https://api.github.com/users/kaijchen/following{/other_user}","gists_url":"https://api.github.com/users/kaijchen/gists{/gist_id}","starred_url":"https://api.github.com/users/kaijchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaijchen/subscriptions","organizations_url":"https://api.github.com/users/kaijchen/orgs","repos_url":"https://api.github.com/users/kaijchen/repos","events_url":"https://api.github.com/users/kaijchen/events{/privacy}","received_events_url":"https://api.github.com/users/kaijchen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-18T10:43:41Z","updated_at":"2021-09-18T10:43:41Z","author_association":"CONTRIBUTOR","body":"For example,\r\n\r\nIf a candidate has `{term = 10, lastLogTerm = 5, lastLogIndex = 50}`,\r\nand a leader has `{term = 5, lastLogTerm = 5, lastLogIndex = 100}`,\r\nThe leader should **reject the vote request and step down**.\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922257245/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922404558","html_url":"https://github.com/apache/ratis/pull/383#issuecomment-922404558","issue_url":"https://api.github.com/repos/apache/ratis/issues/383","id":922404558,"node_id":"IC_kwDOBMxbGc42-sbO","user":{"login":"runzhiwang","id":51938049,"node_id":"MDQ6VXNlcjUxOTM4MDQ5","avatar_url":"https://avatars.githubusercontent.com/u/51938049?v=4","gravatar_id":"","url":"https://api.github.com/users/runzhiwang","html_url":"https://github.com/runzhiwang","followers_url":"https://api.github.com/users/runzhiwang/followers","following_url":"https://api.github.com/users/runzhiwang/following{/other_user}","gists_url":"https://api.github.com/users/runzhiwang/gists{/gist_id}","starred_url":"https://api.github.com/users/runzhiwang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/runzhiwang/subscriptions","organizations_url":"https://api.github.com/users/runzhiwang/orgs","repos_url":"https://api.github.com/users/runzhiwang/repos","events_url":"https://api.github.com/users/runzhiwang/events{/privacy}","received_events_url":"https://api.github.com/users/runzhiwang/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-19T02:18:21Z","updated_at":"2021-09-19T02:18:21Z","author_association":"CONTRIBUTOR","body":"@szetszwo  sorry for the delay. @JacksonYao287  please feel free to take over this, thanks.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/922404558/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/924603342","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-924603342","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":924603342,"node_id":"IC_kwDOBMxbGc43HFPO","user":{"login":"JacksonYao287","id":80438902,"node_id":"MDQ6VXNlcjgwNDM4OTAy","avatar_url":"https://avatars.githubusercontent.com/u/80438902?v=4","gravatar_id":"","url":"https://api.github.com/users/JacksonYao287","html_url":"https://github.com/JacksonYao287","followers_url":"https://api.github.com/users/JacksonYao287/followers","following_url":"https://api.github.com/users/JacksonYao287/following{/other_user}","gists_url":"https://api.github.com/users/JacksonYao287/gists{/gist_id}","starred_url":"https://api.github.com/users/JacksonYao287/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JacksonYao287/subscriptions","organizations_url":"https://api.github.com/users/JacksonYao287/orgs","repos_url":"https://api.github.com/users/JacksonYao287/repos","events_url":"https://api.github.com/users/JacksonYao287/events{/privacy}","received_events_url":"https://api.github.com/users/JacksonYao287/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-22T05:41:02Z","updated_at":"2021-09-22T05:41:02Z","author_association":"NONE","body":"> For example,\r\n> \r\n> If a candidate has `{term = 10, lastLogTerm = 5, lastLogIndex = 50}`,\r\n> and a leader has `{term = 5, lastLogTerm = 5, lastLogIndex = 100}`,\r\n> The leader should **reject the vote request and step down**.\r\n\r\nyea，according to raft paper,  a leader should step down and become follower if it discovers any server with a higher term.\r\n\r\nbut, i am not quite clear that is it necessary if the discovered server has a less up-to-date last logEntry? or will there be any problem if the leader does not step down to follower when it finds the raft peer , with a higher term, has a less up-to-date last logEntry?\r\n\r\n i would like to hear your views. @szetszwo @kaijchen \r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/924603342/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/924631323","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-924631323","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":924631323,"node_id":"IC_kwDOBMxbGc43HMEb","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-22T06:39:36Z","updated_at":"2021-09-22T06:39:36Z","author_association":"CONTRIBUTOR","body":"> ... will there be any problem if the leader does not step down ...\r\n\r\nYes, there is a problem -- that particular follower won't be able to join back.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/924631323/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/924671157","html_url":"https://github.com/apache/ratis/pull/500#issuecomment-924671157","issue_url":"https://api.github.com/repos/apache/ratis/issues/500","id":924671157,"node_id":"IC_kwDOBMxbGc43HVy1","user":{"login":"JacksonYao287","id":80438902,"node_id":"MDQ6VXNlcjgwNDM4OTAy","avatar_url":"https://avatars.githubusercontent.com/u/80438902?v=4","gravatar_id":"","url":"https://api.github.com/users/JacksonYao287","html_url":"https://github.com/JacksonYao287","followers_url":"https://api.github.com/users/JacksonYao287/followers","following_url":"https://api.github.com/users/JacksonYao287/following{/other_user}","gists_url":"https://api.github.com/users/JacksonYao287/gists{/gist_id}","starred_url":"https://api.github.com/users/JacksonYao287/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JacksonYao287/subscriptions","organizations_url":"https://api.github.com/users/JacksonYao287/orgs","repos_url":"https://api.github.com/users/JacksonYao287/repos","events_url":"https://api.github.com/users/JacksonYao287/events{/privacy}","received_events_url":"https://api.github.com/users/JacksonYao287/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-22T07:44:49Z","updated_at":"2021-09-22T07:44:49Z","author_association":"NONE","body":"> that particular follower won't be able to join back\r\n\r\ngood explanation!  thanks @szetszwo , it is clear to me now, i will close this PR","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/924671157/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/925477228","html_url":"https://github.com/apache/ratis/pull/504#issuecomment-925477228","issue_url":"https://api.github.com/repos/apache/ratis/issues/504","id":925477228,"node_id":"IC_kwDOBMxbGc43Kals","user":{"login":"JacksonYao287","id":80438902,"node_id":"MDQ6VXNlcjgwNDM4OTAy","avatar_url":"https://avatars.githubusercontent.com/u/80438902?v=4","gravatar_id":"","url":"https://api.github.com/users/JacksonYao287","html_url":"https://github.com/JacksonYao287","followers_url":"https://api.github.com/users/JacksonYao287/followers","following_url":"https://api.github.com/users/JacksonYao287/following{/other_user}","gists_url":"https://api.github.com/users/JacksonYao287/gists{/gist_id}","starred_url":"https://api.github.com/users/JacksonYao287/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JacksonYao287/subscriptions","organizations_url":"https://api.github.com/users/JacksonYao287/orgs","repos_url":"https://api.github.com/users/JacksonYao287/repos","events_url":"https://api.github.com/users/JacksonYao287/events{/privacy}","received_events_url":"https://api.github.com/users/JacksonYao287/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-23T03:15:10Z","updated_at":"2021-09-23T03:15:10Z","author_association":"NONE","body":"@szetszwo PTAL!  i have tested this patch, scm bootstraps as expected now","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/925477228/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/925487707","html_url":"https://github.com/apache/ratis/pull/504#issuecomment-925487707","issue_url":"https://api.github.com/repos/apache/ratis/issues/504","id":925487707,"node_id":"IC_kwDOBMxbGc43KdJb","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-23T03:51:37Z","updated_at":"2021-09-23T03:51:37Z","author_association":"CONTRIBUTOR","body":"@JacksonYao287 TestInstallSnapshotNotificationWithGrpc failed.  It seems related.  Please take a look.\r\n\r\nBTW, I just have requested @hanishakoneru  to review this.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/925487707/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/925570557","html_url":"https://github.com/apache/ratis/pull/503#issuecomment-925570557","issue_url":"https://api.github.com/repos/apache/ratis/issues/503","id":925570557,"node_id":"IC_kwDOBMxbGc43KxX9","user":{"login":"kaijchen","id":5821159,"node_id":"MDQ6VXNlcjU4MjExNTk=","avatar_url":"https://avatars.githubusercontent.com/u/5821159?v=4","gravatar_id":"","url":"https://api.github.com/users/kaijchen","html_url":"https://github.com/kaijchen","followers_url":"https://api.github.com/users/kaijchen/followers","following_url":"https://api.github.com/users/kaijchen/following{/other_user}","gists_url":"https://api.github.com/users/kaijchen/gists{/gist_id}","starred_url":"https://api.github.com/users/kaijchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaijchen/subscriptions","organizations_url":"https://api.github.com/users/kaijchen/orgs","repos_url":"https://api.github.com/users/kaijchen/repos","events_url":"https://api.github.com/users/kaijchen/events{/privacy}","received_events_url":"https://api.github.com/users/kaijchen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-23T07:34:58Z","updated_at":"2021-09-23T07:34:58Z","author_association":"CONTRIBUTOR","body":"LGTM","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/925570557/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927251612","html_url":"https://github.com/apache/ratis/pull/505#issuecomment-927251612","issue_url":"https://api.github.com/repos/apache/ratis/issues/505","id":927251612,"node_id":"IC_kwDOBMxbGc43RLyc","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-26T07:42:09Z","updated_at":"2021-09-26T07:52:13Z","author_association":"CONTRIBUTOR","body":"Thanks @szetszwo  for the code review. \r\n\r\nIt turns out that add a new setQueueByteLimit is not eought.   This is DN LOG from produciton cluster, \r\n\r\n2021-09-26 15:19:31,860 [EndpointStateMachine task thread for /9.186.21.245:9861 - 0 ] WARN org.apache.hadoop.ozone.container.common.statemachine.EndpointStateMachine: Unable to communicate to SCM server at 9.186.21.245:9861 for past 0 seconds.\r\njava.io.IOException: java.lang.ArithmeticException: integer overflow\r\n        at org.apache.ratis.util.IOUtils.asIOException(IOUtils.java:56)\r\n        at org.apache.ratis.util.IOUtils.toIOException(IOUtils.java:61)\r\n        at org.apache.ratis.util.IOUtils.getFromFuture(IOUtils.java:71)\r\n        at org.apache.ratis.server.impl.RaftServerProxy.getImpls(RaftServerProxy.java:354)\r\n        at org.apache.ratis.server.impl.RaftServerProxy.start(RaftServerProxy.java:371)\r\n        at org.apache.hadoop.ozone.container.common.transport.server.ratis.XceiverServerRatis.start(XceiverServerRatis.java:490)\r\n        at org.apache.hadoop.ozone.container.ozoneimpl.OzoneContainer.start(OzoneContainer.java:313)\r\n        at org.apache.hadoop.ozone.container.common.states.endpoint.VersionEndpointTask.call(VersionEndpointTask.java:114)\r\n        at org.apache.hadoop.ozone.container.common.states.endpoint.VersionEndpointTask.call(VersionEndpointTask.java:42)\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:266)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n        at java.lang.Thread.run(Thread.java:748)\r\nCaused by: java.lang.ArithmeticException: integer overflow\r\n        at java.lang.Math.toIntExact(Math.java:1011)\r\n        at org.apache.ratis.util.SizeInBytes.getSizeInt(SizeInBytes.java:74)\r\n        at org.apache.ratis.util.DataQueue.<init>(DataQueue.java:59)\r\n        at org.apache.ratis.util.DataBlockingQueue.<init>(DataBlockingQueue.java:50)\r\n        at org.apache.ratis.server.raftlog.segmented.SegmentedRaftLogWorker.<init>(SegmentedRaftLogWorker.java:194)\r\n        at org.apache.ratis.server.raftlog.segmented.SegmentedRaftLog.<init>(SegmentedRaftLog.java:202)\r\n        at org.apache.ratis.server.impl.ServerState.initRaftLog(ServerState.java:203)\r\n        at org.apache.ratis.server.impl.ServerState.<init>(ServerState.java:150)\r\n        at org.apache.ratis.server.impl.RaftServerImpl.<init>(RaftServerImpl.java:197)\r\n        at org.apache.ratis.server.impl.RaftServerProxy.lambda$newRaftServerImpl$4(RaftServerProxy.java:266)\r\n        at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1590)\r\n        ... 3 more\r\n\r\n\r\nI will upload another commit to make DataQueue use long instead of int as bytesLimit.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927251612/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927273207","html_url":"https://github.com/apache/ratis/pull/504#issuecomment-927273207","issue_url":"https://api.github.com/repos/apache/ratis/issues/504","id":927273207,"node_id":"IC_kwDOBMxbGc43RRD3","user":{"login":"JacksonYao287","id":80438902,"node_id":"MDQ6VXNlcjgwNDM4OTAy","avatar_url":"https://avatars.githubusercontent.com/u/80438902?v=4","gravatar_id":"","url":"https://api.github.com/users/JacksonYao287","html_url":"https://github.com/JacksonYao287","followers_url":"https://api.github.com/users/JacksonYao287/followers","following_url":"https://api.github.com/users/JacksonYao287/following{/other_user}","gists_url":"https://api.github.com/users/JacksonYao287/gists{/gist_id}","starred_url":"https://api.github.com/users/JacksonYao287/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JacksonYao287/subscriptions","organizations_url":"https://api.github.com/users/JacksonYao287/orgs","repos_url":"https://api.github.com/users/JacksonYao287/repos","events_url":"https://api.github.com/users/JacksonYao287/events{/privacy}","received_events_url":"https://api.github.com/users/JacksonYao287/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-26T09:52:05Z","updated_at":"2021-09-26T09:52:05Z","author_association":"NONE","body":"@szetszwo @hanishakoneru PTAL! thanks. i thinks this is the reason why the leader will make so many rpc calls as shown in the attachment of this jira , i have tested this patch, it works as expected. \r\n\r\nthe test seems faild, but i do not think it is caused by this patch. i will try to fix the test","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927273207/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927311926","html_url":"https://github.com/apache/ratis/pull/505#issuecomment-927311926","issue_url":"https://api.github.com/repos/apache/ratis/issues/505","id":927311926,"node_id":"IC_kwDOBMxbGc43Rag2","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-26T14:04:42Z","updated_at":"2021-09-26T14:04:42Z","author_association":"CONTRIBUTOR","body":"@ChenSammi , oops, then it needs more works.  Thanks.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927311926/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927686871","html_url":"https://github.com/apache/ratis/pull/505#issuecomment-927686871","issue_url":"https://api.github.com/repos/apache/ratis/issues/505","id":927686871,"node_id":"IC_kwDOBMxbGc43S2DX","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-27T09:23:02Z","updated_at":"2021-09-27T09:24:28Z","author_association":"CONTRIBUTOR","body":"The failed UT \"testSimpleWrite(org.apache.ratis.grpc.TestGrpcOutputStream)\" seems irrelevant. Which is also not reproducable locally. ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927686871/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927740792","html_url":"https://github.com/apache/ratis/pull/505#issuecomment-927740792","issue_url":"https://api.github.com/repos/apache/ratis/issues/505","id":927740792,"node_id":"IC_kwDOBMxbGc43TDN4","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-27T10:38:24Z","updated_at":"2021-09-27T10:38:24Z","author_association":"CONTRIBUTOR","body":"Just have re-run the job and all checks have passed.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927740792/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927782106","html_url":"https://github.com/apache/ratis/pull/505#issuecomment-927782106","issue_url":"https://api.github.com/repos/apache/ratis/issues/505","id":927782106,"node_id":"IC_kwDOBMxbGc43TNTa","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-27T11:26:11Z","updated_at":"2021-09-27T11:26:11Z","author_association":"CONTRIBUTOR","body":"Thanks @szetszwo .","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927782106/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927819668","html_url":"https://github.com/apache/ratis/pull/508#issuecomment-927819668","issue_url":"https://api.github.com/repos/apache/ratis/issues/508","id":927819668,"node_id":"IC_kwDOBMxbGc43TWeU","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-27T12:20:17Z","updated_at":"2021-09-27T12:20:17Z","author_association":"CONTRIBUTOR","body":"This patch is a mixed patch. I will upload a clean patch later. ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927819668/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927833676","html_url":"https://github.com/apache/ratis/pull/504#issuecomment-927833676","issue_url":"https://api.github.com/repos/apache/ratis/issues/504","id":927833676,"node_id":"IC_kwDOBMxbGc43TZ5M","user":{"login":"hanishakoneru","id":10237377,"node_id":"MDQ6VXNlcjEwMjM3Mzc3","avatar_url":"https://avatars.githubusercontent.com/u/10237377?v=4","gravatar_id":"","url":"https://api.github.com/users/hanishakoneru","html_url":"https://github.com/hanishakoneru","followers_url":"https://api.github.com/users/hanishakoneru/followers","following_url":"https://api.github.com/users/hanishakoneru/following{/other_user}","gists_url":"https://api.github.com/users/hanishakoneru/gists{/gist_id}","starred_url":"https://api.github.com/users/hanishakoneru/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hanishakoneru/subscriptions","organizations_url":"https://api.github.com/users/hanishakoneru/orgs","repos_url":"https://api.github.com/users/hanishakoneru/repos","events_url":"https://api.github.com/users/hanishakoneru/events{/privacy}","received_events_url":"https://api.github.com/users/hanishakoneru/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-27T12:40:28Z","updated_at":"2021-09-27T12:41:14Z","author_association":"CONTRIBUTOR","body":"@JacksonYao287 thanks for working on this.\r\n\r\nIf I understand the motivation for this fix correctly, it is to avoid the leader sending extra rpc calls to follower when the follower is still installing a snapshot. Is this correct? If yes, could you please update the Jira title to reflect that?\r\n\r\nUsing join(), we are giving up calling the StateMachine asynchronously as we wait for it to finish. Also, if the StateMachine#notifyInstallSnapshotFromLeader() completes exceptionally, join() would throw an unchecked exception which might cause the follower to shutdown.\r\n\r\nSo instead of join(), I think we could call wait on the main thread itself for a specified time. This way, if the StateMachine completes the future before the wait if over, we can return the result. Otherwise, we can return IN_PROGRESS notification back to the leader. ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/927833676/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/928706256","html_url":"https://github.com/apache/ratis/pull/504#issuecomment-928706256","issue_url":"https://api.github.com/repos/apache/ratis/issues/504","id":928706256,"node_id":"IC_kwDOBMxbGc43Wu7Q","user":{"login":"JacksonYao287","id":80438902,"node_id":"MDQ6VXNlcjgwNDM4OTAy","avatar_url":"https://avatars.githubusercontent.com/u/80438902?v=4","gravatar_id":"","url":"https://api.github.com/users/JacksonYao287","html_url":"https://github.com/JacksonYao287","followers_url":"https://api.github.com/users/JacksonYao287/followers","following_url":"https://api.github.com/users/JacksonYao287/following{/other_user}","gists_url":"https://api.github.com/users/JacksonYao287/gists{/gist_id}","starred_url":"https://api.github.com/users/JacksonYao287/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JacksonYao287/subscriptions","organizations_url":"https://api.github.com/users/JacksonYao287/orgs","repos_url":"https://api.github.com/users/JacksonYao287/repos","events_url":"https://api.github.com/users/JacksonYao287/events{/privacy}","received_events_url":"https://api.github.com/users/JacksonYao287/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-28T03:22:40Z","updated_at":"2021-09-28T03:26:10Z","author_association":"NONE","body":"thanks @hanishakoneru for the review !\r\n\r\n>If I understand the motivation for this fix correctly, it is to avoid the leader sending extra rpc calls to follower when the follower is still installing a snapshot. Is this correct? If yes, could you please update the Jira title to reflect that?\r\n\r\nyes it is . when i test, i found two problems。\r\n1 leader will send a lot of extra rpc calls to follower when the follower is still installing a snapshot.\r\n2 after snapshot is installed successfully , leader and follower can not work as expected. `nextIndex: updateUnconditionally` will be called infinitely and the new scm can not be bootstraped successfully. please take a look at the attachement of this jira\r\n\r\nleader.log \r\n```\r\nInstallSnapshotResponseHandler: received a reply b6424ca2-783b-4e68-b12c-95a0e99bb745<-b1b06ffa-12b9-4093-a844-58467d6298b9#0:FAIL-t2,SNAPSHOT_INSTALLED,snapshotIndex=2\r\n2021-09-10 14:31:35,849 [grpc-default-executor-0] INFO org.apache.ratis.grpc.server.GrpcLogAppender: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9-InstallSnapshotResponseHandler: Follower installed snapshot at index 2\r\n2021-09-10 14:31:35,849 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9: snapshotIndex: setUnconditionally 0 -> 2\r\n2021-09-10 14:31:35,849 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9: matchIndex: setUnconditionally 0 -> 2\r\n2021-09-10 14:31:35,849 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9: nextIndex: setUnconditionally 3 -> 3\r\n2021-09-10 14:31:35,849 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: Follower b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9 acknowledged installing snapshot\r\n2021-09-10 14:31:35,849 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: commitIndexChanged notify senders,org.apache.ratis.server.impl.LeaderStateImpl$SenderList@328cc3cb\r\n2021-09-10 14:31:35,849 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9: nextIndex: updateToMax old=3, new=3, updated? false\r\n2021-09-10 14:31:35,849 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9: nextIndex: updateUnconditionally 3 -> 3\r\n2021-09-10 14:31:38,352 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9: nextIndex: updateUnconditionally 3 -> 3\r\n\r\n2021-09-10 14:31:40,414 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9: nextIndex: updateUnconditionally 4 -> 3\r\n2021-09-10 14:31:40,415 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9: nextIndex: updateUnconditionally 4 -> 3\r\n2021-09-10 14:31:40,415 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9: nextIndex: updateUnconditionally 4 -> 3\r\n2021-09-10 14:31:40,416 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9: nextIndex: updateUnconditionally 4 -> 3\r\n\r\n2021-09-10 14:31:40,420 [grpc-default-executor-0] INFO org.apache.ratis.server.leader.FollowerInfo: b6424ca2-783b-4e68-b12c-95a0e99bb745@group-194BB21401F4->b1b06ffa-12b9-4093-a844-58467d6298b9: nextIndex: updateUnconditionally 4 -> 3\r\n```\r\nfollower.log\r\n```\r\n2021-09-10 14:31:35,856 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: Failed appendEntries as snapshot ((t:2, i:2)) installation is in progress\r\n2021-09-10 14:31:35,856 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: inconsistency entries. Reply:b6424ca2-783b-4e68-b12c-95a0e99bb745<-b1b06ffa-12b9-4093-a844-58467d6298b9#207:FAIL-t2,INCONSISTENCY,nextIndex=3,followerCommit=2\r\n2021-09-10 14:31:36,020 [b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4-StateMachineUpdater] INFO org.apache.hadoop.hdds.scm.ha.SCMHAManagerImpl: Installing checkpoint with SCMTransactionInfo 2#2\r\n2021-09-10 14:31:36,023 [b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4-StateMachineUpdater] INFO org.apache.hadoop.hdds.scm.ha.SCMHAManagerImpl: Replaced DB with checkpoint, term: 2, index: 2\r\n2021-09-10 14:31:36,171 [b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4-StateMachineUpdater] INFO org.apache.hadoop.hdds.scm.ha.SequenceIdGenerator: reinitialize SequenceIdGenerator.\r\n2021-09-10 14:31:36,172 [b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4-StateMachineUpdater] INFO org.apache.hadoop.hdds.scm.pipeline.PipelineStateManager: No pipeline exists in current db\r\n2021-09-10 14:31:36,172 [b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4-StateMachineUpdater] INFO org.apache.hadoop.hdds.scm.ha.SCMHAManagerImpl: Reloaded SCM state with Term: 2 and Index: 2\r\n2021-09-10 14:31:36,174 [b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4-StateMachineUpdater] INFO org.apache.ratis.server.impl.StateMachineUpdater: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4-StateMachineUpdater: snapshotIndex: setUnconditionally -1 -> 2\r\n2021-09-10 14:31:36,174 [b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4-StateMachineUpdater] INFO org.apache.ratis.server.impl.StateMachineUpdater: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4-StateMachineUpdater: appliedIndex: setUnconditionally -1 -> 2\r\n2021-09-10 14:31:38,357 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: Failed appendEntries as snapshot ((t:2, i:2)) installation is in progress\r\n2021-09-10 14:31:38,357 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: inconsistency entries. Reply:b6424ca2-783b-4e68-b12c-95a0e99bb745<-b1b06ffa-12b9-4093-a844-58467d6298b9#208:FAIL-t2,INCONSISTENCY,nextIndex=3,followerCommit=2\r\n2021-09-10 14:31:40,418 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: Failed appendEntries as snapshot ((t:2, i:2)) installation is in progress\r\n2021-09-10 14:31:40,418 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: inconsistency entries. Reply:b6424ca2-783b-4e68-b12c-95a0e99bb745<-b1b06ffa-12b9-4093-a844-58467d6298b9#209:FAIL-t2,INCONSISTENCY,nextIndex=3,followerCommit=2\r\n2021-09-10 14:31:40,419 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: Failed appendEntries as snapshot ((t:2, i:2)) installation is in progress\r\n2021-09-10 14:31:40,419 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: inconsistency entries. Reply:b6424ca2-783b-4e68-b12c-95a0e99bb745<-b1b06ffa-12b9-4093-a844-58467d6298b9#210:FAIL-t2,INCONSISTENCY,nextIndex=3,followerCommit=2\r\n2021-09-10 14:31:40,420 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: Failed appendEntries as snapshot ((t:2, i:2)) installation is in progress\r\n2021-09-10 14:31:40,420 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: inconsistency entries. Reply:b6424ca2-783b-4e68-b12c-95a0e99bb745<-b1b06ffa-12b9-4093-a844-58467d6298b9#211:FAIL-t2,INCONSISTENCY,nextIndex=3,followerCommit=2\r\n2021-09-10 14:31:40,420 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: Failed appendEntries as snapshot ((t:2, i:2)) installation is in progress\r\n2021-09-10 14:31:40,420 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: inconsistency entries. Reply:b6424ca2-783b-4e68-b12c-95a0e99bb745<-b1b06ffa-12b9-4093-a844-58467d6298b9#212:FAIL-t2,INCONSISTENCY,nextIndex=3,followerCommit=2\r\n```\r\nfrom follower.log, we can see  that , even if the snapshot has been installed successfully , the follower also consider the snapshot installation is in progress.\r\n\r\nthe reason is `installedSnapshotIndex.set(reply.getIndex());` is called in a separate thread in the completeFuture when the snapshot is installed successfully. if we do not wait until the installation is completed, then the following code will lost the chance to be called, and inProgressInstallSnapshotRequest will keep not null and thus `checkInconsistentAppendEntries` will \r\nalways consider the snapshot installation is in progress.\r\n```\r\n      // If a snapshot has been installed, return SNAPSHOT_INSTALLED with the installed snapshot index and reset\r\n      // installedSnapshotIndex to 0.\r\n      long latestInstalledSnapshotIndex = this.installedSnapshotIndex.getAndSet(0);\r\n      if (latestInstalledSnapshotIndex > 0) {\r\n        LOG.info(\"{}: InstallSnapshot notification result: {}, at index: {}\", getMemberId(),\r\n            InstallSnapshotResult.SNAPSHOT_INSTALLED, latestInstalledSnapshotIndex);\r\n        inProgressInstallSnapshotRequest.compareAndSet(firstAvailableLogTermIndex, null);\r\n        return ServerProtoUtils.toInstallSnapshotReplyProto(leaderId, getMemberId(),\r\n            currentTerm, InstallSnapshotResult.SNAPSHOT_INSTALLED, latestInstalledSnapshotIndex);\r\n      }\r\n```  \r\n\r\n>So instead of join(), I think we could call wait on the main thread itself for a specified time. This way, if the StateMachine completes the future before the wait if over, we can return the result. Otherwise, we can return IN_PROGRESS notification back to the leader.\r\n\r\nif we return IN_PROGRESS notification back to the leader when the wait is over, seems the same problem as described above will happen again, because the future may be completed after the wait . so i thinks there are two possible solutions here.\r\n\r\n1 use `join`. this is simple and clear. Although `join` would throw an unchecked exception which might cause the follower to shutdown, a single follower crash will not downgrade the performance of the whole raft group as long as the majority is alive. what is more, the unchecked exception may indicate some serious problems ，such as disk error or network error, so that we have a chance to find and fix the problem and then restart the raft peer.\r\n\r\n2 use `get(long timeout, TimeUnit unit)`. it gives us a chance to catch the exception and handle it. but if get  timed out, a timeoutException will be throw out and we should call `get` on the same future again until the future is completed successfully or exceptionally. what should be done if it is completed exceptionally. if that happens, no more logs can be appended to this raft peer. if leader retry, the same problem will happen again. if so , it is better off shutting it down.\r\n\r\nso IMHO, we could use `join` for now, and modify it in the future if needed","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/928706256/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/929059212","html_url":"https://github.com/apache/ratis/pull/504#issuecomment-929059212","issue_url":"https://api.github.com/repos/apache/ratis/issues/504","id":929059212,"node_id":"IC_kwDOBMxbGc43YFGM","user":{"login":"hanishakoneru","id":10237377,"node_id":"MDQ6VXNlcjEwMjM3Mzc3","avatar_url":"https://avatars.githubusercontent.com/u/10237377?v=4","gravatar_id":"","url":"https://api.github.com/users/hanishakoneru","html_url":"https://github.com/hanishakoneru","followers_url":"https://api.github.com/users/hanishakoneru/followers","following_url":"https://api.github.com/users/hanishakoneru/following{/other_user}","gists_url":"https://api.github.com/users/hanishakoneru/gists{/gist_id}","starred_url":"https://api.github.com/users/hanishakoneru/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hanishakoneru/subscriptions","organizations_url":"https://api.github.com/users/hanishakoneru/orgs","repos_url":"https://api.github.com/users/hanishakoneru/repos","events_url":"https://api.github.com/users/hanishakoneru/events{/privacy}","received_events_url":"https://api.github.com/users/hanishakoneru/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-28T10:24:38Z","updated_at":"2021-09-28T10:24:38Z","author_association":"CONTRIBUTOR","body":"> the reason is installedSnapshotIndex.set(reply.getIndex()); is called in a separate thread in the completeFuture when the snapshot is installed successfully. if we do not wait until the installation is completed, then the following code will lost the chance to be called, and inProgressInstallSnapshotRequest will keep not null and thus checkInconsistentAppendEntries will always consider the snapshot installation is in progress.\r\n\r\nThe code you mentioned above would be called in the next iteration of the installSnapshot notification. You can verify this from the following statement in the follower log:\r\n```\r\n2021-09-10 14:31:35,854 [grpc-default-executor-0] INFO org.apache.ratis.server.RaftServer$Division: b1b06ffa-12b9-4093-a844-58467d6298b9@group-194BB21401F4: InstallSnapshot notification result: SNAPSHOT_INSTALLED, at index: 2\r\n```\r\nIf we send IN_PROGRESS notification to the leader, the leader tries again and in a subsequent attempt, it will get the SNAPSHOT_INSTALLED reply.\r\n\r\nWe need to figure out why the follower thinks install snapshot is in progress even though it is not. That is what is causing the follower to fail append entries request. From the code path you mentioned above, the LOG statement is being printed in the follower log. So the next line in code `inProgressInstallSnapshotRequest.compareAndSet(firstAvailableLogTermIndex, null);` should also have been run. I am not sure what is happening there.\r\n\r\n> 1 use join. this is simple and clear. Although join would throw an unchecked exception which might cause the follower to shutdown, a single follower crash will not downgrade the performance of the whole raft group as long as the majority is alive. what is more, the unchecked exception may indicate some serious problems ，such as disk error or network error, so that we have a chance to find and fix the problem and then restart the raft peer.\r\n\r\nI don't think this will be so simple. For example, from Ozone perspective, it would not be desirable for an OzoneManager to crash if there was let's say a network blip or something which caused the install snapshot to fail. Shutting down a peer is an extreme step. We should avoid it especially when the peer is not in an inconsistent state and can be recovered.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/929059212/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/929277305","html_url":"https://github.com/apache/ratis/pull/508#issuecomment-929277305","issue_url":"https://api.github.com/repos/apache/ratis/issues/508","id":929277305,"node_id":"IC_kwDOBMxbGc43Y6V5","user":{"login":"bshashikant","id":31469764,"node_id":"MDQ6VXNlcjMxNDY5NzY0","avatar_url":"https://avatars.githubusercontent.com/u/31469764?v=4","gravatar_id":"","url":"https://api.github.com/users/bshashikant","html_url":"https://github.com/bshashikant","followers_url":"https://api.github.com/users/bshashikant/followers","following_url":"https://api.github.com/users/bshashikant/following{/other_user}","gists_url":"https://api.github.com/users/bshashikant/gists{/gist_id}","starred_url":"https://api.github.com/users/bshashikant/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bshashikant/subscriptions","organizations_url":"https://api.github.com/users/bshashikant/orgs","repos_url":"https://api.github.com/users/bshashikant/repos","events_url":"https://api.github.com/users/bshashikant/events{/privacy}","received_events_url":"https://api.github.com/users/bshashikant/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-28T14:20:03Z","updated_at":"2021-09-28T14:21:35Z","author_association":"CONTRIBUTOR","body":"Thanks @ChenSammi for the patch. This should be disabled by default in ratis as @szetszwo suggested, \r\n\r\n\r\nThe only problem i think what we will run into eventually will be :\r\n\r\nIf a slow follower is just not able to catch up with the leader and exceeds the threshold, the leader itself will not be able to apply the transactions whatever have already been appended to its own log . In such cases, probably, it should be able to remove the node and apply the pending transactions which have been appended on the raft log,.\r\n\r\nAlso, a degenerate case will be where we are not updating the majority index to the max but the min of the nodes, but, the leader itself will be accepting accepting transactions till the pending request limit is reached.\r\n\r\nThe other approach can be to not remove the entry from the cache aggressively once applyTransaction is called in Ozone. it should be available on the data cache as long as it is within the threshold of difference between majority and min index  The Once it exceeds the threshold , the pipeline can be closed.\r\nThe data in the stateMachine case will be there in the cache, until all the followers get the data(majority index == min index) . Once all the nodes have the data, or the gap between majority and min index is within the threshold , the entry will always be in the cache. Otherwise, remove the entry from cache and mark the node as slow follower and handle the slow follower case in ozone by closing down the pipeline.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/929277305/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/929943196","html_url":"https://github.com/apache/ratis/pull/508#issuecomment-929943196","issue_url":"https://api.github.com/repos/apache/ratis/issues/508","id":929943196,"node_id":"IC_kwDOBMxbGc43bc6c","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-29T08:11:43Z","updated_at":"2021-09-29T08:11:43Z","author_association":"CONTRIBUTOR","body":"Thanks @szetszwo and @bshashikant for giving the feedback.  Add a switch to turn on/off this feature is very good point. \r\n\r\nFor those ratis client who doesn't need WATCH for ALL_COMMITTED,  and doesn't have large statemachine data to write/read,  there will be no severe slow follower issue.  For example, current OM and SCM HA. \r\nI will add an new  property for that. \r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/929943196/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/929960558","html_url":"https://github.com/apache/ratis/pull/508#issuecomment-929960558","issue_url":"https://api.github.com/repos/apache/ratis/issues/508","id":929960558,"node_id":"IC_kwDOBMxbGc43bhJu","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-29T08:33:42Z","updated_at":"2021-09-29T08:33:42Z","author_association":"CONTRIBUTOR","body":"> Thanks @ChenSammi for the patch. This should be disabled by default in ratis as @szetszwo suggested,\r\n> \r\n> The only problem i think what we will run into eventually will be :\r\n> \r\n> If a slow follower is just not able to catch up with the leader and exceeds the threshold, the leader itself will not be able to apply the transactions whatever have already been appended to its own log . In such cases, probably, it should be able to remove the node and apply the pending transactions which have been appended on the raft log,.\r\n> \r\n\r\nIf the slow follower is alive and function well, it will eventually catch up when the leader and another follower are waiting for it. If the slow follower doesn't response, it will eventually trigger the pipeline close after \"raft.server.rpc.slowness.timeout\" timeout(300s in Ozone).  \r\nRemoving a slow follwer node, leave the two members keep going on, or shall we add another new member to the raft group? \r\n\r\n> Also, a degenerate case will be where we are not updating the majority index to the max but the min of the nodes, but, the leader itself will be accepting accepting transactions till the pending request limit is reached.\r\n> \r\n> The other approach can be to not remove the entry from the cache aggressively once applyTransaction is called in Ozone. it should be available on the data cache as long as it is within the threshold of difference between majority and min index The Once it exceeds the threshold , the pipeline can be closed. The data in the stateMachine case will be there in the cache, until all the followers get the data(majority index == min index) . Once all the nodes have the data, or the gap between majority and min index is within the threshold , the entry will always be in the cache. Otherwise, remove the entry from cache and mark the node as slow follower and handle the slow follower case in ozone by closing down the pipeline.\r\n\r\nI opened a Ozone ticket for the cache improvement HDDS-5791.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/929960558/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/930745520","html_url":"https://github.com/apache/ratis/pull/508#issuecomment-930745520","issue_url":"https://api.github.com/repos/apache/ratis/issues/508","id":930745520,"node_id":"IC_kwDOBMxbGc43egyw","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-30T03:20:45Z","updated_at":"2021-09-30T03:20:45Z","author_association":"CONTRIBUTOR","body":"@bshashikant , do you want to take a look at the new change?","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/930745520/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/931041413","html_url":"https://github.com/apache/ratis/pull/504#issuecomment-931041413","issue_url":"https://api.github.com/repos/apache/ratis/issues/504","id":931041413,"node_id":"IC_kwDOBMxbGc43fpCF","user":{"login":"JacksonYao287","id":80438902,"node_id":"MDQ6VXNlcjgwNDM4OTAy","avatar_url":"https://avatars.githubusercontent.com/u/80438902?v=4","gravatar_id":"","url":"https://api.github.com/users/JacksonYao287","html_url":"https://github.com/JacksonYao287","followers_url":"https://api.github.com/users/JacksonYao287/followers","following_url":"https://api.github.com/users/JacksonYao287/following{/other_user}","gists_url":"https://api.github.com/users/JacksonYao287/gists{/gist_id}","starred_url":"https://api.github.com/users/JacksonYao287/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JacksonYao287/subscriptions","organizations_url":"https://api.github.com/users/JacksonYao287/orgs","repos_url":"https://api.github.com/users/JacksonYao287/repos","events_url":"https://api.github.com/users/JacksonYao287/events{/privacy}","received_events_url":"https://api.github.com/users/JacksonYao287/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-30T08:37:58Z","updated_at":"2021-09-30T08:37:58Z","author_association":"NONE","body":"@hanishakoneru thanks for your reply!\r\n>We need to figure out why the follower thinks install snapshot is in progress even though it is not\r\n\r\nevery time the follower receives a `notifyInstallSnapshotRequest` ,  it will get a new object of `firstAvailableLogTermIndex`\r\n```\r\nfinal TermIndex firstAvailableLogTermIndex = TermIndex.valueOf(\r\n    request.getNotification().getFirstAvailableTermIndex());\r\n```\r\n`inProgressInstallSnapshotRequest` is `AtomicReference<TermIndex>`. when we call `compareAndSet(a, b)`, in fact it will compare the object address(offset in memory) of a and b, but not call something like `compareTo`. so if we reach the following code when leader retry sending `notifyInstallSnapshotRequest` , `firstAvailableLogTermIndex` will not be the one that we set when we receive the first `notifyInstallSnapshotRequest`.so `compareAndSet` will return false and `inProgressInstallSnapshotRequest` will keep not null. and thus `checkInconsistentAppendEntries` will think the installation of the follower is still in progress. \r\n```\r\nif (latestInstalledSnapshotIndex > 0) {\r\n  LOG.info(\"{}: InstallSnapshot notification result: {}, at index: {}\", getMemberId(),\r\n      InstallSnapshotResult.SNAPSHOT_INSTALLED, latestInstalledSnapshotIndex);\r\n  inProgressInstallSnapshotRequest.compareAndSet(firstAvailableLogTermIndex, null);\r\n  return ServerProtoUtils.toInstallSnapshotReplyProto(leaderId, getMemberId(),\r\n      currentTerm, InstallSnapshotResult.SNAPSHOT_INSTALLED, latestInstalledSnapshotIndex);\r\n}\r\n```\r\ni will fix this in a new commit\r\n\r\n>I don't think this will be so simple. For example, from Ozone perspective, it would not be desirable for an OzoneManager to crash if there was let's say a network blip or something which caused the install snapshot to fail. Shutting down a peer is an extreme step. We should avoid it especially when the peer is not in an inconsistent state and can be recovered.\r\n\r\ncan we use get(long timeout, TimeUnit unit) to wait for a specified duration? what about 10 seconds? if the StateMachine completes the future before the wait is over, we can return the result. Otherwise, we can return IN_PROGRESS notification back to the leader\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/931041413/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/932187265","html_url":"https://github.com/apache/ratis/pull/504#issuecomment-932187265","issue_url":"https://api.github.com/repos/apache/ratis/issues/504","id":932187265,"node_id":"IC_kwDOBMxbGc43kAyB","user":{"login":"JacksonYao287","id":80438902,"node_id":"MDQ6VXNlcjgwNDM4OTAy","avatar_url":"https://avatars.githubusercontent.com/u/80438902?v=4","gravatar_id":"","url":"https://api.github.com/users/JacksonYao287","html_url":"https://github.com/JacksonYao287","followers_url":"https://api.github.com/users/JacksonYao287/followers","following_url":"https://api.github.com/users/JacksonYao287/following{/other_user}","gists_url":"https://api.github.com/users/JacksonYao287/gists{/gist_id}","starred_url":"https://api.github.com/users/JacksonYao287/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JacksonYao287/subscriptions","organizations_url":"https://api.github.com/users/JacksonYao287/orgs","repos_url":"https://api.github.com/users/JacksonYao287/repos","events_url":"https://api.github.com/users/JacksonYao287/events{/privacy}","received_events_url":"https://api.github.com/users/JacksonYao287/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-01T12:29:58Z","updated_at":"2021-10-01T12:29:58Z","author_association":"NONE","body":"@hanishakoneru @szetszwo  i have update this patch according to the comments , please take a look!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/932187265/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/932763083","html_url":"https://github.com/apache/ratis/pull/511#issuecomment-932763083","issue_url":"https://api.github.com/repos/apache/ratis/issues/511","id":932763083,"node_id":"IC_kwDOBMxbGc43mNXL","user":{"login":"maobaolong","id":17329931,"node_id":"MDQ6VXNlcjE3MzI5OTMx","avatar_url":"https://avatars.githubusercontent.com/u/17329931?v=4","gravatar_id":"","url":"https://api.github.com/users/maobaolong","html_url":"https://github.com/maobaolong","followers_url":"https://api.github.com/users/maobaolong/followers","following_url":"https://api.github.com/users/maobaolong/following{/other_user}","gists_url":"https://api.github.com/users/maobaolong/gists{/gist_id}","starred_url":"https://api.github.com/users/maobaolong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maobaolong/subscriptions","organizations_url":"https://api.github.com/users/maobaolong/orgs","repos_url":"https://api.github.com/users/maobaolong/repos","events_url":"https://api.github.com/users/maobaolong/events{/privacy}","received_events_url":"https://api.github.com/users/maobaolong/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-02T14:39:13Z","updated_at":"2021-10-02T14:39:13Z","author_association":"MEMBER","body":"@szetszwo Thanks for your discussion with me in the jira, now I push the ratis-shell as a module, please take a look.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/932763083/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/933112688","html_url":"https://github.com/apache/ratis/pull/509#issuecomment-933112688","issue_url":"https://api.github.com/repos/apache/ratis/issues/509","id":933112688,"node_id":"IC_kwDOBMxbGc43nitw","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-04T03:27:04Z","updated_at":"2021-10-04T03:27:04Z","author_association":"CONTRIBUTOR","body":"@adoroszlai , thanks a lot for reviewing this.  Could you also review the asf-site change #512?","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/933112688/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/934323246","html_url":"https://github.com/apache/ratis/pull/504#issuecomment-934323246","issue_url":"https://api.github.com/repos/apache/ratis/issues/504","id":934323246,"node_id":"IC_kwDOBMxbGc43sKQu","user":{"login":"hanishakoneru","id":10237377,"node_id":"MDQ6VXNlcjEwMjM3Mzc3","avatar_url":"https://avatars.githubusercontent.com/u/10237377?v=4","gravatar_id":"","url":"https://api.github.com/users/hanishakoneru","html_url":"https://github.com/hanishakoneru","followers_url":"https://api.github.com/users/hanishakoneru/followers","following_url":"https://api.github.com/users/hanishakoneru/following{/other_user}","gists_url":"https://api.github.com/users/hanishakoneru/gists{/gist_id}","starred_url":"https://api.github.com/users/hanishakoneru/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hanishakoneru/subscriptions","organizations_url":"https://api.github.com/users/hanishakoneru/orgs","repos_url":"https://api.github.com/users/hanishakoneru/repos","events_url":"https://api.github.com/users/hanishakoneru/events{/privacy}","received_events_url":"https://api.github.com/users/hanishakoneru/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-05T11:30:25Z","updated_at":"2021-10-05T11:30:25Z","author_association":"CONTRIBUTOR","body":"Thank you @JacksonYao287. Latest patch LGTM. +1.\r\nI will commit this shortly.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/934323246/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/934465765","html_url":"https://github.com/apache/ratis/pull/515#issuecomment-934465765","issue_url":"https://api.github.com/repos/apache/ratis/issues/515","id":934465765,"node_id":"IC_kwDOBMxbGc43stDl","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-05T14:29:35Z","updated_at":"2021-10-05T14:29:35Z","author_association":"CONTRIBUTOR","body":"The build.sh script use the link to download RAT sha512.  Sure, let's also update it.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/934465765/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/937564337","html_url":"https://github.com/apache/ratis/pull/508#issuecomment-937564337","issue_url":"https://api.github.com/repos/apache/ratis/issues/508","id":937564337,"node_id":"IC_kwDOBMxbGc434hix","user":{"login":"lokeshj1703","id":9255455,"node_id":"MDQ6VXNlcjkyNTU0NTU=","avatar_url":"https://avatars.githubusercontent.com/u/9255455?v=4","gravatar_id":"","url":"https://api.github.com/users/lokeshj1703","html_url":"https://github.com/lokeshj1703","followers_url":"https://api.github.com/users/lokeshj1703/followers","following_url":"https://api.github.com/users/lokeshj1703/following{/other_user}","gists_url":"https://api.github.com/users/lokeshj1703/gists{/gist_id}","starred_url":"https://api.github.com/users/lokeshj1703/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lokeshj1703/subscriptions","organizations_url":"https://api.github.com/users/lokeshj1703/orgs","repos_url":"https://api.github.com/users/lokeshj1703/repos","events_url":"https://api.github.com/users/lokeshj1703/events{/privacy}","received_events_url":"https://api.github.com/users/lokeshj1703/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-07T08:19:59Z","updated_at":"2021-10-07T08:19:59Z","author_association":"CONTRIBUTOR","body":"This PR would also affect LeaderStateImpl#commitIndexChanged. I feel we do not need the follower gap limitation for updating the watch requests.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/937564337/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/937663839","html_url":"https://github.com/apache/ratis/pull/508#issuecomment-937663839","issue_url":"https://api.github.com/repos/apache/ratis/issues/508","id":937663839,"node_id":"IC_kwDOBMxbGc43451f","user":{"login":"kaijchen","id":5821159,"node_id":"MDQ6VXNlcjU4MjExNTk=","avatar_url":"https://avatars.githubusercontent.com/u/5821159?v=4","gravatar_id":"","url":"https://api.github.com/users/kaijchen","html_url":"https://github.com/kaijchen","followers_url":"https://api.github.com/users/kaijchen/followers","following_url":"https://api.github.com/users/kaijchen/following{/other_user}","gists_url":"https://api.github.com/users/kaijchen/gists{/gist_id}","starred_url":"https://api.github.com/users/kaijchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaijchen/subscriptions","organizations_url":"https://api.github.com/users/kaijchen/orgs","repos_url":"https://api.github.com/users/kaijchen/repos","events_url":"https://api.github.com/users/kaijchen/events{/privacy}","received_events_url":"https://api.github.com/users/kaijchen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-07T10:30:25Z","updated_at":"2021-10-07T10:30:25Z","author_association":"CONTRIBUTOR","body":"Good catch.\r\nHowever, I don't feel this is a perfect solution in general case because it may stall the leader. (that's why we need the switch)\r\n\r\nDo you think keeping some cache for the slowest follower will work?\r\nWe can adjust the ratio of **cache for slowest follower** vs **cache for latest entries** to control the flow rates.\r\nIf the slowest follower is making progress, we increase the ratio to let it catch up.\r\nIf the slowest follower is not responding, we decrease the ratio so there is little impact for leader to make progress.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/937663839/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/938307954","html_url":"https://github.com/apache/ratis/pull/508#issuecomment-938307954","issue_url":"https://api.github.com/repos/apache/ratis/issues/508","id":938307954,"node_id":"IC_kwDOBMxbGc437XFy","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-08T03:22:38Z","updated_at":"2021-10-08T03:22:38Z","author_association":"CONTRIBUTOR","body":"Thanks @szetszwo and @bshashikant for the code review. ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/938307954/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/938309351","html_url":"https://github.com/apache/ratis/pull/506#issuecomment-938309351","issue_url":"https://api.github.com/repos/apache/ratis/issues/506","id":938309351,"node_id":"IC_kwDOBMxbGc437Xbn","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-08T03:27:15Z","updated_at":"2021-10-08T03:27:15Z","author_association":"CONTRIBUTOR","body":"Hi @szetszwo and @bshashikant , could you take a look at this patch.  These two metrics are mainly used to meature the read/write smooth of Ozone. ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/938309351/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/938378246","html_url":"https://github.com/apache/ratis/pull/508#issuecomment-938378246","issue_url":"https://api.github.com/repos/apache/ratis/issues/508","id":938378246,"node_id":"IC_kwDOBMxbGc437oQG","user":{"login":"lokeshj1703","id":9255455,"node_id":"MDQ6VXNlcjkyNTU0NTU=","avatar_url":"https://avatars.githubusercontent.com/u/9255455?v=4","gravatar_id":"","url":"https://api.github.com/users/lokeshj1703","html_url":"https://github.com/lokeshj1703","followers_url":"https://api.github.com/users/lokeshj1703/followers","following_url":"https://api.github.com/users/lokeshj1703/following{/other_user}","gists_url":"https://api.github.com/users/lokeshj1703/gists{/gist_id}","starred_url":"https://api.github.com/users/lokeshj1703/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lokeshj1703/subscriptions","organizations_url":"https://api.github.com/users/lokeshj1703/orgs","repos_url":"https://api.github.com/users/lokeshj1703/repos","events_url":"https://api.github.com/users/lokeshj1703/events{/privacy}","received_events_url":"https://api.github.com/users/lokeshj1703/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-08T06:23:04Z","updated_at":"2021-10-08T06:23:04Z","author_association":"CONTRIBUTOR","body":"I think there are a couple of problems with having two caches.\r\n1. There might be some entries which are shared between these two caches.\r\n2. Let's consider a scenario where lag is larger around 10k and slow follower cache can support 1k entries. In this case the rest 9k entries would still be read from disk.\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/938378246/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/939242357","html_url":"https://github.com/apache/ratis/pull/508#issuecomment-939242357","issue_url":"https://api.github.com/repos/apache/ratis/issues/508","id":939242357,"node_id":"IC_kwDOBMxbGc43-7N1","user":{"login":"kaijchen","id":5821159,"node_id":"MDQ6VXNlcjU4MjExNTk=","avatar_url":"https://avatars.githubusercontent.com/u/5821159?v=4","gravatar_id":"","url":"https://api.github.com/users/kaijchen","html_url":"https://github.com/kaijchen","followers_url":"https://api.github.com/users/kaijchen/followers","following_url":"https://api.github.com/users/kaijchen/following{/other_user}","gists_url":"https://api.github.com/users/kaijchen/gists{/gist_id}","starred_url":"https://api.github.com/users/kaijchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaijchen/subscriptions","organizations_url":"https://api.github.com/users/kaijchen/orgs","repos_url":"https://api.github.com/users/kaijchen/repos","events_url":"https://api.github.com/users/kaijchen/events{/privacy}","received_events_url":"https://api.github.com/users/kaijchen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-09T06:57:02Z","updated_at":"2021-10-09T06:57:02Z","author_association":"CONTRIBUTOR","body":"@lokeshj1703 Yes. I was aware of the same problems. Seems we can't set the priorities just by cache.\r\n\r\n> This PR would also affect LeaderStateImpl#commitIndexChanged. I feel we do not need the follower gap limitation for updating the watch requests.\r\n\r\n+1 on this.\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/939242357/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/939397494","html_url":"https://github.com/apache/ratis/pull/511#issuecomment-939397494","issue_url":"https://api.github.com/repos/apache/ratis/issues/511","id":939397494,"node_id":"IC_kwDOBMxbGc43_hF2","user":{"login":"maobaolong","id":17329931,"node_id":"MDQ6VXNlcjE3MzI5OTMx","avatar_url":"https://avatars.githubusercontent.com/u/17329931?v=4","gravatar_id":"","url":"https://api.github.com/users/maobaolong","html_url":"https://github.com/maobaolong","followers_url":"https://api.github.com/users/maobaolong/followers","following_url":"https://api.github.com/users/maobaolong/following{/other_user}","gists_url":"https://api.github.com/users/maobaolong/gists{/gist_id}","starred_url":"https://api.github.com/users/maobaolong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maobaolong/subscriptions","organizations_url":"https://api.github.com/users/maobaolong/orgs","repos_url":"https://api.github.com/users/maobaolong/repos","events_url":"https://api.github.com/users/maobaolong/events{/privacy}","received_events_url":"https://api.github.com/users/maobaolong/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-10T03:05:56Z","updated_at":"2021-10-10T03:05:56Z","author_association":"MEMBER","body":"ping @szetszwo ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/939397494/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/939916097","html_url":"https://github.com/apache/ratis/pull/511#issuecomment-939916097","issue_url":"https://api.github.com/repos/apache/ratis/issues/511","id":939916097,"node_id":"IC_kwDOBMxbGc44BftB","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-11T10:54:02Z","updated_at":"2021-10-11T10:54:02Z","author_association":"CONTRIBUTOR","body":"@maobaolong , please start a discussion on the dev@ratis.apache.org mailing list.  We should ask more people to review this.  Thanks.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/939916097/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/942013097","html_url":"https://github.com/apache/ratis/pull/518#issuecomment-942013097","issue_url":"https://api.github.com/repos/apache/ratis/issues/518","id":942013097,"node_id":"IC_kwDOBMxbGc44Jfqp","user":{"login":"bshashikant","id":31469764,"node_id":"MDQ6VXNlcjMxNDY5NzY0","avatar_url":"https://avatars.githubusercontent.com/u/31469764?v=4","gravatar_id":"","url":"https://api.github.com/users/bshashikant","html_url":"https://github.com/bshashikant","followers_url":"https://api.github.com/users/bshashikant/followers","following_url":"https://api.github.com/users/bshashikant/following{/other_user}","gists_url":"https://api.github.com/users/bshashikant/gists{/gist_id}","starred_url":"https://api.github.com/users/bshashikant/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bshashikant/subscriptions","organizations_url":"https://api.github.com/users/bshashikant/orgs","repos_url":"https://api.github.com/users/bshashikant/repos","events_url":"https://api.github.com/users/bshashikant/events{/privacy}","received_events_url":"https://api.github.com/users/bshashikant/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-13T07:35:53Z","updated_at":"2021-10-13T07:35:53Z","author_association":"CONTRIBUTOR","body":"@ChenSammi / @szetszwo , can you have a look as well?","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/942013097/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/942946344","html_url":"https://github.com/apache/ratis/pull/511#issuecomment-942946344","issue_url":"https://api.github.com/repos/apache/ratis/issues/511","id":942946344,"node_id":"IC_kwDOBMxbGc44NDgo","user":{"login":"maobaolong","id":17329931,"node_id":"MDQ6VXNlcjE3MzI5OTMx","avatar_url":"https://avatars.githubusercontent.com/u/17329931?v=4","gravatar_id":"","url":"https://api.github.com/users/maobaolong","html_url":"https://github.com/maobaolong","followers_url":"https://api.github.com/users/maobaolong/followers","following_url":"https://api.github.com/users/maobaolong/following{/other_user}","gists_url":"https://api.github.com/users/maobaolong/gists{/gist_id}","starred_url":"https://api.github.com/users/maobaolong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maobaolong/subscriptions","organizations_url":"https://api.github.com/users/maobaolong/orgs","repos_url":"https://api.github.com/users/maobaolong/repos","events_url":"https://api.github.com/users/maobaolong/events{/privacy}","received_events_url":"https://api.github.com/users/maobaolong/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-14T04:55:19Z","updated_at":"2021-10-14T04:55:19Z","author_association":"MEMBER","body":" @szetszwo I have sent an email to dev mail list of ratis, please take a look, thank you!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/942946344/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/948356846","html_url":"https://github.com/apache/ratis/pull/518#issuecomment-948356846","issue_url":"https://api.github.com/repos/apache/ratis/issues/518","id":948356846,"node_id":"IC_kwDOBMxbGc44hsbu","user":{"login":"lokeshj1703","id":9255455,"node_id":"MDQ6VXNlcjkyNTU0NTU=","avatar_url":"https://avatars.githubusercontent.com/u/9255455?v=4","gravatar_id":"","url":"https://api.github.com/users/lokeshj1703","html_url":"https://github.com/lokeshj1703","followers_url":"https://api.github.com/users/lokeshj1703/followers","following_url":"https://api.github.com/users/lokeshj1703/following{/other_user}","gists_url":"https://api.github.com/users/lokeshj1703/gists{/gist_id}","starred_url":"https://api.github.com/users/lokeshj1703/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lokeshj1703/subscriptions","organizations_url":"https://api.github.com/users/lokeshj1703/orgs","repos_url":"https://api.github.com/users/lokeshj1703/repos","events_url":"https://api.github.com/users/lokeshj1703/events{/privacy}","received_events_url":"https://api.github.com/users/lokeshj1703/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-21T07:59:04Z","updated_at":"2021-10-21T07:59:04Z","author_association":"CONTRIBUTOR","body":"Thanks @szetszwo! I have addressed the review comments.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/948356846/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/948794980","html_url":"https://github.com/apache/ratis/pull/519#issuecomment-948794980","issue_url":"https://api.github.com/repos/apache/ratis/issues/519","id":948794980,"node_id":"IC_kwDOBMxbGc44jXZk","user":{"login":"avijayanhwx","id":14299376,"node_id":"MDQ6VXNlcjE0Mjk5Mzc2","avatar_url":"https://avatars.githubusercontent.com/u/14299376?v=4","gravatar_id":"","url":"https://api.github.com/users/avijayanhwx","html_url":"https://github.com/avijayanhwx","followers_url":"https://api.github.com/users/avijayanhwx/followers","following_url":"https://api.github.com/users/avijayanhwx/following{/other_user}","gists_url":"https://api.github.com/users/avijayanhwx/gists{/gist_id}","starred_url":"https://api.github.com/users/avijayanhwx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/avijayanhwx/subscriptions","organizations_url":"https://api.github.com/users/avijayanhwx/orgs","repos_url":"https://api.github.com/users/avijayanhwx/repos","events_url":"https://api.github.com/users/avijayanhwx/events{/privacy}","received_events_url":"https://api.github.com/users/avijayanhwx/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-21T16:47:27Z","updated_at":"2021-10-21T16:47:27Z","author_association":"CONTRIBUTOR","body":"Thanks for the review @mukul1987.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/948794980/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/956007154","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-956007154","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":956007154,"node_id":"IC_kwDOBMxbGc44-4Ly","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-01T07:49:13Z","updated_at":"2021-11-01T07:49:13Z","author_association":"CONTRIBUTOR","body":"The two failed UT  org.apache.ratis.datastream.TestNettyDataStreamStarTopologyWithGrpcCluster and \r\norg.apache.ratis.datastream.TestNettyDataStreamChainTopologyWithGrpcCluster are because of timeout.\r\n\r\nThey all passed locally in my developer server. ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/956007154/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/956079010","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-956079010","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":956079010,"node_id":"IC_kwDOBMxbGc44_Jui","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-01T09:39:34Z","updated_at":"2021-11-01T09:39:34Z","author_association":"CONTRIBUTOR","body":"@ChenSammi , If we use getLastRpcResponseTime() instead of getLastRpcTime(), then Leader may send multiple heartbeats to a follower -- the LastRpcResponseTime won't be updated after the Leader sent a heartbeat. The Leader will send another heartbeat when it checks again.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/956079010/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957166600","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-957166600","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":957166600,"node_id":"IC_kwDOBMxbGc45DTQI","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-02T07:34:08Z","updated_at":"2021-11-02T07:41:49Z","author_association":"CONTRIBUTOR","body":"> \r\n> \r\n> @ChenSammi , If we use getLastRpcResponseTime() instead of getLastRpcTime(), then Leader may send multiple heartbeats to a follower -- the LastRpcResponseTime won't be updated after the Leader sent a heartbeat. The Leader will send another heartbeat when it checks again.\r\n\r\nIn the current implemeation, on one side,  leader will step down when it doesn't recevie any rpc from follower in maxTimeoutMs based on follower's lastRpcResponseTime.\r\nOn the other side, grpcLogAppender decides to send out heartbeat based on the the lastRpcResponseTime and lastRpcSendTime, takes the late one, which makes heartbeat is not sent out promptly in some cases.  And a follower will reponse heartbeat message immediately so that heartbeat response time is garanteed.  While the response of data message depends on the follower busy state and is not predicatable. That's the issue. \r\n\r\nThe leader step down criterion and grpcLogAppender heartbeat sent out criterion doesn't match. \r\n\r\nIn the test with high concurency write, the leader stepped down because of no rpc response from two followers. The leader have sent out a lot data messages, these messages are queued on follower, waiting to be handled.  So there is no rpc response during this period.  \r\n@szetszwo  you can refer to the LOG messages in the JIRA description. \r\n\r\nThe leader relection causes an obvious impact on write latency and writh throughput.  With this patch, the leader is very stable and the write is more smooth. \r\n\r\nYes, there is chance that Leader will send another heartbeat out when the follower response doesn't arrive before leader's next check.  It's depends on how fequent the leader checks.  To elimicate the heartbeat resend in a short time, we can have a short wait peiod.  \r\nAnother way I can think about is we use two set of rpcSent/rpcResponse indicators, for heartbeat and message. Leader step down and heartbeat send decision all use heartbeat rpcSent/rpcResponse as crioterion with scheduled fixed timing.  The solution requires a bigger scope code change.   What do you think? \r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957166600/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957179745","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-957179745","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":957179745,"node_id":"IC_kwDOBMxbGc45DWdh","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-02T07:58:30Z","updated_at":"2021-11-02T07:58:30Z","author_association":"CONTRIBUTOR","body":"> ...  To elimicate the heartbeat resend in a short time, we can have a short wait peiod. ...\r\n\r\nIt is a good idea.  How about the following approach?\r\n```\r\n  default long getHeartbeatRemainingTimeMs() {\r\n    final int min = getServer().properties().minRpcTimeoutMs();\r\n    final long rpcElapsed = getFollower().getLastRpcTime().elapsedTimeMs();\r\n    if (rpcElapsed > min/4) {\r\n      return min/2 - getFollower().getLastRpcResponseTime().elapsedTimeMs();\r\n    } else {\r\n      return min/2 - rpcElapsed;\r\n    }\r\n  }\r\n```\r\n\r\n> ... Leader step down and heartbeat send decision all use heartbeat rpcSent/rpcResponse as crioterion with scheduled fixed timing. The solution requires a bigger scope code change. What do you think?\r\n\r\nThis is similar to HDFS lifeline.  If there is a need, we can also implement it.\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957179745/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957229572","html_url":"https://github.com/apache/ratis/pull/520#issuecomment-957229572","issue_url":"https://api.github.com/repos/apache/ratis/issues/520","id":957229572,"node_id":"IC_kwDOBMxbGc45DioE","user":{"login":"JacksonYao287","id":80438902,"node_id":"MDQ6VXNlcjgwNDM4OTAy","avatar_url":"https://avatars.githubusercontent.com/u/80438902?v=4","gravatar_id":"","url":"https://api.github.com/users/JacksonYao287","html_url":"https://github.com/JacksonYao287","followers_url":"https://api.github.com/users/JacksonYao287/followers","following_url":"https://api.github.com/users/JacksonYao287/following{/other_user}","gists_url":"https://api.github.com/users/JacksonYao287/gists{/gist_id}","starred_url":"https://api.github.com/users/JacksonYao287/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JacksonYao287/subscriptions","organizations_url":"https://api.github.com/users/JacksonYao287/orgs","repos_url":"https://api.github.com/users/JacksonYao287/repos","events_url":"https://api.github.com/users/JacksonYao287/events{/privacy}","received_events_url":"https://api.github.com/users/JacksonYao287/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-02T08:48:19Z","updated_at":"2021-11-02T08:48:19Z","author_association":"NONE","body":"@hanishakoneru @szetszwo PTAL!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957229572/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957243371","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-957243371","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":957243371,"node_id":"IC_kwDOBMxbGc45Dl_r","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-02T09:06:37Z","updated_at":"2021-11-02T09:37:24Z","author_association":"CONTRIBUTOR","body":"\r\n\r\n> It is a good idea. How about the following approach?\r\n> \r\n> ```\r\n>   default long getHeartbeatRemainingTimeMs() {\r\n>     final int min = getServer().properties().minRpcTimeoutMs();\r\n>     final long rpcElapsed = getFollower().getLastRpcTime().elapsedTimeMs();\r\n>     if (rpcElapsed > min/4) {\r\n>       return min/2 - getFollower().getLastRpcResponseTime().elapsedTimeMs();\r\n>     } else {\r\n>       return min/2 - rpcElapsed;\r\n>     }\r\n>   }\r\n> ```\r\n\r\n@szetszwo , thanks for the proposal. But it seems this doesn't work.  When leader keeps sending data messages,  getLastRpcTime gets updated very frequently.  In this case, it will go with the \"else\" branch, just as the current code. \r\n\r\nHere are the logs from the test.   The lastRpcSendTime is very small when leader steps down. \r\n\r\n2021-10-27 15:42:24,241 [2b5298c6-78ea-470f-a1f0-4db4e3f5a6e7@group-439523F2EE8A-LeaderStateImpl] WARN org.apache.ratis.server.RaftServer$Division: Follower 2b5298c6-78ea-470f-a1f0-4db4e3f5a6e7@group-439523F2EE8A->f2a076b3-3b3d-479e-94f7-a9d8021f31ef(c2,m2,n3, attendVote=true, lastRpcSendTime=305, lastRpcResponseTime=10150)\r\n\r\n2021-10-27 15:42:24,241 [2b5298c6-78ea-470f-a1f0-4db4e3f5a6e7@group-439523F2EE8A-LeaderStateImpl] WARN org.apache.ratis.server.RaftServer$Division: Follower 2b5298c6-78ea-470f-a1f0-4db4e3f5a6e7@group-439523F2EE8A->7219573a-06d6-4883-8b71-d6d676bf2240(c2,m2,n3, attendVote=true, lastRpcSendTime=1126, lastRpcResponseTime=27656)\r\n\r\nLet me try to implement the other solution. \r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957243371/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957343313","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-957343313","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":957343313,"node_id":"IC_kwDOBMxbGc45D-ZR","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-02T11:13:59Z","updated_at":"2021-11-02T11:13:59Z","author_association":"CONTRIBUTOR","body":"I see.  Than, how about we add a new getLastHeartbeatTime() and use it as below?\r\n```\r\n  default long getHeartbeatRemainingTimeMs() {\r\n    final int min = getServer().properties().minRpcTimeoutMs();\r\n    if (getFollower().getLastHeartbeatTime().elapsedTimeMs() > min/4) {\r\n      return min/2 - getFollower().getLastRpcResponseTime().elapsedTimeMs();\r\n    } else {\r\n      return min/2 - getFollower().getLastRpcTime().elapsedTimeMs();\r\n    }\r\n  }\r\n```","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957343313/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957355132","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-957355132","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":957355132,"node_id":"IC_kwDOBMxbGc45EBR8","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-02T11:31:56Z","updated_at":"2021-11-02T11:31:56Z","author_association":"CONTRIBUTOR","body":"> elapsedTimeMs\r\n\r\n\r\n\r\n> I see. Than, how about we add a new getLastHeartbeatTime() and use it as below?\r\n> \r\n> ```\r\n>   default long getHeartbeatRemainingTimeMs() {\r\n>     final int min = getServer().properties().minRpcTimeoutMs();\r\n>     if (getFollower().getLastHeartbeatTime().elapsedTimeMs() > min/4) {\r\n>       return min/2 - getFollower().getLastRpcResponseTime().elapsedTimeMs();\r\n>     } else {\r\n>       return min/2 - getFollower().getLastRpcTime().elapsedTimeMs();\r\n>     }\r\n>   }\r\n> ```\r\n\r\nHere getLastHeartbeatTime means heartbeat sent or received time? ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957355132/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957359042","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-957359042","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":957359042,"node_id":"IC_kwDOBMxbGc45ECPC","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-02T11:38:23Z","updated_at":"2021-11-02T11:38:23Z","author_association":"CONTRIBUTOR","body":"> Here getLastHeartbeatTime means heartbeat sent or received time?\r\n\r\nI mean \"sent\", ie. getLastHeartbeatSendTime().","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957359042/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957388891","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-957388891","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":957388891,"node_id":"IC_kwDOBMxbGc45EJhb","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-02T12:00:01Z","updated_at":"2021-11-02T12:00:01Z","author_association":"CONTRIBUTOR","body":"getHeartbeatRemainingTimeMs() is used in many places, not just deciding whether to sent out the heartbeat.  And since the issue of this patch is leader may send consecutive heartbeats, how about change the    \r\n   if (heartbeatRemainingMs <= 0L || heartbeat) {\r\n\r\nin  LogAppenderBase#newAppendEntriesRequest to \r\n\r\n     if ((heartbeatRemainingMs <= 0L && getLastHeartbeatSendTime > min/4) || heartbeat) {\r\n\r\n? ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957388891/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957407016","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-957407016","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":957407016,"node_id":"IC_kwDOBMxbGc45EN8o","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-02T12:08:38Z","updated_at":"2021-11-02T12:08:38Z","author_association":"CONTRIBUTOR","body":"@szetszwo ,  we have seen many following logs in our cluster, \r\n\r\n2021-11-02 20:03:02,656 [java.util.concurrent.ThreadPoolExecutor$Worker@1f15dee2[State = -1, empty queue]] WARN org.apache.ratis.grpc.server.GrpcLogAppender: 5ae37fea-d3a9-4dbe-9188-4ffc88b389db@group-84BBDCF0D2B8->b298769f-bdf0-4497-bda1-50ec86019935-GrpcLogAppender:  appendEntries Timeout, request=AppendEntriesRequest:cid=1246,entriesCount=1,lastEntry=(t:1, i:93)\r\n\r\nThe handling of timeout in GrpcLogAppender is remove the request from the either heartbeats or logRequests map. I don't find any where the logRequests be retried.  Will it cause data loss on the follower?  ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957407016/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957872946","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-957872946","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":957872946,"node_id":"IC_kwDOBMxbGc45F_sy","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-02T15:54:00Z","updated_at":"2021-11-02T15:54:00Z","author_association":"CONTRIBUTOR","body":"> ... I don't find any where the logRequests be retried. Will it cause data loss on the follower?\r\n\r\nThe AppendEntries algorithm will negotiate the next entry.  So it won't cause data loss.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957872946/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957876719","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-957876719","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":957876719,"node_id":"IC_kwDOBMxbGc45GAnv","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-02T15:58:04Z","updated_at":"2021-11-02T15:58:04Z","author_association":"CONTRIBUTOR","body":"> in LogAppenderBase#newAppendEntriesRequest to\r\n> \r\n> ```\r\n>  if ((heartbeatRemainingMs <= 0L && getLastHeartbeatSendTime > min/4) || heartbeat) {\r\n> ```\r\n> \r\n> ?\r\n\r\nSure, it looks good.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/957876719/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/958773914","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-958773914","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":958773914,"node_id":"IC_kwDOBMxbGc45Jbqa","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-03T09:23:18Z","updated_at":"2021-11-03T09:23:18Z","author_association":"CONTRIBUTOR","body":"> \r\n> \r\n> > in LogAppenderBase#newAppendEntriesRequest to\r\n> > ```\r\n> >  if ((heartbeatRemainingMs <= 0L && getLastHeartbeatSendTime > min/4) || heartbeat) {\r\n> > ```\r\n> > \r\n> > \r\n> >     \r\n> >       \r\n> >     \r\n> > \r\n> >       \r\n> >     \r\n> > \r\n> >     \r\n> >   \r\n> > ?\r\n> \r\n> Sure, it looks good.\r\n\r\nThanks @szetszwo ， I have uploaded a new commit, and also tested it the test cluster. ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/958773914/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960369199","html_url":"https://github.com/apache/ratis/pull/523#issuecomment-960369199","issue_url":"https://api.github.com/repos/apache/ratis/issues/523","id":960369199,"node_id":"IC_kwDOBMxbGc45PhIv","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-04T01:52:29Z","updated_at":"2021-11-04T01:52:29Z","author_association":"CONTRIBUTOR","body":"Thanks @szetszwo  for the code review. ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960369199/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960451434","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-960451434","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":960451434,"node_id":"IC_kwDOBMxbGc45P1Nq","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-04T04:30:22Z","updated_at":"2021-11-04T04:30:22Z","author_association":"CONTRIBUTOR","body":"@ChenSammi , the latest change look good.  However, the following two tests keep failing even I have re-run the jobs many times.  Let's re-run again.\r\n- org.apache.ratis.grpc.TestGrpcOutputStream\r\n- org.apache.ratis.grpc.TestRaftOutputStreamWithGrpc","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960451434/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960476895","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-960476895","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":960476895,"node_id":"IC_kwDOBMxbGc45P7bf","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-04T05:51:44Z","updated_at":"2021-11-04T05:51:44Z","author_association":"CONTRIBUTOR","body":"I also can reproduce the failure when I repeatedly run the tests.    ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960476895/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960514187","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-960514187","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":960514187,"node_id":"IC_kwDOBMxbGc45QEiL","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-04T07:23:26Z","updated_at":"2021-11-04T07:23:26Z","author_association":"CONTRIBUTOR","body":"It seems that GrpcLogAppender.mayWait() won't wait when (heartbeatRemainingMs <= 0L && getLastHeartbeatSendTime > min/4).  Then, it will loop back without any waiting, i.e. busy waiting.\r\n\r\nA similar problem also in LogAppenderDefault.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960514187/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960516255","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-960516255","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":960516255,"node_id":"IC_kwDOBMxbGc45QFCf","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-04T07:28:16Z","updated_at":"2021-11-04T07:28:16Z","author_association":"CONTRIBUTOR","body":"Let's change getHeartbeatRemainingTimeMs() to getHeartbeatWaitTimeMs() in order to incorporate the \"no heartbeat time\".  Below is the new getHeartbeatWaitTimeMs() method.\r\n```\r\n//LogAppender.java\r\n  /** @return the wait time in milliseconds to send the next heartbeat. */\r\n  default long getHeartbeatWaitTimeMs() {\r\n    final int min = getServer().properties().minRpcTimeoutMs();\r\n    // time remaining to send a heartbeat\r\n    final long heartbeatRemainingTimeMs = min/2 - getFollower().getLastRpcResponseTime().elapsedTimeMs();\r\n    // avoid sending heartbeat too frequently\r\n    final long noHeartbeatTimeMs = min/4 - getFollower().getLastHeartbeatSendTime().elapsedTimeMs();\r\n    return Math.max(heartbeatRemainingTimeMs, noHeartbeatTimeMs);\r\n  }\r\n```\r\nSee also https://issues.apache.org/jira/secure/attachment/13035675/getHeartbeatWaitTimeMs.patch for the suggest changes.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960516255/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960617077","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-960617077","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":960617077,"node_id":"IC_kwDOBMxbGc45Qdp1","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-04T10:11:01Z","updated_at":"2021-11-04T10:11:01Z","author_association":"CONTRIBUTOR","body":" \r\n> See also https://issues.apache.org/jira/secure/attachment/13035675/getHeartbeatWaitTimeMs.patch for the suggest changes.\r\n\r\nIt's a very good solution.  Will try it now.\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/960617077/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961003353","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-961003353","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":961003353,"node_id":"IC_kwDOBMxbGc45R79Z","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-04T14:04:48Z","updated_at":"2021-11-04T14:04:48Z","author_association":"CONTRIBUTOR","body":"There are one more issues.  I will update the patch tomorrow. ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961003353/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961617974","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-961617974","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":961617974,"node_id":"IC_kwDOBMxbGc45USA2","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-05T04:23:04Z","updated_at":"2021-11-05T04:23:32Z","author_association":"CONTRIBUTOR","body":"@szetszwo ,  I did a little change based on the suggest changes,  removed the getHeartbeatWaitTimeMs override in grpcLogAppender, changed its name back to getWaitTimeMs.  \r\n\r\nThe getHeartbeatWaitTimeMs override in grpcLogAppender will cause heartbeatWaitTimeMs always 0 in LogAppenderBase when pipeline starts.\r\n\r\n```\r\n final long heartbeatWaitTimeMs = getHeartbeatWaitTimeMs();\r\n    if (heartbeatWaitTimeMs <= 0L || heartbeat) {\r\n```\r\n\r\nBecause heartbeatWaitTimeMs executed is the one in grpcLogAppender.  When there is no pending packages at pipeline starts,  it alwasy go branch \r\n\r\n```\r\n } else if (shouldSendAppendEntries()) {\r\n      return 0L;\r\n }\r\n```\r\n\r\nleads to repeatedly send out heartbeat without any interval, which cause netty direct memory allocation failure. \r\n\r\n```\r\n2021-11-04 18:37:29,694 [f47cbe99-fe75-4f6d-8313-5c623040b598@group-F3AB210575B1->b298769f-bdf0-4497-bda1-50ec86019935-GrpcLogAppender-LogAppenderDaemon] ERROR org.apache.ratis.server.leader.LogAppenderDaemon: f47cbe99-fe75-4f6d-8313-5c623040b598@group-F3AB210575B1->b298769f-bdf0-4497-bda1-50ec86019935-GrpcLogAppender-LogAppenderDaemon failed\r\norg.apache.ratis.thirdparty.io.netty.util.internal.OutOfDirectMemoryError: failed to allocate 2097152 byte(s) of direct memory (used: 31052529943, max: 31054233600)\r\n        at org.apache.ratis.thirdparty.io.netty.util.internal.PlatformDependent.incrementMemoryCounter(PlatformDependent.java:802)\r\n        at org.apache.ratis.thirdparty.io.netty.util.internal.PlatformDependent.allocateDirectNoCleaner(PlatformDependent.java:731)\r\n        at org.apache.ratis.thirdparty.io.netty.buffer.PoolArena$DirectArena.allocateDirect(PoolArena.java:632)\r\n        at org.apache.ratis.thirdparty.io.netty.buffer.PoolArena$DirectArena.newChunk(PoolArena.java:607)\r\n        at org.apache.ratis.thirdparty.io.netty.buffer.PoolArena.allocateNormal(PoolArena.java:202)\r\n        at org.apache.ratis.thirdparty.io.netty.buffer.PoolArena.tcacheAllocateSmall(PoolArena.java:172)\r\n        at org.apache.ratis.thirdparty.io.netty.buffer.PoolArena.allocate(PoolArena.java:134)\r\n        at org.apache.ratis.thirdparty.io.netty.buffer.PoolArena.allocate(PoolArena.java:126)\r\n        at org.apache.ratis.thirdparty.io.netty.buffer.PooledByteBufAllocator.newDirectBuffer(PooledByteBufAllocator.java:395)\r\n        at org.apache.ratis.thirdparty.io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:187)\r\n        at org.apache.ratis.thirdparty.io.netty.buffer.AbstractByteBufAllocator.buffer(AbstractByteBufAllocator.java:123)\r\n        at org.apache.ratis.thirdparty.io.grpc.netty.NettyWritableBufferAllocator.allocate(NettyWritableBufferAllocator.java:51)\r\n        at org.apache.ratis.thirdparty.io.grpc.internal.MessageFramer.writeKnownLengthUncompressed(MessageFramer.java:227)\r\n        at org.apache.ratis.thirdparty.io.grpc.internal.MessageFramer.writeUncompressed(MessageFramer.java:168)\r\n        at org.apache.ratis.thirdparty.io.grpc.internal.MessageFramer.writePayload(MessageFramer.java:141)\r\n        at org.apache.ratis.thirdparty.io.grpc.internal.AbstractStream.writeMessage(AbstractStream.java:65)\r\n        at org.apache.ratis.thirdparty.io.grpc.internal.ForwardingClientStream.writeMessage(ForwardingClientStream.java:37)\r\n        at org.apache.ratis.thirdparty.io.grpc.internal.ClientCallImpl.sendMessageInternal(ClientCallImpl.java:579)\r\n        at org.apache.ratis.thirdparty.io.grpc.internal.ClientCallImpl.sendMessage(ClientCallImpl.java:563)\r\n        at org.apache.ratis.thirdparty.io.grpc.stub.ClientCalls$CallToStreamObserverAdapter.onNext(ClientCalls.java:364)\r\n        at org.apache.ratis.grpc.server.GrpcLogAppender.sendRequest(GrpcLogAppender.java:237)\r\n        at org.apache.ratis.grpc.server.GrpcLogAppender.appendLog(GrpcLogAppender.java:228)\r\n        at org.apache.ratis.grpc.server.GrpcLogAppender.run(GrpcLogAppender.java:147)\r\n        at org.apache.ratis.server.leader.LogAppenderDaemon.run(LogAppenderDaemon.java:77)\r\n        at java.lang.Thread.run(Thread.java:748)\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961617974/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961642702","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-961642702","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":961642702,"node_id":"IC_kwDOBMxbGc45UYDO","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-05T05:46:07Z","updated_at":"2021-11-05T05:46:07Z","author_association":"CONTRIBUTOR","body":"> ..., removed the getHeartbeatWaitTimeMs override in grpcLogAppender, changed its name back to getWaitTimeMs.\r\n\r\nGood catch!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961642702/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961644603","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-961644603","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":961644603,"node_id":"IC_kwDOBMxbGc45UYg7","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-05T05:52:39Z","updated_at":"2021-11-05T05:52:39Z","author_association":"CONTRIBUTOR","body":"The failed UT TestInstallSnapshotNotificationWithGrpc is reproduced locally. I 'm checking if it's related or not. ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961644603/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961773655","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-961773655","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":961773655,"node_id":"IC_kwDOBMxbGc45U4BX","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-05T10:14:40Z","updated_at":"2021-11-05T10:17:50Z","author_association":"CONTRIBUTOR","body":"TestInstallSnapshotNotificationWithGrpc failure is mostly caused by the issue in shouldNotifyToInstallSnapshot(), which returns an null TermIndex,  then skip the installSnapshot(),  go to send message with Index 0.  \r\nThis Index 0 entry cannot be found, which triggers grpcLogAppender restart. (Why Index 0 is not found in this snapshot taken case is still not clear to me?)\r\n\r\n@szetszwo , shall I open a new JIRA for this？\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961773655/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961784678","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-961784678","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":961784678,"node_id":"IC_kwDOBMxbGc45U6tm","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-05T10:32:28Z","updated_at":"2021-11-05T10:32:28Z","author_association":"CONTRIBUTOR","body":"> ..., shall I open a new JIRA for this？\r\n\r\nSure, please feel free to file a JIRA.  Thanks.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961784678/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961788457","html_url":"https://github.com/apache/ratis/pull/521#issuecomment-961788457","issue_url":"https://api.github.com/repos/apache/ratis/issues/521","id":961788457,"node_id":"IC_kwDOBMxbGc45U7op","user":{"login":"ChenSammi","id":19790142,"node_id":"MDQ6VXNlcjE5NzkwMTQy","avatar_url":"https://avatars.githubusercontent.com/u/19790142?v=4","gravatar_id":"","url":"https://api.github.com/users/ChenSammi","html_url":"https://github.com/ChenSammi","followers_url":"https://api.github.com/users/ChenSammi/followers","following_url":"https://api.github.com/users/ChenSammi/following{/other_user}","gists_url":"https://api.github.com/users/ChenSammi/gists{/gist_id}","starred_url":"https://api.github.com/users/ChenSammi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChenSammi/subscriptions","organizations_url":"https://api.github.com/users/ChenSammi/orgs","repos_url":"https://api.github.com/users/ChenSammi/repos","events_url":"https://api.github.com/users/ChenSammi/events{/privacy}","received_events_url":"https://api.github.com/users/ChenSammi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-05T10:38:23Z","updated_at":"2021-11-05T10:39:51Z","author_association":"CONTRIBUTOR","body":"Thanks @szetszwo for all the proposal and code review.  The shouldNotifyToInstallSnapshot is merged together. ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/961788457/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/962458372","html_url":"https://github.com/apache/ratis/pull/525#issuecomment-962458372","issue_url":"https://api.github.com/repos/apache/ratis/issues/525","id":962458372,"node_id":"IC_kwDOBMxbGc45XfME","user":{"login":"maobaolong","id":17329931,"node_id":"MDQ6VXNlcjE3MzI5OTMx","avatar_url":"https://avatars.githubusercontent.com/u/17329931?v=4","gravatar_id":"","url":"https://api.github.com/users/maobaolong","html_url":"https://github.com/maobaolong","followers_url":"https://api.github.com/users/maobaolong/followers","following_url":"https://api.github.com/users/maobaolong/following{/other_user}","gists_url":"https://api.github.com/users/maobaolong/gists{/gist_id}","starred_url":"https://api.github.com/users/maobaolong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maobaolong/subscriptions","organizations_url":"https://api.github.com/users/maobaolong/orgs","repos_url":"https://api.github.com/users/maobaolong/repos","events_url":"https://api.github.com/users/maobaolong/events{/privacy}","received_events_url":"https://api.github.com/users/maobaolong/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-06T14:18:01Z","updated_at":"2021-11-06T14:18:01Z","author_association":"MEMBER","body":"@szetszwo Would you please take a look at this PR, thank you.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/962458372/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/962824682","html_url":"https://github.com/apache/ratis/pull/524#issuecomment-962824682","issue_url":"https://api.github.com/repos/apache/ratis/issues/524","id":962824682,"node_id":"IC_kwDOBMxbGc45Y4nq","user":{"login":"captainzmc","id":13825159,"node_id":"MDQ6VXNlcjEzODI1MTU5","avatar_url":"https://avatars.githubusercontent.com/u/13825159?v=4","gravatar_id":"","url":"https://api.github.com/users/captainzmc","html_url":"https://github.com/captainzmc","followers_url":"https://api.github.com/users/captainzmc/followers","following_url":"https://api.github.com/users/captainzmc/following{/other_user}","gists_url":"https://api.github.com/users/captainzmc/gists{/gist_id}","starred_url":"https://api.github.com/users/captainzmc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/captainzmc/subscriptions","organizations_url":"https://api.github.com/users/captainzmc/orgs","repos_url":"https://api.github.com/users/captainzmc/repos","events_url":"https://api.github.com/users/captainzmc/events{/privacy}","received_events_url":"https://api.github.com/users/captainzmc/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-08T05:25:30Z","updated_at":"2021-11-08T05:25:30Z","author_association":"MEMBER","body":"hi @szetszwo @bshashikant , can you help review this patch? ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/962824682/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/962878799","html_url":"https://github.com/apache/ratis/pull/525#issuecomment-962878799","issue_url":"https://api.github.com/repos/apache/ratis/issues/525","id":962878799,"node_id":"IC_kwDOBMxbGc45ZF1P","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-08T07:25:59Z","updated_at":"2021-11-08T07:25:59Z","author_association":"CONTRIBUTOR","body":"@maobaolong , thanks for working on this.  I am looking at this pull request.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/962878799/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/962957616","html_url":"https://github.com/apache/ratis/pull/525#issuecomment-962957616","issue_url":"https://api.github.com/repos/apache/ratis/issues/525","id":962957616,"node_id":"IC_kwDOBMxbGc45ZZEw","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-08T09:19:43Z","updated_at":"2021-11-08T09:19:43Z","author_association":"CONTRIBUTOR","body":"See https://issues.apache.org/jira/secure/attachment/13035814/525_review.patch for the review suggestions.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/962957616/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/962991143","html_url":"https://github.com/apache/ratis/pull/527#issuecomment-962991143","issue_url":"https://api.github.com/repos/apache/ratis/issues/527","id":962991143,"node_id":"IC_kwDOBMxbGc45ZhQn","user":{"login":"guohao-rosicky","id":5122636,"node_id":"MDQ6VXNlcjUxMjI2MzY=","avatar_url":"https://avatars.githubusercontent.com/u/5122636?v=4","gravatar_id":"","url":"https://api.github.com/users/guohao-rosicky","html_url":"https://github.com/guohao-rosicky","followers_url":"https://api.github.com/users/guohao-rosicky/followers","following_url":"https://api.github.com/users/guohao-rosicky/following{/other_user}","gists_url":"https://api.github.com/users/guohao-rosicky/gists{/gist_id}","starred_url":"https://api.github.com/users/guohao-rosicky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guohao-rosicky/subscriptions","organizations_url":"https://api.github.com/users/guohao-rosicky/orgs","repos_url":"https://api.github.com/users/guohao-rosicky/repos","events_url":"https://api.github.com/users/guohao-rosicky/events{/privacy}","received_events_url":"https://api.github.com/users/guohao-rosicky/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-08T10:03:22Z","updated_at":"2021-11-08T10:03:22Z","author_association":"CONTRIBUTOR","body":"hi @szetszwo @bshashikant , can you help review this patch?","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/962991143/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/963752071","html_url":"https://github.com/apache/ratis/pull/525#issuecomment-963752071","issue_url":"https://api.github.com/repos/apache/ratis/issues/525","id":963752071,"node_id":"IC_kwDOBMxbGc45cbCH","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-09T02:18:41Z","updated_at":"2021-11-09T02:18:41Z","author_association":"CONTRIBUTOR","body":"> Error:  src/main/java/org/apache/ratis/shell/cli/sh/RatisShell.java:[20,1] (design) HideUtilityClassConstructor: Utility classes should not have a public or default constructor.\r\n\r\nThe checkstyle warning above is a false positive.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/963752071/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/963798239","html_url":"https://github.com/apache/ratis/pull/527#issuecomment-963798239","issue_url":"https://api.github.com/repos/apache/ratis/issues/527","id":963798239,"node_id":"IC_kwDOBMxbGc45cmTf","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-09T04:07:55Z","updated_at":"2021-11-09T04:07:55Z","author_association":"CONTRIBUTOR","body":"BTW, as shown in https://issues.apache.org/jira/secure/attachment/13035853/WorkerGroupGetter.patch , I suggest changing the name of the new conf (raft.netty.dataStream.client.eventLoopThreads) added by https://issues.apache.org/jira/browse/RATIS-1421 in order to make the conf names consistent.\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/963798239/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/963861217","html_url":"https://github.com/apache/ratis/pull/527#issuecomment-963861217","issue_url":"https://api.github.com/repos/apache/ratis/issues/527","id":963861217,"node_id":"IC_kwDOBMxbGc45c1rh","user":{"login":"guohao-rosicky","id":5122636,"node_id":"MDQ6VXNlcjUxMjI2MzY=","avatar_url":"https://avatars.githubusercontent.com/u/5122636?v=4","gravatar_id":"","url":"https://api.github.com/users/guohao-rosicky","html_url":"https://github.com/guohao-rosicky","followers_url":"https://api.github.com/users/guohao-rosicky/followers","following_url":"https://api.github.com/users/guohao-rosicky/following{/other_user}","gists_url":"https://api.github.com/users/guohao-rosicky/gists{/gist_id}","starred_url":"https://api.github.com/users/guohao-rosicky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guohao-rosicky/subscriptions","organizations_url":"https://api.github.com/users/guohao-rosicky/orgs","repos_url":"https://api.github.com/users/guohao-rosicky/repos","events_url":"https://api.github.com/users/guohao-rosicky/events{/privacy}","received_events_url":"https://api.github.com/users/guohao-rosicky/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-09T06:45:04Z","updated_at":"2021-11-09T06:45:04Z","author_association":"CONTRIBUTOR","body":"Thanks @szetszwo ,let me modify that.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/963861217/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/964710470","html_url":"https://github.com/apache/ratis/pull/527#issuecomment-964710470","issue_url":"https://api.github.com/repos/apache/ratis/issues/527","id":964710470,"node_id":"IC_kwDOBMxbGc45gFBG","user":{"login":"guohao-rosicky","id":5122636,"node_id":"MDQ6VXNlcjUxMjI2MzY=","avatar_url":"https://avatars.githubusercontent.com/u/5122636?v=4","gravatar_id":"","url":"https://api.github.com/users/guohao-rosicky","html_url":"https://github.com/guohao-rosicky","followers_url":"https://api.github.com/users/guohao-rosicky/followers","following_url":"https://api.github.com/users/guohao-rosicky/following{/other_user}","gists_url":"https://api.github.com/users/guohao-rosicky/gists{/gist_id}","starred_url":"https://api.github.com/users/guohao-rosicky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guohao-rosicky/subscriptions","organizations_url":"https://api.github.com/users/guohao-rosicky/orgs","repos_url":"https://api.github.com/users/guohao-rosicky/repos","events_url":"https://api.github.com/users/guohao-rosicky/events{/privacy}","received_events_url":"https://api.github.com/users/guohao-rosicky/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-10T01:58:33Z","updated_at":"2021-11-10T01:58:33Z","author_association":"CONTRIBUTOR","body":"@maobaolong ,there is a ratis shell checkstyle problem.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/964710470/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/964722103","html_url":"https://github.com/apache/ratis/pull/527#issuecomment-964722103","issue_url":"https://api.github.com/repos/apache/ratis/issues/527","id":964722103,"node_id":"IC_kwDOBMxbGc45gH23","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-10T02:22:51Z","updated_at":"2021-11-10T02:22:51Z","author_association":"CONTRIBUTOR","body":"> @maobaolong ,there is a ratis shell checkstyle problem.\r\n\r\n@guohao-rosicky , it was introduced by #525 .  Sorry that I merged the checkstyle warning.   I did not realize it would affect other builds.  Please ignore it for the moment.  #528 will fix it.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/964722103/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/964729485","html_url":"https://github.com/apache/ratis/pull/527#issuecomment-964729485","issue_url":"https://api.github.com/repos/apache/ratis/issues/527","id":964729485,"node_id":"IC_kwDOBMxbGc45gJqN","user":{"login":"maobaolong","id":17329931,"node_id":"MDQ6VXNlcjE3MzI5OTMx","avatar_url":"https://avatars.githubusercontent.com/u/17329931?v=4","gravatar_id":"","url":"https://api.github.com/users/maobaolong","html_url":"https://github.com/maobaolong","followers_url":"https://api.github.com/users/maobaolong/followers","following_url":"https://api.github.com/users/maobaolong/following{/other_user}","gists_url":"https://api.github.com/users/maobaolong/gists{/gist_id}","starred_url":"https://api.github.com/users/maobaolong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maobaolong/subscriptions","organizations_url":"https://api.github.com/users/maobaolong/orgs","repos_url":"https://api.github.com/users/maobaolong/repos","events_url":"https://api.github.com/users/maobaolong/events{/privacy}","received_events_url":"https://api.github.com/users/maobaolong/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-10T02:39:21Z","updated_at":"2021-11-10T02:39:21Z","author_association":"MEMBER","body":"@szetszwo @guohao-rosicky Sorry for introduced style issue in #525 , the style issue was corrected in #528 , please take a look. Thanks","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/964729485/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/964733750","html_url":"https://github.com/apache/ratis/pull/528#issuecomment-964733750","issue_url":"https://api.github.com/repos/apache/ratis/issues/528","id":964733750,"node_id":"IC_kwDOBMxbGc45gKs2","user":{"login":"maobaolong","id":17329931,"node_id":"MDQ6VXNlcjE3MzI5OTMx","avatar_url":"https://avatars.githubusercontent.com/u/17329931?v=4","gravatar_id":"","url":"https://api.github.com/users/maobaolong","html_url":"https://github.com/maobaolong","followers_url":"https://api.github.com/users/maobaolong/followers","following_url":"https://api.github.com/users/maobaolong/following{/other_user}","gists_url":"https://api.github.com/users/maobaolong/gists{/gist_id}","starred_url":"https://api.github.com/users/maobaolong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maobaolong/subscriptions","organizations_url":"https://api.github.com/users/maobaolong/orgs","repos_url":"https://api.github.com/users/maobaolong/repos","events_url":"https://api.github.com/users/maobaolong/events{/privacy}","received_events_url":"https://api.github.com/users/maobaolong/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-10T02:42:03Z","updated_at":"2021-11-10T02:42:03Z","author_association":"MEMBER","body":"@szetszwo Thanks for the detailed suggestion and patch, I've addressed the suggestion, PTAL","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/964733750/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/965421477","html_url":"https://github.com/apache/ratis/pull/529#issuecomment-965421477","issue_url":"https://api.github.com/repos/apache/ratis/issues/529","id":965421477,"node_id":"IC_kwDOBMxbGc45iyml","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-10T15:36:38Z","updated_at":"2021-11-10T15:36:38Z","author_association":"CONTRIBUTOR","body":"@maobaolong , please include the JIRA id in the title of this pull request and also the link to the JIRA in the description. For an example, see #525 .","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/965421477/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/965905256","html_url":"https://github.com/apache/ratis/pull/529#issuecomment-965905256","issue_url":"https://api.github.com/repos/apache/ratis/issues/529","id":965905256,"node_id":"IC_kwDOBMxbGc45koto","user":{"login":"maobaolong","id":17329931,"node_id":"MDQ6VXNlcjE3MzI5OTMx","avatar_url":"https://avatars.githubusercontent.com/u/17329931?v=4","gravatar_id":"","url":"https://api.github.com/users/maobaolong","html_url":"https://github.com/maobaolong","followers_url":"https://api.github.com/users/maobaolong/followers","following_url":"https://api.github.com/users/maobaolong/following{/other_user}","gists_url":"https://api.github.com/users/maobaolong/gists{/gist_id}","starred_url":"https://api.github.com/users/maobaolong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maobaolong/subscriptions","organizations_url":"https://api.github.com/users/maobaolong/orgs","repos_url":"https://api.github.com/users/maobaolong/repos","events_url":"https://api.github.com/users/maobaolong/events{/privacy}","received_events_url":"https://api.github.com/users/maobaolong/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-11T01:16:36Z","updated_at":"2021-11-11T01:16:36Z","author_association":"MEMBER","body":"Thank you so much for these suggestions and patch @szetszwo .\r\n\r\nI addressed most of your patch, but not include `emptyGroupId`.\r\n\r\nIf I use `emptyGroupId`, it will return an error\r\n\r\n```\r\nGroup Id group-000000000000 is reserved for the empty group.\r\n```\r\n\r\nThe related code is from RaftGroup#RaftGroup\r\n\r\n```java\r\n  private RaftGroup(RaftGroupId groupId, Collection<RaftPeer> peers) {\r\n    this.groupId = Objects.requireNonNull(groupId, \"groupId == null\");\r\n    Preconditions.assertTrue(!groupId.equals(EMPTY_GROUP.getGroupId()),\r\n        () -> \"Group Id \" + groupId + \" is reserved for the empty group.\");\r\n\r\n    if (peers == null || peers.isEmpty()) {\r\n      this.peers = Collections.emptyMap();\r\n    } else {\r\n      final Map<RaftPeerId, RaftPeer> map = new HashMap<>();\r\n      peers.forEach(p -> map.put(p.getId(), p));\r\n      this.peers = Collections.unmodifiableMap(map);\r\n    }\r\n```\r\n\r\nPlease take another look, thanks.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/965905256/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/965951865","html_url":"https://github.com/apache/ratis/pull/529#issuecomment-965951865","issue_url":"https://api.github.com/repos/apache/ratis/issues/529","id":965951865,"node_id":"IC_kwDOBMxbGc45k0F5","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-11T03:15:26Z","updated_at":"2021-11-11T03:15:26Z","author_association":"CONTRIBUTOR","body":"> If I use emptyGroupId, it will return an error.\r\n\r\nI see.  Thanks.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/965951865/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/965999592","html_url":"https://github.com/apache/ratis/pull/530#issuecomment-965999592","issue_url":"https://api.github.com/repos/apache/ratis/issues/530","id":965999592,"node_id":"IC_kwDOBMxbGc45k_vo","user":{"login":"guohao-rosicky","id":5122636,"node_id":"MDQ6VXNlcjUxMjI2MzY=","avatar_url":"https://avatars.githubusercontent.com/u/5122636?v=4","gravatar_id":"","url":"https://api.github.com/users/guohao-rosicky","html_url":"https://github.com/guohao-rosicky","followers_url":"https://api.github.com/users/guohao-rosicky/followers","following_url":"https://api.github.com/users/guohao-rosicky/following{/other_user}","gists_url":"https://api.github.com/users/guohao-rosicky/gists{/gist_id}","starred_url":"https://api.github.com/users/guohao-rosicky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guohao-rosicky/subscriptions","organizations_url":"https://api.github.com/users/guohao-rosicky/orgs","repos_url":"https://api.github.com/users/guohao-rosicky/repos","events_url":"https://api.github.com/users/guohao-rosicky/events{/privacy}","received_events_url":"https://api.github.com/users/guohao-rosicky/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-11T05:22:06Z","updated_at":"2021-11-11T05:22:06Z","author_association":"CONTRIBUTOR","body":"hi @szetszwo @bshashikant , can you help review this patch?","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/965999592/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/966181626","html_url":"https://github.com/apache/ratis/pull/530#issuecomment-966181626","issue_url":"https://api.github.com/repos/apache/ratis/issues/530","id":966181626,"node_id":"IC_kwDOBMxbGc45lsL6","user":{"login":"guohao-rosicky","id":5122636,"node_id":"MDQ6VXNlcjUxMjI2MzY=","avatar_url":"https://avatars.githubusercontent.com/u/5122636?v=4","gravatar_id":"","url":"https://api.github.com/users/guohao-rosicky","html_url":"https://github.com/guohao-rosicky","followers_url":"https://api.github.com/users/guohao-rosicky/followers","following_url":"https://api.github.com/users/guohao-rosicky/following{/other_user}","gists_url":"https://api.github.com/users/guohao-rosicky/gists{/gist_id}","starred_url":"https://api.github.com/users/guohao-rosicky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guohao-rosicky/subscriptions","organizations_url":"https://api.github.com/users/guohao-rosicky/orgs","repos_url":"https://api.github.com/users/guohao-rosicky/repos","events_url":"https://api.github.com/users/guohao-rosicky/events{/privacy}","received_events_url":"https://api.github.com/users/guohao-rosicky/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-11T10:20:31Z","updated_at":"2021-11-11T10:20:31Z","author_association":"CONTRIBUTOR","body":"jira: https://issues.apache.org/jira/browse/RATIS-1432","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/966181626/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/966344496","html_url":"https://github.com/apache/ratis/pull/511#issuecomment-966344496","issue_url":"https://api.github.com/repos/apache/ratis/issues/511","id":966344496,"node_id":"IC_kwDOBMxbGc45mT8w","user":{"login":"maobaolong","id":17329931,"node_id":"MDQ6VXNlcjE3MzI5OTMx","avatar_url":"https://avatars.githubusercontent.com/u/17329931?v=4","gravatar_id":"","url":"https://api.github.com/users/maobaolong","html_url":"https://github.com/maobaolong","followers_url":"https://api.github.com/users/maobaolong/followers","following_url":"https://api.github.com/users/maobaolong/following{/other_user}","gists_url":"https://api.github.com/users/maobaolong/gists{/gist_id}","starred_url":"https://api.github.com/users/maobaolong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maobaolong/subscriptions","organizations_url":"https://api.github.com/users/maobaolong/orgs","repos_url":"https://api.github.com/users/maobaolong/repos","events_url":"https://api.github.com/users/maobaolong/events{/privacy}","received_events_url":"https://api.github.com/users/maobaolong/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-11T14:25:29Z","updated_at":"2021-11-11T14:25:29Z","author_association":"MEMBER","body":"@szetszwo As we cut this PR into sub tasks, I close this PR now. Thank you.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/966344496/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/966755914","html_url":"https://github.com/apache/ratis/pull/511#issuecomment-966755914","issue_url":"https://api.github.com/repos/apache/ratis/issues/511","id":966755914,"node_id":"IC_kwDOBMxbGc45n4ZK","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-12T01:57:17Z","updated_at":"2021-11-12T01:57:17Z","author_association":"CONTRIBUTOR","body":"@maobaolong , thanks a lot for breaking this into subtasks.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/966755914/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/966932825","html_url":"https://github.com/apache/ratis/pull/531#issuecomment-966932825","issue_url":"https://api.github.com/repos/apache/ratis/issues/531","id":966932825,"node_id":"IC_kwDOBMxbGc45ojlZ","user":{"login":"runzhiwang","id":51938049,"node_id":"MDQ6VXNlcjUxOTM4MDQ5","avatar_url":"https://avatars.githubusercontent.com/u/51938049?v=4","gravatar_id":"","url":"https://api.github.com/users/runzhiwang","html_url":"https://github.com/runzhiwang","followers_url":"https://api.github.com/users/runzhiwang/followers","following_url":"https://api.github.com/users/runzhiwang/following{/other_user}","gists_url":"https://api.github.com/users/runzhiwang/gists{/gist_id}","starred_url":"https://api.github.com/users/runzhiwang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/runzhiwang/subscriptions","organizations_url":"https://api.github.com/users/runzhiwang/orgs","repos_url":"https://api.github.com/users/runzhiwang/repos","events_url":"https://api.github.com/users/runzhiwang/events{/privacy}","received_events_url":"https://api.github.com/users/runzhiwang/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-12T08:57:59Z","updated_at":"2021-11-12T08:57:59Z","author_association":"CONTRIBUTOR","body":"+1, @maobaolong  thanks the patch.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/966932825/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/967000080","html_url":"https://github.com/apache/ratis/pull/532#issuecomment-967000080","issue_url":"https://api.github.com/repos/apache/ratis/issues/532","id":967000080,"node_id":"IC_kwDOBMxbGc45o0AQ","user":{"login":"codings-dan","id":26144703,"node_id":"MDQ6VXNlcjI2MTQ0NzAz","avatar_url":"https://avatars.githubusercontent.com/u/26144703?v=4","gravatar_id":"","url":"https://api.github.com/users/codings-dan","html_url":"https://github.com/codings-dan","followers_url":"https://api.github.com/users/codings-dan/followers","following_url":"https://api.github.com/users/codings-dan/following{/other_user}","gists_url":"https://api.github.com/users/codings-dan/gists{/gist_id}","starred_url":"https://api.github.com/users/codings-dan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/codings-dan/subscriptions","organizations_url":"https://api.github.com/users/codings-dan/orgs","repos_url":"https://api.github.com/users/codings-dan/repos","events_url":"https://api.github.com/users/codings-dan/events{/privacy}","received_events_url":"https://api.github.com/users/codings-dan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-12T10:41:07Z","updated_at":"2021-11-12T10:41:07Z","author_association":"CONTRIBUTOR","body":"@maobaolong I modified the code according to the comment, PTAL, thx!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/967000080/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/967249593","html_url":"https://github.com/apache/ratis/pull/532#issuecomment-967249593","issue_url":"https://api.github.com/repos/apache/ratis/issues/532","id":967249593,"node_id":"IC_kwDOBMxbGc45pw65","user":{"login":"maobaolong","id":17329931,"node_id":"MDQ6VXNlcjE3MzI5OTMx","avatar_url":"https://avatars.githubusercontent.com/u/17329931?v=4","gravatar_id":"","url":"https://api.github.com/users/maobaolong","html_url":"https://github.com/maobaolong","followers_url":"https://api.github.com/users/maobaolong/followers","following_url":"https://api.github.com/users/maobaolong/following{/other_user}","gists_url":"https://api.github.com/users/maobaolong/gists{/gist_id}","starred_url":"https://api.github.com/users/maobaolong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maobaolong/subscriptions","organizations_url":"https://api.github.com/users/maobaolong/orgs","repos_url":"https://api.github.com/users/maobaolong/repos","events_url":"https://api.github.com/users/maobaolong/events{/privacy}","received_events_url":"https://api.github.com/users/maobaolong/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-12T16:32:39Z","updated_at":"2021-11-12T16:32:39Z","author_association":"MEMBER","body":"@codings-dan It LGTM. @szetszwo would you please take a double check?","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/967249593/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]