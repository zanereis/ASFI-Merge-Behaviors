[{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/366996355","html_url":"https://github.com/apache/couchdb/pull/1176#issuecomment-366996355","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1176","id":366996355,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk5NjM1NQ==","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-20T14:36:16Z","updated_at":"2018-02-20T14:36:16Z","author_association":"CONTRIBUTOR","body":"CouchDyno has a set of extended, long running replication tests. Those pass as well:\r\n```\r\n$ couchdyno (master) $ ./test.sh\r\nzip_safe flag not set; analyzing archive contents...\r\n=============== test session starts =====================\r\nplatform darwin -- Python 2.7.13, pytest-3.0.3, py-1.4.33, pluggy-0.4.0 .../src/couchdyno/venv/bin/python\r\ncachedir: .cache\r\nrootdir: .../src/couchdyno, inifile: pytest.ini\r\ncollected 47 items\r\n\r\ntests/test_rep_00_basics.py::test_basic_continuous PASSED\r\ntests/test_rep_00_basics.py::test_basic_10_continuous PASSED\r\ntests/test_rep_00_basics.py::test_basic_10_continuous_1000_docs PASSED\r\ntests/test_rep_00_basics.py::test_basic_normal PASSED\r\ntests/test_rep_00_basics.py::test_basic_10_normal PASSED\r\ntests/test_rep_00_basics.py::test_basic_attachment PASSED\r\ntests/test_rep_00_basics.py::test_basic_js_filter PASSED\r\ntests/test_rep_01_patterns.py::test_n_to_n_pattern[False-False] PASSED\r\ntests/test_rep_01_patterns.py::test_n_to_n_pattern[False-True] PASSED\r\ntests/test_rep_01_patterns.py::test_n_to_n_pattern[True-False] PASSED\r\ntests/test_rep_01_patterns.py::test_n_to_n_pattern[True-True] PASSED\r\ntests/test_rep_01_patterns.py::test_1_to_n_pattern PASSED\r\ntests/test_rep_01_patterns.py::test_n_to_1_pattern PASSED\r\ntests/test_rep_01_patterns.py::test_n_chain_pattern PASSED\r\ntests/test_rep_01_patterns.py::test_all_pattern_continuous PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_view_filter[False-None] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_view_filter[False-1] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_view_filter[True-None] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_view_filter[True-1] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_js_filter[False-None] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_js_filter[False-1] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_js_filter[True-None] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_js_filter[True-1] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_doc_ids_filter[False-None] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_doc_ids_filter[False-1] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_doc_ids_filter[True-None] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_doc_ids_filter[True-1] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_mango_filter[False-None] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_mango_filter[False-1] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_mango_filter[True-None] PASSED\r\ntests/test_rep_02_filter.py::test_n_to_n_mango_filter[True-1] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[False-64-1] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[False-64-100] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[False-100000-1] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[False-100000-100] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[False-attachments4-1] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[False-attachments5-100] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[True-64-1] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[True-64-100] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[True-100000-1] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[True-100000-100] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[True-attachments10-1] PASSED\r\ntests/test_rep_03_attachments.py::test_attachments[True-attachments11-100] PASSED\r\ntests/test_rep_04_cluster.py::test_migration_on_node_failure SKIPPED\r\ntests/test_rep_05_migration.py::test_migration_error PASSED\r\ntests/test_rep_05_migration.py::test_migration_triggered PASSED\r\ntests/test_rep_05_migration.py::test_migration_downgrade_failed SKIPPED\r\n\r\n============== 45 passed, 2 skipped in 10065.23 seconds ======================\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/366996355/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367018821","html_url":"https://github.com/apache/couchdb/issues/1117#issuecomment-367018821","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1117","id":367018821,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzAxODgyMQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-20T15:43:06Z","updated_at":"2018-02-20T15:43:06Z","author_association":"MEMBER","body":"The fix is backported, but it does not necessarily solve the problem of memory leak. Watch #745 for more progress.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367018821/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367094720","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-367094720","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":367094720,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzA5NDcyMA==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-20T19:40:18Z","updated_at":"2018-02-20T19:40:18Z","author_association":"MEMBER","body":"> @dch is happy to do the IP clearance dance assuming we're OK on the NIF side of things. Can anybody look into that? the NIF is an R13B04 era style, does this need any changes?\r\n\r\nThanks @dch, but this doesn’t require IP clearance, as we just keep a copy, we don’t intend to continue developing the dependency code and we don’t intend to slap our license on it. It just needs to satisfy category A as you point out. With the git mirror in place via @rnewson, this is good to go.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367094720/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367158531","html_url":"https://github.com/apache/couchdb/pull/1166#issuecomment-367158531","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1166","id":367158531,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzE1ODUzMQ==","user":{"login":"eiri","id":70542,"node_id":"MDQ6VXNlcjcwNTQy","avatar_url":"https://avatars.githubusercontent.com/u/70542?v=4","gravatar_id":"","url":"https://api.github.com/users/eiri","html_url":"https://github.com/eiri","followers_url":"https://api.github.com/users/eiri/followers","following_url":"https://api.github.com/users/eiri/following{/other_user}","gists_url":"https://api.github.com/users/eiri/gists{/gist_id}","starred_url":"https://api.github.com/users/eiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eiri/subscriptions","organizations_url":"https://api.github.com/users/eiri/orgs","repos_url":"https://api.github.com/users/eiri/repos","events_url":"https://api.github.com/users/eiri/events{/privacy}","received_events_url":"https://api.github.com/users/eiri/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-20T23:30:55Z","updated_at":"2018-02-20T23:30:55Z","author_association":"MEMBER","body":"This is a great catch, but an incorrect fix. The proper fix was done here #849. Unfortunately the issue was found and fixed after 2.1.1 has been shipped.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367158531/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367194817","html_url":"https://github.com/apache/couchdb/pull/1166#issuecomment-367194817","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1166","id":367194817,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzE5NDgxNw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-21T02:38:28Z","updated_at":"2018-02-21T02:38:28Z","author_association":"MEMBER","body":"Closing as this is already fixed in master. Thanks @eiri","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367194817/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367249927","html_url":"https://github.com/apache/couchdb/pull/1166#issuecomment-367249927","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1166","id":367249927,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzI0OTkyNw==","user":{"login":"AlexanderKaraberov","id":3254818,"node_id":"MDQ6VXNlcjMyNTQ4MTg=","avatar_url":"https://avatars.githubusercontent.com/u/3254818?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexanderKaraberov","html_url":"https://github.com/AlexanderKaraberov","followers_url":"https://api.github.com/users/AlexanderKaraberov/followers","following_url":"https://api.github.com/users/AlexanderKaraberov/following{/other_user}","gists_url":"https://api.github.com/users/AlexanderKaraberov/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexanderKaraberov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexanderKaraberov/subscriptions","organizations_url":"https://api.github.com/users/AlexanderKaraberov/orgs","repos_url":"https://api.github.com/users/AlexanderKaraberov/repos","events_url":"https://api.github.com/users/AlexanderKaraberov/events{/privacy}","received_events_url":"https://api.github.com/users/AlexanderKaraberov/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-21T08:33:15Z","updated_at":"2018-02-21T08:33:15Z","author_association":"CONTRIBUTOR","body":"@eiri Thanks! Yes, indeed, my \"fix\" was just an ad-hoc solution to the problem I had with my test DB. I'm glad this issue was properly fixed.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367249927/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367357591","html_url":"https://github.com/apache/couchdb/pull/496#issuecomment-367357591","issue_url":"https://api.github.com/repos/apache/couchdb/issues/496","id":367357591,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzM1NzU5MQ==","user":{"login":"davisp","id":19929,"node_id":"MDQ6VXNlcjE5OTI5","avatar_url":"https://avatars.githubusercontent.com/u/19929?v=4","gravatar_id":"","url":"https://api.github.com/users/davisp","html_url":"https://github.com/davisp","followers_url":"https://api.github.com/users/davisp/followers","following_url":"https://api.github.com/users/davisp/following{/other_user}","gists_url":"https://api.github.com/users/davisp/gists{/gist_id}","starred_url":"https://api.github.com/users/davisp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisp/subscriptions","organizations_url":"https://api.github.com/users/davisp/orgs","repos_url":"https://api.github.com/users/davisp/repos","events_url":"https://api.github.com/users/davisp/events{/privacy}","received_events_url":"https://api.github.com/users/davisp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-21T15:11:20Z","updated_at":"2018-02-21T15:11:20Z","author_association":"MEMBER","body":"Has anyone got any reason for me to not merge this in 72h or whenever? I've rebased it against master and its passing CI checks. As far as I remember everyone was happy with the current state for the V1 pluggable storage engines.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367357591/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367381444","html_url":"https://github.com/apache/couchdb/pull/1139#issuecomment-367381444","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1139","id":367381444,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzM4MTQ0NA==","user":{"login":"jjrodrig","id":1001724,"node_id":"MDQ6VXNlcjEwMDE3MjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1001724?v=4","gravatar_id":"","url":"https://api.github.com/users/jjrodrig","html_url":"https://github.com/jjrodrig","followers_url":"https://api.github.com/users/jjrodrig/followers","following_url":"https://api.github.com/users/jjrodrig/following{/other_user}","gists_url":"https://api.github.com/users/jjrodrig/gists{/gist_id}","starred_url":"https://api.github.com/users/jjrodrig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jjrodrig/subscriptions","organizations_url":"https://api.github.com/users/jjrodrig/orgs","repos_url":"https://api.github.com/users/jjrodrig/repos","events_url":"https://api.github.com/users/jjrodrig/events{/privacy}","received_events_url":"https://api.github.com/users/jjrodrig/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-21T16:19:20Z","updated_at":"2018-02-21T21:10:25Z","author_association":"CONTRIBUTOR","body":"@rnewson I've done some more testing on the deletion with different cluster conditions. It seems that some .couch files keep orphaned if a database is deleted with one of the nodes of the cluster stopped.\r\n\r\n- Start 3-node cluster and create test db:\r\n ```\r\n ./dev/run -n 3 --with-admin-party-please\r\n curl -X PUT http://127.0.0.1:15984/test?q=1\r\n ```\r\n![image](https://user-images.githubusercontent.com/1001724/36490844-8d09e798-1729-11e8-8a13-33d35cf371f2.png)\r\n*One .couch file is created per node*\r\n\r\n- Stop 1 node in the cluster and delete the database\r\n ```\r\n./dev/run -n 3 --with-admin-party-please --degrade-cluster 1\r\ncurl -X DELETE http://127.0.0.1:15984/test\r\n ```\r\n![image](https://user-images.githubusercontent.com/1001724/36491047-179121f6-172a-11e8-9426-0674e49b4d01.png)\r\n*The .couch is removed and persist in the stopped node as expected*\r\n\r\n- Start the complete cluster and check if the database is deleted\r\n ```\r\n./dev/run -n 3 --with-admin-party-please \r\ncurl -X HEAD http://127.0.0.1:15984/test -v\r\n ```\r\n*The database is not found but the .couch file is propagated from the restarted node to the rest*\r\n![image](https://user-images.githubusercontent.com/1001724/36491226-85a98d7c-172a-11e8-90c5-f2f398469951.png)\r\n\r\nIt seems that .couch files keep orphaned in the system after a deletion with at least a node stopped. This PR does not modify this behavior. Do you think, this is an issue?\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367381444/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367757892","html_url":"https://github.com/apache/couchdb/issues/698#issuecomment-367757892","issue_url":"https://api.github.com/repos/apache/couchdb/issues/698","id":367757892,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Nzc1Nzg5Mg==","user":{"login":"reyj007","id":36741072,"node_id":"MDQ6VXNlcjM2NzQxMDcy","avatar_url":"https://avatars.githubusercontent.com/u/36741072?v=4","gravatar_id":"","url":"https://api.github.com/users/reyj007","html_url":"https://github.com/reyj007","followers_url":"https://api.github.com/users/reyj007/followers","following_url":"https://api.github.com/users/reyj007/following{/other_user}","gists_url":"https://api.github.com/users/reyj007/gists{/gist_id}","starred_url":"https://api.github.com/users/reyj007/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reyj007/subscriptions","organizations_url":"https://api.github.com/users/reyj007/orgs","repos_url":"https://api.github.com/users/reyj007/repos","events_url":"https://api.github.com/users/reyj007/events{/privacy}","received_events_url":"https://api.github.com/users/reyj007/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-22T17:31:24Z","updated_at":"2018-02-22T17:31:24Z","author_association":"NONE","body":"callum-spartan - been searching high and low for resolving this issue. I was working w both 2012 & 2016 instances on GCP and could not get around the service starting, restarting until I saw your \"Windows Remote Management \" comment. That did it! Now to figure out what \"Windows Remote Management\" does?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367757892/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367785530","html_url":"https://github.com/apache/couchdb/issues/698#issuecomment-367785530","issue_url":"https://api.github.com/repos/apache/couchdb/issues/698","id":367785530,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Nzc4NTUzMA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-22T19:02:59Z","updated_at":"2018-02-22T19:02:59Z","author_association":"MEMBER","body":"https://msdn.microsoft.com/en-us/library/aa384372(v=vs.85).aspx\r\n\r\n```\r\nWinRM 2.0:  The default HTTP port is 5985, and the default HTTPS port is 5986.\r\n```\r\n\r\nYou can change the port to fix this problem if desired.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367785530/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367805522","html_url":"https://github.com/apache/couchdb/issues/698#issuecomment-367805522","issue_url":"https://api.github.com/repos/apache/couchdb/issues/698","id":367805522,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzgwNTUyMg==","user":{"login":"reyj007","id":36741072,"node_id":"MDQ6VXNlcjM2NzQxMDcy","avatar_url":"https://avatars.githubusercontent.com/u/36741072?v=4","gravatar_id":"","url":"https://api.github.com/users/reyj007","html_url":"https://github.com/reyj007","followers_url":"https://api.github.com/users/reyj007/followers","following_url":"https://api.github.com/users/reyj007/following{/other_user}","gists_url":"https://api.github.com/users/reyj007/gists{/gist_id}","starred_url":"https://api.github.com/users/reyj007/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reyj007/subscriptions","organizations_url":"https://api.github.com/users/reyj007/orgs","repos_url":"https://api.github.com/users/reyj007/repos","events_url":"https://api.github.com/users/reyj007/events{/privacy}","received_events_url":"https://api.github.com/users/reyj007/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-22T20:06:39Z","updated_at":"2018-02-22T20:06:39Z","author_association":"NONE","body":"Thanks but CouchDB uses specifically 5984 so why the issue still? Also FYI, on AWS no issues whatsoever. Only GCP\n\n \n\nRey Jimenez\n\n <mailto:reyj@askrey.com> reyj@askrey.com\n\n \n\n \n\nFrom: Joan Touzet [mailto:notifications@github.com] \nSent: Thursday, February 22, 2018 2:03 PM\nTo: apache/couchdb <couchdb@noreply.github.com>\nCc: reyj007 <reyj@askrey.com>; Comment <comment@noreply.github.com>\nSubject: Re: [apache/couchdb] CouchDB 2 service keeps restarting on Windows Server 2016 (#698)\n\n \n\nhttps://msdn.microsoft.com/en-us/library/aa384372(v=vs.85).aspx\n\nWinRM 2.0:  The default HTTP port is 5985, and the default HTTPS port is 5986.\n\nYou can change the port to fix this problem if desired.\n\n—\nYou are receiving this because you commented.\nReply to this email directly, view it on GitHub <https://github.com/apache/couchdb/issues/698#issuecomment-367785530> , or mute the thread <https://github.com/notifications/unsubscribe-auth/AjCf0L09pxbcWxFsfcN5q9hEtzuTd3-Bks5tXbnsgaJpZM4Oc9Xy> .  <https://github.com/notifications/beacon/AjCf0CAeA3zSRkqBn0W_f-nCjQlpFuglks5tXbnsgaJpZM4Oc9Xy.gif> \n\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367805522/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367824436","html_url":"https://github.com/apache/couchdb/issues/698#issuecomment-367824436","issue_url":"https://api.github.com/repos/apache/couchdb/issues/698","id":367824436,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzgyNDQzNg==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-22T21:15:21Z","updated_at":"2018-02-22T21:15:21Z","author_association":"MEMBER","body":"CouchDB binds to both ports 5984 (clustered interface) and 5986 (localhost-only administrative interface).","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367824436/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367843082","html_url":"https://github.com/apache/couchdb/issues/698#issuecomment-367843082","issue_url":"https://api.github.com/repos/apache/couchdb/issues/698","id":367843082,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Nzg0MzA4Mg==","user":{"login":"reyj007","id":36741072,"node_id":"MDQ6VXNlcjM2NzQxMDcy","avatar_url":"https://avatars.githubusercontent.com/u/36741072?v=4","gravatar_id":"","url":"https://api.github.com/users/reyj007","html_url":"https://github.com/reyj007","followers_url":"https://api.github.com/users/reyj007/followers","following_url":"https://api.github.com/users/reyj007/following{/other_user}","gists_url":"https://api.github.com/users/reyj007/gists{/gist_id}","starred_url":"https://api.github.com/users/reyj007/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reyj007/subscriptions","organizations_url":"https://api.github.com/users/reyj007/orgs","repos_url":"https://api.github.com/users/reyj007/repos","events_url":"https://api.github.com/users/reyj007/events{/privacy}","received_events_url":"https://api.github.com/users/reyj007/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-22T22:23:32Z","updated_at":"2018-02-22T22:23:32Z","author_association":"NONE","body":"Gotcha. Thanks for super quick reply\n\n> On Feb 22, 2018, at 4:15 PM, Joan Touzet <notifications@github.com> wrote:\n> \n> CouchDB binds to both ports 5984 (clustered interface) and 5986 (localhost-only administrative interface).\n> \n> —\n> You are receiving this because you commented.\n> Reply to this email directly, view it on GitHub, or mute the thread.\n> \n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367843082/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367848644","html_url":"https://github.com/apache/couchdb/pull/1178#issuecomment-367848644","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1178","id":367848644,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Nzg0ODY0NA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-22T22:45:05Z","updated_at":"2018-02-22T22:45:05Z","author_association":"MEMBER","body":"+1\r\n\r\n:postal_horn: :imp: :unicorn: ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/367848644/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368011878","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-368011878","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":368011878,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODAxMTg3OA==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-23T13:41:53Z","updated_at":"2018-02-23T13:41:53Z","author_association":"MEMBER","body":"We now have https://github.com/apache/couchdb-erlang-bcrypt ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368011878/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368018221","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-368018221","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":368018221,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODAxODIyMQ==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-23T14:07:54Z","updated_at":"2018-02-23T14:07:54Z","author_association":"MEMBER","body":"I updated the dependency location and rebased master.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368018221/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368019167","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-368019167","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":368019167,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODAxOTE2Nw==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-23T14:11:49Z","updated_at":"2018-02-23T14:11:49Z","author_association":"MEMBER","body":"Added LICENSE and NOTICE entries","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368019167/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368027284","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-368027284","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":368027284,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODAyNzI4NA==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-23T14:41:11Z","updated_at":"2018-02-23T14:42:42Z","author_association":"MEMBER","body":"@pierrekilly nice work overall, and thanks again for the contribution. This is nearly ready to go, but it’d be great to get test coverage up a little bit. Namely, it’d be great to have a test that proves that:\r\n\r\n- [ ] after setting the password scheme to `bcrypt`:\r\n  - [ ] that creation of users works\r\n  - [ ] that users can authenticate\r\n  - [ ] that the password scheme in the users doc is indeed `bcrypt`\r\n- [ ] for admin users in the couchdb config\r\n  - [ ] that creation of admins works\r\n  - [ ] that admins can authenticate\r\n  - [ ] that the password scheme in the configuration is indeed `bcrypt`\r\n- [ ] that users with passwords hashed by different schemes can still log in, with the tasing scheme changed\r\n  - [ ] create new user (has pbkdf2 hash)\r\n  - [ ] change scheme to bcrypt\r\n  - [ ] create new user (has bcrypt hash)\r\n  - [ ] test that both users can still log in\r\n  - [ ] change scheme back to pbkdf2\r\n  - [ ] test that both users can still log in\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368027284/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368128802","html_url":"https://github.com/apache/couchdb/issues/1179#issuecomment-368128802","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1179","id":368128802,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODEyODgwMg==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-23T20:24:47Z","updated_at":"2018-02-23T20:24:47Z","author_association":"MEMBER","body":"I know that native SSL support in CouchDB is almost entirely provided by the underlying Erlang implementation. If Erlang doesn't support the full chain in the main cert file, we can't either.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368128802/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368141014","html_url":"https://github.com/apache/couchdb/issues/1179#issuecomment-368141014","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1179","id":368141014,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODE0MTAxNA==","user":{"login":"art-in","id":671082,"node_id":"MDQ6VXNlcjY3MTA4Mg==","avatar_url":"https://avatars.githubusercontent.com/u/671082?v=4","gravatar_id":"","url":"https://api.github.com/users/art-in","html_url":"https://github.com/art-in","followers_url":"https://api.github.com/users/art-in/followers","following_url":"https://api.github.com/users/art-in/following{/other_user}","gists_url":"https://api.github.com/users/art-in/gists{/gist_id}","starred_url":"https://api.github.com/users/art-in/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/art-in/subscriptions","organizations_url":"https://api.github.com/users/art-in/orgs","repos_url":"https://api.github.com/users/art-in/repos","events_url":"https://api.github.com/users/art-in/events{/privacy}","received_events_url":"https://api.github.com/users/art-in/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-23T21:17:10Z","updated_at":"2018-02-23T21:17:10Z","author_association":"NONE","body":"@wohali Yeah, that's what I expected to hear. No big deal.  \r\n\r\nAnyway, maybe someone will find the fix for `RequestError: Error: unable to verify the first certificate` here.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368141014/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368216241","html_url":"https://github.com/apache/couchdb/issues/1180#issuecomment-368216241","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1180","id":368216241,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODIxNjI0MQ==","user":{"login":"jiangphcn","id":18000622,"node_id":"MDQ6VXNlcjE4MDAwNjIy","avatar_url":"https://avatars.githubusercontent.com/u/18000622?v=4","gravatar_id":"","url":"https://api.github.com/users/jiangphcn","html_url":"https://github.com/jiangphcn","followers_url":"https://api.github.com/users/jiangphcn/followers","following_url":"https://api.github.com/users/jiangphcn/following{/other_user}","gists_url":"https://api.github.com/users/jiangphcn/gists{/gist_id}","starred_url":"https://api.github.com/users/jiangphcn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jiangphcn/subscriptions","organizations_url":"https://api.github.com/users/jiangphcn/orgs","repos_url":"https://api.github.com/users/jiangphcn/repos","events_url":"https://api.github.com/users/jiangphcn/events{/privacy}","received_events_url":"https://api.github.com/users/jiangphcn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-24T09:50:21Z","updated_at":"2018-02-24T09:50:21Z","author_association":"CONTRIBUTOR","body":"try  curl http://localhost:15984/account/_all_docs?include_docs=true","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368216241/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368219395","html_url":"https://github.com/apache/couchdb/issues/1180#issuecomment-368219395","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1180","id":368219395,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODIxOTM5NQ==","user":{"login":"jiangphcn","id":18000622,"node_id":"MDQ6VXNlcjE4MDAwNjIy","avatar_url":"https://avatars.githubusercontent.com/u/18000622?v=4","gravatar_id":"","url":"https://api.github.com/users/jiangphcn","html_url":"https://github.com/jiangphcn","followers_url":"https://api.github.com/users/jiangphcn/followers","following_url":"https://api.github.com/users/jiangphcn/following{/other_user}","gists_url":"https://api.github.com/users/jiangphcn/gists{/gist_id}","starred_url":"https://api.github.com/users/jiangphcn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jiangphcn/subscriptions","organizations_url":"https://api.github.com/users/jiangphcn/orgs","repos_url":"https://api.github.com/users/jiangphcn/repos","events_url":"https://api.github.com/users/jiangphcn/events{/privacy}","received_events_url":"https://api.github.com/users/jiangphcn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-24T10:45:35Z","updated_at":"2018-02-24T10:45:35Z","author_association":"CONTRIBUTOR","body":"In addition, I didn't think that this is proper place to raise such question. May try in slack or IRC.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368219395/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368325239","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-368325239","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":368325239,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODMyNTIzOQ==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-25T16:59:20Z","updated_at":"2018-02-25T16:59:20Z","author_association":"MEMBER","body":"@pierrekilly see https://github.com/apache/couchdb/blob/master/test/javascript/tests/users_db_security.js for getting started","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368325239/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368353763","html_url":"https://github.com/apache/couchdb/issues/946#issuecomment-368353763","issue_url":"https://api.github.com/repos/apache/couchdb/issues/946","id":368353763,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODM1Mzc2Mw==","user":{"login":"leonaves","id":1926652,"node_id":"MDQ6VXNlcjE5MjY2NTI=","avatar_url":"https://avatars.githubusercontent.com/u/1926652?v=4","gravatar_id":"","url":"https://api.github.com/users/leonaves","html_url":"https://github.com/leonaves","followers_url":"https://api.github.com/users/leonaves/followers","following_url":"https://api.github.com/users/leonaves/following{/other_user}","gists_url":"https://api.github.com/users/leonaves/gists{/gist_id}","starred_url":"https://api.github.com/users/leonaves/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leonaves/subscriptions","organizations_url":"https://api.github.com/users/leonaves/orgs","repos_url":"https://api.github.com/users/leonaves/repos","events_url":"https://api.github.com/users/leonaves/events{/privacy}","received_events_url":"https://api.github.com/users/leonaves/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-25T23:04:51Z","updated_at":"2018-02-25T23:04:51Z","author_association":"NONE","body":"I don't know if I've followed some of those threads incorrectly, but is [this person](https://issues.apache.org/jira/browse/COUCHDB-1397?focusedCommentId=13199747&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-13199747) correct in their statement:\r\n\r\n> it is the people writing\r\n> ```json\r\n> {\"map\": \"var d=1; function(doc)\r\n> { emit(doc._id, d); }\"}\r\n> ```\r\n> that should find their code not working, as they are using undocumented features.\r\n\r\nBreaking undocumented features isn't a breaking change. I accept that a large number of users may rely on this, but resisting changes that break things you never promised to stay working for the sake of existing users is pretty short sighted IMO, especially given the growing ES6+ community.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368353763/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368384551","html_url":"https://github.com/apache/couchdb/issues/946#issuecomment-368384551","issue_url":"https://api.github.com/repos/apache/couchdb/issues/946","id":368384551,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODM4NDU1MQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-26T04:06:19Z","updated_at":"2018-02-26T05:02:40Z","author_association":"MEMBER","body":"It would also break CommonJS library inclusion.\r\n\r\nPull requests welcome.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368384551/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368404943","html_url":"https://github.com/apache/couchdb/pull/1176#issuecomment-368404943","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1176","id":368404943,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODQwNDk0Mw==","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-26T06:40:54Z","updated_at":"2018-02-26T06:40:54Z","author_association":"CONTRIBUTOR","body":"I made two updates to the PR over the weekend:\r\n\r\n 1. Added more unit tests covering various cookie update states in `_auth_session` plugin:\r\n\r\n https://github.com/cloudant/couchdb/blob/921609e9ce3b3e535561816b3e435b039ad731df/src/couch_replicator/src/couch_replicator_auth_session.erl#L554-L648\r\n\r\n 2. Realized when we POST-ed to `_session` with content type `application/x-www-form-urlencoded` we didn't actually urlencode username and password param values. So enabled that: \r\n\r\nhttps://github.com/cloudant/couchdb/blob/921609e9ce3b3e535561816b3e435b039ad731df/src/couch_replicator/src/couch_replicator_auth_session.erl#L554-L648\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368404943/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368514747","html_url":"https://github.com/apache/couchdb/pull/1182#issuecomment-368514747","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1182","id":368514747,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODUxNDc0Nw==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-26T14:09:05Z","updated_at":"2018-02-26T14:09:05Z","author_association":"MEMBER","body":"Fix for #1181 \r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368514747/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368637307","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-368637307","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":368637307,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODYzNzMwNw==","user":{"login":"pierrekilly","id":1321703,"node_id":"MDQ6VXNlcjEzMjE3MDM=","avatar_url":"https://avatars.githubusercontent.com/u/1321703?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrekilly","html_url":"https://github.com/pierrekilly","followers_url":"https://api.github.com/users/pierrekilly/followers","following_url":"https://api.github.com/users/pierrekilly/following{/other_user}","gists_url":"https://api.github.com/users/pierrekilly/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrekilly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrekilly/subscriptions","organizations_url":"https://api.github.com/users/pierrekilly/orgs","repos_url":"https://api.github.com/users/pierrekilly/repos","events_url":"https://api.github.com/users/pierrekilly/events{/privacy}","received_events_url":"https://api.github.com/users/pierrekilly/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-26T20:22:47Z","updated_at":"2018-02-26T20:22:47Z","author_association":"NONE","body":"Just pushed more tests\r\nA quick explanation about them: I have modified the current test in the file @janl pointed to be applied also to both `pbkdf2` and `bcrypt` + I have added the third scenario asked.\r\nHope everything is fine but if there's any issue or work remaining, please let me know.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368637307/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368681825","html_url":"https://github.com/apache/couchdb/issues/1154#issuecomment-368681825","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1154","id":368681825,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODY4MTgyNQ==","user":{"login":"gambolputty","id":8270488,"node_id":"MDQ6VXNlcjgyNzA0ODg=","avatar_url":"https://avatars.githubusercontent.com/u/8270488?v=4","gravatar_id":"","url":"https://api.github.com/users/gambolputty","html_url":"https://github.com/gambolputty","followers_url":"https://api.github.com/users/gambolputty/followers","following_url":"https://api.github.com/users/gambolputty/following{/other_user}","gists_url":"https://api.github.com/users/gambolputty/gists{/gist_id}","starred_url":"https://api.github.com/users/gambolputty/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gambolputty/subscriptions","organizations_url":"https://api.github.com/users/gambolputty/orgs","repos_url":"https://api.github.com/users/gambolputty/repos","events_url":"https://api.github.com/users/gambolputty/events{/privacy}","received_events_url":"https://api.github.com/users/gambolputty/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-26T22:59:19Z","updated_at":"2018-02-26T23:00:03Z","author_association":"NONE","body":"In case anybody has the same issue: also \"GDATA Internet Security\" has a problem with the file \"nssm.exe\" inside the `C:\\CouchDB\\bin` folder and recognizes it as Junkware. I reported it as a false positive to GDATA.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368681825/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368768760","html_url":"https://github.com/apache/couchdb/pull/1182#issuecomment-368768760","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1182","id":368768760,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODc2ODc2MA==","user":{"login":"obi458","id":3896482,"node_id":"MDQ6VXNlcjM4OTY0ODI=","avatar_url":"https://avatars.githubusercontent.com/u/3896482?v=4","gravatar_id":"","url":"https://api.github.com/users/obi458","html_url":"https://github.com/obi458","followers_url":"https://api.github.com/users/obi458/followers","following_url":"https://api.github.com/users/obi458/following{/other_user}","gists_url":"https://api.github.com/users/obi458/gists{/gist_id}","starred_url":"https://api.github.com/users/obi458/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/obi458/subscriptions","organizations_url":"https://api.github.com/users/obi458/orgs","repos_url":"https://api.github.com/users/obi458/repos","events_url":"https://api.github.com/users/obi458/events{/privacy}","received_events_url":"https://api.github.com/users/obi458/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T07:07:58Z","updated_at":"2018-02-27T08:54:46Z","author_association":"NONE","body":"After some times on the couch and thinking about the problem i guess is_idle is wrong using monitored_by.\r\n\r\nI simulate scheduler(pause) always with an debug point!\r\n\r\nIf i set an debug point on:\r\n\r\nProcess(Fd):\r\n```\r\nhandle_info(maybe_close, File) ->\r\n    case is_idle(File) of\r\n        true ->\r\n         **debug point ->**  {stop, normal, File};\r\n        false ->\r\n            erlang:send_after(?MONITOR_CHECK, self(), maybe_close),\r\n            {noreply, File}\r\n    end;\r\n```\r\n\r\nand calling erlang:monitor(process, Fd) from process(OpenDb) that want to open Db:\r\n\r\n```\r\nreceive\r\n        {'DOWN', Ref, _, _, _} ->\r\n            {down, Db}\r\n    after 0 ->\r\n        {ok, Db#db{fd_monitor = Ref}}\r\n    end.\r\n```\r\n\r\ndoes not work, cause the Fd process lives(on my debug point)! \r\nand will die shortly through {stop, normal, File}\r\n\r\nI think it is better to replace the monitor function with(and turn around the logic):\r\n\r\ngen_server:call(Fd,{monitor_me,OpenDb},unlimited).\r\nif the calling failed, we are sure the process does not exists and we restart to open or create the Db.\r\n\r\nIn short: \r\n\r\n1) save the OpenDb in monitor dict and \r\n2) the couch_file monitors the OpenDb and remove OpenDb from monitor dict on 'DOWN' message.\r\n     Therefore we have always a consistent monitor dict and is_idle will work correctly!\r\n\r\nis_idle like:\r\nis_idle() -> dict:size(monitor_dict) =:= 0.\r\n\r\n\r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368768760/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368786394","html_url":"https://github.com/apache/couchdb/pull/496#issuecomment-368786394","issue_url":"https://api.github.com/repos/apache/couchdb/issues/496","id":368786394,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODc4NjM5NA==","user":{"login":"jiangphcn","id":18000622,"node_id":"MDQ6VXNlcjE4MDAwNjIy","avatar_url":"https://avatars.githubusercontent.com/u/18000622?v=4","gravatar_id":"","url":"https://api.github.com/users/jiangphcn","html_url":"https://github.com/jiangphcn","followers_url":"https://api.github.com/users/jiangphcn/followers","following_url":"https://api.github.com/users/jiangphcn/following{/other_user}","gists_url":"https://api.github.com/users/jiangphcn/gists{/gist_id}","starred_url":"https://api.github.com/users/jiangphcn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jiangphcn/subscriptions","organizations_url":"https://api.github.com/users/jiangphcn/orgs","repos_url":"https://api.github.com/users/jiangphcn/repos","events_url":"https://api.github.com/users/jiangphcn/events{/privacy}","received_events_url":"https://api.github.com/users/jiangphcn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T08:33:02Z","updated_at":"2018-02-27T08:33:02Z","author_association":"CONTRIBUTOR","body":"+1 from my side. All tests passed locally. ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368786394/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368908940","html_url":"https://github.com/apache/couchdb/pull/1182#issuecomment-368908940","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1182","id":368908940,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODkwODk0MA==","user":{"login":"davisp","id":19929,"node_id":"MDQ6VXNlcjE5OTI5","avatar_url":"https://avatars.githubusercontent.com/u/19929?v=4","gravatar_id":"","url":"https://api.github.com/users/davisp","html_url":"https://github.com/davisp","followers_url":"https://api.github.com/users/davisp/followers","following_url":"https://api.github.com/users/davisp/following{/other_user}","gists_url":"https://api.github.com/users/davisp/gists{/gist_id}","starred_url":"https://api.github.com/users/davisp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisp/subscriptions","organizations_url":"https://api.github.com/users/davisp/orgs","repos_url":"https://api.github.com/users/davisp/repos","events_url":"https://api.github.com/users/davisp/events{/privacy}","received_events_url":"https://api.github.com/users/davisp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T15:07:50Z","updated_at":"2018-02-27T15:07:50Z","author_association":"MEMBER","body":"I thought about something similar the other day however I didn't go too far down that route as the cost of a message pass through couch_file would be quite a performance penalty especially as the system load increases.\r\n\r\nI'm starting to wonder though if there's not an alternative approach to having couch_file just notify couch_server that its idle. Though that suggests extra messaging through couch_server that might also be a performance issue on the top end.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368908940/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368962363","html_url":"https://github.com/apache/couchdb/pull/1182#issuecomment-368962363","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1182","id":368962363,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODk2MjM2Mw==","user":{"login":"obi458","id":3896482,"node_id":"MDQ6VXNlcjM4OTY0ODI=","avatar_url":"https://avatars.githubusercontent.com/u/3896482?v=4","gravatar_id":"","url":"https://api.github.com/users/obi458","html_url":"https://github.com/obi458","followers_url":"https://api.github.com/users/obi458/followers","following_url":"https://api.github.com/users/obi458/following{/other_user}","gists_url":"https://api.github.com/users/obi458/gists{/gist_id}","starred_url":"https://api.github.com/users/obi458/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/obi458/subscriptions","organizations_url":"https://api.github.com/users/obi458/orgs","repos_url":"https://api.github.com/users/obi458/repos","events_url":"https://api.github.com/users/obi458/events{/privacy}","received_events_url":"https://api.github.com/users/obi458/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T17:39:15Z","updated_at":"2018-02-27T17:39:15Z","author_association":"NONE","body":"One solution may be:\r\n\r\nIf we are going to close the Db(couch_file) we try:\r\n\r\n```\r\nis_idle() ->\r\n....\r\nandalso ets:insert_new(couch_dbs,self()).\r\n```\r\n\r\n\r\nFurther if we are going to monitor the Fd:\r\n\r\n ```\r\nincref(#db{fd = Fd} = Db) ->\r\n  incref(Db,ets:insert_new(couch_dbs,Fd)).\r\n\r\nincref(#db{fd = Fd} = Db, true = _Ready) ->\r\n    % first monitor\r\n    Ref = erlang:monitor(process, Fd),\r\n    % than release the lock\r\n    ets:delete(couch_dbs,Fd),\r\n    {ok, Db#db{fd_monitor = Ref}};\r\n% we are not able to write the lock,\r\n% either the file will be closed or another process want to monitor\r\n% we will try it again\r\nincref(#db{fd = _Fd} = Db, false = _Ready) ->\r\n    retry.\r\n```\r\n\r\nand \r\n\r\n```\r\n...\r\ncase couch_db:incref(Db0) of\r\n                retry -> open(DbName, Options0);\r\n                {ok, Db1} -> couch_db:set_user_ctx(Db1, Ctx)\r\n            end;\r\n...\r\n\r\n...\r\ncase couch_db:incref(Db0) of\r\n                retry -> create(DbName, Options0);\r\n                {ok, Db1} -> couch_db:set_user_ctx(Db1, Ctx)\r\n            end;\r\n...\r\n\r\n```\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368962363/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368977110","html_url":"https://github.com/apache/couchdb/pull/1182#issuecomment-368977110","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1182","id":368977110,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODk3NzExMA==","user":{"login":"davisp","id":19929,"node_id":"MDQ6VXNlcjE5OTI5","avatar_url":"https://avatars.githubusercontent.com/u/19929?v=4","gravatar_id":"","url":"https://api.github.com/users/davisp","html_url":"https://github.com/davisp","followers_url":"https://api.github.com/users/davisp/followers","following_url":"https://api.github.com/users/davisp/following{/other_user}","gists_url":"https://api.github.com/users/davisp/gists{/gist_id}","starred_url":"https://api.github.com/users/davisp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisp/subscriptions","organizations_url":"https://api.github.com/users/davisp/orgs","repos_url":"https://api.github.com/users/davisp/repos","events_url":"https://api.github.com/users/davisp/events{/privacy}","received_events_url":"https://api.github.com/users/davisp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T18:25:10Z","updated_at":"2018-02-27T18:25:10Z","author_association":"MEMBER","body":"Aha! I was reading back through history and staring at this code to remind myself how this fits together and I realized that this isn't actually the right bug. The issue here is actually that we're doing a dirty read on the ets table and then attempting to take the monitor in an unprotected section. The proposed issues we've had here won't ever actually help us (other than the retry being a possible bandaid that'd likely fix it well enough).\r\n\r\nThe dirty read issue becomes apparent when I finally remembered that couch_db_updater always monitors couch_file. So what must have happened is that couch_db_updater sent the close_db_if_idle cast which gets processed just after a client reads the db record from the ets table. What should really happen is that the monitor is taken while the client has locked the db entry in the couch_dbs table. Which is similar-ish to the proposal to insert/delete pids from that table.\r\n\r\nHowever, actually doing that makes things *really* slow (I've tried it for other reasons). And also fairly complicated as you then have the possibility where clients die during a \"transaction\" which then leaves your table with permanent locks and so on and such forth.\r\n\r\nI've run across this for some other reason I can't remember as well. And I've never been able to figure out a fix that doesn't cripple the throughput of couch_server. ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368977110/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368998123","html_url":"https://github.com/apache/couchdb/pull/1176#issuecomment-368998123","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1176","id":368998123,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODk5ODEyMw==","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T19:31:52Z","updated_at":"2018-02-27T19:31:52Z","author_association":"CONTRIBUTOR","body":"Debating whether to make this an opt-in feature at first and make the default plugin list = `couch_replicator_auth_noop`. Then after a period of time, presumably if any users have tried this feature out and didn't find issues with it. Make it the default.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368998123/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368998747","html_url":"https://github.com/apache/couchdb/pull/1182#issuecomment-368998747","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1182","id":368998747,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODk5ODc0Nw==","user":{"login":"obi458","id":3896482,"node_id":"MDQ6VXNlcjM4OTY0ODI=","avatar_url":"https://avatars.githubusercontent.com/u/3896482?v=4","gravatar_id":"","url":"https://api.github.com/users/obi458","html_url":"https://github.com/obi458","followers_url":"https://api.github.com/users/obi458/followers","following_url":"https://api.github.com/users/obi458/following{/other_user}","gists_url":"https://api.github.com/users/obi458/gists{/gist_id}","starred_url":"https://api.github.com/users/obi458/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/obi458/subscriptions","organizations_url":"https://api.github.com/users/obi458/orgs","repos_url":"https://api.github.com/users/obi458/repos","events_url":"https://api.github.com/users/obi458/events{/privacy}","received_events_url":"https://api.github.com/users/obi458/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T19:33:54Z","updated_at":"2018-02-27T19:33:54Z","author_association":"NONE","body":"The motivation we thinking about the problem is: a lot of noproc errors in changes!\r\nFollowing by a lot of timeouts!\r\nMaybe we could better handle the badmatch!\r\n\r\n```\r\n[error] 2018-02-23T18:55:04.251497Z couchdb@127.0.0.1 <0.12749.108> 8647c35089 rexi_server: from: couchdb@127.0.0.1(<0.960.81>) mfa: fabric_rpc:changes/3 error:{badmatch,{'EXIT',noproc}} [{couch_file,pread_binary,2,[{file,\"src/couch_file.erl\"},{line,169}]},{couch_file,pread_term,2,[{file,\"src/couch_file.erl\"},{line,157}]},{couch_btree,get_node,2,[{file,\"src/couch_btree.erl\"},{line,434}]},{couch_btree,reduce_stream_node,11,[{file,\"src/couch_btree.erl\"},{line,619}]},{couch_btree,fold_reduce,4,[{file,\"src/couch_btree.erl\"},{line,81}]},{couch_db,count_changes_since,2,[{file,\"src/couch_db.erl\"},{line,1407}]},{fabric_rpc,changes,4,[{file,\"src/fabric_rpc.erl\"},{line,80}]},{rexi_server,init_p,3,[{file,\"src/rexi_server.erl\"},{line,139}]}]\r\n[error] 2018-02-23T19:11:26.204435Z couchdb@127.0.0.1 <0.12625.108> 8647c35089 rexi_server: from: couchdb@127.0.0.1(<0.960.81>) mfa: fabric_rpc:changes/3 exit:timeout [{rexi,init_stream,1,[{file,\"src/rexi.erl\"},{line,256}]},{rexi,stream_last,2,[{file,\"src/rexi.erl\"},{line,224}]},{fabric_rpc,changes,4,[{file,\"src/fabric_rpc.erl\"},{line,86}]},{rexi_server,init_p,3,[{file,\"src/rexi_server.erl\"},{line,139}]}]\r\n[error] 2018-02-23T19:11:26.206475Z couchdb@127.0.0.1 <0.12799.108> 8647c35089 rexi_server: from: couchdb@127.0.0.1(<0.960.81>) mfa: fabric_rpc:changes/3 exit:timeout [{rexi,init_stream,1,[{file,\"src/rexi.erl\"},{line,256}]},{rexi,stream_last,2,[{file,\"src/rexi.erl\"},{line,224}]},{fabric_rpc,changes,4,[{file,\"src/fabric_rpc.erl\"},{line,86}]},{rexi_server,init_p,3,[{file,\"src/rexi_server.erl\"},{line,139}]}]\r\n[error] 2018-02-23T19:11:26.206597Z couchdb@127.0.0.1 <0.12936.108> 8647c35089 rexi_server: from: couchdb@127.0.0.1(<0.960.81>) mfa: fabric_rpc:changes/3 exit:timeout [{rexi,init_stream,1,[{file,\"src/rexi.erl\"},{line,256}]},{rexi,stream_last,2,[{file,\"src/rexi.erl\"},{line,224}]},{fabric_rpc,changes,4,[{file,\"src/fabric_rpc.erl\"},{line,86}]},{rexi_server,init_p,3,[{file,\"src/rexi_server.erl\"},{line,139}]}]\r\n```\r\nThis comes from:\r\n\r\nioq:\r\n```\r\nsubmit_request(#request{}=Request, #state{}=State) ->\r\n    Ref = erlang:monitor(process, Request#request.fd), % fd is dead!!!\r\n```\r\n\r\n```\r\nhandle_info({'DOWN', Ref, _, _, Reason}, State) ->\r\n    case lists:keytake(Ref, #request.ref, State#state.running) of\r\n        {value, Request, Remaining} ->\r\n            gen_server:reply(Request#request.from, {'EXIT', Reason}), % Reason is noproc\r\n            {noreply, State#state{running=Remaining}, 0};\r\n        false ->\r\n            {noreply, State, 0}\r\n    end;\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/368998747/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369000882","html_url":"https://github.com/apache/couchdb/issues/1174#issuecomment-369000882","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1174","id":369000882,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTAwMDg4Mg==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T19:40:46Z","updated_at":"2018-02-27T19:40:46Z","author_association":"MEMBER","body":"You should review the former `proxy_use_secret` functionality, which has not been working since 2.0.0, and determine if you can address your concern by fixing this functionality rather than proposing something new.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369000882/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369001477","html_url":"https://github.com/apache/couchdb/issues/1183#issuecomment-369001477","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1183","id":369001477,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTAwMTQ3Nw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T19:42:30Z","updated_at":"2018-02-27T19:42:30Z","author_association":"MEMBER","body":"Correct, this functionality has not worked since the 2.0.0 release.\r\n\r\nSee #1174 for a proposal to revive it.\r\n\r\nThe workaround for now is to use very tight firewalling with your proxy server, only allowing it direct access to the CouchDB node(s).\r\n\r\nI'm not sure whether to duplicate this ticket against #1174 or not, as I'm not 100% sure that ticket is proposing to fix this problem.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369001477/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369009872","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-369009872","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":369009872,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTAwOTg3Mg==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T20:10:02Z","updated_at":"2018-02-27T20:10:02Z","author_association":"MEMBER","body":"Great work here. I'm unable to comment on the code quality, but if @janl and @rnewson are happy, you've pleased the right people.\r\n\r\nAs someone else has probably mentioned, this needs to be squashed before landing.\r\n\r\nSorry to bring this up again... @janl and I discussed the whole `iterations` vs. `log_rounds` being the same or separate. I guess if both encryption types can be supported at once, it can make sense for them to be separate. But if only one type of encryption is supported at the time of creation of a new user, then the parameters would be best to be unified into the single `iterations` existing config value - the [POLA](https://en.wikipedia.org/wiki/Principle_of_least_astonishment) comes into effect.\r\n\r\nJan said he'll think about this and drop by in a day or two to comment.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369009872/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369019525","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-369019525","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":369019525,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTAxOTUyNQ==","user":{"login":"pierrekilly","id":1321703,"node_id":"MDQ6VXNlcjEzMjE3MDM=","avatar_url":"https://avatars.githubusercontent.com/u/1321703?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrekilly","html_url":"https://github.com/pierrekilly","followers_url":"https://api.github.com/users/pierrekilly/followers","following_url":"https://api.github.com/users/pierrekilly/following{/other_user}","gists_url":"https://api.github.com/users/pierrekilly/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrekilly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrekilly/subscriptions","organizations_url":"https://api.github.com/users/pierrekilly/orgs","repos_url":"https://api.github.com/users/pierrekilly/repos","events_url":"https://api.github.com/users/pierrekilly/events{/privacy}","received_events_url":"https://api.github.com/users/pierrekilly/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T20:44:24Z","updated_at":"2018-02-27T20:44:24Z","author_association":"NONE","body":"Very well!\r\n\r\nJust one precision about this: in case of PBKDF2, with `iterations` set to 10, there will be 10 iterations. In case of bcrypt, the same `10` means there will be 2^10 iterations.\r\n\r\nAs the number do *not* represent exactly the same thing, I preferred to keep them separated, but the decision is up to you guys :-)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369019525/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369037334","html_url":"https://github.com/apache/couchdb/pull/1139#issuecomment-369037334","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1139","id":369037334,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTAzNzMzNA==","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T21:45:31Z","updated_at":"2018-02-27T21:45:31Z","author_association":"MEMBER","body":"Thanks for this PR @jjrodrig, very well done.\r\n\r\nThe orphaned files are a known condition. They are OK from the perspective of database correctness, as a new database created with the same name will have a different creation timestamp and so the old data would not be surfaced. It could be a useful future enhancement to remove orphaned shard files in a background process.\r\n\r\nThe previous behavior of distinguishing between a majority or minority of committed updates to the replicas of the shard table is not something I'm interested in preserving. I think we can do better.\r\n\r\nI *do* think the use of 202 Accepted as an indicator to the client that \"hey, things are a little messy right now, you might see surprises while we work things out\" is a good thing. My concern with the current PR is that we may return 200 OK to a user even though some nodes in the cluster still host the old (soon-to-be-deleted) version of the database. For example, consider the following sequence of events:\r\n\r\n1. Cluster experiences a network partition which creates subsets A and B\r\n2. User submits `DELETE /foo` to a node in A and receives `200 OK`\r\n3. User submits `PUT /foo` to a node in A and receives `200 OK`\r\n4. User submits `PUT /foo/bar` to a node in B and receives `202 Accepted`\r\n5. Network partition resolves, shard maps are updated\r\n\r\nIn this sequence the `/foo/bar` document will be lost permanently 👎 \r\n\r\nPerhaps a preferable approach is to use `202 Accepted` for every situation in which\r\n\r\n1. We get at least one acknowledgement and \r\n2. We do not hear back from a cluster member\r\n\r\nThe downside of this approach is that we wait around to hear back from every cluster member, and the `request_timeout` can be quite large. But I think we need to be quite careful about using `200 OK` in situations where some cluster member could still be accepting new data in a shard on death row.\r\n\r\nWhat do you think?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369037334/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369039661","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-369039661","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":369039661,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTAzOTY2MQ==","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T21:53:22Z","updated_at":"2018-02-27T21:53:22Z","author_association":"CONTRIBUTOR","body":"@pierrekilly good point on it being a different types of parameter. It's not just linear difference. Maybe call it `bcrypt_work_factor`. In other words it seems work factor parameters are specific for the algorithm. `scrypt` in turn seems to have a factor which is a CPU/memory cost parameter which doesn't seem to exactly map to bcrypt rounds or iterations in PBKDF2","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369039661/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369066063","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-369066063","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":369066063,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTA2NjA2Mw==","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-27T23:34:22Z","updated_at":"2018-02-27T23:34:22Z","author_association":"MEMBER","body":"definitely a separate parameter as they are not comparable.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369066063/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369270935","html_url":"https://github.com/apache/couchdb/pull/496#issuecomment-369270935","issue_url":"https://api.github.com/repos/apache/couchdb/issues/496","id":369270935,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTI3MDkzNQ==","user":{"login":"davisp","id":19929,"node_id":"MDQ6VXNlcjE5OTI5","avatar_url":"https://avatars.githubusercontent.com/u/19929?v=4","gravatar_id":"","url":"https://api.github.com/users/davisp","html_url":"https://github.com/davisp","followers_url":"https://api.github.com/users/davisp/followers","following_url":"https://api.github.com/users/davisp/following{/other_user}","gists_url":"https://api.github.com/users/davisp/gists{/gist_id}","starred_url":"https://api.github.com/users/davisp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisp/subscriptions","organizations_url":"https://api.github.com/users/davisp/orgs","repos_url":"https://api.github.com/users/davisp/repos","events_url":"https://api.github.com/users/davisp/events{/privacy}","received_events_url":"https://api.github.com/users/davisp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-28T15:15:25Z","updated_at":"2018-02-28T15:15:25Z","author_association":"MEMBER","body":"Last rebase. Will merge once CI comes back green.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369270935/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369297722","html_url":"https://github.com/apache/couchdb/issues/1184#issuecomment-369297722","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1184","id":369297722,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTI5NzcyMg==","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-28T16:32:58Z","updated_at":"2018-02-28T16:32:58Z","author_association":"CONTRIBUTOR","body":"Thanks for the report.\r\n\r\nWould it be possible to have an example document that generates this error.\r\n\r\nAlso if you search the logs for `818340776` it might show a stacktrace. Sanitize that log snippet and post it as it might also help solve the issue.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369297722/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369330927","html_url":"https://github.com/apache/couchdb/pull/1185#issuecomment-369330927","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1185","id":369330927,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTMzMDkyNw==","user":{"login":"davisp","id":19929,"node_id":"MDQ6VXNlcjE5OTI5","avatar_url":"https://avatars.githubusercontent.com/u/19929?v=4","gravatar_id":"","url":"https://api.github.com/users/davisp","html_url":"https://github.com/davisp","followers_url":"https://api.github.com/users/davisp/followers","following_url":"https://api.github.com/users/davisp/following{/other_user}","gists_url":"https://api.github.com/users/davisp/gists{/gist_id}","starred_url":"https://api.github.com/users/davisp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisp/subscriptions","organizations_url":"https://api.github.com/users/davisp/orgs","repos_url":"https://api.github.com/users/davisp/repos","events_url":"https://api.github.com/users/davisp/events{/privacy}","received_events_url":"https://api.github.com/users/davisp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-28T18:13:31Z","updated_at":"2018-02-28T18:13:31Z","author_association":"MEMBER","body":"Don't merge this yet. Just running some travis runs to try and trigger the failure in compaction daemons tests.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369330927/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369345885","html_url":"https://github.com/apache/couchdb/pull/1182#issuecomment-369345885","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1182","id":369345885,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTM0NTg4NQ==","user":{"login":"obi458","id":3896482,"node_id":"MDQ6VXNlcjM4OTY0ODI=","avatar_url":"https://avatars.githubusercontent.com/u/3896482?v=4","gravatar_id":"","url":"https://api.github.com/users/obi458","html_url":"https://github.com/obi458","followers_url":"https://api.github.com/users/obi458/followers","following_url":"https://api.github.com/users/obi458/following{/other_user}","gists_url":"https://api.github.com/users/obi458/gists{/gist_id}","starred_url":"https://api.github.com/users/obi458/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/obi458/subscriptions","organizations_url":"https://api.github.com/users/obi458/orgs","repos_url":"https://api.github.com/users/obi458/repos","events_url":"https://api.github.com/users/obi458/events{/privacy}","received_events_url":"https://api.github.com/users/obi458/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-28T19:00:48Z","updated_at":"2018-02-28T19:23:35Z","author_association":"NONE","body":"I don't give up :-)\r\n\r\n```\r\nincref(#db{fd = Fd} = Db) ->\r\n    incref(Db,couch_file:lock(Fd)).\r\n\r\nincref(#db{fd = Fd} = Db, true = _Locked) ->\r\n    % first monitor\r\n    Ref = erlang:monitor(process, Fd),\r\n    % than release the lock\r\n    couch_file:unlock(Fd),\r\n    {ok, Db#db{fd_monitor = Ref}};\r\n% we are not able to write the lock,\r\n% either the file will be closed or another process want to monitor\r\n% we will try it again\r\nincref(#db{fd = _Fd} = _Db, false = _Locked) ->\r\n    retry.\r\n```\r\n\r\ncouch_file:\r\n\r\n```\r\n% System dbs aren't monitored by couch_stats_process_tracker\r\nis_idle(#file{is_sys=true}) ->\r\n    case process_info(self(), monitored_by) of\r\n        {monitored_by, []} -> lock(self());\r\n        _ -> false\r\n    end;\r\nis_idle(#file{is_sys=false}) ->\r\n    Tracker = whereis(couch_stats_process_tracker),\r\n    case process_info(self(), monitored_by) of\r\n        {monitored_by, []} -> lock(self());\r\n        {monitored_by, [Tracker]} -> lock(self());\r\n        {monitored_by, [_]} -> exit(tracker_monitoring_failed);\r\n        _ -> false\r\n    end.\r\n\r\nlock(Fd) -> try\r\n                ets:new(list_to_atom(pid_to_list(Fd)), [named_table]), true\r\n            catch\r\n                _:_ -> false\r\n            end.\r\nunlock(Fd) -> ets:delete(list_to_atom(pid_to_list(Fd))).\r\n```\r\n\r\ncouchd_db_updater:\r\n\r\n```\r\nhandle_info(timeout, #db{fd=Fd, name=DbName} = Db) ->\r\n    IdleLimitMSec = update_idle_limit_from_config(),\r\n    case couch_db:is_idle(Db) of\r\n        true ->\r\n            % we have to unlock Fd, cause close_db_if_idle will check is_idle again\r\n            couch_file:unlock(Fd),\r\n            MSecSinceLastRead = couch_file:msec_since_last_read(Fd),\r\n            case MSecSinceLastRead > IdleLimitMSec of\r\n                true ->\r\n                    ok = couch_server:close_db_if_idle(DbName);\r\n                false ->\r\n                    ok\r\n            end;\r\n        false ->\r\n            ok\r\n    end,\r\n    % Send a message to wake up and then hibernate. Hibernation here is done to\r\n    % force a thorough garbage collection.\r\n    gen_server:cast(self(), wakeup),\r\n    {noreply, Db, hibernate}.\r\n```\r\n\r\ncouchd_db:\r\n\r\n```\r\nis_idle(#db{compactor_pid=nil, waiting_delayed_commit=nil} = Db) ->\r\n    monitored_by(Db) == [] andalso couch_file:lock(Db#db.fd);\r\nis_idle(_Db) ->\r\n    false.\r\n```\r\n\r\nProcess died -> ets died and lock will released!\r\n\r\n`timer:tc(fun() -> [begin couch_file:lock(self()), couch_file:unlock() end || _ <- lists:seq(1,1000000)] end).`\r\n\r\n{2191728,ok} on iMac Pro","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369345885/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369361539","html_url":"https://github.com/apache/couchdb/issues/1171#issuecomment-369361539","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1171","id":369361539,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTM2MTUzOQ==","user":{"login":"Nanonid","id":1835820,"node_id":"MDQ6VXNlcjE4MzU4MjA=","avatar_url":"https://avatars.githubusercontent.com/u/1835820?v=4","gravatar_id":"","url":"https://api.github.com/users/Nanonid","html_url":"https://github.com/Nanonid","followers_url":"https://api.github.com/users/Nanonid/followers","following_url":"https://api.github.com/users/Nanonid/following{/other_user}","gists_url":"https://api.github.com/users/Nanonid/gists{/gist_id}","starred_url":"https://api.github.com/users/Nanonid/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Nanonid/subscriptions","organizations_url":"https://api.github.com/users/Nanonid/orgs","repos_url":"https://api.github.com/users/Nanonid/repos","events_url":"https://api.github.com/users/Nanonid/events{/privacy}","received_events_url":"https://api.github.com/users/Nanonid/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-28T19:51:29Z","updated_at":"2018-02-28T19:51:29Z","author_association":"NONE","body":"If we add a check for[ FIPS_mode() ](https://wiki.openssl.org/index.php/FIPS_mode())and fall back on erlang:MD5 if enabled, that would be least disturbing for non-FIPS users. Does this sound acceptable as a pull request? (only hypothesis right now)\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369361539/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369420178","html_url":"https://github.com/apache/couchdb/issues/1171#issuecomment-369420178","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1171","id":369420178,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTQyMDE3OA==","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-02-28T23:28:43Z","updated_at":"2018-02-28T23:28:43Z","author_association":"MEMBER","body":"Hm not really. The function you want to call doesn’t exist in all the versions of Erlang we support. \n\nSent from my iPhone\n\n> On 28 Feb 2018, at 19:51, Nanonid <notifications@github.com> wrote:\n> \n> If we add a check for FIPS_mode() and fall back on erlang:MD5 if enabled, that would be least disturbing for non-FIPS users. Does this sound acceptable as a pull request? (only hypothesis right now)\n> \n> —\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub, or mute the thread.\n> \n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369420178/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369447881","html_url":"https://github.com/apache/couchdb/issues/745#issuecomment-369447881","issue_url":"https://api.github.com/repos/apache/couchdb/issues/745","id":369447881,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTQ0Nzg4MQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-01T01:53:44Z","updated_at":"2018-03-01T02:09:55Z","author_association":"MEMBER","body":"So in testing with a client, this no longer hangs/crashes/eats all the RAM, but it does still cause an issue where a too-large request body fails to transmit a document. The replicator thinks it HAS successfully transferred the document, and declares replication successful. A subsequent attempt to GET the document results in a 404.\r\n\r\nHere is a censored excerpt from the logfile of the situation:\r\n\r\n```\r\n[notice] 2018-02-27T01:16:58.004513Z couchdb@127.0.0.1 <0.31509.279> 0f1a3bf01b localhost:5984 127.0.0.1 undefined GET /_scheduler/docs/_replicator/862944988a0e42e8e7567da18c863571 200 ok 0\r\n[notice] 2018-02-27T01:17:07.843508Z couchdb@127.0.0.1 <0.24829.275> -------- Starting replication 2def458d381dd99fa1f4e4887b5b9775+create_target (http://localhost:5984/db1/ -> http://localhost:5984/db2/) from doc _replicator:862944988a0e42e8e7567da18c863571 worker_procesess:4 worker_batch_size:500 session_id:bfafe761a21c1ea012228fc2df6790a9\r\n[notice] 2018-02-27T01:17:07.843558Z couchdb@127.0.0.1 <0.24829.275> -------- Document `862944988a0e42e8e7567da18c863571` triggered replication `2def458d381dd99fa1f4e4887b5b9775+create_target`\r\n\r\n[notice] 2018-02-27T01:17:10.600494Z couchdb@127.0.0.1 <0.18679.277> 66a9b51dfd localhost:5984 127.0.0.1 undefined GET /db1/foo?revs=true&open_revs=%5B%222-d32df74e77cfebcc08455cda37518117%22%5D&latest=true 200 ok 2668\r\n[error] 2018-02-27T01:17:10.869278Z couchdb@127.0.0.1 <0.23437.278> -------- Replicator: error writing document `foo` to `http://localhost:5984/db2/`: {error,request_body_too_large}\r\n[notice] 2018-02-27T01:17:27.107006Z couchdb@127.0.0.1 <0.24829.275> -------- Replication `2def458d381dd99fa1f4e4887b5b9775+create_target` completed (triggered by `862944988a0e42e8e7567da18c863571`)\r\n\r\n[notice] 2018-02-27T01:18:05.754340Z couchdb@127.0.0.1 <0.24230.274> 2a9c5d5507 localhost:5984 127.0.0.1 undefined GET /db2/foo 404 ok 1\r\n```\r\n\r\nNote that in extensive testing, this has only happened four times, so I'm not sure I can provide an easy reproducer here, but we'll keep at it.\r\n\r\nCouch was running at the info log level for this test, so I'm going bump it up to debug level and try the test again, hoping for a duplicate.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369447881/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369465780","html_url":"https://github.com/apache/couchdb/issues/745#issuecomment-369465780","issue_url":"https://api.github.com/repos/apache/couchdb/issues/745","id":369465780,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTQ2NTc4MA==","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-01T03:49:33Z","updated_at":"2018-03-01T03:49:33Z","author_association":"CONTRIBUTOR","body":"If some requests fail with a 413 it's not surprising that it completes. It should bump the `doc_write_failures` stats in the completion record to indicate how many documents it failed to write.\r\n\r\nThe question is why does that one request fail with a 413 to start with. \r\n\r\nGood call on debug logs. Also what are the are the doc sizes involved, how many revisions per document. Any attachments? Then what are the `[couchdb] max_document_size` , `[couchdb] max_attachment_size` and `[httpd] max_http_request_size` params.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369465780/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369467559","html_url":"https://github.com/apache/couchdb/issues/745#issuecomment-369467559","issue_url":"https://api.github.com/repos/apache/couchdb/issues/745","id":369467559,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTQ2NzU1OQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-01T04:03:03Z","updated_at":"2018-03-01T04:17:06Z","author_association":"MEMBER","body":"Yes attachments. you can see revisions per doc are low. in the log.\r\n\r\nEverything else is default. (Working around this by bumping the defaults is just sweeping the error under the rug...)\r\n\r\nOf course, we should be replicating the document. Why is it even getting a 413 in the first place? It's replicating a document from the same server to the same server, no settings have changed, surely it should be able to PUT a document it just did a GET of from itself. I believe this test (I didn't write it) runs in a loop, so the data is being replicated over and over from one database to the next on the same server.\r\n\r\nFinally, even with a bumped `doc_write_failures` value, calling this a `completed` replication is a VERY surprising result. Unless you think to check `/_scheduler/docs` for the failed document count, or compare source/target document counts, you'd never know there was a failure.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369467559/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369486100","html_url":"https://github.com/apache/couchdb/issues/1008#issuecomment-369486100","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1008","id":369486100,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTQ4NjEwMA==","user":{"login":"dc0d","id":3826814,"node_id":"MDQ6VXNlcjM4MjY4MTQ=","avatar_url":"https://avatars.githubusercontent.com/u/3826814?v=4","gravatar_id":"","url":"https://api.github.com/users/dc0d","html_url":"https://github.com/dc0d","followers_url":"https://api.github.com/users/dc0d/followers","following_url":"https://api.github.com/users/dc0d/following{/other_user}","gists_url":"https://api.github.com/users/dc0d/gists{/gist_id}","starred_url":"https://api.github.com/users/dc0d/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dc0d/subscriptions","organizations_url":"https://api.github.com/users/dc0d/orgs","repos_url":"https://api.github.com/users/dc0d/repos","events_url":"https://api.github.com/users/dc0d/events{/privacy}","received_events_url":"https://api.github.com/users/dc0d/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-01T06:19:05Z","updated_at":"2018-03-01T06:19:29Z","author_association":"NONE","body":"Same error (on verify installation, installed via snap on Ubuntu 16.04). Also it installs 2.0.0 instead of 2.1.1.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369486100/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369530770","html_url":"https://github.com/apache/couchdb/pull/1160#issuecomment-369530770","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1160","id":369530770,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTUzMDc3MA==","user":{"login":"pierrekilly","id":1321703,"node_id":"MDQ6VXNlcjEzMjE3MDM=","avatar_url":"https://avatars.githubusercontent.com/u/1321703?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrekilly","html_url":"https://github.com/pierrekilly","followers_url":"https://api.github.com/users/pierrekilly/followers","following_url":"https://api.github.com/users/pierrekilly/following{/other_user}","gists_url":"https://api.github.com/users/pierrekilly/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrekilly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrekilly/subscriptions","organizations_url":"https://api.github.com/users/pierrekilly/orgs","repos_url":"https://api.github.com/users/pierrekilly/repos","events_url":"https://api.github.com/users/pierrekilly/events{/privacy}","received_events_url":"https://api.github.com/users/pierrekilly/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-01T09:25:02Z","updated_at":"2018-03-01T09:25:02Z","author_association":"NONE","body":"Ho, and I forgot to mention that `logRounds` is actually the name used in bcrypt itself, so that name seemd appropriate to me.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369530770/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369699515","html_url":"https://github.com/apache/couchdb/pull/1176#issuecomment-369699515","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1176","id":369699515,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTY5OTUxNQ==","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-01T19:17:08Z","updated_at":"2018-03-01T19:17:08Z","author_association":"MEMBER","body":"I've enabled this with;\r\n\r\n+auth_plugins = couch_replicator_auth_session,couch_replicator_auth_noop\r\n\r\n\r\nand used sys:get_state(Pid) to look at the state of a replicator task.\r\n\r\nauth_props remains [].\r\n\r\nUntil I see this work, it's -1 from me.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369699515/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369707222","html_url":"https://github.com/apache/couchdb/pull/1186#issuecomment-369707222","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1186","id":369707222,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTcwNzIyMg==","user":{"login":"davisp","id":19929,"node_id":"MDQ6VXNlcjE5OTI5","avatar_url":"https://avatars.githubusercontent.com/u/19929?v=4","gravatar_id":"","url":"https://api.github.com/users/davisp","html_url":"https://github.com/davisp","followers_url":"https://api.github.com/users/davisp/followers","following_url":"https://api.github.com/users/davisp/following{/other_user}","gists_url":"https://api.github.com/users/davisp/gists{/gist_id}","starred_url":"https://api.github.com/users/davisp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisp/subscriptions","organizations_url":"https://api.github.com/users/davisp/orgs","repos_url":"https://api.github.com/users/davisp/repos","events_url":"https://api.github.com/users/davisp/events{/privacy}","received_events_url":"https://api.github.com/users/davisp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-01T19:42:18Z","updated_at":"2018-03-01T19:42:18Z","author_association":"MEMBER","body":"So thinking more on this, I think the best approach is to not upgrade the purge values to a tree until we get a purge request. Thus for the normal case when a customer has no purge activity before and after the upgrade/downgrade there won't be any issue.\r\n\r\nI'm also trying to decide if we should change the disk version for this instead of just altering the purge_docs field contents.\r\n\r\nThe thing I'm most worried about at this point is what happens when we downgrade after purge requests have been issued over the new API. If we're doing this quickly then its likely that we'd have to invalidate all secondary indexes to be sure they're valid? Or else make some sort of check against all of the _local purge docs?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369707222/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369755692","html_url":"https://github.com/apache/couchdb/pull/1190#issuecomment-369755692","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1190","id":369755692,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTc1NTY5Mg==","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-01T22:37:52Z","updated_at":"2018-03-01T22:37:52Z","author_association":"CONTRIBUTOR","body":"```\r\nsrc/couch_att.erl:181: Function new/0 has no local return\r\nsrc/couch_att.erl:188: Record construction #att{name::'undefined',type::'undefined',att_len::'undefined',disk_len::'undefined',md5::<<>>,revpos::0,data::'undefined',encoding::'identity'} violates the declared type of field name::binary() and type::binary() and att_len::non_neg_integer() and disk_len::non_neg_integer() and data::'follows' | 'stub' | binary() | fun(() -> binary()) | {_,_} | {'follows',pid(),reference()}\r\nsrc/couch_att.erl:192: Function new/1 has no local return\r\nsrc/couch_att.erl:408: Function from_json/2 has no local return\r\nsrc/couch_att.erl:422: Function stub_from_json/2 will never be called\r\nsrc/couch_att.erl:435: Function follow_from_json/2 will never be called\r\nsrc/couch_att.erl:445: Function inline_from_json/2 will never be called\r\nsrc/couch_att.erl:464: Function encoded_lengths_from_json/1 will never be called\r\nsrc/couch_att.erl:477: Function digest_from_json/1 will never be called\r\n```\r\nLooks good no from_disk_term errors","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369755692/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369814422","html_url":"https://github.com/apache/couchdb/issues/745#issuecomment-369814422","issue_url":"https://api.github.com/repos/apache/couchdb/issues/745","id":369814422,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTgxNDQyMg==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-02T04:08:51Z","updated_at":"2018-03-02T06:25:27Z","author_association":"MEMBER","body":"We're now hard-rejecting attachments greater than `max_http_request_size`, sadly.\r\n\r\n@nickva I have an excellent reproducible case:\r\n\r\n1. Build couchdb, master, latest.\r\n1. Set up my `makeit.py` script from [this comment](https://github.com/apache/couchdb/issues/745#issuecomment-351301113).\r\n1. Run `dev/run -n 1 --with-admin-party-please`.\r\n1. Run `curl -X PUT localhost:15984/foo`\r\n1. Edit the URL in `makeit.py` to reflect `http://localhost:15984/foo`.\r\n1. After entering the `virtualenv` for `makeit.py`, run: `python ./makeit.py 10 --size=75000000`\r\n1. Start a replication: `curl -X PUT localhost:15984/_replicator/bar -d '{\"source\": \"http://localhost:15984/foo\", \"target\": \"http://localhost:15984/bar\", \"create_target\": true}'`\r\n1. Watch the sparks fly.\r\n\r\n/cc @janl ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369814422/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369880364","html_url":"https://github.com/apache/couchdb/pull/1176#issuecomment-369880364","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1176","id":369880364,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTg4MDM2NA==","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-02T10:11:33Z","updated_at":"2018-03-02T10:11:33Z","author_association":"MEMBER","body":"ok, figured out my mistake. It does acquire cookies. I'll finish the code review itself today.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369880364/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369905803","html_url":"https://github.com/apache/couchdb/issues/745#issuecomment-369905803","issue_url":"https://api.github.com/repos/apache/couchdb/issues/745","id":369905803,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTkwNTgwMw==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-02T12:14:44Z","updated_at":"2018-03-02T12:14:44Z","author_association":"MEMBER","body":"Great repro Joan. I played with it and came up with this:\r\n\r\nThe python script uses the standalone attachment API: `/db/doc/att` The handler for this request does NOT apply `max_http_request_size` (which happens in [`chttpd:body/2`](https://github.com/apache/couchdb/blob/master/src/chttpd/src/chttpd.erl#L628-L643) or [couch_httpd:check_max_request_length()](https://github.com/apache/couchdb/blob/master/src/couch/src/couch_httpd.erl#L452-L460), neither of which is used by the standalone attachment API).\r\n\r\nThe twist now is that the replicator uses multipart requests and not standalone attachment requests. Multipart requests are subject to the `max_http_request_size` limit.\r\n\r\nThis leads to the observed behaviour that you can create an attachment in one db and can NOT replicate that attachment to another db on the same CouchDB node (or another node with the same `max_http_request_size` limit).\r\n\r\nApplying `max_http_request_size` in the standalone attachment API is trivial[1], but leads to the next unfortunate behaviour:\r\n\r\nSay you create a doc with two attachments, with a length that is just under `max_http_request_size`, each individual attachment write will succeed, but replicating it to another db will, again, produce a multipart request that overall is > `max_http_request_size`.\r\n\r\nI haven’t checked this, but a conflicting doc with one attachment < `max_http_request_size` where the attachment data is conflicted might also produce a multipart http request > `max_http_request_size` to replicate both conflicting revisions and attachment bodies.\r\n\r\nThis leads us to having to decide:\r\n1. is `max_http_request_size` a hard hard hard limit or do we accept requests larger than that, if they are multipart http requests?\r\n  - if yes, do we apply the `max_document_size` and `max_attachment_size` to individual chunks of the multipart request?\r\n2. if not 1., do we need to rewrite the replicator to not produce requests > `max_http_request_size` and potentially do attachments individually?\r\n\r\n\r\nReferences:\r\n[1]:\r\n```diff\r\n--- a/src/chttpd/src/chttpd_db.erl\r\n+++ b/src/chttpd/src/chttpd_db.erl\r\n@@ -1218,6 +1218,7 @@ db_attachment_req(#httpd{method=Method, user_ctx=Ctx}=Req, Db, DocId, FileNamePa\r\n                 undefined -> <<\"application/octet-stream\">>;\r\n                 CType -> list_to_binary(CType)\r\n             end,\r\n+           couch_httpd:check_max_request_length(Req),\r\n            Data = fabric:att_receiver(Req, chttpd:body_length(Req)),\r\n            ContentLen = case couch_httpd:header_value(Req,\"Content-Length\") of\r\n                undefined -> undefined;\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369905803/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369913191","html_url":"https://github.com/apache/couchdb/issues/745#issuecomment-369913191","issue_url":"https://api.github.com/repos/apache/couchdb/issues/745","id":369913191,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTkxMzE5MQ==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-02T12:52:43Z","updated_at":"2018-03-02T12:54:01Z","author_association":"MEMBER","body":"Shorter repro that runs quickly, tests the 1 attachment > `max_http_request_size` as well as the 2 attachments < `max_http_request_size` but att1 + att2 > `max_http_request_size` cases.\r\n\r\nLook for the two instances of `\"doc_write_failures\":1` in the output.\r\n\r\n```sh\r\n#!/bin/sh\r\n\r\nCOUCH=http://127.0.0.1:15984\r\nINT=http://127.0.0.1:15986\r\nDBA=$COUCH/db\r\nDBB=$COUCH/dbb\r\n\r\n# cleanup\r\ncurl -X DELETE $DBA\r\ncurl -X DELETE $DBB\r\n\r\n# setup\r\ncurl -X PUT $DBA\r\ncurl -X PUT $DBB\r\n\r\n# config\r\ncurl -X PUT $INT/_config/httpd/max_http_request_size -d '\"1500\"'\r\ncurl -X PUT $INT/_config/replicator/retries_per_request -d '\"1\"'\r\n\r\n# create an att > max_http_request_size, should succeed\r\n# 3000 here as not to run into _local checkpoint size limits\r\nBODY3000=11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\ncurl -X PUT http://127.0.0.1:15984/db/doc/att --data-binary \"$BODY3000\" -Hcontent-type:application/octet-stream\r\n\r\n# replicate, should suceed, but with one doc_write_failure\r\ncurl -X POST $COUCH/_replicate -d \"{\\\"source\\\": \\\"$DBA\\\", \\\"target\\\": \\\"$DBB\\\"}\" -H content-type:application/json\r\n\r\n\r\n\r\n# create two atts, each < max_http_request_size, but att1+att2 > max_http_request_size\r\n\r\n\r\n# cleanup\r\ncurl -X DELETE $DBA\r\ncurl -X DELETE $DBB\r\n\r\n# setup\r\ncurl -X PUT $DBA\r\ncurl -X PUT $DBB\r\n\r\n\r\nBODY1500=11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\r\nREV=`curl -sX PUT http://127.0.0.1:15984/db/doc1/att --data-binary \"$BODY1500\" -Hcontent-type:application/octet-stream | cut -b 31-64`\r\n\r\ncurl -X PUT http://127.0.0.1:15984/db/doc1/att2?rev=$REV --data-binary \"$BODY1500\" -Hcontent-type:application/octet-stream\r\n\r\n# replicate, should suceed, but with one doc_write_failure\r\ncurl -X POST $COUCH/_replicate -d \"{\\\"source\\\": \\\"$DBA\\\", \\\"target\\\": \\\"$DBB\\\"}\" -H content-type:application/json\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369913191/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369931784","html_url":"https://github.com/apache/couchdb/pull/1186#issuecomment-369931784","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1186","id":369931784,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTkzMTc4NA==","user":{"login":"jiangphcn","id":18000622,"node_id":"MDQ6VXNlcjE4MDAwNjIy","avatar_url":"https://avatars.githubusercontent.com/u/18000622?v=4","gravatar_id":"","url":"https://api.github.com/users/jiangphcn","html_url":"https://github.com/jiangphcn","followers_url":"https://api.github.com/users/jiangphcn/followers","following_url":"https://api.github.com/users/jiangphcn/following{/other_user}","gists_url":"https://api.github.com/users/jiangphcn/gists{/gist_id}","starred_url":"https://api.github.com/users/jiangphcn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jiangphcn/subscriptions","organizations_url":"https://api.github.com/users/jiangphcn/orgs","repos_url":"https://api.github.com/users/jiangphcn/repos","events_url":"https://api.github.com/users/jiangphcn/events{/privacy}","received_events_url":"https://api.github.com/users/jiangphcn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-02T14:15:44Z","updated_at":"2018-03-02T14:15:44Z","author_association":"CONTRIBUTOR","body":"Thanks @davisp for pointing out about possibility of index being rebuilt. It looks to me that it is good idea of not upgrading the purge values to a tree until we get a purge request. I need some time to implement them. ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369931784/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369940332","html_url":"https://github.com/apache/couchdb/pull/1192#issuecomment-369940332","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1192","id":369940332,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTk0MDMzMg==","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-02T14:47:43Z","updated_at":"2018-03-02T14:47:43Z","author_association":"MEMBER","body":"+1","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369940332/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369954361","html_url":"https://github.com/apache/couchdb/pull/1193#issuecomment-369954361","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1193","id":369954361,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTk1NDM2MQ==","user":{"login":"eiri","id":70542,"node_id":"MDQ6VXNlcjcwNTQy","avatar_url":"https://avatars.githubusercontent.com/u/70542?v=4","gravatar_id":"","url":"https://api.github.com/users/eiri","html_url":"https://github.com/eiri","followers_url":"https://api.github.com/users/eiri/followers","following_url":"https://api.github.com/users/eiri/following{/other_user}","gists_url":"https://api.github.com/users/eiri/gists{/gist_id}","starred_url":"https://api.github.com/users/eiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eiri/subscriptions","organizations_url":"https://api.github.com/users/eiri/orgs","repos_url":"https://api.github.com/users/eiri/repos","events_url":"https://api.github.com/users/eiri/events{/privacy}","received_events_url":"https://api.github.com/users/eiri/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-02T15:34:24Z","updated_at":"2018-03-02T15:34:24Z","author_association":"MEMBER","body":"Using `chttpd:send_error/4` seems to be closer to the original intent? It's public func as well.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369954361/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369983259","html_url":"https://github.com/apache/couchdb/pull/1194#issuecomment-369983259","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1194","id":369983259,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTk4MzI1OQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-02T17:01:08Z","updated_at":"2018-03-02T17:01:08Z","author_association":"MEMBER","body":"For reference, Jenkins is running this branch's PR here: https://builds.apache.org/blue/organizations/jenkins/CouchDB/detail/jenkins-faster/1/pipeline","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/369983259/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370007031","html_url":"https://github.com/apache/couchdb/pull/1186#issuecomment-370007031","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1186","id":370007031,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDAwNzAzMQ==","user":{"login":"davisp","id":19929,"node_id":"MDQ6VXNlcjE5OTI5","avatar_url":"https://avatars.githubusercontent.com/u/19929?v=4","gravatar_id":"","url":"https://api.github.com/users/davisp","html_url":"https://github.com/davisp","followers_url":"https://api.github.com/users/davisp/followers","following_url":"https://api.github.com/users/davisp/following{/other_user}","gists_url":"https://api.github.com/users/davisp/gists{/gist_id}","starred_url":"https://api.github.com/users/davisp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisp/subscriptions","organizations_url":"https://api.github.com/users/davisp/orgs","repos_url":"https://api.github.com/users/davisp/repos","events_url":"https://api.github.com/users/davisp/events{/privacy}","received_events_url":"https://api.github.com/users/davisp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-02T18:21:01Z","updated_at":"2018-03-02T18:21:01Z","author_association":"MEMBER","body":"Yeah, but this is also gonna play badly with internal replication which will also try pushing and pulling those things across. Also trying to figure out index resets when we upgrade and have an old index that's not queried very often. Am trying to figure out if there's a way to force all indexes to write out their tracking doc without forcing indexing to start.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370007031/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370007393","html_url":"https://github.com/apache/couchdb/pull/1186#issuecomment-370007393","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1186","id":370007393,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDAwNzM5Mw==","user":{"login":"davisp","id":19929,"node_id":"MDQ6VXNlcjE5OTI5","avatar_url":"https://avatars.githubusercontent.com/u/19929?v=4","gravatar_id":"","url":"https://api.github.com/users/davisp","html_url":"https://github.com/davisp","followers_url":"https://api.github.com/users/davisp/followers","following_url":"https://api.github.com/users/davisp/following{/other_user}","gists_url":"https://api.github.com/users/davisp/gists{/gist_id}","starred_url":"https://api.github.com/users/davisp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisp/subscriptions","organizations_url":"https://api.github.com/users/davisp/orgs","repos_url":"https://api.github.com/users/davisp/repos","events_url":"https://api.github.com/users/davisp/events{/privacy}","received_events_url":"https://api.github.com/users/davisp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-02T18:21:40Z","updated_at":"2018-03-02T18:21:40Z","author_association":"MEMBER","body":"However that seems like it'd get awfully complicated quite quickly. Am trying to avoid having a large impact on clusters that have lots of unused indexes.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370007393/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370097873","html_url":"https://github.com/apache/couchdb/pull/1199#issuecomment-370097873","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1199","id":370097873,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDA5Nzg3Mw==","user":{"login":"chewbranca","id":5326,"node_id":"MDQ6VXNlcjUzMjY=","avatar_url":"https://avatars.githubusercontent.com/u/5326?v=4","gravatar_id":"","url":"https://api.github.com/users/chewbranca","html_url":"https://github.com/chewbranca","followers_url":"https://api.github.com/users/chewbranca/followers","following_url":"https://api.github.com/users/chewbranca/following{/other_user}","gists_url":"https://api.github.com/users/chewbranca/gists{/gist_id}","starred_url":"https://api.github.com/users/chewbranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chewbranca/subscriptions","organizations_url":"https://api.github.com/users/chewbranca/orgs","repos_url":"https://api.github.com/users/chewbranca/repos","events_url":"https://api.github.com/users/chewbranca/events{/privacy}","received_events_url":"https://api.github.com/users/chewbranca/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-03T00:36:24Z","updated_at":"2018-03-03T00:36:24Z","author_association":"CONTRIBUTOR","body":"+0.5 from me (after the WS nit). The approach seems fine, but I don't have strong enough opinions on removal of Fauxton from `:5986` to give it a full +1, so it would be good to get some more feedback.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370097873/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370106652","html_url":"https://github.com/apache/couchdb/issues/1010#issuecomment-370106652","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1010","id":370106652,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDEwNjY1Mg==","user":{"login":"vitaly-goot","id":6166649,"node_id":"MDQ6VXNlcjYxNjY2NDk=","avatar_url":"https://avatars.githubusercontent.com/u/6166649?v=4","gravatar_id":"","url":"https://api.github.com/users/vitaly-goot","html_url":"https://github.com/vitaly-goot","followers_url":"https://api.github.com/users/vitaly-goot/followers","following_url":"https://api.github.com/users/vitaly-goot/following{/other_user}","gists_url":"https://api.github.com/users/vitaly-goot/gists{/gist_id}","starred_url":"https://api.github.com/users/vitaly-goot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vitaly-goot/subscriptions","organizations_url":"https://api.github.com/users/vitaly-goot/orgs","repos_url":"https://api.github.com/users/vitaly-goot/repos","events_url":"https://api.github.com/users/vitaly-goot/events{/privacy}","received_events_url":"https://api.github.com/users/vitaly-goot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-03T01:57:28Z","updated_at":"2018-03-03T01:57:28Z","author_association":"CONTRIBUTOR","body":"Having a similar issue on CouchDB-1.6.x \r\nHere are some additional debugging info, if that could help:\r\n\r\n`lsof` in my case show leak on file descriptor #23.\r\n```beam.smp 2471 root   23u      REG    253,0     2355299   95256735 /ghostcache/edgedata/data/.delete/0d697973b6cd6b71c0d726878c1ffaed (deleted)```\r\n\r\nHere is a backtrace reported by process_info on erlang PID that holds that descriptor:\r\n```\r\n[{current_function,{gen_server,loop,6}},\r\n {initial_call,{proc_lib,init_p,5}},\r\n {status,waiting},\r\n {message_queue_len,0},\r\n {messages,[]},\r\n {links,[#Port<1941.3912>,<1941.244.0>]},\r\n {dictionary,[{'$ancestors',[<1941.241.0>]},\r\n              {'$initial_call',{couch_file,init,1}}]},\r\n {trap_exit,true},\r\n {error_handler,error_handler},\r\n {priority,normal},\r\n {group_leader,<1941.111.0>},\r\n {total_heap_size,1597},\r\n {heap_size,987},\r\n {stack_size,9},\r\n {reductions,1749931},\r\n {garbage_collection,[{min_bin_vheap_size,46368},\r\n                      {min_heap_size,233},\r\n                      {fullsweep_after,65535},\r\n                      {minor_gcs,987}]},\r\n {suspending,[]}]\r\n\r\n\r\n {<1941.242.0>,^M\r\n  {backtrace,<<\"Program counter: 0x00007f5924aeed40 (gen_server:loop/6 + 264)\\nCP: 0x0000000000000000 (invalid)\\narity = 0\\n\\n0x00007f592b3e5fe0 Return addr 0x00007f5924ae72b0 (proc_lib:init_p_do_apply/3 + 56)\\ny(0)     []\\ny(1)     infinity\\ny(2)     couch_file\\ny(3)     {file,{file_descriptor,prim_file,{#Port<0.3912>,23}},true,2445427,<0.244.0>}\\ny(4)     <0.242.0>\\ny(5)     <0.241.0>\\n\\n0x00007f592b3e6018 Return addr 0x00000000008a6278 (<terminate process normally>)\\ny(0)     Catch 0x00007f5924ae72d0 (proc_lib:init_p_do_apply/3 + 88)\\n\">>}},^M\r\n```\r\n\r\nAnd here is a backtrace reported by process info of linked process`{links,[#Port<1941.3912>,<1941.244.0>]}` \r\n\r\n```\r\n{backtrace,<<\"Program counter: 0x00000000008a6270 (unknown function)\\nCP: 0x00000000008a6278 (<terminate process normally>)\\narity = 3\\n   proc_lib\\n   wake_up\\n   [gen_server,wake_hib,[<0.241.0>,<0.244.0>,{db,<0.244.0>,nil,<<16 bytes>>,<0.3382.2688>,#Ref<0.0.3410.8669>,{db_header,6,15,0,{125165,{6,0,115324},2264},{116902,6,1558},{140103,[],5187},0,nil,nil,1000},15,{btree,<0.3382.2688>,{125165,{6,0,115324},2264},#Fun<couch_db_updater.btree_by_id_split.1>,#Fun<couch_db_updater.btree_by_id_join.2>,undefined,#Fun<couch_db_updater.btree_by_id_reduce.2>,snappy},{btree,<0.3382.2688>,{116902,6,1558},#Fun<couch_db_updater.btree_by_seq_split.1>,#Fun<couch_db_updater.btree_by_seq_join.2>,undefined,#Fun<couch_db_updater.btree_by_seq_reduce.2>,snappy},{btree,<0.3382.2688>,{140103,[],5187},undefined,undefined,undefined,nil,snappy},15,<<3 bytes>>,\\\"/ghostcache/edgedata/data/dbs.couch\\\",[],[],nil,{user_ctx,null,[<<6 bytes>>],undefined,write},nil,nil,1000,[before_header,after_header,on_file_open],[sys_db,{user_ctx,{user_ctx,null,[<<6 bytes>>],undefined,write}}],snappy,nil,nil},couch_db_updater,[]]]\\n\">>}\r\nok\r\n```\r\n\r\nIn that particular case it's related to `dbs.couch`.  \r\nI've seen similar issues related to `nodes.couch`  as well as data and view files.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370106652/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370115818","html_url":"https://github.com/apache/couchdb/issues/1010#issuecomment-370115818","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1010","id":370115818,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDExNTgxOA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-03T04:10:07Z","updated_at":"2018-03-03T04:10:07Z","author_association":"MEMBER","body":"Is anyone seeing this in 2.x?\r\n\r\n1.x is on sustaining support at this point - we will only release a new 1.x build if there is a security patch necessary.\r\n\r\nOnce 3.0 comes out, support for 1.x will terminate.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370115818/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370152925","html_url":"https://github.com/apache/couchdb/pull/1199#issuecomment-370152925","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1199","id":370152925,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDE1MjkyNQ==","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-03T14:51:12Z","updated_at":"2018-03-03T14:51:12Z","author_association":"MEMBER","body":"losing the CSP tests seems a bit unfortunate.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370152925/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370163316","html_url":"https://github.com/apache/couchdb/pull/1199#issuecomment-370163316","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1199","id":370163316,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDE2MzMxNg==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-03T17:07:09Z","updated_at":"2018-03-03T17:07:09Z","author_association":"MEMBER","body":"These were only testing CSP on the node-local port anyway. I can port them to chttpd, give me a day or two.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370163316/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370163471","html_url":"https://github.com/apache/couchdb/pull/1200#issuecomment-370163471","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1200","id":370163471,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDE2MzQ3MQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-03T17:09:26Z","updated_at":"2018-03-03T17:09:26Z","author_association":"MEMBER","body":"I haven't read everything yet, but you are failing `make check`:\r\n\r\n```\r\n    couch_doc_tests: doc_from_multi_part_stream_test...*failed*\r\nin function ets:lookup/2\r\n  called as lookup(config,{\"couchdb\",\"max_attachments_per_document\"})\r\nin call from config_meck_original:get/3 (src/config.erl, line 148)\r\nin call from config:get/3\r\n  called as get(\"couchdb\",\"max_attachments_per_document\",\"infinity\")\r\nin call from couch_att:max_attachment_count/0 (src/couch_att.erl, line 723)\r\nin call from couch_att:validate_attachment_count/1 (src/couch_att.erl, line 732)\r\nin call from couch_doc:from_json_obj_validate/2 (src/couch_doc.erl, line 138)\r\nin call from couch_doc:doc_from_multi_part_stream/4 (src/couch_doc.erl, line 466)\r\nin call from couch_doc_tests:doc_from_multi_part_stream_test/0 (test/couch_doc_tests.erl, line 34)\r\n**error:badarg\r\n  output:<<\"\">>\r\n    couch_doc_tests: doc_to_multi_part_stream_test...ok\r\n    couch_doc_tests: len_doc_to_multi_part_stream_test...ok\r\n    undefined\r\n    *** context setup failed ***\r\n**in function meck_proc:start/2 (src/meck_proc.erl, line 96)\r\n  called as start(config,[passthrough])\r\nin call from couch_doc_tests:mock_config/0 (test/couch_doc_tests.erl, line 138)\r\nin call from couch_doc_tests:'-validate_docid_test_/0-fun-34-'/0 (test/couch_doc_tests.erl, line 80)\r\n**error:{already_started,<0.28375.0>}\r\n  [done in 0.156 s]\r\n[done in 0.156 s]\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370163471/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370164647","html_url":"https://github.com/apache/couchdb/pull/1200#issuecomment-370164647","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1200","id":370164647,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDE2NDY0Nw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-03T17:26:05Z","updated_at":"2018-03-03T17:26:26Z","author_association":"MEMBER","body":"OK, I've had a read through. Looks good, though I have some comments.\r\n\r\nIn 2.2.0, shouldn't we raise the default `max_http_request_size` or reduce the default `max_document_size` so the default configuration doesn't end up with docs too big to replicate?\r\n\r\nWe should support `infinity` as a valid value for all of these `max_*` settings. We already do support `infinity for `max_attachment_size`.\r\n\r\nWe should enforce `max_attachment_* = 0` on the node-local port. We can either ignore, mirror, or hard-code the other limits on the node-local port. (And we should keep moving towards removing the node-local port entirely for 3.0.)\r\n\r\nI am +1 on the idea of setting `max_attachments_per_doc = 0` to disable attachments, and documenting this as a feature. We can even include text about it improving CouchDB performance, and point people at recommended external solutions for binary management if desired, especially if this is a pattern we are actively trying to discourage.\r\n\r\nI am -0 on `local.ini-recommended`, as I feel our defaults should already be the recommendations, for any release. If those settings can't yet be the default (as they would be in 2.2.0 vs. 3.0.0) then we should stick them in `local.ini` and just comment them out. People are already used to un-commenting lines in `local.ini` for things they want, let's continue with that pattern.\r\n\r\nThe only way I'd think `local.ini-*` files would make sense is if we wanted to start shipping different settings for different standard configurations: standalone node, 3-node cluster, db-per-user setups, etc. and that's still a bit of a bandaid. (The Debian packaging attempts to hide this type of configuration from the user; why not remove the smarts from the package and stick them right in the product instead? This is well beyond the scope of this PR.)\r\n\r\nAs a side-note, I'd like to move towards any (and all?) `default.ini` settings to be commented out, meaning the file is effectively empty for a new install and acts almost as documentation. We see in the field plenty of people who keep their old `default.ini` files around - this is especially a problem with the older `Docker` containers - so it'd be nice to eliminate that problem. I know this is challenging for our handler definitions right now, but at least numerical settings like these `max_*` settings could be resolved.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370164647/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370172189","html_url":"https://github.com/apache/couchdb/pull/1200#issuecomment-370172189","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1200","id":370172189,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDE3MjE4OQ==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-03T19:12:23Z","updated_at":"2018-03-03T19:12:23Z","author_association":"MEMBER","body":"> `make check`\r\n\r\nThe code is just meant to demonstrate how this could look. This PR is mainly meant for discussion\r\n\r\n> .ini-*\r\n\r\nSorry for bringing this up, I'll open another issue to discuss, it's orthogonal to this discussion.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370172189/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370177272","html_url":"https://github.com/apache/couchdb/issues/1010#issuecomment-370177272","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1010","id":370177272,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDE3NzI3Mg==","user":{"login":"ondra-novak","id":9439234,"node_id":"MDQ6VXNlcjk0MzkyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9439234?v=4","gravatar_id":"","url":"https://api.github.com/users/ondra-novak","html_url":"https://github.com/ondra-novak","followers_url":"https://api.github.com/users/ondra-novak/followers","following_url":"https://api.github.com/users/ondra-novak/following{/other_user}","gists_url":"https://api.github.com/users/ondra-novak/gists{/gist_id}","starred_url":"https://api.github.com/users/ondra-novak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ondra-novak/subscriptions","organizations_url":"https://api.github.com/users/ondra-novak/orgs","repos_url":"https://api.github.com/users/ondra-novak/repos","events_url":"https://api.github.com/users/ondra-novak/events{/privacy}","received_events_url":"https://api.github.com/users/ondra-novak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-03T20:27:16Z","updated_at":"2018-03-03T20:27:51Z","author_association":"NONE","body":"I tried to reproduce the issue on 2.1.1.\r\n\r\nI have to run compaction directly on port 5986 - on appropriate shard. The deleted file appears as leaked, however it is cleaned after a short period of time (without reporting anything to the log file).\r\n\r\nIt seems that somebody has already fixed this in the newest version. It probably performs some cleanup periodically (aprox each minute)\r\n\r\nBefore you close the issue please verify my observation.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370177272/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370185337","html_url":"https://github.com/apache/couchdb/issues/1010#issuecomment-370185337","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1010","id":370185337,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDE4NTMzNw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-03T22:33:58Z","updated_at":"2018-03-03T22:33:58Z","author_association":"MEMBER","body":"I'll leave this open as a 1.x issue in the eventuality someone wants to contribute a patch. Once 3.x releases I will mass-close all 1.x issues.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370185337/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370187107","html_url":"https://github.com/apache/couchdb/issues/796#issuecomment-370187107","issue_url":"https://api.github.com/repos/apache/couchdb/issues/796","id":370187107,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDE4NzEwNw==","user":{"login":"adyshimony","id":6388409,"node_id":"MDQ6VXNlcjYzODg0MDk=","avatar_url":"https://avatars.githubusercontent.com/u/6388409?v=4","gravatar_id":"","url":"https://api.github.com/users/adyshimony","html_url":"https://github.com/adyshimony","followers_url":"https://api.github.com/users/adyshimony/followers","following_url":"https://api.github.com/users/adyshimony/following{/other_user}","gists_url":"https://api.github.com/users/adyshimony/gists{/gist_id}","starred_url":"https://api.github.com/users/adyshimony/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adyshimony/subscriptions","organizations_url":"https://api.github.com/users/adyshimony/orgs","repos_url":"https://api.github.com/users/adyshimony/repos","events_url":"https://api.github.com/users/adyshimony/events{/privacy}","received_events_url":"https://api.github.com/users/adyshimony/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-03T23:06:00Z","updated_at":"2018-03-04T14:15:33Z","author_association":"NONE","body":"***Solved - scroll down to read solution**\r\n\r\nHi,\r\n\r\nI have the same issue with 60 dbs, running on a local computer, each db has 4 views, up to 2 millions docs for every DB. only the last db is being updated.\r\nI am getting emfile error, and shard db error, and errors are changing according to the query range.\r\nSometimes only one db returns error, sometimes multiple.\r\nhttps://gist.github.com/adyshimony/d5b9fec95a7ec7544095cef398960c5c\r\n\r\nI set up the config exactly as written here \r\nhttp://docs.couchdb.org/en/stable/maintenance/performance.html#system-resource-limits\r\n\r\nChecking ulimit -n returns 64000\r\n\r\nAlso set max_dbs_open is 15k\r\nAlso added \r\n[couchdb]\r\nupdate_lru_on_read = false\r\n\r\nBut when checking for service limits:\r\n\r\n├─beam.smp(1532)─┬─couchjs(3546)───{couchjs}(3554)\r\n           │                ├─couchjs(3547)───{couchjs}(3555)\r\n           │                ├─couchjs(3548)───{couchjs}(3553)\r\n   \r\n\r\ncat /proc/3546/limits\r\nI am getting Max open files  1024   \r\nFor every process in the list, even that I configured this:\r\n\r\n/etc/systemd/system/couchdb.d/override.conf\r\n[Service]\r\nLimitNOFILE=64000.\r\n\r\n**Solutions found. I am not deleting this cause maybe it will help someone else.**\r\n\r\nAdd \r\n/etc/systemd/system/couchdb.service.d/limits.conf\r\n[Service]\r\nLimitNOFILE=64000\r\n\r\nFixed the issue with all the other things I mention above.\r\n/etc/systemd/system/couchdb.d/override.conf is not enough if working at all.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370187107/reactions","total_count":14,"+1":5,"-1":0,"laugh":3,"hooray":3,"confused":0,"heart":3,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370254333","html_url":"https://github.com/apache/couchdb/pull/1201#issuecomment-370254333","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1201","id":370254333,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDI1NDMzMw==","user":{"login":"tonysun83","id":6991573,"node_id":"MDQ6VXNlcjY5OTE1NzM=","avatar_url":"https://avatars.githubusercontent.com/u/6991573?v=4","gravatar_id":"","url":"https://api.github.com/users/tonysun83","html_url":"https://github.com/tonysun83","followers_url":"https://api.github.com/users/tonysun83/followers","following_url":"https://api.github.com/users/tonysun83/following{/other_user}","gists_url":"https://api.github.com/users/tonysun83/gists{/gist_id}","starred_url":"https://api.github.com/users/tonysun83/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tonysun83/subscriptions","organizations_url":"https://api.github.com/users/tonysun83/orgs","repos_url":"https://api.github.com/users/tonysun83/repos","events_url":"https://api.github.com/users/tonysun83/events{/privacy}","received_events_url":"https://api.github.com/users/tonysun83/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-04T19:03:47Z","updated_at":"2018-03-04T19:03:47Z","author_association":"CONTRIBUTOR","body":"+1","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370254333/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370266455","html_url":"https://github.com/apache/couchdb/pull/1176#issuecomment-370266455","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1176","id":370266455,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDI2NjQ1NQ==","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-04T21:38:28Z","updated_at":"2018-03-04T21:38:28Z","author_association":"CONTRIBUTOR","body":"Rebased on latest master","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370266455/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370373499","html_url":"https://github.com/apache/couchdb/pull/1186#issuecomment-370373499","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1186","id":370373499,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDM3MzQ5OQ==","user":{"login":"jiangphcn","id":18000622,"node_id":"MDQ6VXNlcjE4MDAwNjIy","avatar_url":"https://avatars.githubusercontent.com/u/18000622?v=4","gravatar_id":"","url":"https://api.github.com/users/jiangphcn","html_url":"https://github.com/jiangphcn","followers_url":"https://api.github.com/users/jiangphcn/followers","following_url":"https://api.github.com/users/jiangphcn/following{/other_user}","gists_url":"https://api.github.com/users/jiangphcn/gists{/gist_id}","starred_url":"https://api.github.com/users/jiangphcn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jiangphcn/subscriptions","organizations_url":"https://api.github.com/users/jiangphcn/orgs","repos_url":"https://api.github.com/users/jiangphcn/repos","events_url":"https://api.github.com/users/jiangphcn/events{/privacy}","received_events_url":"https://api.github.com/users/jiangphcn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T10:19:30Z","updated_at":"2018-03-05T10:19:30Z","author_association":"CONTRIBUTOR","body":"Still trying to think about downgrade and upgrade from pre-CP to Clustered Purge.\r\n\r\nThere is another situation where database are created after we upgrade to Clustered Purge. The database header will be created with purge tree instead of purge value, like\r\n```\r\n(dbcore@db1.testy011.cloudant.net)3> couch_db:open(<<\"shards/c0000000-dfffffff/testy011-user1/db2.1520242912\">>, []).\r\n{ok,{db,1,\r\n        <<\"shards/c0000000-dfffffff/testy011-user1/db2.1520242912\">>,\r\n        \"/srv/db/shards/c0000000-dfffffff/testy011-user1/db2.1520242912.couch\",\r\n        {couch_bt_engine,{st,\"/srv/db/shards/c0000000-dfffffff/testy011-user1/db2.1520242912.couch\",\r\n                             <0.7078.55>,#Ref<0.0.69.200720>,\r\n                             [before_header,after_header,on_file_open],\r\n                             {db_header,7,0,0,nil,nil,nil,0,nil,184,1000,\r\n                                        <<\"6139f441\"...>>,\r\n                                        [{...}],\r\n                                        0,...},\r\n                             false,\r\n                             {btree,<0.7078.55>,nil,\r\n                                    #Fun<couch_bt_engine.id_tree_split.1>,\r\n                                    #Fun<couch_bt_engine.id_tree_join.2>,undefined,\r\n                                    #Fun<couch_bt_engine.id_tree_reduce.2>,\r\n                                    {deflate,6}},\r\n                             {btree,<0.7078.55>,nil,\r\n                                    #Fun<couch_bt_engine.seq_tree_split.1>,\r\n                                    #Fun<couch_bt_engine.seq_tree_join.2>,undefined,\r\n                                    #Fun<couch_bt_engine.seq_tree_reduce.2>,\r\n                                    {deflate,6}},\r\n                             {btree,<0.7078.55>,nil,\r\n                                    #Fun<couch_bt_engine.local_tree_split.1>,\r\n                                    #Fun<couch_bt_engine.local_tree_join.2>,undefined,nil,\r\n                                    {deflate,6}},\r\n                             {deflate,6},\r\n                             {btree,<0.7078.55>,nil,undefined,undefined,undefined,\r\n                                    #Fun<couch_bt_engine.purge_tree_reduce.2>,snappy},\r\n                             {btree,<0.7078.55>,nil,undefined,undefined,undefined,\r\n                                    #Fun<couch_bt_engine.purge_tree_reduce.2>,...}}},\r\n        <0.7077.55>,nil,0,<<\"1520242912784404\">>,\r\n        {user_ctx,null,[],undefined},\r\n        [],undefined,nil,nil,nil,\r\n        [{default_security_object,[]},\r\n         {n,\"3\"},\r\n         {q,\"8\"},\r\n         {placement,undefined}],\r\n        undefined}} \r\n```\r\n\r\nIf we need to downgrade for such database, we might have to start without any purge history. Or other thoughts? @davisp \r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370373499/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370375722","html_url":"https://github.com/apache/couchdb/issues/745#issuecomment-370375722","issue_url":"https://api.github.com/repos/apache/couchdb/issues/745","id":370375722,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDM3NTcyMg==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T10:27:36Z","updated_at":"2018-03-05T10:27:36Z","author_association":"MEMBER","body":"I suggest we close this in favour of #1200. \r\n\r\ntl;dr: CouchDB master works as expected, but has an unfortunate behaviour leading to replication failures when attachments are > `max_http_request_size`, the solution of which, we’re discussing in #1200.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370375722/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370381759","html_url":"https://github.com/apache/couchdb/pull/1200#issuecomment-370381759","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1200","id":370381759,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDM4MTc1OQ==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T10:50:49Z","updated_at":"2018-03-05T10:50:49Z","author_association":"MEMBER","body":"Summing up, here are the things we need to decide:\r\n\r\n1. What is the desired behaviour for CouchDB?\r\n   1. Replication can fail if sum(attachments.size) > max_http_request_size (2.1.0 and later). We document this and move on.\r\n   1. Things fail randomly plus a DOS vector, because, if at all, we have  a 4GB limit for documents sizes (CouchDB 2.0.0 and earlier).\r\n   1. A document that can be written to CouchDB can also be replicated to another CouchDB instance with the same configuration (including itself) AND there are request/document/attachment size limits in place that make it easy to operate CouchDB on the internet.\r\n\r\n* * *\r\n\r\nIf iii., there are two options (so far, please suggest more ;):\r\n1. As outlined in this issue, use a combination of `max_document_size`, `max_attachment_size` and `max_attachments_per_doc` to stay under `max_http_request_size` to ensure smooth replication.\r\n1. alternatively: on document/attachment write, check against a `max_http_request_size` quota and reject doc updates, attachment updates, and attachment additions that would take a document over `max_http_request_size`.\r\n\r\n* * *\r\n\r\n2. Should we decide on iii, what is the baseline for the new behaviour with regards to semantic versioning?\r\n    1. We start enforcing new limits in the next *minor* version release of CouchDB (2.2.0 or 2.3.0 depending on how fast we can resolve this). This would mean breaking backwards compatibility with 2.0.0 and earlier releases, including all 1.x releases. If we do this, the release notes should be very upfront about this.\r\n   1. Same as i., but we do this for the next *major* version of CouchDB (3.0.0), BC-breaks are of less concern here, although the upgrade notes should be extensive.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370381759/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370455069","html_url":"https://github.com/apache/couchdb/issues/1171#issuecomment-370455069","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1171","id":370455069,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDQ1NTA2OQ==","user":{"login":"Nanonid","id":1835820,"node_id":"MDQ6VXNlcjE4MzU4MjA=","avatar_url":"https://avatars.githubusercontent.com/u/1835820?v=4","gravatar_id":"","url":"https://api.github.com/users/Nanonid","html_url":"https://github.com/Nanonid","followers_url":"https://api.github.com/users/Nanonid/followers","following_url":"https://api.github.com/users/Nanonid/following{/other_user}","gists_url":"https://api.github.com/users/Nanonid/gists{/gist_id}","starred_url":"https://api.github.com/users/Nanonid/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Nanonid/subscriptions","organizations_url":"https://api.github.com/users/Nanonid/orgs","repos_url":"https://api.github.com/users/Nanonid/repos","events_url":"https://api.github.com/users/Nanonid/events{/privacy}","received_events_url":"https://api.github.com/users/Nanonid/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T15:26:56Z","updated_at":"2018-03-05T15:29:15Z","author_association":"NONE","body":"So we have a erlang:MD5 polyfill. Aren't there already such fills?\r\nI'd rather not have a secure couchdb fork, with IA patches, but it is necessary if the master can't be made compliant.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370455069/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370470585","html_url":"https://github.com/apache/couchdb/issues/1093#issuecomment-370470585","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1093","id":370470585,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDQ3MDU4NQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T16:10:38Z","updated_at":"2018-03-05T16:10:38Z","author_association":"MEMBER","body":"@ReeceStevens In testing together, it looks like the candidate fix for #745 has resolved this problem. I'm going to tentatively close this issue out.\r\n\r\nIf you have any recurrence of this issue while testing, please let me know.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370470585/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370489809","html_url":"https://github.com/apache/couchdb/pull/1200#issuecomment-370489809","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1200","id":370489809,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDQ4OTgwOQ==","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T17:06:00Z","updated_at":"2018-03-05T17:24:26Z","author_association":"CONTRIBUTOR","body":"Good write-up @janl \r\n\r\n`max_http_request_size` is a quick and dirty way of specifying limits but not very accurate and has  loopholes in it still.  Because we implemented other limits, it's value has decreased. Moreover, because we fixed how it checks its limit and fixed some bugs there, its default value started breaking users' code.\r\n\r\nIn general, if the cost of checking was the same, I'd think most users would rather pick the more specific limits (doc size, att size, max num of atts etc) than thinking of those limits and then applying some formula to calculate a max http request size.\r\n\r\nMaybe `max_http_request_size` should be adjusted to an upper bound of `max_doc_size  + max attachment_size * max_num_attachment_per_doc` expected by users. They are using attachments larger than 64Mb and they seem to work. We even fixed a few issue which prevented uploading of large attachments from timing out, so now chances are users would this limit more often. So maybe at least 500Mb (about 10x increase) or even 1G? Users which worry about DOS would have to apply limits as they see fit for their environment.\r\n\r\nReplying to the summary specifically:\r\n\r\n> 1.i & ii\r\n\r\n From a users' perspective I think 1.i is buggy and is just as random of failure 1.ii. Since when replicating the only indication of a failed write is a failed doc write count bump that the majority of users don't know about, the breakage is quite insidious. It might lead to invalid backups and it might take years before users notice the missing data their backups. So I'd pick 1.ii as better than 1.i from this point of view. A DOS is terrible but at least immediately apparent. Attachments mysteriously disappearing during replication is only to be discovered much later later is a more serious issue. I can imagine already the \"My db ate my data blog posts\".\r\n\r\n> 1.iii\r\n\r\nI like the `max_attachments_per_doc` idea. So given a max doc size, max attachment size, max num of attachment / doc we could almost automatically generate a max http request size value for mp doc puts, attachment PUTs and single document updates.\r\n\r\nThere is one more place were we'd need a limit to completely constrain the http request size based on the more precise limits - `_bulk_docs` requests. We'd have to restrict the max number of docs posted there.  Then given max doc size + max num of docs / _bulk_docs request we can automatically calculate a reasonable upper bound on request sizes to most \"update/modify/create\" APIs.\r\n\r\nSo I think I like 1.iii and it seems 1.iii.2 is similar to the idea of automatically deducing a max http request size from the other limits and rejecting it update based on it. But we' instead let users specify the more precise limits instead of using http max request size as the primary constraint.\r\n\r\n(One exception I guess if users somehow have a broken proxy or some middleware that cannot cope with large requests and they need to specifically adjust the http request size).\r\n\r\n> 2\r\n\r\nI think we should increase max http request size, at least for 2.2.0 and document how users can apply limits to avoid DOS attacks and how max request size, max doc size and max attachment sizes are related. This would unbreak customers with 64Mb attachments. Maybe add the `max_attachments_per_doc` and `max_docs_per_bulk_doc_request` though these could be in 2.3.0 perhaps.\r\n\r\nSome more random notes:\r\n\r\nAnother way to handle some of the issues is to teach the replicator to bisect attachment PUTs just like it bisect _bulk_docs when it receives a 413 response: https://github.com/apache/couchdb/blob/40b9f85f0be775fe5508f12332130f2695262595/src/couch_replicator/src/couch_replicator_worker.erl#L481-L489  that would be a pain to write for attachment mp parser streamer code though...\r\n\r\nAlso it is good to keep in mind that replicator could be running on a 3rd cluster (not target or source necessarily) and it would need to handle older or other alternative CouchDB implementations. In that respect it has to \"auto-discover\" setting by probing, bisecting and guessing.\r\n\r\nIn the table above, technically in <2.0.0 we didn't have max document size, but only max http request size. The setting was called max document size but was just bad name and as soon as we had a proper max document size we renamed it.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370489809/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370492585","html_url":"https://github.com/apache/couchdb/pull/1186#issuecomment-370492585","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1186","id":370492585,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDQ5MjU4NQ==","user":{"login":"davisp","id":19929,"node_id":"MDQ6VXNlcjE5OTI5","avatar_url":"https://avatars.githubusercontent.com/u/19929?v=4","gravatar_id":"","url":"https://api.github.com/users/davisp","html_url":"https://github.com/davisp","followers_url":"https://api.github.com/users/davisp/followers","following_url":"https://api.github.com/users/davisp/following{/other_user}","gists_url":"https://api.github.com/users/davisp/gists{/gist_id}","starred_url":"https://api.github.com/users/davisp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davisp/subscriptions","organizations_url":"https://api.github.com/users/davisp/orgs","repos_url":"https://api.github.com/users/davisp/repos","events_url":"https://api.github.com/users/davisp/events{/privacy}","received_events_url":"https://api.github.com/users/davisp/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T17:14:43Z","updated_at":"2018-03-05T17:14:43Z","author_association":"MEMBER","body":"I've not got anything good no. Other than I'm starting to really really wanting to avoid the possibility of downgrading. The one thing that does make things a bit easier is that most databases won't already have purge information since its not available through the clustered API and doesn't appear to be an API most people use normally.\r\n\r\nHowever the thing that's mostly worrying me now is what to do about unused/idle indexes after upgrade in terms of both a) can we auto-create _local docs for them or b) can we force them all to run an initial step. The fear being that if we upgrade and allow for purging when an index exists but is unused it seems possible to have an invalid index laying around (i.e., if we compact purge requests such that a index never sees them).","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370492585/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370512799","html_url":"https://github.com/apache/couchdb/pull/1200#issuecomment-370512799","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1200","id":370512799,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDUxMjc5OQ==","user":{"login":"elistevens","id":138016,"node_id":"MDQ6VXNlcjEzODAxNg==","avatar_url":"https://avatars.githubusercontent.com/u/138016?v=4","gravatar_id":"","url":"https://api.github.com/users/elistevens","html_url":"https://github.com/elistevens","followers_url":"https://api.github.com/users/elistevens/followers","following_url":"https://api.github.com/users/elistevens/following{/other_user}","gists_url":"https://api.github.com/users/elistevens/gists{/gist_id}","starred_url":"https://api.github.com/users/elistevens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elistevens/subscriptions","organizations_url":"https://api.github.com/users/elistevens/orgs","repos_url":"https://api.github.com/users/elistevens/repos","events_url":"https://api.github.com/users/elistevens/events{/privacy}","received_events_url":"https://api.github.com/users/elistevens/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T18:18:25Z","updated_at":"2018-03-05T18:18:25Z","author_association":"NONE","body":"I have a concrete use case that I don't think is well-served by iii.1:\r\n\r\n- I have some documents with many small attachments\r\n- I have some documents with one very large attachment\r\n\r\nMy understanding is that due to this, I'd have to choose between having an unrealistically large `max_http_request_size` or having a sane `max_http_request_size` but remain in the situation where docs+attachments could be written but not replicated (once usage patterns changed).\r\n\r\nI would much prefer iii.2, where `max_http_request_size` becomes effectively `max_doc_plus_attachments_size` and at that point I don't care if there are attachment size or count limits because I can feel confident that no matter what mix of doc and attachments, the size will stay sane.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370512799/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370542104","html_url":"https://github.com/apache/couchdb/pull/1200#issuecomment-370542104","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1200","id":370542104,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDU0MjEwNA==","user":{"login":"elistevens","id":138016,"node_id":"MDQ6VXNlcjEzODAxNg==","avatar_url":"https://avatars.githubusercontent.com/u/138016?v=4","gravatar_id":"","url":"https://api.github.com/users/elistevens","html_url":"https://github.com/elistevens","followers_url":"https://api.github.com/users/elistevens/followers","following_url":"https://api.github.com/users/elistevens/following{/other_user}","gists_url":"https://api.github.com/users/elistevens/gists{/gist_id}","starred_url":"https://api.github.com/users/elistevens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elistevens/subscriptions","organizations_url":"https://api.github.com/users/elistevens/orgs","repos_url":"https://api.github.com/users/elistevens/repos","events_url":"https://api.github.com/users/elistevens/events{/privacy}","received_events_url":"https://api.github.com/users/elistevens/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T19:51:19Z","updated_at":"2018-03-05T19:51:19Z","author_association":"NONE","body":"I'd like to add that if iii.1 moves forward, I'd like to have some information about what impact setting `max_http_request_size` to large values would have. Things like:\r\n\r\n- Will setting the value to something large have a performance or behavior impact if all of the actual data flowing through the system remains small?\r\n- Are there corresponding timeouts that might need to be increased to accommodate larger data sizes moving through the system?\r\n- Can the value be set to something larger than physical RAM without swapping?\r\n\r\nEtc.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370542104/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370560095","html_url":"https://github.com/apache/couchdb/pull/373#issuecomment-370560095","issue_url":"https://api.github.com/repos/apache/couchdb/issues/373","id":370560095,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDU2MDA5NQ==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T20:49:39Z","updated_at":"2018-03-05T20:49:39Z","author_association":"MEMBER","body":"Ping. Cleaning up old stuff. Any interest in reviving this or instead taking https://github.com/cloudant/delegated_auth","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370560095/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370560506","html_url":"https://github.com/apache/couchdb/pull/366#issuecomment-370560506","issue_url":"https://api.github.com/repos/apache/couchdb/issues/366","id":370560506,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDU2MDUwNg==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T20:50:56Z","updated_at":"2018-03-05T20:50:56Z","author_association":"MEMBER","body":"I'm going to close this out, simply because new feature development for 1.x has ended.\r\n\r\nI'd still very much like to see #373 and associated PRs get merged into 2.x, and/or Cloudant's delegated_auth repo instead.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370560506/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370560677","html_url":"https://github.com/apache/couchdb/pull/334#issuecomment-370560677","issue_url":"https://api.github.com/repos/apache/couchdb/issues/334","id":370560677,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDU2MDY3Nw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T20:51:25Z","updated_at":"2018-03-05T20:51:25Z","author_association":"MEMBER","body":"I think new development has died for 1.x at this point.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370560677/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370565054","html_url":"https://github.com/apache/couchdb/pull/1199#issuecomment-370565054","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1199","id":370565054,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDU2NTA1NA==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T21:04:39Z","updated_at":"2018-03-05T21:04:39Z","author_association":"MEMBER","body":"@janl Hm, if we bind chttpd to 0.0.0.0 it could be tricky to determine the right IP address to choose, 127.0.0.1 might not be visible if they are coming from outside (and mistakenly have bound httpd to 0.0.0.0 as well.) It'd sure be a nice to have, though.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370565054/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370574453","html_url":"https://github.com/apache/couchdb/pull/1199#issuecomment-370574453","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1199","id":370574453,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDU3NDQ1Mw==","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T21:35:34Z","updated_at":"2018-03-05T21:35:34Z","author_association":"MEMBER","body":"@rnewson I've moved the CSP tests over to chttpd, where they should be anyway, and of course they pass with flying colours because we are awesome. :)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370574453/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370589633","html_url":"https://github.com/apache/couchdb/issues/1171#issuecomment-370589633","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1171","id":370589633,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDU4OTYzMw==","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T22:26:07Z","updated_at":"2018-03-05T22:26:07Z","author_association":"MEMBER","body":"I was referring the FIPS_mode() function.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370589633/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370590745","html_url":"https://github.com/apache/couchdb/pull/373#issuecomment-370590745","issue_url":"https://api.github.com/repos/apache/couchdb/issues/373","id":370590745,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDU5MDc0NQ==","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T22:30:20Z","updated_at":"2018-03-05T22:30:20Z","author_association":"MEMBER","body":"no interest from me.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370590745/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370601327","html_url":"https://github.com/apache/couchdb/issues/1171#issuecomment-370601327","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1171","id":370601327,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDYwMTMyNw==","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-05T23:12:04Z","updated_at":"2018-03-05T23:12:04Z","author_association":"CONTRIBUTOR","body":"Like @rnewson mentioned it is about the FIPS check.\r\n\r\n`erlang:md5` seems to be there in every supported Erlang version R16B03 -> 20.0.\r\n\r\n`crypto:info_fips()` is a newer function and only present since 20.0 http://erlang.org/doc/man/crypto.html#info_fips-0\r\n\r\nAt first thought it would seem why not just switch all uses of md5 to `erlang:md5` but it turns out it can be quite a bit slower for large values. For 4MB binaries for example:\r\n\r\n```\r\n3> f(Bin), Bin = crypto:strong_rand_bytes(1 bsl 22).\r\n<<93,...>>\r\n\r\n4> timer:tc(fun() -> crypto:hash(md5, Bin) end ).\r\n{6929, <<75,...>>}\r\n\r\n5> timer:tc(fun() -> crypto:hash(md5, Bin) end ).\r\n{7064, <<75,...>>}\r\n\r\n6> timer:tc(fun() -> erlang:md5(Bin) end ).\r\n{40849, <<75,...>>}\r\n\r\n7> timer:tc(fun() -> erlang:md5(Bin) end ).\r\n{85613, <<75,...>>}\r\n```\r\n\r\n(The result of `timer:tc/1` is `{Microseconds, FunResult}`)\r\n\r\nMaybe you'd want to move the md5 calculation to `couch_util` and provide a macro can be used at compile to to pick between the implementations. If FIPS_MODE enabled you'd pick erlang:md5 otherwise use the other one.\r\n\r\nWe recently did a similar macro thing for some of random functions:\r\n\r\nhttps://github.com/apache/couchdb/blob/75984da4b22003d0e46a9fe1001978d999387636/src/couch/src/couch_rand.erl\r\n\r\nhttps://github.com/apache/couchdb/blob/a99cc6fda04e35e2266953a73a182c724ed928de/src/couch/rebar.config.script#L138","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370601327/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370730342","html_url":"https://github.com/apache/couchdb/pull/1199#issuecomment-370730342","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1199","id":370730342,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDczMDM0Mg==","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-06T10:08:19Z","updated_at":"2018-03-06T10:08:19Z","author_association":"MEMBER","body":"@wohali good call, with a load balancer it gets even worse.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370730342/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370734359","html_url":"https://github.com/apache/couchdb/issues/1204#issuecomment-370734359","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1204","id":370734359,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDczNDM1OQ==","user":{"login":"SCdF","id":583851,"node_id":"MDQ6VXNlcjU4Mzg1MQ==","avatar_url":"https://avatars.githubusercontent.com/u/583851?v=4","gravatar_id":"","url":"https://api.github.com/users/SCdF","html_url":"https://github.com/SCdF","followers_url":"https://api.github.com/users/SCdF/followers","following_url":"https://api.github.com/users/SCdF/following{/other_user}","gists_url":"https://api.github.com/users/SCdF/gists{/gist_id}","starred_url":"https://api.github.com/users/SCdF/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SCdF/subscriptions","organizations_url":"https://api.github.com/users/SCdF/orgs","repos_url":"https://api.github.com/users/SCdF/repos","events_url":"https://api.github.com/users/SCdF/events{/privacy}","received_events_url":"https://api.github.com/users/SCdF/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-06T10:21:55Z","updated_at":"2018-03-06T11:54:38Z","author_association":"NONE","body":"I also found this very confusing. I think because (at least for me) the vast majority of view usage is without a corresponding reduce, it's not something that you come across much, and it's a pretty radical change that is only passively documented in the query param list.\r\n\r\nI think it might be worth modifying the documentation to pull this effect[1] into a warning documentation block to highlight it, and include an explanation to get everyone on the same page.\r\n\r\nSomething like:\r\n\r\n> **Warning**\r\n> By default, querying a view runs its reduce function if it has one. This can be confusing if you are used to just using map functions, and are adding a reduce function to an existing view. This happens because `explanation_goes_here`\r\n\r\n[1] That all view queries automatically become reduce queries when you add a reduce","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370734359/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370740318","html_url":"https://github.com/apache/couchdb/issues/1097#issuecomment-370740318","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1097","id":370740318,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDc0MDMxOA==","user":{"login":"adrienverge","id":5244945,"node_id":"MDQ6VXNlcjUyNDQ5NDU=","avatar_url":"https://avatars.githubusercontent.com/u/5244945?v=4","gravatar_id":"","url":"https://api.github.com/users/adrienverge","html_url":"https://github.com/adrienverge","followers_url":"https://api.github.com/users/adrienverge/followers","following_url":"https://api.github.com/users/adrienverge/following{/other_user}","gists_url":"https://api.github.com/users/adrienverge/gists{/gist_id}","starred_url":"https://api.github.com/users/adrienverge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrienverge/subscriptions","organizations_url":"https://api.github.com/users/adrienverge/orgs","repos_url":"https://api.github.com/users/adrienverge/repos","events_url":"https://api.github.com/users/adrienverge/events{/privacy}","received_events_url":"https://api.github.com/users/adrienverge/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-03-06T10:43:54Z","updated_at":"2018-03-06T10:44:47Z","author_association":"CONTRIBUTOR","body":"We experience the same problem: lots of free disk space, lots of free RAM, and:\r\n\r\n```\r\n[notice] 2018-03-06... -------- Compaction swap for db: /var/lib/couchdb/shards/00000000-1fffffff/my_db.1493304636.couch 131313 45297\r\n[warning] 2018-03-06... -------- Compaction daemon - unable to calculate free space for `/run/user/0`: `enoent`\r\n[notice] 2018-03-06... -------- Compaction swap for db: /var/lib/couchdb/shards/00000000-1fffffff/my_db.1493304645.couch 131266 45250\r\n```\r\n\r\nNone of these DBs have attachments. Actually the issue doesn't seem related to attachments, but instead to the fact that `/run/user/0` doesn't exist:\r\n\r\n```shell\r\n# ls -a /run/user \r\n.  ..  1000\r\n```\r\n\r\nThis error log happens in all 3 nodes of our cluster.\r\n\r\n@wohali Can you open the issue again?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/370740318/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]