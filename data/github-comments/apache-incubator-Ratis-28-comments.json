[{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2261803105","html_url":"https://github.com/apache/ratis/pull/1126#issuecomment-2261803105","issue_url":"https://api.github.com/repos/apache/ratis/issues/1126","id":2261803105,"node_id":"IC_kwDOBMxbGc6G0GBh","user":{"login":"symious","id":14933944,"node_id":"MDQ6VXNlcjE0OTMzOTQ0","avatar_url":"https://avatars.githubusercontent.com/u/14933944?v=4","gravatar_id":"","url":"https://api.github.com/users/symious","html_url":"https://github.com/symious","followers_url":"https://api.github.com/users/symious/followers","following_url":"https://api.github.com/users/symious/following{/other_user}","gists_url":"https://api.github.com/users/symious/gists{/gist_id}","starred_url":"https://api.github.com/users/symious/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/symious/subscriptions","organizations_url":"https://api.github.com/users/symious/orgs","repos_url":"https://api.github.com/users/symious/repos","events_url":"https://api.github.com/users/symious/events{/privacy}","received_events_url":"https://api.github.com/users/symious/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-01T02:00:24Z","updated_at":"2024-08-01T02:00:24Z","author_association":"CONTRIBUTOR","body":"I tried to analyze the a local heap, but failed to reproduce the result mentioned by @jojochuang .\r\n\r\n```\r\nClass Name                                                                         | Objects | Shallow Heap | Retained Heap\r\n----------------------------------------------------------------------------------------------------------------------------\r\norg.apache.logging.log4j.core.async.RingBufferLogEvent                             | 262,144 |   27,262,976 | >= 41,943,032\r\norg.apache.logging.log4j.core.async.AsyncLoggerConfigDisruptor$Log4jEventWrapper   | 262,144 |    6,291,456 |  >= 6,291,456\r\norg.apache.logging.log4j.core.time.MutableInstant                                  | 262,144 |    6,291,456 |  >= 6,291,512\r\norg.apache.logging.log4j.util.SortedArrayStringMap                                 | 262,143 |    8,388,576 |  >= 8,389,096\r\nbyte[]                                                                             | 208,852 |   24,340,320 | >= 24,340,320\r\norg.apache.ratis.proto.RaftProtos$CommitInfoProto                                  | 180,004 |    8,640,192 |  >= 8,641,432\r\njava.util.concurrent.ConcurrentHashMap$Node                                        | 161,219 |    5,159,008 | >= 41,160,136\r\njava.util.concurrent.atomic.AtomicInteger                                          | 120,145 |    1,922,320 |  >= 1,922,368\r\norg.apache.ratis.thirdparty.com.google.protobuf.ByteString$LiteralByteString       | 120,023 |    2,880,552 | >= 15,601,672\r\norg.apache.ratis.proto.RaftProtos$LogEntryProto                                    | 119,312 |    6,681,472 | >= 29,214,712\r\norg.apache.ratis.server.protocol.TermIndex$1                                       | 119,311 |    3,817,952 |  >= 3,818,040\r\norg.apache.ratis.util.ReferenceCountedObject$3                                     | 119,311 |    3,817,952 | >= 34,942,304\r\norg.apache.ratis.server.raftlog.LogEntryHeader$1                                   | 119,311 |    2,863,464 |  >= 2,863,520\r\norg.apache.ratis.server.raftlog.segmented.LogSegment$LogRecord                     | 119,311 |    2,863,464 |  >= 5,726,928\r\norg.apache.ratis.thirdparty.com.google.common.cache.LocalCache$StrongValueReference| 118,544 |    1,896,704 | >= 34,296,768\r\njava.lang.String                                                                   |  85,515 |    2,052,360 |  >= 6,972,128\r\njava.lang.Object[]                                                                 |  70,952 |   16,363,352 | >= 85,756,368\r\n----------------------------------------------------------------------------------------------------------------------------\r\n```\r\n\r\nI think the following points are interesting:\r\n1. The count of `TermIndex$1` and `RaftProtos$LogEntryProto` are similar here, but quite different in @jojochuang 's case.\r\n2. The count of `TermIndex$1` will be very large, so the default size of Util.CACHE, which is 1 << 16, is not enough, so the cache hit rate should be quite low.\r\n\r\nTested by running \"ozone freon ommg --operation CREATE_FILE -n 30000 -t 1 --size=100 --bucket=bucket-1 --type RATIS --replication THREE\" on master branch of Ozone, heap analyzed from datanode.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2261803105/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2262737075","html_url":"https://github.com/apache/ratis/pull/1128#issuecomment-2262737075","issue_url":"https://api.github.com/repos/apache/ratis/issues/1128","id":2262737075,"node_id":"IC_kwDOBMxbGc6G3qCz","user":{"login":"sadanand48","id":31859223,"node_id":"MDQ6VXNlcjMxODU5MjIz","avatar_url":"https://avatars.githubusercontent.com/u/31859223?v=4","gravatar_id":"","url":"https://api.github.com/users/sadanand48","html_url":"https://github.com/sadanand48","followers_url":"https://api.github.com/users/sadanand48/followers","following_url":"https://api.github.com/users/sadanand48/following{/other_user}","gists_url":"https://api.github.com/users/sadanand48/gists{/gist_id}","starred_url":"https://api.github.com/users/sadanand48/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sadanand48/subscriptions","organizations_url":"https://api.github.com/users/sadanand48/orgs","repos_url":"https://api.github.com/users/sadanand48/repos","events_url":"https://api.github.com/users/sadanand48/events{/privacy}","received_events_url":"https://api.github.com/users/sadanand48/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-01T10:50:21Z","updated_at":"2024-08-01T10:51:33Z","author_association":"CONTRIBUTOR","body":"Thanks @adoroszlai , verified the fix by running `TestLeaderElectionWithGrpc` using your command too.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2262737075/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2263359135","html_url":"https://github.com/apache/ratis/pull/1128#issuecomment-2263359135","issue_url":"https://api.github.com/repos/apache/ratis/issues/1128","id":2263359135,"node_id":"IC_kwDOBMxbGc6G6B6f","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-01T15:28:55Z","updated_at":"2024-08-01T15:28:55Z","author_association":"CONTRIBUTOR","body":"@sadanand48 , thanks for working on this!\r\n\r\n@adoroszlai , thanks for reviewing and testing this!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2263359135/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2270416440","html_url":"https://github.com/apache/ratis/pull/1130#issuecomment-2270416440","issue_url":"https://api.github.com/repos/apache/ratis/issues/1130","id":2270416440,"node_id":"IC_kwDOBMxbGc6HU844","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-06T05:30:34Z","updated_at":"2024-08-06T05:30:34Z","author_association":"CONTRIBUTOR","body":"Could you also change `logMetadata` as below as mentioned in https://github.com/apache/ratis/pull/1130#pullrequestreview-2219395735 ?\r\n```java\r\n//LeaderStateImpl\r\n  private void logMetadata(long commitIndex) {\r\n    if (raftLog.appendMetadata(currentTerm, commitIndex) != RaftLog.INVALID_LOG_INDEX) {\r\n      notifySenders();\r\n    }\r\n  }\r\n```","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2270416440/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2270435667","html_url":"https://github.com/apache/ratis/pull/1130#issuecomment-2270435667","issue_url":"https://api.github.com/repos/apache/ratis/issues/1130","id":2270435667,"node_id":"IC_kwDOBMxbGc6HVBlT","user":{"login":"chungen0126","id":65023303,"node_id":"MDQ6VXNlcjY1MDIzMzAz","avatar_url":"https://avatars.githubusercontent.com/u/65023303?v=4","gravatar_id":"","url":"https://api.github.com/users/chungen0126","html_url":"https://github.com/chungen0126","followers_url":"https://api.github.com/users/chungen0126/followers","following_url":"https://api.github.com/users/chungen0126/following{/other_user}","gists_url":"https://api.github.com/users/chungen0126/gists{/gist_id}","starred_url":"https://api.github.com/users/chungen0126/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chungen0126/subscriptions","organizations_url":"https://api.github.com/users/chungen0126/orgs","repos_url":"https://api.github.com/users/chungen0126/repos","events_url":"https://api.github.com/users/chungen0126/events{/privacy}","received_events_url":"https://api.github.com/users/chungen0126/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-06T05:48:44Z","updated_at":"2024-08-06T06:26:12Z","author_association":"CONTRIBUTOR","body":"Done. I also add a check to avoid NullPointerException as below as mentioned in  https://github.com/apache/ratis/pull/1130#discussion_r1704381262:\r\n```\r\n  private boolean shouldAppendMetadata(long newCommitIndex) {\r\n    if (newCommitIndex <= 0) {\r\n      // do not log the first conf entry\r\n      return false;\r\n    }\r\n    final LogEntryProto last = lastMetadataEntry.get();\r\n    // do not log entries with a smaller commit index.\r\n    return last == null || newCommitIndex > last.getMetadataEntry().getCommitIndex();\r\n  }\r\n```","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2270435667/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2275086546","html_url":"https://github.com/apache/ratis/pull/1131#issuecomment-2275086546","issue_url":"https://api.github.com/repos/apache/ratis/issues/1131","id":2275086546,"node_id":"IC_kwDOBMxbGc6HmxDS","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-08T06:56:59Z","updated_at":"2024-08-08T06:56:59Z","author_association":"CONTRIBUTOR","body":"@szetszwo PTAL!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2275086546/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2283185261","html_url":"https://github.com/apache/ratis/pull/1133#issuecomment-2283185261","issue_url":"https://api.github.com/repos/apache/ratis/issues/1133","id":2283185261,"node_id":"IC_kwDOBMxbGc6IFqRt","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-12T06:19:32Z","updated_at":"2024-08-12T06:19:32Z","author_association":"CONTRIBUTOR","body":"@szetszwo PTAL!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2283185261/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2284413049","html_url":"https://github.com/apache/ratis/pull/1129#issuecomment-2284413049","issue_url":"https://api.github.com/repos/apache/ratis/issues/1129","id":2284413049,"node_id":"IC_kwDOBMxbGc6IKWB5","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-12T16:21:18Z","updated_at":"2024-08-12T16:21:18Z","author_association":"CONTRIBUTOR","body":"@SzyWilliam , thanks a lot for reviewing this!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2284413049/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2284423095","html_url":"https://github.com/apache/ratis/pull/1132#issuecomment-2284423095","issue_url":"https://api.github.com/repos/apache/ratis/issues/1132","id":2284423095,"node_id":"IC_kwDOBMxbGc6IKYe3","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-12T16:22:43Z","updated_at":"2024-08-12T16:22:43Z","author_association":"CONTRIBUTOR","body":"@SzyWilliam , thanks a lot for reviewing this!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2284423095/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2289504672","html_url":"https://github.com/apache/ratis/pull/1134#issuecomment-2289504672","issue_url":"https://api.github.com/repos/apache/ratis/issues/1134","id":2289504672,"node_id":"IC_kwDOBMxbGc6IdxGg","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-14T18:09:23Z","updated_at":"2024-08-14T18:09:23Z","author_association":"CONTRIBUTOR","body":"@adoroszlai thanks for reviewing this!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2289504672/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2296409630","html_url":"https://github.com/apache/ratis/pull/1127#issuecomment-2296409630","issue_url":"https://api.github.com/repos/apache/ratis/issues/1127","id":2296409630,"node_id":"IC_kwDOBMxbGc6I4G4e","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-19T12:03:02Z","updated_at":"2024-08-19T12:03:20Z","author_association":"CONTRIBUTOR","body":"Hi, @szetszwo \r\nWe have tested this pull request,  the write throughput is improved by about 25%.\r\n\r\nBefore:\r\n![image](https://github.com/user-attachments/assets/a4ef9f67-d7fe-4686-bd01-4969a8a03fae)\r\nAfter:\r\n![image](https://github.com/user-attachments/assets/9cdf21d2-9777-4403-88bf-d8c2e63d87d5)\r\n\r\nWe analyzed the flame graph and found that 15% of the Raftlog read locks had disappeared, which made acquiring raftlog locks faster in the write path, resulting in better write performance.This indicates that the write throughput improvement from this PR is still substantial.\r\n\r\nBefore:\r\n<img width=\"1511\" alt=\"image\" src=\"https://github.com/user-attachments/assets/ff960461-b1d9-4d01-857c-2c5eacb98cf6\">\r\nAfter:\r\n<img width=\"1511\" alt=\"image\" src=\"https://github.com/user-attachments/assets/78b33fa2-cf3d-464c-8458-96fc08894695\">\r\n\r\nIn addition, we found that UpdateCommitIndex also takes a lot of CPU in the latest optimized scenario. It should be beneficial to continue to optimize the locking logic here.\r\n\r\n\r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2296409630/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2297071049","html_url":"https://github.com/apache/ratis/pull/1127#issuecomment-2297071049","issue_url":"https://api.github.com/repos/apache/ratis/issues/1127","id":2297071049,"node_id":"IC_kwDOBMxbGc6I6oXJ","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-19T17:25:42Z","updated_at":"2024-08-19T17:25:42Z","author_association":"CONTRIBUTOR","body":"@OneSizeFitsQuorum , thanks a lot for testing this!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2297071049/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2297956659","html_url":"https://github.com/apache/ratis/pull/1136#issuecomment-2297956659","issue_url":"https://api.github.com/repos/apache/ratis/issues/1136","id":2297956659,"node_id":"IC_kwDOBMxbGc6I-Akz","user":{"login":"Flyangz","id":39462475,"node_id":"MDQ6VXNlcjM5NDYyNDc1","avatar_url":"https://avatars.githubusercontent.com/u/39462475?v=4","gravatar_id":"","url":"https://api.github.com/users/Flyangz","html_url":"https://github.com/Flyangz","followers_url":"https://api.github.com/users/Flyangz/followers","following_url":"https://api.github.com/users/Flyangz/following{/other_user}","gists_url":"https://api.github.com/users/Flyangz/gists{/gist_id}","starred_url":"https://api.github.com/users/Flyangz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Flyangz/subscriptions","organizations_url":"https://api.github.com/users/Flyangz/orgs","repos_url":"https://api.github.com/users/Flyangz/repos","events_url":"https://api.github.com/users/Flyangz/events{/privacy}","received_events_url":"https://api.github.com/users/Flyangz/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-20T04:45:50Z","updated_at":"2024-08-21T02:43:38Z","author_association":"CONTRIBUTOR","body":"ping @szetszwo @SzyWilliam ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2297956659/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2303550886","html_url":"https://github.com/apache/ratis/pull/1138#issuecomment-2303550886","issue_url":"https://api.github.com/repos/apache/ratis/issues/1138","id":2303550886,"node_id":"IC_kwDOBMxbGc6JTWWm","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-22T02:21:43Z","updated_at":"2024-08-22T02:21:43Z","author_association":"CONTRIBUTOR","body":"@szetszwo PTAL","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2303550886/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2305205332","html_url":"https://github.com/apache/ratis/pull/1135#issuecomment-2305205332","issue_url":"https://api.github.com/repos/apache/ratis/issues/1135","id":2305205332,"node_id":"IC_kwDOBMxbGc6JZqRU","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-22T16:44:36Z","updated_at":"2024-08-22T16:44:36Z","author_association":"CONTRIBUTOR","body":"@adoroszlai , thanks a lot for reviewing this!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2305205332/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2310707581","html_url":"https://github.com/apache/ratis/pull/1126#issuecomment-2310707581","issue_url":"https://api.github.com/repos/apache/ratis/issues/1126","id":2310707581,"node_id":"IC_kwDOBMxbGc6Jupl9","user":{"login":"duongkame","id":17348547,"node_id":"MDQ6VXNlcjE3MzQ4NTQ3","avatar_url":"https://avatars.githubusercontent.com/u/17348547?v=4","gravatar_id":"","url":"https://api.github.com/users/duongkame","html_url":"https://github.com/duongkame","followers_url":"https://api.github.com/users/duongkame/followers","following_url":"https://api.github.com/users/duongkame/following{/other_user}","gists_url":"https://api.github.com/users/duongkame/gists{/gist_id}","starred_url":"https://api.github.com/users/duongkame/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/duongkame/subscriptions","organizations_url":"https://api.github.com/users/duongkame/orgs","repos_url":"https://api.github.com/users/duongkame/repos","events_url":"https://api.github.com/users/duongkame/events{/privacy}","received_events_url":"https://api.github.com/users/duongkame/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-26T17:28:16Z","updated_at":"2024-08-26T17:31:12Z","author_association":"CONTRIBUTOR","body":">We may have stored the same TermIndex value multiple times. Otherwise, we won't get 2.4m TermIndex objects in https://github.com/apache/ratis/pull/1126#issuecomment-2258899751\r\n\r\nLet's just revert the change by this PR and reexamine the problem with TermIndex instances somewhere else.\r\n\r\nThe change is made prematurely, without due diligence. For such memory, we must.\r\n1. Identify the problem root, e.g. is there duplicated, and where is the local source of keeping that huge amount of TermIndex instances? Is there anything wrong with logic? It's suspecting because we're only cache TermIndex in the RaftLogCache, where TermIndex should be unique. \r\nThis doesn't sound right not to understand the problem and create a *global* cache with the hope to fix it. As per my experience, a global static cache usually brings more problems than solving them.\r\n2. Make a quick fix and verify if the change fixes the original problem. \r\n\r\nWithout doing the above 2 things, we will likely introduce a new problem without solving the original, just like we did. Guessing and fixing and not verifying never turns out well. \r\n\r\n@szetszwo @jojochuang ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2310707581/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2310721483","html_url":"https://github.com/apache/ratis/pull/1126#issuecomment-2310721483","issue_url":"https://api.github.com/repos/apache/ratis/issues/1126","id":2310721483,"node_id":"IC_kwDOBMxbGc6Jus_L","user":{"login":"jojochuang","id":2691807,"node_id":"MDQ6VXNlcjI2OTE4MDc=","avatar_url":"https://avatars.githubusercontent.com/u/2691807?v=4","gravatar_id":"","url":"https://api.github.com/users/jojochuang","html_url":"https://github.com/jojochuang","followers_url":"https://api.github.com/users/jojochuang/followers","following_url":"https://api.github.com/users/jojochuang/following{/other_user}","gists_url":"https://api.github.com/users/jojochuang/gists{/gist_id}","starred_url":"https://api.github.com/users/jojochuang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jojochuang/subscriptions","organizations_url":"https://api.github.com/users/jojochuang/orgs","repos_url":"https://api.github.com/users/jojochuang/repos","events_url":"https://api.github.com/users/jojochuang/events{/privacy}","received_events_url":"https://api.github.com/users/jojochuang/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-26T17:35:38Z","updated_at":"2024-08-26T17:35:38Z","author_association":"CONTRIBUTOR","body":"+1 to revert. IMO the initial problem in the original jira wasn't as a huge issue as the problem it introduces.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2310721483/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2310764005","html_url":"https://github.com/apache/ratis/pull/1126#issuecomment-2310764005","issue_url":"https://api.github.com/repos/apache/ratis/issues/1126","id":2310764005,"node_id":"IC_kwDOBMxbGc6Ju3Xl","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-26T18:00:45Z","updated_at":"2024-08-26T18:00:45Z","author_association":"CONTRIBUTOR","body":"@jojochuang , thanks for the confirmation.  Let's revert it.\r\n\r\n@duongkame , let's use the `git revert` command for reverting.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2310764005/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2310780468","html_url":"https://github.com/apache/ratis/pull/1126#issuecomment-2310780468","issue_url":"https://api.github.com/repos/apache/ratis/issues/1126","id":2310780468,"node_id":"IC_kwDOBMxbGc6Ju7Y0","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-26T18:10:03Z","updated_at":"2024-08-26T18:10:03Z","author_association":"CONTRIBUTOR","body":"Reverted.\r\n```\r\ncommit 520ecab157c9c6aff87ed5c5978c08f98cd4ec6c (origin/master, origin/HEAD, master)\r\nAuthor: Tsz-Wo Nicholas Sze <szetszwo@apache.org>\r\nDate:   Mon Aug 26 11:07:29 2024 -0700\r\n\r\n    Revert \"RATIS-2099. Cache TermIndexImpl instead of using anonymous class (#1100)\"\r\n    \r\n    This reverts commit 428ce4ae3d5a0349f3425cb85ef1a3d38dea24b1.\r\n```\r\n```\r\ncommit da5d508caffc4ca90b0ab962b5105785b9774daa\r\nAuthor: Tsz-Wo Nicholas Sze <szetszwo@apache.org>\r\nDate:   Mon Aug 26 11:07:17 2024 -0700\r\n\r\n    Revert \"RATIS-2101. Move TermIndex.PRIVATE_CACHE to Util.CACHE (#1103)\"\r\n    \r\n    This reverts commit 93eb32a8620fdd4e5119592ef32bc50590810c7b.\r\n\r\n```","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2310780468/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2316642158","html_url":"https://github.com/apache/ratis/pull/1140#issuecomment-2316642158","issue_url":"https://api.github.com/repos/apache/ratis/issues/1140","id":2316642158,"node_id":"IC_kwDOBMxbGc6KFSdu","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-29T03:26:22Z","updated_at":"2024-08-29T03:26:22Z","author_association":"CONTRIBUTOR","body":" @szetszwo PTAL!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2316642158/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2318470856","html_url":"https://github.com/apache/ratis/pull/1127#issuecomment-2318470856","issue_url":"https://api.github.com/repos/apache/ratis/issues/1127","id":2318470856,"node_id":"IC_kwDOBMxbGc6KMQ7I","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-29T17:39:47Z","updated_at":"2024-08-29T17:39:47Z","author_association":"CONTRIBUTOR","body":"Submitted https://github.com/apache/ratis/pull/1141 for the master branch.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2318470856/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2322040940","html_url":"https://github.com/apache/ratis/pull/1141#issuecomment-2322040940","issue_url":"https://api.github.com/repos/apache/ratis/issues/1141","id":2322040940,"node_id":"IC_kwDOBMxbGc6KZ4hs","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-08-30T17:37:42Z","updated_at":"2024-08-30T17:37:42Z","author_association":"CONTRIBUTOR","body":"@OneSizeFitsQuorum , thanks a lot for reviewing and testing this!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2322040940/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2327806401","html_url":"https://github.com/apache/ratis/pull/1144#issuecomment-2327806401","issue_url":"https://api.github.com/repos/apache/ratis/issues/1144","id":2327806401,"node_id":"IC_kwDOBMxbGc6Kv4HB","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-04T02:43:40Z","updated_at":"2024-09-04T02:43:40Z","author_association":"CONTRIBUTOR","body":"@szetszwo PTAL","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2327806401/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2327834631","html_url":"https://github.com/apache/ratis/pull/1127#issuecomment-2327834631","issue_url":"https://api.github.com/repos/apache/ratis/issues/1127","id":2327834631,"node_id":"IC_kwDOBMxbGc6Kv_AH","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-04T03:19:24Z","updated_at":"2024-09-04T03:19:24Z","author_association":"CONTRIBUTOR","body":"Hi, @szetszwo , we can close this PR because the release-3.1.x will not contain this PR and we can include this work in the future 3.2.0.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2327834631/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2328514296","html_url":"https://github.com/apache/ratis/pull/1145#issuecomment-2328514296","issue_url":"https://api.github.com/repos/apache/ratis/issues/1145","id":2328514296,"node_id":"IC_kwDOBMxbGc6Kyk74","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-04T10:32:59Z","updated_at":"2024-09-04T10:32:59Z","author_association":"CONTRIBUTOR","body":"Bidirectional flow RPC can ensure that the sending and receiving order of messages is the same.\r\n\r\nSo in this PR, I used a flag to determine whether the entire snapshot request was successful\r\n\r\nIf a corrupt exception is encountered before the last request is received, subsequent requests will not be processed, reset the flag, and wait for resending","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2328514296/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2328528251","html_url":"https://github.com/apache/ratis/pull/1143#issuecomment-2328528251","issue_url":"https://api.github.com/repos/apache/ratis/issues/1143","id":2328528251,"node_id":"IC_kwDOBMxbGc6KyoV7","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-04T10:38:24Z","updated_at":"2024-09-04T10:38:24Z","author_association":"CONTRIBUTOR","body":"Since I can't pass the testImmediatelyRevertedToFollower, I move the if condition to the try block.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2328528251/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2329521149","html_url":"https://github.com/apache/ratis/pull/1127#issuecomment-2329521149","issue_url":"https://api.github.com/repos/apache/ratis/issues/1127","id":2329521149,"node_id":"IC_kwDOBMxbGc6K2av9","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-04T16:33:21Z","updated_at":"2024-09-04T16:33:21Z","author_association":"CONTRIBUTOR","body":"Sure, let's close this.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2329521149/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2330499966","html_url":"https://github.com/apache/ratis/pull/1145#issuecomment-2330499966","issue_url":"https://api.github.com/repos/apache/ratis/issues/1145","id":2330499966,"node_id":"IC_kwDOBMxbGc6K6Jt-","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-05T02:57:54Z","updated_at":"2024-09-05T02:57:54Z","author_association":"CONTRIBUTOR","body":"Based on this PR, maybe we'll be able to do file-level retries during snapshot transfers in the future~","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2330499966/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2330507158","html_url":"https://github.com/apache/ratis/pull/1142#issuecomment-2330507158","issue_url":"https://api.github.com/repos/apache/ratis/issues/1142","id":2330507158,"node_id":"IC_kwDOBMxbGc6K6LeW","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-05T03:06:16Z","updated_at":"2024-09-05T03:06:16Z","author_association":"CONTRIBUTOR","body":"We spent a lot of time troubleshooting this issue, and what we were able to confirm in the end is that there seems to be some problem with `digester.reset`, which causes the final MD5 calculation to be incorrect. We searched for related issues on the OpenJDK official [website](https://bugs.openjdk.org/browse/JDK-8300416?jql=project%20%3D%20JDK%20AND%20issuetype%20%3D%20Bug%20AND%20affectedVersion%20in%20releasedVersions()%20AND%20text%20~%20%22MD5%22%20ORDER%20BY%20created%20DESC) but couldn't find an exact cause.\r\n\r\nHowever, we found that instead of using reset, creating a new digester each time a new file appears should solve the issue (our testing process can verify this). Therefore, I recommend making this change directly. \r\n\r\nWhat's your opinion? @szetszwo ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2330507158/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2334532134","html_url":"https://github.com/apache/ratis/pull/1143#issuecomment-2334532134","issue_url":"https://api.github.com/repos/apache/ratis/issues/1143","id":2334532134,"node_id":"IC_kwDOBMxbGc6LJiIm","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-06T17:40:12Z","updated_at":"2024-09-06T17:40:12Z","author_association":"CONTRIBUTOR","body":"`TestRaftWithGrpc` keeps failing.  The failure does not seem related to this.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2334532134/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2335003431","html_url":"https://github.com/apache/ratis/pull/1143#issuecomment-2335003431","issue_url":"https://api.github.com/repos/apache/ratis/issues/1143","id":2335003431,"node_id":"IC_kwDOBMxbGc6LLVMn","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-07T02:15:51Z","updated_at":"2024-09-07T02:15:51Z","author_association":"CONTRIBUTOR","body":"Filed RATIS-2151 for the failure of `TestRaftWithGrpc`.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2335003431/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2335013923","html_url":"https://github.com/apache/ratis/pull/1143#issuecomment-2335013923","issue_url":"https://api.github.com/repos/apache/ratis/issues/1143","id":2335013923,"node_id":"IC_kwDOBMxbGc6LLXwj","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-07T02:56:13Z","updated_at":"2024-09-07T02:56:13Z","author_association":"CONTRIBUTOR","body":"Retried 20 times but still cannot get a clean build https://github.com/apache/ratis/actions/runs/10699620016/job/29810958383?pr=1143#step:5:735\r\n\r\nSince the failure of `TestRaftWithGrpc` is unrelated, let's merge this.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2335013923/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2336965511","html_url":"https://github.com/apache/ratis/pull/1144#issuecomment-2336965511","issue_url":"https://api.github.com/repos/apache/ratis/issues/1144","id":2336965511,"node_id":"IC_kwDOBMxbGc6LS0OH","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-09T01:58:43Z","updated_at":"2024-09-09T01:58:53Z","author_association":"CONTRIBUTOR","body":"Thanks for  reviewing! @szetszwo @adoroszlai \r\n\r\n| Please continue using your fork for pushing development branches, instead of apache/ratis\r\n\r\ngot it!\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2336965511/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2336997209","html_url":"https://github.com/apache/ratis/pull/1142#issuecomment-2336997209","issue_url":"https://api.github.com/repos/apache/ratis/issues/1142","id":2336997209,"node_id":"IC_kwDOBMxbGc6LS79Z","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-09T02:37:13Z","updated_at":"2024-09-09T02:37:13Z","author_association":"CONTRIBUTOR","body":"@szetszwo What do you think of this way?","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2336997209/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2339746397","html_url":"https://github.com/apache/ratis/pull/1142#issuecomment-2339746397","issue_url":"https://api.github.com/repos/apache/ratis/issues/1142","id":2339746397,"node_id":"IC_kwDOBMxbGc6LdbJd","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-10T06:10:45Z","updated_at":"2024-09-10T06:10:45Z","author_association":"CONTRIBUTOR","body":"private String randomString(int length) {\r\n        StringBuilder sb = new StringBuilder();\r\n        for (int i = 0; i < length; i++) {\r\n            sb.append((char) (Math.random() * 26 + 'a'));\r\n        }\r\n        return sb.toString();\r\n    }\r\n\r\n    @Benchmark\r\n    public void md5Test(Blackhole blackhole) throws NoSuchAlgorithmException {\r\n        int length = 1000;\r\n        md5 = MessageDigest.getInstance(\"MD5\");\r\n        for (int i = 0; i < 1000; ++i) {\r\n            md5.reset();\r\n            md5.update(randomString(length).getBytes());\r\n            blackhole.consume(md5.digest());\r\n            length += 100;\r\n        }\r\n    }\r\n\r\n    @Benchmark\r\n    public void md5Test2(Blackhole blackhole) throws NoSuchAlgorithmException {\r\n        int length = 10000;\r\n        for (int i = 0; i < 1000; ++i) {\r\n            MessageDigest md5 = MessageDigest.getInstance(\"MD5\");\r\n            md5.reset();\r\n            md5.update(randomString(length).getBytes());\r\n            blackhole.consume(md5.digest());\r\n            length += 100;\r\n        }\r\n\r\n    }\r\n\r\n    @Benchmark\r\n    public void md5DoNothingTest() throws NoSuchAlgorithmException {\r\n        MessageDigest md5 = MessageDigest.getInstance(\"MD5\");\r\n        for (int i = 0; i < 1000000; ++i) {\r\n            md5.reset();\r\n        }\r\n    }\r\n\r\n    @Benchmark\r\n    public void md5DoNothingTest2() throws NoSuchAlgorithmException {\r\n        for (int i = 0; i < 1000000; ++i) {\r\n            MessageDigest md5 = MessageDigest.getInstance(\"MD5\");\r\n            md5.reset();\r\n        }\r\n    }","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2339746397/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2339753228","html_url":"https://github.com/apache/ratis/pull/1142#issuecomment-2339753228","issue_url":"https://api.github.com/repos/apache/ratis/issues/1142","id":2339753228,"node_id":"IC_kwDOBMxbGc6Ldc0M","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-10T06:12:43Z","updated_at":"2024-09-10T11:07:39Z","author_association":"CONTRIBUTOR","body":"<img width=\"580\" alt=\"image\" src=\"https://github.com/user-attachments/assets/89f5b493-8eb7-483d-967f-34382f52467e\">\r\n\r\nThis is the performance difference between using a new digester and using a single digester\r\n\r\nFor each received file, the difference between using a new md5 object and using a member variable is almost negligible","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2339753228/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2339766891","html_url":"https://github.com/apache/ratis/pull/1147#issuecomment-2339766891","issue_url":"https://api.github.com/repos/apache/ratis/issues/1147","id":2339766891,"node_id":"IC_kwDOBMxbGc6LdgJr","user":{"login":"adoroszlai","id":6454655,"node_id":"MDQ6VXNlcjY0NTQ2NTU=","avatar_url":"https://avatars.githubusercontent.com/u/6454655?v=4","gravatar_id":"","url":"https://api.github.com/users/adoroszlai","html_url":"https://github.com/adoroszlai","followers_url":"https://api.github.com/users/adoroszlai/followers","following_url":"https://api.github.com/users/adoroszlai/following{/other_user}","gists_url":"https://api.github.com/users/adoroszlai/gists{/gist_id}","starred_url":"https://api.github.com/users/adoroszlai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adoroszlai/subscriptions","organizations_url":"https://api.github.com/users/adoroszlai/orgs","repos_url":"https://api.github.com/users/adoroszlai/repos","events_url":"https://api.github.com/users/adoroszlai/events{/privacy}","received_events_url":"https://api.github.com/users/adoroszlai/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-10T06:21:21Z","updated_at":"2024-09-10T06:21:21Z","author_association":"CONTRIBUTOR","body":"Thanks @OneSizeFitsQuorum, @szetszwo for the review.  I've also cherry-picked this to the `release-3.1.1` branch.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2339766891/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2344454009","html_url":"https://github.com/apache/ratis/pull/1146#issuecomment-2344454009","issue_url":"https://api.github.com/repos/apache/ratis/issues/1146","id":2344454009,"node_id":"IC_kwDOBMxbGc6LvYd5","user":{"login":"chungen0126","id":65023303,"node_id":"MDQ6VXNlcjY1MDIzMzAz","avatar_url":"https://avatars.githubusercontent.com/u/65023303?v=4","gravatar_id":"","url":"https://api.github.com/users/chungen0126","html_url":"https://github.com/chungen0126","followers_url":"https://api.github.com/users/chungen0126/followers","following_url":"https://api.github.com/users/chungen0126/following{/other_user}","gists_url":"https://api.github.com/users/chungen0126/gists{/gist_id}","starred_url":"https://api.github.com/users/chungen0126/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chungen0126/subscriptions","organizations_url":"https://api.github.com/users/chungen0126/orgs","repos_url":"https://api.github.com/users/chungen0126/repos","events_url":"https://api.github.com/users/chungen0126/events{/privacy}","received_events_url":"https://api.github.com/users/chungen0126/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-11T19:01:41Z","updated_at":"2024-09-11T19:02:19Z","author_association":"CONTRIBUTOR","body":">It seems that we may remove done as below. What do you think?\r\n\r\nIs there anything miss in the code? The while loop might end only when it is closed.\r\nThe another reason why I think the current implement is better because It will become a busy loop in a normal node.\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2344454009/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2344539912","html_url":"https://github.com/apache/ratis/pull/1146#issuecomment-2344539912","issue_url":"https://api.github.com/repos/apache/ratis/issues/1146","id":2344539912,"node_id":"IC_kwDOBMxbGc6LvtcI","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-11T19:27:28Z","updated_at":"2024-09-11T19:27:28Z","author_association":"CONTRIBUTOR","body":"@chungen0126 , sorry, copied a wrong diff.  Updated my previous comment.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2344539912/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2344615720","html_url":"https://github.com/apache/ratis/pull/1146#issuecomment-2344615720","issue_url":"https://api.github.com/repos/apache/ratis/issues/1146","id":2344615720,"node_id":"IC_kwDOBMxbGc6Lv_8o","user":{"login":"chungen0126","id":65023303,"node_id":"MDQ6VXNlcjY1MDIzMzAz","avatar_url":"https://avatars.githubusercontent.com/u/65023303?v=4","gravatar_id":"","url":"https://api.github.com/users/chungen0126","html_url":"https://github.com/chungen0126","followers_url":"https://api.github.com/users/chungen0126/followers","following_url":"https://api.github.com/users/chungen0126/following{/other_user}","gists_url":"https://api.github.com/users/chungen0126/gists{/gist_id}","starred_url":"https://api.github.com/users/chungen0126/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chungen0126/subscriptions","organizations_url":"https://api.github.com/users/chungen0126/orgs","repos_url":"https://api.github.com/users/chungen0126/repos","events_url":"https://api.github.com/users/chungen0126/events{/privacy}","received_events_url":"https://api.github.com/users/chungen0126/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-11T20:12:18Z","updated_at":"2024-09-11T20:27:26Z","author_association":"CONTRIBUTOR","body":"@szetszwo , I think the while loop in the new diff might also become infinite if the InstallSnapshotResponseHandler closes before the loop starts. In addition, I run `TestLeaderInstallSnapshotWithGrpc` on my local machine and it fails.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2344615720/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2344762073","html_url":"https://github.com/apache/ratis/pull/1146#issuecomment-2344762073","issue_url":"https://api.github.com/repos/apache/ratis/issues/1146","id":2344762073,"node_id":"IC_kwDOBMxbGc6LwjrZ","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-11T21:48:20Z","updated_at":"2024-09-11T21:48:20Z","author_association":"CONTRIBUTOR","body":">  I think the while loop in the new diff might also become infinite ...\r\n\r\nGood catch!\r\n\r\nWe actually should use `CompletableFuture` in this case; see below:\r\n```java\r\ndiff --git a/ratis-grpc/src/main/java/org/apache/ratis/grpc/server/GrpcLogAppender.java b/ratis-grpc/src/main/java/org/apache/ratis/grpc/server/GrpcLogAppender.java\r\nindex 1da7bb3b47..355adc2f8b 100644\r\n--- a/ratis-grpc/src/main/java/org/apache/ratis/grpc/server/GrpcLogAppender.java\r\n+++ b/ratis-grpc/src/main/java/org/apache/ratis/grpc/server/GrpcLogAppender.java\r\n@@ -54,8 +54,9 @@ import java.io.InterruptedIOException;\r\n import java.util.*;\r\n import java.util.concurrent.CompletableFuture;\r\n import java.util.concurrent.ConcurrentHashMap;\r\n+import java.util.concurrent.ExecutionException;\r\n import java.util.concurrent.TimeUnit;\r\n-import java.util.concurrent.atomic.AtomicBoolean;\r\n+import java.util.concurrent.TimeoutException;\r\n import java.util.concurrent.atomic.AtomicLong;\r\n \r\n /**\r\n@@ -576,7 +577,7 @@ public class GrpcLogAppender extends LogAppenderBase {\r\n   private class InstallSnapshotResponseHandler implements StreamObserver<InstallSnapshotReplyProto> {\r\n     private final String name = getFollower().getName() + \"-\" + JavaUtils.getClassSimpleName(getClass());\r\n     private final Queue<Integer> pending;\r\n-    private final AtomicBoolean done = new AtomicBoolean(false);\r\n+    private final CompletableFuture<Void> done = new CompletableFuture<>();\r\n     private final boolean isNotificationOnly;\r\n \r\n     InstallSnapshotResponseHandler() {\r\n@@ -637,12 +638,19 @@ public class GrpcLogAppender extends LogAppenderBase {\r\n       getServer().getStateMachine().event().notifySnapshotInstalled(result, snapshotIndex, getFollower().getPeer());\r\n     }\r\n \r\n-    boolean isDone() {\r\n-      return done.get();\r\n+    boolean isRunning() {\r\n+      try {\r\n+        done.get(100, TimeUnit.MILLISECONDS);\r\n+        return false;\r\n+      } catch (InterruptedException | TimeoutException e) {\r\n+        return true;\r\n+      } catch (ExecutionException e) {\r\n+        throw new IllegalStateException(\"Failed to complete \" + name, e);\r\n+      }\r\n     }\r\n \r\n     void close() {\r\n-      done.set(true);\r\n+      done.complete(null);\r\n       notifyLogAppender();\r\n     }\r\n \r\n@@ -718,7 +726,7 @@ public class GrpcLogAppender extends LogAppenderBase {\r\n \r\n     @Override\r\n     public void onError(Throwable t) {\r\n-      if (!isRunning()) {\r\n+      if (!GrpcLogAppender.this.isRunning()) {\r\n         LOG.info(\"{} is stopped\", GrpcLogAppender.this);\r\n         return;\r\n       }\r\n@@ -777,13 +785,8 @@ public class GrpcLogAppender extends LogAppenderBase {\r\n       return;\r\n     }\r\n \r\n-    while (isRunning() && !responseHandler.isDone()) {\r\n-      try {\r\n-        getEventAwaitForSignal().await(getWaitTimeMs(), TimeUnit.MILLISECONDS);\r\n-      } catch (InterruptedException ignored) {\r\n-        Thread.currentThread().interrupt();\r\n-      }\r\n-    }\r\n+    // wait for responseHandler to complete\r\n+    while (isRunning() && responseHandler.isRunning());\r\n \r\n     if (responseHandler.hasAllResponse()) {\r\n       getFollower().setSnapshotIndex(snapshot.getTermIndex().getIndex());\r\n@@ -822,13 +825,8 @@ public class GrpcLogAppender extends LogAppenderBase {\r\n       return;\r\n     }\r\n \r\n-    while (isRunning() && !responseHandler.isDone()) {\r\n-      try {\r\n-        getEventAwaitForSignal().await(getWaitTimeMs(), TimeUnit.MILLISECONDS);\r\n-      } catch (InterruptedException ignored) {\r\n-        Thread.currentThread().interrupt();\r\n-      }\r\n-    }\r\n+    // wait for responseHandler to complete\r\n+    while (isRunning() && responseHandler.isRunning());\r\n   }\r\n \r\n   /**\r\n```","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2344762073/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2345161744","html_url":"https://github.com/apache/ratis/pull/1148#issuecomment-2345161744","issue_url":"https://api.github.com/repos/apache/ratis/issues/1148","id":2345161744,"node_id":"IC_kwDOBMxbGc6LyFQQ","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-12T02:51:36Z","updated_at":"2024-09-12T02:51:36Z","author_association":"CONTRIBUTOR","body":"@szetszwo PTAL","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2345161744/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2346845870","html_url":"https://github.com/apache/ratis/pull/1142#issuecomment-2346845870","issue_url":"https://api.github.com/repos/apache/ratis/issues/1142","id":2346845870,"node_id":"IC_kwDOBMxbGc6L4gau","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-12T17:21:39Z","updated_at":"2024-09-12T17:23:29Z","author_association":"CONTRIBUTOR","body":"> For each received file, the difference between using a new md5 object and using a member variable is almost negligible\r\n\r\nThanks for running the benchmarks!  Let's use a new digester.   How about moving the new MD5 method to `MD5Hash`?\r\n\r\n```java\r\ndiff --git a/ratis-common/src/main/java/org/apache/ratis/io/MD5Hash.java b/ratis-common/src/main/java/org/apache/ratis/io/MD5Hash.java\r\nindex e60bef9652..8aacd9a65d 100644\r\n--- a/ratis-common/src/main/java/org/apache/ratis/io/MD5Hash.java\r\n+++ b/ratis-common/src/main/java/org/apache/ratis/io/MD5Hash.java\r\n@@ -29,14 +29,15 @@ import java.util.Arrays;\r\n public class MD5Hash {\r\n   public static final int MD5_LEN = 16;\r\n \r\n-  private static final ThreadLocal<MessageDigest> DIGESTER_FACTORY =\r\n-      ThreadLocal.withInitial(() -> {\r\n+  private static final ThreadLocal<MessageDigest> DIGESTER_FACTORY = ThreadLocal.withInitial(MD5Hash::newDigester);\r\n+\r\n+  public static MessageDigest newDigester() {\r\n     try {\r\n       return MessageDigest.getInstance(\"MD5\");\r\n     } catch (NoSuchAlgorithmException e) {\r\n-      throw new RuntimeException(e);\r\n+      throw new IllegalStateException(\"Failed to create MessageDigest for MD5\", e);\r\n     }\r\n-  });\r\n+  }\r\n \r\n   private byte[] digest;\r\n \r\ndiff --git a/ratis-server/src/main/java/org/apache/ratis/server/storage/SnapshotManager.java b/ratis-server/src/main/java/org/apache/ratis/server/storage/SnapshotManager.java\r\nindex 794604d66b..5b5158aebd 100644\r\n--- a/ratis-server/src/main/java/org/apache/ratis/server/storage/SnapshotManager.java\r\n+++ b/ratis-server/src/main/java/org/apache/ratis/server/storage/SnapshotManager.java\r\n@@ -112,9 +109,9 @@ public class SnapshotManager {\r\n     LOG.info(\"Installing snapshot:{}, to tmp dir:{}\",\r\n         ServerStringUtils.toInstallSnapshotRequestString(request), tmpDir);\r\n \r\n+    final MessageDigest digester = MD5Hash.newDigester();\r\n     // TODO: Make sure that subsequent requests for the same installSnapshot are coming in order,\r\n     // and are not lost when whole request cycle is done. Check requestId and requestIndex here\r\n-\r\n     for (FileChunkProto chunk : snapshotChunkRequest.getFileChunksList()) {\r\n       SnapshotInfo pi = stateMachine.getLatestSnapshot();\r\n       if (pi != null && pi.getTermIndex().getIndex() >= lastIncludedIndex) {\r\n```","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2346845870/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2347881421","html_url":"https://github.com/apache/ratis/pull/1142#issuecomment-2347881421","issue_url":"https://api.github.com/repos/apache/ratis/issues/1142","id":2347881421,"node_id":"IC_kwDOBMxbGc6L8dPN","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-13T01:49:47Z","updated_at":"2024-09-13T01:49:47Z","author_association":"CONTRIBUTOR","body":"> > For each received file, the difference between using a new md5 object and using a member variable is almost negligible\r\n> \r\n> Thanks for running the benchmarks! Let's use a new digester. How about moving the new MD5 method to `MD5Hash`?\r\n> \r\n> ```java\r\n> diff --git a/ratis-common/src/main/java/org/apache/ratis/io/MD5Hash.java b/ratis-common/src/main/java/org/apache/ratis/io/MD5Hash.java\r\n> index e60bef9652..8aacd9a65d 100644\r\n> --- a/ratis-common/src/main/java/org/apache/ratis/io/MD5Hash.java\r\n> +++ b/ratis-common/src/main/java/org/apache/ratis/io/MD5Hash.java\r\n> @@ -29,14 +29,15 @@ import java.util.Arrays;\r\n>  public class MD5Hash {\r\n>    public static final int MD5_LEN = 16;\r\n>  \r\n> -  private static final ThreadLocal<MessageDigest> DIGESTER_FACTORY =\r\n> -      ThreadLocal.withInitial(() -> {\r\n> +  private static final ThreadLocal<MessageDigest> DIGESTER_FACTORY = ThreadLocal.withInitial(MD5Hash::newDigester);\r\n> +\r\n> +  public static MessageDigest newDigester() {\r\n>      try {\r\n>        return MessageDigest.getInstance(\"MD5\");\r\n>      } catch (NoSuchAlgorithmException e) {\r\n> -      throw new RuntimeException(e);\r\n> +      throw new IllegalStateException(\"Failed to create MessageDigest for MD5\", e);\r\n>      }\r\n> -  });\r\n> +  }\r\n>  \r\n>    private byte[] digest;\r\n>  \r\n> diff --git a/ratis-server/src/main/java/org/apache/ratis/server/storage/SnapshotManager.java b/ratis-server/src/main/java/org/apache/ratis/server/storage/SnapshotManager.java\r\n> index 794604d66b..5b5158aebd 100644\r\n> --- a/ratis-server/src/main/java/org/apache/ratis/server/storage/SnapshotManager.java\r\n> +++ b/ratis-server/src/main/java/org/apache/ratis/server/storage/SnapshotManager.java\r\n> @@ -112,9 +109,9 @@ public class SnapshotManager {\r\n>      LOG.info(\"Installing snapshot:{}, to tmp dir:{}\",\r\n>          ServerStringUtils.toInstallSnapshotRequestString(request), tmpDir);\r\n>  \r\n> +    final MessageDigest digester = MD5Hash.newDigester();\r\n>      // TODO: Make sure that subsequent requests for the same installSnapshot are coming in order,\r\n>      // and are not lost when whole request cycle is done. Check requestId and requestIndex here\r\n> -\r\n>      for (FileChunkProto chunk : snapshotChunkRequest.getFileChunksList()) {\r\n>        SnapshotInfo pi = stateMachine.getLatestSnapshot();\r\n>        if (pi != null && pi.getTermIndex().getIndex() >= lastIncludedIndex) {\r\n> ```\r\n\r\nGood idea, but there are some problems in the provided code, we should construct digester when receiving the first chunk and calculate md5 after receiving a complete file.\r\n\r\nTherefore, we add a MessageDigest member variable in SnapshotManager and assign it to the first chunk every time","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2347881421/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2350953012","html_url":"https://github.com/apache/ratis/pull/1142#issuecomment-2350953012","issue_url":"https://api.github.com/repos/apache/ratis/issues/1142","id":2350953012,"node_id":"IC_kwDOBMxbGc6MILI0","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-14T11:04:02Z","updated_at":"2024-09-14T11:04:02Z","author_association":"CONTRIBUTOR","body":"Maybe we need a atomicReference for this digester @szetszwo ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2350953012/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2350956198","html_url":"https://github.com/apache/ratis/pull/1149#issuecomment-2350956198","issue_url":"https://api.github.com/repos/apache/ratis/issues/1149","id":2350956198,"node_id":"IC_kwDOBMxbGc6MIL6m","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-14T11:16:35Z","updated_at":"2024-09-14T11:16:35Z","author_association":"CONTRIBUTOR","body":"@szetszwo PTAL","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2350956198/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2351090069","html_url":"https://github.com/apache/ratis/pull/1142#issuecomment-2351090069","issue_url":"https://api.github.com/repos/apache/ratis/issues/1142","id":2351090069,"node_id":"IC_kwDOBMxbGc6MIsmV","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-14T18:15:16Z","updated_at":"2024-09-14T18:15:16Z","author_association":"CONTRIBUTOR","body":"@OneSizeFitsQuorum , That's a good point!  We should have an `AtomicReference`.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2351090069/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2352021491","html_url":"https://github.com/apache/ratis/pull/1151#issuecomment-2352021491","issue_url":"https://api.github.com/repos/apache/ratis/issues/1151","id":2352021491,"node_id":"IC_kwDOBMxbGc6MMP_z","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-16T04:59:38Z","updated_at":"2024-09-16T04:59:38Z","author_association":"CONTRIBUTOR","body":"@szetszwo PTAL","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2352021491/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2357393946","html_url":"https://github.com/apache/ratis/pull/1151#issuecomment-2357393946","issue_url":"https://api.github.com/repos/apache/ratis/issues/1151","id":2357393946,"node_id":"IC_kwDOBMxbGc6Mgvoa","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T02:58:21Z","updated_at":"2024-09-18T02:58:21Z","author_association":"CONTRIBUTOR","body":"Hi, @szetszwo @133tosakarin ,\r\n1. Maybe we need to create a new one for [sender](https://github.com/apache/ratis/blob/master/ratis-server/src/main/java/org/apache/ratis/server/storage/FileChunkReader.java#L59) as we already saw that the reset on the receiver side can sometimes fail, and there is no significant performance cost to creating a new digester?\r\n2. Thanks for the reminder. Now that we have synchronized, we probably don't need to add another judgment; adding volatile would cause a sonar bug. Maybe we can undo this change.\r\n3. It seems the ci failure is same as this problem discussed in [mail list](https://lists.apache.org/thread/m4r34p2y79z4rvy5vyc983ty06xxt92x), then we can merge this pr first and create a new issue for this problem for master.\r\n<img width=\"1919\" alt=\"image\" src=\"https://github.com/user-attachments/assets/afd4dd7c-9901-4ebb-a696-fddf73b5aaa7\">\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2357393946/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2357513647","html_url":"https://github.com/apache/ratis/pull/1150#issuecomment-2357513647","issue_url":"https://api.github.com/repos/apache/ratis/issues/1150","id":2357513647,"node_id":"IC_kwDOBMxbGc6MhM2v","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T05:14:02Z","updated_at":"2024-09-18T05:14:02Z","author_association":"CONTRIBUTOR","body":"@OneSizeFitsQuorum , thanks a lot for reviewing this!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2357513647/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2357518664","html_url":"https://github.com/apache/ratis/pull/1151#issuecomment-2357518664","issue_url":"https://api.github.com/repos/apache/ratis/issues/1151","id":2357518664,"node_id":"IC_kwDOBMxbGc6MhOFI","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T05:18:30Z","updated_at":"2024-09-18T05:18:30Z","author_association":"CONTRIBUTOR","body":">  t seems the ci failure is same as this problem discussed in [mail list](https://lists.apache.org/thread/m4r34p2y79z4rvy5vyc983ty06xxt92x), ...\r\n\r\n@OneSizeFitsQuorum , if the failure is related to `ReferenceCount` or zero-copy, let ignore it for the moment.  We will fix it separately.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2357518664/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2375778113","html_url":"https://github.com/apache/ratis/pull/1155#issuecomment-2375778113","issue_url":"https://api.github.com/repos/apache/ratis/issues/1155","id":2375778113,"node_id":"IC_kwDOBMxbGc6Nm39B","user":{"login":"OneSizeFitsQuorum","id":32640567,"node_id":"MDQ6VXNlcjMyNjQwNTY3","avatar_url":"https://avatars.githubusercontent.com/u/32640567?v=4","gravatar_id":"","url":"https://api.github.com/users/OneSizeFitsQuorum","html_url":"https://github.com/OneSizeFitsQuorum","followers_url":"https://api.github.com/users/OneSizeFitsQuorum/followers","following_url":"https://api.github.com/users/OneSizeFitsQuorum/following{/other_user}","gists_url":"https://api.github.com/users/OneSizeFitsQuorum/gists{/gist_id}","starred_url":"https://api.github.com/users/OneSizeFitsQuorum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OneSizeFitsQuorum/subscriptions","organizations_url":"https://api.github.com/users/OneSizeFitsQuorum/orgs","repos_url":"https://api.github.com/users/OneSizeFitsQuorum/repos","events_url":"https://api.github.com/users/OneSizeFitsQuorum/events{/privacy}","received_events_url":"https://api.github.com/users/OneSizeFitsQuorum/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-26T03:25:14Z","updated_at":"2024-09-26T03:25:14Z","author_association":"CONTRIBUTOR","body":"@szetszwo PTAL","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2375778113/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2376101802","html_url":"https://github.com/apache/ratis/pull/1154#issuecomment-2376101802","issue_url":"https://api.github.com/repos/apache/ratis/issues/1154","id":2376101802,"node_id":"IC_kwDOBMxbGc6NoG-q","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-26T07:05:25Z","updated_at":"2024-09-26T07:05:25Z","author_association":"CONTRIBUTOR","body":"> +1 the change looks good.\r\n\r\nThere are some other deadlock problem, I need to check","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2376101802/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2378358318","html_url":"https://github.com/apache/ratis/pull/1154#issuecomment-2378358318","issue_url":"https://api.github.com/repos/apache/ratis/issues/1154","id":2378358318,"node_id":"IC_kwDOBMxbGc6Nwt4u","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-27T04:04:26Z","updated_at":"2024-09-27T04:04:26Z","author_association":"CONTRIBUTOR","body":"@szetszwo  It seems that there are also cases where the unit (misc) test fails in the master branch ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2378358318/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2379819374","html_url":"https://github.com/apache/ratis/pull/1154#issuecomment-2379819374","issue_url":"https://api.github.com/repos/apache/ratis/issues/1154","id":2379819374,"node_id":"IC_kwDOBMxbGc6N2Slu","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-27T18:16:11Z","updated_at":"2024-09-27T18:16:11Z","author_association":"CONTRIBUTOR","body":"> ... It seems that there are also cases where the unit (misc) test fails in the master branch\r\n\r\n@133tosakarin , the test failures in misc may be related to this change.  In https://github.com/apache/ratis/pull/1152 , the misc tests did not fail.\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2379819374/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2380421317","html_url":"https://github.com/apache/ratis/pull/1154#issuecomment-2380421317","issue_url":"https://api.github.com/repos/apache/ratis/issues/1154","id":2380421317,"node_id":"IC_kwDOBMxbGc6N4ljF","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-28T05:55:21Z","updated_at":"2024-09-28T05:55:21Z","author_association":"CONTRIBUTOR","body":"> > ... It seems that there are also cases where the unit (misc) test fails in the master branch\r\n> \r\n> @133tosakarin , the test failures in misc may be related to this change. In #1152 , the misc tests did not fail.\r\n\r\nI see. I will further check","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2380421317/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381442474","html_url":"https://github.com/apache/ratis/pull/1154#issuecomment-2381442474","issue_url":"https://api.github.com/repos/apache/ratis/issues/1154","id":2381442474,"node_id":"IC_kwDOBMxbGc6N8e2q","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-29T17:50:49Z","updated_at":"2024-09-29T17:50:49Z","author_association":"CONTRIBUTOR","body":"Let's try testing it over release-3.1.1; see #1157 ","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381442474/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381443747","html_url":"https://github.com/apache/ratis/pull/1152#issuecomment-2381443747","issue_url":"https://api.github.com/repos/apache/ratis/issues/1152","id":2381443747,"node_id":"IC_kwDOBMxbGc6N8fKj","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-29T17:55:32Z","updated_at":"2024-09-29T17:55:32Z","author_association":"CONTRIBUTOR","body":"Test this over 3.1.1 with #1158","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381443747/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381445119","html_url":"https://github.com/apache/ratis/pull/1157#issuecomment-2381445119","issue_url":"https://api.github.com/repos/apache/ratis/issues/1157","id":2381445119,"node_id":"IC_kwDOBMxbGc6N8ff_","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-29T18:00:44Z","updated_at":"2024-09-29T18:00:44Z","author_association":"CONTRIBUTOR","body":"@133tosakarin , misc unit test also failed here.  Please take a look.  Thanks.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381445119/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381639269","html_url":"https://github.com/apache/ratis/pull/1152#issuecomment-2381639269","issue_url":"https://api.github.com/repos/apache/ratis/issues/1152","id":2381639269,"node_id":"IC_kwDOBMxbGc6N9O5l","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-29T22:46:32Z","updated_at":"2024-09-29T22:46:32Z","author_association":"CONTRIBUTOR","body":"This passed all the tests in https://github.com/apache/ratis/pull/1158 over release-3.1.1.  The failures here are unrelated.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381639269/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381639573","html_url":"https://github.com/apache/ratis/pull/1152#issuecomment-2381639573","issue_url":"https://api.github.com/repos/apache/ratis/issues/1152","id":2381639573,"node_id":"IC_kwDOBMxbGc6N9O-V","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-29T22:47:43Z","updated_at":"2024-09-29T22:47:43Z","author_association":"CONTRIBUTOR","body":"The failure is tracked by RATIS-2151.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381639573/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381639680","html_url":"https://github.com/apache/ratis/pull/1152#issuecomment-2381639680","issue_url":"https://api.github.com/repos/apache/ratis/issues/1152","id":2381639680,"node_id":"IC_kwDOBMxbGc6N9PAA","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-29T22:48:10Z","updated_at":"2024-09-29T22:48:10Z","author_association":"CONTRIBUTOR","body":"@OneSizeFitsQuorum , thanks a lot for reviewing this!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381639680/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381644151","html_url":"https://github.com/apache/ratis/pull/1158#issuecomment-2381644151","issue_url":"https://api.github.com/repos/apache/ratis/issues/1158","id":2381644151,"node_id":"IC_kwDOBMxbGc6N9QF3","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-29T23:04:51Z","updated_at":"2024-09-29T23:04:51Z","author_association":"CONTRIBUTOR","body":"This is the build info: https://github.com/apache/ratis/actions/runs/11094746799","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381644151/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381849353","html_url":"https://github.com/apache/ratis/pull/1157#issuecomment-2381849353","issue_url":"https://api.github.com/repos/apache/ratis/issues/1157","id":2381849353,"node_id":"IC_kwDOBMxbGc6N-CMJ","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-30T01:46:07Z","updated_at":"2024-09-30T01:46:07Z","author_association":"CONTRIBUTOR","body":"> @133tosakarin , misc unit test also failed here. Please take a look. Thanks.\r\n\r\n\r\n\r\n> @133tosakarin , misc unit test also failed here. Please take a look. Thanks.\r\n\r\nSze, thank you for helping to test, I will continue to investigate RATIS-2162.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381849353/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381908770","html_url":"https://github.com/apache/ratis/pull/1157#issuecomment-2381908770","issue_url":"https://api.github.com/repos/apache/ratis/issues/1157","id":2381908770,"node_id":"IC_kwDOBMxbGc6N-Qsi","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-30T03:01:19Z","updated_at":"2024-09-30T03:16:00Z","author_association":"CONTRIBUTOR","body":"@szetszwo \r\n\r\n![image](https://github.com/user-attachments/assets/32c21b2c-1beb-4ce2-83d0-e521346ad442)\r\n\r\nI found that the failure of mics occurred in simulateRpc because logAppenderDaemon s9 was blocked waiting for rpc reply.\r\n\r\nThis problem seems to be unstable recurrence, and I have tried many times locally without triggering it.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2381908770/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2382220949","html_url":"https://github.com/apache/ratis/pull/1157#issuecomment-2382220949","issue_url":"https://api.github.com/repos/apache/ratis/issues/1157","id":2382220949,"node_id":"IC_kwDOBMxbGc6N_c6V","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-30T06:29:39Z","updated_at":"2024-09-30T06:29:39Z","author_association":"CONTRIBUTOR","body":"Let's rerun it here to see if it can be reproduced.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2382220949/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2382236484","html_url":"https://github.com/apache/ratis/pull/1157#issuecomment-2382236484","issue_url":"https://api.github.com/repos/apache/ratis/issues/1157","id":2382236484,"node_id":"IC_kwDOBMxbGc6N_gtE","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-30T06:40:30Z","updated_at":"2024-09-30T06:40:30Z","author_association":"CONTRIBUTOR","body":"> Let's rerun it here to see if it can be reproduced.\r\n\r\nSze, thank you for continuing to follow this PR, misc has passed.\r\n\r\nIn addition, I found that the reason why logAppender s9 continues to block is that this FileChannel cannot be created. Other logAppenders that are working normally have already created FileChannels.\r\n\r\n![image](https://github.com/user-attachments/assets/a7813c08-bab7-475d-8845-37701fe12a56)\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2382236484/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2382240042","html_url":"https://github.com/apache/ratis/pull/1157#issuecomment-2382240042","issue_url":"https://api.github.com/repos/apache/ratis/issues/1157","id":2382240042,"node_id":"IC_kwDOBMxbGc6N_hkq","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-30T06:42:55Z","updated_at":"2024-09-30T06:42:55Z","author_association":"CONTRIBUTOR","body":"Let's merge https://github.com/apache/ratis/pull/1154 then.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2382240042/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2382240664","html_url":"https://github.com/apache/ratis/pull/1154#issuecomment-2382240664","issue_url":"https://api.github.com/repos/apache/ratis/issues/1154","id":2382240664,"node_id":"IC_kwDOBMxbGc6N_huY","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-30T06:43:21Z","updated_at":"2024-09-30T06:43:21Z","author_association":"CONTRIBUTOR","body":"https://github.com/apache/ratis/pull/1157 has passed over 3.1.1.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2382240664/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2391033860","html_url":"https://github.com/apache/ratis/pull/1161#issuecomment-2391033860","issue_url":"https://api.github.com/repos/apache/ratis/issues/1161","id":2391033860,"node_id":"IC_kwDOBMxbGc6OhEgE","user":{"login":"jianghuazhu","id":6416939,"node_id":"MDQ6VXNlcjY0MTY5Mzk=","avatar_url":"https://avatars.githubusercontent.com/u/6416939?v=4","gravatar_id":"","url":"https://api.github.com/users/jianghuazhu","html_url":"https://github.com/jianghuazhu","followers_url":"https://api.github.com/users/jianghuazhu/followers","following_url":"https://api.github.com/users/jianghuazhu/following{/other_user}","gists_url":"https://api.github.com/users/jianghuazhu/gists{/gist_id}","starred_url":"https://api.github.com/users/jianghuazhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jianghuazhu/subscriptions","organizations_url":"https://api.github.com/users/jianghuazhu/orgs","repos_url":"https://api.github.com/users/jianghuazhu/repos","events_url":"https://api.github.com/users/jianghuazhu/events{/privacy}","received_events_url":"https://api.github.com/users/jianghuazhu/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-03T10:13:37Z","updated_at":"2024-10-03T10:13:37Z","author_association":"CONTRIBUTOR","body":"@szetszwo , can you help review this PR?\r\nThanks","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2391033860/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2392861246","html_url":"https://github.com/apache/ratis/pull/1161#issuecomment-2392861246","issue_url":"https://api.github.com/repos/apache/ratis/issues/1161","id":2392861246,"node_id":"IC_kwDOBMxbGc6OoCo-","user":{"login":"jianghuazhu","id":6416939,"node_id":"MDQ6VXNlcjY0MTY5Mzk=","avatar_url":"https://avatars.githubusercontent.com/u/6416939?v=4","gravatar_id":"","url":"https://api.github.com/users/jianghuazhu","html_url":"https://github.com/jianghuazhu","followers_url":"https://api.github.com/users/jianghuazhu/followers","following_url":"https://api.github.com/users/jianghuazhu/following{/other_user}","gists_url":"https://api.github.com/users/jianghuazhu/gists{/gist_id}","starred_url":"https://api.github.com/users/jianghuazhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jianghuazhu/subscriptions","organizations_url":"https://api.github.com/users/jianghuazhu/orgs","repos_url":"https://api.github.com/users/jianghuazhu/repos","events_url":"https://api.github.com/users/jianghuazhu/events{/privacy}","received_events_url":"https://api.github.com/users/jianghuazhu/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-04T05:38:18Z","updated_at":"2024-10-04T05:38:18Z","author_association":"CONTRIBUTOR","body":"Thanks @szetszwo  for the comment and review.\r\nHere are some CI run failures that don't seem to be related to this PR.\r\nHere are my tests for my personal branch:\r\nhttps://github.com/jianghuazhu/ratis/actions/runs/11165969820\r\n","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2392861246/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2394682455","html_url":"https://github.com/apache/ratis/pull/1161#issuecomment-2394682455","issue_url":"https://api.github.com/repos/apache/ratis/issues/1161","id":2394682455,"node_id":"IC_kwDOBMxbGc6Ou_RX","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-04T21:16:18Z","updated_at":"2024-10-04T21:16:18Z","author_association":"CONTRIBUTOR","body":"@jianghuazhu , agree that the failures were not related to this.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2394682455/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2394849828","html_url":"https://github.com/apache/ratis/pull/1161#issuecomment-2394849828","issue_url":"https://api.github.com/repos/apache/ratis/issues/1161","id":2394849828,"node_id":"IC_kwDOBMxbGc6OvoIk","user":{"login":"jianghuazhu","id":6416939,"node_id":"MDQ6VXNlcjY0MTY5Mzk=","avatar_url":"https://avatars.githubusercontent.com/u/6416939?v=4","gravatar_id":"","url":"https://api.github.com/users/jianghuazhu","html_url":"https://github.com/jianghuazhu","followers_url":"https://api.github.com/users/jianghuazhu/followers","following_url":"https://api.github.com/users/jianghuazhu/following{/other_user}","gists_url":"https://api.github.com/users/jianghuazhu/gists{/gist_id}","starred_url":"https://api.github.com/users/jianghuazhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jianghuazhu/subscriptions","organizations_url":"https://api.github.com/users/jianghuazhu/orgs","repos_url":"https://api.github.com/users/jianghuazhu/repos","events_url":"https://api.github.com/users/jianghuazhu/events{/privacy}","received_events_url":"https://api.github.com/users/jianghuazhu/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-05T01:28:17Z","updated_at":"2024-10-05T01:30:05Z","author_association":"CONTRIBUTOR","body":"Thanks @szetszwo .\r\nI created a related issue in the Ozone project, HDDS-11529.\r\nI will resolve it when the next new version of Apache Ratis is imported.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2394849828/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2395938956","html_url":"https://github.com/apache/ratis/pull/1162#issuecomment-2395938956","issue_url":"https://api.github.com/repos/apache/ratis/issues/1162","id":2395938956,"node_id":"IC_kwDOBMxbGc6OzyCM","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-07T05:25:51Z","updated_at":"2024-10-07T05:25:51Z","author_association":"CONTRIBUTOR","body":"The failed test is a known problem but not related this; see RATIS-2151.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2395938956/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2396682963","html_url":"https://github.com/apache/ratis/pull/1156#issuecomment-2396682963","issue_url":"https://api.github.com/repos/apache/ratis/issues/1156","id":2396682963,"node_id":"IC_kwDOBMxbGc6O2nrT","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-07T11:37:31Z","updated_at":"2024-10-07T11:37:31Z","author_association":"CONTRIBUTOR","body":"Finally, it is able to pass all the tests (with a few retries).  Note that there are probably some other zero copy bugs.  Will fix them separately.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2396682963/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2397682136","html_url":"https://github.com/apache/ratis/pull/1162#issuecomment-2397682136","issue_url":"https://api.github.com/repos/apache/ratis/issues/1162","id":2397682136,"node_id":"IC_kwDOBMxbGc6O6bnY","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-07T19:09:06Z","updated_at":"2024-10-07T19:09:06Z","author_association":"CONTRIBUTOR","body":"@adoroszlai , thanks for reviewing this!\r\n\r\nTested this change in https://github.com/apache/ratis/pull/1156 .  It was able to pass everything (with a few retries).  Since this is just a build change, I would ignore the known test failures and merge this.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2397682136/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2397707643","html_url":"https://github.com/apache/ratis/pull/1156#issuecomment-2397707643","issue_url":"https://api.github.com/repos/apache/ratis/issues/1156","id":2397707643,"node_id":"IC_kwDOBMxbGc6O6h17","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-07T19:22:32Z","updated_at":"2024-10-07T19:22:52Z","author_association":"CONTRIBUTOR","body":"This can pass all the tests (with a few retries).  Since this change is quite big (56kB) and non-trivial, I will split this to a few JIRAs:\r\n1. The current JIRA RATIS-2164 for fixing `LeakDetector`.  (I will leave this PR as-is and submit another PR.)\r\n2. RATIS-2151 for fixing gRPC.\r\n3. RATIS-2159 for fixing other non-gRPC cases.\r\n\r\nI will see if (2) and (3) needed to be further split.\r\n\r\nBTW, we should move `LeakDetector` enabling from `MiniRaftClusterWithGrpc` to `MiniRaftCluster`.  It will be able to detect more failures.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2397707643/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2397788560","html_url":"https://github.com/apache/ratis/pull/1163#issuecomment-2397788560","issue_url":"https://api.github.com/repos/apache/ratis/issues/1163","id":2397788560,"node_id":"IC_kwDOBMxbGc6O61mQ","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-07T20:05:03Z","updated_at":"2024-10-07T20:05:03Z","author_association":"CONTRIBUTOR","body":"@duongkame , @133tosakarin , @OneSizeFitsQuorum , @adoroszlai , please take a look.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2397788560/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2397833764","html_url":"https://github.com/apache/ratis/pull/1163#issuecomment-2397833764","issue_url":"https://api.github.com/repos/apache/ratis/issues/1163","id":2397833764,"node_id":"IC_kwDOBMxbGc6O7Aok","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-07T20:30:31Z","updated_at":"2024-10-07T20:30:31Z","author_association":"CONTRIBUTOR","body":"The failures are expected since it needs the other fixes described in https://github.com/apache/ratis/pull/1156","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2397833764/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2398366094","html_url":"https://github.com/apache/ratis/pull/1164#issuecomment-2398366094","issue_url":"https://api.github.com/repos/apache/ratis/issues/1164","id":2398366094,"node_id":"IC_kwDOBMxbGc6O9CmO","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-08T01:05:40Z","updated_at":"2024-10-08T01:05:40Z","author_association":"CONTRIBUTOR","body":"@duongkame , @133tosakarin , @OneSizeFitsQuorum , @adoroszlai , please take a look.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2398366094/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2398933422","html_url":"https://github.com/apache/ratis/pull/1160#issuecomment-2398933422","issue_url":"https://api.github.com/repos/apache/ratis/issues/1160","id":2398933422,"node_id":"IC_kwDOBMxbGc6O_NGu","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-08T06:09:30Z","updated_at":"2024-10-08T06:09:30Z","author_association":"CONTRIBUTOR","body":"@szetszwo \r\n\r\nThese failed tests seem to meet expectations","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2398933422/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2398936815","html_url":"https://github.com/apache/ratis/pull/1159#issuecomment-2398936815","issue_url":"https://api.github.com/repos/apache/ratis/issues/1159","id":2398936815,"node_id":"IC_kwDOBMxbGc6O_N7v","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-08T06:11:54Z","updated_at":"2024-10-08T06:11:54Z","author_association":"CONTRIBUTOR","body":"@szetszwo \r\nThese failed tests seem to meet expectations","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2398936815/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2401011756","html_url":"https://github.com/apache/ratis/pull/1159#issuecomment-2401011756","issue_url":"https://api.github.com/repos/apache/ratis/issues/1159","id":2401011756,"node_id":"IC_kwDOBMxbGc6PHIgs","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-08T23:59:39Z","updated_at":"2024-10-08T23:59:39Z","author_association":"CONTRIBUTOR","body":"@133tosakarin , on a second thought, let's change the `Preconditions.assertEquals(..)` to throw `IOException`.  `Preconditions` usually is for correctness checking.  If `Preconditions` fails, it should indicate a bug.\r\n```java\r\n@@ -192,8 +193,12 @@ class SnapshotInstallationHandler {\r\n         //TODO: We should only update State with installed snapshot once the request is done.\r\n         state.installSnapshot(request);\r\n \r\n-        int idx = nextChunkIndex.getAndIncrement();\r\n-        Preconditions.assertEquals(snapshotChunkRequest.getRequestIndex(), idx, \"nextChunkIndex\");\r\n+        final int expectedChunkIndex = nextChunkIndex.getAndIncrement();\r\n+        if (snapshotChunkRequest.getRequestIndex() != expectedChunkIndex) {\r\n+          throw new IOException(\"Unexpected request chunk index: \" + snapshotChunkRequest.getRequestIndex()\r\n+              + \" (the expected index is \" + expectedChunkIndex + \")\");\r\n+        }\r\n+\r\n         // update the committed index\r\n         // re-load the state machine if this is the last chunk\r\n```","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2401011756/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2401018138","html_url":"https://github.com/apache/ratis/pull/1160#issuecomment-2401018138","issue_url":"https://api.github.com/repos/apache/ratis/issues/1160","id":2401018138,"node_id":"IC_kwDOBMxbGc6PHKEa","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-09T00:06:07Z","updated_at":"2024-10-09T00:06:07Z","author_association":"CONTRIBUTOR","body":"> These failed tests seem to meet expectations\r\n\r\n@133tosakarin , you are right that the failures does not seem related; see https://github.com/apache/ratis/pull/1156 .  Let's merge this without further retries.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2401018138/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2401284594","html_url":"https://github.com/apache/ratis/pull/1159#issuecomment-2401284594","issue_url":"https://api.github.com/repos/apache/ratis/issues/1159","id":2401284594,"node_id":"IC_kwDOBMxbGc6PILHy","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-09T04:21:57Z","updated_at":"2024-10-09T04:21:57Z","author_association":"CONTRIBUTOR","body":"@133tosakarin , you are right that the failures does not seem related; see https://github.com/apache/ratis/pull/1156 . Let's merge this without further retries.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2401284594/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2402075874","html_url":"https://github.com/apache/ratis/pull/1165#issuecomment-2402075874","issue_url":"https://api.github.com/repos/apache/ratis/issues/1165","id":2402075874,"node_id":"IC_kwDOBMxbGc6PLMTi","user":{"login":"jianghuazhu","id":6416939,"node_id":"MDQ6VXNlcjY0MTY5Mzk=","avatar_url":"https://avatars.githubusercontent.com/u/6416939?v=4","gravatar_id":"","url":"https://api.github.com/users/jianghuazhu","html_url":"https://github.com/jianghuazhu","followers_url":"https://api.github.com/users/jianghuazhu/followers","following_url":"https://api.github.com/users/jianghuazhu/following{/other_user}","gists_url":"https://api.github.com/users/jianghuazhu/gists{/gist_id}","starred_url":"https://api.github.com/users/jianghuazhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jianghuazhu/subscriptions","organizations_url":"https://api.github.com/users/jianghuazhu/orgs","repos_url":"https://api.github.com/users/jianghuazhu/repos","events_url":"https://api.github.com/users/jianghuazhu/events{/privacy}","received_events_url":"https://api.github.com/users/jianghuazhu/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-09T11:36:56Z","updated_at":"2024-10-09T11:36:56Z","author_association":"CONTRIBUTOR","body":"@szetszwo , can you help review this PR?\r\nThanks.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2402075874/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2402655608","html_url":"https://github.com/apache/ratis/pull/1165#issuecomment-2402655608","issue_url":"https://api.github.com/repos/apache/ratis/issues/1165","id":2402655608,"node_id":"IC_kwDOBMxbGc6PNZ14","user":{"login":"jianghuazhu","id":6416939,"node_id":"MDQ6VXNlcjY0MTY5Mzk=","avatar_url":"https://avatars.githubusercontent.com/u/6416939?v=4","gravatar_id":"","url":"https://api.github.com/users/jianghuazhu","html_url":"https://github.com/jianghuazhu","followers_url":"https://api.github.com/users/jianghuazhu/followers","following_url":"https://api.github.com/users/jianghuazhu/following{/other_user}","gists_url":"https://api.github.com/users/jianghuazhu/gists{/gist_id}","starred_url":"https://api.github.com/users/jianghuazhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jianghuazhu/subscriptions","organizations_url":"https://api.github.com/users/jianghuazhu/orgs","repos_url":"https://api.github.com/users/jianghuazhu/repos","events_url":"https://api.github.com/users/jianghuazhu/events{/privacy}","received_events_url":"https://api.github.com/users/jianghuazhu/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-09T15:27:47Z","updated_at":"2024-10-09T15:27:47Z","author_association":"CONTRIBUTOR","body":"Ok, thanks @szetszwo .","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2402655608/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2403862329","html_url":"https://github.com/apache/ratis/pull/1166#issuecomment-2403862329","issue_url":"https://api.github.com/repos/apache/ratis/issues/1166","id":2403862329,"node_id":"IC_kwDOBMxbGc6PSAc5","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-10T03:25:44Z","updated_at":"2024-10-10T03:25:44Z","author_association":"CONTRIBUTOR","body":"@szetszwo \r\nPlease review this PR","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2403862329/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2407586916","html_url":"https://github.com/apache/ratis/pull/1164#issuecomment-2407586916","issue_url":"https://api.github.com/repos/apache/ratis/issues/1164","id":2407586916,"node_id":"IC_kwDOBMxbGc6PgNxk","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-11T14:54:38Z","updated_at":"2024-10-11T14:54:38Z","author_association":"CONTRIBUTOR","body":"@adoroszlai , could you approve this?  I guess no one else will review this.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2407586916/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2407597560","html_url":"https://github.com/apache/ratis/pull/1164#issuecomment-2407597560","issue_url":"https://api.github.com/repos/apache/ratis/issues/1164","id":2407597560,"node_id":"IC_kwDOBMxbGc6PgQX4","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-11T14:59:52Z","updated_at":"2024-10-11T14:59:52Z","author_association":"CONTRIBUTOR","body":"@adoroszlai , thanks a lot for reviewing and approving this!","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2407597560/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2407799669","html_url":"https://github.com/apache/ratis/pull/1153#issuecomment-2407799669","issue_url":"https://api.github.com/repos/apache/ratis/issues/1153","id":2407799669,"node_id":"IC_kwDOBMxbGc6PhBt1","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-11T16:58:37Z","updated_at":"2024-10-11T16:58:37Z","author_association":"CONTRIBUTOR","body":"This was fixed as a part of RATIS-2151.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2407799669/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2414018958","html_url":"https://github.com/apache/ratis/pull/1168#issuecomment-2414018958","issue_url":"https://api.github.com/repos/apache/ratis/issues/1168","id":2414018958,"node_id":"IC_kwDOBMxbGc6P4wGO","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-15T14:04:56Z","updated_at":"2024-10-15T14:04:56Z","author_association":"CONTRIBUTOR","body":"@szetszwo \r\nplease take a look. If you agree to write it this way, I will create an issue in jira.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2414018958/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2417045970","html_url":"https://github.com/apache/ratis/pull/1168#issuecomment-2417045970","issue_url":"https://api.github.com/repos/apache/ratis/issues/1168","id":2417045970,"node_id":"IC_kwDOBMxbGc6QETHS","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-16T14:41:54Z","updated_at":"2024-10-16T14:41:54Z","author_association":"CONTRIBUTOR","body":"@szetszwo @OneSizeFitsQuorum \r\n\r\nPlease check the comments below. could you help me refer to which one to use as the final solution?\r\nThere are currently two main options:\r\n1. Move future.join outsize the lock (current commit)\r\n2. Use wait/notify (Code Block below)\r\n\r\n```\r\nSubject: [PATCH] use wait/notify\r\n---\r\nIndex: ratis-server/src/main/java/org/apache/ratis/server/leader/LogAppenderDaemon.java\r\nIDEA additional info:\r\nSubsystem: com.intellij.openapi.diff.impl.patch.CharsetEP\r\n<+>UTF-8\r\n===================================================================\r\ndiff --git a/ratis-server/src/main/java/org/apache/ratis/server/leader/LogAppenderDaemon.java b/ratis-server/src/main/java/org/apache/ratis/server/leader/LogAppenderDaemon.java\r\n--- a/ratis-server/src/main/java/org/apache/ratis/server/leader/LogAppenderDaemon.java\t(revision 62ae6d9f068ce01dd467a6fa83fb74dad9c2c8d8)\r\n+++ b/ratis-server/src/main/java/org/apache/ratis/server/leader/LogAppenderDaemon.java\t(date 1729085480985)\r\n@@ -94,6 +94,9 @@\r\n         logAppender.restart();\r\n       }\r\n       closeFuture.complete(finalState);\r\n+      synchronized (logAppender.getServer()) {\r\n+        logAppender.getServer().notifyAll();\r\n+      }\r\n     }\r\n   }\r\n \r\nIndex: ratis-server/src/main/java/org/apache/ratis/server/impl/FollowerState.java\r\nIDEA additional info:\r\nSubsystem: com.intellij.openapi.diff.impl.patch.CharsetEP\r\n<+>UTF-8\r\n===================================================================\r\ndiff --git a/ratis-server/src/main/java/org/apache/ratis/server/impl/FollowerState.java b/ratis-server/src/main/java/org/apache/ratis/server/impl/FollowerState.java\r\n--- a/ratis-server/src/main/java/org/apache/ratis/server/impl/FollowerState.java\t(revision 62ae6d9f068ce01dd467a6fa83fb74dad9c2c8d8)\r\n+++ b/ratis-server/src/main/java/org/apache/ratis/server/impl/FollowerState.java\t(date 1729086757702)\r\n@@ -130,6 +130,9 @@\r\n       runImpl();\r\n     } finally {\r\n       stopped.complete(null);\r\n+      synchronized (server) {\r\n+        server.notifyAll();\r\n+      }\r\n     }\r\n   }\r\n \r\nIndex: ratis-server/src/main/java/org/apache/ratis/server/impl/RaftServerImpl.java\r\nIDEA additional info:\r\nSubsystem: com.intellij.openapi.diff.impl.patch.CharsetEP\r\n<+>UTF-8\r\n===================================================================\r\ndiff --git a/ratis-server/src/main/java/org/apache/ratis/server/impl/RaftServerImpl.java b/ratis-server/src/main/java/org/apache/ratis/server/impl/RaftServerImpl.java\r\n--- a/ratis-server/src/main/java/org/apache/ratis/server/impl/RaftServerImpl.java\t(revision 62ae6d9f068ce01dd467a6fa83fb74dad9c2c8d8)\r\n+++ b/ratis-server/src/main/java/org/apache/ratis/server/impl/RaftServerImpl.java\t(date 1729087936568)\r\n@@ -565,16 +565,38 @@\r\n     }\r\n   }\r\n \r\n+   static class Pair<U, V> {\r\n+    private final U first;\r\n+    private final V second;\r\n+\r\n+    private Pair(U first, V second) {\r\n+      this.first = first;\r\n+      this.second = second;\r\n+    }\r\n+\r\n+    static <U,V> Pair<U, V> makePair(U u,  V v) {\r\n+      return new Pair<>(u, v);\r\n+    }\r\n+\r\n+    U first() {\r\n+      return first;\r\n+    }\r\n+\r\n+    V second() {\r\n+      return second;\r\n+    }\r\n+  }\r\n+\r\n   /**\r\n    * Change the server state to Follower if this server is in a different role or force is true.\r\n    * @param newTerm The new term.\r\n    * @param force Force to start a new {@link FollowerState} even if this server is already a follower.\r\n    * @return if the term/votedFor should be updated to the new term\r\n    */\r\n-  private boolean changeToFollower(long newTerm, boolean force, boolean allowListener, Object reason) {\r\n+  private Pair<Boolean, CompletableFuture<Void>> changeToFollower(long newTerm, boolean force, boolean allowListener, Object reason) {\r\n     final AtomicReference<Boolean> metadataUpdated = new AtomicReference<>();\r\n-    changeToFollowerAsync(newTerm, force, allowListener, reason, metadataUpdated).join();\r\n-    return metadataUpdated.get();\r\n+    CompletableFuture<Void> future = changeToFollowerAsync(newTerm, force, allowListener, reason, metadataUpdated);\r\n+    return Pair.makePair(metadataUpdated.get(), future);\r\n   }\r\n \r\n   private synchronized CompletableFuture<Void> changeToFollowerAsync(\r\n@@ -617,20 +639,37 @@\r\n       long newTerm,\r\n       boolean allowListener,\r\n       Object reason) throws IOException {\r\n-    if (changeToFollower(newTerm, false, allowListener, reason)) {\r\n-      state.persistMetadata();\r\n+    Pair<Boolean, CompletableFuture<Void>> pair = changeToFollower(newTerm, false, allowListener, reason);\r\n+    try {\r\n+      if (pair.first()) {\r\n+        state.persistMetadata();\r\n+      }\r\n+    } finally {\r\n+      waitFutureAndJoin(pair.second());\r\n     }\r\n   }\r\n \r\n-  synchronized void changeToLeader() {\r\n+  synchronized void waitFutureAndJoin(CompletableFuture<?> future) {\r\n+    while (!future.isDone()) {\r\n+      try {\r\n+        this.wait();\r\n+      } catch (InterruptedException e) {\r\n+        // ignore\r\n+      }\r\n+    }\r\n+    future.join();\r\n+  }\r\n+  \r\n+  synchronized CompletableFuture<Void> changeToLeader() {\r\n     Preconditions.assertTrue(getInfo().isCandidate());\r\n-    role.shutdownLeaderElection();\r\n+    CompletableFuture<Void> future = role.shutdownLeaderElection();\r\n     setRole(RaftPeerRole.LEADER, \"changeToLeader\");\r\n     final LeaderStateImpl leader = role.updateLeaderState(this);\r\n     state.becomeLeader();\r\n \r\n     // start sending AppendEntries RPC to followers\r\n     leader.start();\r\n+    return future;\r\n   }\r\n \r\n   @Override\r\n@@ -1460,8 +1499,9 @@\r\n       final boolean voteGranted = context.decideVote(candidate, candidateLastEntry);\r\n       if (candidate != null && phase == Phase.ELECTION) {\r\n         // change server state in the ELECTION phase\r\n-        final boolean termUpdated =\r\n-            changeToFollower(candidateTerm, true, false, \"candidate:\" + candidateId);\r\n+        Pair<Boolean, CompletableFuture<Void>> pair = changeToFollower(candidateTerm, true, false, \"candidate:\" + candidateId);\r\n+        final boolean termUpdated = pair.first;\r\n+        waitFutureAndJoin(pair.second);\r\n         if (voteGranted) {\r\n           state.grantVote(candidate.getId());\r\n         }\r\nIndex: ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderElection.java\r\nIDEA additional info:\r\nSubsystem: com.intellij.openapi.diff.impl.patch.CharsetEP\r\n<+>UTF-8\r\n===================================================================\r\ndiff --git a/ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderElection.java b/ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderElection.java\r\n--- a/ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderElection.java\t(revision 62ae6d9f068ce01dd467a6fa83fb74dad9c2c8d8)\r\n+++ b/ratis-server/src/main/java/org/apache/ratis/server/impl/LeaderElection.java\t(date 1729087936578)\r\n@@ -242,6 +242,9 @@\r\n       runImpl();\r\n     } finally {\r\n       stopped.complete(null);\r\n+      synchronized (server) {\r\n+        server.notifyAll();\r\n+      }\r\n     }\r\n   }\r\n \r\n@@ -256,7 +259,7 @@\r\n       for (int round = 0; shouldRun(); round++) {\r\n         if (skipPreVote || askForVotes(Phase.PRE_VOTE, round)) {\r\n           if (askForVotes(Phase.ELECTION, round)) {\r\n-            server.changeToLeader();\r\n+            server.changeToLeader().join();\r\n           }\r\n         }\r\n       }\r\n\r\n```","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2417045970/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2417523491","html_url":"https://github.com/apache/ratis/pull/1168#issuecomment-2417523491","issue_url":"https://api.github.com/repos/apache/ratis/issues/1168","id":2417523491,"node_id":"IC_kwDOBMxbGc6QGHsj","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-16T17:53:51Z","updated_at":"2024-10-16T17:53:51Z","author_association":"CONTRIBUTOR","body":"@133tosakarin , sorry for the delay.  Will review this soon.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2417523491/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2417572721","html_url":"https://github.com/apache/ratis/pull/1163#issuecomment-2417572721","issue_url":"https://api.github.com/repos/apache/ratis/issues/1163","id":2417572721,"node_id":"IC_kwDOBMxbGc6QGTtx","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-16T18:12:43Z","updated_at":"2024-10-16T18:12:43Z","author_association":"CONTRIBUTOR","body":"@OneSizeFitsQuorum , @adoroszlai , we need a committer review approval for this.  With this and RATIS-2173, the tests will be much easier to pass (although there may be still some undiscovered bugs.)","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2417572721/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2417963646","html_url":"https://github.com/apache/ratis/pull/1163#issuecomment-2417963646","issue_url":"https://api.github.com/repos/apache/ratis/issues/1163","id":2417963646,"node_id":"IC_kwDOBMxbGc6QHzJ-","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-16T21:05:45Z","updated_at":"2024-10-16T21:05:45Z","author_association":"CONTRIBUTOR","body":"@adoroszlai , thanks a lot for reviewing this!\r\n\r\nAlthough the test failures are unrelated, let's rerun them one more time.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2417963646/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2418630380","html_url":"https://github.com/apache/ratis/pull/1168#issuecomment-2418630380","issue_url":"https://api.github.com/repos/apache/ratis/issues/1168","id":2418630380,"node_id":"IC_kwDOBMxbGc6QKV7s","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-17T06:24:46Z","updated_at":"2024-10-17T06:24:46Z","author_association":"CONTRIBUTOR","body":"> @133tosakarin , thanks a lot for working on this! The idea is great.\r\n> \r\n> * We should avoid using `Optional`.  Using `final` is better since the compiler will enforce that the variable must be initialized before use.\r\n> * Let's pass an `AtomicBoolean` instead of adding the new `Pair` class.  It will have much less code change.\r\n> \r\n> See https://issues.apache.org/jira/secure/attachment/13072253/1168_review.patch\r\n\r\nSze, thank you for your advice!\r\n\r\nOur current commit is to move future.join out of the lock, but **OneSizeFitsQuorum** thinks there may be concurrency issues. \r\n\r\nWhat do you think?","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2418630380/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2419890203","html_url":"https://github.com/apache/ratis/pull/1168#issuecomment-2419890203","issue_url":"https://api.github.com/repos/apache/ratis/issues/1168","id":2419890203,"node_id":"IC_kwDOBMxbGc6QPJgb","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-17T15:39:38Z","updated_at":"2024-10-17T15:39:38Z","author_association":"CONTRIBUTOR","body":"Suppose we have the following code:\r\n```java\r\nsynchronized(server) {\r\n  ...\r\n  final CompletableFuture<Void> future = state.shudown()\r\n  f.join()\r\n}\r\n```\r\n- I agree with you that calling `join()` at the end of `synchronized(server)` block seems useless since it just waits for the `state` thread to terminate.  If anything needs to be synchronized, it should be done inside the `shutdown()` method.  Of course, the `state` thread could be `synchronized(server)` in its `run()` method.  The same synchronization will happen also in the non-shutdown cases.  It there is a bug, the non-shutdown cases should also have the same bug.\r\n\r\n- I could see that calling `join()` at the middle of `synchronized(server)` may be useful in some cases -- the caller wants to wait of the `state` thread to complete for some reasons such as getting a final result.  However, we are not doing that in our shutdown code.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2419890203/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2420036950","html_url":"https://github.com/apache/ratis/pull/1167#issuecomment-2420036950","issue_url":"https://api.github.com/repos/apache/ratis/issues/1167","id":2420036950,"node_id":"IC_kwDOBMxbGc6QPtVW","user":{"login":"szetszwo","id":907380,"node_id":"MDQ6VXNlcjkwNzM4MA==","avatar_url":"https://avatars.githubusercontent.com/u/907380?v=4","gravatar_id":"","url":"https://api.github.com/users/szetszwo","html_url":"https://github.com/szetszwo","followers_url":"https://api.github.com/users/szetszwo/followers","following_url":"https://api.github.com/users/szetszwo/following{/other_user}","gists_url":"https://api.github.com/users/szetszwo/gists{/gist_id}","starred_url":"https://api.github.com/users/szetszwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szetszwo/subscriptions","organizations_url":"https://api.github.com/users/szetszwo/orgs","repos_url":"https://api.github.com/users/szetszwo/repos","events_url":"https://api.github.com/users/szetszwo/events{/privacy}","received_events_url":"https://api.github.com/users/szetszwo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-17T16:50:19Z","updated_at":"2024-10-17T16:50:19Z","author_association":"CONTRIBUTOR","body":"After a few retries, this can pass everything (although there are still zero-copy bugs).\r\n- https://github.com/apache/ratis/actions/runs/11378907332\r\n\r\nLet's move `ReferenceCountedLeakDetector.enable(..)` back to `MiniRaftClusterWithGrpc` for now in order to easier passing the tests.\r\n- Indeed, the non-gRPC leaks are not real leaks since there are no underlying buffers to release.  Just the reference counts are incorrect.\r\n- One kind of bugs may be related to `CodeInjectionForTesting` -- some tests may inject some code but not cleaning them up correctly.","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2420036950/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2421158186","html_url":"https://github.com/apache/ratis/pull/1168#issuecomment-2421158186","issue_url":"https://api.github.com/repos/apache/ratis/issues/1168","id":2421158186,"node_id":"IC_kwDOBMxbGc6QT_Eq","user":{"login":"133tosakarin","id":97331129,"node_id":"U_kgDOBc0nuQ","avatar_url":"https://avatars.githubusercontent.com/u/97331129?v=4","gravatar_id":"","url":"https://api.github.com/users/133tosakarin","html_url":"https://github.com/133tosakarin","followers_url":"https://api.github.com/users/133tosakarin/followers","following_url":"https://api.github.com/users/133tosakarin/following{/other_user}","gists_url":"https://api.github.com/users/133tosakarin/gists{/gist_id}","starred_url":"https://api.github.com/users/133tosakarin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/133tosakarin/subscriptions","organizations_url":"https://api.github.com/users/133tosakarin/orgs","repos_url":"https://api.github.com/users/133tosakarin/repos","events_url":"https://api.github.com/users/133tosakarin/events{/privacy}","received_events_url":"https://api.github.com/users/133tosakarin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-18T02:42:53Z","updated_at":"2024-10-18T02:42:53Z","author_association":"CONTRIBUTOR","body":"> Suppose we have the following code:\r\n> \r\n> ```java\r\n> synchronized(server) {\r\n>   ...\r\n>   final CompletableFuture<Void> future = state.shudown()\r\n>   f.join()\r\n> }\r\n> ```\r\n> \r\n> * I agree with you that calling `join()` at the end of `synchronized(server)` block seems useless since it just waits for the `state` thread to terminate.  If anything needs to be synchronized, it should be done inside the `shutdown()` method.  Of course, the `state` thread could be `synchronized(server)` in its `run()` method.  The same synchronization will happen also in the non-shutdown cases.  It there is a bug, the non-shutdown cases should also have the same bug.\r\n> * I could see that calling `join()` at the middle of `synchronized(server)` may be useful in some cases -- the caller wants to wait of the `state` thread to complete for some reasons such as getting a final result.  However, we are not doing that in our shutdown code.\r\n\r\nThank you for your valuable advice! We have reached a consensus\r\n\r\nRegarding the question raised by **OneSizeFitsQuorum**, the concern might be that when thread A waits for the state to shut down outside the `synchronized (server)` block, it is possible that the state thread could modify some data of the server. When thread A is woken up, since some server data may have been changed by the state thread before its shutdown, the question is whether this could have any subsequent impact on thread A.\r\n\r\nOneSizeFitsQuorum recommends writing it as follows:\r\n\r\nFor Thread A:\r\n```\r\nsynchronized (server) {\r\n    future = state.shutdown();\r\n    while (!future.isDone()) {\r\n        server.wait();\r\n    }\r\n}\r\n```\r\n\r\nFor Thread State:\r\n```\r\nFuture<Void> stopped;\r\n...\r\ntry {\r\n    run();\r\n} finally {\r\n    stopped.complete();\r\n    synchronized (server) {\r\n        server.notify();\r\n    }\r\n}\r\n```\r\n\r\nIn our code, the State thread may be LogAppender, FollowerState, LeaderElection","reactions":{"url":"https://api.github.com/repos/apache/ratis/issues/comments/2421158186/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]