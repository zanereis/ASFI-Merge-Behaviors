[{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/926625539","html_url":"https://github.com/apache/couchdb/issues/3477#issuecomment-926625539","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3477","id":926625539,"node_id":"IC_kwDOAAMmUc43Oy8D","user":{"login":"AJ1989x","id":23634564,"node_id":"MDQ6VXNlcjIzNjM0NTY0","avatar_url":"https://avatars.githubusercontent.com/u/23634564?v=4","gravatar_id":"","url":"https://api.github.com/users/AJ1989x","html_url":"https://github.com/AJ1989x","followers_url":"https://api.github.com/users/AJ1989x/followers","following_url":"https://api.github.com/users/AJ1989x/following{/other_user}","gists_url":"https://api.github.com/users/AJ1989x/gists{/gist_id}","starred_url":"https://api.github.com/users/AJ1989x/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AJ1989x/subscriptions","organizations_url":"https://api.github.com/users/AJ1989x/orgs","repos_url":"https://api.github.com/users/AJ1989x/repos","events_url":"https://api.github.com/users/AJ1989x/events{/privacy}","received_events_url":"https://api.github.com/users/AJ1989x/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-24T13:29:15Z","updated_at":"2021-09-24T13:29:27Z","author_association":"NONE","body":"Any new informations? ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/926625539/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":2},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/926860933","html_url":"https://github.com/apache/couchdb/pull/3763#issuecomment-926860933","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3763","id":926860933,"node_id":"IC_kwDOAAMmUc43PsaF","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-24T19:10:35Z","updated_at":"2021-09-24T19:10:35Z","author_association":"MEMBER","body":"LGTM. Appreciate the co-author credit üôè  but my email is kocolosk@apache.org","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/926860933/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/926885384","html_url":"https://github.com/apache/couchdb/pull/3763#issuecomment-926885384","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3763","id":926885384,"node_id":"IC_kwDOAAMmUc43PyYI","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-24T19:57:30Z","updated_at":"2021-09-24T19:58:50Z","author_association":"CONTRIBUTOR","body":"> LGTM. Appreciate the co-author credit üôè but my email is [kocolosk@apache.org](mailto:kocolosk@apache.org)\r\n\r\nOh, sorry! I corrected it both the commit message and the PR comment","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/926885384/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/927665880","html_url":"https://github.com/apache/couchdb/pull/3764#issuecomment-927665880","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3764","id":927665880,"node_id":"IC_kwDOAAMmUc43Sw7Y","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-27T08:56:47Z","updated_at":"2021-09-27T08:56:47Z","author_association":"MEMBER","body":"Those are two good enhancements and agree they would be nice. My work here simply reintroduces the semantics of this feature as it existed in 3.x (and the default.ini comment makes clear that the ending of the response is contingent on receiving an update).","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/927665880/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/928092100","html_url":"https://github.com/apache/couchdb/pull/3767#issuecomment-928092100","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3767","id":928092100,"node_id":"IC_kwDOAAMmUc43UY_E","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-27T17:23:51Z","updated_at":"2021-09-27T17:23:51Z","author_association":"MEMBER","body":"This needs an automated test. As we cannot run search in our automated test suite, the test should validate that, after loading dreyfus with no clouseau connected, and the default `search = true`, `search` is *not* returned by `GET /`.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/928092100/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/928110718","html_url":"https://github.com/apache/couchdb/pull/3767#issuecomment-928110718","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3767","id":928110718,"node_id":"IC_kwDOAAMmUc43Udh-","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-27T17:51:22Z","updated_at":"2021-09-28T16:14:16Z","author_association":"CONTRIBUTOR","body":"Agree with @wohali. We should only return \"search\" in the features list if users can successfully use the feature. If `search` appears as a feature but search doesn't actually work, it would be quite confusing. ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/928110718/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/928335621","html_url":"https://github.com/apache/couchdb/pull/3769#issuecomment-928335621","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3769","id":928335621,"node_id":"IC_kwDOAAMmUc43VUcF","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-27T22:01:11Z","updated_at":"2021-09-27T22:01:11Z","author_association":"CONTRIBUTOR","body":"Pasting the `+1` from @wohali on couchdb-dev IRC","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/928335621/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/931474968","html_url":"https://github.com/apache/couchdb/issues/2934#issuecomment-931474968","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2934","id":931474968,"node_id":"IC_kwDOAAMmUc43hS4Y","user":{"login":"tsloughter","id":36227,"node_id":"MDQ6VXNlcjM2MjI3","avatar_url":"https://avatars.githubusercontent.com/u/36227?v=4","gravatar_id":"","url":"https://api.github.com/users/tsloughter","html_url":"https://github.com/tsloughter","followers_url":"https://api.github.com/users/tsloughter/followers","following_url":"https://api.github.com/users/tsloughter/following{/other_user}","gists_url":"https://api.github.com/users/tsloughter/gists{/gist_id}","starred_url":"https://api.github.com/users/tsloughter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsloughter/subscriptions","organizations_url":"https://api.github.com/users/tsloughter/orgs","repos_url":"https://api.github.com/users/tsloughter/repos","events_url":"https://api.github.com/users/tsloughter/events{/privacy}","received_events_url":"https://api.github.com/users/tsloughter/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-30T16:23:58Z","updated_at":"2021-09-30T16:23:58Z","author_association":"NONE","body":"Just saw @dch mention a new CouchDB release on irc and it reminded me to look back at this thread. I thought I'd just mention some development on the OpenTelemetry side, first being that the tracing spec 1.0 has been released, https://medium.com/opentelemetry/opentelemetry-specification-v1-0-0-tracing-edition-72dd08936978\r\n\r\nThe Erlang implementation has been stuck at an RC release for months but that will be changing soon with a 1.0 release in the coming weeks.\r\n\r\nIt has also been over a year since this was opened so maybe support for pre-21 Erlang is considered being dropped now?\r\n\r\nAlso all development is now done under the repo https://github.com/open-telemetry/opentelemetry-erlang/ (plus https://github.com/open-telemetry/opentelemetry-erlang-contrib where instrumentation for other libraries are kept) and the old `opentelemetry-erlang-api` repo is archived.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/931474968/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/931589350","html_url":"https://github.com/apache/couchdb/issues/2934#issuecomment-931589350","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2934","id":931589350,"node_id":"IC_kwDOAAMmUc43huzm","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-30T19:07:24Z","updated_at":"2021-09-30T19:07:24Z","author_association":"CONTRIBUTOR","body":"@tsloughter that's great to hear about OpenTelemetry, thanks for the update!\r\n\r\nThe new CouchDB 3.2 release still support Erlang and is already in the final release candidate phase. However, by the next major release it's highly likely we'd bump the minimum Erlang version to be >= 21, so OpenTelemetry would become easier to integrate.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/931589350/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/932585638","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-932585638","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":932585638,"node_id":"IC_kwDOAAMmUc43liCm","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-01T21:25:40Z","updated_at":"2021-10-01T21:25:40Z","author_association":"CONTRIBUTOR","body":"That looks like a collation bug. We use the ICU library for comparisons when view rows are ordered with respect to each other. It could be that the collation library is too old, or, most likely at some point, we compare or merge rows not based on the ICU order but using binary comparisons.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/932585638/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/932603969","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-932603969","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":932603969,"node_id":"IC_kwDOAAMmUc43lmhB","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-01T22:05:32Z","updated_at":"2021-10-01T22:05:32Z","author_association":"CONTRIBUTOR","body":"Hmm, I could not reproduce it with latest 3.x branch. Erlang 20, MacOS, libicu 59:\r\n\r\n```\r\notool -L couch_ejson_compare.so\r\ncouch_ejson_compare.so:\r\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1292.100.5)\r\n\t/usr/local/opt/icu4c/lib/libicuuc.59.dylib (compatibility version 59.0.0, current version 59.1.0)\r\n\t/usr/local/opt/icu4c/lib/libicudata.59.1.dylib (compatibility version 59.0.0, current version 59.1.0)\r\n\t/usr/local/opt/icu4c/lib/libicui18n.59.dylib (compatibility version 59.0.0, current version 59.1.0)\r\n```\r\n\r\nI slightly tweaked your script https://gist.github.com/nickva/e351e678fc10d3b5424de44be992703c but ensure it still preserved the encoded values:\r\n\r\n```\r\n % ./collation_bug_view.sh\r\n{\"ok\":true}\r\n{\"ok\":true}\r\n{\"ok\":true,\"id\":\"_design/by-type-name\",\"rev\":\"1-c5fc5a56efeddb94b1c3a3de0d25f7dd\"}\r\n{\"ok\":true,\"id\":\"doc1\",\"rev\":\"1-b269c8b395d44f4a054ad149f232886c\"}\r\n{\"ok\":true,\"id\":\"doc2\",\"rev\":\"1-af18b03890d4f08e8e41b720f27c11fa\"}\r\nWe can see that \"cha√Æne\" is encoded one time as 69cc82, and one time as c3ae\r\n\r\n00000000: 2020 2020 2020 2020 226e 616d 6522 3a20          \"name\":\r\n00000010: 2263 6861 c3ae 6e65 220a 2020 2020 2020  \"cha..ne\".\r\n00000020: 2020 226e 616d 6522 3a20 2263 6861 69cc    \"name\": \"chai.\r\n00000030: 826e 6522 0a                             .ne\".\r\n\r\nRequest the view, one time for each encoding\r\n\r\n--- c h a i n e ---\r\n{\"rows\":[\r\n{\"key\":[\"file\",\"cha√Æne\"],\"value\":1}\r\n]}\r\n\r\n--- c h a i ^ n e ---\r\n{\"rows\":[\r\n{\"key\":[\"file\",\"chaiÃÇne\"],\"value\":1}\r\n]}\r\n\r\nExpected: 1 row in each response, but I got 2 rows in first response and 0 on the second\r\n```\r\n\r\nSee if you can determine the version of Erlang and libicu used?\r\n\r\nAnd you're definitely not using the \"raw\" collation option?\r\n\r\nAnother idea is to try with the the latest 3.1.1 version, perhaps different OS...","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/932603969/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933237430","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-933237430","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":933237430,"node_id":"IC_kwDOAAMmUc43oBK2","user":{"login":"sblaisot","id":2768193,"node_id":"MDQ6VXNlcjI3NjgxOTM=","avatar_url":"https://avatars.githubusercontent.com/u/2768193?v=4","gravatar_id":"","url":"https://api.github.com/users/sblaisot","html_url":"https://github.com/sblaisot","followers_url":"https://api.github.com/users/sblaisot/followers","following_url":"https://api.github.com/users/sblaisot/following{/other_user}","gists_url":"https://api.github.com/users/sblaisot/gists{/gist_id}","starred_url":"https://api.github.com/users/sblaisot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sblaisot/subscriptions","organizations_url":"https://api.github.com/users/sblaisot/orgs","repos_url":"https://api.github.com/users/sblaisot/repos","events_url":"https://api.github.com/users/sblaisot/events{/privacy}","received_events_url":"https://api.github.com/users/sblaisot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-04T07:57:15Z","updated_at":"2021-10-04T07:57:15Z","author_association":"CONTRIBUTOR","body":"We had the problem on debian 9 stretch with couchdb 2.3.0 from debian package found at https://apache.jfrog.io/ui/native/couchdb-deb/dists/stretch.\r\n\r\nErlang comes with that package and is version 8.3.5\r\nSystem's libICU is version 57.1 (I'm not sure couchdb from debian package uses system's library but I can't find any libICU installed with that package)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933237430/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933240496","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-933240496","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":933240496,"node_id":"IC_kwDOAAMmUc43oB6w","user":{"login":"sblaisot","id":2768193,"node_id":"MDQ6VXNlcjI3NjgxOTM=","avatar_url":"https://avatars.githubusercontent.com/u/2768193?v=4","gravatar_id":"","url":"https://api.github.com/users/sblaisot","html_url":"https://github.com/sblaisot","followers_url":"https://api.github.com/users/sblaisot/followers","following_url":"https://api.github.com/users/sblaisot/following{/other_user}","gists_url":"https://api.github.com/users/sblaisot/gists{/gist_id}","starred_url":"https://api.github.com/users/sblaisot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sblaisot/subscriptions","organizations_url":"https://api.github.com/users/sblaisot/orgs","repos_url":"https://api.github.com/users/sblaisot/repos","events_url":"https://api.github.com/users/sblaisot/events{/privacy}","received_events_url":"https://api.github.com/users/sblaisot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-04T08:01:43Z","updated_at":"2021-10-04T08:01:43Z","author_association":"CONTRIBUTOR","body":"well, couchdb from upstream package seems to uses system's library so it's libICU 57.1:\r\n```\r\n# ldd /opt/couchdb/lib/couch-2.3.0-RC1/priv/couch_ejson_compare.so | grep -i icu\r\n\tlibicuuc.so.57 => /usr/lib/x86_64-linux-gnu/libicuuc.so.57 (0x00007f7d4a74c000)\r\n\tlibicudata.so.57 => /usr/lib/x86_64-linux-gnu/libicudata.so.57 (0x00007f7d48ccf000)\r\n\tlibicui18n.so.57 => /usr/lib/x86_64-linux-gnu/libicui18n.so.57 (0x00007f7d48854000)\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933240496/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933309717","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-933309717","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":933309717,"node_id":"IC_kwDOAAMmUc43oS0V","user":{"login":"nono","id":2767,"node_id":"MDQ6VXNlcjI3Njc=","avatar_url":"https://avatars.githubusercontent.com/u/2767?v=4","gravatar_id":"","url":"https://api.github.com/users/nono","html_url":"https://github.com/nono","followers_url":"https://api.github.com/users/nono/followers","following_url":"https://api.github.com/users/nono/following{/other_user}","gists_url":"https://api.github.com/users/nono/gists{/gist_id}","starred_url":"https://api.github.com/users/nono/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nono/subscriptions","organizations_url":"https://api.github.com/users/nono/orgs","repos_url":"https://api.github.com/users/nono/repos","events_url":"https://api.github.com/users/nono/events{/privacy}","received_events_url":"https://api.github.com/users/nono/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-04T09:30:38Z","updated_at":"2021-10-04T09:30:38Z","author_association":"NONE","body":"Could it be related to clustering? We don't see this issue when trying the script on a single node server with debian stretch and the official debian package.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933309717/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933486656","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-933486656","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":933486656,"node_id":"IC_kwDOAAMmUc43o-BA","user":{"login":"sblaisot","id":2768193,"node_id":"MDQ6VXNlcjI3NjgxOTM=","avatar_url":"https://avatars.githubusercontent.com/u/2768193?v=4","gravatar_id":"","url":"https://api.github.com/users/sblaisot","html_url":"https://github.com/sblaisot","followers_url":"https://api.github.com/users/sblaisot/followers","following_url":"https://api.github.com/users/sblaisot/following{/other_user}","gists_url":"https://api.github.com/users/sblaisot/gists{/gist_id}","starred_url":"https://api.github.com/users/sblaisot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sblaisot/subscriptions","organizations_url":"https://api.github.com/users/sblaisot/orgs","repos_url":"https://api.github.com/users/sblaisot/repos","events_url":"https://api.github.com/users/sblaisot/events{/privacy}","received_events_url":"https://api.github.com/users/sblaisot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-04T13:27:58Z","updated_at":"2021-10-04T13:27:58Z","author_association":"CONTRIBUTOR","body":"Some more tests from our side :\r\n\r\non debian 9 stretch with official couchdb deb package.\r\n\r\nBug not show with default config (standalone mode, no clustering, n=1)\r\n\r\nBUT, if I add `q = 1` in `[cluster]` section of the config, I can reproduce the problem 100%\r\n\r\nSteps to reproduce:\r\n1. install couchdb 2.3.0 from debian package on debian stretch, selecting standalone mode\r\n2. add `q = 1` in `/opt/couchdb/etc/default.d/5-single-node.ini`\r\n3. restart couchdb\r\n4. wait 10 seconds to let it start\r\n5. run above script\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933486656/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933493409","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-933493409","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":933493409,"node_id":"IC_kwDOAAMmUc43o_qh","user":{"login":"nono","id":2767,"node_id":"MDQ6VXNlcjI3Njc=","avatar_url":"https://avatars.githubusercontent.com/u/2767?v=4","gravatar_id":"","url":"https://api.github.com/users/nono","html_url":"https://github.com/nono","followers_url":"https://api.github.com/users/nono/followers","following_url":"https://api.github.com/users/nono/following{/other_user}","gists_url":"https://api.github.com/users/nono/gists{/gist_id}","starred_url":"https://api.github.com/users/nono/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nono/subscriptions","organizations_url":"https://api.github.com/users/nono/orgs","repos_url":"https://api.github.com/users/nono/repos","events_url":"https://api.github.com/users/nono/events{/privacy}","received_events_url":"https://api.github.com/users/nono/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-04T13:35:37Z","updated_at":"2021-10-04T13:35:37Z","author_association":"NONE","body":"So, we can reproduce with:\r\n\r\n```sh\r\n#!/bin/sh\r\nCOUCH_URL=\"http://localhost:5984\"\r\ncurl -s -X DELETE \"$COUCH_URL/debug\"\r\nsleep 1\r\ncurl -s -X PUT \"$COUCH_URL/debug?n=1&q=1\"\r\nsleep 1\r\ncurl -s -X PUT \"$COUCH_URL/debug/_design/by-type-name\" -d '{ \"views\": { \"by-type-name\": { \"map\": \"function (doc) { emit([doc.type, doc.name]) }\", \"reduce\": \"_count\" } } }'\r\ncurl -s -X PUT \"$COUCH_URL/debug/doc1\" -H \"Content-Type: application/json\" -d '{ \"type\": \"file\", \"name\": \"chaiÃÇne\" }'\r\ncurl -s -X PUT \"$COUCH_URL/debug/doc2\" -H \"Content-Type: application/json\" -d '{ \"type\": \"file\", \"name\": \"cha√Æne\" }'\r\ncurl -s \"$COUCH_URL/debug/_design/by-type-name/_view/by-type-name?group=true\" -H \"Content-Type: application/json\" -d '{\"keys\": [[\"file\", \"cha√Æne\"]]}'\r\n```\r\n\r\nI have 0 rows in the response of the last request, but I would definitively expect a row.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933493409/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933512138","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-933512138","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":933512138,"node_id":"IC_kwDOAAMmUc43pEPK","user":{"login":"sblaisot","id":2768193,"node_id":"MDQ6VXNlcjI3NjgxOTM=","avatar_url":"https://avatars.githubusercontent.com/u/2768193?v=4","gravatar_id":"","url":"https://api.github.com/users/sblaisot","html_url":"https://github.com/sblaisot","followers_url":"https://api.github.com/users/sblaisot/followers","following_url":"https://api.github.com/users/sblaisot/following{/other_user}","gists_url":"https://api.github.com/users/sblaisot/gists{/gist_id}","starred_url":"https://api.github.com/users/sblaisot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sblaisot/subscriptions","organizations_url":"https://api.github.com/users/sblaisot/orgs","repos_url":"https://api.github.com/users/sblaisot/repos","events_url":"https://api.github.com/users/sblaisot/events{/privacy}","received_events_url":"https://api.github.com/users/sblaisot/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-04T13:56:44Z","updated_at":"2021-10-04T13:56:44Z","author_association":"CONTRIBUTOR","body":"I also reproduce the problem on debian 10 buster with couchdb 3.1.2 debian package","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/933512138/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/934029882","html_url":"https://github.com/apache/couchdb/pull/3767#issuecomment-934029882","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3767","id":934029882,"node_id":"IC_kwDOAAMmUc43rCo6","user":{"login":"jiahuili430","id":54631519,"node_id":"MDQ6VXNlcjU0NjMxNTE5","avatar_url":"https://avatars.githubusercontent.com/u/54631519?v=4","gravatar_id":"","url":"https://api.github.com/users/jiahuili430","html_url":"https://github.com/jiahuili430","followers_url":"https://api.github.com/users/jiahuili430/followers","following_url":"https://api.github.com/users/jiahuili430/following{/other_user}","gists_url":"https://api.github.com/users/jiahuili430/gists{/gist_id}","starred_url":"https://api.github.com/users/jiahuili430/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jiahuili430/subscriptions","organizations_url":"https://api.github.com/users/jiahuili430/orgs","repos_url":"https://api.github.com/users/jiahuili430/repos","events_url":"https://api.github.com/users/jiahuili430/events{/privacy}","received_events_url":"https://api.github.com/users/jiahuili430/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-05T03:33:04Z","updated_at":"2021-10-05T03:33:04Z","author_association":"CONTRIBUTOR","body":"Since we have [chttpd_misc:get_features()](https://github.com/apache/couchdb/blob/3.x/src/chttpd/src/chttpd_misc.erl#L62-L68) to add `search` to the features list, so I will close this PR.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/934029882/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937839051","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-937839051","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":937839051,"node_id":"IC_kwDOAAMmUc435knL","user":{"login":"jcoglan","id":9265,"node_id":"MDQ6VXNlcjkyNjU=","avatar_url":"https://avatars.githubusercontent.com/u/9265?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoglan","html_url":"https://github.com/jcoglan","followers_url":"https://api.github.com/users/jcoglan/followers","following_url":"https://api.github.com/users/jcoglan/following{/other_user}","gists_url":"https://api.github.com/users/jcoglan/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoglan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoglan/subscriptions","organizations_url":"https://api.github.com/users/jcoglan/orgs","repos_url":"https://api.github.com/users/jcoglan/repos","events_url":"https://api.github.com/users/jcoglan/events{/privacy}","received_events_url":"https://api.github.com/users/jcoglan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-07T14:18:14Z","updated_at":"2021-10-07T14:18:14Z","author_association":"CONTRIBUTOR","body":"This is James from Neighbourhoodie; CozyCloud contacted us for assistance with this issue. So far I've confirmed I can repro this issue, on macOS 11.6 with CouchDB 3.1.1 and Erlang 24.\r\n\r\nWith the DB defaults (`n=1`, `q=2`) I get 1 row for each query. With `q=1` I get zero rows for the second query -- the one with key bytes `69 cc 82`, representing codepoints U+0069 U+0302.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937839051/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937846761","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-937846761","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":937846761,"node_id":"IC_kwDOAAMmUc435mfp","user":{"login":"jcoglan","id":9265,"node_id":"MDQ6VXNlcjkyNjU=","avatar_url":"https://avatars.githubusercontent.com/u/9265?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoglan","html_url":"https://github.com/jcoglan","followers_url":"https://api.github.com/users/jcoglan/followers","following_url":"https://api.github.com/users/jcoglan/following{/other_user}","gists_url":"https://api.github.com/users/jcoglan/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoglan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoglan/subscriptions","organizations_url":"https://api.github.com/users/jcoglan/orgs","repos_url":"https://api.github.com/users/jcoglan/repos","events_url":"https://api.github.com/users/jcoglan/events{/privacy}","received_events_url":"https://api.github.com/users/jcoglan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-07T14:26:52Z","updated_at":"2021-10-07T14:38:46Z","author_association":"CONTRIBUTOR","body":"It's also interesting that querying the view without `keys` lists two rows with `q=2`:\r\n\r\n```\r\nSee what is in the view\r\n00000000  7b 22 72 6f 77 73 22 3a  5b 0d 0a 7b 22 6b 65 79  |{\"rows\":[..{\"key|\r\n00000010  22 3a 5b 22 66 69 6c 65  22 2c 22 63 68 61 c3 ae  |\":[\"file\",\"cha..|\r\n00000020  6e 65 22 5d 2c 22 76 61  6c 75 65 22 3a 31 7d 2c  |ne\"],\"value\":1},|\r\n00000030  0d 0a 7b 22 6b 65 79 22  3a 5b 22 66 69 6c 65 22  |..{\"key\":[\"file\"|\r\n00000040  2c 22 63 68 61 69 cc 82  6e 65 22 5d 2c 22 76 61  |,\"chai..ne\"],\"va|\r\n00000050  6c 75 65 22 3a 31 7d 0d  0a 5d 7d 0a              |lue\":1}..]}.|\r\n0000005c\r\n```\r\n\r\n... but only a single row with `q=1`. The row returned has key bytes `c3 ae` representing codepoint U+00EE. Notes its `value` is `2` indicating there are actually two rows stored in the view, but their keys have been considered equal by the `_count` function.\r\n\r\n```\r\nSee what is in the view\r\n00000000  7b 22 72 6f 77 73 22 3a  5b 0d 0a 7b 22 6b 65 79  |{\"rows\":[..{\"key|\r\n00000010  22 3a 5b 22 66 69 6c 65  22 2c 22 63 68 61 c3 ae  |\":[\"file\",\"cha..|\r\n00000020  6e 65 22 5d 2c 22 76 61  6c 75 65 22 3a 32 7d 0d  |ne\"],\"value\":2}.|\r\n00000030  0a 5d 7d 0a                                       |.]}.|\r\n00000034\r\n```\r\n\r\nSo it does seem as though if these two rows are stored in the same shard, their keys are considered equal and they get merged, but not if they're (potentially) stored in different shards. I also tried running this example with the `reduce` and `group` operations removed just to see what rows we'd get. With `q=1` or `q=2` I get the same results; all queries return _two_ rows:\r\n\r\n```\r\nSee what is in the view\r\n00000000  7b 22 74 6f 74 61 6c 5f  72 6f 77 73 22 3a 32 2c  |{\"total_rows\":2,|\r\n00000010  22 6f 66 66 73 65 74 22  3a 30 2c 22 72 6f 77 73  |\"offset\":0,\"rows|\r\n00000020  22 3a 5b 0d 0a 7b 22 69  64 22 3a 22 64 6f 63 31  |\":[..{\"id\":\"doc1|\r\n00000030  22 2c 22 6b 65 79 22 3a  5b 22 66 69 6c 65 22 2c  |\",\"key\":[\"file\",|\r\n00000040  22 63 68 61 c3 ae 6e 65  22 5d 2c 22 76 61 6c 75  |\"cha..ne\"],\"valu|\r\n00000050  65 22 3a 6e 75 6c 6c 7d  2c 0d 0a 7b 22 69 64 22  |e\":null},..{\"id\"|\r\n00000060  3a 22 64 6f 63 32 22 2c  22 6b 65 79 22 3a 5b 22  |:\"doc2\",\"key\":[\"|\r\n00000070  66 69 6c 65 22 2c 22 63  68 61 69 cc 82 6e 65 22  |file\",\"chai..ne\"|\r\n00000080  5d 2c 22 76 61 6c 75 65  22 3a 6e 75 6c 6c 7d 0d  |],\"value\":null}.|\r\n00000090  0a 5d 7d 0a                                       |.]}.|\r\n00000094\r\nRequest the view, one time for each encoding\r\n00000000  7b 22 74 6f 74 61 6c 5f  72 6f 77 73 22 3a 32 2c  |{\"total_rows\":2,|\r\n00000010  22 6f 66 66 73 65 74 22  3a 30 2c 22 72 6f 77 73  |\"offset\":0,\"rows|\r\n00000020  22 3a 5b 0d 0a 7b 22 69  64 22 3a 22 64 6f 63 31  |\":[..{\"id\":\"doc1|\r\n00000030  22 2c 22 6b 65 79 22 3a  5b 22 66 69 6c 65 22 2c  |\",\"key\":[\"file\",|\r\n00000040  22 63 68 61 c3 ae 6e 65  22 5d 2c 22 76 61 6c 75  |\"cha..ne\"],\"valu|\r\n00000050  65 22 3a 6e 75 6c 6c 7d  2c 0d 0a 7b 22 69 64 22  |e\":null},..{\"id\"|\r\n00000060  3a 22 64 6f 63 32 22 2c  22 6b 65 79 22 3a 5b 22  |:\"doc2\",\"key\":[\"|\r\n00000070  66 69 6c 65 22 2c 22 63  68 61 69 cc 82 6e 65 22  |file\",\"chai..ne\"|\r\n00000080  5d 2c 22 76 61 6c 75 65  22 3a 6e 75 6c 6c 7d 0d  |],\"value\":null}.|\r\n00000090  0a 5d 7d 0a                                       |.]}.|\r\n00000094\r\n00000000  7b 22 74 6f 74 61 6c 5f  72 6f 77 73 22 3a 32 2c  |{\"total_rows\":2,|\r\n00000010  22 6f 66 66 73 65 74 22  3a 30 2c 22 72 6f 77 73  |\"offset\":0,\"rows|\r\n00000020  22 3a 5b 0d 0a 7b 22 69  64 22 3a 22 64 6f 63 31  |\":[..{\"id\":\"doc1|\r\n00000030  22 2c 22 6b 65 79 22 3a  5b 22 66 69 6c 65 22 2c  |\",\"key\":[\"file\",|\r\n00000040  22 63 68 61 c3 ae 6e 65  22 5d 2c 22 76 61 6c 75  |\"cha..ne\"],\"valu|\r\n00000050  65 22 3a 6e 75 6c 6c 7d  2c 0d 0a 7b 22 69 64 22  |e\":null},..{\"id\"|\r\n00000060  3a 22 64 6f 63 32 22 2c  22 6b 65 79 22 3a 5b 22  |:\"doc2\",\"key\":[\"|\r\n00000070  66 69 6c 65 22 2c 22 63  68 61 69 cc 82 6e 65 22  |file\",\"chai..ne\"|\r\n00000080  5d 2c 22 76 61 6c 75 65  22 3a 6e 75 6c 6c 7d 0d  |],\"value\":null}.|\r\n00000090  0a 5d 7d 0a                                       |.]}.|\r\n00000094\r\n```\r\n\r\nSomething curious is going on here: both documents are stored distinctly and produce two distinct view rows, the `keys` param matches both rows no matter which encoding is used, and when `q=1` the `reduce`/`group` operation with `_count` considers the rows' keys equal and merges them.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937846761/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937860800","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-937860800","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":937860800,"node_id":"IC_kwDOAAMmUc435p7A","user":{"login":"jcoglan","id":9265,"node_id":"MDQ6VXNlcjkyNjU=","avatar_url":"https://avatars.githubusercontent.com/u/9265?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoglan","html_url":"https://github.com/jcoglan","followers_url":"https://api.github.com/users/jcoglan/followers","following_url":"https://api.github.com/users/jcoglan/following{/other_user}","gists_url":"https://api.github.com/users/jcoglan/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoglan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoglan/subscriptions","organizations_url":"https://api.github.com/users/jcoglan/orgs","repos_url":"https://api.github.com/users/jcoglan/repos","events_url":"https://api.github.com/users/jcoglan/events{/privacy}","received_events_url":"https://api.github.com/users/jcoglan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-07T14:42:13Z","updated_at":"2021-10-07T14:42:13Z","author_association":"CONTRIBUTOR","body":"So, the problem is not happening when view rows are stored -- two rows are always present. The problem is that if the rows are in the same shard, then reductions over them might consider their keys equal. Wondering if this has anything to do with how intermediate reduction results are stored in view B-trees ([docs](https://docs.couchdb.org/en/stable/ddocs/views/intro.html))?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937860800/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937959517","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-937959517","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":937959517,"node_id":"IC_kwDOAAMmUc436CBd","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-07T16:28:42Z","updated_at":"2021-10-07T16:28:42Z","author_association":"CONTRIBUTOR","body":"Great analysis, @jcoglan\r\n\r\nI think you may be right that it has to do with how intermediate results are stored and how the unicode collator compares them. We had a recent fix that may be related https://github.com/apache/couchdb/commit/4f33f14deb733f36cf0df03aedceebc746716d8c, there we noticed that the collation rules on the shards are different than the collation rules used when aggregating rows in the coordinator (fabric). \r\n\r\nWonder which representation is the correct one - should these two rows be considered equal (does unicode collation consider them equivalent)? Or, is it correct that they would be emitted as separate rows. If first is correct, then it could be that the coordinator reduce step (in fabric) has a bug where it matches keys exactly instead of using unicode collation.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937959517/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937963554","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-937963554","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":937963554,"node_id":"IC_kwDOAAMmUc436DAi","user":{"login":"jcoglan","id":9265,"node_id":"MDQ6VXNlcjkyNjU=","avatar_url":"https://avatars.githubusercontent.com/u/9265?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoglan","html_url":"https://github.com/jcoglan","followers_url":"https://api.github.com/users/jcoglan/followers","following_url":"https://api.github.com/users/jcoglan/following{/other_user}","gists_url":"https://api.github.com/users/jcoglan/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoglan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoglan/subscriptions","organizations_url":"https://api.github.com/users/jcoglan/orgs","repos_url":"https://api.github.com/users/jcoglan/repos","events_url":"https://api.github.com/users/jcoglan/events{/privacy}","received_events_url":"https://api.github.com/users/jcoglan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-07T16:33:37Z","updated_at":"2021-10-07T16:33:37Z","author_association":"CONTRIBUTOR","body":"Collation would depend on your locale, in general. But normalisation would at least let you decide that `U+00EE` and `U+0069 U+0302` are the same thing and convert one to the other, producing identical byte sequences. If you're being consistent in comparison of either codepoints or bytes you should get consistent behaviour.\r\n\r\nAs @nono says there's no an obvious correct choice here, the problem is the _inconsistent_ behaviour depending on `q`, indicating different bits of CouchDB disagree about how to compare strings.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937963554/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937965583","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-937965583","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":937965583,"node_id":"IC_kwDOAAMmUc436DgP","user":{"login":"jcoglan","id":9265,"node_id":"MDQ6VXNlcjkyNjU=","avatar_url":"https://avatars.githubusercontent.com/u/9265?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoglan","html_url":"https://github.com/jcoglan","followers_url":"https://api.github.com/users/jcoglan/followers","following_url":"https://api.github.com/users/jcoglan/following{/other_user}","gists_url":"https://api.github.com/users/jcoglan/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoglan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoglan/subscriptions","organizations_url":"https://api.github.com/users/jcoglan/orgs","repos_url":"https://api.github.com/users/jcoglan/repos","events_url":"https://api.github.com/users/jcoglan/events{/privacy}","received_events_url":"https://api.github.com/users/jcoglan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-07T16:36:20Z","updated_at":"2021-10-07T16:36:20Z","author_association":"CONTRIBUTOR","body":"I did wonder if this would have anything to do with those strings being round-tripped through JS, but that ought to preserve the codepoints that are present even if JS uses a different internal byte encoding (the bytes in examples here are UTF-8). As an aside, I made some [notes](https://gist.github.com/jcoglan/c1ba332ecfe53866ffb077728eb30615) about string encoding/comparison when I first picked up CouchDB as I was curious about whether JS would affect how strings get sorted.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/937965583/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/939089720","html_url":"https://github.com/apache/couchdb/pull/3780#issuecomment-939089720","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3780","id":939089720,"node_id":"IC_kwDOAAMmUc43-V84","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-08T20:10:52Z","updated_at":"2021-10-08T20:10:52Z","author_association":"CONTRIBUTOR","body":"@jaydoane good catch, Thanks!\r\n\r\nFixed the commit message and the PR comment.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/939089720/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/939090703","html_url":"https://github.com/apache/couchdb/pull/3780#issuecomment-939090703","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3780","id":939090703,"node_id":"IC_kwDOAAMmUc43-WMP","user":{"login":"tonysun83","id":6991573,"node_id":"MDQ6VXNlcjY5OTE1NzM=","avatar_url":"https://avatars.githubusercontent.com/u/6991573?v=4","gravatar_id":"","url":"https://api.github.com/users/tonysun83","html_url":"https://github.com/tonysun83","followers_url":"https://api.github.com/users/tonysun83/followers","following_url":"https://api.github.com/users/tonysun83/following{/other_user}","gists_url":"https://api.github.com/users/tonysun83/gists{/gist_id}","starred_url":"https://api.github.com/users/tonysun83/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tonysun83/subscriptions","organizations_url":"https://api.github.com/users/tonysun83/orgs","repos_url":"https://api.github.com/users/tonysun83/repos","events_url":"https://api.github.com/users/tonysun83/events{/privacy}","received_events_url":"https://api.github.com/users/tonysun83/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-08T20:12:48Z","updated_at":"2021-10-08T20:12:48Z","author_association":"CONTRIBUTOR","body":"+1","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/939090703/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/939114457","html_url":"https://github.com/apache/couchdb/pull/3746#issuecomment-939114457","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3746","id":939114457,"node_id":"IC_kwDOAAMmUc43-b_Z","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-08T21:03:43Z","updated_at":"2021-10-08T21:45:01Z","author_association":"CONTRIBUTOR","body":"3.2 has been tagged,  I think we can take another look at the PR.\r\n\r\nHopefully the property tests would give us some more confidence about it","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/939114457/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/939180747","html_url":"https://github.com/apache/couchdb/issues/3477#issuecomment-939180747","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3477","id":939180747,"node_id":"IC_kwDOAAMmUc43-sLL","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-08T23:43:36Z","updated_at":"2021-10-08T23:43:36Z","author_association":"MEMBER","body":"3.2.0 has been released on bullseye. Because of dependencies, we are unable to release any older versions on bullseye at this time.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/939180747/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/940091733","html_url":"https://github.com/apache/couchdb/issues/1077#issuecomment-940091733","issue_url":"https://api.github.com/repos/apache/couchdb/issues/1077","id":940091733,"node_id":"IC_kwDOAAMmUc44CKlV","user":{"login":"PulsarFX","id":4960210,"node_id":"MDQ6VXNlcjQ5NjAyMTA=","avatar_url":"https://avatars.githubusercontent.com/u/4960210?v=4","gravatar_id":"","url":"https://api.github.com/users/PulsarFX","html_url":"https://github.com/PulsarFX","followers_url":"https://api.github.com/users/PulsarFX/followers","following_url":"https://api.github.com/users/PulsarFX/following{/other_user}","gists_url":"https://api.github.com/users/PulsarFX/gists{/gist_id}","starred_url":"https://api.github.com/users/PulsarFX/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PulsarFX/subscriptions","organizations_url":"https://api.github.com/users/PulsarFX/orgs","repos_url":"https://api.github.com/users/PulsarFX/repos","events_url":"https://api.github.com/users/PulsarFX/events{/privacy}","received_events_url":"https://api.github.com/users/PulsarFX/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-11T14:39:25Z","updated_at":"2021-10-11T14:39:25Z","author_association":"NONE","body":"Is there a way to do this in the meantime? I don't want to have my users use the server admin account to see the databases they might be allowed to use. This makes the whole security thingi useless.\r\nAs far as I can see, an application needs to use the server admin credentials, to get the list of all databases and filter them in business code?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/940091733/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/940674564","html_url":"https://github.com/apache/couchdb/pull/3782#issuecomment-940674564","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3782","id":940674564,"node_id":"IC_kwDOAAMmUc44EY4E","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-12T05:22:53Z","updated_at":"2021-10-12T05:22:53Z","author_association":"CONTRIBUTOR","body":"@nickva I was seeing some test failures due to this error:\r\n```\r\n  *** context setup failed ***\r\n**in function couch_replicator_doc_processor:setup/0 (src/couch_replicator_doc_processor.erl, line 872)\r\n**error:{badmatch,{error,{already_started,<0.4946.0>}}}\r\n```\r\nso I pushed another commit to address that issue.\r\n\r\nSeems like it did the trick, but would appreciate a quick sanity check that it is a good solution for the problem.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/940674564/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/941091086","html_url":"https://github.com/apache/couchdb/pull/3782#issuecomment-941091086","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3782","id":941091086,"node_id":"IC_kwDOAAMmUc44F-kO","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-12T14:56:14Z","updated_at":"2021-10-12T14:56:14Z","author_association":"CONTRIBUTOR","body":"@jaydoane good find, that flaky test has been plaguing us for a quite a while\r\n\r\nGood idea to use stop_sync, @iilyak","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/941091086/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/941963658","html_url":"https://github.com/apache/couchdb/issues/3773#issuecomment-941963658","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3773","id":941963658,"node_id":"IC_kwDOAAMmUc44JTmK","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-13T06:26:37Z","updated_at":"2021-10-13T15:11:16Z","author_association":"CONTRIBUTOR","body":"I think the issue is in the logic where we [match reduce rows by keys](https://github.com/apache/couchdb/blob/3.x/src/fabric/src/fabric_view.erl#L245). In case when there are keys which are effectively equivalent under unicode collation rules, the worker might return the 69cc82 row with value 2 already reduced but if the requested key is c3ae then it won't be found and we'd get 0 rows in the result. Instead, we would like it to compare the rows in the row dict not by exact matching, but using the same collation algorithm as the one used when building the view.\r\n\r\nI made an attempt here https://github.com/apache/couchdb/pull/3783\r\n\r\nWith that PR and my altered reproducer [script](https://gist.github.com/nickva/e351e678fc10d3b5424de44be992703c) I get:\r\n\r\n```\r\n--- c h a i n e ---\r\n{\"rows\":[\r\n{\"key\":[\"file\",\"cha√Æne\"],\"value\":2}\r\n]}\r\n\r\n--- c h a i ^ n e ---\r\n{\"rows\":[\r\n{\"key\":[\"file\",\"chaiÃÇne\"],\"value\":2}\r\n]}\r\n```\r\n\r\nFor both q=1 and q=2 cases ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/941963658/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/942391560","html_url":"https://github.com/apache/couchdb/issues/3784#issuecomment-942391560","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3784","id":942391560,"node_id":"IC_kwDOAAMmUc44K8EI","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-13T14:57:46Z","updated_at":"2021-10-13T14:57:46Z","author_association":"CONTRIBUTOR","body":"Based on the `{case_clause,{error,eacces}},[{config,parse_ini_file,1` message it looks like it can't read one of the config .ini files. Double-check that the config files are readable by the `couchdb.service`. Check permissions, make sure all expected file systems are mounted, things like that","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/942391560/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/942409112","html_url":"https://github.com/apache/couchdb/issues/3784#issuecomment-942409112","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3784","id":942409112,"node_id":"IC_kwDOAAMmUc44LAWY","user":{"login":"Nulos","id":32259104,"node_id":"MDQ6VXNlcjMyMjU5MTA0","avatar_url":"https://avatars.githubusercontent.com/u/32259104?v=4","gravatar_id":"","url":"https://api.github.com/users/Nulos","html_url":"https://github.com/Nulos","followers_url":"https://api.github.com/users/Nulos/followers","following_url":"https://api.github.com/users/Nulos/following{/other_user}","gists_url":"https://api.github.com/users/Nulos/gists{/gist_id}","starred_url":"https://api.github.com/users/Nulos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Nulos/subscriptions","organizations_url":"https://api.github.com/users/Nulos/orgs","repos_url":"https://api.github.com/users/Nulos/repos","events_url":"https://api.github.com/users/Nulos/events{/privacy}","received_events_url":"https://api.github.com/users/Nulos/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-13T15:16:14Z","updated_at":"2021-10-13T15:16:14Z","author_association":"NONE","body":"Great! It works ! Thank you so much. I did a chown -R couchd:couchd /opt/couchdb/etc /","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/942409112/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/942412302","html_url":"https://github.com/apache/couchdb/issues/3784#issuecomment-942412302","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3784","id":942412302,"node_id":"IC_kwDOAAMmUc44LBIO","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-13T15:19:27Z","updated_at":"2021-10-13T15:19:27Z","author_association":"CONTRIBUTOR","body":"Thanks for reaching out. Closing the issue","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/942412302/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943331136","html_url":"https://github.com/apache/couchdb/issues/3308#issuecomment-943331136","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3308","id":943331136,"node_id":"IC_kwDOAAMmUc44OhdA","user":{"login":"anuragvohraec","id":53807480,"node_id":"MDQ6VXNlcjUzODA3NDgw","avatar_url":"https://avatars.githubusercontent.com/u/53807480?v=4","gravatar_id":"","url":"https://api.github.com/users/anuragvohraec","html_url":"https://github.com/anuragvohraec","followers_url":"https://api.github.com/users/anuragvohraec/followers","following_url":"https://api.github.com/users/anuragvohraec/following{/other_user}","gists_url":"https://api.github.com/users/anuragvohraec/gists{/gist_id}","starred_url":"https://api.github.com/users/anuragvohraec/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anuragvohraec/subscriptions","organizations_url":"https://api.github.com/users/anuragvohraec/orgs","repos_url":"https://api.github.com/users/anuragvohraec/repos","events_url":"https://api.github.com/users/anuragvohraec/events{/privacy}","received_events_url":"https://api.github.com/users/anuragvohraec/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-14T12:58:32Z","updated_at":"2021-10-14T12:58:32Z","author_association":"NONE","body":"> Exactly! That's how connection sharing works. After the TCP connection is established to a host, port, SSL session is setup, it can be reused for multiple requests:\r\n> The time to connect and do the SSL handshake can be expensive, so instead of tearing down the connection and making a new one every time, it can be re-used. Some client libraries can do this too, for example with requests is may look like: https://docs.python-requests.org/en/master/user/advanced/\r\n\r\nAfter reading your comments, I have been overthinking on this and come to a concluson that REST based API is over all bad. A web socket based API layer would have been way faster and efficient in handling DB connections. So may be couchdb 5.0 can be build on top of websockets. This way a data can be updated to ever listner in nearly real time [RethinkDB](https://rethinkdb.com/) is an example to this.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943331136/reactions","total_count":1,"+1":0,"-1":1,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943481479","html_url":"https://github.com/apache/couchdb/issues/3786#issuecomment-943481479","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3786","id":943481479,"node_id":"IC_kwDOAAMmUc44PGKH","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-14T15:42:50Z","updated_at":"2021-10-14T15:42:50Z","author_association":"CONTRIBUTOR","body":"@nickva bisected commit history and [located the commit where this fault was introduced](https://github.com/apache/couchdb/commit/8ac1978d78af2fc288bed1a99c092c44632ac35a). Further analysis revealed that by [changing the code to use the actual shards db](https://github.com/apache/couchdb/commit/8ac1978d78af2fc288bed1a99c092c44632ac35a), it caused custodian's design doc to be injected into that db:\r\n```\r\nhttp $DB/_node/_local/_dbs/_all_docs\r\nHTTP/1.1 200 OK\r\nCache-Control: must-revalidate\r\nContent-Type: application/json\r\nDate: Wed, 13 Oct 2021 18:07:26 GMT\r\nServer: CouchDB/3.1.1-8ac1978 (Erlang OTP/20)\r\nTransfer-Encoding: chunked\r\nX-Couch-Request-ID: be32a659e4\r\nX-CouchDB-Body-Time: 0\r\n{\r\n    \"offset\": 0,\r\n    \"rows\": [\r\n        {\r\n            \"id\": \"_design/custodian\",\r\n            \"key\": \"_design/custodian\",\r\n            \"value\": {\r\n                \"rev\": \"1-51e56733e48a1b629dbc15e2c2ed6d7d\"\r\n            }\r\n        },\r\n        {\r\n            \"id\": \"_replicator\",\r\n            \"key\": \"_replicator\",\r\n            \"value\": {\r\n                \"rev\": \"1-d52224ea9c7c3bba18d02e9a0c2c4410\"\r\n            }\r\n        },\r\n        {\r\n            \"id\": \"_users\",\r\n            \"key\": \"_users\",\r\n            \"value\": {\r\n                \"rev\": \"1-48f825a6cc14fd694c3db04794d69a5b\"\r\n            }\r\n        }\r\n    ],\r\n    \"total_rows\": 3\r\n}\r\n```\r\nEvidently `_design/custodian` is (correctly) filtered out of the `_all_dbs` result, but _after_ the limit is applied, which essentially results in an off-by-one result now for `_all_dbs` with limit applied, e.g.\r\n```\r\n$ curl -s -u adm:pass localhost:15984/_all_dbs | jq .\r\n[\r\n  \"_replicator\",\r\n  \"_users\"\r\n]\r\n\r\n$ curl -s -u adm:pass localhost:15984/_all_dbs?limit=1 | jq .\r\n[]\r\n\r\n$ curl -s -u adm:pass localhost:15984/_all_dbs?limit=2 | jq .\r\n[\r\n  \"_replicator\"\r\n]\r\n```\r\nI haven't looked at the code yet, but perhaps the limit could be applied _after_ the ddoc has been filtered out?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943481479/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943543453","html_url":"https://github.com/apache/couchdb/issues/3786#issuecomment-943543453","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3786","id":943543453,"node_id":"IC_kwDOAAMmUc44PVSd","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-14T16:57:00Z","updated_at":"2021-10-14T16:57:00Z","author_association":"CONTRIBUTOR","body":"An alternative could be to move to not use a VDU and instead rely on a before_doc_update/3 validation function since this is a system DB.\r\n\r\nWe did a similar thing for _replicator auto-injected VDU in `main` branch with the idea of eventually porting to 3.x as well. Then, if we had that we can auto-remove the injected design doc.\r\n\r\nAdditionally, the VDU / validation probably shouldn't happen in custodian but rather in the mem3 module, so we should move the logic there if we plan on keeping it for the future.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943543453/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943644770","html_url":"https://github.com/apache/couchdb/issues/3786#issuecomment-943644770","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3786","id":943644770,"node_id":"IC_kwDOAAMmUc44PuBi","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-14T19:08:53Z","updated_at":"2021-10-14T19:08:53Z","author_association":"CONTRIBUTOR","body":"Using a `before_doc_update/3` validation function and avoiding JS makes sense, especially for the shards db.\r\n\r\n> We did a similar thing for _replicator auto-injected VDU in main branch with the idea of eventually porting to 3.x as well\r\n\r\nIs [this](https://github.com/apache/couchdb/blob/15cbb5502503c6e4d786bf0a85b7c225ccd14f71/src/couch_replicator/src/couch_replicator_docs.erl#L89-L135) to what you are referring?\r\n\r\nAlso agree that `mem3` is a better location for the VDU, if it were to stay. ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943644770/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943653798","html_url":"https://github.com/apache/couchdb/issues/3786#issuecomment-943653798","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3786","id":943653798,"node_id":"IC_kwDOAAMmUc44PwOm","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-14T19:20:04Z","updated_at":"2021-10-14T20:24:38Z","author_association":"CONTRIBUTOR","body":"Yeah that's the before_doc_update/3 handler I was referring to. That callback works, I believe, on system databases in a fairly straightforward [manner](https://github.com/apache/couchdb/blob/029612b27c78405790fd550958028cec5c84e9c8/src/couch/src/couch_server.erl#L182-L205) and if we translate the doc body to a map before passing it to the validator, we can do succinct pattern matching that might look more elegant than the JS version.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943653798/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943746910","html_url":"https://github.com/apache/couchdb/pull/3746#issuecomment-943746910","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3746","id":943746910,"node_id":"IC_kwDOAAMmUc44QG9e","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-14T21:26:12Z","updated_at":"2021-10-14T21:26:12Z","author_association":"MEMBER","body":"I reviewed the code and ran the tests. It seems correct, but is surprisingly subtle! It would take quite a while to figure out without the guidance from the PR description.\r\n\r\nWould it make sense to expose the `compare_strings` function more directly to Erlang instead of calling `less_nif` every time? It would save on some extra allocations and redundant type checks when we already know we are dealing with two binary strings, and it would also make the max depth check / infinite recursion issue a bit easier to reason about.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943746910/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943765471","html_url":"https://github.com/apache/couchdb/pull/3746#issuecomment-943765471","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3746","id":943765471,"node_id":"IC_kwDOAAMmUc44QLff","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-14T21:54:56Z","updated_at":"2021-10-14T21:54:56Z","author_association":"CONTRIBUTOR","body":"Thanks for taking a look.\r\n\r\nGood idea to add a `compare_strings` function, I will do that.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/943765471/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944059583","html_url":"https://github.com/apache/couchdb/issues/3788#issuecomment-944059583","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3788","id":944059583,"node_id":"IC_kwDOAAMmUc44RTS_","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T07:18:46Z","updated_at":"2021-10-15T07:20:21Z","author_association":"CONTRIBUTOR","body":"This may be related to another issue created today https://github.com/apache/couchdb/issues/3787\r\n\r\nNoticed that the some of the decoded changes sequence shards lack the node uuids. That's the `700a83e` bit from the `{59800975,<<\"700a83e\">>, 'couchdb@...}` tuple. That uuid is used for checking internal replication checkpoints [1] or avoid rewinds when shards are moved between nodes. Yours is the first case where a node is replaced with another node, and the 3787 was generated from the rewinds observed after moving shards to new nodes.\r\n\r\nThe lack of uuids in the sequences seems to be a common motif in both issues, so perhaps if that's solved it would solve both of those issues.\r\n\r\n[1] https://github.com/apache/couchdb/blob/3.x/src/fabric/src/fabric_rpc.erl#L631-L638\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944059583/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944069723","html_url":"https://github.com/apache/couchdb/issues/3788#issuecomment-944069723","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3788","id":944069723,"node_id":"IC_kwDOAAMmUc44RVxb","user":{"login":"j3k0","id":191881,"node_id":"MDQ6VXNlcjE5MTg4MQ==","avatar_url":"https://avatars.githubusercontent.com/u/191881?v=4","gravatar_id":"","url":"https://api.github.com/users/j3k0","html_url":"https://github.com/j3k0","followers_url":"https://api.github.com/users/j3k0/followers","following_url":"https://api.github.com/users/j3k0/following{/other_user}","gists_url":"https://api.github.com/users/j3k0/gists{/gist_id}","starred_url":"https://api.github.com/users/j3k0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/j3k0/subscriptions","organizations_url":"https://api.github.com/users/j3k0/orgs","repos_url":"https://api.github.com/users/j3k0/repos","events_url":"https://api.github.com/users/j3k0/events{/privacy}","received_events_url":"https://api.github.com/users/j3k0/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T07:37:36Z","updated_at":"2021-10-15T07:37:36Z","author_association":"NONE","body":"Would it be possible to generate a sequence id manually that includes the node's `uuid`? I can confirm if this would solve the issue.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944069723/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944072258","html_url":"https://github.com/apache/couchdb/issues/3788#issuecomment-944072258","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3788","id":944072258,"node_id":"IC_kwDOAAMmUc44RWZC","user":{"login":"j3k0","id":191881,"node_id":"MDQ6VXNlcjE5MTg4MQ==","avatar_url":"https://avatars.githubusercontent.com/u/191881?v=4","gravatar_id":"","url":"https://api.github.com/users/j3k0","html_url":"https://github.com/j3k0","followers_url":"https://api.github.com/users/j3k0/followers","following_url":"https://api.github.com/users/j3k0/following{/other_user}","gists_url":"https://api.github.com/users/j3k0/gists{/gist_id}","starred_url":"https://api.github.com/users/j3k0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/j3k0/subscriptions","organizations_url":"https://api.github.com/users/j3k0/orgs","repos_url":"https://api.github.com/users/j3k0/repos","events_url":"https://api.github.com/users/j3k0/events{/privacy}","received_events_url":"https://api.github.com/users/j3k0/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T07:41:56Z","updated_at":"2021-10-15T07:42:07Z","author_association":"NONE","body":"Also, I noticed in the rewound sequence number [1] that the included `uuid` is `{2,<<\"5d30401\">>, 'couchdb@couchdb3-2.private.dexez.fovea.cc'}` &rArr; it references a node (`couchdb3-2`) that isn't part of the cluster anymore.\r\n\r\n[1]\r\n```erl\r\n[{'couchdb@couchdb3-5.private.dexez.fovea.cc',[0,1431655764], 0},\r\n {'couchdb@couchdb3-5.private.dexez.fovea.cc',[1431655765, 2863311529], {2,<<\"5d30401\">>, 'couchdb@couchdb3-2.private.dexez.fovea.cc'}},\r\n {'couchdb@couchdb3-5.private.dexez.fovea.cc',[2863311530, 4294967295], 0}]\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944072258/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944115277","html_url":"https://github.com/apache/couchdb/issues/3788#issuecomment-944115277","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3788","id":944115277,"node_id":"IC_kwDOAAMmUc44Rg5N","user":{"login":"j3k0","id":191881,"node_id":"MDQ6VXNlcjE5MTg4MQ==","avatar_url":"https://avatars.githubusercontent.com/u/191881?v=4","gravatar_id":"","url":"https://api.github.com/users/j3k0","html_url":"https://github.com/j3k0","followers_url":"https://api.github.com/users/j3k0/followers","following_url":"https://api.github.com/users/j3k0/following{/other_user}","gists_url":"https://api.github.com/users/j3k0/gists{/gist_id}","starred_url":"https://api.github.com/users/j3k0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/j3k0/subscriptions","organizations_url":"https://api.github.com/users/j3k0/orgs","repos_url":"https://api.github.com/users/j3k0/repos","events_url":"https://api.github.com/users/j3k0/events{/privacy}","received_events_url":"https://api.github.com/users/j3k0/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T08:44:53Z","updated_at":"2021-10-15T08:44:53Z","author_association":"NONE","body":"@nickva It doesn't seems like the `uuid` change would solve the issue. Using `since=now` I got a sequence number that contains `uuids`.\r\n\r\n```erl\r\nbinary_to_term(couch_util:decodeBase64Url(\"g1AAAAGAeJzLYWBgYM5gTmHQTM4vTc5ISXKA0sa6JnoFRZlliSWpeimpFalVemn5ZamJesnJOUAtTIkMSaGhoSFZGcxJzHP4RXKBYuzmRkYmickmpJhFhs0ge0PzWBhWrlq1CmK9xF-w9ZapSckW5rS2Hmgz0OJVQOo_EEAc4JgOdoCFkWWimaUFKUZmAQAG1n5q\")).\r\n[{'couchdb@couchdb3-4.private.dexez.fovea.cc',[0,1431655764],\r\n                                              {60559124,<<\"7224ac4\">>,\r\n                                               'couchdb@couchdb3-4.private.dexez.fovea.cc'}},\r\n {'couchdb@couchdb3-4.private.dexez.fovea.cc',[1431655765,\r\n                                               2863311529],\r\n                                              {60561661,<<\"9ebc874\">>,\r\n                                               'couchdb@couchdb3-4.private.dexez.fovea.cc'}},\r\n {'couchdb@couchdb3-4.private.dexez.fovea.cc',[2863311530,\r\n                                               4294967295],\r\n                                              {60572007,<<\"829a698\">>,\r\n                                               'couchdb@couchdb3-4.private.dexez.fovea.cc'}}]\r\n```\r\n\r\nUsing this sequence number in `since`, I experience the same issue. The `couchb3-4` host needs to be up, or there is a rewind.\r\n\r\nI noticed another thing: if the node is in `maintenance_mode=\"true\"`, there is no rewind. It only happens if the node is down.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944115277/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944175642","html_url":"https://github.com/apache/couchdb/issues/3789#issuecomment-944175642","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3789","id":944175642,"node_id":"IC_kwDOAAMmUc44Rvoa","user":{"login":"arnesten","id":571223,"node_id":"MDQ6VXNlcjU3MTIyMw==","avatar_url":"https://avatars.githubusercontent.com/u/571223?v=4","gravatar_id":"","url":"https://api.github.com/users/arnesten","html_url":"https://github.com/arnesten","followers_url":"https://api.github.com/users/arnesten/followers","following_url":"https://api.github.com/users/arnesten/following{/other_user}","gists_url":"https://api.github.com/users/arnesten/gists{/gist_id}","starred_url":"https://api.github.com/users/arnesten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arnesten/subscriptions","organizations_url":"https://api.github.com/users/arnesten/orgs","repos_url":"https://api.github.com/users/arnesten/repos","events_url":"https://api.github.com/users/arnesten/events{/privacy}","received_events_url":"https://api.github.com/users/arnesten/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T10:19:08Z","updated_at":"2021-10-15T10:19:08Z","author_association":"NONE","body":"If I remove the following section from `local.ini` it seems to be working in CouchDB 3.2.0:\r\n```\r\n[fabric]\r\nrequest_timeout = infinity\r\n```\r\n\r\nIs \"infinity\" no longer a supported value for this setting?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944175642/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944295777","html_url":"https://github.com/apache/couchdb/issues/3788#issuecomment-944295777","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3788","id":944295777,"node_id":"IC_kwDOAAMmUc44SM9h","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T13:19:28Z","updated_at":"2021-10-15T13:19:28Z","author_association":"MEMBER","body":"> Also, I noticed in the rewound sequence number [1] that the included `uuid` is `{2,<<\"5d30401\">>, 'couchdb@couchdb3-2.private.dexez.fovea.cc'}` ‚áí it references a node (`couchdb3-2`) that isn't part of the cluster anymore.\r\n> \r\n> [1]\r\n> \r\n> ```erlang\r\n> [{'couchdb@couchdb3-5.private.dexez.fovea.cc',[0,1431655764], 0},\r\n>  {'couchdb@couchdb3-5.private.dexez.fovea.cc',[1431655765, 2863311529], {2,<<\"5d30401\">>, 'couchdb@couchdb3-2.private.dexez.fovea.cc'}},\r\n>  {'couchdb@couchdb3-5.private.dexez.fovea.cc',[2863311530, 4294967295], 0}]\r\n> ```\r\n\r\nIt turns out we need to track the identity of the node that originally committed sequence `2` for the shard with UUID `\"5d30401\"` in addition to the node that currently hosts the shard. That's why you see two different node IDs in this element of the list; `couchdb3-2` is what we call the `EpochNode` for this sequence in the codebase.\r\n\r\nThanks for this detailed report! I figured Nick had tracked it down with the lack of UUIDs in the initial sequence but I guess not. The plot thickens ...","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944295777/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944302231","html_url":"https://github.com/apache/couchdb/issues/3787#issuecomment-944302231","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3787","id":944302231,"node_id":"IC_kwDOAAMmUc44SOiX","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T13:28:01Z","updated_at":"2021-10-19T16:48:44Z","author_association":"CONTRIBUTOR","body":"Adam in the #couchdb-dev channel identified the reason for this behavior - we generate the `since=now&limit=0` sequence from the dbs_info response only which does not pack the uuids in the sequence: https://github.com/apache/couchdb/blob/3.x/src/fabric/src/fabric_db_info.erl#L78-L89","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944302231/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944303596","html_url":"https://github.com/apache/couchdb/pull/3746#issuecomment-944303596","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3746","id":944303596,"node_id":"IC_kwDOAAMmUc44SO3s","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T13:30:00Z","updated_at":"2021-10-15T13:30:00Z","author_association":"CONTRIBUTOR","body":"Added the `compare_strings` function. The code looks better without the confusing recursive `less_erl` back to `less_nif` jump.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944303596/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944309414","html_url":"https://github.com/apache/couchdb/issues/3788#issuecomment-944309414","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3788","id":944309414,"node_id":"IC_kwDOAAMmUc44SQSm","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T13:38:07Z","updated_at":"2021-10-15T13:38:07Z","author_association":"MEMBER","body":" @j3k0 are you logging `warn` level messages? If so, do the logs contain anything matching `couch_db.*start_seq`? There's some useful debugging output emitted here: https://github.com/apache/couchdb/blob/3.1.1/src/couch/src/couch_db.erl#L1495-L1528","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944309414/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944317391","html_url":"https://github.com/apache/couchdb/issues/3789#issuecomment-944317391","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3789","id":944317391,"node_id":"IC_kwDOAAMmUc44SSPP","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T13:49:14Z","updated_at":"2021-10-15T13:49:32Z","author_association":"CONTRIBUTOR","body":"Thanks for the report, @arnesten\r\n\r\nIt is indeed a bug. The request_timeout value from fabric in 3.2.0 is used in an arithmetic expression, while previously in 3.1.1 it was just passed to Erlang VM's `receive ... after Timeout -> ...` expression. The `receive` statement can handle the `infinity` atom while the arithmetic expression cannot and crashes.\r\n\r\nIt seems the infinity value was undocumented, but again so was is whole `[fabric]` config section. While we fix this, setting a large numeric value, or accepting the default (60000) can be workaround. Thanks again for debugging the issue and providing a stacktrace that pointed to the cause right away.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944317391/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944368213","html_url":"https://github.com/apache/couchdb/issues/3788#issuecomment-944368213","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3788","id":944368213,"node_id":"IC_kwDOAAMmUc44SepV","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T14:56:48Z","updated_at":"2021-10-15T14:56:48Z","author_association":"MEMBER","body":"I have a hypothesis on this one. @j3k0 your observation that the rewind does not happen with a node in maintenance mode is key.\r\n\r\nWhen a node is in maintenance mode we still submit a request to that node, and then we catch the `maintenance_mode` error message and replace the worker with another one that is responsible for the same shard range. When that replacement happens we minimize rewinds correctly through analyzing internal replication checkpoints. In contrast, if the node has disconnected from the cluster entirely, we don't initiate a worker at all, but instead proactively replace it. That replacement looks like it is [starting from zero](https://github.com/apache/couchdb/blob/3.1.1/src/fabric/src/fabric_view_changes.erl#L146-L150). The probable fix there is to invoke `make_replacement_arg` to inject a `{replace, EpochNode, Uuid, Seq}` tuple for the typical case when we have that information.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944368213/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944384386","html_url":"https://github.com/apache/couchdb/issues/3788#issuecomment-944384386","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3788","id":944384386,"node_id":"IC_kwDOAAMmUc44SimC","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T15:16:29Z","updated_at":"2021-10-15T15:18:31Z","author_association":"CONTRIBUTOR","body":"Agree with @kocolosk's finding! That explains the rewind in this case. We'd have to couple that with the fix to always include the uuids in the generated sequences as outlined in https://github.com/apache/couchdb/issues/3787","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944384386/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944572965","html_url":"https://github.com/apache/couchdb/issues/3789#issuecomment-944572965","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3789","id":944572965,"node_id":"IC_kwDOAAMmUc44TQol","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-15T19:09:15Z","updated_at":"2021-10-15T19:09:15Z","author_association":"CONTRIBUTOR","body":"The fix for this was merged in 3.x https://github.com/apache/couchdb/pull/3790","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/944572965/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/945361467","html_url":"https://github.com/apache/couchdb/pull/3792#issuecomment-945361467","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3792","id":945361467,"node_id":"IC_kwDOAAMmUc44WRI7","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-18T04:46:31Z","updated_at":"2021-10-18T04:46:31Z","author_association":"CONTRIBUTOR","body":"Tested with a q=2&n=2 db\r\n\r\n```\r\nhttp get $DB/db1/_shards\r\n{\r\n    \"shards\": {\r\n        \"00000000-7fffffff\": [\"node3@127.0.0.1\",\"node2@127.0.0.1\",\"node1@127.0.0.1\"],\r\n        \"80000000-ffffffff\": [\"node3@127.0.0.1\",\"node2@127.0.0.1\",\"node1@127.0.0.1\"]\r\n    }\r\n}\r\n```\r\n\r\nInserted a few docs and got a sequence: \r\n```\r\n17-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV2MDQy1zMAQsMckEQiQ1L9____szKYE7lzgQLsloZGSZbJxpjK4UYYohmRxwIkGRqA1H-oSWxgk5LSkkzTLJIwdWUBAFd3JLs\r\n```\r\n\r\nDecodes as:\r\n```\r\nDecode(\"g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV2MDQy1zMAQsMckEQiQ1L9____szKYE7lzgQLsloZGSZbJxpjK4UYYohmRxwIkGRqA1H-oSWxgk5LSkkzTLJIwdWUBAFd3JLs\").\r\n[\r\n {'node3@127.0.0.1',[0,2147483647],          {11,<<\"912b9c3\">>,'node3@127.0.0.1'}},\r\n {'node1@127.0.0.1',[2147483648,4294967295], {6,<<\"bfb5f8b\">>,'node1@127.0.0.1'}}\r\n]\r\n```\r\n\r\nKilling node3 and getting since with the sequence yields 0 pending as expected\r\n\r\n```\r\nhttp get $DB/db1/_changes'?since=17-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV2MDQy1zMAQsMckEQiQ1L9____szKYE7lzgQLsloZGSZbJxpjK4UYYohmRxwIkGRqA1H-oSWxgk5LSkkzTLJIwdWUBAFd3JLs&limit=1'\r\n\r\n{\r\n    \"last_seq\": \"17-g1AAAACTeJzLYWBgYMpgTmHgz8tPSTV0MDQy1zMAQsMckEQiQ1L9____szKYE7lzgQLsZhZmlsaWiZjKcRqRxwIkGRqA1H-oSWxgk5LSkkzTLJIwdWUBAEhXJJQ\",\r\n    \"pending\": 0,\r\n    \"results\": []\r\n}\r\n```\r\n\r\nA very nice find and fix","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/945361467/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/945396072","html_url":"https://github.com/apache/couchdb/issues/3789#issuecomment-945396072","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3789","id":945396072,"node_id":"IC_kwDOAAMmUc44WZlo","user":{"login":"arnesten","id":571223,"node_id":"MDQ6VXNlcjU3MTIyMw==","avatar_url":"https://avatars.githubusercontent.com/u/571223?v=4","gravatar_id":"","url":"https://api.github.com/users/arnesten","html_url":"https://github.com/arnesten","followers_url":"https://api.github.com/users/arnesten/followers","following_url":"https://api.github.com/users/arnesten/following{/other_user}","gists_url":"https://api.github.com/users/arnesten/gists{/gist_id}","starred_url":"https://api.github.com/users/arnesten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arnesten/subscriptions","organizations_url":"https://api.github.com/users/arnesten/orgs","repos_url":"https://api.github.com/users/arnesten/repos","events_url":"https://api.github.com/users/arnesten/events{/privacy}","received_events_url":"https://api.github.com/users/arnesten/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-18T06:10:33Z","updated_at":"2021-10-18T06:10:33Z","author_association":"NONE","body":"Thank you! That was fixed quickly :+1: ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/945396072/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/947998837","html_url":"https://github.com/apache/couchdb/issues/3789#issuecomment-947998837","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3789","id":947998837,"node_id":"IC_kwDOAAMmUc44gVB1","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-20T20:09:33Z","updated_at":"2021-10-20T20:09:33Z","author_association":"CONTRIBUTOR","body":"Closing the issue for now. The fix should be released in the next bugfix 3.2.1 release","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/947998837/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/948409540","html_url":"https://github.com/apache/couchdb/pull/3795#issuecomment-948409540","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3795","id":948409540,"node_id":"IC_kwDOAAMmUc44h5TE","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-21T09:06:01Z","updated_at":"2021-10-21T09:10:48Z","author_association":"MEMBER","body":"I'm worried about any code that tries to mask situations that should not occur.\r\n\r\n``` a clouseau index may become out of sync with the db or\r\nbecome corrupt under certain conditions (heap exhaustion, garbage collection).\r\n```\r\n\r\nThe index should only ever be either current or stale. I don't recognise \"out of sync\" or \"corrupt\", can you describe this more? If the jvm died for some reason, the index would simply be stale (behind) relative to the database, and the next query, once the jvm has restarted, should update the index as it was before.\r\n\r\nI would expect the doc to be missing for an include_docs=true if the doc were deleted between the start of the _search request and its completion, but I'm inferring this PR is not about addressing that known case?\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/948409540/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/948783750","html_url":"https://github.com/apache/couchdb/pull/3795#issuecomment-948783750","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3795","id":948783750,"node_id":"IC_kwDOAAMmUc44jUqG","user":{"login":"tonysun83","id":6991573,"node_id":"MDQ6VXNlcjY5OTE1NzM=","avatar_url":"https://avatars.githubusercontent.com/u/6991573?v=4","gravatar_id":"","url":"https://api.github.com/users/tonysun83","html_url":"https://github.com/tonysun83","followers_url":"https://api.github.com/users/tonysun83/followers","following_url":"https://api.github.com/users/tonysun83/following{/other_user}","gists_url":"https://api.github.com/users/tonysun83/gists{/gist_id}","starred_url":"https://api.github.com/users/tonysun83/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tonysun83/subscriptions","organizations_url":"https://api.github.com/users/tonysun83/orgs","repos_url":"https://api.github.com/users/tonysun83/repos","events_url":"https://api.github.com/users/tonysun83/events{/privacy}","received_events_url":"https://api.github.com/users/tonysun83/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-21T16:32:42Z","updated_at":"2021-10-21T16:34:34Z","author_association":"CONTRIBUTOR","body":"> I'm worried about any code that tries to mask situations that should not occur.\r\n\r\nI agree that this is a bandaid approach and it masks the underlying root cause. The right approach would be to recreate the exact scenario and see how the indexes get corrupted and see if a change in clouseau can prevent such a situation. Unfortunately, due to security reasons, I am unable to access the user's cluster and I can't reproduce the issue locally (specifically they claim that their particular document that causes the case clause is from a different db). \r\n\r\n> The index should only ever be either current or stale. I don't recognize \"out of sync\" or \"corrupt\", can you describe this more?\r\n\r\nThe user's cluster usage/workflow patterns leads clouseau to constantly allocate more and more heap memory until it reaches the max. Garbage collection kicks frequently and degrades the cluster. Occasionally clouseau will become non-responsive and a restart is required. Some of the clouseau indexes will contain:\r\n\r\n```\r\nWARNING: 5 broken segments (containing 15231 documents) detected\r\nWARNING: would write new segments file, and 15231 documents would be lost, if -fix were specified\r\n```\r\nAs you well know, this means that the indexes are corrupt. Running `CheckIndex` -fix doesn't resolve the issue and the only way the issue resolves is if the index is rebuilt. \r\n\r\n> If the jvm died for some reason, the index would simply be stale (behind) relative to the database, and the next query, once the jvm has restarted, should update the index as it was before.\r\n\r\nWhat if the document never existed before? https://github.com/apache/couchdb/blob/3.x/src/dreyfus/src/dreyfus_index_updater.erl#L129\r\nWe only update the index upon checking for the latest changes to the db. If the document never existed in the db, then on the dreyfus side, it would appear as though the database is up to date. Whereas on the clouseau, you have this phantom docid that appeared out of nowhere that was never part of the database. That's what the customer is claiming. I wonder if this is even possible. Could there be a situation where clouseau, under high load, writes a document id to a different segment that maps to a different db? Or would some segment merge operation do this? This is all conjecture on my part since I don't have access to the cluster itself. \r\n\r\n> I'm inferring this PR is not about addressing that known case?\r\n\r\nIt's a lesser of two evils in the short term. The user's application can't continue because of the case_clause. But I have the same concern as you: their application wouldn't crash right away, but they are dealing with incorrect data. Perhaps we should throw a 500 with a more meaningful message? I'm definitely open to suggestions. \r\n\r\nNote that this only happens when include_docs=true. So for the longest time now, under similar situations, users have been getting wrong results back already but they just never got an exception when include_docs=false. This \"bug\" has been around forever.\r\n\r\n\r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/948783750/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949053932","html_url":"https://github.com/apache/couchdb/issues/3786#issuecomment-949053932","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3786","id":949053932,"node_id":"IC_kwDOAAMmUc44kWns","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-21T22:38:44Z","updated_at":"2021-10-21T22:38:44Z","author_association":"CONTRIBUTOR","body":"Tentative (draft) PR https://github.com/apache/couchdb/pull/3796","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949053932/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949423630","html_url":"https://github.com/apache/couchdb/pull/3783#issuecomment-949423630","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3783","id":949423630,"node_id":"IC_kwDOAAMmUc44lw4O","user":{"login":"nono","id":2767,"node_id":"MDQ6VXNlcjI3Njc=","avatar_url":"https://avatars.githubusercontent.com/u/2767?v=4","gravatar_id":"","url":"https://api.github.com/users/nono","html_url":"https://github.com/nono","followers_url":"https://api.github.com/users/nono/followers","following_url":"https://api.github.com/users/nono/following{/other_user}","gists_url":"https://api.github.com/users/nono/gists{/gist_id}","starred_url":"https://api.github.com/users/nono/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nono/subscriptions","organizations_url":"https://api.github.com/users/nono/orgs","repos_url":"https://api.github.com/users/nono/repos","events_url":"https://api.github.com/users/nono/events{/privacy}","received_events_url":"https://api.github.com/users/nono/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-22T08:56:51Z","updated_at":"2021-10-22T08:56:51Z","author_association":"NONE","body":"@jcoglan what do you think of this PR?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949423630/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949635068","html_url":"https://github.com/apache/couchdb/pull/3783#issuecomment-949635068","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3783","id":949635068,"node_id":"IC_kwDOAAMmUc44mkf8","user":{"login":"jcoglan","id":9265,"node_id":"MDQ6VXNlcjkyNjU=","avatar_url":"https://avatars.githubusercontent.com/u/9265?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoglan","html_url":"https://github.com/jcoglan","followers_url":"https://api.github.com/users/jcoglan/followers","following_url":"https://api.github.com/users/jcoglan/following{/other_user}","gists_url":"https://api.github.com/users/jcoglan/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoglan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoglan/subscriptions","organizations_url":"https://api.github.com/users/jcoglan/orgs","repos_url":"https://api.github.com/users/jcoglan/repos","events_url":"https://api.github.com/users/jcoglan/events{/privacy}","received_events_url":"https://api.github.com/users/jcoglan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-22T13:31:24Z","updated_at":"2021-10-22T13:31:24Z","author_association":"CONTRIBUTOR","body":"What behaviour does this produce for the examples in #3773? In that issue we have two stored view rows with keys that have different bytes, representing different codepoints, but which can be viewed equal under Unicode normalisation.\r\n\r\n- one key (call this key A) has bytes `c3 ae` representing codepoints U+00EE\r\n- the other (key B) has bytes `69 cc 82` representing codepoints U+0069 U+0302\r\n\r\nWhen these keys are retrieved from the same shard they're considered equal when reducing, but not when fetched from different shards. This meant that:\r\n\r\n- with `q=1`, querying the view with no filter gives 1 row. Querying for key A gives 1 row and key B gives 0 rows.\r\n- with `q=2`, querying the view with no filter gives 2 rows. Querying for key A gives 1 row and key B also gives 1 row.\r\n\r\nWhat behaviour does this patch give for these scenarios? Would it be possible to write tests for them?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949635068/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949638061","html_url":"https://github.com/apache/couchdb/pull/3783#issuecomment-949638061","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3783","id":949638061,"node_id":"IC_kwDOAAMmUc44mlOt","user":{"login":"jcoglan","id":9265,"node_id":"MDQ6VXNlcjkyNjU=","avatar_url":"https://avatars.githubusercontent.com/u/9265?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoglan","html_url":"https://github.com/jcoglan","followers_url":"https://api.github.com/users/jcoglan/followers","following_url":"https://api.github.com/users/jcoglan/following{/other_user}","gists_url":"https://api.github.com/users/jcoglan/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoglan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoglan/subscriptions","organizations_url":"https://api.github.com/users/jcoglan/orgs","repos_url":"https://api.github.com/users/jcoglan/repos","events_url":"https://api.github.com/users/jcoglan/events{/privacy}","received_events_url":"https://api.github.com/users/jcoglan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-22T13:35:04Z","updated_at":"2021-10-22T13:35:04Z","author_association":"CONTRIBUTOR","body":"For clarity I'm referring to the queries performed by these requests:\r\n\r\n```\r\ncurl -s \"$COUCH_URL/debug/_design/by-type-name/_view/by-type-name?group=true\"\r\n\r\ncurl -s \"$COUCH_URL/debug/_design/by-type-name/_view/by-type-name?group=true\" -H \"Content-Type: application/json\" -d '{\"keys\": [[\"file\", \"cha√Æne\"]]}'\r\n\r\ncurl -s \"$COUCH_URL/debug/_design/by-type-name/_view/by-type-name?group=true\" -H \"Content-Type: application/json\" -d '{\"keys\": [[\"file\", \"chaiÃÇne\"]]}'\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949638061/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949655148","html_url":"https://github.com/apache/couchdb/pull/3783#issuecomment-949655148","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3783","id":949655148,"node_id":"IC_kwDOAAMmUc44mpZs","user":{"login":"jcoglan","id":9265,"node_id":"MDQ6VXNlcjkyNjU=","avatar_url":"https://avatars.githubusercontent.com/u/9265?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoglan","html_url":"https://github.com/jcoglan","followers_url":"https://api.github.com/users/jcoglan/followers","following_url":"https://api.github.com/users/jcoglan/following{/other_user}","gists_url":"https://api.github.com/users/jcoglan/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoglan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoglan/subscriptions","organizations_url":"https://api.github.com/users/jcoglan/orgs","repos_url":"https://api.github.com/users/jcoglan/repos","events_url":"https://api.github.com/users/jcoglan/events{/privacy}","received_events_url":"https://api.github.com/users/jcoglan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-22T13:55:52Z","updated_at":"2021-10-22T13:55:52Z","author_association":"CONTRIBUTOR","body":"Seems to me that we either want:\r\n\r\n- the keys are considered equal, in which case all three queries return a single row with value `2`\r\n- the keys are considered different, in which case the first query returns two rows with value `1`, and the latter two queries return one row with value `1`\r\n\r\nAnd we want these results to be independent of `q`.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949655148/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949660910","html_url":"https://github.com/apache/couchdb/pull/3783#issuecomment-949660910","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3783","id":949660910,"node_id":"IC_kwDOAAMmUc44mqzu","user":{"login":"jcoglan","id":9265,"node_id":"MDQ6VXNlcjkyNjU=","avatar_url":"https://avatars.githubusercontent.com/u/9265?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoglan","html_url":"https://github.com/jcoglan","followers_url":"https://api.github.com/users/jcoglan/followers","following_url":"https://api.github.com/users/jcoglan/following{/other_user}","gists_url":"https://api.github.com/users/jcoglan/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoglan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoglan/subscriptions","organizations_url":"https://api.github.com/users/jcoglan/orgs","repos_url":"https://api.github.com/users/jcoglan/repos","events_url":"https://api.github.com/users/jcoglan/events{/privacy}","received_events_url":"https://api.github.com/users/jcoglan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-22T14:02:20Z","updated_at":"2021-10-22T14:02:20Z","author_association":"CONTRIBUTOR","body":"It looks like https://github.com/apache/couchdb/issues/3773#issuecomment-941963658 is consistent with the first case I mention above. Do we mind that the results contain unnormalised keys? In @nickva's example:\r\n\r\n```\r\n--- c h a i n e ---\r\n{\"rows\":[\r\n{\"key\":[\"file\",\"cha√Æne\"],\"value\":2}\r\n]}\r\n\r\n--- c h a i ^ n e ---\r\n{\"rows\":[\r\n{\"key\":[\"file\",\"chaiÃÇne\"],\"value\":2}\r\n]}\r\n```\r\n\r\nThe first result has `c3 ae` and the second has `69 cc 82` in the `\"key\"` field. I'm wondering if applications could get confused by this, if CouchDB has considered those strings to be equal but doesn't normalise them in its results. It's quite possible we should leave those bytes alone though and not transform strings passed to us by the application.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949660910/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949932469","html_url":"https://github.com/apache/couchdb/pull/3783#issuecomment-949932469","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3783","id":949932469,"node_id":"IC_kwDOAAMmUc44ntG1","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-22T20:15:06Z","updated_at":"2021-10-25T14:14:25Z","author_association":"CONTRIBUTOR","body":"> if CouchDB has considered those strings to be equal but doesn't normalise them in its results.\r\n\r\nCouchDB currently doesn't normalize json keys in the views, neither when updating the view or the start/end keys or key dicts when querying. Perhaps we should do it, but I think that's a larger decision to be made, as it would involve compatibility with existent views.\r\n\r\nCouchDB relies on unicode comparisons only (`less(A,B) -> -1 | 0 | 1`). That function is used on each shard as base BTree ordering function, and used in the coordinator (fabric) when merging results. The primary issue that previously there was a subtle difference in how the functions worked on each shard vs how it works in the coordinator.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/949932469/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950050042","html_url":"https://github.com/apache/couchdb/issues/3797#issuecomment-950050042","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3797","id":950050042,"node_id":"IC_kwDOAAMmUc44oJz6","user":{"login":"yxuco","id":6663438,"node_id":"MDQ6VXNlcjY2NjM0Mzg=","avatar_url":"https://avatars.githubusercontent.com/u/6663438?v=4","gravatar_id":"","url":"https://api.github.com/users/yxuco","html_url":"https://github.com/yxuco","followers_url":"https://api.github.com/users/yxuco/followers","following_url":"https://api.github.com/users/yxuco/following{/other_user}","gists_url":"https://api.github.com/users/yxuco/gists{/gist_id}","starred_url":"https://api.github.com/users/yxuco/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yxuco/subscriptions","organizations_url":"https://api.github.com/users/yxuco/orgs","repos_url":"https://api.github.com/users/yxuco/repos","events_url":"https://api.github.com/users/yxuco/events{/privacy}","received_events_url":"https://api.github.com/users/yxuco/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-23T03:34:33Z","updated_at":"2021-10-23T03:34:33Z","author_association":"NONE","body":"I worked around the issue by using `parseFloat(v)` instead of `BigInt(v)`, although I am curious why BigInt does not work.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950050042/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950346033","html_url":"https://github.com/apache/couchdb/pull/3796#issuecomment-950346033","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3796","id":950346033,"node_id":"IC_kwDOAAMmUc44pSEx","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-24T15:36:34Z","updated_at":"2021-10-24T15:36:34Z","author_association":"CONTRIBUTOR","body":"@jaydoane thanks taking a look.\r\n\r\nI added tests for the _design and replicated_changes (it turns out we can perfectly fine accept shard docs with just `by_node`, who knew...). Also added the cover logic so we get coverage reports from mem3 tests.\r\n\r\nCoverage now is 100%\r\n\r\n```\r\n\r\nCode Coverage:\r\nmem3                           :  52%\r\nmem3_app                       : 100%\r\nmem3_bdu                       : 100%\r\n...\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950346033/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950657897","html_url":"https://github.com/apache/couchdb/pull/3783#issuecomment-950657897","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3783","id":950657897,"node_id":"IC_kwDOAAMmUc44qeNp","user":{"login":"jcoglan","id":9265,"node_id":"MDQ6VXNlcjkyNjU=","avatar_url":"https://avatars.githubusercontent.com/u/9265?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoglan","html_url":"https://github.com/jcoglan","followers_url":"https://api.github.com/users/jcoglan/followers","following_url":"https://api.github.com/users/jcoglan/following{/other_user}","gists_url":"https://api.github.com/users/jcoglan/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoglan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoglan/subscriptions","organizations_url":"https://api.github.com/users/jcoglan/orgs","repos_url":"https://api.github.com/users/jcoglan/repos","events_url":"https://api.github.com/users/jcoglan/events{/privacy}","received_events_url":"https://api.github.com/users/jcoglan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-25T08:25:27Z","updated_at":"2021-10-25T08:25:27Z","author_association":"CONTRIBUTOR","body":"@nickva I think you're right, normalising keys in output could be a significant behaviour change so something that requires more thought and planning, not something to roll into this fix üëç ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950657897/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950734749","html_url":"https://github.com/apache/couchdb/pull/3795#issuecomment-950734749","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3795","id":950734749,"node_id":"IC_kwDOAAMmUc44qw-d","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-25T09:47:28Z","updated_at":"2021-10-25T09:47:28Z","author_association":"MEMBER","body":"for an index with \r\n\r\n```WARNING: 5 broken segments (containing 15231 documents) detected\r\nWARNING: would write new segments file, and 15231 documents would be lost, if -fix were specified\r\n```\r\nwe should be deleting the index and letting it rebuild, or, at the very least, logging a 'fatal' error for the administrator and returning a 500 status code indicating the index is broken to the user.\r\n\r\nA lucene index managed by clouseau is specific to a single copy of a single shard range of a single database. A lucene index consists of 1 or more \"segments\", this is a tradeoff between performance (1 segment being ideal) and the ability to update the index efficiently. Segments are merged in the background and Lucene ensures this has no effect on the integrity of the index. That CheckIndex -fix would wipe out all the existing segments and write a new, empty one tells us the index is useless and no results from it should be returned to the user (they would only coincidentally be correct, which is no basis to proceed). We are, of course, on a very old version of Lucene (4.6.1, and latest is 8.10.1) and many fixes and enhancements have happened since.\r\n\r\n```Could there be a situation where clouseau, under high load, writes a document id to a different segment that maps to a different db```\r\n\r\nThat would be alarming indeed. I don't believe it is possible, as indexes are named after the corresponding source .couch file. It would be a helpful exercise if you could check into this.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950734749/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950735085","html_url":"https://github.com/apache/couchdb/issues/3797#issuecomment-950735085","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3797","id":950735085,"node_id":"IC_kwDOAAMmUc44qxDt","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-25T09:47:53Z","updated_at":"2021-10-25T09:47:53Z","author_association":"MEMBER","body":"We cleared this up in Slack, this due to SpiderMonkey 60 being part of the Mac binary and BigInt only being available in 68+. Here is an experimental build with SM86: https://clients.neighbourhood.ie/couchdb/releases/3.2.0/","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950735085/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950735474","html_url":"https://github.com/apache/couchdb/pull/3795#issuecomment-950735474","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3795","id":950735474,"node_id":"IC_kwDOAAMmUc44qxJy","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-25T09:48:19Z","updated_at":"2021-10-25T09:48:19Z","author_association":"MEMBER","body":"my summary so far: -1 to this fix as it appears to be an attempt to hide a fatal condition (corrupted index) rather than fix it.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/950735474/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951103516","html_url":"https://github.com/apache/couchdb/pull/3795#issuecomment-951103516","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3795","id":951103516,"node_id":"IC_kwDOAAMmUc44sLAc","user":{"login":"tonysun83","id":6991573,"node_id":"MDQ6VXNlcjY5OTE1NzM=","avatar_url":"https://avatars.githubusercontent.com/u/6991573?v=4","gravatar_id":"","url":"https://api.github.com/users/tonysun83","html_url":"https://github.com/tonysun83","followers_url":"https://api.github.com/users/tonysun83/followers","following_url":"https://api.github.com/users/tonysun83/following{/other_user}","gists_url":"https://api.github.com/users/tonysun83/gists{/gist_id}","starred_url":"https://api.github.com/users/tonysun83/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tonysun83/subscriptions","organizations_url":"https://api.github.com/users/tonysun83/orgs","repos_url":"https://api.github.com/users/tonysun83/repos","events_url":"https://api.github.com/users/tonysun83/events{/privacy}","received_events_url":"https://api.github.com/users/tonysun83/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-25T16:35:49Z","updated_at":"2021-10-25T16:35:49Z","author_association":"CONTRIBUTOR","body":">It would be a helpful exercise if you could check into this.\r\n\r\nWill verify with the user.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951103516/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951109770","html_url":"https://github.com/apache/couchdb/pull/3796#issuecomment-951109770","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3796","id":951109770,"node_id":"IC_kwDOAAMmUc44sMiK","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-25T16:44:18Z","updated_at":"2021-10-25T16:44:18Z","author_association":"CONTRIBUTOR","body":"Seeing [this failure](https://ci-couchdb.apache.org/job/jenkins-cm1/job/PullRequests/job/PR-3799/2/execution/node/112/log/?cloudbees-analytics-link=scm-reporting%2Ferror%2Fstep):\r\n```\r\n22:30:31  module 'mem3_bdu_test'\r\n22:30:31    mem3 bdu shard doc tests\r\n22:30:31      mem3_bdu_test:62: mem3_bdu_shard_doc_test_ (t_can_insert_shard_map_doc)...*failed*\r\n22:30:31  in function mem3_bdu_test:'-t_can_insert_shard_map_doc/1-fun-2-'/2 (test/eunit/mem3_bdu_test.erl, line 93)\r\n22:30:31  in call from eunit_test:run_testfun/1 (eunit_test.erl, line 71)\r\n22:30:31  in call from eunit_proc:run_test/1 (eunit_proc.erl, line 510)\r\n22:30:31  in call from eunit_proc:with_timeout/3 (eunit_proc.erl, line 335)\r\n22:30:31  in call from eunit_proc:handle_test/2 (eunit_proc.erl, line 493)\r\n22:30:31  in call from eunit_proc:tests_inorder/3 (eunit_proc.erl, line 435)\r\n22:30:31  in call from eunit_proc:with_timeout/3 (eunit_proc.erl, line 325)\r\n22:30:31  in call from eunit_proc:run_group/2 (eunit_proc.erl, line 549)\r\n22:30:31  **error:{assertMatch,[{module,mem3_bdu_test},\r\n22:30:31                {line,93},\r\n22:30:31                {expression,\"req ( get , Top ++ Db )\"},\r\n22:30:31                {pattern,\"{ 200 , _ }\"},\r\n22:30:31                {value,{500,\r\n22:30:31                        #{<<\"error\">> => <<\"internal_server_error\">>,\r\n22:30:31                          <<\"reason\">> => <<\"No DB shards could be opened\"...>>,\r\n22:30:31                          <<\"ref\">> => 2416970314}}}]}\r\n22:30:31    output:<<\"\">>\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951109770/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951141425","html_url":"https://github.com/apache/couchdb/pull/3796#issuecomment-951141425","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3796","id":951141425,"node_id":"IC_kwDOAAMmUc44sUQx","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-25T17:23:36Z","updated_at":"2021-10-25T17:23:36Z","author_association":"CONTRIBUTOR","body":"@jaydoane hmm, apparently the db isn't guaranteed to synchronously appear right after we get a 201 from a shard doc creation.\r\n\r\nI couldn't reproduce the flakiness locally but I can imagine it can occur. I think this should fix it https://github.com/apache/couchdb/pull/3802. The \"can read db info\" was an extra check anyway not related to whether BDU itself worked or not which what tests should be testing only.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951141425/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951150950","html_url":"https://github.com/apache/couchdb/pull/3796#issuecomment-951150950","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3796","id":951150950,"node_id":"IC_kwDOAAMmUc44sWlm","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-25T17:36:11Z","updated_at":"2021-10-25T17:36:11Z","author_association":"CONTRIBUTOR","body":"@nickva I couldn't repro locally either, but it seems the CI could multiple times in a row for some reason. Thanks for the quick fix!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951150950/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951291195","html_url":"https://github.com/apache/couchdb/issues/3581#issuecomment-951291195","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3581","id":951291195,"node_id":"IC_kwDOAAMmUc44s407","user":{"login":"MrOats","id":13208087,"node_id":"MDQ6VXNlcjEzMjA4MDg3","avatar_url":"https://avatars.githubusercontent.com/u/13208087?v=4","gravatar_id":"","url":"https://api.github.com/users/MrOats","html_url":"https://github.com/MrOats","followers_url":"https://api.github.com/users/MrOats/followers","following_url":"https://api.github.com/users/MrOats/following{/other_user}","gists_url":"https://api.github.com/users/MrOats/gists{/gist_id}","starred_url":"https://api.github.com/users/MrOats/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MrOats/subscriptions","organizations_url":"https://api.github.com/users/MrOats/orgs","repos_url":"https://api.github.com/users/MrOats/repos","events_url":"https://api.github.com/users/MrOats/events{/privacy}","received_events_url":"https://api.github.com/users/MrOats/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-25T20:25:32Z","updated_at":"2021-10-25T20:58:02Z","author_association":"NONE","body":"Can confirm with fresh Let's Encrypt certs that I receive the same error.\r\n\r\nThe workaround is to specify the following in your CouchDB config (like local.ini):\r\n```ini\r\n[ssl]\r\ntls_versions = ['tlsv1.2']\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951291195/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951322692","html_url":"https://github.com/apache/couchdb/issues/3581#issuecomment-951322692","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3581","id":951322692,"node_id":"IC_kwDOAAMmUc44tAhE","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-25T20:55:10Z","updated_at":"2021-10-25T21:27:04Z","author_association":"MEMBER","body":"Another workaround for now would be to use a reverse proxy to terminate the SSL/TLS connection, sitting between your client and the database.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951322692/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951388660","html_url":"https://github.com/apache/couchdb/pull/3792#issuecomment-951388660","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3792","id":951388660,"node_id":"IC_kwDOAAMmUc44tQn0","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-25T22:41:06Z","updated_at":"2021-10-25T22:41:06Z","author_association":"CONTRIBUTOR","body":"I added a few log warnings and a unit test for `find_replacement_sequence/2` as two separate commits.\r\n\r\n@kocolosk should we mark it as ready for review?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/951388660/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/952294470","html_url":"https://github.com/apache/couchdb/issues/3787#issuecomment-952294470","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3787","id":952294470,"node_id":"IC_kwDOAAMmUc44wtxG","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-26T20:22:39Z","updated_at":"2021-10-26T20:22:39Z","author_association":"CONTRIBUTOR","body":"This is fixed","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/952294470/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/952295049","html_url":"https://github.com/apache/couchdb/issues/3786#issuecomment-952295049","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3786","id":952295049,"node_id":"IC_kwDOAAMmUc44wt6J","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-26T20:23:28Z","updated_at":"2021-10-26T20:23:28Z","author_association":"CONTRIBUTOR","body":"This is fixed and should be ready for 3.2.1","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/952295049/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/952877046","html_url":"https://github.com/apache/couchdb/pull/3792#issuecomment-952877046","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3792","id":952877046,"node_id":"IC_kwDOAAMmUc44y7_2","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-27T12:30:34Z","updated_at":"2021-10-27T12:30:34Z","author_association":"MEMBER","body":"Unit tests look good from my end, thanks for adding them.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/952877046/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/953931347","html_url":"https://github.com/apache/couchdb/issues/3806#issuecomment-953931347","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3806","id":953931347,"node_id":"IC_kwDOAAMmUc4429ZT","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-28T15:00:04Z","updated_at":"2021-10-28T15:32:54Z","author_association":"CONTRIBUTOR","body":"Using the correctly configured shards db seems to work.\r\n\r\nHowever it also produces some noise in the logs for n=1 and n=2 dbs\r\n\r\n```\r\n[notice] 2021-10-28T14:04:51.453035Z node1@127.0.0.1 <0.3689.0> d1af8be8bd 127.0.0.1:15984 127.0.0.1 adm PUT /db2?q=1&n=2 201 ok 288\r\n[notice] 2021-10-28T14:05:57.258774Z node1@127.0.0.1 <0.4773.0> 26625fe22a 127.0.0.1:15984 127.0.0.1 adm PUT /db2?q=1&n=3 412 ok 1\r\n[notice] 2021-10-28T14:06:05.118009Z node1@127.0.0.1 <0.4903.0> 29e9834ffa 127.0.0.1:15984 127.0.0.1 adm PUT /db3?q=1&n=3 201 ok 339\r\n[critical] 2021-10-28T14:06:05.120958Z node1@127.0.0.1 <0.4957.0> -------- 1 shard in cluster with only 1 copy on nodes that are currently up\r\n[critical] 2021-10-28T14:06:05.121009Z node1@127.0.0.1 <0.4957.0> -------- 1 shard in cluster with only 1 copy on nodes not in maintenance mode\r\n[critical] 2021-10-28T14:06:05.121055Z node1@127.0.0.1 <0.4957.0> -------- 1 shard in cluster with only 2 copies on nodes that are currently up\r\n[critical] 2021-10-28T14:06:05.121111Z node1@127.0.0.1 <0.4957.0> -------- 1 shard in cluster with only 2 copies on nodes not in maintenance mode\r\n```\r\n\r\nIf users specify n=1 or n=2 it should not generate critical errors, so custodian would need to handle those cases before being enabled properly.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/953931347/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954043895","html_url":"https://github.com/apache/couchdb/issues/3806#issuecomment-954043895","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3806","id":954043895,"node_id":"IC_kwDOAAMmUc443Y33","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-28T17:16:36Z","updated_at":"2021-10-28T17:16:36Z","author_association":"CONTRIBUTOR","body":"> If users specify n=1 or n=2 it should not generate critical errors, so custodian would need to handle those cases before being enabled properly.\r\n\r\nCustodian is opinionated about how many copies of data you have in a cluster, which seems like a good thing in general. But I can see how it would get annoying to have `critical` log messages when you know what you're doing with low `n` dbs.\r\n\r\nPerhaps we could make a `[custodian] unsafe_log_level = critical` config option which would allow those more comfortable with potential data loss change it to something less scary?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954043895/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954057428","html_url":"https://github.com/apache/couchdb/issues/3806#issuecomment-954057428","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3806","id":954057428,"node_id":"IC_kwDOAAMmUc443cLU","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-28T17:35:48Z","updated_at":"2021-10-28T17:35:48Z","author_association":"CONTRIBUTOR","body":"Ideally I think we should generate the critical/warn logs depending on the expected vs available shards\r\n\r\nThe shard map should inform us of the expected shard copies and the live nodes / maintenance nodes / dead nodes would tell use how many are missing vs expected. That is perhaps warn if there is < expected available and critical if < expected / 2?\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954057428/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954263760","html_url":"https://github.com/apache/couchdb/pull/3807#issuecomment-954263760","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3807","id":954263760,"node_id":"IC_kwDOAAMmUc444OjQ","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-28T22:10:38Z","updated_at":"2021-10-28T22:10:38Z","author_association":"CONTRIBUTOR","body":"How to test:\r\n\r\n * Create `n=1` and `n=2` dbs\r\n * Notice that custodian shouldn't emit errors\r\n * Set one of the nodes in maintenance mode. Custodian should emit errors.\r\n * Bring node back to production and kill one of the nodes. Custodian should also emit errors.\r\n\r\n```\r\nhttp put $DB/n1db'?n=1'\r\nhttp put $DB/n2db'?n=2'\r\n```\r\n\r\n```\r\nconfig:set(\"couchdb\", \"maintenance_mode\", \"true\", false).\r\n\r\ncustodian:report().\r\n[{<<\"n2db\">>,{0,2147483647},{live,1}},\r\n {<<\"n1db\">>,{0,2147483647},{live,0}},\r\n {<<\"_users\">>,{2147483648,4294967295},{live,2}},\r\n {<<\"_users\">>,{0,2147483647},{live,2}},\r\n {<<\"_replicator\">>,{2147483648,4294967295},{live,2}},\r\n {<<\"_replicator\">>,{0,2147483647},{live,2}}]\r\n```\r\n\r\n```\r\n[notice] 2021-10-28T20:51:30.985095Z node1@127.0.0.1 <0.109.0> -------- config: [couchdb] maintenance_mode set to true for reason nil\r\n[critical] 2021-10-28T20:51:30.987098Z node1@127.0.0.1 <0.2089.0> -------- 1 shard in cluster with only 1 copy on nodes not in maintenance mode\r\n[critical] 2021-10-28T20:51:30.987134Z node1@127.0.0.1 <0.2089.0> -------- 1 shard in cluster with only 0 copies on nodes not in maintenance mode\r\n[warning] 2021-10-28T20:51:30.987196Z node1@127.0.0.1 <0.2089.0> -------- 4 shards in cluster with only 2 copies on nodes not in maintenance mode\r\n```\r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954263760/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954277855","html_url":"https://github.com/apache/couchdb/issues/3806#issuecomment-954277855","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3806","id":954277855,"node_id":"IC_kwDOAAMmUc444R_f","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-28T22:41:04Z","updated_at":"2021-10-28T22:41:04Z","author_association":"CONTRIBUTOR","body":"PR to fix it https://github.com/apache/couchdb/pull/3807","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954277855/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954288740","html_url":"https://github.com/apache/couchdb/issues/3806#issuecomment-954288740","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3806","id":954288740,"node_id":"IC_kwDOAAMmUc444Upk","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-28T23:07:37Z","updated_at":"2021-10-28T23:07:37Z","author_association":"CONTRIBUTOR","body":"Thanks for reviewing the PR @jaydoane. The fix was merged, closing the issue","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954288740/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954290436","html_url":"https://github.com/apache/couchdb/issues/3788#issuecomment-954290436","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3788","id":954290436,"node_id":"IC_kwDOAAMmUc444VEE","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-28T23:11:42Z","updated_at":"2021-10-28T23:11:42Z","author_association":"CONTRIBUTOR","body":"@kocolosk's PR with the fix was merged, closing the issue","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954290436/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954834702","html_url":"https://github.com/apache/couchdb/issues/3758#issuecomment-954834702","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3758","id":954834702,"node_id":"IC_kwDOAAMmUc446Z8O","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-29T15:28:31Z","updated_at":"2021-10-29T15:28:31Z","author_association":"MEMBER","body":"Hi, \r\n\r\nI've just tried this locally and it worked for me. Can you verify you set the config correctly by querying `/_node/_local/_config/jwt_auth/roles_claim_name` and confirm it returns `\"couchdbroles\"`.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954834702/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954837792","html_url":"https://github.com/apache/couchdb/issues/3758#issuecomment-954837792","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3758","id":954837792,"node_id":"IC_kwDOAAMmUc446asg","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-29T15:33:00Z","updated_at":"2021-10-29T15:33:00Z","author_association":"MEMBER","body":"I used jtw.io to create a JWT token signed with my key but with your verbatim (decoded) JWT body and get;\r\n\r\n```\r\n{\"ok\":true,\"userCtx\":{\"name\":\"b5efed67-731c-408f-8c22-e182309cf3eb\",\"roles\":[\"developper\"]},\"info\":{\"authentication_handlers\":[\"jwt\",\"cookie\",\"default\"],\"authenticated\":\"jwt\"}}\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954837792/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954971078","html_url":"https://github.com/apache/couchdb/pull/3808#issuecomment-954971078","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3808","id":954971078,"node_id":"IC_kwDOAAMmUc4467PG","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-29T18:47:48Z","updated_at":"2021-10-29T18:47:48Z","author_association":"CONTRIBUTOR","body":"I looks like we are still setting the `couch_httpd_auth` secret values in the` _session` handler:\r\n\r\nhttps://github.com/apache/couchdb/blob/3.x/src/couch/src/couch_httpd_auth.erl#L318\r\n\r\nWonder what the correct approach is to sync then. If setup is run on new install only, sync `chttpd_auth` but if there is a chance it would run an already existing cluster sync both if they are not `undefined`?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/954971078/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/955175077","html_url":"https://github.com/apache/couchdb/pull/3808#issuecomment-955175077","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3808","id":955175077,"node_id":"IC_kwDOAAMmUc447tCl","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-10-30T08:48:21Z","updated_at":"2021-10-30T08:48:21Z","author_association":"MEMBER","body":"good find, I‚Äôm happy to adjust `ensure_cookie_auth_secret` in this PR here.\r\n\r\nSetup is meant for new installs only, never for existing clusters.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/955175077/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/956311317","html_url":"https://github.com/apache/couchdb/issues/3811#issuecomment-956311317","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3811","id":956311317,"node_id":"IC_kwDOAAMmUc45ACcV","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-01T15:04:52Z","updated_at":"2021-11-01T15:04:52Z","author_association":"MEMBER","body":"Ah, sorry, this changed on purpose in https://github.com/apache/couchdb/commit/331894a6acb4565c71d800f2e63206101dfbb48c after consulting the RFC 7519 specification.\r\n\r\nThe docs need updating.\r\n\r\ncc @jaydoane ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/956311317/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/956538796","html_url":"https://github.com/apache/couchdb/pull/3812#issuecomment-956538796","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3812","id":956538796,"node_id":"IC_kwDOAAMmUc45A5-s","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-01T19:51:16Z","updated_at":"2021-11-01T19:51:16Z","author_association":"CONTRIBUTOR","body":"We should be able to rely on `_revisions:{start: ..., ids: [...]}` instead and shouldn't necessarily need `_rev`","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/956538796/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/959092581","html_url":"https://github.com/apache/couchdb/issues/3758#issuecomment-959092581","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3758","id":959092581,"node_id":"IC_kwDOAAMmUc45Kpdl","user":{"login":"loylick","id":20624598,"node_id":"MDQ6VXNlcjIwNjI0NTk4","avatar_url":"https://avatars.githubusercontent.com/u/20624598?v=4","gravatar_id":"","url":"https://api.github.com/users/loylick","html_url":"https://github.com/loylick","followers_url":"https://api.github.com/users/loylick/followers","following_url":"https://api.github.com/users/loylick/following{/other_user}","gists_url":"https://api.github.com/users/loylick/gists{/gist_id}","starred_url":"https://api.github.com/users/loylick/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/loylick/subscriptions","organizations_url":"https://api.github.com/users/loylick/orgs","repos_url":"https://api.github.com/users/loylick/repos","events_url":"https://api.github.com/users/loylick/events{/privacy}","received_events_url":"https://api.github.com/users/loylick/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-03T13:35:24Z","updated_at":"2021-11-03T14:04:54Z","author_association":"NONE","body":"Hi, the response to /_node/_local/_config/jwt_auth/roles_claim_name is  \"_couchdb.roles\". I've tried what you did. I called the claim \"couchdbroles\" without nesting the array. In such configuration it worked. So if I call the claim \"_couchdb.roles\" the roles are not passed. If I call the claim as you did, everything works fine.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/959092581/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/961079350","html_url":"https://github.com/apache/couchdb/issues/909#issuecomment-961079350","issue_url":"https://api.github.com/repos/apache/couchdb/issues/909","id":961079350,"node_id":"IC_kwDOAAMmUc45SOg2","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-04T14:41:07Z","updated_at":"2021-11-04T14:41:07Z","author_association":"MEMBER","body":"CouchDB 3.0 introduced a new compaction daemon in #1904 that implements most of this. It allows for different calculations of \"gain\". Specifically, you can prioritize based on the ratio of `file size / active data` or the difference `file size - active data`, and you can create different \"channels\" with different settings so that e.g. you always devote some bandwidth to compacting large database shards, and you also keep compacting small views quickly become sparse. The documentation is pretty thorough:\r\n\r\nhttps://docs.couchdb.org/en/stable/config/compaction.html#compaction-daemon","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/961079350/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/961111956","html_url":"https://github.com/apache/couchdb/issues/2008#issuecomment-961111956","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2008","id":961111956,"node_id":"IC_kwDOAAMmUc45SWeU","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-04T14:56:52Z","updated_at":"2021-11-04T14:56:52Z","author_association":"MEMBER","body":"Rediscovered in #3773 and fixed by #3783","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/961111956/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/961122564","html_url":"https://github.com/apache/couchdb/issues/2235#issuecomment-961122564","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2235","id":961122564,"node_id":"IC_kwDOAAMmUc45SZEE","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-11-04T15:01:57Z","updated_at":"2021-11-04T15:01:57Z","author_association":"MEMBER","body":"I believe those PRs by @noahshaw11 exactly resolve this issue.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/961122564/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]