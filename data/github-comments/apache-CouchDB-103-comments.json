[{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/889465405","html_url":"https://github.com/apache/couchdb/issues/3684#issuecomment-889465405","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3684","id":889465405,"node_id":"IC_kwDOAAMmUc41BCo9","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-07-29T21:16:48Z","updated_at":"2021-07-29T21:16:48Z","author_association":"CONTRIBUTOR","body":"Thanks for the bug report @mojito317","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/889465405/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/890129192","html_url":"https://github.com/apache/couchdb/pull/3685#issuecomment-890129192","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3685","id":890129192,"node_id":"IC_kwDOAAMmUc41Dkso","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-07-30T20:12:19Z","updated_at":"2021-07-30T20:12:19Z","author_association":"CONTRIBUTOR","body":"Thanks for the fixup. I improved it a bit with another edge case here https://github.com/apache/couchdb/pull/3686\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/890129192/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/890275799","html_url":"https://github.com/apache/couchdb/pull/3687#issuecomment-890275799","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3687","id":890275799,"node_id":"IC_kwDOAAMmUc41EIfX","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-07-31T02:00:22Z","updated_at":"2021-07-31T02:00:22Z","author_association":"CONTRIBUTOR","body":"Reusing +1 from https://github.com/apache/couchdb/pull/3686","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/890275799/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/890275881","html_url":"https://github.com/apache/couchdb/issues/3684#issuecomment-890275881","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3684","id":890275881,"node_id":"IC_kwDOAAMmUc41EIgp","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-07-31T02:01:15Z","updated_at":"2021-07-31T02:01:15Z","author_association":"CONTRIBUTOR","body":"These PRs should fix it https://github.com/apache/couchdb/pull/3687 https://github.com/apache/couchdb/pull/3686","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/890275881/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/890372099","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-890372099","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":890372099,"node_id":"IC_kwDOAAMmUc41EgAD","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-07-31T16:29:15Z","updated_at":"2021-08-02T19:58:27Z","author_association":"CONTRIBUTOR","body":"I confirmed that the JS engine is implicated. I ran 2.3.1 and 3.x latest on Ubuntu 20.04. For 3.x I installed the libmozjs185 couchdb-build package for Ubuntu 18.04 on my Ubuntu 20.04 system and ran with q=8 to minimize difference and similar performance numbers as 2.3.1.\r\n\r\nPackages I downloaded and installed manually:\r\n```\r\ncouch-libmozjs185-1.0_1.8.5-1.0.0+couch-2_bionic_amd64.deb\r\ncouch-libmozjs185-dev_1.8.5-1.0.0+couch-2_bionic_amd64.deb\r\nlibffi6_3.2.1-8_amd64.deb\r\nlibffi-dev_3.2.1-8_amd64.deb\r\n```\r\n(libffi6 was needed as a dependency of couch-libmozjs185)\r\n\r\nConfigure 3.x to build with version 1.8.5\r\n```\r\n./configure --spidermonkey-version 1.8.5 --dev\r\n```\r\n\r\nTest script was modified to not set up docker containers, just run locally with 2.3.1 and 3.1.1 running on different ports.\r\n```\r\n./couchdb-test.sh query\r\nCouchDB performance regression test script\r\nAssuming that setup is already complete\r\n================ Query CouchDB 2.3.1 ================\r\n{\"couchdb\":\"Welcome\",\"version\":\"2.3.1\",\"git_sha\":\"c298091a4\",\"uuid\":\"fake_uuid_for_dev\",\"features\":[\"pluggable-storage-engines\",\"scheduler\"],\"vendor\":{\"name\":\"The Apache Software Foundation\"}}\r\nQuery Database views on port 15994\r\nRound: 1/10\r\n\r\nreal\t0m13.022s\r\nuser\t0m0.023s\r\nsys\t0m0.023s\r\nRound: 2/10\r\n\r\nreal\t0m7.234s\r\nuser\t0m0.020s\r\nsys\t0m0.008s\r\nRound: 3/10\r\n\r\nreal\t0m6.715s\r\nuser\t0m0.026s\r\nsys\t0m0.000s\r\nRound: 4/10\r\n\r\nreal\t0m7.021s\r\nuser\t0m0.018s\r\nsys\t0m0.009s\r\nRound: 5/10\r\n\r\nreal\t0m7.159s\r\nuser\t0m0.005s\r\nsys\t0m0.021s\r\nRound: 6/10\r\n\r\nreal\t0m7.318s\r\nuser\t0m0.014s\r\nsys\t0m0.014s\r\nRound: 7/10\r\n\r\nreal\t0m7.464s\r\nuser\t0m0.007s\r\nsys\t0m0.021s\r\nRound: 8/10\r\n\r\nreal\t0m7.175s\r\nuser\t0m0.016s\r\nsys\t0m0.011s\r\nRound: 9/10\r\n\r\nreal\t0m7.096s\r\nuser\t0m0.004s\r\nsys\t0m0.023s\r\nRound: 10/10\r\n\r\nreal\t0m7.235s\r\nuser\t0m0.006s\r\nsys\t0m0.022s\r\n```\r\n\r\n```\r\nq=8\r\n================ Query CouchDB 3.1.1 ================\r\n{\"couchdb\":\"Welcome\",\"version\":\"3.1.1-ba63878\",\"git_sha\":\"ba63878\",\"uuid\":\"fake_uuid_for_dev\",\"features\":[\"access-ready\",\"partitioned\",\"pluggable-storage-engines\",\"reshard\",\"scheduler\"],\"vendor\":{\"name\":\"The Apache Software Foundation\"}}\r\nQuery Database views on port 15984\r\nRound: 1/10\r\n\r\nreal\t0m5.979s\r\nuser\t0m0.017s\r\nsys\t0m0.010s\r\nRound: 2/10\r\n\r\nreal\t0m6.757s\r\nuser\t0m0.013s\r\nsys\t0m0.013s\r\nRound: 3/10\r\n\r\nreal\t0m7.112s\r\nuser\t0m0.012s\r\nsys\t0m0.016s\r\nRound: 4/10\r\n\r\nreal\t0m7.359s\r\nuser\t0m0.017s\r\nsys\t0m0.011s\r\nRound: 5/10\r\n\r\nreal\t0m7.210s\r\nuser\t0m0.017s\r\nsys\t0m0.013s\r\nRound: 6/10\r\n\r\nreal\t0m7.233s\r\nuser\t0m0.008s\r\nsys\t0m0.021s\r\nRound: 7/10\r\n\r\nreal\t0m6.284s\r\nuser\t0m0.028s\r\nsys\t0m0.000s\r\nRound: 8/10\r\n\r\nreal\t0m7.101s\r\nuser\t0m0.020s\r\nsys\t0m0.008s\r\nRound: 9/10\r\n\r\nreal\t0m6.943s\r\nuser\t0m0.022s\r\nsys\t0m0.006s\r\nRound: 10/10\r\n\r\nreal\t0m6.736s\r\nuser\t0m0.016s\r\nsys\t0m0.011s\r\n```\r\n\r\nWith default mozjs68 library on Ubuntu I was getting around 30 seconds\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/890372099/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/891758583","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-891758583","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":891758583,"node_id":"IC_kwDOAAMmUc41Jyf3","user":{"login":"konrad-ohms","id":40577406,"node_id":"MDQ6VXNlcjQwNTc3NDA2","avatar_url":"https://avatars.githubusercontent.com/u/40577406?v=4","gravatar_id":"","url":"https://api.github.com/users/konrad-ohms","html_url":"https://github.com/konrad-ohms","followers_url":"https://api.github.com/users/konrad-ohms/followers","following_url":"https://api.github.com/users/konrad-ohms/following{/other_user}","gists_url":"https://api.github.com/users/konrad-ohms/gists{/gist_id}","starred_url":"https://api.github.com/users/konrad-ohms/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/konrad-ohms/subscriptions","organizations_url":"https://api.github.com/users/konrad-ohms/orgs","repos_url":"https://api.github.com/users/konrad-ohms/repos","events_url":"https://api.github.com/users/konrad-ohms/events{/privacy}","received_events_url":"https://api.github.com/users/konrad-ohms/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-03T11:12:36Z","updated_at":"2021-08-03T11:12:36Z","author_association":"NONE","body":"Thank you @nickva for your investigation. Good to know that it is really located in the Javascript engine and not elsewhere within the CouchDB code base.\r\nI am not too familiar with CouchDB's dependencies, are you stating, that the Problem is basically a performance regression in Mozilla’s SpiderMonkey implementation?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/891758583/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/891897388","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-891897388","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":891897388,"node_id":"IC_kwDOAAMmUc41KUYs","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-03T14:32:34Z","updated_at":"2021-08-03T14:32:34Z","author_association":"CONTRIBUTOR","body":"Discussing this on couchdb-dev channel, CouchDB with JS runtimes later than mozjs 60 need to re-write their design doc functions [1]. Also, unlike pure map views, where the JS runtime gets to process (learn) the function first, then only handle the keys and values [2], custom reduce functions have the function body sent with each query server command. Therefore, any overhead in that JS code re-writing is amplified for the custom reducers.\r\n\r\nLooking back at the reduce function, I wonder if it would be possible to rewrite it using two _sum[3] and _stats[4] built-in reducers, which should not suffer from the same rewriting overhead.\r\n\r\nFor example, the _sum reducer can be applied to objects, such as:\r\n\r\n```\r\n\"views\":{\"v1\":{ \"map\": \"function(doc){ emit(null, {x:doc.x, y:doc.y}) };\", \"reduce\":\"_sum\"}}\r\n...\r\n{\"x\": 1, \"y\": 3}\r\n{\"x\": 2, \"y\": 4}\r\n```\r\nAnd would emit:\r\n```\r\n{\"key\":null,\"value\":{\"x\":3,\"y\":7}}\r\n```\r\n\r\nThat could be used for \"unsuccessful\" results. For the \"successful\" case, execution stats could be accumulated using _stats [3]\r\n\r\n\r\n[1] https://github.com/apache/couchdb/blob/0059b8f90e58e10b199a4b768a06a762d12a30d3/share/server/60/rewrite_fun.js#L29-L38\r\n[2] https://docs.couchdb.org/en/stable/query-server/protocol.html?highlight=add_fun#add-fun\r\n[3] https://docs.couchdb.org/en/stable/ddocs/ddocs.html#_sum\r\n[4] https://docs.couchdb.org/en/stable/ddocs/ddocs.html#_stats","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/891897388/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/893051528","html_url":"https://github.com/apache/couchdb/issues/3324#issuecomment-893051528","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3324","id":893051528,"node_id":"IC_kwDOAAMmUc41OuKI","user":{"login":"bdoyle0182","id":11879547,"node_id":"MDQ6VXNlcjExODc5NTQ3","avatar_url":"https://avatars.githubusercontent.com/u/11879547?v=4","gravatar_id":"","url":"https://api.github.com/users/bdoyle0182","html_url":"https://github.com/bdoyle0182","followers_url":"https://api.github.com/users/bdoyle0182/followers","following_url":"https://api.github.com/users/bdoyle0182/following{/other_user}","gists_url":"https://api.github.com/users/bdoyle0182/gists{/gist_id}","starred_url":"https://api.github.com/users/bdoyle0182/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bdoyle0182/subscriptions","organizations_url":"https://api.github.com/users/bdoyle0182/orgs","repos_url":"https://api.github.com/users/bdoyle0182/repos","events_url":"https://api.github.com/users/bdoyle0182/events{/privacy}","received_events_url":"https://api.github.com/users/bdoyle0182/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-04T23:55:24Z","updated_at":"2021-08-04T23:55:24Z","author_association":"NONE","body":"Hi is there anyway for someone to check on this to at least verify it is truly a bug, whether or not that actually involves fixing it at the same time? We would like verification before we put more effort in trying to attempt to get this to work.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/893051528/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/894979239","html_url":"https://github.com/apache/couchdb/pull/3694#issuecomment-894979239","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3694","id":894979239,"node_id":"IC_kwDOAAMmUc41WEyn","user":{"login":"noahshaw11","id":47468872,"node_id":"MDQ6VXNlcjQ3NDY4ODcy","avatar_url":"https://avatars.githubusercontent.com/u/47468872?v=4","gravatar_id":"","url":"https://api.github.com/users/noahshaw11","html_url":"https://github.com/noahshaw11","followers_url":"https://api.github.com/users/noahshaw11/followers","following_url":"https://api.github.com/users/noahshaw11/following{/other_user}","gists_url":"https://api.github.com/users/noahshaw11/gists{/gist_id}","starred_url":"https://api.github.com/users/noahshaw11/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noahshaw11/subscriptions","organizations_url":"https://api.github.com/users/noahshaw11/orgs","repos_url":"https://api.github.com/users/noahshaw11/repos","events_url":"https://api.github.com/users/noahshaw11/events{/privacy}","received_events_url":"https://api.github.com/users/noahshaw11/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-09T06:23:55Z","updated_at":"2021-08-09T06:23:55Z","author_association":"CONTRIBUTOR","body":"Closing since https://github.com/apache/couchdb/pull/3697 contains these changes.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/894979239/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/896037447","html_url":"https://github.com/apache/couchdb/pull/3697#issuecomment-896037447","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3697","id":896037447,"node_id":"IC_kwDOAAMmUc41aHJH","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-10T13:39:35Z","updated_at":"2021-08-10T13:39:35Z","author_association":"CONTRIBUTOR","body":"Nice job! Only test case coverage question left.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/896037447/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/896470017","html_url":"https://github.com/apache/couchdb/pull/3700#issuecomment-896470017","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3700","id":896470017,"node_id":"IC_kwDOAAMmUc41bwwB","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-11T03:22:12Z","updated_at":"2021-08-11T03:22:12Z","author_association":"MEMBER","body":"😲\n\nNice find! Did this one show up in production?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/896470017/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/896906616","html_url":"https://github.com/apache/couchdb/issues/3367#issuecomment-896906616","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3367","id":896906616,"node_id":"IC_kwDOAAMmUc41dbV4","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-11T15:05:54Z","updated_at":"2021-08-11T15:05:54Z","author_association":"CONTRIBUTOR","body":"The PR with a fix has been merged. ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/896906616/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/896908901","html_url":"https://github.com/apache/couchdb/issues/3239#issuecomment-896908901","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3239","id":896908901,"node_id":"IC_kwDOAAMmUc41db5l","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-11T15:08:34Z","updated_at":"2021-08-11T15:08:34Z","author_association":"CONTRIBUTOR","body":"The PR has been merged in 3.x and main. Since it is a behaviour change the fix is protected by configuration toggle.\r\n\r\n```\r\n[chttpd]\r\n; Set to true to decode + to space in db and doc_id parts.\r\n; decode_plus_to_space = true\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/896908901/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/897026292","html_url":"https://github.com/apache/couchdb/pull/3700#issuecomment-897026292","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3700","id":897026292,"node_id":"IC_kwDOAAMmUc41d4j0","user":{"login":"chewbranca","id":5326,"node_id":"MDQ6VXNlcjUzMjY=","avatar_url":"https://avatars.githubusercontent.com/u/5326?v=4","gravatar_id":"","url":"https://api.github.com/users/chewbranca","html_url":"https://github.com/chewbranca","followers_url":"https://api.github.com/users/chewbranca/followers","following_url":"https://api.github.com/users/chewbranca/following{/other_user}","gists_url":"https://api.github.com/users/chewbranca/gists{/gist_id}","starred_url":"https://api.github.com/users/chewbranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chewbranca/subscriptions","organizations_url":"https://api.github.com/users/chewbranca/orgs","repos_url":"https://api.github.com/users/chewbranca/repos","events_url":"https://api.github.com/users/chewbranca/events{/privacy}","received_events_url":"https://api.github.com/users/chewbranca/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-11T17:48:45Z","updated_at":"2021-08-11T17:48:45Z","author_association":"CONTRIBUTOR","body":"> 😲\r\n> \r\n> Nice find! Did this one show up in production?\r\n\r\n@kocolosk Thanks! I happened to stumble upon it while looking at other `erlang:send_after` patterns in the codebase hahahha.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/897026292/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/898405413","html_url":"https://github.com/apache/couchdb/issues/2146#issuecomment-898405413","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2146","id":898405413,"node_id":"IC_kwDOAAMmUc41jJQl","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-13T11:55:03Z","updated_at":"2021-08-13T11:55:03Z","author_association":"CONTRIBUTOR","body":"Should we close this bug? Since  the fix is available.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/898405413/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/898407740","html_url":"https://github.com/apache/couchdb/issues/2146#issuecomment-898407740","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2146","id":898407740,"node_id":"IC_kwDOAAMmUc41jJ08","user":{"login":"sztanyoo","id":1235564,"node_id":"MDQ6VXNlcjEyMzU1NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1235564?v=4","gravatar_id":"","url":"https://api.github.com/users/sztanyoo","html_url":"https://github.com/sztanyoo","followers_url":"https://api.github.com/users/sztanyoo/followers","following_url":"https://api.github.com/users/sztanyoo/following{/other_user}","gists_url":"https://api.github.com/users/sztanyoo/gists{/gist_id}","starred_url":"https://api.github.com/users/sztanyoo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sztanyoo/subscriptions","organizations_url":"https://api.github.com/users/sztanyoo/orgs","repos_url":"https://api.github.com/users/sztanyoo/repos","events_url":"https://api.github.com/users/sztanyoo/events{/privacy}","received_events_url":"https://api.github.com/users/sztanyoo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-13T11:59:16Z","updated_at":"2021-08-13T11:59:16Z","author_association":"NONE","body":"For me it's fine. Thanks.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/898407740/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/900394603","html_url":"https://github.com/apache/couchdb/issues/2603#issuecomment-900394603","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2603","id":900394603,"node_id":"IC_kwDOAAMmUc41qu5r","user":{"login":"git-AlexS","id":40857602,"node_id":"MDQ6VXNlcjQwODU3NjAy","avatar_url":"https://avatars.githubusercontent.com/u/40857602?v=4","gravatar_id":"","url":"https://api.github.com/users/git-AlexS","html_url":"https://github.com/git-AlexS","followers_url":"https://api.github.com/users/git-AlexS/followers","following_url":"https://api.github.com/users/git-AlexS/following{/other_user}","gists_url":"https://api.github.com/users/git-AlexS/gists{/gist_id}","starred_url":"https://api.github.com/users/git-AlexS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/git-AlexS/subscriptions","organizations_url":"https://api.github.com/users/git-AlexS/orgs","repos_url":"https://api.github.com/users/git-AlexS/repos","events_url":"https://api.github.com/users/git-AlexS/events{/privacy}","received_events_url":"https://api.github.com/users/git-AlexS/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-17T15:24:00Z","updated_at":"2021-08-17T15:24:00Z","author_association":"NONE","body":"Same problem here, also struggling to solve this any way other than setting the environment variables. Why is this issue closed? Isn't it preferable to use the in-built password hashing in the .ini files? ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/900394603/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/900562109","html_url":"https://github.com/apache/couchdb/pull/3701#issuecomment-900562109","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3701","id":900562109,"node_id":"IC_kwDOAAMmUc41rXy9","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-17T19:11:44Z","updated_at":"2021-08-17T19:11:44Z","author_association":"MEMBER","body":"hm, not sure here. the _show / _list / _update handlers exist to allow users to decide their own semantics, so allowing any http method for _update makes sense (e.g, PATCH). \r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/900562109/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/900562387","html_url":"https://github.com/apache/couchdb/pull/3701#issuecomment-900562387","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3701","id":900562387,"node_id":"IC_kwDOAAMmUc41rX3T","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-17T19:12:13Z","updated_at":"2021-08-17T19:12:13Z","author_association":"MEMBER","body":"\"any except GET\", rather.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/900562387/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/900630192","html_url":"https://github.com/apache/couchdb/pull/3701#issuecomment-900630192","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3701","id":900630192,"node_id":"IC_kwDOAAMmUc41roaw","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-17T21:06:11Z","updated_at":"2021-08-17T21:06:11Z","author_association":"CONTRIBUTOR","body":"Added a comment related to this on the docs PR https://github.com/apache/couchdb-documentation/pull/674#issuecomment-900463236","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/900630192/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/900754570","html_url":"https://github.com/apache/couchdb/pull/3701#issuecomment-900754570","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3701","id":900754570,"node_id":"IC_kwDOAAMmUc41sGyK","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-18T02:02:49Z","updated_at":"2021-08-18T02:04:02Z","author_association":"CONTRIBUTOR","body":"> hm, not sure here. the _show / _list / _update handlers exist to allow users to decide their own semantics, so allowing any http method for _update makes sense (e.g, PATCH).\r\n\r\n@rnewson if that's the intention, the documentation doesn't make it clear, since it specifies [PUT](https://docs.couchdb.org/en/latest/api/ddoc/render.html#put--db-_design-ddoc-_update-func-docid) and [POST](https://docs.couchdb.org/en/latest/api/ddoc/render.html#post--db-_design-ddoc-_update-func), but no others. So, maybe we just need to improve the docs?\r\n\r\nCan you point to where in the documentation it says that users are allowed to decide their own semantics?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/900754570/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/901202086","html_url":"https://github.com/apache/couchdb/pull/3701#issuecomment-901202086","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3701","id":901202086,"node_id":"IC_kwDOAAMmUc41t0Cm","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-18T15:17:37Z","updated_at":"2021-08-18T15:17:37Z","author_association":"MEMBER","body":"In this case I think the docs are wrong.\r\n\r\nI don't think changing the behaviour of _update is warranted without a major version bump unless there is a security issue at play here that has not yet been mentioned.\r\n\r\nAs _update handlers go away in the next version (4.0) I think, at most, a doc fix is appropriate, not a compatibility-breaking change.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/901202086/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/901202474","html_url":"https://github.com/apache/couchdb/pull/3701#issuecomment-901202474","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3701","id":901202474,"node_id":"IC_kwDOAAMmUc41t0Iq","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-18T15:18:05Z","updated_at":"2021-08-18T15:18:05Z","author_association":"MEMBER","body":"-1.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/901202474/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/901358564","html_url":"https://github.com/apache/couchdb/pull/3701#issuecomment-901358564","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3701","id":901358564,"node_id":"IC_kwDOAAMmUc41uaPk","user":{"login":"jaydoane","id":51209,"node_id":"MDQ6VXNlcjUxMjA5","avatar_url":"https://avatars.githubusercontent.com/u/51209?v=4","gravatar_id":"","url":"https://api.github.com/users/jaydoane","html_url":"https://github.com/jaydoane","followers_url":"https://api.github.com/users/jaydoane/followers","following_url":"https://api.github.com/users/jaydoane/following{/other_user}","gists_url":"https://api.github.com/users/jaydoane/gists{/gist_id}","starred_url":"https://api.github.com/users/jaydoane/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaydoane/subscriptions","organizations_url":"https://api.github.com/users/jaydoane/orgs","repos_url":"https://api.github.com/users/jaydoane/repos","events_url":"https://api.github.com/users/jaydoane/events{/privacy}","received_events_url":"https://api.github.com/users/jaydoane/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-18T19:05:23Z","updated_at":"2021-08-18T19:05:23Z","author_association":"CONTRIBUTOR","body":"> As _update handlers go away in the next version (4.0) I think, at most, a doc fix is appropriate, not a compatibility-breaking change.\r\n\r\nAh, I was not aware update functions are deprecated! Unlike [list](https://docs.couchdb.org/en/latest/api/ddoc/render.html#db-design-design-doc-list-list-name-view-name) and [show](https://docs.couchdb.org/en/latest/api/ddoc/render.html#db-design-design-doc-show-show-name) functions, update functions are not currently annotaged as deprecated.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/901358564/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/901382535","html_url":"https://github.com/apache/couchdb/pull/3701#issuecomment-901382535","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3701","id":901382535,"node_id":"IC_kwDOAAMmUc41ugGH","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-18T19:44:55Z","updated_at":"2021-08-18T19:44:55Z","author_association":"MEMBER","body":"@janl double check me on _update deprecation?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/901382535/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/902281691","html_url":"https://github.com/apache/couchdb/pull/3617#issuecomment-902281691","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3617","id":902281691,"node_id":"IC_kwDOAAMmUc41x7nb","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-19T22:06:13Z","updated_at":"2021-08-19T22:06:13Z","author_association":"CONTRIBUTOR","body":"Thanks for your contribution. I wonder if we could just use a separate variable:\r\n\r\n```\r\n+# Use a separate var to work around rebar's mustache template bug\r\n+DEFAULT_FAUXTON_ROOT={{fauxton_root}}\r\n+export COUCHDB_FAUXTON_DOCROOT=\"${COUCHDB_FAUXTON_DOCROOT:-${DEFAULT_FAUXTON_ROOT}}\"\r\n```\r\n\r\nThat way we can keep the fauxton_root template var and don't have to add slashes to the end.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/902281691/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/902437641","html_url":"https://github.com/apache/couchdb/pull/3617#issuecomment-902437641","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3617","id":902437641,"node_id":"IC_kwDOAAMmUc41yhsJ","user":{"login":"sklassen","id":6997477,"node_id":"MDQ6VXNlcjY5OTc0Nzc=","avatar_url":"https://avatars.githubusercontent.com/u/6997477?v=4","gravatar_id":"","url":"https://api.github.com/users/sklassen","html_url":"https://github.com/sklassen","followers_url":"https://api.github.com/users/sklassen/followers","following_url":"https://api.github.com/users/sklassen/following{/other_user}","gists_url":"https://api.github.com/users/sklassen/gists{/gist_id}","starred_url":"https://api.github.com/users/sklassen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sklassen/subscriptions","organizations_url":"https://api.github.com/users/sklassen/orgs","repos_url":"https://api.github.com/users/sklassen/repos","events_url":"https://api.github.com/users/sklassen/events{/privacy}","received_events_url":"https://api.github.com/users/sklassen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-20T05:16:27Z","updated_at":"2021-08-20T05:16:27Z","author_association":"CONTRIBUTOR","body":"Super. Yes, that is a clever idea.\n\nOn Fri, 20 Aug 2021, 06:06 Nick Vatamaniuc, ***@***.***>\nwrote:\n\n> Thanks for your contribution. I wonder if we could just use a separate\n> variable:\n>\n> +# Use a separate var to work around rebar's mustache template bug\n> +DEFAULT_FAUXTON_ROOT={{fauxton_root}}\n> +export COUCHDB_FAUXTON_DOCROOT=\"${COUCHDB_FAUXTON_DOCROOT:-${DEFAULT_FAUXTON_ROOT}}\"\n>\n> That way we can keep the fauxton_root template var and don't have to add\n> slashes to the end.\n>\n> —\n> You are receiving this because you authored the thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/apache/couchdb/pull/3617#issuecomment-902281691>, or\n> unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/ABVMLZKPEPFN64P2XQ6YMGDT5V557ANCNFSM46O3R4HQ>\n> .\n> Triage notifications on the go with GitHub Mobile for iOS\n> <https://apps.apple.com/app/apple-store/id1477376905?ct=notification-email&mt=8&pt=524675>\n> or Android\n> <https://play.google.com/store/apps/details?id=com.github.android&utm_campaign=notification-email>\n> .\n>\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/902437641/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/902445232","html_url":"https://github.com/apache/couchdb/pull/3184#issuecomment-902445232","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3184","id":902445232,"node_id":"IC_kwDOAAMmUc41yjiw","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-20T05:38:43Z","updated_at":"2021-08-20T05:38:43Z","author_association":"CONTRIBUTOR","body":"I'll merge it since it got a green pass on CI","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/902445232/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/902794106","html_url":"https://github.com/apache/couchdb/pull/3617#issuecomment-902794106","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3617","id":902794106,"node_id":"IC_kwDOAAMmUc41z4t6","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-20T15:59:26Z","updated_at":"2021-08-20T15:59:26Z","author_association":"CONTRIBUTOR","body":"PR with a default var fix https://github.com/apache/couchdb/pull/3708","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/902794106/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/902806961","html_url":"https://github.com/apache/couchdb/pull/3617#issuecomment-902806961","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3617","id":902806961,"node_id":"IC_kwDOAAMmUc41z72x","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-20T16:19:31Z","updated_at":"2021-08-20T16:19:31Z","author_association":"CONTRIBUTOR","body":"Merged the PR with the default var fix.\r\n\r\nClosing this one","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/902806961/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/903036800","html_url":"https://github.com/apache/couchdb/issues/3704#issuecomment-903036800","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3704","id":903036800,"node_id":"IC_kwDOAAMmUc410z-A","user":{"login":"eiri","id":70542,"node_id":"MDQ6VXNlcjcwNTQy","avatar_url":"https://avatars.githubusercontent.com/u/70542?v=4","gravatar_id":"","url":"https://api.github.com/users/eiri","html_url":"https://github.com/eiri","followers_url":"https://api.github.com/users/eiri/followers","following_url":"https://api.github.com/users/eiri/following{/other_user}","gists_url":"https://api.github.com/users/eiri/gists{/gist_id}","starred_url":"https://api.github.com/users/eiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eiri/subscriptions","organizations_url":"https://api.github.com/users/eiri/orgs","repos_url":"https://api.github.com/users/eiri/repos","events_url":"https://api.github.com/users/eiri/events{/privacy}","received_events_url":"https://api.github.com/users/eiri/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-21T02:02:58Z","updated_at":"2021-08-21T02:46:22Z","author_association":"MEMBER","body":"Hi @zhangjingcat \r\n\r\nYour guess about the root cause is correct, CouchDB does not automatically rebalance data on a new joined node, you'll need to update db's meta and sync shards manually, as described in [shard management](https://docs.couchdb.org/en/stable/cluster/sharding.html#moving-a-shard) section of the documentation.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/903036800/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/903046746","html_url":"https://github.com/apache/couchdb/issues/3704#issuecomment-903046746","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3704","id":903046746,"node_id":"IC_kwDOAAMmUc4102Za","user":{"login":"eiri","id":70542,"node_id":"MDQ6VXNlcjcwNTQy","avatar_url":"https://avatars.githubusercontent.com/u/70542?v=4","gravatar_id":"","url":"https://api.github.com/users/eiri","html_url":"https://github.com/eiri","followers_url":"https://api.github.com/users/eiri/followers","following_url":"https://api.github.com/users/eiri/following{/other_user}","gists_url":"https://api.github.com/users/eiri/gists{/gist_id}","starred_url":"https://api.github.com/users/eiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eiri/subscriptions","organizations_url":"https://api.github.com/users/eiri/orgs","repos_url":"https://api.github.com/users/eiri/repos","events_url":"https://api.github.com/users/eiri/events{/privacy}","received_events_url":"https://api.github.com/users/eiri/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-21T03:22:22Z","updated_at":"2021-08-21T03:22:22Z","author_association":"MEMBER","body":"I realize that the process in the documentation is somehow involved, so I did a quick practical write up on the whole procedure: https://gist.github.com/eiri/2efc1b0ef401a21c51cd534871c20d30#file-readme-md\r\n\r\nI hope it'll be helpful.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/903046746/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/903367004","html_url":"https://github.com/apache/couchdb/issues/3704#issuecomment-903367004","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3704","id":903367004,"node_id":"IC_kwDOAAMmUc412Elc","user":{"login":"zhangjingcat","id":17232084,"node_id":"MDQ6VXNlcjE3MjMyMDg0","avatar_url":"https://avatars.githubusercontent.com/u/17232084?v=4","gravatar_id":"","url":"https://api.github.com/users/zhangjingcat","html_url":"https://github.com/zhangjingcat","followers_url":"https://api.github.com/users/zhangjingcat/followers","following_url":"https://api.github.com/users/zhangjingcat/following{/other_user}","gists_url":"https://api.github.com/users/zhangjingcat/gists{/gist_id}","starred_url":"https://api.github.com/users/zhangjingcat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhangjingcat/subscriptions","organizations_url":"https://api.github.com/users/zhangjingcat/orgs","repos_url":"https://api.github.com/users/zhangjingcat/repos","events_url":"https://api.github.com/users/zhangjingcat/events{/privacy}","received_events_url":"https://api.github.com/users/zhangjingcat/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-23T00:58:12Z","updated_at":"2021-08-23T00:58:12Z","author_association":"NONE","body":"> I realize that the process in the documentation is somehow involved, so I did a quick practical write up on the whole procedure: https://gist.github.com/eiri/2efc1b0ef401a21c51cd534871c20d30#file-readme-md\r\n> \r\n> I hope it'll be helpful.\r\n\r\nHi Eiri,\r\n\r\nThank you a lot for your kind reply!\r\nThe guide helped us a lot : )","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/903367004/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904550385","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-904550385","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":904550385,"node_id":"IC_kwDOAAMmUc416lfx","user":{"login":"konrad-ohms","id":40577406,"node_id":"MDQ6VXNlcjQwNTc3NDA2","avatar_url":"https://avatars.githubusercontent.com/u/40577406?v=4","gravatar_id":"","url":"https://api.github.com/users/konrad-ohms","html_url":"https://github.com/konrad-ohms","followers_url":"https://api.github.com/users/konrad-ohms/followers","following_url":"https://api.github.com/users/konrad-ohms/following{/other_user}","gists_url":"https://api.github.com/users/konrad-ohms/gists{/gist_id}","starred_url":"https://api.github.com/users/konrad-ohms/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/konrad-ohms/subscriptions","organizations_url":"https://api.github.com/users/konrad-ohms/orgs","repos_url":"https://api.github.com/users/konrad-ohms/repos","events_url":"https://api.github.com/users/konrad-ohms/events{/privacy}","received_events_url":"https://api.github.com/users/konrad-ohms/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-24T11:18:28Z","updated_at":"2021-08-24T11:36:08Z","author_association":"NONE","body":"Thanks @nickva and sorry for my delayed response, it took me a while to gather the right data to check if that change would be feasible for our application code.\r\n\r\nTLDR: The proposed solution works and is about 130 times faster on the given dataset, that are great results, thanks so much for your input :-)\r\n\r\n## View adjustments\r\n\r\nI tried to use the build-in reducers for a small set of documents on CouchDB 3.\r\n\r\nFor the testing out your proposal, I created 7 documents, all shared the same aDefId to return one single reduced output object. I have one document per execution result and an additional document which executed successful to be able to check the computation.\r\n\r\nThe original view was using this map function:\r\n\r\n```javascript\r\nfunction (doc) {\r\n    if(doc.object === \"ainst\" && doc.result) {\r\n        var subscription = doc.subscription || doc.tenant;\r\n        var stats = {\r\n            successfulCount : 0,\r\n            failedCount : 0,\r\n            canceledCount : 0,\r\n            executingCount : 0,\r\n            unsuccessfulCount : 0,\r\n            unknownCount : 0,\r\n            totalCount : 1,\r\n            execTimeSum : 0,\r\n            execTimeCount : 0,\r\n            execTimeMin : Infinity,\r\n            execTimeMax : 0\r\n        }\r\n\r\n        if (doc.result.status === \"successful\") {\r\n            stats.successfulCount = 1;\r\n\r\n            if (doc.result.executionTime) {\r\n                stats.execTimeSum = doc.result.executionTime;\r\n                stats.execTimeCount = 1;\r\n                stats.execTimeMin = doc.result.executionTime;\r\n                stats.execTimeMax = doc.result.executionTime;\r\n            }\r\n        } else if (doc.result.status === \"failed\") {\r\n            stats.failedCount = 1;\r\n        } else if (doc.result.status === \"canceled\") {\r\n            stats.canceledCount = 1;\r\n        } else if (doc.result.status === \"executing\") {\r\n            stats.executingCount = 1;\r\n        } else if (doc.result.status === \"unsuccessful\") {\r\n            stats.unsuccessfulCount = 1;\r\n        } else if (doc.result.status === \"unknown\") {\r\n            stats.unknownCount = 1;\r\n        }\r\n\r\n        emit([subscription, doc.aDefId], stats);\r\n    }\r\n}\r\n```\r\n\r\nand the following custom reduce function:\r\n\r\n```javascript\r\nfunction (keys, values, rereduce) {\r\n    var stats = {\r\n        successfulCount : 0,\r\n        failedCount : 0,\r\n        canceledCount : 0,\r\n        executingCount : 0,\r\n        unsuccessfulCount : 0,\r\n        unknownCount : 0,\r\n        totalCount : 0,\r\n        execTimeSum : 0,\r\n        execTimeCount : 0,\r\n        execTimeMin : Infinity,\r\n        execTimeMax : 0\r\n    }\r\n\r\n    for (var index in values) {\r\n        stats.successfulCount += values[index].successfulCount;\r\n        stats.failedCount += values[index].failedCount;\r\n        stats.canceledCount += values[index].canceledCount;\r\n        stats.executingCount += values[index].executingCount;\r\n        stats.unsuccessfulCount += values[index].unsuccessfulCount;\r\n        stats.unknownCount += values[index].unknownCount;\r\n        stats.totalCount += values[index].totalCount;\r\n        if (values[index].execTimeCount) {\r\n            stats.execTimeSum += values[index].execTimeSum;\r\n            stats.execTimeCount += values[index].execTimeCount;\r\n            stats.execTimeMin = Math.min(stats.execTimeMin, values[index].execTimeMin);\r\n            stats.execTimeMax = Math.max(stats.execTimeMax, values[index].execTimeMax);\r\n        }\r\n    }\r\n\r\n    return stats;\r\n}\r\n```\r\n\r\nThe original view returned the following as response which I will use to validate the result of the following adjustments:\r\n\r\n```bash\r\n$ curl -ksu \"admin:password\" \"http://localhost:3003/demo2/_design/demo/_view/slow?reduce=true&group=true\" | jq \".\"\r\n{\r\n  \"rows\": [\r\n    {\r\n      \"key\": [\r\n        \"xxx\",\r\n        \"135600b7487db5804c1961408a115e0270e5\"\r\n      ],\r\n      \"value\": {\r\n        \"successfulCount\": 2,\r\n        \"failedCount\": 1,\r\n        \"canceledCount\": 1,\r\n        \"executingCount\": 1,\r\n        \"unsuccessfulCount\": 1,\r\n        \"unknownCount\": 1,\r\n        \"totalCount\": 7,\r\n        \"execTimeSum\": 1557,\r\n        \"execTimeCount\": 2,\r\n        \"execTimeMin\": 200,\r\n        \"execTimeMax\": 1357\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nAs you mentioned, the build-in _sum reducer can be used to count different executions in a single view.\r\n\r\nThis is my updated demo-build-in-reduce/count view:\r\n\r\n```javascript\r\nfunction (doc) {\r\n    if(doc.object === \"ainst\" && doc.result) {\r\n        var subscription = doc.subscription || doc.tenant;\r\n        var stats = {\r\n            successfulCount : 0,\r\n            failedCount : 0,\r\n            canceledCount : 0,\r\n            executingCount : 0,\r\n            unsuccessfulCount : 0,\r\n            unknownCount : 0,\r\n            totalCount : 1\r\n        }\r\n\r\n        if (doc.result.status === \"successful\") {\r\n            stats.successfulCount = 1;\r\n        } else if (doc.result.status === \"failed\") {\r\n            stats.failedCount = 1;\r\n        } else if (doc.result.status === \"canceled\") {\r\n            stats.canceledCount = 1;\r\n        } else if (doc.result.status === \"executing\") {\r\n            stats.executingCount = 1;\r\n        } else if (doc.result.status === \"unsuccessful\") {\r\n            stats.unsuccessfulCount = 1;\r\n        } else if (doc.result.status === \"unknown\") {\r\n            stats.unknownCount = 1;\r\n        }\r\n\r\n        emit([subscription, doc.aDefId], stats);\r\n    }\r\n}\r\n```\r\n\r\nThe reduce function is set to _sum on that view.\r\n\r\nWhen I query that view, I get results as expected for the counts:\r\n\r\n```bash\r\n$ curl -ksu \"admin:password\" \"http://localhost:3003/demo2/_design/demo-build-in-reduce/_view/count?reduce=true&group=true\" | jq \".\"\r\n{\r\n  \"rows\": [\r\n    {\r\n      \"key\": [\r\n        \"xxx\",\r\n        \"135600b7487db5804c1961408a115e0270e5\"\r\n      ],\r\n      \"value\": {\r\n        \"canceledCount\": 1,\r\n        \"executingCount\": 1,\r\n        \"failedCount\": 1,\r\n        \"successfulCount\": 2,\r\n        \"totalCount\": 7,\r\n        \"unknownCount\": 1,\r\n        \"unsuccessfulCount\": 1\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nThe response looks good, but as expected is lacking the execution time stats. This can be done with a second view which I named demo-build-in-reduce/successfulExecutionTime.\r\n\r\nThe second view returns the following:\r\n\r\n```bash\r\n$ curl -ksu \"admin:password\" \"http://localhost:3003/demo2/_design/demo-build-in-reduce/_view/successfulExecutionTime?reduce=true&group=true\" | jq \".\"\r\n{\r\n  \"rows\": [\r\n    {\r\n      \"key\": [\r\n        \"xxx\",\r\n        \"135600b7487db5804c1961408a115e0270e5\"\r\n      ],\r\n      \"value\": {\r\n        \"sum\": 1557,\r\n        \"count\": 2,\r\n        \"min\": 200,\r\n        \"max\": 1357,\r\n        \"sumsqr\": 1881449\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nThis looks good either, I do not care for the sumsqr, but for sum, count, min and max. The count is also included in the demo-build-in-reduce/count view, which can be used in the application theoretically to render a more high level view of data. The successfulExecutionTime view is providing the other data.\r\n\r\nSo, your proposal works for the given data model, thank you very much. The downside is that to keep our API compatible, we need to submit two requests concurrently instead of using the single original view. Nevertheless, the performance is way more consistent, let me share a few measurements based on the new views.\r\n\r\n\r\n## Test setup to measure performance improvements of the new implementation\r\n\r\nI used the initial setup script to deploy both CouchDBs and to load data.\r\nAfterwards I injected the design doc into the demo database:\r\n\r\n```bash\r\n$ curl -X POST \\\r\n    \"http://admin:password@localhost:3003/demo\" \\\r\n    -H \"Content-Type: application/json\" \\\r\n    -d '{\r\n        \"_id\": \"_design/demo-build-in-reduce\",\r\n        \"views\": {\r\n            \"count\": {\r\n            \"reduce\": \"_sum\",\r\n            \"map\": \"function (doc) {\\n                if(doc.object === \\\"ainst\\\" && doc.result) {\\n                    var subscription = doc.subscription || doc.tenant;\\n                    var stats = {\\n                        successfulCount : 0,\\n                        failedCount : 0,\\n                        canceledCount : 0,\\n                        executingCount : 0,\\n                        unsuccessfulCount : 0,\\n                        unknownCount : 0,\\n                        totalCount : 1\\n                    }\\n\\n                    if (doc.result.status === \\\"successful\\\") {\\n                        stats.successfulCount = 1;\\n                    } else if (doc.result.status === \\\"failed\\\") {\\n                        stats.failedCount = 1;\\n                    } else if (doc.result.status === \\\"canceled\\\") {\\n                        stats.canceledCount = 1;\\n                    } else if (doc.result.status === \\\"executing\\\") {\\n                        stats.executingCount = 1;\\n                    } else if (doc.result.status === \\\"unsuccessful\\\") {\\n                        stats.unsuccessfulCount = 1;\\n                    } else if (doc.result.status === \\\"unknown\\\") {\\n                        stats.unknownCount = 1;\\n                    }\\n\\n                    emit([subscription, doc.aDefId], stats);\\n                }\\n            }\"\r\n            },\r\n            \"successfulExecutionTime\": {\r\n            \"reduce\": \"_stats\",\r\n            \"map\": \"function (doc) {\\n    if(doc.object === \\\"ainst\\\" && doc.result && doc.result.status === \\\"successful\\\") {\\n        var subscription = doc.subscription || doc.tenant;\\n        emit([subscription, doc.aDefId], doc.result.executionTime);\\n    }\\n}\"\r\n            }\r\n        },\r\n        \"language\": \"javascript\"\r\n    }'\r\n{\"ok\":true,\"id\":\"_design/demo-build-in-reduce\",\"rev\":\"1-e769ee9d7efdeb5f80075e16a1113968\"}\r\n```\r\n\r\nI used the following Node.js script to query data and combine them within the application.\r\n[reducers-demo.zip](https://github.com/apache/couchdb/files/7038700/reducers-demo.zip)\r\n\r\n```javascript\r\n'use strict';\r\nconst parallel = require('async').parallel;\r\nconst http = require('http');\r\nconst user = 'admin';\r\nconst password = 'password';\r\nconst port = 3003;\r\nconst dbname = 'demo';\r\n\r\nlet newRequest = (async () => {\r\n    console.log(\"==================== New approach ====================\");\r\n    for( let i=1; i<=10; i++) {\r\n        console.log(`===== Iteration ${i} ======`);\r\n        console.time(`Fast iteration ${i} took`);\r\n        let responseMapCount = {};\r\n        let responseMapSuccessfulExecutionTime = {};\r\n        await parallel([\r\n            (cb) => {\r\n                let currentUrl = `http://${user}:${password}@localhost:${port}/${dbname}/_design/demo-build-in-reduce/_view/count?reduce=true&group=true`;\r\n                console.log(`Requesting: ${currentUrl}`)\r\n                let req = http.get(currentUrl, (res) => {\r\n                    console.log('statusCode:', res.statusCode);\r\n                  \r\n                    let body = \"\"\r\n                    res.on('data', (d) => {\r\n                        body += d;\r\n                    });\r\n                    res.on('end', function () {\r\n                        // store rows in map to combine them after http requests are completed\r\n                        body = JSON.parse(body);\r\n                        body.rows.forEach(currentRow => {\r\n                            responseMapCount[currentRow.key.join('-')] = currentRow.value;\r\n                        });\r\n                        cb()\r\n                    });\r\n                }).on('error', (e) => {\r\n                    console.error(e);\r\n                    cb(e);\r\n                });\r\n                req.end();\r\n            },\r\n            (cb) => {\r\n                let currentUrl = `http://${user}:${password}@localhost:${port}/${dbname}/_design/demo-build-in-reduce/_view/successfulExecutionTime?reduce=true&group=true`;\r\n                console.log(`Requesting: ${currentUrl}`)\r\n                let req = http.get(currentUrl, (res) => {\r\n                    console.log('statusCode:', res.statusCode);\r\n                  \r\n                    let body = '';\r\n                    res.on('data', (d) => {\r\n                        body += d;\r\n                    });\r\n                    res.on('end', function () {\r\n                        // store rows in map to combine them after http requests are completed\r\n                        body = JSON.parse(body);\r\n                        body.rows.forEach(currentRow => {\r\n                            responseMapSuccessfulExecutionTime[currentRow.key.join('-')] = currentRow.value;\r\n                        });\r\n                        cb()\r\n                    });\r\n                }).on('error', (e) => {\r\n                    console.error(e);\r\n                    cb(e);\r\n                });\r\n                req.end();\r\n            }\r\n        ]);\r\n        console.log(`Combining results`);\r\n        // iterate over responseMapCount, as there is always an entry for every ainst result\r\n        let lastMergedKey;\r\n        Object.keys(responseMapCount).forEach((currentKey) => {\r\n            // check if the aInst result had a successful invocation, merge it back in that case\r\n            if(responseMapSuccessfulExecutionTime[currentKey]) {\r\n                // merge second result property back into responseMapCount\r\n                responseMapCount[currentKey].execTimeSum = responseMapSuccessfulExecutionTime[currentKey].sum;\r\n                responseMapCount[currentKey].execTimeMin = responseMapSuccessfulExecutionTime[currentKey].min;\r\n                responseMapCount[currentKey].execTimeMax = responseMapSuccessfulExecutionTime[currentKey].max;\r\n            }\r\n        });\r\n        console.log(`Example combined result for aDefId=100200b7487db5804c1961408a115e0270e5: ${JSON.stringify(responseMapCount['xxx-100200b7487db5804c1961408a115e0270e5'], null, 4)}`)\r\n        console.timeEnd(`Fast iteration ${i} took`);\r\n    }\r\n});\r\n\r\nlet oldRequest = (async () => {\r\n    console.log(\"==================== Old approach ====================\");\r\n    for( let i=1; i<=10; i++) {\r\n        console.log(`===== Iteration ${i} ======`);\r\n        console.time(`Slow iteration ${i} took`);\r\n        let results = await parallel([\r\n            (cb) => {\r\n                let currentUrl = `http://${user}:${password}@localhost:${port}/${dbname}/_design/demo/_view/slow?reduce=true&group=true`;\r\n                console.log(`Requesting: ${currentUrl}`)\r\n                let req = http.get(currentUrl, (res) => {\r\n                    console.log('statusCode:', res.statusCode);\r\n                  \r\n                    let body = ''\r\n                    res.on('data', (d) => {\r\n                        body += d;\r\n                    });\r\n                    res.on('end', function () {\r\n                        body = JSON.parse(body);\r\n                        cb(null, body);\r\n                    });\r\n                }).on('error', (e) => {\r\n                    console.error(e);\r\n                    cb(e);\r\n                });\r\n                req.end();\r\n            }\r\n        ]);\r\n        console.log(`Result for aDefId=100200b7487db5804c1961408a115e0270e5:`);\r\n        // the view could have been invoked directly with the key, but all results should be retrieved to measure the performance\r\n        // only a single result is picked to compare those are equal in both query approaches. \r\n        results[0].rows.forEach((currentRow) => {\r\n            if(currentRow.key[1] === '100200b7487db5804c1961408a115e0270e5') {\r\n                console.log(JSON.stringify(currentRow.value, null, 4));\r\n            }\r\n        })\r\n        console.timeEnd(`Slow iteration ${i} took`);\r\n    }\r\n});\r\n\r\n(async () => {\r\n    await newRequest();\r\n    await oldRequest();\r\n})()\r\n```\r\n\r\nThe output shows an impressive difference, even if the application logic gets more complicated (full output: [couchdb3-test-output.txt](https://github.com/apache/couchdb/files/7038811/couchdb3-test-output.txt)):\r\n\r\n```bash\r\n==================== New approach ====================\r\n===== Iteration 1 ======\r\nRequesting: http://admin:password@localhost:3003/demo/_design/demo-build-in-reduce/_view/count?reduce=true&group=true\r\nRequesting: http://admin:password@localhost:3003/demo/_design/demo-build-in-reduce/_view/successfulExecutionTime?reduce=true&group=true\r\nstatusCode: 200\r\nstatusCode: 200\r\nCombining results\r\nExample combined result for aDefId=100200b7487db5804c1961408a115e0270e5: {\r\n    \"canceledCount\": 1,\r\n    \"executingCount\": 1,\r\n    \"failedCount\": 1,\r\n    \"successfulCount\": 1,\r\n    \"totalCount\": 6,\r\n    \"unknownCount\": 1,\r\n    \"unsuccessfulCount\": 1,\r\n    \"execTimeSum\": 1002,\r\n    \"execTimeMin\": 1002,\r\n    \"execTimeMax\": 1002\r\n}\r\nFast iteration 1 took: 270.495ms\r\n...\r\n==================== Old approach ====================\r\n===== Iteration 1 ======\r\nRequesting: http://admin:password@localhost:3003/demo/_design/demo/_view/slow?reduce=true&group=true\r\nstatusCode: 200\r\nResult for aDefId=100200b7487db5804c1961408a115e0270e5:\r\n{\r\n    \"successfulCount\": 1,\r\n    \"failedCount\": 1,\r\n    \"canceledCount\": 1,\r\n    \"executingCount\": 1,\r\n    \"unsuccessfulCount\": 1,\r\n    \"unknownCount\": 1,\r\n    \"totalCount\": 6,\r\n    \"execTimeSum\": 1002,\r\n    \"execTimeCount\": 1,\r\n    \"execTimeMin\": 1002,\r\n    \"execTimeMax\": 1002\r\n}\r\nSlow iteration 1 took: 34.973s\r\n...\r\n```\r\n\r\n## Conclusion\r\nOn average (10 iterations), I could get combined results of all records within 274 ms compared to 35714 ms, so the workaround on my given dataset is actually ~ 130 times faster.\r\n\r\nI repeated the test for CouchDB 2 as well ([couchdb2-test-output](https://github.com/apache/couchdb/files/7038776/output2.txt)) and got an average of 447 ms with the new approach compared to 6917 ms which is still more than 15 times faster. So independent on the question if we should migrate to CouchDB 3 or not, it might still be a useful optimization also for CouchDB 2 setups.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904550385/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904691017","html_url":"https://github.com/apache/couchdb/issues/3692#issuecomment-904691017","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3692","id":904691017,"node_id":"IC_kwDOAAMmUc417H1J","user":{"login":"eiri","id":70542,"node_id":"MDQ6VXNlcjcwNTQy","avatar_url":"https://avatars.githubusercontent.com/u/70542?v=4","gravatar_id":"","url":"https://api.github.com/users/eiri","html_url":"https://github.com/eiri","followers_url":"https://api.github.com/users/eiri/followers","following_url":"https://api.github.com/users/eiri/following{/other_user}","gists_url":"https://api.github.com/users/eiri/gists{/gist_id}","starred_url":"https://api.github.com/users/eiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eiri/subscriptions","organizations_url":"https://api.github.com/users/eiri/orgs","repos_url":"https://api.github.com/users/eiri/repos","events_url":"https://api.github.com/users/eiri/events{/privacy}","received_events_url":"https://api.github.com/users/eiri/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-24T14:26:10Z","updated_at":"2021-08-24T14:26:10Z","author_association":"MEMBER","body":"I was able to reproduce this on both `latest` docker's image for `couch:3` and on a `HEAD` of `3.x` branch. A bit to pay attention here is that this is happening only on _reused_ connection (curl's `-:` flag), while sequential calls to attachment delete and then db info query are returning fine.\r\n\r\nAnother note is that `Transfer-Encoding: chunked` is a bit of a red-herring, the same hanging connection can be induced even without it when payload body on attachment delete request is larger than 0, in other words this is an issue of delete operation not properly draining and discarding request payload.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904691017/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904741147","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-904741147","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":904741147,"node_id":"IC_kwDOAAMmUc417UEb","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-24T15:24:56Z","updated_at":"2021-08-24T15:24:56Z","author_association":"CONTRIBUTOR","body":"Excellent write-up, @konrad-ohms. Thank you for getting back to us and sharing the results. 130x speedup is not something we see every day!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904741147/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904846319","html_url":"https://github.com/apache/couchdb/issues/3709#issuecomment-904846319","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3709","id":904846319,"node_id":"IC_kwDOAAMmUc417tvv","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-24T17:43:14Z","updated_at":"2021-08-24T17:43:14Z","author_association":"MEMBER","body":"Please try re-running `curl https://couchdb.apache.org/repo/keys.asc | gpg --dearmor | sudo tee /usr/share/keyrings/couchdb-archive-keyring.gpg` (without the `>/dev/null 2>&1`) and look for any error.\r\n\r\nAfter that, try again a `apt update`.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904846319/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904860303","html_url":"https://github.com/apache/couchdb/issues/3709#issuecomment-904860303","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3709","id":904860303,"node_id":"IC_kwDOAAMmUc417xKP","user":{"login":"teknari","id":31591435,"node_id":"MDQ6VXNlcjMxNTkxNDM1","avatar_url":"https://avatars.githubusercontent.com/u/31591435?v=4","gravatar_id":"","url":"https://api.github.com/users/teknari","html_url":"https://github.com/teknari","followers_url":"https://api.github.com/users/teknari/followers","following_url":"https://api.github.com/users/teknari/following{/other_user}","gists_url":"https://api.github.com/users/teknari/gists{/gist_id}","starred_url":"https://api.github.com/users/teknari/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/teknari/subscriptions","organizations_url":"https://api.github.com/users/teknari/orgs","repos_url":"https://api.github.com/users/teknari/repos","events_url":"https://api.github.com/users/teknari/events{/privacy}","received_events_url":"https://api.github.com/users/teknari/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-24T18:04:50Z","updated_at":"2021-08-24T18:04:50Z","author_association":"NONE","body":"I ran it without the `>/dev/null 2>&1`\r\n\r\nIt ran apparently without errors. I got this first:\r\n\r\n> curl https://couchdb.apache.org/repo/keys.asc | gpg --dearmor | sudo tee /usr/share/keyrings/couchdb-archive-keyring.gpg\r\n>   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n>                                  Dload  Upload   Total   Spent    Left  Speed\r\n>   0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:100  3882  100  3882    0     0  73245      0 --:--:-- --:--:-- --:--:-- 73245\r\n\r\nThen a bunch of binary gibberish with this in the middle of it:\r\n\r\n> The Apache Software Foundation (Package repository signing key) <root@apache.org>\r\n\r\n\r\nNo apparent error, but when I run `sudo apt update` I get the same:\r\n\r\n> \r\n> sudo apt update\r\n> Hit:1 http://mirrors.linode.com/debian buster InRelease\r\n> Hit:2 http://mirrors.linode.com/debian-security buster/updates InRelease\r\n> Hit:3 http://mirrors.linode.com/debian buster-updates InRelease\r\n> Get:4 https://apache.jfrog.io/artifactory/couchdb-deb buster InRelease [5,151 B]\r\n> Err:4 https://apache.jfrog.io/artifactory/couchdb-deb buster InRelease\r\n>   The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 0EE62FB37A00258D\r\n> Reading package lists... Done\r\n> W: GPG error: https://apache.jfrog.io/artifactory/couchdb-deb buster InRelease: The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 0EE62FB37A00258D\r\n> E: The repository 'https://apache.jfrog.io/artifactory/couchdb-deb buster InRelease' is not signed.\r\n> N: Updating from such a repository can't be done securely, and is therefore disabled by default.\r\n> N: See apt-secure(8) manpage for repository creation and user configuration details.\r\n\r\nIf I go and take a look in the keyring folder, it looks like it is in there:\r\n\r\n> teknari@tekdallas:~$ cd /usr/share/keyrings/\r\n> teknari@tekdallas:/usr/share/keyrings$ ls\r\n> couchdb-archive-keyring.gpg\r\n> debian-archive-bullseye-automatic.gpg\r\n> debian-archive-bullseye-security-automatic.gpg\r\n> debian-archive-bullseye-stable.gpg\r\n> debian-archive-buster-automatic.gpg\r\n> debian-archive-buster-security-automatic.gpg\r\n> debian-archive-buster-stable.gpg\r\n> debian-archive-keyring.gpg\r\n> debian-archive-removed-keys.gpg\r\n> debian-archive-stretch-automatic.gpg\r\n> debian-archive-stretch-security-automatic.gpg\r\n> debian-archive-stretch-stable.gpg\r\n\r\nAnd when I take a look in the sources.list.d\r\n\r\n> teknari@tekdallas:/etc/apt/sources.list.d$ ls\r\n> couchdb.list\r\n> teknari@tekdallas:/etc/apt/sources.list.d$ sudo cat couchdb.list \r\n> deb [signed-by=/usr/share/keyrings/couchdb-archive-keyring.gpg] https://apache.jfrog.io/artifactory/couchdb-deb/ buster main\r\n> teknari@tekdallas:/etc/apt/sources.list.d$ \r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904860303/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904870660","html_url":"https://github.com/apache/couchdb/issues/3709#issuecomment-904870660","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3709","id":904870660,"node_id":"IC_kwDOAAMmUc417zsE","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-24T18:20:37Z","updated_at":"2021-08-24T18:20:37Z","author_association":"MEMBER","body":"I just took a brand new Debian Buster install and can confirm the instructions work, from scratch. There must be something wrong with your install.\r\n\r\nConverting to a peer-support topic as the installation system does seem to work correctly.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904870660/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904881246","html_url":"https://github.com/apache/couchdb/issues/3704#issuecomment-904881246","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3704","id":904881246,"node_id":"IC_kwDOAAMmUc4172Re","user":{"login":"eiri","id":70542,"node_id":"MDQ6VXNlcjcwNTQy","avatar_url":"https://avatars.githubusercontent.com/u/70542?v=4","gravatar_id":"","url":"https://api.github.com/users/eiri","html_url":"https://github.com/eiri","followers_url":"https://api.github.com/users/eiri/followers","following_url":"https://api.github.com/users/eiri/following{/other_user}","gists_url":"https://api.github.com/users/eiri/gists{/gist_id}","starred_url":"https://api.github.com/users/eiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eiri/subscriptions","organizations_url":"https://api.github.com/users/eiri/orgs","repos_url":"https://api.github.com/users/eiri/repos","events_url":"https://api.github.com/users/eiri/events{/privacy}","received_events_url":"https://api.github.com/users/eiri/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-24T18:37:21Z","updated_at":"2021-08-24T18:37:21Z","author_association":"MEMBER","body":"@zhangjingcat Glad to hear that. I'm going to close this issue then.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/904881246/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/905412556","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-905412556","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":905412556,"node_id":"IC_kwDOAAMmUc4193_M","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-25T11:22:48Z","updated_at":"2021-08-25T11:22:48Z","author_association":"MEMBER","body":"I’ve attempted a quick demo that caches the transpilation inside the JS process, this would still do one transpile per couchjs process, but should still be a lot better.\r\n\r\n@konrad-ohms or @nickva would you be able to retry this with the original setup?\r\n\r\n```\r\ndiff --git a/share/server/60/rewrite_fun.js b/share/server/60/rewrite_fun.js\r\nindex 1b27a9d14..9b85f953f 100644\r\n--- a/share/server/60/rewrite_fun.js\r\n+++ b/share/server/60/rewrite_fun.js\r\n@@ -15,30 +15,39 @@\r\n //\r\n //  https://github.com/dmunch/couch-chakra/blob/master/js/normalizeFunction.js\r\n \r\n+\r\n+const cache = {}\r\n function rewriteFunInt(fun) {\r\n-    const ast = esprima.parse(fun);\r\n-    let idx = ast.body.length - 1;\r\n-    let decl = {};\r\n-\r\n-    // Search for the first FunctionDeclaration beginning from the end\r\n-    do {\r\n-        decl = ast.body[idx--];\r\n-    } while (idx >= 0 && decl.type !== \"FunctionDeclaration\");\r\n-    idx++;\r\n-\r\n-    // If we have a function declaration without an Id, wrap it\r\n-    // in an ExpressionStatement and change it into\r\n-    // a FuntionExpression\r\n-    if (decl.type == \"FunctionDeclaration\" && decl.id == null) {\r\n-        decl.type = \"FunctionExpression\";\r\n-        ast.body[idx] = {\r\n-            type: \"ExpressionStatement\",\r\n-            expression: decl\r\n-        };\r\n-    }\r\n+    const crc = crc32_str(fun)\r\n+    if (cache[crc]) {\r\n+        return cache[crc];\r\n+    } else {\r\n+        const ast = esprima.parse(fun);\r\n+        let idx = ast.body.length - 1;\r\n+        let decl = {};\r\n+\r\n+        // Search for the first FunctionDeclaration beginning from the end\r\n+        do {\r\n+            decl = ast.body[idx--];\r\n+        } while (idx >= 0 && decl.type !== \"FunctionDeclaration\");\r\n+        idx++;\r\n+\r\n+        // If we have a function declaration without an Id, wrap it\r\n+        // in an ExpressionStatement and change it into\r\n+        // a FuntionExpression\r\n+        if (decl.type == \"FunctionDeclaration\" && decl.id == null) {\r\n+            decl.type = \"FunctionExpression\";\r\n+            ast.body[idx] = {\r\n+                type: \"ExpressionStatement\",\r\n+                expression: decl\r\n+            };\r\n+        }\r\n \r\n-    // Generate source from the rewritten AST\r\n-    return escodegen.generate(ast);\r\n+        // Generate source from the rewritten AST\r\n+        const gen = escodegen.generate(ast);\r\n+        cache[crc] = gen;\r\n+        return gen;\r\n+    }\r\n }\r\n \r\n \r\n@@ -53,4 +62,51 @@ function rewriteFuns(funsJSON) {\r\n         return rewriteFunInt(fun);\r\n     });\r\n     return JSON.stringify(results);\r\n-}\r\n\\ No newline at end of file\r\n+}\r\n+\r\n+// nicked from https://github.com/SheetJS/js-crc32/blob/master/crc32.js\r\n+\r\n+function signed_crc_table() {\r\n+\tvar c = 0, table = new Array(256);\r\n+\r\n+\tfor(var n =0; n != 256; ++n){\r\n+\t\tc = n;\r\n+\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n+\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n+\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n+\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n+\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n+\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n+\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n+\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n+\t\ttable[n] = c;\r\n+\t}\r\n+\r\n+\treturn typeof Int32Array !== 'undefined' ? new Int32Array(table) : table;\r\n+}\r\n+\r\n+var T = signed_crc_table();\r\n+\r\n+function crc32_str(str, seed) {\r\n+\tvar C = seed ^ -1;\r\n+\tfor(var i = 0, L=str.length, c, d; i < L;) {\r\n+\t\tc = str.charCodeAt(i++);\r\n+\t\tif(c < 0x80) {\r\n+\t\t\tC = (C>>>8) ^ T[(C ^ c)&0xFF];\r\n+\t\t} else if(c < 0x800) {\r\n+\t\t\tC = (C>>>8) ^ T[(C ^ (192|((c>>6)&31)))&0xFF];\r\n+\t\t\tC = (C>>>8) ^ T[(C ^ (128|(c&63)))&0xFF];\r\n+\t\t} else if(c >= 0xD800 && c < 0xE000) {\r\n+\t\t\tc = (c&1023)+64; d = str.charCodeAt(i++)&1023;\r\n+\t\t\tC = (C>>>8) ^ T[(C ^ (240|((c>>8)&7)))&0xFF];\r\n+\t\t\tC = (C>>>8) ^ T[(C ^ (128|((c>>2)&63)))&0xFF];\r\n+\t\t\tC = (C>>>8) ^ T[(C ^ (128|((d>>6)&15)|((c&3)<<4)))&0xFF];\r\n+\t\t\tC = (C>>>8) ^ T[(C ^ (128|(d&63)))&0xFF];\r\n+\t\t} else {\r\n+\t\t\tC = (C>>>8) ^ T[(C ^ (224|((c>>12)&15)))&0xFF];\r\n+\t\t\tC = (C>>>8) ^ T[(C ^ (128|((c>>6)&63)))&0xFF];\r\n+\t\t\tC = (C>>>8) ^ T[(C ^ (128|(c&63)))&0xFF];\r\n+\t\t}\r\n+\t}\r\n+\treturn C ^ -1;\r\n+}\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/905412556/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/905792881","html_url":"https://github.com/apache/couchdb/pull/3712#issuecomment-905792881","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3712","id":905792881,"node_id":"IC_kwDOAAMmUc41_U1x","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-25T18:58:25Z","updated_at":"2021-08-25T18:58:25Z","author_association":"CONTRIBUTOR","body":"The following patch also fixing the problem \r\n\r\n```\r\ndiff --git a/src/chttpd/src/chttpd.erl b/src/chttpd/src/chttpd.erl\r\nindex 8fd05597d..5562ec402 100644\r\n--- a/src/chttpd/src/chttpd.erl\r\n+++ b/src/chttpd/src/chttpd.erl\r\n@@ -261,6 +261,7 @@ handle_request_int(MochiReq) ->\r\n         reason = Reason\r\n     },\r\n\r\n+    mochiweb_request:cleanup(MochiReq),\r\n     case after_request(HttpReq2, HttpResp) of\r\n         #httpd_resp{status = ok, response = Resp} ->\r\n             {ok, Resp};\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/905792881/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/905947459","html_url":"https://github.com/apache/couchdb/issues/3713#issuecomment-905947459","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3713","id":905947459,"node_id":"IC_kwDOAAMmUc41_6lD","user":{"login":"vgfl","id":33558508,"node_id":"MDQ6VXNlcjMzNTU4NTA4","avatar_url":"https://avatars.githubusercontent.com/u/33558508?v=4","gravatar_id":"","url":"https://api.github.com/users/vgfl","html_url":"https://github.com/vgfl","followers_url":"https://api.github.com/users/vgfl/followers","following_url":"https://api.github.com/users/vgfl/following{/other_user}","gists_url":"https://api.github.com/users/vgfl/gists{/gist_id}","starred_url":"https://api.github.com/users/vgfl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vgfl/subscriptions","organizations_url":"https://api.github.com/users/vgfl/orgs","repos_url":"https://api.github.com/users/vgfl/repos","events_url":"https://api.github.com/users/vgfl/events{/privacy}","received_events_url":"https://api.github.com/users/vgfl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-25T23:42:31Z","updated_at":"2021-08-25T23:42:31Z","author_association":"NONE","body":"Of course it's not just update, installation fails too.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/905947459/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/905947929","html_url":"https://github.com/apache/couchdb/issues/3713#issuecomment-905947929","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3713","id":905947929,"node_id":"IC_kwDOAAMmUc41_6sZ","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-25T23:43:56Z","updated_at":"2021-08-25T23:43:56Z","author_association":"CONTRIBUTOR","body":"bintray has been discontinued. Please use the instructions on https://docs.couchdb.org/en/stable/install/unix.html to set up the jfrog repository.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/905947929/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906411618","html_url":"https://github.com/apache/couchdb/pull/3712#issuecomment-906411618","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3712","id":906411618,"node_id":"IC_kwDOAAMmUc42Br5i","user":{"login":"eiri","id":70542,"node_id":"MDQ6VXNlcjcwNTQy","avatar_url":"https://avatars.githubusercontent.com/u/70542?v=4","gravatar_id":"","url":"https://api.github.com/users/eiri","html_url":"https://github.com/eiri","followers_url":"https://api.github.com/users/eiri/followers","following_url":"https://api.github.com/users/eiri/following{/other_user}","gists_url":"https://api.github.com/users/eiri/gists{/gist_id}","starred_url":"https://api.github.com/users/eiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eiri/subscriptions","organizations_url":"https://api.github.com/users/eiri/orgs","repos_url":"https://api.github.com/users/eiri/repos","events_url":"https://api.github.com/users/eiri/events{/privacy}","received_events_url":"https://api.github.com/users/eiri/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-26T13:24:59Z","updated_at":"2021-08-26T13:24:59Z","author_association":"MEMBER","body":"@iilyak They are not the same. Consider following (important parts in bold):\r\n\r\nWith my patch:\r\n<pre>\r\n$ curl -q -s -v -u *:* http://127.0.0.1:15984/koi/doc/att?rev=2-a85de97b9bf75058156d7872a4bc3b89 -X DELETE -H 'Content-Type: application/json' -d '{\"oh\", \"hi\"}' --next -s -v http://127.0.0.1:15984 | jq '.'\r\n*   Trying 127.0.0.1...\r\n* TCP_NODELAY set\r\n* Connected to 127.0.0.1 (127.0.0.1) port 15984 (#0)\r\n* Server auth using Basic with user ***\r\n> DELETE /koi/doc/att?rev=2-a85de97b9bf75058156d7872a4bc3b89 HTTP/1.1\r\n> Host: 127.0.0.1:15984\r\n> Authorization: ***\r\n> User-Agent: curl/7.64.1\r\n> Accept: */*\r\n> Content-Type: application/json\r\n> Content-Length: 12\r\n>\r\n} [12 bytes data]\r\n* upload completely sent off: 12 out of 12 bytes\r\n< HTTP/1.1 200 OK\r\n< Cache-Control: must-revalidate\r\n< Content-Length: 66\r\n< Content-Type: application/json\r\n< Date: Thu, 26 Aug 2021 12:47:00 GMT\r\n< Server: CouchDB/3.1.1-dirty (Erlang OTP/22)\r\n< X-Couch-Request-ID: edbe14f280\r\n< X-CouchDB-Body-Time: 0\r\n<\r\n{ [66 bytes data]\r\n<strong>* Connection #0 to host 127.0.0.1 left intact</strong>\r\n*{\r\n Found bundle for host 127.0.0.1: 0x7fe3f03056a0 [can pipeline]\r\n*  \"ok\": true,\r\n Could pipeline, but not asked to!\r\n  \"id\": \"doc\",\r\n  \"rev\": \"3-bb43bd1ff8645e9544c8d0700b474337\"\r\n}\r\n<strong> * Re-using existing connection! (#0) with host 127.0.0.1</strong>\r\n* Connected to 127.0.0.1 (127.0.0.1) port 15984 (#0)\r\n> GET / HTTP/1.1\r\n> Host: 127.0.0.1:15984\r\n> User-Agent: curl/7.64.1\r\n> Accept: */*\r\n>\r\n< HTTP/1.1 200 OK\r\n...\r\n</pre>\r\n\r\nWith this patch:\r\n<pre>\r\ncurl -q -s -v -u *:* http://127.0.0.1:15984/koi/doc/att?rev=2-a85de97b9bf75058156d7872a4bc3b89 -X DELETE -H 'Content-Type: application/json' -d '{\"oh\", \"hi\"}' --next -s -v http://127.0.0.1:15984 | jq '.'\r\n*   Trying 127.0.0.1...\r\n* TCP_NODELAY set\r\n* Connected to 127.0.0.1 (127.0.0.1) port 15984 (#0)\r\n* Server auth using Basic with user ***\r\n> DELETE /koi/doc/att?rev=2-a85de97b9bf75058156d7872a4bc3b89 HTTP/1.1\r\n> Host: 127.0.0.1:15984\r\n> Authorization: Basic ***\r\n> User-Agent: curl/7.64.1\r\n> Accept: */*\r\n> Content-Type: application/json\r\n> Content-Length: 12\r\n>\r\n} [12 bytes data]\r\n* upload completely sent off: 12 out of 12 bytes\r\n< HTTP/1.1 200 OK\r\n< Cache-Control: must-revalidate\r\n< Content-Length: 66\r\n< Content-Type: application/json\r\n< Date: Thu, 26 Aug 2021 12:50:02 GMT\r\n< Server: CouchDB/3.1.1-dirty (Erlang OTP/22)\r\n< X-Couch-Request-ID: c5a76b2209\r\n< X-CouchDB-Body-Time: 0\r\n<\r\n{ [66 bytes data]\r\n<strong>* Connection #0 to host 127.0.0.1 left intact</strong>\r\n* Found bundle for host 127.0.0.1: 0x7fa78f0056a0 [can pipeline]\r\n* Could pipeline, but not asked to!\r\n{\r\n  \"ok\": true,\r\n  \"id\": \"doc\",\r\n  \"rev\": \"3-bb43bd1ff8645e9544c8d0700b474337\"\r\n}\r\n* Re-using existing connection! (#0) with host 127.0.0.1\r\n* Connected to 127.0.0.1 (127.0.0.1) port 15984 (#0)\r\n> GET / HTTP/1.1\r\n> Host: 127.0.0.1:15984\r\n> User-Agent: curl/7.64.1\r\n> Accept: */*\r\n>\r\n<strong>* Recv failure: Connection reset by peer\r\n* Connection died, retrying a fresh connect\r\n* Closing connection 0\r\n* Issue another request to this URL: 'http://127.0.0.1:15984/'</strong>\r\n* Hostname 127.0.0.1 was found in DNS cache\r\n*   Trying 127.0.0.1...\r\n* TCP_NODELAY set\r\n* Connected to 127.0.0.1 (127.0.0.1) port 15984 (#1)\r\n> GET / HTTP/1.1\r\n> Host: 127.0.0.1:15984\r\n> User-Agent: curl/7.64.1\r\n> Accept: */*\r\n>\r\n< HTTP/1.1 200 OK\r\n</pre>\r\nSo this effectively kills keep-alive capability for all requests to Couch API.\r\n\r\nWhich is kind of expected, because as I read it `mochiweb_request:cleanup/1` is a hack around mochiweb's proc dicts poor-man's state machine of request life-cycle that was added to _implement_ keep-alive in [here](https://github.com/apache/couchdb-mochiweb/blob/main/src/mochiweb_http.erl#L216) by erasing all flags and immediately restarting req loop. So if we clean the flags outside of req lifecycle it's not surprising for it to break.\r\n\r\nThis is why I rather wary about extending scope for this PR to _all_ http requests handling, we can subtly degrade our http stack and I don't trust our CI to catch it all.\r\n\r\nAnother thing to consider that just dropping dict flags without draining payload leaving garbage in socket buffer till the socket closed, i.e. leaking memory a bit.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906411618/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906500952","html_url":"https://github.com/apache/couchdb/issues/3692#issuecomment-906500952","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3692","id":906500952,"node_id":"IC_kwDOAAMmUc42CBtY","user":{"login":"eiri","id":70542,"node_id":"MDQ6VXNlcjcwNTQy","avatar_url":"https://avatars.githubusercontent.com/u/70542?v=4","gravatar_id":"","url":"https://api.github.com/users/eiri","html_url":"https://github.com/eiri","followers_url":"https://api.github.com/users/eiri/followers","following_url":"https://api.github.com/users/eiri/following{/other_user}","gists_url":"https://api.github.com/users/eiri/gists{/gist_id}","starred_url":"https://api.github.com/users/eiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eiri/subscriptions","organizations_url":"https://api.github.com/users/eiri/orgs","repos_url":"https://api.github.com/users/eiri/repos","events_url":"https://api.github.com/users/eiri/events{/privacy}","received_events_url":"https://api.github.com/users/eiri/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-26T15:13:30Z","updated_at":"2021-08-26T15:13:30Z","author_association":"MEMBER","body":"Fixed in #3712 ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906500952/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906552956","html_url":"https://github.com/apache/couchdb/issues/3603#issuecomment-906552956","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3603","id":906552956,"node_id":"IC_kwDOAAMmUc42COZ8","user":{"login":"eiri","id":70542,"node_id":"MDQ6VXNlcjcwNTQy","avatar_url":"https://avatars.githubusercontent.com/u/70542?v=4","gravatar_id":"","url":"https://api.github.com/users/eiri","html_url":"https://github.com/eiri","followers_url":"https://api.github.com/users/eiri/followers","following_url":"https://api.github.com/users/eiri/following{/other_user}","gists_url":"https://api.github.com/users/eiri/gists{/gist_id}","starred_url":"https://api.github.com/users/eiri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eiri/subscriptions","organizations_url":"https://api.github.com/users/eiri/orgs","repos_url":"https://api.github.com/users/eiri/repos","events_url":"https://api.github.com/users/eiri/events{/privacy}","received_events_url":"https://api.github.com/users/eiri/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-26T16:16:49Z","updated_at":"2021-08-26T16:16:49Z","author_association":"MEMBER","body":"All right, so the strange part is that I can reproduce this on `couchdb:3` docker image with the following ddoc, but can't reproduce when I'm building from repo's `3.x` branch (nor from tag `3.1.1`) and changing `dev/run`'s `.ini` configs to match docker's.\r\n\r\nFile: `alpha.json`\r\n```json\r\n{\r\n    \"indexes\": {\r\n        \"searchindex001\": {\r\n            \"index\": \"function(doc) { index(\\\"default\\\", doc._id); }\"\r\n        }\r\n    }\r\n}\r\n``` \r\n\r\nAgainst docker:\r\n```\r\n$ curl -q -K .curlrc http://127.0.0.1:15984/koi -X PUT\r\n{\"ok\":true}\r\n\r\n$ curl -q -K .curlrc http://127.0.0.1:15984/koi -X POST -d '{\"name\": \"Alice\", \"number\": 42}'\r\n{\"ok\":true,\"id\":\"d9d564521ee139ec83134600f4000e0f\",\"rev\":\"1-7b54ca479c9043f8cc4cd83777ce6b75\"}\r\n\r\n$ curl -q -K .curlrc http://127.0.0.1:15984/koi/_design/alpha -X PUT --data @alpha.json\r\n{\"ok\":true,\"id\":\"_design/alpha\",\"rev\":\"1-b445a33cf17da10d2f2502f68f58462b\"}\r\n\r\n$ curl -q -K .curlrc http://127.0.0.1:15984/koi/_design/alpha/_search/searchindex001 -X POST -d '{\"query\": \"name:Alice*\"}'\r\n{\"error\":\"{badarg,[{erlang,monitor,[process,{main,'clouseau@127.0.0.1'}],[]},\\n         {ioq,submit_request,2,[{file,\\\"src/ioq.erl\\\"},{line,187}]},\\n         {ioq,maybe_submit_request,1,[{file,\\\"src/ioq.erl\\\"},{line,150}]},\\n         {ioq,handle_info,2,[{file,\\\"src/ioq.erl\\\"},{line,123}]},\\n         {gen_server,try_dispatch,4,[{file,\\\"gen_server.erl\\\"},{line,616}]},\\n         {gen_server,handle_msg,6,[{file,\\\"gen_server.erl\\\"},{line,686}]},\\n         {proc_lib,init_p_do_apply,3,[{file,\\\"proc_lib.erl\\\"},{line,247}]}]}\",\"reason\":\"{gen_server,call,\\n            [ioq,\\n             {request,<0.286.0>,{pread_iolist,4490},other,<0.435.0>,undefined},\\n             infinity]}\",\"ref\":2383229562}\r\n```\r\n\r\nAgainst repo:\r\n```\r\n$ curl -q -K .curlrc http://127.0.0.1:15984/koi -X PUT\r\n{\"ok\":true}\r\n\r\n$ curl -q -K .curlrc http://127.0.0.1:15984/koi -X POST -d '{\"name\": \"Alice\", \"number\": 42}'\r\n{\"ok\":true,\"id\":\"d9d564521ee139ec83134600f4000e0f\",\"rev\":\"1-7b54ca479c9043f8cc4cd83777ce6b75\"}\r\n\r\n$ curl -q -K .curlrc http://127.0.0.1:15984/koi/_design/alpha -X PUT --data @alpha.json\r\n{\"ok\":true,\"id\":\"_design/alpha\",\"rev\":\"1-b445a33cf17da10d2f2502f68f58462b\"}\r\n\r\n$ curl -q -K .curlrc http://127.0.0.1:15984/koi/_design/alpha/_search/searchindex001 -X POST -d '{\"query\": \"name:Alice*\"}'\r\n{\"error\":\"ou_est_clouseau\",\"reason\":\"Could not connect to the Clouseau Java service at clouseau@127.0.0.1\"}\r\n```\r\n\r\nSince `HEAD` behaves as expected with `ou_est_clouseau` error, I suspect this is some kind of configuration issue, but I can't figure out values in `ini` config to reproduce it.\r\n\r\nIf anyone will manage to induce this locally in dev environment, please leave steps in a comment.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906552956/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906670629","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-906670629","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":906670629,"node_id":"IC_kwDOAAMmUc42CrIl","user":{"login":"konrad-ohms","id":40577406,"node_id":"MDQ6VXNlcjQwNTc3NDA2","avatar_url":"https://avatars.githubusercontent.com/u/40577406?v=4","gravatar_id":"","url":"https://api.github.com/users/konrad-ohms","html_url":"https://github.com/konrad-ohms","followers_url":"https://api.github.com/users/konrad-ohms/followers","following_url":"https://api.github.com/users/konrad-ohms/following{/other_user}","gists_url":"https://api.github.com/users/konrad-ohms/gists{/gist_id}","starred_url":"https://api.github.com/users/konrad-ohms/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/konrad-ohms/subscriptions","organizations_url":"https://api.github.com/users/konrad-ohms/orgs","repos_url":"https://api.github.com/users/konrad-ohms/repos","events_url":"https://api.github.com/users/konrad-ohms/events{/privacy}","received_events_url":"https://api.github.com/users/konrad-ohms/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-26T19:08:57Z","updated_at":"2021-08-26T19:08:57Z","author_association":"NONE","body":"Thank you @janl for your code change. I will try to compare the performance of your change within the test suite above, I try to fit that in next week.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906670629/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906754022","html_url":"https://github.com/apache/couchdb/issues/3603#issuecomment-906754022","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3603","id":906754022,"node_id":"IC_kwDOAAMmUc42C_fm","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-26T21:25:23Z","updated_at":"2021-08-26T21:25:23Z","author_association":"MEMBER","body":"Intriguing! I think I figured it out. The difference is that the `couchdb:3` container is configured without any node name and is not running in distributed mode. In that mode trying to monitor the remote Clouseau process triggers a badarg error:\r\n\r\n```\r\n# /opt/couchdb/erts-9.3.3.14/bin/erl -boot /opt/couchdb/releases/3.1.1/start_clean\r\nErlang/OTP 20 [erts-9.3.3.14] [source] [64-bit] [smp:8:8] [ds:8:8:10] [async-threads:10] [hipe] [kernel-poll:false]\r\n\r\nEshell V9.3.3.14  (abort with ^G)\r\n1> erlang:monitor(process, {main, 'clouseau@127.0.0.1'}).\r\n** exception error: bad argument\r\n     in function  monitor/2\r\n        called as monitor(process,{main,'clouseau@127.0.0.1'})\r\n```\r\n\r\nwhereas in dev mode we are running a CouchDB Erlang node and the behavior changes to deliver a 'DOWN` message to the mailbox:\r\n\r\n```\r\n# /opt/couchdb/erts-9.3.3.14/bin/erl -boot /opt/couchdb/releases/3.1.1/start_clean -name test@127.0.0.1\r\nErlang/OTP 20 [erts-9.3.3.14] [source] [64-bit] [smp:8:8] [ds:8:8:10] [async-threads:10] [hipe] [kernel-poll:false]\r\n\r\nEshell V9.3.3.14  (abort with ^G)\r\n(test@127.0.0.1)1> erlang:monitor(process, {main, 'clouseau@127.0.0.1'}).\r\n#Ref<0.2127152124.2865758209.248364>\r\n(test@127.0.0.1)2> receive M -> M end.\r\n{'DOWN',#Ref<0.2127152124.2865758209.248364>,process,\r\n        {main,'clouseau@127.0.0.1'},\r\n        noconnection}\r\n(test@127.0.0.1)3> \r\n```\r\n\r\nNot sure offhand what the right fix is here. Seems like we ought to be able to run gracefully without the Erlang distribution, although it's news to me that the Docker image is configured that way.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906754022/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906901215","html_url":"https://github.com/apache/couchdb/issues/3603#issuecomment-906901215","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3603","id":906901215,"node_id":"IC_kwDOAAMmUc42Djbf","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-27T03:42:53Z","updated_at":"2021-08-27T03:42:53Z","author_association":"MEMBER","body":"From the Docker container README:\r\n\r\n> CouchDB also uses `/opt/couchdb/etc/vm.args` to store Erlang runtime-specific changes. Changing these values is less common. If you need to change the epmd port, for instance, you will want to bind mount this file as well. (Note: files cannot be bind-mounted on Windows hosts.)\r\n\r\nand\r\n\r\n> NODENAME will set the name of the CouchDB node inside the container to couchdb@${NODENAME}, in the file /opt/couchdb/etc/vm.args. This is used for clustering purposes and can be ignored for single-node setups.\r\n\r\nTry setting `NODENAME`?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/906901215/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/907258177","html_url":"https://github.com/apache/couchdb/issues/3603#issuecomment-907258177","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3603","id":907258177,"node_id":"IC_kwDOAAMmUc42E6lB","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-27T14:47:34Z","updated_at":"2021-08-27T14:47:34Z","author_association":"MEMBER","body":"Hi @wohali yes, I can confirm that starting the container with a NODENAME specified restores the intended behavior. It just seems to me that we'd want to be better behaved inside CouchDB itself when running in non-distributed mode, but I'm not sure about the best way to effect that change.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/907258177/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/908209453","html_url":"https://github.com/apache/couchdb/issues/3576#issuecomment-908209453","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3576","id":908209453,"node_id":"IC_kwDOAAMmUc42Ii0t","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-30T09:59:00Z","updated_at":"2021-08-30T09:59:00Z","author_association":"MEMBER","body":"heya, I just want to clarify what you’re looking for here? `error,enospc` already says “there was an error, there is no more space on the filesystem”.\r\n\r\nDo you want this to say literally “there was an error, there is no more space on the filesystem”, or what are you asking for here?\r\n\r\nCouchDB can’t “handle” a full filesystem any better because it can’t write any data to disk","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/908209453/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/908210629","html_url":"https://github.com/apache/couchdb/issues/3562#issuecomment-908210629","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3562","id":908210629,"node_id":"IC_kwDOAAMmUc42IjHF","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-30T10:00:52Z","updated_at":"2021-08-30T10:00:52Z","author_association":"MEMBER","body":"for completeness sake, this is where documentation bug is: https://docs.couchdb.org/en/stable/ddocs/views/pagination.html#paging-alternate-method","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/908210629/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/908302248","html_url":"https://github.com/apache/couchdb/issues/3576#issuecomment-908302248","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3576","id":908302248,"node_id":"IC_kwDOAAMmUc42I5eo","user":{"login":"sergey-safarov","id":2562241,"node_id":"MDQ6VXNlcjI1NjIyNDE=","avatar_url":"https://avatars.githubusercontent.com/u/2562241?v=4","gravatar_id":"","url":"https://api.github.com/users/sergey-safarov","html_url":"https://github.com/sergey-safarov","followers_url":"https://api.github.com/users/sergey-safarov/followers","following_url":"https://api.github.com/users/sergey-safarov/following{/other_user}","gists_url":"https://api.github.com/users/sergey-safarov/gists{/gist_id}","starred_url":"https://api.github.com/users/sergey-safarov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sergey-safarov/subscriptions","organizations_url":"https://api.github.com/users/sergey-safarov/orgs","repos_url":"https://api.github.com/users/sergey-safarov/repos","events_url":"https://api.github.com/users/sergey-safarov/events{/privacy}","received_events_url":"https://api.github.com/users/sergey-safarov/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-30T12:30:04Z","updated_at":"2021-08-30T12:30:04Z","author_association":"NONE","body":"I mean:\r\n1) no all understand erlang error stack, some users may be stuck with this error;\r\n2) do not understand what is means `error,enospc` need some googling and manuals reading;\r\n3) when CouchDB has a lot of write operations, then this error flooding Linux host error log.\r\n\r\nWhat is prefer:\r\n1) on no free space error write to logs `no free space on database volume`;\r\n2) write this error message onece peer hour (30 min, 5 min) and write to log \"no free space error muted for 60 min\".\r\n\r\nThis will make error messages more user-friendly and do not flood the error log in the future.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/908302248/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/908352558","html_url":"https://github.com/apache/couchdb/issues/3576#issuecomment-908352558","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3576","id":908352558,"node_id":"IC_kwDOAAMmUc42JFwu","user":{"login":"iilyak","id":9804420,"node_id":"MDQ6VXNlcjk4MDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9804420?v=4","gravatar_id":"","url":"https://api.github.com/users/iilyak","html_url":"https://github.com/iilyak","followers_url":"https://api.github.com/users/iilyak/followers","following_url":"https://api.github.com/users/iilyak/following{/other_user}","gists_url":"https://api.github.com/users/iilyak/gists{/gist_id}","starred_url":"https://api.github.com/users/iilyak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iilyak/subscriptions","organizations_url":"https://api.github.com/users/iilyak/orgs","repos_url":"https://api.github.com/users/iilyak/repos","events_url":"https://api.github.com/users/iilyak/events{/privacy}","received_events_url":"https://api.github.com/users/iilyak/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-30T13:40:26Z","updated_at":"2021-08-30T13:40:26Z","author_association":"CONTRIBUTOR","body":"> write this error message onece peer hour (30 min, 5 min) and write to log \"no free space error muted for 60 min\".\r\n\r\nTo implement it we would need to maintain a timestamp when the message was logged last time.\r\nWe don't have facility in the logger to log certain messages once in a given interval. The problem is a couch_file processes are independent for each database. So we cannot remove duplicates of the message across those processes. Also we terminate couch_file processes when needed which makes accounting for `last_time_logged` impossible (without using shared state).\r\n\r\nCouchDB project would benefit in few other places if we would implement log once facility in the logger.\r\nHowever implementation of this is not easy and would require:\r\n1.  porting https://github.com/apache/couchdb/pull/3526 to 3.x\r\n2. erlang upgrade to 21","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/908352558/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/909124414","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-909124414","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":909124414,"node_id":"IC_kwDOAAMmUc42MCM-","user":{"login":"konrad-ohms","id":40577406,"node_id":"MDQ6VXNlcjQwNTc3NDA2","avatar_url":"https://avatars.githubusercontent.com/u/40577406?v=4","gravatar_id":"","url":"https://api.github.com/users/konrad-ohms","html_url":"https://github.com/konrad-ohms","followers_url":"https://api.github.com/users/konrad-ohms/followers","following_url":"https://api.github.com/users/konrad-ohms/following{/other_user}","gists_url":"https://api.github.com/users/konrad-ohms/gists{/gist_id}","starred_url":"https://api.github.com/users/konrad-ohms/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/konrad-ohms/subscriptions","organizations_url":"https://api.github.com/users/konrad-ohms/orgs","repos_url":"https://api.github.com/users/konrad-ohms/repos","events_url":"https://api.github.com/users/konrad-ohms/events{/privacy}","received_events_url":"https://api.github.com/users/konrad-ohms/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-31T10:51:38Z","updated_at":"2021-08-31T10:53:18Z","author_association":"NONE","body":"Okay, I validated your fix, please find the outcome below:\r\n\r\n## Creating a custom build\r\nFirst, I wanted to create a patch build which is as close as possible to what I have tested before, so I used the same OS as in the container image I used initially:\r\n\r\n```bash\r\n$ podman run --rm -it docker.io/library/couchdb:3.1.1 cat /etc/os-release\r\nPRETTY_NAME=\"Debian GNU/Linux 10 (buster)\"\r\nNAME=\"Debian GNU/Linux\"\r\nVERSION_ID=\"10\"\r\nVERSION=\"10 (buster)\"\r\nVERSION_CODENAME=buster\r\nID=debian\r\nHOME_URL=\"https://www.debian.org/\"\r\nSUPPORT_URL=\"https://www.debian.org/support\"\r\nBUG_REPORT_URL=\"https://bugs.debian.org/\"\r\n```\r\n\r\nTo get a build env matching the OS and its required libraries, I had a look into <https://github.com/apache/couchdb-ci> and built the following image on an 18.04.5 LTS amd64 VM with Docker version 20.10.8, build 3967b7d:\r\n\r\n```bash\r\n$ git clone https://github.com/apache/couchdb-ci.git\r\nCloning into 'couchdb-ci'...\r\nremote: Enumerating objects: 1742, done.\r\nremote: Counting objects: 100% (87/87), done.\r\nremote: Compressing objects: 100% (58/58), done.\r\nremote: Total 1742 (delta 55), reused 56 (delta 29), pack-reused 1655\r\nReceiving objects: 100% (1742/1742), 10.24 MiB | 16.11 MiB/s, done.\r\nResolving deltas: 100% (998/998), done.\r\n$ cd couchdb-ci/\r\n$ ./build.sh platform debian-buster\r\n...\r\nSuccessfully built d1c29b763a2c\r\nSuccessfully tagged apache/couchdbci-debian:buster-erlang-20.3.8.26-1\r\n```\r\n\r\nFrom there I used CouchDB v3.1.1 and applied your patch within the container:\r\n\r\n```bash\r\n$ docker run --name couchdb-3.1.1-fix-validation -it apache/couchdbci-debian:buster-erlang-20.3.8.26-1\r\njenkins@2665e52069d0:/$ cd ~\r\njenkins@2665e52069d0:~$ whoami\r\njenkins\r\njenkins@2665e52069d0:~$ pwd\r\n/home/jenkins\r\njenkins@2665e52069d0:~$ git clone --depth=1 -b 3.1.1 https://github.com/apache/couchdb.git\r\nCloning into 'couchdb'...\r\nremote: Enumerating objects: 1207, done.\r\nremote: Counting objects: 100% (1207/1207), done.\r\nremote: Compressing objects: 100% (1099/1099), done.\r\nremote: Total 1207 (delta 245), reused 380 (delta 55), pack-reused 0\r\nReceiving objects: 100% (1207/1207), 1.80 MiB | 6.14 MiB/s, done.\r\nResolving deltas: 100% (245/245), done.\r\nNote: checking out 'ce596c65d9d7f0bc5d9937bcaf6253b343015690'.\r\n\r\nYou are in 'detached HEAD' state. You can look around, make experimental\r\nchanges and commit them, and you can discard any commits you make in this\r\nstate without impacting any branches by performing another checkout.\r\n\r\nIf you want to create a new branch to retain commits you create, you may\r\ndo so (now or later) by using -b with the checkout command again. Example:\r\n\r\n  git checkout -b <new-branch-name>\r\n\r\njenkins@2665e52069d0:~$ # Apply Jan's patch\r\njenkins@2665e52069d0:~$ cat <<'EOF' > jan.patch\r\n> diff --git a/share/server/60/rewrite_fun.js b/share/server/60/rewrite_fun.js\r\n> index 1b27a9d14..9b85f953f 100644\r\n> --- a/share/server/60/rewrite_fun.js\r\n> +++ b/share/server/60/rewrite_fun.js\r\n> @@ -15,30 +15,39 @@\r\n>  //\r\n>  //  https://github.com/dmunch/couch-chakra/blob/master/js/normalizeFunction.js\r\n>  \r\n> +\r\n> +const cache = {}\r\n>  function rewriteFunInt(fun) {\r\n> -    const ast = esprima.parse(fun);\r\n> -    let idx = ast.body.length - 1;\r\n> -    let decl = {};\r\n> -\r\n> -    // Search for the first FunctionDeclaration beginning from the end\r\n> -    do {\r\n> -        decl = ast.body[idx--];\r\n> -    } while (idx >= 0 && decl.type !== \"FunctionDeclaration\");\r\n> -    idx++;\r\n> -\r\n> -    // If we have a function declaration without an Id, wrap it\r\n> -    // in an ExpressionStatement and change it into\r\n> -    // a FuntionExpression\r\n> -    if (decl.type == \"FunctionDeclaration\" && decl.id == null) {\r\n> -        decl.type = \"FunctionExpression\";\r\n> -        ast.body[idx] = {\r\n> -            type: \"ExpressionStatement\",\r\n> -            expression: decl\r\n> -        };\r\n> -    }\r\n> +    const crc = crc32_str(fun)\r\n> +    if (cache[crc]) {\r\n> +        return cache[crc];\r\n> +    } else {\r\n> +        const ast = esprima.parse(fun);\r\n> +        let idx = ast.body.length - 1;\r\n> +        let decl = {};\r\n> +\r\n> +        // Search for the first FunctionDeclaration beginning from the end\r\n> +        do {\r\n> +            decl = ast.body[idx--];\r\n> +        } while (idx >= 0 && decl.type !== \"FunctionDeclaration\");\r\n> +        idx++;\r\n> +\r\n> +        // If we have a function declaration without an Id, wrap it\r\n> +        // in an ExpressionStatement and change it into\r\n> +        // a FuntionExpression\r\n> +        if (decl.type == \"FunctionDeclaration\" && decl.id == null) {\r\n> +            decl.type = \"FunctionExpression\";\r\n> +            ast.body[idx] = {\r\n> +                type: \"ExpressionStatement\",\r\n> +                expression: decl\r\n> +            };\r\n> +        }\r\n>  \r\n> -    // Generate source from the rewritten AST\r\n> -    return escodegen.generate(ast);\r\n> +        // Generate source from the rewritten AST\r\n> +        const gen = escodegen.generate(ast);\r\n> +        cache[crc] = gen;\r\n> +        return gen;\r\n> +    }\r\n>  }\r\n>  \r\n>  \r\n> @@ -53,4 +62,51 @@ function rewriteFuns(funsJSON) {\r\n>          return rewriteFunInt(fun);\r\n>      });\r\n>      return JSON.stringify(results);\r\n> -}\r\n> \\ No newline at end of file\r\n> +}\r\n> +\r\n> +// nicked from https://github.com/SheetJS/js-crc32/blob/master/crc32.js\r\n> +\r\n> +function signed_crc_table() {\r\n> +var c = 0, table = new Array(256);\r\n> +\r\n> +for(var n =0; n != 256; ++n){\r\n> +c = n;\r\n> +c = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n> +c = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n> +c = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n> +c = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n> +c = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n> +c = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n> +c = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n> +c = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\r\n> +table[n] = c;\r\n> +}\r\n> +\r\n> +return typeof Int32Array !== 'undefined' ? new Int32Array(table) : table;\r\n> +}\r\n> +\r\n> +var T = signed_crc_table();\r\n> +\r\n> +function crc32_str(str, seed) {\r\n> +var C = seed ^ -1;\r\n> +for(var i = 0, L=str.length, c, d; i < L;) {\r\n> +c = str.charCodeAt(i++);\r\n> +if(c < 0x80) {\r\n> +C = (C>>>8) ^ T[(C ^ c)&0xFF];\r\n> +} else if(c < 0x800) {\r\n> +C = (C>>>8) ^ T[(C ^ (192|((c>>6)&31)))&0xFF];\r\n> +C = (C>>>8) ^ T[(C ^ (128|(c&63)))&0xFF];\r\n> +} else if(c >= 0xD800 && c < 0xE000) {\r\n> +c = (c&1023)+64; d = str.charCodeAt(i++)&1023;\r\n> +C = (C>>>8) ^ T[(C ^ (240|((c>>8)&7)))&0xFF];\r\n> +C = (C>>>8) ^ T[(C ^ (128|((c>>2)&63)))&0xFF];\r\n> +C = (C>>>8) ^ T[(C ^ (128|((d>>6)&15)|((c&3)<<4)))&0xFF];\r\n> +C = (C>>>8) ^ T[(C ^ (128|(d&63)))&0xFF];\r\n> +} else {\r\n> +C = (C>>>8) ^ T[(C ^ (224|((c>>12)&15)))&0xFF];\r\n> +C = (C>>>8) ^ T[(C ^ (128|((c>>6)&63)))&0xFF];\r\n> +C = (C>>>8) ^ T[(C ^ (128|(c&63)))&0xFF];\r\n> +}\r\n> +}\r\n> +return C ^ -1;\r\n> +}\r\n> EOF\r\n\r\njenkins@2665e52069d0:~$ cd couchdb/\r\njenkins@2665e52069d0:~/couchdb$ git status\r\nNot currently on any branch.\r\nnothing to commit, working tree clean\r\njenkins@2665e52069d0:~/couchdb$ git checkout -b 3.1.1-patch-jan\r\nSwitched to a new branch '3.1.1-patch-jan'\r\njenkins@2665e52069d0:~/couchdb$ git apply ../jan.patch \r\njenkins@2665e52069d0:~/couchdb$ git status\r\nOn branch 3.1.1-patch-jan\r\nChanges not staged for commit:\r\n  (use \"git add <file>...\" to update what will be committed)\r\n  (use \"git checkout -- <file>...\" to discard changes in working directory)\r\n\r\n\tmodified:   share/server/60/rewrite_fun.js\r\n\r\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\r\n```\r\n\r\nAfterwards I compiled the source:\r\n\r\n```bash\r\njenkins@2665e52069d0:~/couchdb$ ./configure\r\n...\r\n==> couchdb (update-deps)\r\nUpdating config from {git,\"https://github.com/apache/couchdb-config.git\",\r\n                          {tag,\"2.1.7\"}}\r\nUpdating b64url from {git,\"https://github.com/apache/couchdb-b64url.git\",\r\n                          {tag,\"1.0.2\"}}\r\nUpdating ets_lru from {git,\"https://github.com/apache/couchdb-ets-lru.git\",\r\n                           {tag,\"1.1.0\"}}\r\nUpdating khash from {git,\"https://github.com/apache/couchdb-khash.git\",\r\n                         {tag,\"1.1.0\"}}\r\nUpdating snappy from {git,\"https://github.com/apache/couchdb-snappy.git\",\r\n                          {tag,\"CouchDB-1.0.4\"}}\r\nUpdating docs from {git,\"https://github.com/apache/couchdb-documentation\",\r\n                        {tag,\"3.1.1-RC2\"}}\r\nUpdating fauxton from {git,\"https://github.com/apache/couchdb-fauxton\",\r\n                           {tag,\"v1.2.6\"}}\r\nUpdating folsom from {git,\"https://github.com/apache/couchdb-folsom.git\",\r\n                          {tag,\"CouchDB-0.8.3\"}}\r\nUpdating hyper from {git,\"https://github.com/apache/couchdb-hyper.git\",\r\n                         {tag,\"CouchDB-2.2.0-6\"}}\r\nUpdating ibrowse from {git,\"https://github.com/apache/couchdb-ibrowse.git\",\r\n                           {tag,\"CouchDB-4.0.1-1\"}}\r\nUpdating jiffy from {git,\"https://github.com/apache/couchdb-jiffy.git\",\r\n                         {tag,\"CouchDB-1.0.4-1\"}}\r\nUpdating mochiweb from {git,\"https://github.com/apache/couchdb-mochiweb.git\",\r\n                            {tag,\"v2.20.0\"}}\r\nUpdating meck from {git,\"https://github.com/apache/couchdb-meck.git\",\r\n                        {tag,\"0.8.8\"}}\r\nUpdating recon from {git,\"https://github.com/apache/couchdb-recon.git\",\r\n                         {tag,\"2.5.0\"}}\r\nUpdating proper from {git,\"https://github.com/proper-testing/proper\",\r\n                          {tag,\"v1.3\"}}\r\nUpdating bear from {git,\"https://github.com/apache/couchdb-bear.git\",\r\n                        \"008f48aff819126e281d5ccae80a258bf9bf9c30\"}\r\nYou have configured Apache CouchDB, time to relax. Relax.\r\n\r\n# Compile\r\njenkins@2665e52069d0:~/couchdb$ make release\r\n...\r\nThe HTML pages are in build/html.\r\nsphinx-build -b man -a -W -n -A local=1 -D latex_elements.papersize=a4 -d build/doctree src/ build/man\r\nRunning Sphinx v1.8.4\r\nmaking output directory...\r\nloading pickled environment... done\r\nbuilding [mo]: all of 0 po files\r\nbuilding [man]: all source files\r\nupdating environment: 0 added, 0 changed, 0 removed\r\nlooking for now-outdated files... none found\r\nwriting... apachecouchdb.1 { intro/index intro/overview intro/why intro/consistency intro/curl intro/security intro/tour intro/api replication/index replication/intro replication/replicator replication/conflicts replication/protocol ddocs/index ddocs/ddocs ddocs/views/index ddocs/views/intro ddocs/views/collation ddocs/views/joins ddocs/views/nosql ddocs/views/pagination ddocs/search best-practices/index best-practices/documents best-practices/forms best-practices/iso-date best-practices/jsdevel best-practices/views best-practices/reverse-proxies install/index install/unix install/windows install/mac install/freebsd install/docker install/snap install/kubernetes install/search install/upgrading install/troubleshooting setup/index setup/single-node setup/cluster config/index config/intro config/couchdb config/cluster config/couch-peruser config/http config/auth config/compaction config/indexbuilds config/ioq config/logging config/replicator config/query-servers config/misc config/resharding cluster/index cluster/theory cluster/nodes cluster/databases cluster/sharding cluster/purging maintenance/index maintenance/compaction maintenance/performance maintenance/backups fauxton/index fauxton/install experimental api/index api/basics api/server/index api/server/common api/server/authn api/server/configuration api/database/index api/database/common api/database/bulk-api api/database/find api/database/shard api/database/changes api/database/compact api/database/security api/database/misc api/document/index api/document/common api/document/attachments api/ddoc/index api/ddoc/common api/ddoc/views api/ddoc/search api/ddoc/render api/ddoc/rewrites api/partitioned-dbs api/local json-structure query-server/index query-server/protocol query-server/javascript query-server/erlang partitioned-dbs/index whatsnew/index whatsnew/3.1 whatsnew/3.0 whatsnew/2.3 whatsnew/2.2 whatsnew/2.1 whatsnew/2.0 whatsnew/1.7 whatsnew/1.6 whatsnew/1.5 whatsnew/1.4 whatsnew/1.3 whatsnew/1.2 whatsnew/1.1 whatsnew/1.0 whatsnew/0.11 whatsnew/0.10 whatsnew/0.9 whatsnew/0.8 cve/index cve/2010-0009 cve/2010-2234 cve/2010-3854 cve/2012-5641 cve/2012-5649 cve/2012-5650 cve/2014-2668 cve/2017-12635 cve/2017-12636 cve/2018-11769 cve/2018-17188 cve/2018-8007 cve/2020-1955 about contributing } \r\nbuild succeeded.\r\n\r\nThe manual pages are in build/man.\r\nmake[1]: Leaving directory '/home/jenkins/couchdb/src/docs'\r\nInstalling CouchDB into rel/couchdb/ ...\r\n==> rel (generate)\r\nWARN:  'generate' command does not apply to directory /home/jenkins/couchdb\r\n... done\r\n\r\n    You can now copy the rel/couchdb directory anywhere on your system.\r\n    Start CouchDB with ./bin/couchdb from within that directory.\r\n\r\njenkins@2665e52069d0:~/couchdb$ echo $?\r\n0\r\n\r\n```\r\n\r\nThe compilation seem to have worked, so I created deb packages based on that. The `make dist` seemed not to like uncommited changes, so I added your patch as a commit:\r\n\r\n```bash\r\njenkins@2665e52069d0:~/couchdb$ git config --global user.email \"couchdb-validation@no-reply.com\"\r\njenkins@2665e52069d0:~/couchdb$ git config --global user.name \"CouchDB validation\"\r\njenkins@2665e52069d0:~/couchdb$ git commit -am \"fix: Apply caching\"\r\n[3.1.1-patch-jan 6c2d01a] fix: Apply caching\r\n 1 file changed, 79 insertions(+), 23 deletions(-)\r\njenkins@2665e52069d0:~/couchdb$ make dist\r\n==> config (compile)\r\n==> b64url (compile)\r\n==> ets_lru (compile)\r\n==> khash (compile)\r\n==> snappy (compile)\r\n==> bear (compile)\r\n==> meck (compile)\r\n==> folsom (compile)\r\n==> hyper (compile)\r\n==> ibrowse (compile)\r\n==> jiffy (compile)\r\n==> mochiweb (compile)\r\n==> recon (compile)\r\n==> proper (compile)\r\n==> couch_epi (compile)\r\n==> couch_log (compile)\r\n==> chttpd (compile)\r\n==> couch (compile)\r\nCompiling priv/couch_js/1.8.5/http.c\r\nCompiling priv/couch_js/1.8.5/main.c\r\nCompiling priv/couch_js/1.8.5/utf8.c\r\nCompiling priv/couch_js/1.8.5/util.c\r\n==> couch_event (compile)\r\n==> mem3 (compile)\r\n==> couch_index (compile)\r\n==> couch_mrview (compile)\r\n==> couch_replicator (compile)\r\n==> couch_plugins (compile)\r\n==> couch_pse_tests (compile)\r\n==> couch_stats (compile)\r\n==> couch_peruser (compile)\r\n==> couch_tests (compile)\r\n==> ddoc_cache (compile)\r\n==> dreyfus (compile)\r\n==> fabric (compile)\r\n==> global_changes (compile)\r\n==> ioq (compile)\r\n==> jwtf (compile)\r\n==> ken (compile)\r\n==> mango (compile)\r\n==> rexi (compile)\r\n==> setup (compile)\r\n==> smoosh (compile)\r\n==> rel (compile)\r\n==> couchdb (compile)\r\nCOUCHDB_GIT_SHA:        6c2d01a\r\nCOUCHDB_VERSION:        3.1.1-6c2d01a\r\nCOUCHDB_VERSION_SUFFIX: 6c2d01a\r\nDIRTY:                  \r\nIN_RC:                  \r\nIN_RELEASE:             \r\nON_TAG:                 \r\nREL_TAG:                3.1.1\r\nSUB_VSN:                \r\nBuilding Apache CouchDB 3.1.1-6c2d01a\r\nfatal: ambiguous argument '6c976bd..HEAD': unknown revision or path not in the working tree.\r\nUse '--' to separate paths from revisions, like this:\r\n'git <command> [<revision>...] -- [<file>...]'\r\nDone: apache-couchdb-3.1.1-6c2d01a.tar.gz\r\n```\r\n\r\nI copied that tar back to the host OS:\r\n\r\n```bash\r\n$ docker cp couchdb-3.1.1-fix-validation:/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a.tar.gz .\r\n$ git clone https://github.com/apache/couchdb-pkg.git\r\nCloning into 'couchdb-pkg'...\r\nremote: Enumerating objects: 723, done.\r\nremote: Counting objects: 100% (94/94), done.\r\nremote: Compressing objects: 100% (70/70), done.\r\nremote: Total 723 (delta 40), reused 57 (delta 20), pack-reused 629\r\nReceiving objects: 100% (723/723), 25.31 MiB | 23.49 MiB/s, done.\r\nResolving deltas: 100% (335/335), done.\r\n$ cd couchdb-pkg/\r\n\r\n```\r\n\r\nThe assumed image name was `couchdbdev/<osname>-<codename>-erlang-<erlang-version>`, so I retagged my created one before running the packaging job:\r\n\r\n```bash\r\n$ docker tag apache/couchdbci-debian:buster-erlang-20.3.8.26-1 couchdbdev/debian-buster-erlang-20.3.8.26-1\r\n$ ERLANGVERSION=20.3.8.26-1 ./build.sh couch debian-buster /root/apache-couchdb-3.1.1-6c2d01a.tar.gz\r\nUsing apache-couchdb-3.1.1-6c2d01a.tar.gz to build packages...\r\nmkdir -p ../couchdb\r\ncp apache-couchdb-3.1.1-6c2d01a.tar.gz ../couchdb\r\ncd ../couchdb && tar xfz *.tar.gz\r\ncp debian/control.in debian/control\r\nsed -i 's/%SPIDERMONKEY%/libmozjs-60-0/g' debian/control\r\nsed -i 's/%SPIDERMONKEY_DEV%/libmozjs-60-dev/g' debian/control\r\necho 'SM_VER = 60' > debian/sm_ver.mk\r\nrm -rf /home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/debian\r\ncp -R debian /home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a\r\ncd /home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a && dch -v 3.1.1-6c2d01a~buster \"Automatically generated package from upstream.\"\r\ncd /home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a && dpkg-buildpackage -b -us -uc\r\ndpkg-buildpackage: info: source package couchdb\r\ndpkg-buildpackage: info: source version 3.1.1-6c2d01a~buster\r\ndpkg-buildpackage: info: source distribution UNRELEASED\r\ndpkg-buildpackage: info: source changed by \"CouchDB Developers\" <\"dev@couchdb.apache.org\">\r\n dpkg-source --before-build .\r\ndpkg-buildpackage: info: host architecture amd64\r\ndpkg-source: info: using options from apache-couchdb-3.1.1-6c2d01a/debian/source/options: --compression=bzip2 --compression-level=9\r\n debian/rules clean\r\nmake[1]: Entering directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\ndh clean --with=systemd\r\n   debian/rules override_dh_auto_clean\r\nmake[2]: Entering directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\ndh_auto_clean\r\n\tmake -j1 distclean\r\nmake[3]: Entering directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\n==> config (clean)\r\n==> b64url (clean)\r\n==> ets_lru (clean)\r\n==> khash (clean)\r\n==> snappy (clean)\r\n==> bear (clean)\r\n==> meck (clean)\r\n==> folsom (clean)\r\n==> hyper (clean)\r\n==> ibrowse (clean)\r\n==> jiffy (clean)\r\n==> mochiweb (clean)\r\n==> recon (clean)\r\n==> couch_epi (clean)\r\n==> couch_log (clean)\r\n==> chttpd (clean)\r\n==> couch (clean)\r\n==> couch_event (clean)\r\n==> mem3 (clean)\r\n==> couch_index (clean)\r\n==> couch_mrview (clean)\r\n==> couch_replicator (clean)\r\n==> couch_plugins (clean)\r\n==> couch_pse_tests (clean)\r\n==> couch_stats (clean)\r\n==> couch_peruser (clean)\r\n==> couch_tests (clean)\r\n==> ddoc_cache (clean)\r\n==> dreyfus (clean)\r\n==> fabric (clean)\r\n==> global_changes (clean)\r\n==> ioq (clean)\r\n==> jwtf (clean)\r\n==> ken (clean)\r\n==> mango (clean)\r\n==> rexi (clean)\r\n==> setup (clean)\r\n==> smoosh (clean)\r\n==> rel (clean)\r\n==> apache-couchdb-3.1.1-6c2d01a (clean)\r\nmake[3]: Leaving directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\nmv src/mango/src/mango_cursor_text.erl.nocompile src/mango/src/mango_cursor_text.erl\r\nmv: cannot stat 'src/mango/src/mango_cursor_text.erl.nocompile': No such file or directory\r\nmake[2]: [debian/rules:21: override_dh_auto_clean] Error 1 (ignored)\r\nmv src/mango/src/mango_cursor_text.nocompile src/mango/src/mango_cursor_text.erl\r\nmv: cannot stat 'src/mango/src/mango_cursor_text.nocompile': No such file or directory\r\nmake[2]: [debian/rules:22: override_dh_auto_clean] Error 1 (ignored)\r\nmake[2]: Leaving directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\n   dh_clean\r\nmake[1]: Leaving directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\n debian/rules build\r\nmake[1]: Entering directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\ndh build --with=systemd\r\n   dh_update_autotools_config\r\n   debian/rules override_dh_auto_configure\r\nmake[2]: Entering directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\n./configure --spidermonkey-version 60\r\n==> configuring couchdb in rel/couchdb.config\r\nYou have configured Apache CouchDB, time to relax. Relax.\r\nmake[2]: Leaving directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\n   debian/rules override_dh_auto_build\r\nmake[2]: Entering directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\ndh_auto_build -- release\r\n\tmake -j1 release\r\nmake[3]: Entering directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\n==> config (compile)\r\nCompiled src/config_util.erl\r\nCompiled src/config_writer.erl\r\nCompiled src/config_sup.erl\r\nCompiled src/config_notifier.erl\r\nCompiled src/config_listener_mon.erl\r\nCompiled src/config_listener.erl\r\nCompiled src/config_app.erl\r\nCompiled src/config.erl\r\n==> b64url (compile)\r\nCompiled src/b64url.erl\r\nCompiling c_src/b64url.c\r\n==> ets_lru (compile)\r\nCompiled src/ets_lru.erl\r\n==> khash (compile)\r\nCompiled src/khash.erl\r\nCompiling c_src/hash.c\r\nCompiling c_src/khash.c\r\n==> snappy (compile)\r\nCompiled src/snappy.erl\r\nCompiling c_src/snappy_nif.cc\r\nc_src/snappy_nif.cc: In function 'ERL_NIF_TERM snappy_compress(ErlNifEnv*, int, const ERL_NIF_TERM*)':\r\nc_src/snappy_nif.cc:156:28: warning: catching polymorphic type 'class std::bad_alloc' by value [-Wcatch-value=]\r\n     } catch(std::bad_alloc e) {\r\n                            ^\r\nCompiling c_src/snappy/snappy-sinksource.cc\r\nCompiling c_src/snappy/snappy-stubs-internal.cc\r\nCompiling c_src/snappy/snappy.cc\r\nc_src/snappy/snappy.cc: In instantiation of 'bool snappy::SnappyScatteredWriter<Allocator>::AppendFromSelf(size_t, size_t) [with Allocator = snappy::SnappySinkAllocator; size_t = long unsigned int]':\r\nc_src/snappy/snappy.cc:779:13:   required from 'void snappy::SnappyDecompressor::DecompressAllTags(Writer*) [with Writer = snappy::SnappyScatteredWriter<snappy::SnappySinkAllocator>]'\r\nc_src/snappy/snappy.cc:865:3:   required from 'bool snappy::InternalUncompressAllTags(snappy::SnappyDecompressor*, Writer*, snappy::uint32) [with Writer = snappy::SnappyScatteredWriter<snappy::SnappySinkAllocator>; snappy::uint32 = unsigned int]'\r\nc_src/snappy/snappy.cc:1549:78:   required from here\r\nc_src/snappy/snappy.cc:1401:21: warning: comparison of integer expressions of different signedness: 'size_t' {aka 'long unsigned int'} and 'long int' [-Wsign-compare]\r\n     if (offset - 1u < op_ptr_ - op_base_) {\r\n         ~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~~\r\n==> bear (compile)\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/bear/src/bear.erl:28: Warning: export_all flag enabled - all functions will be exported\r\nCompiled src/bear.erl\r\n==> meck (compile)\r\nCompiled src/meck_util.erl\r\nCompiled src/meck_matcher.erl\r\nCompiled src/meck_ret_spec.erl\r\nCompiled src/meck_history.erl\r\nCompiled src/meck_expect.erl\r\nCompiled src/meck_cover.erl\r\nCompiled src/meck_code.erl\r\nCompiled src/meck_code_gen.erl\r\nCompiled src/meck_proc.erl\r\nCompiled src/meck_args_matcher.erl\r\nCompiled src/meck.erl\r\n==> folsom (compile)\r\nCompiled src/folsom_utils.erl\r\nCompiled src/folsom_sup.erl\r\nCompiled src/folsom_sample_slide_uniform.erl\r\nCompiled src/folsom_sample_uniform.erl\r\nCompiled src/folsom_sample_slide_sup.erl\r\nCompiled src/folsom_sample_slide_server.erl\r\nCompiled src/folsom_sample_slide_sorted.erl\r\nCompiled src/folsom_vm_metrics.erl\r\nCompiled src/folsom_sample_none.erl\r\nCompiled src/folsom_sample_slide.erl\r\nCompiled src/folsom_metrics_spiral.erl\r\nCompiled src/folsom_sample_exdec.erl\r\nCompiled src/folsom_sample.erl\r\nCompiled src/folsom_metrics_meter.erl\r\nCompiled src/folsom_metrics_history.erl\r\nCompiled src/folsom_metrics_meter_reader.erl\r\nCompiled src/folsom_metrics_histogram_ets.erl\r\nCompiled src/folsom_metrics_gauge.erl\r\nCompiled src/folsom_metrics_histogram.erl\r\nCompiled src/folsom_metrics_duration.erl\r\nCompiled src/folsom_metrics_counter.erl\r\nCompiled src/folsom_ewma.erl\r\nCompiled src/folsom_meter_timer_server.erl\r\nCompiled src/folsom.erl\r\nCompiled src/folsom_metrics.erl\r\nCompiled src/folsom_ets.erl\r\n==> hyper (compile)\r\nCompiled src/hyper_register.erl\r\nCompiled src/hyper_carray.erl\r\nCompiled src/hyper_gb.erl\r\nCompiled src/hyper_const.erl\r\nCompiled src/hyper_array.erl\r\nCompiled src/hyper_binary_rle.erl\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/hyper/src/hyper.erl:245: Warning: random:uniform/1: the 'random' module is deprecated; use the 'rand' module instead\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/hyper/src/hyper.erl:288: Warning: random:seed/3: the 'random' module is deprecated; use the 'rand' module instead\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/hyper/src/hyper.erl:333: Warning: random:seed/3: the 'random' module is deprecated; use the 'rand' module instead\r\nCompiled src/hyper.erl\r\nCompiled src/hyper_binary.erl\r\nCompiling c_src/hyper_carray.c\r\n==> ibrowse (compile)\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/ibrowse/src/ibrowse_lib.erl:372: Warning: erlang:now/0: Deprecated BIF. See the \"Time and Time Correction in Erlang\" chapter of the ERTS User's Guide for more information.\r\nCompiled src/ibrowse_lib.erl\r\nCompiled src/ibrowse_sup.erl\r\nCompiled src/ibrowse_socks5.erl\r\nCompiled src/ibrowse_lb.erl\r\nCompiled src/ibrowse_app.erl\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/ibrowse/src/ibrowse_test.erl:83: Warning: erlang:now/0: Deprecated BIF. See the \"Time and Time Correction in Erlang\" chapter of the ERTS User's Guide for more information.\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/ibrowse/src/ibrowse_test.erl:93: Warning: erlang:now/0: Deprecated BIF. See the \"Time and Time Correction in Erlang\" chapter of the ERTS User's Guide for more information.\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/ibrowse/src/ibrowse_test.erl:171: Warning: erlang:now/0: Deprecated BIF. See the \"Time and Time Correction in Erlang\" chapter of the ERTS User's Guide for more information.\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/ibrowse/src/ibrowse_test.erl:182: Warning: erlang:now/0: Deprecated BIF. See the \"Time and Time Correction in Erlang\" chapter of the ERTS User's Guide for more information.\r\nCompiled src/ibrowse_test.erl\r\nCompiled src/ibrowse.erl\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/ibrowse/src/ibrowse_http_client.erl:428: Warning: erlang:now/0: Deprecated BIF. See the \"Time and Time Correction in Erlang\" chapter of the ERTS User's Guide for more information.\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/ibrowse/src/ibrowse_http_client.erl:1831: Warning: erlang:now/0: Deprecated BIF. See the \"Time and Time Correction in Erlang\" chapter of the ERTS User's Guide for more information.\r\nCompiled src/ibrowse_http_client.erl\r\n==> jiffy (compile)\r\nCompiling c_src/decoder.c\r\nCompiling c_src/encoder.c\r\nCompiling c_src/jiffy.c\r\nCompiling c_src/termstack.c\r\nCompiling c_src/utf8.c\r\nCompiling c_src/util.c\r\nCompiling c_src/doubles.cc\r\nCompiling c_src/objects.cc\r\nCompiling c_src/double-conversion/bignum-dtoa.cc\r\nCompiling c_src/double-conversion/bignum.cc\r\nCompiling c_src/double-conversion/cached-powers.cc\r\nCompiling c_src/double-conversion/diy-fp.cc\r\nCompiling c_src/double-conversion/double-conversion.cc\r\nCompiling c_src/double-conversion/fast-dtoa.cc\r\nCompiling c_src/double-conversion/fixed-dtoa.cc\r\nCompiling c_src/double-conversion/strtod.cc\r\nCompiled src/jiffy_utf8.erl\r\nCompiled src/jiffy.erl\r\n==> mochiweb (compile)\r\nCompiled src/reloader.erl\r\nCompiled src/mochiweb_websocket.erl\r\nCompiled src/mochiweb_socket.erl\r\nCompiled src/mochiweb_util.erl\r\nCompiled src/mochiweb_session.erl\r\nCompiled src/mochiweb_socket_server.erl\r\nCompiled src/mochiweb_response.erl\r\nCompiled src/mochiweb_mime.erl\r\nCompiled src/mochiweb_multipart.erl\r\nCompiled src/mochiweb_io.erl\r\nCompiled src/mochiweb_http.erl\r\nCompiled src/mochiweb_request.erl\r\nCompiled src/mochiweb_echo.erl\r\nCompiled src/mochiweb_headers.erl\r\nCompiled src/mochiweb_cover.erl\r\nCompiled src/mochiweb_cookies.erl\r\nCompiled src/mochiweb_clock.erl\r\nCompiled src/mochiweb_base64url.erl\r\nCompiled src/mochiweb_acceptor.erl\r\nCompiled src/mochiweb.erl\r\nCompiled src/mochiweb_html.erl\r\nCompiled src/mochiutf8.erl\r\nCompiled src/mochitemp.erl\r\nCompiled src/mochinum.erl\r\nCompiled src/mochilogfile2.erl\r\nCompiled src/mochilists.erl\r\nCompiled src/mochijson.erl\r\nCompiled src/mochihex.erl\r\nCompiled src/mochiglobal.erl\r\nCompiled src/mochifmt_std.erl\r\nCompiled src/mochifmt_records.erl\r\nCompiled src/mochijson2.erl\r\nCompiled src/mochifmt.erl\r\nCompiled src/mochiweb_charref.erl\r\n==> recon (compile)\r\nCompiled src/recon_map.erl\r\nCompiled src/recon_rec.erl\r\nCompiled src/recon_trace.erl\r\nCompiled src/recon_alloc.erl\r\nCompiled src/recon_lib.erl\r\nCompiled src/recon.erl\r\n==> proper (compile)\r\nCompiled src/vararg.erl\r\nCompiled src/proper_target.erl\r\nCompiled src/proper_types.erl\r\nCompiled src/proper_unicode.erl\r\nCompiled src/proper_unused_imports_remover.erl\r\nCompiled src/proper_symb.erl\r\nCompiled src/proper_transformer.erl\r\nCompiled src/proper_shrink.erl\r\nCompiled src/proper_statem.erl\r\nCompiled src/proper_sets.erl\r\nCompiled src/proper_queue.erl\r\nCompiled src/proper_sa.erl\r\nCompiled src/proper_prop_remover.erl\r\nCompiled src/proper_orddict.erl\r\nCompiled src/proper_ordsets.erl\r\nCompiled src/proper_gen.erl\r\nCompiled src/proper_typeserver.erl\r\nCompiled src/proper_gb_trees.erl\r\nCompiled src/proper_gb_sets.erl\r\nCompiled src/proper_gen_next.erl\r\nCompiled src/proper_dict.erl\r\nCompiled src/proper_array.erl\r\nCompiled src/proper_fsm.erl\r\nCompiled src/proper_arith.erl\r\nCompiled src/proper.erl\r\n==> couch_epi (compile)\r\nCompiled src/couch_epi_util.erl\r\nCompiled src/couch_epi_sup.erl\r\nCompiled src/couch_epi_plugin.erl\r\nCompiled src/couch_epi_module_keeper.erl\r\nCompiled src/couch_epi_functions.erl\r\nCompiled src/couch_epi_functions_gen.erl\r\nCompiled src/couch_epi_data_gen.erl\r\nCompiled src/couch_epi_data.erl\r\nCompiled src/couch_epi_codegen.erl\r\nCompiled src/couch_epi_app.erl\r\nCompiled src/couch_epi_codechange_monitor.erl\r\nCompiled src/couch_epi.erl\r\n==> couch_log (compile)\r\nCompiled src/couch_log_writer.erl\r\nCompiled src/couch_log_writer_journald.erl\r\nCompiled src/couch_log_writer_stderr.erl\r\nCompiled src/couch_log_writer_syslog.erl\r\nCompiled src/couch_log_writer_file.erl\r\nCompiled src/couch_log_util.erl\r\nCompiled src/couch_log_sup.erl\r\nCompiled src/couch_log_server.erl\r\nCompiled src/couch_log_monitor.erl\r\nCompiled src/couch_log_trunc_io_fmt.erl\r\nCompiled src/couch_log_error_logger_h.erl\r\nCompiled src/couch_log_config_dyn.erl\r\nCompiled src/couch_log_trunc_io.erl\r\nCompiled src/couch_log_app.erl\r\nCompiled src/couch_log_config.erl\r\nCompiled src/couch_log.erl\r\nCompiled src/couch_log_formatter.erl\r\n==> chttpd (compile)\r\nCompiled src/chttpd.erl\r\nCompiled src/chttpd_xframe_options.erl\r\nCompiled src/chttpd_sup.erl\r\nCompiled src/chttpd_view.erl\r\nCompiled src/chttpd_stats.erl\r\nCompiled src/chttpd_test_util.erl\r\nCompiled src/chttpd_prefer_header.erl\r\nCompiled src/chttpd_rewrite.erl\r\nCompiled src/chttpd_show.erl\r\nCompiled src/chttpd_plugin.erl\r\nCompiled src/chttpd_httpd_handlers.erl\r\nCompiled src/chttpd_handlers.erl\r\nCompiled src/chttpd_node.erl\r\nCompiled src/chttpd_misc.erl\r\nCompiled src/chttpd_epi.erl\r\nCompiled src/chttpd_external.erl\r\nCompiled src/chttpd_cors.erl\r\nCompiled src/chttpd_auth_request.erl\r\nCompiled src/chttpd_auth.erl\r\nCompiled src/chttpd_app.erl\r\nCompiled src/chttpd_auth_cache.erl\r\nCompiled src/chttpd_db.erl\r\n==> couch (compile)\r\nCompiled src/couch_httpd.erl\r\nCompiled src/test_request.erl\r\nCompiled src/couch_work_queue.erl\r\nCompiled src/couch_uuids.erl\r\nCompiled src/couch_users_db.erl\r\nCompiled src/couch_totp.erl\r\nCompiled src/test_util.erl\r\nCompiled src/couch_util.erl\r\nCompiled src/couch_task_status.erl\r\nCompiled src/couch_sup.erl\r\nCompiled src/couch_secondary_sup.erl\r\nCompiled src/couch_rand.erl\r\nCompiled src/couch_stream.erl\r\nCompiled src/couch_proc_manager.erl\r\nCompiled src/couch_query_servers.erl\r\nCompiled src/couch_server.erl\r\nCompiled src/couch_primary_sup.erl\r\nCompiled src/couch_partition.erl\r\nCompiled src/couch_passwords.erl\r\nCompiled src/couch_os_process.erl\r\nCompiled src/couch_lru.erl\r\nCompiled src/couch_multidb_changes.erl\r\nCompiled src/couch_io_logger.erl\r\nCompiled src/couch_native_process.erl\r\nCompiled src/couch_httpd_vhost.erl\r\nCompiled src/couch_key_tree.erl\r\nCompiled src/couch_httpd_rewrite.erl\r\nCompiled src/couch_httpd_handlers.erl\r\nCompiled src/couch_httpd_multipart.erl\r\nCompiled src/couch_httpd_misc_handlers.erl\r\nCompiled src/couch_httpd_external.erl\r\nCompiled src/couch_hotp.erl\r\nCompiled src/couch_hash.erl\r\nCompiled src/couch_flags_config.erl\r\nCompiled src/couch_httpd_auth.erl\r\nCompiled src/couch_flags.erl\r\nCompiled src/couch_event_sup.erl\r\nCompiled src/couch_emsort.erl\r\nCompiled src/couch_ejson_size.erl\r\nCompiled src/couch_file.erl\r\nCompiled src/couch_httpd_db.erl\r\nCompiled src/couch_ejson_compare.erl\r\nCompiled src/couch_drv.erl\r\nCompiled src/couch_debug.erl\r\nCompiled src/couch_doc.erl\r\nCompiled src/couch_db_split.erl\r\nCompiled src/couch_db_plugin.erl\r\nCompiled src/couch_db_epi.erl\r\nCompiled src/couch_db_header.erl\r\nCompiled src/couch_db_updater.erl\r\nCompiled src/couch_compress.erl\r\nCompiled src/couch_db_engine.erl\r\nCompiled src/couch_changes.erl\r\nCompiled src/couch_bt_engine_stream.erl\r\nCompiled src/couch_bt_engine_header.erl\r\nCompiled src/couch_db.erl\r\nCompiled src/couch_btree.erl\r\nCompiled src/couch_base32.erl\r\nCompiled src/couch_bt_engine_compactor.erl\r\nCompiled src/couch_auth_cache.erl\r\nCompiled src/couch_att.erl\r\nCompiled src/couch_bt_engine.erl\r\nCompiled src/couch.erl\r\nCompiled src/couch_app.erl\r\nCompiling priv/couch_js/60/http.cpp\r\nCompiling priv/couch_js/60/main.cpp\r\nCompiling priv/couch_js/60/util.cpp\r\nCompiling priv/icu_driver/couch_icu_driver.c\r\nCompiling priv/couch_ejson_compare/couch_ejson_compare.c\r\n==> couch_event (compile)\r\nCompiled src/couch_event_listener.erl\r\nCompiled src/couch_event_sup2.erl\r\nCompiled src/couch_event_os_listener.erl\r\nCompiled src/couch_event_app.erl\r\nCompiled src/couch_event.erl\r\nCompiled src/couch_event_server.erl\r\nCompiled src/couch_event_listener_mfa.erl\r\n==> mem3 (compile)\r\nCompiled src/mem3_sync_nodes.erl\r\nCompiled src/mem3_sync_security.erl\r\nCompiled src/mem3_sync_event.erl\r\nCompiled src/mem3_sync_event_listener.erl\r\nCompiled src/mem3_sup.erl\r\nCompiled src/mem3_sync.erl\r\nCompiled src/mem3_util.erl\r\nCompiled src/mem3_seeds.erl\r\nCompiled src/mem3_reshard_validate.erl\r\nCompiled src/mem3_reshard_sup.erl\r\nCompiled src/mem3_shards.erl\r\nCompiled src/mem3_rpc.erl\r\nCompiled src/mem3_reshard_job_sup.erl\r\nCompiled src/mem3_reshard_store.erl\r\nCompiled src/mem3_reshard_index.erl\r\nCompiled src/mem3_reshard_httpd.erl\r\nCompiled src/mem3_reshard_job.erl\r\nCompiled src/mem3_reshard_api.erl\r\nCompiled src/mem3_reshard_dbdoc.erl\r\nCompiled src/mem3_plugin_couch_db.erl\r\nCompiled src/mem3_nodes.erl\r\nCompiled src/mem3_httpd_handlers.erl\r\nCompiled src/mem3_reshard.erl\r\nCompiled src/mem3_hash.erl\r\nCompiled src/mem3_epi.erl\r\nCompiled src/mem3_httpd.erl\r\nCompiled src/mem3_rep.erl\r\nCompiled src/mem3_app.erl\r\nCompiled src/mem3_cluster.erl\r\nCompiled src/mem3.erl\r\n==> couch_index (compile)\r\nCompiled src/couch_index_sup.erl\r\nCompiled src/couch_index_util.erl\r\nCompiled src/couch_index_plugin_couch_db.erl\r\nCompiled src/couch_index_updater.erl\r\nCompiled src/couch_index_epi.erl\r\nCompiled src/couch_index_plugin.erl\r\nCompiled src/couch_index_app.erl\r\nCompiled src/couch_index_server.erl\r\nCompiled src/couch_index_compactor.erl\r\nCompiled src/couch_index.erl\r\n==> couch_mrview (compile)\r\nCompiled src/couch_mrview_update_notifier.erl\r\nCompiled src/couch_mrview_updater.erl\r\nCompiled src/couch_mrview_test_util.erl\r\nCompiled src/couch_mrview_show.erl\r\nCompiled src/couch_mrview_util.erl\r\nCompiled src/couch_mrview_index.erl\r\nCompiled src/couch_mrview_compactor.erl\r\nCompiled src/couch_mrview_cleanup.erl\r\nCompiled src/couch_mrview_http.erl\r\nCompiled src/couch_mrview.erl\r\n==> couch_replicator (compile)\r\nCompiled src/couch_replicator_httpc.erl\r\nCompiled src/couch_replicator_auth.erl\r\nCompiled src/couch_replicator_utils.erl\r\nCompiled src/couch_replicator_sup.erl\r\nCompiled src/couch_replicator_stats.erl\r\nCompiled src/couch_replicator_scheduler_sup.erl\r\nCompiled src/json_stream_parse.erl\r\nCompiled src/couch_replicator_worker.erl\r\nCompiled src/couch_replicator_rate_limiter_tables.erl\r\nCompiled src/couch_replicator_rate_limiter.erl\r\nCompiled src/couch_replicator_notifier.erl\r\nCompiled src/couch_replicator_job_sup.erl\r\nCompiled src/couch_replicator_scheduler_job.erl\r\nCompiled src/couch_replicator_scheduler.erl\r\nCompiled src/couch_replicator_ids.erl\r\nCompiled src/couch_replicator_httpd_util.erl\r\nCompiled src/couch_replicator_httpd.erl\r\nCompiled src/couch_replicator_httpc_pool.erl\r\nCompiled src/couch_replicator_filters.erl\r\nCompiled src/couch_replicator_fabric_rpc.erl\r\nCompiled src/couch_replicator_doc_processor_worker.erl\r\nCompiled src/couch_replicator_fabric.erl\r\nCompiled src/couch_replicator_db_changes.erl\r\nCompiled src/couch_replicator_connection.erl\r\nCompiled src/couch_replicator_docs.erl\r\nCompiled src/couch_replicator_changes_reader.erl\r\nCompiled src/couch_replicator_doc_processor.erl\r\nCompiled src/couch_replicator_clustering.erl\r\nCompiled src/couch_replicator_app.erl\r\nCompiled src/couch_replicator_auth_noop.erl\r\nCompiled src/couch_replicator_auth_session.erl\r\nCompiled src/couch_replicator.erl\r\nCompiled src/couch_replicator_api_wrap.erl\r\n==> couch_plugins (compile)\r\nCompiled src/couch_plugins_httpd.erl\r\nCompiled src/couch_plugins.erl\r\n==> couch_pse_tests (compile)\r\nCompiled src/cpse_test_ref_counting.erl\r\nCompiled src/cpse_util.erl\r\nCompiled src/cpse_test_read_write_docs.erl\r\n/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/src/couch_pse_tests/src/cpse_test_purge_seqs.erl:14: Warning: export_all flag enabled - all functions will be exported\r\nCompiled src/cpse_test_purge_seqs.erl\r\nCompiled src/cpse_test_purge_replication.erl\r\nCompiled src/cpse_test_purge_docs.erl\r\nCompiled src/cpse_test_open_close_delete.erl\r\nCompiled src/cpse_test_purge_bad_checkpoints.erl\r\nCompiled src/cpse_test_get_set_props.erl\r\nCompiled src/cpse_test_fold_purge_infos.erl\r\nCompiled src/cpse_test_fold_changes.erl\r\nCompiled src/cpse_test_fold_docs.erl\r\nCompiled src/cpse_test_copy_purge_infos.erl\r\nCompiled src/cpse_gather.erl\r\nCompiled src/cpse_test_attachments.erl\r\nCompiled src/cpse_test_compaction.erl\r\n==> couch_stats (compile)\r\nCompiled src/couch_stats_sup.erl\r\nCompiled src/couch_stats_app.erl\r\nCompiled src/couch_stats_process_tracker.erl\r\nCompiled src/couch_stats.erl\r\nCompiled src/couch_stats_httpd.erl\r\nCompiled src/couch_stats_aggregator.erl\r\n==> couch_peruser (compile)\r\nCompiled src/couch_peruser_app.erl\r\nCompiled src/couch_peruser_sup.erl\r\nCompiled src/couch_peruser.erl\r\n==> couch_tests (compile)\r\nCompiled setups/couch_epi_dispatch.erl\r\nCompiled src/couch_tests_combinatorics.erl\r\nCompiled src/couch_tests.erl\r\n==> ddoc_cache (compile)\r\nCompiled src/ddoc_cache_value.erl\r\nCompiled src/ddoc_cache_sup.erl\r\nCompiled src/ddoc_cache_opener.erl\r\nCompiled src/ddoc_cache_entry_validation_funs.erl\r\nCompiled src/ddoc_cache_entry_ddocid_rev.erl\r\nCompiled src/ddoc_cache_entry_ddocid.erl\r\nCompiled src/ddoc_cache_entry_custom.erl\r\nCompiled src/ddoc_cache_app.erl\r\nCompiled src/ddoc_cache_lru.erl\r\nCompiled src/ddoc_cache.erl\r\nCompiled src/ddoc_cache_entry.erl\r\n==> dreyfus (compile)\r\nCompiled src/dreyfus_sup.erl\r\nCompiled src/dreyfus_plugin_couch_db.erl\r\nCompiled src/dreyfus_rpc.erl\r\nCompiled src/dreyfus_index_updater.erl\r\nCompiled src/dreyfus_util.erl\r\nCompiled src/dreyfus_index_manager.erl\r\nCompiled src/dreyfus_httpd_handlers.erl\r\nCompiled src/dreyfus_index.erl\r\nCompiled src/dreyfus_fabric_search.erl\r\nCompiled src/dreyfus_fabric_info.erl\r\nCompiled src/dreyfus_httpd.erl\r\nCompiled src/dreyfus_fabric_group2.erl\r\nCompiled src/dreyfus_fabric_cleanup.erl\r\nCompiled src/dreyfus_fabric_group1.erl\r\nCompiled src/dreyfus_epi.erl\r\nCompiled src/dreyfus_config.erl\r\nCompiled src/dreyfus_app.erl\r\nCompiled src/dreyfus_fabric.erl\r\nCompiled src/dreyfus_bookmark.erl\r\nCompiled src/clouseau_rpc.erl\r\n==> fabric (compile)\r\nCompiled src/fabric_db_update_listener.erl\r\nCompiled src/fabric_view_reduce.erl\r\nCompiled src/fabric_view_map.erl\r\nCompiled src/fabric_view_all_docs.erl\r\nCompiled src/fabric_view_changes.erl\r\nCompiled src/fabric_view.erl\r\nCompiled src/fabric_streams.erl\r\nCompiled src/fabric_util.erl\r\nCompiled src/fabric_rpc.erl\r\nCompiled src/fabric_ring.erl\r\nCompiled src/fabric_group_info.erl\r\nCompiled src/fabric_doc_update.erl\r\nCompiled src/fabric_doc_purge.erl\r\nCompiled src/fabric_doc_missing_revs.erl\r\nCompiled src/fabric_doc_open_revs.erl\r\nCompiled src/fabric_doc_atts.erl\r\nCompiled src/fabric_doc_open.erl\r\nCompiled src/fabric_dict.erl\r\nCompiled src/fabric_doc_attachments.erl\r\nCompiled src/fabric_design_doc_count.erl\r\nCompiled src/fabric_db_partition_info.erl\r\nCompiled src/fabric_db_meta.erl\r\nCompiled src/fabric_db_doc_count.erl\r\nCompiled src/fabric_db_info.erl\r\nCompiled src/fabric_db_delete.erl\r\nCompiled src/fabric_db_create.erl\r\nCompiled src/fabric.erl\r\n==> global_changes (compile)\r\nCompiled src/global_changes_sup.erl\r\nCompiled src/global_changes_util.erl\r\nCompiled src/global_changes_plugin.erl\r\nCompiled src/global_changes_httpd_handlers.erl\r\nCompiled src/global_changes_listener.erl\r\nCompiled src/global_changes_server.erl\r\nCompiled src/global_changes_epi.erl\r\nCompiled src/global_changes_app.erl\r\nCompiled src/global_changes_httpd.erl\r\n==> ioq (compile)\r\nCompiled src/ioq_app.erl\r\nCompiled src/ioq_sup.erl\r\nCompiled src/ioq.erl\r\n==> jwtf (compile)\r\nCompiled src/jwtf_app.erl\r\nCompiled src/jwtf_sup.erl\r\nCompiled src/jwtf.erl\r\nCompiled src/jwtf_keystore.erl\r\n==> ken (compile)\r\nCompiled src/ken_sup.erl\r\nCompiled src/ken_event_handler.erl\r\nCompiled src/ken_app.erl\r\nCompiled src/ken.erl\r\nCompiled src/ken_server.erl\r\n==> mango (compile)\r\nCompiled src/mango_sup.erl\r\nCompiled src/mango_sort.erl\r\nCompiled src/mango_util.erl\r\nCompiled src/mango_selector_text.erl\r\nCompiled src/mango_selector.erl\r\nCompiled src/mango_opts.erl\r\nCompiled src/mango_json.erl\r\nCompiled src/mango_json_bookmark.erl\r\nCompiled src/mango_native_proc.erl\r\nCompiled src/mango_idx_special.erl\r\nCompiled src/mango_idx_text.erl\r\nCompiled src/mango_httpd_handlers.erl\r\nCompiled src/mango_idx_view.erl\r\nCompiled src/mango_fields.erl\r\nCompiled src/mango_execution_stats.erl\r\nCompiled src/mango_idx.erl\r\nCompiled src/mango_epi.erl\r\nCompiled src/mango_httpd.erl\r\nCompiled src/mango_error.erl\r\nCompiled src/mango_doc.erl\r\nCompiled src/mango_cursor_text.erl\r\nCompiled src/mango_cursor_special.erl\r\nCompiled src/mango_cursor.erl\r\nCompiled src/mango_app.erl\r\nCompiled src/mango_crud.erl\r\nCompiled src/mango_cursor_view.erl\r\n==> rexi (compile)\r\nCompiled src/rexi_server_sup.erl\r\nCompiled src/rexi_sup.erl\r\nCompiled src/rexi_utils.erl\r\nCompiled src/rexi_server_mon.erl\r\nCompiled src/rexi_monitor.erl\r\nCompiled src/rexi_app.erl\r\nCompiled src/rexi_server.erl\r\nCompiled src/rexi_buffer.erl\r\nCompiled src/rexi.erl\r\n==> setup (compile)\r\nCompiled src/setup_sup.erl\r\nCompiled src/setup_httpd_handlers.erl\r\nCompiled src/setup_app.erl\r\nCompiled src/setup_epi.erl\r\nCompiled src/setup_httpd.erl\r\nCompiled src/setup.erl\r\n==> smoosh (compile)\r\nCompiled src/smoosh_sup.erl\r\nCompiled src/smoosh_utils.erl\r\nCompiled src/smoosh_priority_queue.erl\r\nCompiled src/smoosh_app.erl\r\nCompiled src/smoosh_channel.erl\r\nCompiled src/smoosh_server.erl\r\nCompiled src/smoosh.erl\r\n==> rel (compile)\r\n==> apache-couchdb-3.1.1-6c2d01a (compile)\r\nInstalling CouchDB into rel/couchdb/ ...\r\n==> rel (generate)\r\nWARN:  'generate' command does not apply to directory /home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a\r\n... done\r\n\r\n    You can now copy the rel/couchdb directory anywhere on your system.\r\n    Start CouchDB with ./bin/couchdb from within that directory.\r\n\r\nmake[3]: Leaving directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\nrm -rf rel/couchdb/var/log\r\nrm -rf rel/couchdb/data\r\nmake[2]: Leaving directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\nmake[1]: Leaving directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\n debian/rules binary\r\nmake[1]: Entering directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\ndh binary --with=systemd\r\n   dh_testroot\r\n   dh_prep\r\n   dh_installdirs\r\n   dh_install\r\n   dh_installdocs\r\n   dh_installchangelogs\r\n   dh_installman\r\n   dh_installdebconf\r\n   dh_systemd_enable\r\n   dh_installinit\r\n   dh_systemd_start\r\n   dh_installlogrotate\r\n   dh_lintian\r\n   dh_perl\r\n   dh_link\r\n   dh_strip_nondeterminism\r\n   dh_compress\r\n   dh_fixperms\r\n   dh_missing\r\n   dh_strip\r\n   dh_makeshlibs\r\n   debian/rules override_dh_shlibdeps\r\nmake[2]: Entering directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\ndh_shlibdeps -- --ignore-missing-info -xlibmozjs185-1.0\r\nobjdump: debian/couchdb/opt/couchdb/lib/crypto-4.2.2.4/priv/obj/otp_test_engine.o: not a dynamic object\r\nobjdump: debian/couchdb/opt/couchdb/lib/crypto-4.2.2.4/priv/obj/otp_test_engine.o: invalid operation\r\ndpkg-shlibdeps: warning: couldn't parse dynamic symbol definition: no symbols\r\nobjdump: debian/couchdb/opt/couchdb/lib/crypto-4.2.2.4/priv/obj/crypto_callback.o: not a dynamic object\r\nobjdump: debian/couchdb/opt/couchdb/lib/crypto-4.2.2.4/priv/obj/crypto_callback.o: invalid operation\r\ndpkg-shlibdeps: warning: couldn't parse dynamic symbol definition: no symbols\r\nobjdump: debian/couchdb/opt/couchdb/lib/crypto-4.2.2.4/priv/obj/crypto.o: not a dynamic object\r\nobjdump: debian/couchdb/opt/couchdb/lib/crypto-4.2.2.4/priv/obj/crypto.o: invalid operation\r\ndpkg-shlibdeps: warning: couldn't parse dynamic symbol definition: no symbols\r\ndpkg-shlibdeps: warning: package could avoid a useless dependency if debian/couchdb/opt/couchdb/lib/couch-3.1.1-6c2d01a/priv/couch_ejson_compare.so debian/couchdb/opt/couchdb/lib/couch-3.1.1-6c2d01a/priv/couch_icu_driver.so were not linked against libicudata.so.63 (they use none of the library's symbols)\r\nmake[2]: Leaving directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\n   dh_installdeb\r\n   dh_gencontrol\r\n   dh_md5sums\r\n   debian/rules override_dh_builddeb\r\nmake[2]: Entering directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\ndh_builddeb -- -Zgzip\r\ndpkg-deb: building package 'couchdb-dbgsym' in '../couchdb-dbgsym_3.1.1-6c2d01a~buster_amd64.deb'.\r\ndpkg-deb: building package 'couchdb' in '../couchdb_3.1.1-6c2d01a~buster_amd64.deb'.\r\nmake[2]: Leaving directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\nmake[1]: Leaving directory '/home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a'\r\n dpkg-genbuildinfo --build=binary\r\n dpkg-genchanges --build=binary >../couchdb_3.1.1-6c2d01a~buster_amd64.changes\r\ndpkg-genchanges: info: binary-only upload (no source code included)\r\n dpkg-source --after-build .\r\ndpkg-source: info: using options from apache-couchdb-3.1.1-6c2d01a/debian/source/options: --compression=bzip2 --compression-level=9\r\ndpkg-buildpackage: info: binary-only upload (no source included)\r\ncd /home/jenkins/couchdb/apache-couchdb-3.1.1-6c2d01a/.. && lintian --profile couchdb couch*.deb || true\r\nwarning: the authors of lintian do not recommend running it with root privileges!\r\nW: couchdb: maintainer-script-should-not-use-recursive-chown-or-chmod postinst:207\r\nN: 3 tags overridden (2 errors, 1 info); 2 unused overrides\r\nchmod a+rwx ../couchdb/couchdb*\r\nmkdir -p pkgs/couch/debian-buster && chmod 777 pkgs/couch/debian-buster\r\ncp ../couchdb/couchdb* pkgs/couch/debian-buster\r\nif [ -f debian/control.bak ]; then mv -f debian/control.bak debian/control; fi\r\nif [ -f rpm/SPECS/couchdb.spec.bak ]; then mv -f rpm/SPECS/couchdb.spec.bak rpm/SPECS/couchdb.spec; fi\r\nrm -rf parts prime stage js/build debian/sm_ver.mk\r\n\r\n# packages were created\r\n$ ls -lah pkgs/couch/debian-buster/\r\ntotal 30M\r\ndrwxrwxrwx 2 root root  207 Aug 31 01:58 .\r\ndrwxrwxrwx 3 root root   45 Aug 31 01:58 ..\r\n-rwxr-xr-x 1 root root  11K Aug 31 01:58 couchdb_3.1.1-6c2d01a~buster_amd64.buildinfo\r\n-rwxr-xr-x 1 root root 1.5K Aug 31 01:58 couchdb_3.1.1-6c2d01a~buster_amd64.changes\r\n-rwxr-xr-x 1 root root  30M Aug 31 01:58 couchdb_3.1.1-6c2d01a~buster_amd64.deb\r\n-rwxr-xr-x 1 root root 474K Aug 31 01:58 couchdb-dbgsym_3.1.1-6c2d01a~buster_amd64.deb\r\n\r\n```\r\n\r\nNext use https://github.com/apache/couchdb-docker/tree/main/3.1.1 to produce the container images, but adjust them to include the custom couchdb version.\r\n\r\n```bash\r\n$ git clone https://github.com/apache/couchdb-docker.git\r\nCloning into 'couchdb-docker'...\r\nremote: Enumerating objects: 1010, done.\r\nremote: Counting objects: 100% (118/118), done.\r\nremote: Compressing objects: 100% (82/82), done.\r\nremote: Total 1010 (delta 64), reused 64 (delta 32), pack-reused 892\r\nReceiving objects: 100% (1010/1010), 248.11 KiB | 1.19 MiB/s, done.\r\nResolving deltas: 100% (490/490), done.\r\n$ cd ~/couchdb-docker/3.1.1\r\n$ cp -r ~/couchdb-pkg/pkgs/couch/debian-buster/ .\r\n$ ls debian-buster/\r\ncouchdb_3.1.1-6c2d01a~buster_amd64.buildinfo  couchdb_3.1.1-6c2d01a~buster_amd64.changes  couchdb_3.1.1-6c2d01a~buster_amd64.deb  couchdb-dbgsym_3.1.1-6c2d01a~buster_amd64.deb\r\n\r\n$ git diff\r\ndiff --git a/3.1.1/Dockerfile b/3.1.1/Dockerfile\r\nindex 75b4b29..59a90d9 100644\r\n--- a/3.1.1/Dockerfile\r\n+++ b/3.1.1/Dockerfile\r\n@@ -60,6 +60,10 @@ RUN . /etc/os-release; \\\r\n     echo \"deb [signed-by=/usr/share/keyrings/couchdb-archive-keyring.gpg] https://apache.jfrog.io/artifactory/couchdb-deb/ ${VERSION_CODENAME} main\" | \\\r\n         tee /etc/apt/sources.list.d/couchdb.list >/dev/null\r\n \r\n+# I know, we should not include deb packages in images, but it should be good enough to validate the fix\r\n+COPY debian-buster/couchdb_3.1.1-6c2d01a~buster_amd64.deb /tmp/packages/\r\n+COPY debian-buster/couchdb-dbgsym_3.1.1-6c2d01a~buster_amd64.deb /tmp/packages/\r\n+\r\n # https://github.com/apache/couchdb-pkg/blob/master/debian/README.Debian\r\n RUN set -eux; \\\r\n     apt-get update; \\\r\n@@ -67,7 +71,7 @@ RUN set -eux; \\\r\n     echo \"couchdb couchdb/mode select none\" | debconf-set-selections; \\\r\n # we DO want recommends this time\r\n     DEBIAN_FRONTEND=noninteractive apt-get install -y --allow-downgrades --allow-remove-essential --allow-change-held-packages \\\r\n-            couchdb=\"$COUCHDB_VERSION\"~buster \\\r\n+    /tmp/packages/* \\\r\n     ; \\\r\n # Undo symlinks to /var/log and /var/lib\r\n     rmdir /var/lib/couchdb /var/log/couchdb; \\\r\n\r\ndocker build -t \"couchdb:3.1.1-patch-jan\" .\r\nSending build context to Docker daemon  31.45MB\r\nStep 1/20 : FROM debian:buster-slim\r\n ---> 5c3d57f3e47a\r\nStep 2/20 : LABEL maintainer=\"CouchDB Developers dev@couchdb.apache.org\"\r\n ---> Using cache\r\n ---> 60f37c14a0e1\r\nStep 3/20 : RUN groupadd -g 5984 -r couchdb && useradd -u 5984 -d /opt/couchdb -g couchdb couchdb\r\n ---> Using cache\r\n ---> 78202346b500\r\nStep 4/20 : RUN set -ex;     apt-get update;     apt-get install -y --no-install-recommends         apt-transport-https         ca-certificates         dirmngr         gnupg      ;     rm -rf /var/lib/apt/lists/*\r\n ---> Using cache\r\n ---> fad0f8a736e0\r\nStep 5/20 : RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends gosu tini;     rm -rf /var/lib/apt/lists/*;     gosu nobody true;     tini --version\r\n ---> Using cache\r\n ---> aca1db0792a3\r\nStep 6/20 : ENV GPG_COUCH_KEY     390EF70BB1EA12B2773962950EE62FB37A00258D\r\n ---> Using cache\r\n ---> d28f3c244c10\r\nStep 7/20 : RUN set -eux;     apt-get update;     apt-get install -y curl;     export GNUPGHOME=\"$(mktemp -d)\";     curl -fL -o keys.asc https://couchdb.apache.org/repo/keys.asc;     gpg --batch --import keys.asc;     gpg --batch --export \"${GPG_COUCH_KEY}\" > /usr/share/keyrings/couchdb-archive-keyring.gpg;     command -v gpgconf && gpgconf --kill all || :;     rm -rf \"$GNUPGHOME\";     apt-key list;     apt purge -y --autoremove curl;     rm -rf /var/lib/apt/lists/*\r\n ---> Using cache\r\n ---> e2949d6cc031\r\nStep 8/20 : ENV COUCHDB_VERSION 3.1.1\r\n ---> Using cache\r\n ---> baa8089d1bea\r\nStep 9/20 : RUN . /etc/os-release;     echo \"deb [signed-by=/usr/share/keyrings/couchdb-archive-keyring.gpg] https://apache.jfrog.io/artifactory/couchdb-deb/ ${VERSION_CODENAME} main\" |         tee /etc/apt/sources.list.d/couchdb.list >/dev/null\r\n ---> Using cache\r\n ---> a7933b88e802\r\nStep 10/20 : COPY debian-buster/couchdb_3.1.1-6c2d01a~buster_amd64.deb /tmp/packages/\r\n ---> Using cache\r\n ---> ded52d34b729\r\nStep 11/20 : COPY debian-buster/couchdb-dbgsym_3.1.1-6c2d01a~buster_amd64.deb /tmp/packages/\r\n ---> Using cache\r\n ---> eb9b215cb430\r\nStep 12/20 : RUN set -eux;     apt-get update;         echo \"couchdb couchdb/mode select none\" | debconf-set-selections;     DEBIAN_FRONTEND=noninteractive apt-get install -y --allow-downgrades --allow-remove-essential --allow-change-held-packages     /tmp/packages/*     ;     rmdir /var/lib/couchdb /var/log/couchdb;     rm /opt/couchdb/data /opt/couchdb/var/log;     mkdir -p /opt/couchdb/data /opt/couchdb/var/log;     chown couchdb:couchdb /opt/couchdb/data /opt/couchdb/var/log;     chmod 777 /opt/couchdb/data /opt/couchdb/var/log;     rm /opt/couchdb/etc/default.d/10-filelog.ini;     find /opt/couchdb \\! \\( -user couchdb -group couchdb \\) -exec chown -f couchdb:couchdb '{}' +;     find /opt/couchdb/etc -type d ! -perm 0755 -exec chmod -f 0755 '{}' +;     find /opt/couchdb/etc -type f ! -perm 0644 -exec chmod -f 0644 '{}' +;     chmod -f 0777 /opt/couchdb/etc/local.d;     rm -rf /var/lib/apt/lists/*;\r\n ---> Running in 6f530f886258\r\n+ apt-get update\r\nGet:1 http://security.debian.org/debian-security buster/updates InRelease [65.4 kB]\r\nGet:2 http://deb.debian.org/debian buster InRelease [122 kB]\r\nGet:3 http://deb.debian.org/debian buster-updates InRelease [51.9 kB]\r\nGet:4 http://security.debian.org/debian-security buster/updates/main amd64 Packages [302 kB]\r\nGet:5 http://deb.debian.org/debian buster/main amd64 Packages [7907 kB]\r\nGet:6 https://apache.jfrog.io/artifactory/couchdb-deb buster InRelease [5151 B]\r\nGet:7 https://apache.jfrog.io/artifactory/couchdb-deb buster/main amd64 Packages [3889 B]\r\nGet:8 http://deb.debian.org/debian buster-updates/main amd64 Packages [15.2 kB]\r\nFetched 8473 kB in 3s (3017 kB/s)\r\nReading package lists...\r\n+ echo couchdb couchdb/mode select none\r\n+ debconf-set-selections\r\n+ DEBIAN_FRONTEND=noninteractive apt-get install -y --allow-downgrades --allow-remove-essential --allow-change-held-packages /tmp/packages/couchdb-dbgsym_3.1.1-6c2d01a~buster_amd64.deb /tmp/packages/couchdb_3.1.1-6c2d01a~buster_amd64.deb\r\nReading package lists...\r\nBuilding dependency tree...\r\nReading state information...\r\nThe following additional packages will be installed:\r\n  curl krb5-locales libcurl4 libgpm2 libgssapi-krb5-2 libicu63 libk5crypto3\r\n  libkeyutils1 libkrb5-3 libkrb5support0 libmozjs-60-0 libncurses6\r\n  libnghttp2-14 libprocps7 libpsl5 librtmp1 libssh2-1 procps psmisc\r\n  publicsuffix\r\nSuggested packages:\r\n  gpm krb5-doc krb5-user\r\nThe following NEW packages will be installed:\r\n  couchdb couchdb-dbgsym curl krb5-locales libcurl4 libgpm2 libgssapi-krb5-2\r\n  libicu63 libk5crypto3 libkeyutils1 libkrb5-3 libkrb5support0 libmozjs-60-0\r\n  libncurses6 libnghttp2-14 libprocps7 libpsl5 librtmp1 libssh2-1 procps\r\n  psmisc publicsuffix\r\n0 upgraded, 22 newly installed, 0 to remove and 0 not upgraded.\r\nNeed to get 13.5 MB/45.0 MB of archives.\r\nAfter this operation, 104 MB of additional disk space will be used.\r\nGet:1 http://security.debian.org/debian-security buster/updates/main amd64 krb5-locales all 1.17-3+deb10u2 [95.5 kB]\r\nGet:2 http://deb.debian.org/debian buster/main amd64 libncurses6 amd64 6.1+20181013-2+deb10u2 [102 kB]\r\nGet:3 http://security.debian.org/debian-security buster/updates/main amd64 libkrb5support0 amd64 1.17-3+deb10u2 [65.7 kB]\r\nGet:4 http://security.debian.org/debian-security buster/updates/main amd64 libk5crypto3 amd64 1.17-3+deb10u2 [122 kB]\r\nGet:5 http://security.debian.org/debian-security buster/updates/main amd64 libkrb5-3 amd64 1.17-3+deb10u2 [369 kB]\r\nGet:6 http://security.debian.org/debian-security buster/updates/main amd64 libgssapi-krb5-2 amd64 1.17-3+deb10u2 [158 kB]\r\nGet:7 http://deb.debian.org/debian buster/main amd64 libprocps7 amd64 2:3.3.15-2 [61.7 kB]\r\nGet:8 http://deb.debian.org/debian buster/main amd64 procps amd64 2:3.3.15-2 [259 kB]\r\nGet:9 http://deb.debian.org/debian buster/main amd64 libkeyutils1 amd64 1.6-6 [15.0 kB]\r\nGet:10 http://deb.debian.org/debian buster/main amd64 libnghttp2-14 amd64 1.36.0-2+deb10u1 [85.0 kB]\r\nGet:11 /tmp/packages/couchdb_3.1.1-6c2d01a~buster_amd64.deb couchdb amd64 3.1.1-6c2d01a~buster [30.9 MB]\r\nGet:12 /tmp/packages/couchdb-dbgsym_3.1.1-6c2d01a~buster_amd64.deb couchdb-dbgsym amd64 3.1.1-6c2d01a~buster [485 kB]\r\nGet:13 http://deb.debian.org/debian buster/main amd64 libpsl5 amd64 0.20.2-2 [53.7 kB]\r\nGet:14 http://deb.debian.org/debian buster/main amd64 librtmp1 amd64 2.4+20151223.gitfa8646d.1-2 [60.5 kB]\r\nGet:15 http://deb.debian.org/debian buster/main amd64 libssh2-1 amd64 1.8.0-2.1 [140 kB]\r\nGet:16 http://deb.debian.org/debian buster/main amd64 libcurl4 amd64 7.64.0-4+deb10u2 [332 kB]\r\nGet:17 http://deb.debian.org/debian buster/main amd64 curl amd64 7.64.0-4+deb10u2 [265 kB]\r\nGet:18 http://deb.debian.org/debian buster/main amd64 libicu63 amd64 63.1-6+deb10u1 [8300 kB]\r\nGet:19 http://deb.debian.org/debian buster/main amd64 libmozjs-60-0 amd64 60.2.3-3 [2785 kB]\r\nGet:20 http://deb.debian.org/debian buster/main amd64 libgpm2 amd64 1.20.7-5 [35.1 kB]\r\nGet:21 http://deb.debian.org/debian buster/main amd64 psmisc amd64 23.2-1 [126 kB]\r\nGet:22 http://deb.debian.org/debian buster/main amd64 publicsuffix all 20190415.1030-1 [116 kB]\r\ndebconf: delaying package configuration, since apt-utils is not installed\r\nFetched 13.5 MB in 1s (12.8 MB/s)\r\nSelecting previously unselected package libncurses6:amd64.\r\n(Reading database ... 7118 files and directories currently installed.)\r\nPreparing to unpack .../00-libncurses6_6.1+20181013-2+deb10u2_amd64.deb ...\r\nUnpacking libncurses6:amd64 (6.1+20181013-2+deb10u2) ...\r\nSelecting previously unselected package libprocps7:amd64.\r\nPreparing to unpack .../01-libprocps7_2%3a3.3.15-2_amd64.deb ...\r\nUnpacking libprocps7:amd64 (2:3.3.15-2) ...\r\nSelecting previously unselected package procps.\r\nPreparing to unpack .../02-procps_2%3a3.3.15-2_amd64.deb ...\r\nUnpacking procps (2:3.3.15-2) ...\r\nSelecting previously unselected package krb5-locales.\r\nPreparing to unpack .../03-krb5-locales_1.17-3+deb10u2_all.deb ...\r\nUnpacking krb5-locales (1.17-3+deb10u2) ...\r\nSelecting previously unselected package libkeyutils1:amd64.\r\nPreparing to unpack .../04-libkeyutils1_1.6-6_amd64.deb ...\r\nUnpacking libkeyutils1:amd64 (1.6-6) ...\r\nSelecting previously unselected package libkrb5support0:amd64.\r\nPreparing to unpack .../05-libkrb5support0_1.17-3+deb10u2_amd64.deb ...\r\nUnpacking libkrb5support0:amd64 (1.17-3+deb10u2) ...\r\nSelecting previously unselected package libk5crypto3:amd64.\r\nPreparing to unpack .../06-libk5crypto3_1.17-3+deb10u2_amd64.deb ...\r\nUnpacking libk5crypto3:amd64 (1.17-3+deb10u2) ...\r\nSelecting previously unselected package libkrb5-3:amd64.\r\nPreparing to unpack .../07-libkrb5-3_1.17-3+deb10u2_amd64.deb ...\r\nUnpacking libkrb5-3:amd64 (1.17-3+deb10u2) ...\r\nSelecting previously unselected package libgssapi-krb5-2:amd64.\r\nPreparing to unpack .../08-libgssapi-krb5-2_1.17-3+deb10u2_amd64.deb ...\r\nUnpacking libgssapi-krb5-2:amd64 (1.17-3+deb10u2) ...\r\nSelecting previously unselected package libnghttp2-14:amd64.\r\nPreparing to unpack .../09-libnghttp2-14_1.36.0-2+deb10u1_amd64.deb ...\r\nUnpacking libnghttp2-14:amd64 (1.36.0-2+deb10u1) ...\r\nSelecting previously unselected package libpsl5:amd64.\r\nPreparing to unpack .../10-libpsl5_0.20.2-2_amd64.deb ...\r\nUnpacking libpsl5:amd64 (0.20.2-2) ...\r\nSelecting previously unselected package librtmp1:amd64.\r\nPreparing to unpack .../11-librtmp1_2.4+20151223.gitfa8646d.1-2_amd64.deb ...\r\nUnpacking librtmp1:amd64 (2.4+20151223.gitfa8646d.1-2) ...\r\nSelecting previously unselected package libssh2-1:amd64.\r\nPreparing to unpack .../12-libssh2-1_1.8.0-2.1_amd64.deb ...\r\nUnpacking libssh2-1:amd64 (1.8.0-2.1) ...\r\nSelecting previously unselected package libcurl4:amd64.\r\nPreparing to unpack .../13-libcurl4_7.64.0-4+deb10u2_amd64.deb ...\r\nUnpacking libcurl4:amd64 (7.64.0-4+deb10u2) ...\r\nSelecting previously unselected package curl.\r\nPreparing to unpack .../14-curl_7.64.0-4+deb10u2_amd64.deb ...\r\nUnpacking curl (7.64.0-4+deb10u2) ...\r\nSelecting previously unselected package libicu63:amd64.\r\nPreparing to unpack .../15-libicu63_63.1-6+deb10u1_amd64.deb ...\r\nUnpacking libicu63:amd64 (63.1-6+deb10u1) ...\r\nSelecting previously unselected package libmozjs-60-0:amd64.\r\nPreparing to unpack .../16-libmozjs-60-0_60.2.3-3_amd64.deb ...\r\nUnpacking libmozjs-60-0:amd64 (60.2.3-3) ...\r\nSelecting previously unselected package couchdb.\r\nPreparing to unpack .../17-couchdb_3.1.1-6c2d01a~buster_amd64.deb ...\r\nUnpacking couchdb (3.1.1-6c2d01a~buster) ...\r\nSelecting previously unselected package couchdb-dbgsym.\r\nPreparing to unpack .../18-couchdb-dbgsym_3.1.1-6c2d01a~buster_amd64.deb ...\r\nUnpacking couchdb-dbgsym (3.1.1-6c2d01a~buster) ...\r\nSelecting previously unselected package libgpm2:amd64.\r\nPreparing to unpack .../19-libgpm2_1.20.7-5_amd64.deb ...\r\nUnpacking libgpm2:amd64 (1.20.7-5) ...\r\nSelecting previously unselected package psmisc.\r\nPreparing to unpack .../20-psmisc_23.2-1_amd64.deb ...\r\nUnpacking psmisc (23.2-1) ...\r\nSelecting previously unselected package publicsuffix.\r\nPreparing to unpack .../21-publicsuffix_20190415.1030-1_all.deb ...\r\nUnpacking publicsuffix (20190415.1030-1) ...\r\nSetting up libkeyutils1:amd64 (1.6-6) ...\r\nSetting up libpsl5:amd64 (0.20.2-2) ...\r\nSetting up libgpm2:amd64 (1.20.7-5) ...\r\nSetting up psmisc (23.2-1) ...\r\nSetting up libprocps7:amd64 (2:3.3.15-2) ...\r\nSetting up libnghttp2-14:amd64 (1.36.0-2+deb10u1) ...\r\nSetting up krb5-locales (1.17-3+deb10u2) ...\r\nSetting up libicu63:amd64 (63.1-6+deb10u1) ...\r\nSetting up libkrb5support0:amd64 (1.17-3+deb10u2) ...\r\nSetting up librtmp1:amd64 (2.4+20151223.gitfa8646d.1-2) ...\r\nSetting up libncurses6:amd64 (6.1+20181013-2+deb10u2) ...\r\nSetting up libk5crypto3:amd64 (1.17-3+deb10u2) ...\r\nSetting up procps (2:3.3.15-2) ...\r\nupdate-alternatives: using /usr/bin/w.procps to provide /usr/bin/w (w) in auto mode\r\nupdate-alternatives: warning: skip creation of /usr/share/man/man1/w.1.gz because associated file /usr/share/man/man1/w.procps.1.gz (of link group w) doesn't exist\r\nSetting up libssh2-1:amd64 (1.8.0-2.1) ...\r\nSetting up libkrb5-3:amd64 (1.17-3+deb10u2) ...\r\nSetting up publicsuffix (20190415.1030-1) ...\r\nSetting up libmozjs-60-0:amd64 (60.2.3-3) ...\r\nSetting up libgssapi-krb5-2:amd64 (1.17-3+deb10u2) ...\r\nSetting up libcurl4:amd64 (7.64.0-4+deb10u2) ...\r\nSetting up curl (7.64.0-4+deb10u2) ...\r\nSetting up couchdb (3.1.1-6c2d01a~buster) ...\r\ninvoke-rc.d: could not determine current runlevel\r\ninvoke-rc.d: policy-rc.d denied execution of start.\r\nSetting up couchdb-dbgsym (3.1.1-6c2d01a~buster) ...\r\nProcessing triggers for libc-bin (2.28-10) ...\r\n+ rmdir /var/lib/couchdb /var/log/couchdb\r\n+ rm /opt/couchdb/data /opt/couchdb/var/log\r\n+ mkdir -p /opt/couchdb/data /opt/couchdb/var/log\r\n+ chown couchdb:couchdb /opt/couchdb/data /opt/couchdb/var/log\r\n+ chmod 777 /opt/couchdb/data /opt/couchdb/var/log\r\n+ rm /opt/couchdb/etc/default.d/10-filelog.ini\r\n+ find /opt/couchdb ! ( -user couchdb -group couchdb ) -exec chown -f couchdb:couchdb {} +\r\n+ find /opt/couchdb/etc -type d ! -perm 0755 -exec chmod -f 0755 {} +\r\n+ find /opt/couchdb/etc -type f ! -perm 0644 -exec chmod -f 0644 {} +\r\n+ chmod -f 0777 /opt/couchdb/etc/local.d\r\n+ rm -rf /var/lib/apt/lists/apache.jfrog.io_artifactory_couchdb-deb_dists_buster_InRelease /var/lib/apt/lists/apache.jfrog.io_artifactory_couchdb-deb_dists_buster_main_binary-amd64_Packages.lz4 /var/lib/apt/lists/auxfiles /var/lib/apt/lists/deb.debian.org_debian_dists_buster-updates_InRelease /var/lib/apt/lists/deb.debian.org_debian_dists_buster-updates_main_binary-amd64_Packages.lz4 /var/lib/apt/lists/deb.debian.org_debian_dists_buster_InRelease /var/lib/apt/lists/deb.debian.org_debian_dists_buster_main_binary-amd64_Packages.lz4 /var/lib/apt/lists/lock /var/lib/apt/lists/partial /var/lib/apt/lists/security.debian.org_debian-security_dists_buster_updates_InRelease /var/lib/apt/lists/security.debian.org_debian-security_dists_buster_updates_main_binary-amd64_Packages.lz4\r\nRemoving intermediate container 6f530f886258\r\n ---> eaea07a7886e\r\nStep 13/20 : COPY --chown=couchdb:couchdb 10-docker-default.ini /opt/couchdb/etc/default.d/\r\n ---> f1c9d8e86732\r\nStep 14/20 : COPY --chown=couchdb:couchdb vm.args /opt/couchdb/etc/\r\n ---> a984087a4ee3\r\nStep 15/20 : COPY docker-entrypoint.sh /usr/local/bin\r\n ---> 66cd3ececce1\r\nStep 16/20 : RUN ln -s usr/local/bin/docker-entrypoint.sh /docker-entrypoint.sh # backwards compat\r\n ---> Running in ae10e0e02906\r\nRemoving intermediate container ae10e0e02906\r\n ---> bf8817264923\r\nStep 17/20 : ENTRYPOINT [\"tini\", \"--\", \"/docker-entrypoint.sh\"]\r\n ---> Running in 1485a79c319f\r\nRemoving intermediate container 1485a79c319f\r\n ---> 737d9f7a9b97\r\nStep 18/20 : VOLUME /opt/couchdb/data\r\n ---> Running in 6aa4eafbc054\r\nRemoving intermediate container 6aa4eafbc054\r\n ---> 3f111d557168\r\nStep 19/20 : EXPOSE 5984 4369 9100\r\n ---> Running in 07b6a3204c82\r\nRemoving intermediate container 07b6a3204c82\r\n ---> c70917bea3fd\r\nStep 20/20 : CMD [\"/opt/couchdb/bin/couchdb\"]\r\n ---> Running in d61719ef6dea\r\nRemoving intermediate container d61719ef6dea\r\n ---> ca3940266314\r\nSuccessfully built ca3940266314\r\nSuccessfully tagged couchdb:3.1.1-patch-jan\r\n```\r\n\r\nI pushed the image and pulled it to my workstation again to have the same underlying hardware as in the previous test.\r\n\r\n## Results\r\nI adjusted the couchdb-test.sh [couchdb-test-validate-patch-3517.zip](https://github.com/apache/couchdb/files/7083304/couchdb-test-validate-patch-3517.zip) script to use the patched image and compare it against the vanilla CouchDB 3.1.1 image.\r\n\r\n```bash\r\n$ ./couchdb-test.sh setup\r\n...\r\ninserting docs cycle 2000/2000\r\n{\"ok\":true,\"id\":\"a479f05c01bf22c5168ee73617783eb7\",\"rev\":\"1-f7fac9a3f6ce538d67747271336211c4\"}\r\n{\"ok\":true,\"id\":\"a479f05c01bf22c5168ee73617784bb6\",\"rev\":\"1-7e3d2b01acbc416b60e6e5be050dd790\"}\r\n{\"ok\":true,\"id\":\"a479f05c01bf22c5168ee73617784e38\",\"rev\":\"1-c959b425a724ad6346f646d8a63da6cd\"}\r\n{\"ok\":true,\"id\":\"a479f05c01bf22c5168ee73617785d5b\",\"rev\":\"1-d8bd0d00d0b04b52796cfe73d9a80760\"}\r\n{\"ok\":true,\"id\":\"a479f05c01bf22c5168ee73617786743\",\"rev\":\"1-24f6bc4fcfdceae7ff2fae47a68fbf42\"}\r\n{\"ok\":true,\"id\":\"a479f05c01bf22c5168ee73617787715\",\"rev\":\"1-b0dfc903b7f27dc98130c8d51931f5d4\"}\r\n\r\n$ ./couchdb-test.sh query\r\nCouchDB performance regression test script\r\nAssuming that setup is already complete\r\n================ Query CouchDB 3.1.1 ================\r\n{\"couchdb\":\"Welcome\",\"version\":\"3.1.1\",\"git_sha\":\"ce596c65d\",\"uuid\":\"84f2eae60ea04fe192284667cb0e4640\",\"features\":[\"access-ready\",\"partitioned\",\"pluggable-storage-engines\",\"reshard\",\"scheduler\"],\"vendor\":{\"name\":\"The Apache Software Foundation\"}}\r\nQuery Database views on port 3003\r\nRound: 1/10\r\n\r\nreal\t0m36.391s\r\nuser\t0m0.014s\r\nsys\t0m0.010s\r\nRound: 2/10\r\n\r\nreal\t0m36.426s\r\nuser\t0m0.009s\r\nsys\t0m0.015s\r\nRound: 3/10\r\n\r\nreal\t0m37.448s\r\nuser\t0m0.015s\r\nsys\t0m0.010s\r\nRound: 4/10\r\n\r\nreal\t0m37.182s\r\nuser\t0m0.010s\r\nsys\t0m0.016s\r\nRound: 5/10\r\n\r\nreal\t0m34.802s\r\nuser\t0m0.013s\r\nsys\t0m0.013s\r\nRound: 6/10\r\n\r\nreal\t0m34.877s\r\nuser\t0m0.009s\r\nsys\t0m0.016s\r\nRound: 7/10\r\n\r\nreal\t0m34.204s\r\nuser\t0m0.007s\r\nsys\t0m0.017s\r\nRound: 8/10\r\n\r\nreal\t0m34.092s\r\nuser\t0m0.009s\r\nsys\t0m0.015s\r\nRound: 9/10\r\n\r\nreal\t0m35.571s\r\nuser\t0m0.014s\r\nsys\t0m0.011s\r\nRound: 10/10\r\n\r\nreal\t0m35.790s\r\nuser\t0m0.010s\r\nsys\t0m0.015s\r\n================ Query CouchDB 3.1.1 patch jan ================\r\n{\"couchdb\":\"Welcome\",\"version\":\"3.1.1\",\"git_sha\":\"6c2d01a\",\"uuid\":\"7df6b96ce9f321de839f65a9a6f264f3\",\"features\":[\"access-ready\",\"partitioned\",\"pluggable-storage-engines\",\"reshard\",\"scheduler\"],\"vendor\":{\"name\":\"The Apache Software Foundation\"}}\r\nQuery Database views on port 3004\r\nRound: 1/10\r\n\r\nreal\t0m11.194s\r\nuser\t0m0.012s\r\nsys\t0m0.010s\r\nRound: 2/10\r\n\r\nreal\t0m11.224s\r\nuser\t0m0.014s\r\nsys\t0m0.011s\r\nRound: 3/10\r\n\r\nreal\t0m10.966s\r\nuser\t0m0.012s\r\nsys\t0m0.012s\r\nRound: 4/10\r\n\r\nreal\t0m11.212s\r\nuser\t0m0.013s\r\nsys\t0m0.012s\r\nRound: 5/10\r\n\r\nreal\t0m10.696s\r\nuser\t0m0.016s\r\nsys\t0m0.009s\r\nRound: 6/10\r\n\r\nreal\t0m10.859s\r\nuser\t0m0.013s\r\nsys\t0m0.012s\r\nRound: 7/10\r\n\r\nreal\t0m11.342s\r\nuser\t0m0.012s\r\nsys\t0m0.013s\r\nRound: 8/10\r\n\r\nreal\t0m11.276s\r\nuser\t0m0.011s\r\nsys\t0m0.013s\r\nRound: 9/10\r\n\r\nreal\t0m11.357s\r\nuser\t0m0.015s\r\nsys\t0m0.009s\r\nRound: 10/10\r\n\r\nreal\t0m11.542s\r\nuser\t0m0.014s\r\nsys\t0m0.010s\r\n```\r\n\r\nThat's actually great news, we have an average response time from about 11.2s now compared to 35.7s on the vanilla image :-)\r\nIf possible, I would vote for including your patch in a new 3.x build, as it would be more than 3 times faster for the same queries with unchanged client code (at least for the given dataset).\r\n\r\nStill, nothing seem to beat build-in reducers, but at least it would not be way slower to run customer reducers on CouchDB 3 vs. CouchDB 2 installations.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/909124414/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/910303881","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-910303881","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":910303881,"node_id":"IC_kwDOAAMmUc42QiKJ","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-01T13:49:10Z","updated_at":"2021-09-01T13:49:10Z","author_association":"MEMBER","body":"@konrad-ohms thank you for confirming this, we’ll see about getting this into 3.x ✌️","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/910303881/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/911375056","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-911375056","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":911375056,"node_id":"IC_kwDOAAMmUc42UnrQ","user":{"login":"konrad-ohms","id":40577406,"node_id":"MDQ6VXNlcjQwNTc3NDA2","avatar_url":"https://avatars.githubusercontent.com/u/40577406?v=4","gravatar_id":"","url":"https://api.github.com/users/konrad-ohms","html_url":"https://github.com/konrad-ohms","followers_url":"https://api.github.com/users/konrad-ohms/followers","following_url":"https://api.github.com/users/konrad-ohms/following{/other_user}","gists_url":"https://api.github.com/users/konrad-ohms/gists{/gist_id}","starred_url":"https://api.github.com/users/konrad-ohms/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/konrad-ohms/subscriptions","organizations_url":"https://api.github.com/users/konrad-ohms/orgs","repos_url":"https://api.github.com/users/konrad-ohms/repos","events_url":"https://api.github.com/users/konrad-ohms/events{/privacy}","received_events_url":"https://api.github.com/users/konrad-ohms/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-02T08:24:25Z","updated_at":"2021-09-02T08:24:25Z","author_association":"NONE","body":"Perfect, thank you very much","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/911375056/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/911764035","html_url":"https://github.com/apache/couchdb/issues/3666#issuecomment-911764035","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3666","id":911764035,"node_id":"IC_kwDOAAMmUc42WGpD","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-02T14:44:34Z","updated_at":"2021-09-02T14:44:34Z","author_association":"MEMBER","body":"this is done","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/911764035/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/911877735","html_url":"https://github.com/apache/couchdb/issues/3477#issuecomment-911877735","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3477","id":911877735,"node_id":"IC_kwDOAAMmUc42WiZn","user":{"login":"TechInterMezzo","id":16213048,"node_id":"MDQ6VXNlcjE2MjEzMDQ4","avatar_url":"https://avatars.githubusercontent.com/u/16213048?v=4","gravatar_id":"","url":"https://api.github.com/users/TechInterMezzo","html_url":"https://github.com/TechInterMezzo","followers_url":"https://api.github.com/users/TechInterMezzo/followers","following_url":"https://api.github.com/users/TechInterMezzo/following{/other_user}","gists_url":"https://api.github.com/users/TechInterMezzo/gists{/gist_id}","starred_url":"https://api.github.com/users/TechInterMezzo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TechInterMezzo/subscriptions","organizations_url":"https://api.github.com/users/TechInterMezzo/orgs","repos_url":"https://api.github.com/users/TechInterMezzo/repos","events_url":"https://api.github.com/users/TechInterMezzo/events{/privacy}","received_events_url":"https://api.github.com/users/TechInterMezzo/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-02T16:53:17Z","updated_at":"2021-09-02T16:53:17Z","author_association":"NONE","body":"Any news about the bullseye package?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/911877735/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/911901861","html_url":"https://github.com/apache/couchdb/issues/3477#issuecomment-911901861","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3477","id":911901861,"node_id":"IC_kwDOAAMmUc42WoSl","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-02T17:23:24Z","updated_at":"2021-09-02T17:23:24Z","author_association":"MEMBER","body":"The release is being prepared, expect within 1-2 weeks. Sorry for the delay.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/911901861/reactions","total_count":5,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":3},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/912603173","html_url":"https://github.com/apache/couchdb/pull/3725#issuecomment-912603173","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3725","id":912603173,"node_id":"IC_kwDOAAMmUc42ZTgl","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-03T14:59:44Z","updated_at":"2021-09-03T15:02:47Z","author_association":"CONTRIBUTOR","body":"`ateles` is not an Apache CouchDB application we can't depend on it\r\n\r\nWe'd want to configure couch_eval perhaps to talk to ateles","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/912603173/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/914376860","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-914376860","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":914376860,"node_id":"IC_kwDOAAMmUc42gEic","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-07T14:57:36Z","updated_at":"2021-09-07T14:57:36Z","author_association":"MEMBER","body":"@konrad-ohms would you be able to once more test this PR: https://github.com/apache/couchdb/pull/3728 — it uses SHA-256 over crc32, and thus is production ready, we just wanna make sure this still speeds you up :)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/914376860/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/915121820","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-915121820","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":915121820,"node_id":"IC_kwDOAAMmUc42i6ac","user":{"login":"konrad-ohms","id":40577406,"node_id":"MDQ6VXNlcjQwNTc3NDA2","avatar_url":"https://avatars.githubusercontent.com/u/40577406?v=4","gravatar_id":"","url":"https://api.github.com/users/konrad-ohms","html_url":"https://github.com/konrad-ohms","followers_url":"https://api.github.com/users/konrad-ohms/followers","following_url":"https://api.github.com/users/konrad-ohms/following{/other_user}","gists_url":"https://api.github.com/users/konrad-ohms/gists{/gist_id}","starred_url":"https://api.github.com/users/konrad-ohms/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/konrad-ohms/subscriptions","organizations_url":"https://api.github.com/users/konrad-ohms/orgs","repos_url":"https://api.github.com/users/konrad-ohms/repos","events_url":"https://api.github.com/users/konrad-ohms/events{/privacy}","received_events_url":"https://api.github.com/users/konrad-ohms/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-08T10:37:29Z","updated_at":"2021-09-08T10:37:29Z","author_association":"NONE","body":"Thanks @janl, I compiled your PR and ran the test suite again.\r\n\r\nUnfortunately, the second fix in the PR is not performing as good as the prior patch, but it is still better than the original 3.1.1 performance.\r\n\r\n| Version                  | Average Performance |\r\n|--------------------------|---------------------|\r\n| 3.1.1                    | 36.43s              |\r\n| 3.1.1 patch 1            | 11.45s              |\r\n| 3.1.1 patch 2 (PR #3728) | 25.25s              |\r\n\r\nPlease find my full result output below:\r\n\r\n```bash\r\n$ ./couchdb-test.sh query\r\nCouchDB performance regression test script\r\nAssuming that setup is already complete\r\n================ Query CouchDB 3.1.1 ================\r\n{\"couchdb\":\"Welcome\",\"version\":\"3.1.1\",\"git_sha\":\"ce596c65d\",\"uuid\":\"ae7c1c70f02a0b873d0a4f414e1a4d7e\",\"features\":[\"access-ready\",\"partitioned\",\"pluggable-storage-engines\",\"reshard\",\"scheduler\"],\"vendor\":{\"name\":\"The Apache Software Foundation\"}}\r\nQuery Database views on port 3003\r\nRound: 1/10\r\n\r\nreal\t0m35.155s\r\nuser\t0m0.019s\r\nsys\t0m0.014s\r\nRound: 2/10\r\n\r\nreal\t0m35.645s\r\nuser\t0m0.011s\r\nsys\t0m0.015s\r\nRound: 3/10\r\n\r\nreal\t0m37.915s\r\nuser\t0m0.008s\r\nsys\t0m0.018s\r\nRound: 4/10\r\n\r\nreal\t0m36.850s\r\nuser\t0m0.008s\r\nsys\t0m0.018s\r\nRound: 5/10\r\n\r\nreal\t0m35.977s\r\nuser\t0m0.016s\r\nsys\t0m0.012s\r\nRound: 6/10\r\n\r\nreal\t0m36.915s\r\nuser\t0m0.010s\r\nsys\t0m0.016s\r\nRound: 7/10\r\n\r\nreal\t0m35.969s\r\nuser\t0m0.010s\r\nsys\t0m0.017s\r\nRound: 8/10\r\n\r\nreal\t0m37.248s\r\nuser\t0m0.014s\r\nsys\t0m0.013s\r\nRound: 9/10\r\n\r\nreal\t0m36.506s\r\nuser\t0m0.013s\r\nsys\t0m0.012s\r\nRound: 10/10\r\n\r\nreal\t0m36.101s\r\nuser\t0m0.012s\r\nsys\t0m0.014s\r\n================ Query CouchDB 3.1.1 patch jan ================\r\n{\"couchdb\":\"Welcome\",\"version\":\"3.1.1\",\"git_sha\":\"6c2d01a\",\"uuid\":\"54f521952cafc33bdb70987c4fc6cd69\",\"features\":[\"access-ready\",\"partitioned\",\"pluggable-storage-engines\",\"reshard\",\"scheduler\"],\"vendor\":{\"name\":\"The Apache Software Foundation\"}}\r\nQuery Database views on port 3004\r\nRound: 1/10\r\n\r\nreal\t0m11.213s\r\nuser\t0m0.015s\r\nsys\t0m0.010s\r\nRound: 2/10\r\n\r\nreal\t0m11.737s\r\nuser\t0m0.008s\r\nsys\t0m0.017s\r\nRound: 3/10\r\n\r\nreal\t0m11.524s\r\nuser\t0m0.013s\r\nsys\t0m0.012s\r\nRound: 4/10\r\n\r\nreal\t0m11.387s\r\nuser\t0m0.011s\r\nsys\t0m0.014s\r\nRound: 5/10\r\n\r\nreal\t0m11.257s\r\nuser\t0m0.013s\r\nsys\t0m0.011s\r\nRound: 6/10\r\n\r\nreal\t0m11.325s\r\nuser\t0m0.012s\r\nsys\t0m0.013s\r\nRound: 7/10\r\n\r\nreal\t0m11.846s\r\nuser\t0m0.012s\r\nsys\t0m0.013s\r\nRound: 8/10\r\n\r\nreal\t0m11.652s\r\nuser\t0m0.009s\r\nsys\t0m0.015s\r\nRound: 9/10\r\n\r\nreal\t0m11.508s\r\nuser\t0m0.013s\r\nsys\t0m0.012s\r\nRound: 10/10\r\n\r\nreal\t0m11.351s\r\nuser\t0m0.015s\r\nsys\t0m0.010s\r\n================ Query CouchDB 3.1.1 patch2 jan ================\r\n{\"couchdb\":\"Welcome\",\"version\":\"3.1.1\",\"git_sha\":\"65fd7ec\",\"uuid\":\"73454c85dfb63b0826f42e25310b6dec\",\"features\":[\"access-ready\",\"partitioned\",\"pluggable-storage-engines\",\"reshard\",\"scheduler\"],\"vendor\":{\"name\":\"The Apache Software Foundation\"}}\r\nQuery Database views on port 3005\r\nRound: 1/10\r\n\r\nreal\t0m25.617s\r\nuser\t0m0.017s\r\nsys\t0m0.011s\r\nRound: 2/10\r\n\r\nreal\t0m25.098s\r\nuser\t0m0.014s\r\nsys\t0m0.015s\r\nRound: 3/10\r\n\r\nreal\t0m24.765s\r\nuser\t0m0.010s\r\nsys\t0m0.015s\r\nRound: 4/10\r\n\r\nreal\t0m26.233s\r\nuser\t0m0.010s\r\nsys\t0m0.016s\r\nRound: 5/10\r\n\r\nreal\t0m25.144s\r\nuser\t0m0.011s\r\nsys\t0m0.016s\r\nRound: 6/10\r\n\r\nreal\t0m25.586s\r\nuser\t0m0.015s\r\nsys\t0m0.012s\r\nRound: 7/10\r\n\r\nreal\t0m24.918s\r\nuser\t0m0.013s\r\nsys\t0m0.014s\r\nRound: 8/10\r\n\r\nreal\t0m24.787s\r\nuser\t0m0.011s\r\nsys\t0m0.015s\r\nRound: 9/10\r\n\r\nreal\t0m25.519s\r\nuser\t0m0.015s\r\nsys\t0m0.011s\r\nRound: 10/10\r\n\r\nreal\t0m24.812s\r\nuser\t0m0.014s\r\nsys\t0m0.011s\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/915121820/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/915144134","html_url":"https://github.com/apache/couchdb/pull/3724#issuecomment-915144134","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3724","id":915144134,"node_id":"IC_kwDOAAMmUc42i_3G","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-08T11:13:14Z","updated_at":"2021-09-08T11:13:14Z","author_association":"MEMBER","body":"Thanks Nick, should be all addressed\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/915144134/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/915997675","html_url":"https://github.com/apache/couchdb/pull/3038#issuecomment-915997675","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3038","id":915997675,"node_id":"IC_kwDOAAMmUc42mQPr","user":{"login":"stemuk","id":17005007,"node_id":"MDQ6VXNlcjE3MDA1MDA3","avatar_url":"https://avatars.githubusercontent.com/u/17005007?v=4","gravatar_id":"","url":"https://api.github.com/users/stemuk","html_url":"https://github.com/stemuk","followers_url":"https://api.github.com/users/stemuk/followers","following_url":"https://api.github.com/users/stemuk/following{/other_user}","gists_url":"https://api.github.com/users/stemuk/gists{/gist_id}","starred_url":"https://api.github.com/users/stemuk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stemuk/subscriptions","organizations_url":"https://api.github.com/users/stemuk/orgs","repos_url":"https://api.github.com/users/stemuk/repos","events_url":"https://api.github.com/users/stemuk/events{/privacy}","received_events_url":"https://api.github.com/users/stemuk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-09T11:21:49Z","updated_at":"2021-09-09T11:21:49Z","author_association":"NONE","body":"@janl Are there any further plans for this pull request? ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/915997675/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/916180095","html_url":"https://github.com/apache/couchdb/issues/3733#issuecomment-916180095","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3733","id":916180095,"node_id":"IC_kwDOAAMmUc42m8x_","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-09T15:00:22Z","updated_at":"2021-09-09T15:00:22Z","author_association":"CONTRIBUTOR","body":"PR merged","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/916180095/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/916925011","html_url":"https://github.com/apache/couchdb/pull/3739#issuecomment-916925011","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3739","id":916925011,"node_id":"IC_kwDOAAMmUc42pypT","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-10T13:57:43Z","updated_at":"2021-09-10T13:57:43Z","author_association":"MEMBER","body":"Code looks great to me. I saw you mention a shard splitting PR on IRC and figured I'd need an extra cup of coffee this morning, then saw a 2 line changes with detailed tests 🎉 \r\n\r\nCouple of small typos in the commit message, \"purge sequences *were* always copied\", \"In order to correctly gather and *(split?)* the purge sequences\". Nice work! 👍 ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/916925011/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/916980553","html_url":"https://github.com/apache/couchdb/pull/3739#issuecomment-916980553","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3739","id":916980553,"node_id":"IC_kwDOAAMmUc42qANJ","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-10T15:12:43Z","updated_at":"2021-09-10T15:12:43Z","author_association":"CONTRIBUTOR","body":"Thank you for taking a look, Adam!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/916980553/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/916992153","html_url":"https://github.com/apache/couchdb/issues/3744#issuecomment-916992153","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3744","id":916992153,"node_id":"IC_kwDOAAMmUc42qDCZ","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-10T15:29:03Z","updated_at":"2021-09-10T15:29:35Z","author_association":"CONTRIBUTOR","body":"See if there are any errors in the logs or in the _scheduler/jobs for those replications\r\n\r\nIf replications use a filter and it's fairly restrictive, there could be a large number of pending changes and very few writes.\r\n\r\nAnother reason could be a validate doc update (VDU) function which is restricting writes.\r\n\r\nWithout a more details job history and/or logs it's a bit hard to tell why state looks like that\r\n\r\nThis might also be better converted to a discussion for now","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/916992153/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/917361272","html_url":"https://github.com/apache/couchdb/pull/3746#issuecomment-917361272","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3746","id":917361272,"node_id":"IC_kwDOAAMmUc42rdJ4","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-11T07:45:01Z","updated_at":"2021-09-11T07:45:01Z","author_association":"MEMBER","body":"I would hold this until after 3.2 - seems like too subtle of a change to push in at the last minute, no?","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/917361272/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/917415831","html_url":"https://github.com/apache/couchdb/pull/3746#issuecomment-917415831","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3746","id":917415831,"node_id":"IC_kwDOAAMmUc42rqeX","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-11T14:22:14Z","updated_at":"2021-09-11T14:22:14Z","author_association":"CONTRIBUTOR","body":"@wohali yeah definitely, let's wait","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/917415831/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/918324335","html_url":"https://github.com/apache/couchdb/issues/3738#issuecomment-918324335","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3738","id":918324335,"node_id":"IC_kwDOAAMmUc42vIRv","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-13T15:44:04Z","updated_at":"2021-09-13T15:44:04Z","author_association":"CONTRIBUTOR","body":"This should be fixed. Closing","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/918324335/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/919304082","html_url":"https://github.com/apache/couchdb/issues/3517#issuecomment-919304082","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3517","id":919304082,"node_id":"IC_kwDOAAMmUc42y3eS","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-14T16:16:22Z","updated_at":"2021-09-14T16:16:22Z","author_association":"MEMBER","body":"Thanks for the update! We expected a reduction in performance, but this is quite a jump. Maybe we can think about making this configurable, most folks only ever run trusted design docs anyway and a simpler and faster hashing function might do the trick.\r\n\r\nAfter all, this might not make it into 3.2, but we will remain on it.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/919304082/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920116946","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920116946","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920116946,"node_id":"IC_kwDOAAMmUc42197S","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T15:20:13Z","updated_at":"2021-09-15T15:20:13Z","author_association":"MEMBER","body":"Update: it does _not_ matter which shard returns the one response that we handle correctly. This probably rules out that this has to do with shards where the ddoc isn’t actually stored.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920116946/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920123818","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920123818","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920123818,"node_id":"IC_kwDOAAMmUc421_mq","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T15:28:29Z","updated_at":"2021-09-15T15:28:29Z","author_association":"MEMBER","body":"This also happens with, say, `limit=1`:\r\n\r\n```\r\n{\"total_rows\":12,\"offset\":11,\"rows\":[\r\n{\"id\":\"doc2\",\"key\":\"foo\",\"value\":null}\r\n]}\r\n{\"total_rows\":12,\"offset\":11,\"rows\":[\r\n{\"id\":\"doc2\",\"key\":\"foo\",\"value\":\"fooValue\"}\r\n]}\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920123818/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920126205","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920126205","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920126205,"node_id":"IC_kwDOAAMmUc422AL9","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T15:31:24Z","updated_at":"2021-09-15T15:31:24Z","author_association":"MEMBER","body":"with `skip=2&limit=2`:\r\n\r\n```\r\n{\"total_rows\":12,\"offset\":10,\"rows\":[\r\n{\"id\":\"doc2\",\"key\":\"foo\",\"value\":\"fooValue\"},\r\n{\"id\":\"doc2\",\"key\":\"foo\",\"value\":null}\r\n]}\r\n{\"total_rows\":12,\"offset\":10,\"rows\":[\r\n{\"id\":\"doc2\",\"key\":\"foo\",\"value\":null},\r\n{\"id\":\"doc2\",\"key\":\"foo\",\"value\":\"fooValue\"}\r\n]}\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920126205/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920271499","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920271499","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920271499,"node_id":"IC_kwDOAAMmUc422jqL","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T18:26:20Z","updated_at":"2021-09-15T18:26:20Z","author_association":"MEMBER","body":"Good catch! I think the bug occurs when one shard sends both the `meta` message and the followup `complete` message before `meta` messages have been received from other shards. `fabric_view:maybe_send_row/1` handles this condition correctly, but the `limit=0` pattern match in `fabric_view_map:handle_message/1` does not. I think the fix is simply to call `maybe_send_row` there instead -- it looks a bit odd since we obviously _don't_ want to send a row, but it's the DRY approach.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920271499/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920272154","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920272154","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920272154,"node_id":"IC_kwDOAAMmUc422j0a","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T18:27:25Z","updated_at":"2021-09-15T18:27:25Z","author_association":"MEMBER","body":"Also, did you really mean that you observe a bug with `limit=1` as you noted above? I don't see a bug there, and the one I'm describing can only occur with `limit=0`","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920272154/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920294880","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920294880","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920294880,"node_id":"IC_kwDOAAMmUc422pXg","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T18:56:34Z","updated_at":"2021-09-15T18:58:31Z","author_association":"CONTRIBUTOR","body":"I think this might fix it:\r\n\r\n```\r\n git diff\r\ndiff --git a/src/fabric/src/fabric_view_map.erl b/src/fabric/src/fabric_view_map.erl\r\nindex b8d0d392a..eed6af74e 100644\r\n--- a/src/fabric/src/fabric_view_map.erl\r\n+++ b/src/fabric/src/fabric_view_map.erl\r\n@@ -147,9 +147,9 @@ handle_message({meta, Meta0}, {Worker, From}, State) ->\r\n     end;\r\n\r\n handle_message(#view_row{}, {_, _}, #collector{limit=0} = State) ->\r\n-    #collector{callback=Callback} = State,\r\n-    {_, Acc} = Callback(complete, State#collector.user_acc),\r\n-    {stop, State#collector{user_acc=Acc}};\r\n+    % rely on limit=0 special clause in maybe_send_row to wait until all\r\n+    % shard ranges reply\r\n+    fabric_view:maybe_send_row(State);\r\n\r\n handle_message(#view_row{} = Row, {_,From}, #collector{sorted=false} = St) ->\r\n     #collector{callback=Callback, user_acc=AccIn, limit=Limit} = St,\r\n```\r\n\r\nWe rely on the logic in https://github.com/apache/couchdb/blob/9f081914fe1fd7f31c2c1c7b3ead89427cf342f3/src/fabric/src/fabric_view.erl#L124-L134 to already wait until we have completed the ring with meta only (we don't bump counters with any rows returned)\r\n\r\nInterestingly enough, there is a remnant `erase(meta_sent),` of some attempt at row send waiting until we sent meta...","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920294880/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920300900","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920300900","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920300900,"node_id":"IC_kwDOAAMmUc422q1k","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T19:05:16Z","updated_at":"2021-09-15T19:05:16Z","author_association":"CONTRIBUTOR","body":"Running with it for 5 minutes or so and getting consistent meta being returned with limit=0","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920300900/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920305279","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920305279","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920305279,"node_id":"IC_kwDOAAMmUc422r5_","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T19:12:02Z","updated_at":"2021-09-15T19:12:02Z","author_association":"MEMBER","body":"This works fine here.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920305279/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920324847","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920324847","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920324847,"node_id":"IC_kwDOAAMmUc422wrv","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T19:43:52Z","updated_at":"2021-09-15T19:43:52Z","author_association":"CONTRIBUTOR","body":"PR https://github.com/apache/couchdb/pull/3751 for limit=0 meta ","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920324847/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920328911","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920328911","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920328911,"node_id":"IC_kwDOAAMmUc422xrP","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T19:50:43Z","updated_at":"2021-09-15T19:50:43Z","author_association":"MEMBER","body":"> Also, did you really mean that you observe a bug with limit=1 as you noted above? I don't see a bug there, and the one I'm describing can only occur with limit=0\r\n\r\n@kocolosk yes I can see unstable sort results with `limit=1` on the same data set. Sometimes I get a `\"fooValues\"` and sometimes a `null`. Same script, just `s/limit=0/limit=1`","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920328911/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920343930","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920343930","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920343930,"node_id":"IC_kwDOAAMmUc4221V6","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T20:14:02Z","updated_at":"2021-09-15T20:14:02Z","author_association":"MEMBER","body":"@janl do we have a defined sorting order for multiple distinct values emitted with the same key from the same document? I wasn't aware of one.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920343930/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920349490","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920349490","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920349490,"node_id":"IC_kwDOAAMmUc4222sy","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T20:22:33Z","updated_at":"2021-09-15T20:22:33Z","author_association":"MEMBER","body":"fair comment that the apparent inconsistent ordering actually isn't, it's merely undefined. \r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920349490/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920353683","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920353683","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920353683,"node_id":"IC_kwDOAAMmUc4223uT","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-15T20:29:00Z","updated_at":"2021-09-15T20:29:00Z","author_association":"MEMBER","body":"If we look back at the original introduction of the limit=0 clause in https://github.com/apache/couchdb/commit/4e0c97bf3587e9d0e330494f0d06194c0c4bfa17 I wonder if this isn't the better fix;\r\n\r\n```\r\ndiff --git a/src/fabric/src/fabric_view_map.erl b/src/fabric/src/fabric_view_map.erl\r\nindex b8d0d392a..ff6aa8b69 100644\r\n--- a/src/fabric/src/fabric_view_map.erl\r\n+++ b/src/fabric/src/fabric_view_map.erl\r\n@@ -146,7 +146,7 @@ handle_message({meta, Meta0}, {Worker, From}, State) ->\r\n         }}\r\n     end;\r\n\r\n-handle_message(#view_row{}, {_, _}, #collector{limit=0} = State) ->\r\n+handle_message(#view_row{}, {_, _}, #collector{sorted=false, limit=0} = State) ->\r\n     #collector{callback=Callback} = State,\r\n     {_, Acc} = Callback(complete, State#collector.user_acc),\r\n     {stop, State#collector{user_acc=Acc}};\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920353683/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920585909","html_url":"https://github.com/apache/couchdb/issues/2203#issuecomment-920585909","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2203","id":920585909,"node_id":"IC_kwDOAAMmUc423wa1","user":{"login":"fangq","id":226913,"node_id":"MDQ6VXNlcjIyNjkxMw==","avatar_url":"https://avatars.githubusercontent.com/u/226913?v=4","gravatar_id":"","url":"https://api.github.com/users/fangq","html_url":"https://github.com/fangq","followers_url":"https://api.github.com/users/fangq/followers","following_url":"https://api.github.com/users/fangq/following{/other_user}","gists_url":"https://api.github.com/users/fangq/gists{/gist_id}","starred_url":"https://api.github.com/users/fangq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fangq/subscriptions","organizations_url":"https://api.github.com/users/fangq/orgs","repos_url":"https://api.github.com/users/fangq/repos","events_url":"https://api.github.com/users/fangq/events{/privacy}","received_events_url":"https://api.github.com/users/fangq/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-16T05:21:17Z","updated_at":"2021-09-16T05:21:17Z","author_association":"NONE","body":"just a quick update - I just received a 5-year (U24) grant from the NIH (National Institute of Heath) to help migrate a vast field of neuroimaging software and data to a unified JSON/UBJSON formats so that these valuable neuroimaging datasets (results from millions of dollars of investments from the NIH) can be readable, resuable, and easily migrated to NoSQL databases for scaling and integration. More details will be available at http://neurojson.org\r\n\r\nIn our first step, we will first convert major neuroimaging data files to JSON, which should be readily usable for a CouchDB query interface. I imagine that with the gradual availability of parsers/libraries, more people may choose to adopt our [Binary JData ](https://github.com/NeuroJSON/bjdata/blob/master/Binary_JData_Specification.md)(BJData, largely derived from UBJSON) format for efficiency purposes; so if importing BJData/UBJSON can be discussed in the roadmaps of CouchDB, that would be fantastic for making Couch an attractive tool towards scientific data and research community.\r\n\r\nIn the meantime, I am coordinating with UBJSON developers on backporting BJData new data markers https://github.com/ubjson/universal-binary-json/issues/109, although, unfortunately the UBJSON development seems to have been stalled over the past few years.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920585909/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920632171","html_url":"https://github.com/apache/couchdb/issues/2203#issuecomment-920632171","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2203","id":920632171,"node_id":"IC_kwDOAAMmUc4237tr","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-16T07:02:16Z","updated_at":"2021-09-16T07:02:16Z","author_association":"MEMBER","body":"The main limiting factor is the general deprecation of attachments in CouchDB, and the reduction of max document size in CouchDB 4.x to around 10MB. We're not opposed to a richer solution, but it's orthogonal to choosing something like UBJSON/etc, and would have to be solved first.\r\n\r\nSee prior mailing list discussion:\r\n\r\nhttps://lists.apache.org/thread.html/dd951bda2a8a98f204fa9dd3afbb99b2b12946bb529288829e6fe72c%40%3Cdev.couchdb.apache.org%3E\r\n\r\nhttps://lists.apache.org/thread.html/4a7f29d2356349fa684fca199a6d0817d06e741fba483fd83f6ee59b%40%3Cdev.couchdb.apache.org%3E\r\n\r\nhttps://lists.apache.org/thread.html/4a7f29d2356349fa684fca199a6d0817d06e741fba483fd83f6ee59b%40%3Cdev.couchdb.apache.org%3E\r\n\r\nhttps://lists.apache.org/thread.html/r815b25fe34996ab3c54e2fb9759de2026ddccffc8bb59966b1168063%40%3Cdev.couchdb.apache.org%3E (stopgap change for 3.x to set a finite upper bound for attachments)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920632171/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920646774","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920646774","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920646774,"node_id":"IC_kwDOAAMmUc423_R2","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-16T07:24:46Z","updated_at":"2021-09-16T07:24:46Z","author_association":"MEMBER","body":"> @janl do we have a defined sorting order for multiple distinct values emitted with the same key from the same document? I wasn't aware of one.\r\n\r\n@kocolosk DO’H, of course, I was too in the weeds on this one to see this. ta.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920646774/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920670450","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920670450","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920670450,"node_id":"IC_kwDOAAMmUc424FDy","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-16T07:48:23Z","updated_at":"2021-09-16T07:48:23Z","author_association":"MEMBER","body":"hm, continuing to think about this, I’m still somewhat surprised but this:\r\n\r\n1. I assume those rows are written to the index on a fixed order\r\n2. we read those indexes row by row\r\n3. how would, say row 2 with value `null` overtake row 3 with value `\"fooValue\"` on the way out if it comes from the same index shard?\r\n\r\nI’m not necessarily arguing that we fix this, I’m just trying to understand :)","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920670450/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920902849","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920902849","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920902849,"node_id":"IC_kwDOAAMmUc4249zB","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-16T13:28:13Z","updated_at":"2021-09-16T13:28:13Z","author_association":"MEMBER","body":"I don't have a complete answer for that one. You probably noticed that the values show up in a consistent order with q=1, so it has something to do with the way that rows from different shards are collated in the coordinator. We do that by merging each incoming row into a sorted list of rows from all shards using the standard ejson comparator function [here](https://github.com/apache/couchdb/blob/3.x/src/fabric/src/fabric_view_map.erl#L192-L200). That merge implementation seems to preserve the \"arrival order\" when inserting rows that compare equal, but if it did not I think we'd have our culprit. When q=1 we are sending rows out as soon as we get them, but when q>1 the coordinator might end up reordering equal rows from the same shard in that list while waiting for at least one row from all the other shards.\r\n\r\nI still think that's probably the spot where this reordering is happening, just can't prove it yet.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920902849/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920947424","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920947424","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920947424,"node_id":"IC_kwDOAAMmUc425Irg","user":{"login":"kocolosk","id":16679,"node_id":"MDQ6VXNlcjE2Njc5","avatar_url":"https://avatars.githubusercontent.com/u/16679?v=4","gravatar_id":"","url":"https://api.github.com/users/kocolosk","html_url":"https://github.com/kocolosk","followers_url":"https://api.github.com/users/kocolosk/followers","following_url":"https://api.github.com/users/kocolosk/following{/other_user}","gists_url":"https://api.github.com/users/kocolosk/gists{/gist_id}","starred_url":"https://api.github.com/users/kocolosk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kocolosk/subscriptions","organizations_url":"https://api.github.com/users/kocolosk/orgs","repos_url":"https://api.github.com/users/kocolosk/repos","events_url":"https://api.github.com/users/kocolosk/events{/privacy}","received_events_url":"https://api.github.com/users/kocolosk/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-16T14:21:22Z","updated_at":"2021-09-16T14:21:22Z","author_association":"MEMBER","body":"Ah! The issue is this short-circuit equality test: https://github.com/apache/couchdb/blob/a36e7308ab4a2cf/src/fabric/src/fabric_view.erl#L301\r\n\r\nThe normal `couch_ejson_compare` sorting function preserves the arrival order because it only does the less-than check, but the short-circuit one will reverse them and put the newest-arriving element that compares equal first. Mystery solved.\r\n","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920947424/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920978333","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-920978333","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":920978333,"node_id":"IC_kwDOAAMmUc425QOd","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-16T14:57:52Z","updated_at":"2021-09-16T14:57:52Z","author_association":"CONTRIBUTOR","body":"@kocolosk, you're right, removing the line the rows are returned in the same order:\r\n\r\n```\r\nwhile (true); do curl -su adm:pass 'http://localhost:15984/debug/_design/test/_view/test?startkey=\"foo\"&limit=6' ; sleep 1 ; done\r\n```\r\n\r\n```\r\n...\r\n{\"total_rows\":12,\"offset\":8,\"rows\":[\r\n{\"id\":\"doc1\",\"key\":\"foo\",\"value\":null},\r\n{\"id\":\"doc1\",\"key\":\"foo\",\"value\":\"fooValue\"},\r\n{\"id\":\"doc2\",\"key\":\"foo\",\"value\":null},\r\n{\"id\":\"doc2\",\"key\":\"foo\",\"value\":\"fooValue\"}\r\n]}\r\n...\r\n```\r\n\r\nI guess the general constraint is that the collation function must be identical to the one used on the shards themselves and if it isn't the `lists:merge/3` function won't work as expected?\r\n\r\n```\r\nmerge(Fun, List1, List2) -> List3\r\n\r\nReturns the sorted list formed by merging List1 and List2. Both List1\r\nand List2 must be sorted according to the ordering function Fun\r\nbefore evaluating this function. Fun(A, B) is to return true if A\r\ncompares less than or equal to B in the ordering, otherwise false.\r\nWhen two elements compare equal, the element from List1 is picked\r\nbefore the element from List2.\r\n```","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/920978333/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/921023031","html_url":"https://github.com/apache/couchdb/issues/2203#issuecomment-921023031","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2203","id":921023031,"node_id":"IC_kwDOAAMmUc425bI3","user":{"login":"fangq","id":226913,"node_id":"MDQ6VXNlcjIyNjkxMw==","avatar_url":"https://avatars.githubusercontent.com/u/226913?v=4","gravatar_id":"","url":"https://api.github.com/users/fangq","html_url":"https://github.com/fangq","followers_url":"https://api.github.com/users/fangq/followers","following_url":"https://api.github.com/users/fangq/following{/other_user}","gists_url":"https://api.github.com/users/fangq/gists{/gist_id}","starred_url":"https://api.github.com/users/fangq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fangq/subscriptions","organizations_url":"https://api.github.com/users/fangq/orgs","repos_url":"https://api.github.com/users/fangq/repos","events_url":"https://api.github.com/users/fangq/events{/privacy}","received_events_url":"https://api.github.com/users/fangq/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-16T15:51:12Z","updated_at":"2021-09-16T15:51:12Z","author_association":"NONE","body":"thanks @wohali for the heads up - not necessarily related to supporting UBJSON/msgpack, just for the kind of data I work with, attachment feature will be necessary- so I hope it won't be entirely retired. \r\n\r\nyou can see samples of public neuroimaging datasets, organized via the BIDS standard (https://github.com/bids-standard/) in the below link\r\n\r\nhttps://openneuro.org/public/datasets\r\n\r\nso, these public datasets routinely exceed GB in size, although they contains many individual data files/scans, and each file could be much smaller.\r\n\r\nMy plan is to extract as much as possible the metadata from these data files, and place big binary data chunks into attachments. As long as the max attachment size is adjustable, I can always dial it up when needed. But sounds like the max document size will be a hard limit? 10MB could be pushing considering the scalability of the datasets we will be dealing with.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/921023031/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/921028679","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-921028679","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":921028679,"node_id":"IC_kwDOAAMmUc425chH","user":{"login":"janl","id":11321,"node_id":"MDQ6VXNlcjExMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11321?v=4","gravatar_id":"","url":"https://api.github.com/users/janl","html_url":"https://github.com/janl","followers_url":"https://api.github.com/users/janl/followers","following_url":"https://api.github.com/users/janl/following{/other_user}","gists_url":"https://api.github.com/users/janl/gists{/gist_id}","starred_url":"https://api.github.com/users/janl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janl/subscriptions","organizations_url":"https://api.github.com/users/janl/orgs","repos_url":"https://api.github.com/users/janl/repos","events_url":"https://api.github.com/users/janl/events{/privacy}","received_events_url":"https://api.github.com/users/janl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-16T15:58:15Z","updated_at":"2021-09-16T15:58:15Z","author_association":"MEMBER","body":"ah wow this is fascinating, thanks for pulling this out!","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/921028679/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/921031881","html_url":"https://github.com/apache/couchdb/issues/3750#issuecomment-921031881","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3750","id":921031881,"node_id":"IC_kwDOAAMmUc425dTJ","user":{"login":"rnewson","id":47223,"node_id":"MDQ6VXNlcjQ3MjIz","avatar_url":"https://avatars.githubusercontent.com/u/47223?v=4","gravatar_id":"","url":"https://api.github.com/users/rnewson","html_url":"https://github.com/rnewson","followers_url":"https://api.github.com/users/rnewson/followers","following_url":"https://api.github.com/users/rnewson/following{/other_user}","gists_url":"https://api.github.com/users/rnewson/gists{/gist_id}","starred_url":"https://api.github.com/users/rnewson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnewson/subscriptions","organizations_url":"https://api.github.com/users/rnewson/orgs","repos_url":"https://api.github.com/users/rnewson/repos","events_url":"https://api.github.com/users/rnewson/events{/privacy}","received_events_url":"https://api.github.com/users/rnewson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-16T16:02:11Z","updated_at":"2021-09-16T16:02:11Z","author_association":"MEMBER","body":"nice find.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/921031881/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/921139429","html_url":"https://github.com/apache/couchdb/issues/2203#issuecomment-921139429","issue_url":"https://api.github.com/repos/apache/couchdb/issues/2203","id":921139429,"node_id":"IC_kwDOAAMmUc4253jl","user":{"login":"wohali","id":112292,"node_id":"MDQ6VXNlcjExMjI5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/112292?v=4","gravatar_id":"","url":"https://api.github.com/users/wohali","html_url":"https://github.com/wohali","followers_url":"https://api.github.com/users/wohali/followers","following_url":"https://api.github.com/users/wohali/following{/other_user}","gists_url":"https://api.github.com/users/wohali/gists{/gist_id}","starred_url":"https://api.github.com/users/wohali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wohali/subscriptions","organizations_url":"https://api.github.com/users/wohali/orgs","repos_url":"https://api.github.com/users/wohali/repos","events_url":"https://api.github.com/users/wohali/events{/privacy}","received_events_url":"https://api.github.com/users/wohali/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-16T18:22:35Z","updated_at":"2021-09-16T18:22:35Z","author_association":"MEMBER","body":"Attachments aren't completely removed, but >10MB is an open design problem. It's unclear if 4.0 will launch with support for anything >10MB, due to the small FDB transaction size and the lack of consensus in how to craft a solution that works with it.","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/921139429/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/924955261","html_url":"https://github.com/apache/couchdb/pull/3757#issuecomment-924955261","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3757","id":924955261,"node_id":"IC_kwDOAAMmUc43IbJ9","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-22T13:55:08Z","updated_at":"2021-09-22T13:55:08Z","author_association":"CONTRIBUTOR","body":"There is a similar thing we already do for _all_docs with keys:\r\n  \r\n  * https://github.com/apache/couchdb/blob/3.x/src/fabric/src/fabric_view_all_docs.erl#L75-L78\r\n  * https://github.com/apache/couchdb/blob/3.x/src/couch_mrview/src/couch_mrview.erl#L400-L403","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/924955261/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/926228380","html_url":"https://github.com/apache/couchdb/pull/3763#issuecomment-926228380","issue_url":"https://api.github.com/repos/apache/couchdb/issues/3763","id":926228380,"node_id":"IC_kwDOAAMmUc43NR-c","user":{"login":"nickva","id":211822,"node_id":"MDQ6VXNlcjIxMTgyMg==","avatar_url":"https://avatars.githubusercontent.com/u/211822?v=4","gravatar_id":"","url":"https://api.github.com/users/nickva","html_url":"https://github.com/nickva","followers_url":"https://api.github.com/users/nickva/followers","following_url":"https://api.github.com/users/nickva/following{/other_user}","gists_url":"https://api.github.com/users/nickva/gists{/gist_id}","starred_url":"https://api.github.com/users/nickva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickva/subscriptions","organizations_url":"https://api.github.com/users/nickva/orgs","repos_url":"https://api.github.com/users/nickva/repos","events_url":"https://api.github.com/users/nickva/events{/privacy}","received_events_url":"https://api.github.com/users/nickva/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-09-23T23:15:50Z","updated_at":"2021-09-23T23:15:50Z","author_association":"CONTRIBUTOR","body":"The test script from issue 3750 can be used to verify the new behavior https://github.com/apache/couchdb/issues/3750#issuecomment-920978333","reactions":{"url":"https://api.github.com/repos/apache/couchdb/issues/comments/926228380/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]